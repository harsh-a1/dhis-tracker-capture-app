{"version":3,"sources":["webpack:///webpack/bootstrap 9051a9b407771f2e8508","webpack:///./scripts/index.js","webpack:///./scripts/app.js","webpack:///./scripts/trackerCaptureModule.js","webpack:///./~/d2-tracker/lib/dhis2.angular.services.js","webpack:///./~/d2-tracker/lib/dhis2.angular.directives.js","webpack:///./~/d2-tracker/lib/dhis2.angular.validations.js","webpack:///./~/d2-tracker/lib/dhis2.angular.filters.js","webpack:///./~/d2-tracker/lib/dhis2.angular.controllers.js","webpack:///./~/d2-tracker/lib/dhis2.angular.templates.js","webpack:///./scripts/services.js","webpack:///./scripts/filters.js","webpack:///./scripts/directives.js","webpack:///./scripts/controllers.js","webpack:///./scripts/leftbar-menu-controller.js","webpack:///./scripts/report-types-controller.js","webpack:///./scripts/display-mode-controller.js","webpack:///./scripts/sticky.min.js","webpack:///./scripts/custom-services.js","webpack:///./scripts/queue/queue-controller.js","webpack:///./components/dashboard/dashboard-controller.js","webpack:///./components/dashboard/dashboard-widgets-controller.js","webpack:///./components/registration/registration-controller.js","webpack:///./components/enrollment/enrollment-controller.js","webpack:///./components/dataentry/dataentry-controller.js","webpack:///./components/dataentry/referral-controller.js","webpack:///./components/dataentry/modal-default-form-controller.js","webpack:///./components/dataentry/new-event-controller.js","webpack:///./components/dataentry/event-cocbo-controller.js","webpack:///./components/report/tei-report-controller.js","webpack:///./components/report/program-summary-controller.js","webpack:///./components/report/program-statistics-controller.js","webpack:///./components/report/overdue-events-controller.js","webpack:///./components/report/upcoming-events-controller.js","webpack:///./components/selected/selected-controller.js","webpack:///./components/relationship/relationship-controller.js","webpack:///./components/teiadd/tei-add-controller.js","webpack:///./components/profile/profile-controller.js","webpack:///./components/notes/notes-controller.js","webpack:///./components/rulebound/rulebound-controller.js","webpack:///./components/messaging/messaging-controller.js","webpack:///./~/leaflet/dist/leaflet-src.js","webpack:///./~/leaflet-geocoder-mapzen/dist/leaflet-geocoder-mapzen.js","webpack:///./~/leaflet-contextmenu/dist/leaflet.contextmenu.js","webpack:///./~/d2-tracker/lib/Google.js"],"names":["require","Icon","Default","imagePath","angular","module","value","config","$httpProvider","$routeProvider","$translateProvider","$logProvider","defaults","useXDomain","headers","common","when","templateUrl","controller","css","otherwise","redirectTo","preferredLanguage","useSanitizeValueStrategy","useLoader","debugEnabled","run","$templateCache","$http","$rootScope","get","then","page","put","data","maxGridColumnSize","maxOptionSize","trackerCaptureServices","factory","store","dhis2","storage","Store","name","adapters","IndexedDBAdapter","DomSessionStorageAdapter","InMemoryAdapter","objectStores","currentStore","service","DHIS2URL","NotificationService","$translate","ButtonIds","Complete","Incomplete","Validate","Delete","Skip","Unskip","Note","w","enrollmentWidget","title","view","show","expand","parent","order","indicatorWidget","dataentryWidget","dataentryTabularWidget","reportWidget","selectedWidget","feedbackWidget","profileWidget","relationshipWidget","notesWidget","messagingWidget","defaultLayout","Object","widgets","program","getDefaultLayout","customLayout","dashboardLayout","promise","response","extend","showNotifcationDialog","instant","saveLayout","saveAsDefault","url","method","error","errorMsgHdr","errorMsgBody","dashboardUpdateCallback","numberOfWidgetsReady","registerDashboardUpdateCallback","callback","updateDashboard","DateUtils","CalendarService","$filter","calendarSetting","getSetting","splitDate","dateValue","year","moment","momentFormat","month","week","day","processPeriodsForEvent","periods","event","index","occupied","i","length","endDate","isSame","sortingDate","startDate","isAfter","copy","splice","available","getPeriods","events","stage","enrollment","_periodOffset","referenceDate","incidentDate","enrollmentDate","offset","minDaysFromStart","generatedByEnrollmentDate","occupiedPeriods","availablePeriods","hasFuturePeriod","periodType","forEach","push","id","format","add","periodOffset","validation","isNumber","getToday","eventDateOffSet","_d","keyDateFormat","pt","PeriodType","d2Periods","generatePeriods","filterFuturePeriods","reversePeriods","p","formatFromApiToUser","ps","managePeriods","isNewEvent","$q","TCStorageService","getAll","def","defer","open","done","optionSets","$apply","resolve","uid","optionSet","getCode","options","key","displayName","code","getName","relationshipTypes","relationshipType","$location","SessionStorageService","orderByFilter","OrgUnitFactory","CommonUtils","roles","userRoles","userCredentials","getOrgUnit","search","ou","orgUnit","prs","programs","pr","organisationUnits","hasOwnProperty","userHasValidRole","getAllForUser","selectedProgram","reverse","continueLoop","isUndefined","legth","getProgramsByOu","pv","getByProgram","programValidations","pvs","TEIService","registerOrUpdate","tei","attributesById","trackedEntityInstance","update","register","processForm","existingTei","formTei","originalTei","attributes","formEmpty","k","formChanged","att","attribute","valueType","convertFromApiToUser","enrollments","convertFromUserToApi","formatFromUserToApi","orgUnitName","errorHeader","enrollmentUid","errorBody","status","message","getByEntity","entity","getByEntityAndProgram","getByStartAndEndDate","ouMode","enroll","en","post","notes","delete","updateForNote","entities","te","AttributesFactory","CurrentSelection","entityUid","formatDataValue","headerText","bodyText","statusText","ouId","queryUrl","programUrl","attributeUrl","pager","paging","attributesList","attrNamesIdMap","deferred","pgSize","pageSize","pg","xmlData","rows","itemName","jsonData","getAttributesById","j","indexOf","column","replace","JSON","stringify","formattedTei","processAttributes","selectedTei","selectedEnrollment","atts","showRequiredAttributes","getWithoutProgram","getGeneratedAttributeValue","OptionSetService","OperatorFactory","programAttributes","programTrackedEntityAttributes","pAttribute","trackedEntityAttribute","mandatory","displayInList","displayInListNoProgram","getMissingAttributesForEnrollment","existingAttributes","missingAttributes","exists","requiredAttributes","teiAttributes","fromEnrollment","processed","allowFutureDate","type","generateAttributeFilters","operator","defaultOperators","skipPaging","getEventsByStatus","programStatus","getEventsByProgram","attributeCategory","default","cc","cp","getEventsByProgramStage","programStage","getByOrgUnitAndProgram","eventUid","create","dhis2Event","updateForSingleValue","singleValue","dataValues","dataElement","updateForEventDate","getEventReport","eventStatus","boolOperators","obj","MetaDataFactory","staticReplacements","regExp","RegExp","replacement","performStaticReplacements","expression","staticReplacement","getRules","programUid","constants","pis","variables","programRules","pi","displayInForm","newAction","content","displayDescription","programRuleActionType","location","newRule","shortname","description","condition","filter","programRuleActions","variablesInCondition","match","variablesInData","valueCountPresent","positiveValueCountPresent","variableObjectsCurrentExpression","pushDirectAddressedVariable","variableWithCurls","variableName","variableNameParts","split","newVariableObject","programRuleVariableSourceType","useCodeForOptionSet","variableInCondition","pushed","variableInData","valueCountText","variableCurrentRule","zeroPosValueCountText","programIndicators","rules","programVariables","rule","actions","programStageId","getAttributesQuery","query","hasValue","q","exactValue","startValue","endValue","substr","isArray","val","programEnrollmentStartDate","programEnrollmentEndDate","programIncidentStartDate","programIncidentEndDate","resetAttributesQuery","programStartDate","programEndDate","selectedOrgUnitId","grid","map","invalidTeis","isFollowUp","entityList","own","other","row","isEmpty","created","inactive","followUp","optionSetValue","checkAndSetOrgUnitName","len","metaData","generateGridColumns","nonConfidential","filterTypes","filterText","columns","returnAttributes","concat","showFilter","getData","d","col","getHeader","header","PeriodService","getEventDueDate","eventsByStage","dueDate","repeatable","evs","ev","eventDate","standardInterval","getEventDuePeriod","reconstructEvent","e","programStageDataElements","prStDe","providedElsewhere","captureCoordinates","coordinate","latitude","longitude","createDummyEvent","eventsPerStage","today","dummyEvent","n","executionDateLabel","enrollmentStatus","prds","periodName","statusColor","getEventStatusColor","autoGenerateEvents","teiId","availableEvent","dhis2Events","programStages","getOptionSets","autoGenerateEvent","newEvent","openAfterEnrollment","reportDateToUse","reconstruct","processEvent","prStDes","dataValue","allowProvidedElsewhereExists","allowProvidedElsewhere","getGridColumns","partial","allColumns","displayInReports","c","displayFormName","all","getEditingStatus","isValid","blockEntryForm","$modal","showModal","availableStages","selectedEntity","selectedOrgUnit","autoCreate","eventCreationAction","allEventsSorted","suggestedStage","selectedCategories","modalInstance","stages","allStages","result","eventCreationActions","schedule","referral","sendMessage","summaries","summary","responseMessage","errorMessage","trackerCaptureFilters","pagedList","fullList","filteredData","period","trackerCaptureDirectives","directive","link","scope","element","attrs","ngModel","$parsers","$formatters","parseFloat","$window","getWindowDimensions","height","width","$watch","_height","newValue","oldValue","console","log","bind","restrict","chosenEventWrapped","getEventStyle","completeActionCustom","reopenActionCustom","validateActionCustom","deleteActionCustom","skipActionCustom","unskipActionCustom","notesActionCustom","applicableButtons","allEvents","formData","buttonsEnabled","deleteActionExtended","$scope","$element","$attrs","EventUtils","DHIS2EventFactory","EVENTSTATUSCOMPLETELABEL","EVENTSTATUSSKIPPEDLABEL","EVENTSTATUSVISITEDLABEL","EVENTSTATUSACTIVELABEL","EVENTSTATUSSCHEDULELABEL","COMPLETE","INCOMPLETE","VALIDATE","DELETE","SKIP","UNSKIP","NOTE","completeAction","isDefined","completeActionDefault","reopenAction","reopenActionDefault","validateAction","deleteAction","deleteActionDefault","skipAction","unskipAction","showNotes","notesModal","showNoteExistsIcon","notesSummary","note","noteSubstring","lastSpace","lastIndexOf","summaryHeader","summaryFooter","eventTableOptions","text","tooltip","icon","onClick","sort","validatedEventDate","updateEventTableOptions","equals","updatedEvent","date","eventRow","disabled","defaultOption","defaultOption2","createOptionsArray","eventTableOptionsArr","defaultFound","a","b","bodyList","currentNote","value1","storedDate","value2","dialogOptions","closeButtonText","textAreaButtonText","textAreaButtonShow","bodyTextAreas","model","placeholder","required","currentEvent","dialogDefaults","$modalInstance","modalOptions","formSubmitted","textAreaValues","textAreaButtonClick","textAreaModalForm","$valid","addNote","$setUntouched","close","newNote","formatToHrsMins","Date","showNotifcationWithOptions","foundIndex","setChosenEventToNothing","submitted","dhis2EventToUpdate","makeDhis2EventToUpdate","deStatus","oldEvent","chosenEvent","priority","compile","templateName","dhis2CompiledInclude","Error","template","html","body","trackerCapture","$timeout","Paginator","ProgramFactory","EntityQueryFactory","TEIGridService","EventReportService","GridColumnService","savedAdvancedSeachOptions","defaultColumn","eventsTodayFilters","selectedEventsTodayFilter","availablePrograms","fileNames","orgUnitNames","ouModes","selectedOuMode","dashboardProgramId","treeLoaded","searchOuTree","teiListMode","onlyActive","showSearchDiv","searchText","exportFormats","searchFilterExists","enrollmentStartDate","enrollmentEndDate","incidentStartDate","incidentEndDate","searchMode","listAll","freeText","attributeBased","dataElementTranslations","doSearch","sortColumn","resetParams","goToPage","trackedEntityList","emptySearchText","emptySearchAttribute","showRegistrationDiv","showTrackedEntityDiv","teiFetched","frontPageListEnabled","toolBarDisplay","isObject","updateOrgUnitInCurrentSelection","getFromStoreOrServer","orgUnitFromStore","selections","set","closedStatus","currentOrgUnit","newOrgUnitSelected","setAdvancedSearchOptions","confidential","searchingOrgUnit","getAdvancedSearchOptions","savedTeis","getTrackedEntities","setAttributesById","setOptionSets","gridColumns","gridColumnsInUserStore","ouLevels","getOuLevels","setOuLevels","trackerCaptureLabel","orgUnitLabel","listAllLabel","registerLabel","searchOusLabel","printLabel","searchLabel","findLabel","advancedSearchLabel","allEnrollmentsLabel","completedEnrollmentsLabel","activeEnrollmentsLabel","cancelledEnrollmentsLabel","searchCriteriaLabel","programSelectLabel","settingsLabel","showHideLabel","listProgramsLabel","todayLabel","displayModeLabel","loadPrograms","selectedSearchMode","restoreGridColumnsFromUserStore","getProgramAttributes","setEnrollmentStatus","restoreSavedTeis","displayFrontPageList","setPage","setPageCount","pageCount","setPageSize","setItemCount","total","filterByEnrollmentStatus","sortGrid","gridHeader","setColumnReverse","setSortColumn","d2Sort","getDate","mode","selectedSearchingOrgUnit","fetchTeis","fetchTeisEventsToday","eventsTodayFilter","promises","ids","eventRows","trackedEntityInstanceCreated","trackedEntityInstanceOrgUnit","trackedEntityInstanceOrgUnitName","trackedEntityInstanceInactive","attr","eventsToday","setTrackedEntities","getFileNames","getOrgUnitNames","jumpToPage","resetPageSize","getPage","clearEntities","showRegistration","$broadcast","registrationMode","showDisplayMode","showHideColumns","hiddenGridColumns","gridColumnDomainKey","gridColumnKey","showDashboard","currentEntity","sortedTei","sortedTeiIds","setSortedTeiIds","path","getHelpContent","getSearchTreeRoot","orgUnits","children","o","hasChildren","expandCollapse","getChildren","doNotFetch","setSelectedSearchingOrgUnit","getExportList","attrIdList","attrNamesList","toLowerCase","item","fileName","document","createElement","blob","style","Blob","endings","window","URL","createObjectURL","href","download","appendChild","click","setTimeout","removeChild","revokeObjectURL","exportEnabled","showHome","selection","load","showReportTypes","showQueueInterface","showApexQueueInterface","programSummary","programStatistics","overdueEvents","upcomingEvents","linkFn","$elem","mediaQuery","stickyClass","unstickyClass","bodyClass","elem","$body","doc","initialCSS","initialStyle","isSticking","stickyLine","stickyBottomLine","anchor","confine","prevOffset","matchMedia","usePlaceholder","initSticky","documentElement","useplaceholder","undefined","parseInt","trim","zIndex","top","position","marginTop","cssLeft","getTopOffset","on","checkIfShouldStick","onResize","$on","onDestroy","getScrollTop","pageYOffset","B","D","clientHeight","scrollTop","getBoundingClientRect","pixels","offsetParent","offsetTop","getBottomOffset","shouldStickWithLimit","shouldApplyWithLimit","elementHeight","offsetHeight","windowHeight","innerHeight","offsetWidth","unStickElement","getComputedStyle","parentElement","initialOffsetWidth","getPropertyValue","off","removeClass","remove","getClosest","array","num","minDiff","ans","m","Math","abs","stickElement","rect","absoluteLeft","left","addClass","hasClass","elementsHeight","after","shouldStick","scrollBottom","scrolledDistance","matches","clientTop","stickLimit","from","compare","closest","fromDirection","marginBottom","newVal","oldVal","parentHeight","warning","warn","RegistrationService","CustomIdService","getOu","getCurrentToRootAttributeValue","thiz","attributeValues","createCustomId","regDate","totalTeiCount","orgUnitCode","thisDef","$","Deferred","prefix","totalTei","finalCustomId","createCustomIdAndSave","customIDAttribute","customId","attributeExists","teI","validateAndCreateCustomId","tEAttributes","destination","enrolmentdate","isValidProgram","isValidAttribute","getProgramAttributeAndValue","getTEAttributesAttributeAndValue","tea","trackedEntityAttributes","customRegDate","substring","getTotalTeiByProgramAndOrgUnit","teiResponse","trackedEntityInstances","getOrgunitCode","orgUnitCodeResponse","getTotalTeiByProgram","orgUnitId","orgUnitUid","isProgramToBeUsedForRegistration","ouid","goToDashboard","clicked","base","protocol","host","queue","loadQueue","filtered_events","getJSON","sampleCollectedFlag","aesid","nid","age","csfc","serumc","wbc","csfwbcc","csfje","csfg","csfp","csfwbcc2","csfje2","serumje","serumig","serumsti","queueEvents","TEService","EnrollmentService","DashboardLayoutService","ModalService","AuthorityService","orgUnitUrl","queueRedirect","displayEnrollment","dataEntryMainMenuItemSelected","metaDataCached","orgUnitClosed","tc","downloadMetaData","selectedTeiId","selectedProgramId","userAuthority","getUserAuthorities","getSortedTeiIds","useTopBar","showSettingsButton","topbarClass","topbarRightSizeClass","removeLabel","expandLabel","collapseLabel","noDataReportLabel","noRelationshipLabel","showHideWidgetsLabel","notEnrolledLabel","stickLabel","unstickLabel","stickyDisabled","previousTeiExists","nextTeiExists","temporaryHideWidgets","temporaryShowWidgets","current","trackedEntity","backupSelectedEnrollment","programNames","programStageNames","setSelectedTeiEvents","prNames","prStNames","getDashboardLayout","dashboardWidgets","widgetsChanged","dashboardStatus","dashboardWidgetsOrder","biggerWidgets","smallerWidgets","orderChanged","dashboardLayouts","selectedLayout","stickRightSide","widget","hasBigger","hasSmaller","setWidgetsSize","broadCastSelections","setInactiveMessage","widgetSize","smaller","bigger","teName","instance","setHeaderDelayMessage","args","applySelectedProgram","getCurrentDashboardLayout","widgetsOrder","saveDashboardLayout","currentLayout","programId","saveDashboarLayoutAsDefault","layout","DEFAULT","applyWidgetsOrderChange","param","visible","visibleItems","closingStage","programExists","activiateTEI","st","actionButtonText","deleteTEI","teis","back","getBackButtonText","showEnrollment","removeWidget","showHideWidgets","closeOpenWidget","fetchTei","$parse","CustomFormService","TrackerRulesFactory","TrackerRulesExecutionService","CustomIDGenerationService","trackedEntityForm","customRegistrationForm","warningMessages","hiddenFields","assignedFields","errorMessages","hiddenSections","registrationAndDataEntry","autoGeneratedAttFailed","savingRegistration","helpTexts","flag","debug","verbose","ruleeffects","isDisabled","generated","editingDisabled","trackedEntities","selected","getProgramRules","allProgramRules","getAttributes","minEnrollmentDate","maxEnrollmentDate","selectEnrollmentDatesInFuture","reportDateRange","minDate","maxDate","teiOriginal","executeRules","_mode","customRegistrationFormExists","customDataEntryForm","schedulingEnabled","fetchGeneratedAttributes","dataEntryForm","htmlCode","selectIncidentDatesInFuture","displayIncidentDate","getForTrackedEntity","useFirstStageDuringRegistration","currentStage","getForProgramStage","Number","outerForm","$setPristine","reloadProfileWidget","notifyRegistrtaionCompletion","broadcastTeiEnrolled","performRegistration","registrationResponse","reg","reference","enrollmentResponse","importSummaries","avilableEvent","registerEntity","$invalid","outerDataEntryForm","metaAttribute","newAttributeInArray","eventExists","byStage","isHidden","teiValueUpdated","field","saveDataValueForRadio","context","effectResult","processRuleEffectAttribute","interacted","$dirty","getTrackerAssociate","selectedAttribute","existingAssociateUid","windowClass","addingRelationship","relatedProgramRelationship","res","cancelRegistrationWarning","cancelFunction","showAttributeMap","lat","lng","coordinates","showDataElementMap","showProgramStageMap","saveDatavalue","verifyExpiryDate","eventDateStr","dateGetter","dateSetter","assign","ouDates","verifyOrgUnitPeriodDate","expiryPeriodType","expiryDays","$route","historicalEnrollments","showEnrollmentDiv","showEnrollmentHistoryDiv","hasEnrollmentHistory","currentEnrollment","newEnrollment","processSelectedTei","hasOtherPrograms","activeEnrollments","stagesById","loadEnrollmentDetails","reload","showNewEnrollment","hideEnrollmentDiv","showEnrollmentHistory","listeners","activateDeactivateEnrollment","enrollmentForm","completeReopenEnrollment","deleteEnrollment","markForFollowup","followup","changeProgram","canUseEnrollment","saveCoordinate","enrollmentLatSaved","enrollmentLngSaved","$log","EventCreationService","instanceId","floor","random","printForm","printEmptyForm","eventPageSize","eventPagingStart","eventPagingEnd","showAttributeCategoryOptions","displayCustomForm","currentElement","eventPeriods","currentPeriod","showEventsAsTables","stagesCanBeShownAsTable","stagesNotShowingInStageTasks","tabularEntryStages","tableMaxNumberOfDataElements","xVisitScheduleDataElement","reSortStageEvents","eventsLoaded","dashBoardWidgetFirstRun","showSelf","eventLockEnabled","eventLockHours","useMainMenu","mainMenuStages","useBottomLine","hideTopLineEventsForFormTypes","TABLE","COMPARE","visibleWidgetsInMainMenu","dataentry","close_file","modalCompleteIncompleteActions","complete","completeAndExit","completeEnrollment","edit","dataElementLabel","valueLabel","providedElsewhereLabel","validatedDateSetForEvent","userProfile","storedBy","username","invalidDate","eventStyles","color","showInStageLegend","showInEventLegend","showLegend","showEventSearch","eventSearchText","filterLegend","mainMenuStageSelected","getLegendText","useInStage","getDescriptionTextForDescription","descriptionTypes","full","addNewEvent","processRuleEffect","callerId","useReferral","showReferral","authorities","print","divName","printContents","getElementById","innerHTML","popupWin","write","affectedEvent","searchedEvent","effect","action","editingNotAllowed","ineffect","alert","saveDataValueForEvent","programStageSection","processedValue","updateTabularEntryStages","selectedMainMenuStage","buildMainMenuStages","neverShowItems","headerCombineStages","openStageFromMenu","deSelectCurrentEvent","timelineFilter","openStageEventFromMenu","backToMainMenu","bottomLineItems","topLineStageFilter","headerStages","getHeaderStages","headerStagesWithoutCurrent","withoutCurrent","headerStage","headerCurrentStageName","stageWithName","displayEventInTopLine","displayEventInBottomLine","topLineEventsIsFiltered","topLineEvents","getTopLineEvents","filterStages","sortOrder","filterStage","stageEvents","hiddenStages","getTopLineEventsPage","getEventPageForEvent","slice","isCompulsory","programStageDataElementsCollection","compulsory","EventToCheck","allSorted","displayEventsInTable","rulesExecuted","currentStageEvents","showDataEntryDiv","showEventCreationDiv","totalEvents","stageStyleLabels","eventStyleLabels","allowEventCreation","repeatableStages","eventsByStageDesc","optionsReady","ouNames","setOrgUnitNames","stageCanBeShownAsTable","setCurrentStage","setDisplayTypeForStages","categoryCombo","isDefault","categories","getEvents","broadcastDataEntryControllerData","openEventExternal","showDataEntry","deleteScheduleAndOverdueEvents","openEvent","deleteScheduleOverDueEvents","getSelectedTeiEvents","displayDate","eventStage","sortEventsByStage","enableRescheduling","toggleEventsTableDisplay","getDataEntryForm","setDisplayTypeForStage","stageNeedsEventErrors","scheduleDisabled","scheduledFound","notRepeatable","stageNeedsEventOfType","completeRequired","errorResponseContainer","hideDueDate","errorCode","stageNeedsEvent","calculatedCompleteRequired","onlyOneIncompleteEvent","foundEvent","creatableStagesExist","stageList","getTopLineColumnStyle","colNr","showStageTasks","displayStageTasksInTopLine","toggleShowStageTasks","setProgramStage","getApplicableStagesForStageTasks","applicableStages","stageErrorInEventLayout","showCreateEventIfStageNeedsEvent","requireStageEventsToBeCompleted","showModalOnNoEventsNeeded","showCreateEvent","allApplicableEvents","eventContainer","eventGridColumns","suppressToggling","resetStage","saved","tableRowIsEditable","tableEditMode","tableEditModes","form","tableRowStatusButtonsEnabled","table","tableAndForm","toggleTableEditMode","eventRowChanged","eventRowClicked","switchToEventRow","openEventEditFormModal","eventRowDblClicked","eventEditFormModalInstance","switchToEventRowDeselected","switchDataEntryForm","buildOtherValuesLists","otherValues","programStageDataElement","currentId","alternateValue","displayBooleanAsYesNo","currentFileNames","programStageSections","section","sortStageEvents","currentEventOriginal","currentStageEventsOriginal","saveReturn","reject","eventToSave","backgroundUpdate","eventDateSaved","updateSuccess","failed","pending","updateFileNames","latitudeSaved","longitudeSaved","saveDatavalueLocation","saveEventDate","reOrder","saveEventDateForEvent","saveDueDate","dueDateSaved","invalidDueDate","clearNote","getInputDueDateClass","getInputNotifcationClass","custom","completeEnrollmentAllowed","ignoreEventId","dv","completeIncompleteEvent","inTableView","modalDefaults","$setSubmitted","sections","warningSection","itemType","actionButtons","class","remindCompleted","completedDate","modalResult","executeCompleteIncompleteEvent","eventIsLocked","setStatusColor","sendAlerts","allowGenerateNextVisit","now","diff","skipUnskipEvent","executeSkipUnskipEvent","deleteEvent","executeDeleteEvent","programStageID","GetPreviousEventPage","getEventPage","openStagesEvent","openEmptyStage","skipCurrentEventStyle","getDescriptionTextForEventStyle","label","getColumnWidth","weight","sortEventsByDate","sortedEvents","sortedEvent","operation","eventFilteringRequired","visited","showLastEventInStage","stageId","showDataEntryForEvent","$submitted","direction","deselectCurrent","abortDeselect","showCompleteErrorMessageInModal","fieldName","isWarning","messages","headerPrefix","compareModeColDefs","otherEvent","otherEvents","getCompareModeColSize","colId","otherEventsCnt","otherStageEvents","maxCompareItemsInCompareView","setOtherStageEvents","otherStageEventIndexes","stageEventsExcludedSkipped","indexOfCurrent","stageEvent","relative","unshift","indexContainer","navigateOtherStageEvents","change","readyCompareDisplayForm","buttonType","forward","showOtherEventsNavigationButtonInCompareForm","firstEventPosition","lastEventRelativePosition","currentStageEventNumber","getStageStyle","eventToFetch","getEventForStage","stageStyle","getMainMenuItemStyle","getEventForStages","descriptionType","translateText","getStageStyleLabel","getEventStyleLabel","lastComplete","firstOpen","itiratedEvent","stagesInputArray","isString","stageString","eventsForStages","getEventFromEventCollection","eventCollection","openStageFormFromEventLayout","openStageEvent","stageOpenInEventLayout","timelineFilterArr","noEventFoundFunc","getEventFromStageSelection","latest","getStageEventCnt","cnt","getValueTitleCompareForm","getGestAgeForANCEventContainer","getStageErrorMessageInEventLayout","resetStageErrorInEventLayout","downloadFile","dataElementUid","stopPropagation","preventDefault","deleteFile","categoryOptionComboFilter","editAttributeCategoryOptions","attributeCategoryOptions","selectedOptions","categoryOptions","selectedOption","join","saveAttributeCategoryOptions","changedCat","acos","attributeOptionCombo","getOptionSaveNotifcationClass","hideEditAttributeCategoryOptions","completeIncompleteEventFromTable","$eval","cancel","makeReferral","referralDate","dateError","orgError","defaultRequestError","completeIncompleteEventModal","requestError","modalForm","deleteEventModal","skipUnskipEventModal","closeEventModal","dismiss","removeFuturePeriodFilter","isScheduleEvent","isReferralEvent","selectedStage","dueDateInvalid","eventDateInvalid","stageSpecifiedOnModalOpen","pleaseSelectLabel","referenceOffset","prepareEvent","invalid","selectedPeriod","suggestStage","availableStagesOrdered","lastStageForEvents","localeCompare","availableStage","save","getCategoryOptions","eventCreationForm","orgUnitError","newEvents","orgUnitsLoading","generateFieldsUrl","getOrgUnits","orgWithParents","org","orgUnitsById","childrenLoaded","child","fieldUrl","parentStartDefault","parentEndDefault","level","parentStart","parentEnd","fetchPeriod","applyOptions","showProgramReportDetailsDiv","enrollmentsByProgram","dataFetched","dataExists","report","eventList","programName","showProgramReportDetails","selectedReport","providedElsewhereExists","keys","enr","reportStarted","dataReady","generateReport","teiList","hasData","displayMode","printMode","xFunction","yFunction","y","active","completed","cancelled","enrollmentList","totalEnrollment","enrollmentStat","skipped","overdue","ontime","eventStat","reportFinished","generateGridHeader","overdueEvent","eventName","eventCol","gridColumn","overDueEvent","searchInGrid","currentFilter","removeStartFilterText","gridColumnId","start","removeEndFilterText","end","generateReportData","generateReportHeader","$watchCollection","upcomingEvent","registrationDate","upcomingDueEvent","dates","selectedDate","datePicker","numOfDays","getDateAfterOffsetDays","hideDatePicker","RelationshipFactory","showAddRelationshipDiv","relationships","relatedTeis","rels","rel","setRelationships","showAddRelationship","related","removeRelationship","relationship","relId","trimmedTei","dashboardProgram","relatedProgram","trackedEntityInstanceA","relName","aIsToB","trackedEntityInstanceB","bIsToA","getRelativeAttributes","mainTei","addingTeiAssociate","selectedRelationship","selectedTeiForDisplay","showAdvancedSearchDiv","selectedTrackedEntity","teiAddLabel","setRelationshipOwner","selectedProgramForRelative","resetFields","teiForRelationship","teiCount","relationshipInfo","getRelationshipInfo","addRelationship","setAttributesForSearch","showHideSearch","simpleSearch","setRelationshipSides","side","assignRelationship","relativeTei","assignInheritance","t","getRelationshipOwner","inherit","customFormExists","setRelationshipInfo","enrollmentEditing","listenToBroadCast","customForm","enableEdit","showNotesDiv","clear","$parent","biggerWidget","smallerWidget","widgetTitle","emptyFeedbackListLabel","emptyIndicatorListLabel","lastEventUpdated","widgetTitleLabel","displayTextEffects","displayKeyDataEffects","textInEffect","keyDataInEffect","round","showKeyDataSection","showTextSection","MessagingService","showMessagingDiv","messageTypes","selectedMessageType","smsMessage","emailMessage","foundPhoneNumber","foundEmailId","phoneNumber","emailId","messagingForm","emailSubject","showMessaging"],"mappings":"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;AACA;AACA,UAAS;AACT;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;;AAEA;AACA;;AAEA,wCAAuC;AACvC;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;;AAEA,a;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA,6BAA4B,kBAAkB;AAC9C;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA,6BAA4B,kBAAkB;AAC9C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;;AAEA;AACA;AACA,iC;AACA;AACA,uD;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8C;AACA;AACA;AACA;AACA,6F;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA,sBAAqB,sBAAsB,M;AAC3C;AACA;AACA;AACA;AACA,kCAAiC,8BAA8B;AAC/D;AACA;AACA;AACA;AACA;AACA;AACA,0B;AACA,UAAS;AACT;AACA;AACA,UAAS;AACT;AACA;AACA,UAAS;AACT,iC;AACA;AACA;AACA;AACA,UAAS;AACT;AACA,0D;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,gCAA+B,wBAAwB;AACvD;;AAEA;AACA;;AAEA;AACA;AACA,sBAAqB;;AAErB;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kDAAiD,mCAAmC;AACpF;AACA;AACA;AACA,kDAAiD,MAAM,iEAAiE,8BAA8B;AACtJ;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,sDAAqD,oCAAoC;;;AAGzF;AACA;AACA;AACA;AACA,+NAA8N,kDAAkD;AAChR;AACA;AACA;AACA;AACA;AACA,qHAAoH,8BAA8B;AAClJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2DAA0D,wEAAwE;AAClI;AACA;AACA,4KAA2K,8BAA8B;AACzM;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qKAAoK,qBAAqB;AACzL,uKAAsK,oBAAoB;AAC1L;AACA;AACA;AACA;AACA;AACA,8DAA6D,mCAAmC;AAChG,2DAA0D,wEAAwE;AAClI;AACA;AACA;AACA;AACA;AACA;AACA,0IAAyI,8BAA8B;AACvK;AACA;AACA;AACA,2DAA0D,wEAAwE;AAClI;AACA,mJAAkJ,8BAA8B;AAChL;AACA;AACA;AACA,2DAA0D,wEAAwE;AAClI;AACA,mJAAkJ,8BAA8B;AAChL;AACA;AACA;AACA;AACA,wLAAuL,8LAA8L;AACrX;AACA;AACA;AACA,qHAAoH,wBAAwB;AAC5I;AACA;AACA,sHAAqH,wBAAwB;AAC7I;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kFAAiF,8BAA8B;AAC/G;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mFAAkF,8BAA8B;AAChH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mFAAkF,8BAA8B;AAChH;AACA;AACA;AACA;AACA,4EAA2E,oBAAoB;AAC/F,0DAAyD,wCAAwC;AACjG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mFAAkF,8BAA8B;AAChH;AACA;AACA;AACA;AACA,2DAA0D,wEAAwE;AAClI;AACA,yIAAwI,8BAA8B;AACtK;AACA;AACA,6GAA4G;AAC5G;AACA;AACA;AACA,uGAAsG,8BAA8B;AACpI;AACA;AACA;AACA,2DAA0D,wEAAwE;AAClI;AACA,yIAAwI,8BAA8B;AACtK;AACA;AACA,0DAAyD,uCAAuC;AAChG;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;;AAGA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,yBAAwB;AACxB;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,kBAAiB;;;AAGjB;AACA;AACA;AACA;AACA;;AAEA,gCAA+B,wBAAwB;AACvD;AACA;AACA;;AAEA;AACA;AACA,sBAAqB;;AAErB;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,yGAAwG;AACxG,yIAAwI,kDAAkD;AAC1L;AACA;AACA;AACA;AACA,iHAAgH,2BAA2B;AAC3I;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yGAAwG;AACxG;AACA;AACA;AACA,sIAAqI,2BAA2B;AAChK;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8JAA6J,qBAAqB;AAClL,+JAA8J,oBAAoB;AAClL;AACA;AACA;AACA,0GAAyG;AACzG;AACA,0DAAyD,mCAAmC;AAC5F;AACA;AACA;AACA;AACA;AACA,kGAAiG,2BAA2B;AAC5H;AACA;AACA,yGAAwG;AACxG;AACA;AACA,2GAA0G,2BAA2B;AACrI;AACA;AACA,yGAAwG;AACxG;AACA;AACA,kGAAiG,2BAA2B;AAC5H;AACA;AACA;AACA,gHAA+G;AAC/G;AACA;AACA;AACA;AACA,4EAA2E,qBAAqB,GAAG,0CAA0C;AAC7I;AACA;AACA,8EAA6E,yBAAyB;AACtG;AACA;AACA;AACA;AACA,4EAA2E,wBAAwB,GAAG,0CAA0C;AAChJ;AACA;AACA,8EAA6E,yBAAyB;AACtG;AACA;AACA;AACA;AACA;AACA,8GAA6G,2BAA2B;AACxI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sIAAqI,2BAA2B;AAChK;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sIAAqI,2BAA2B;AAChK;AACA;AACA;AACA,2EAA0E,oBAAoB;AAC9F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8HAA6H,2BAA2B;AACxJ;AACA;AACA,wFAAuF;AACvF;AACA;AACA;AACA;AACA,2FAA0F;AAC1F;AACA;AACA;AACA;AACA,2FAA0F;AAC1F;AACA;AACA;AACA,uC;AACA,yDAAwD,uCAAuC;AAC/F,kC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,mFAAkF;AAClF;AACA;AACA;AACA;AACA,kDAAiD,mCAAmC;AACpF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mFAAkF;AAClF;AACA;AACA;AACA;AACA,kDAAiD,mCAAmC;AACpF;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,yBAAwB;AACxB;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA,4BAA2B,2BAA2B;AACtD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kDAAiD,sBAAsB;AACvE;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,qDAAoD,iCAAiC;AACrF;;AAEA,cAAa;AACb;AACA;AACA;AACA;AACA;AACA,qDAAoD,kDAAkD;AACtG;AACA;AACA,wDAAuD,sBAAsB;AAC7E;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,EAAC;;AAED;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;;AAEA;AACA;;AAEA,EAAC;;AAED;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;;AAEb;;AAEA;AACA;;AAEA,EAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oCAAmC;AACnC;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,UAAS;AACT;;AAEA;AACA;AACA;AACA,EAAC;AACD;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,4BAA2B,+BAA+B;AAC1D;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA,wBAAuB,2BAA2B;AAClD,2BAA0B,kCAAkC;AAC5D;;AAEA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA,sBAAqB;AACrB;AACA;AACA,kBAAiB;AACjB,cAAa;AACb;AACA,UAAS;AACT;AACA;AACA;AACA,sDAAqD,2CAA2C;AAChG;AACA,kBAAiB;AACjB;AACA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA,EAAC;;AAED;AACA;;AAEA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA,cAAa;AACb;AACA,UAAS;AACT;AACA;AACA;AACA,cAAa;AACb;AACA,cAAa;AACb;AACA,UAAS;AACT;AACA;AACA;AACA,4BAA2B,8CAA8C;AACzE;AACA;AACA,cAAa;AACb;AACA,cAAa;AACb;AACA;AACA;AACA,EAAC;AACD;AACA;AACA;AACA,2BAA0B,wEAAwE;AAClG,0BAAyB,uEAAuE;AAChG,0BAAyB,qBAAqB,eAAe,uBAAuB,WAAW,EAAE;;AAEjG;AACA;AACA;AACA,UAAS;;AAET;AACA;;AAEA,Y;AACA,0C;AACA,kC;AACA;AACA,iG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA,sFAAqF,SAAS;AAC9F,8EAA6E,SAAS;AACtF,kFAAiF,YAAY;AAC7F,0FAAyF,YAAY;AACrG,0FAAyF,qBAAqB;AAC9G,0FAAyF,qBAAqB;AAC9G;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA,8BAA6B;;AAE7B;AACA;;AAEA;AACA;AACA;AACA,8BAA6B;;AAE7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAiC;AACjC;AACA;;AAEA;AACA,6FAA4F,YAAY;AACxG,uFAAsF,YAAY;AAClG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAiC;AACjC;AACA;;AAEA;AACA,6FAA4F,qBAAqB;AACjH,uFAAsF,qBAAqB;AAC3G;;AAEA;AACA;AACA;AACA,sBAAqB;;AAErB,8CAA6C;;AAE7C,qH;AACA,yH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAiC,E;AACjC,8CAA6C,mKAAmK;AAChN,8BAA6B;AAC7B,0BAAyB;AACzB,sBAAqB;AACrB,kBAAiB,E;AACjB,cAAa,E;AACb;AACA;AACA,O;AACA,EAAC;AACD;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA,UAAS;;AAET;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA,UAAS;AACT;AACA;AACA,UAAS;AACT;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,0BAAyB;AACzB,sBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAsC,oBAAoB;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mDAAkD,oCAAoC;AACtF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;;AAEb;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,cAAa;;AAEb;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;AAEA;AACA,iC;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,iCAAgC;AAChC;AACA,6DAA4D,SAAS;AACrE;AACA;AACA;AACA,8DAA6D,iBAAiB,iBAAiB,iBAAiB,gBAAgB;;AAEhI;AACA;AACA,mHAAkH,wBAAwB;AAC1I;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;;AAEA;AACA,kCAAiC;AACjC;AACA,wDAAuD,SAAS;AAChE;AACA;AACA;AACA,8DAA6D,gBAAgB;;AAE7E;AACA;AACA;AACA,mEAAkE,wBAAwB;AAC1F;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;;AAEA;AACA,kCAAiC;AACjC;AACA,wDAAuD,SAAS;AAChE;AACA;AACA;AACA,8DAA6D,gBAAgB;;AAE7E;AACA;AACA;AACA,mEAAkE,wBAAwB;AAC1F;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;;AAEA;AACA,kCAAiC;AACjC;AACA,wDAAuD,SAAS;AAChE;AACA;AACA;AACA,8DAA6D,gBAAgB;;AAE7E;AACA;AACA;AACA,mEAAkE,wBAAwB;AAC1F;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;;AAEA;AACA;;AAEA;AACA;AACA;AACA,mCAAkC,mCAAmC;AACrE,kBAAiB,oCAAoC;AACrD,kBAAiB,qCAAqC;AACtD,kBAAiB,oCAAoC;AACrD,kBAAiB,6BAA6B;AAC9C,kBAAiB,+BAA+B;AAChD,kBAAiB,sBAAsB;AACvC,kBAAiB,+BAA+B;AAChD,kBAAiB,4BAA4B;AAC7C,kBAAiB,4BAA4B;AAC7C,kBAAiB,6BAA6B;AAC9C,kBAAiB,sCAAsC;AACvD,kBAAiB,oCAAoC;AACrD,kBAAiB,4BAA4B;AAC7C,kBAAiB,6BAA6B;AAC9C,kBAAiB,gCAAgC;AACjD,kBAAiB,qCAAqC;AACtD,kBAAiB,uCAAuC;AACxD,kBAAiB,wCAAwC;AACzD,kBAAiB,0CAA0C;AAC3D,kBAAiB,4BAA4B;AAC7C,kBAAiB,6BAA6B;AAC9C,kBAAiB,iCAAiC;AAClD,kBAAiB,6BAA6B;AAC9C,kBAAiB,8BAA8B;AAC/C;AACA;AACA,2BAA0B,2BAA2B;AACrD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,4CAA2C,uBAAuB;AAClE;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4CAA2C,uBAAuB;AAClE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,uDAAsD,qCAAqC;AAC3F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uDAAsD,qCAAqC;AAC3F;AACA;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,+CAA8C,gCAAgC;AAC9E;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,+CAA8C,oCAAoC;AAClF;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA6B;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB,kBAAiB;;AAEjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,2BAA0B;;AAE1B;AACA,iD;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,8CAA6C,uCAAuC;AACpF;AACA;AACA,cAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,cAAa;;AAEb;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,4DAA2D,iBAAiB;AAC5E;AACA;AACA;AACA,+DAA8D,iBAAiB;AAC/E,sBAAqB,E;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,0EAAyE,qBAAqB;;AAE9F;AACA;AACA;AACA;AACA,uFAAsF,4CAA4C;AAClI;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,iDAAgD;AAChD;AACA;;AAEA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,8EAA6E,gBAAgB;AAC7F;AACA;AACA;AACA;AACA;AACA;AACA,2DAA0D;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAiC;AACjC;AACA;AACA,8BAA6B;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qGAAoG,iBAAiB,gBAAgB;;AAErI;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB,kBAAiB;;AAEjB;AACA;AACA,kEAAiE,4EAA4E;AAC7I;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,6D;AACA;AACA;AACA;AACA;AACA;AACA;AACA,YAAW,E;AACX,cAAa;AACb;AACA;AACA;;AAEA,mF;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;;AAGA,8BAA6B,qC;AAC7B,iCAAgC;;AAEhC,gJ;AACA,2F;AACA,qK;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0BAAyB;;AAEzB;AACA;AACA;AACA;AACA;AACA,iCAAgC;AAChC,sBAAqB;AACrB,kBAAiB,E;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC,gCAAgC;AAChE;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6BAA4B,qCAAqC;AACjE;AACA;AACA;AACA;AACA;AACA;AACA,2E;AACA;AACA;;AAEA;AACA;AACA;AACA,mCAAkC,mCAAmC;AACrE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,cAAa,E;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA,kBAAiB;AACjB,cAAa;AACb,UAAS;AACT;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,sBAAqB;AACrB;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb,qBAAoB;AACpB,UAAS;AACT;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,cAAa;;AAEb,qBAAoB;AACpB,UAAS;AACT;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA,gCAA+B,uCAAuC;AACtE;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,+BAA8B,wEAAwE;AACtG;AACA,cAAa;;AAEb;;AAEA;AACA,iCAAgC;AAChC;AACA;;AAEA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA,yBAAwB,qCAAqC;AAC7D;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;;AAEA,UAAS;AACT;AACA;;AAEA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA,EAAC;;;;AAID;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA,UAAS;AACT;AACA,kC;AACA,sE;AACA;AACA;AACA,yP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB,c;AACA;AACA,UAAS;AACT;AACA,kC;AACA,sE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB,c;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA,cAAa;AACb;AACA,UAAS;AACT;AACA;AACA,qEAAoE;AACpE;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA,UAAS;AACT;AACA,oCAAmC;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA,mB;AACA,yB;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0CAAyC;AACzC;AACA,kCAAiC;AACjC;AACA;AACA,iD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC,E;;;;;;ACtzGD;;AAEA;;AAEA;;AAEA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA,kEAAiE;AACjE;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA,cAAa;;AAEb;AACA;AACA;AACA,2BAA0B;AAC1B;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA,EAAC;;AAED;;AAEA;AACA,iBAAgB,yBAAyB;AACzC;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA,cAAa;AACb;AACA;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,cAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA,UAAS;AACT;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA,UAAS;AACT;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA,cAAa;;AAEb;AACA;AACA;AACA;;AAEA;AACA,gCAA+B,gDAAgD;AAC/E;AACA;AACA;AACA;AACA;;AAEA;AACA,gCAA+B,iDAAiD;AAChF;AACA;AACA;AACA;AACA;AACA,+BAA8B;AAC9B;AACA;AACA;AACA;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA,EAAC;;AAED;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,kBAAiB;;AAEjB;AACA,cAAa;;AAEb;AACA;AACA,cAAa;;AAEb;AACA;AACA,cAAa;AACb;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA,kBAAiB;AACjB;;AAEA;;AAEA;AACA;AACA;AACA,cAAa;;AAEb;AACA;AACA;AACA,cAAa;AACb;AACA;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;;AAEA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4DAA2D,8CAA8C,uDAAuD;AAChK;AACA;AACA;AACA,8BAA6B;AAC7B;AACA;AACA;AACA;AACA;AACA;;AAEA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,0BAAyB;AACzB;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA,kEAAiE,+BAA+B;AAChG;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA6B;AAC7B;AACA;AACA,8BAA6B;AAC7B;AACA;AACA,8BAA6B;AAC7B;AACA;AACA;AACA;AACA,sBAAqB;AACrB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,0BAAyB;AACzB;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,6DAA4D,iBAAiB;AAC7E;AACA;AACA;AACA;AACA;AACA;AACA,8BAA6B;AAC7B;AACA;AACA,8BAA6B;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,cAAa;AACb;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA0B;AAC1B;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA,iB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;;AAEA,UAAS;AACT;;AAEA,6BAA4B;;AAE5B;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,gDAA+C,0BAA0B;AACzE;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA,kBAAiB;;AAEjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA,8CAA6C,aAAa;AAC1D;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,cAAa;AACb;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA,iB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA,UAAS;AACT;;AAEA;AACA;AACA;;AAEA,2D;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,0BAAyB;AACzB;AACA;AACA;AACA;AACA,kBAAiB;;AAEjB;AACA;AACA;AACA;AACA;AACA;AACA,0B;AACA,sB;AACA,kBAAiB;AACjB,kBAAiB;AACjB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT,6G;AACA;;AAEA;AACA,yD;AACA,0F;AACA;AACA;AACA;AACA;;AAEA,2F;AACA;AACA;AACA;AACA,+DAA8D;AAC9D;AACA;AACA;AACA;AACA,kB;AACA;AACA;AACA;AACA;;AAEA;;AAEA,yC;;AAEA,kC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,qCAAoC;AACpC;AACA;AACA,kBAAiB;;AAEjB,gE;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,qF;;AAEA,oE;AACA;AACA;AACA,6DAA4D,yCAAyC;AACrG;AACA;AACA;AACA;AACA;AACA;AACA,6DAA4D,+CAA+C;AAC3G;AACA,0B;AACA;AACA,kBAAiB;AACjB,kBAAiB;AACjB;;AAEA,mE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sB;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,2DAA0D;AAC1D;AACA;AACA;AACA;AACA,qDAAoD,YAAY,G;AAChE;AACA;AACA;AACA,yDAAwD,YAAY;AACpE;AACA,sB;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,gE;AACA,mK;AACA;AACA;AACA;AACA;AACA;;AAEA,yF;AACA;AACA;AACA,e;AACA,UAAS;AACT;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;;AAEA,UAAS;AACT,sC;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,mE;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;;AAEb,yC;AACA,6B;AACA;;AAEA;AACA,8CAA6C,+IAA+I;AAC5L;AACA;AACA;;AAEA;AACA;AACA;;AAEA,4D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sB;AACA;AACA;AACA;AACA;AACA;AACA,EAAC,E;;;;;;AC39BD;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,oE;AACA;AACA;AACA;AACA;AACA;AACA,oE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,0D;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,kB;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,e;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,c;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;;AAEA;;AAEA,oE;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA,yD;;AAEA;;AAEA;AACA,kCAAiC;AACjC;;AAEA;;AAEA,4D;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,0B;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4D;AACA;AACA;AACA,8B;AACA;AACA,0BAAyB;AACzB;AACA;AACA;AACA;;AAEA;AACA;AACA,c;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,kB;AACA,cAAa,E;AACb;AACA;AACA,EAAC,E;;;;;;ACjPD;;AAEA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,U;AACA,c;;AAEA,gCAA+B;AAC/B,gCAA+B;AAC/B,kCAAiC;AACjC;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,wE;AACA,wF;AACA;;AAEA;AACA,U;AACA,O;;AAEA;AACA,yD;AACA;AACA,oE;AACA,+D;;AAEA;AACA;AACA,U;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,U;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,U;;AAEA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;;AAEA,iDAAgD,gBAAgB;;AAEhE;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA,wBAAuB,aAAa;AACpC;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA,4B;AACA,0C;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;;;;;;;ACjKD;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA,6B;AACA,wC;AACA;AACA;AACA,wC;AACA;;AAEA;AACA;AACA;AACA;AACA,O;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,2BAA0B,EAAE,yBAAyB,EAAE,EAAE,EAAE,EAAE,EAAE;AAC/D;AACA,qCAAoC;AACpC;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,iE;;AAEA;;AAEA;;AAEA;;AAEA;;AAEA,sBAAqB,8C;;AAErB;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,M;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA,sBAAqB;;AAErB,2BAA0B;AAC1B;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,kBAAiB;AACjB;AACA;AACA;AACA;AACA;;AAEA,sFAAqF,KAAK,qEAAqE;;AAE/J;AACA;AACA;;AAEA;;AAEA,0C;AACA;AACA,UAAS;AACT;AACA;AACA,UAAS,E;;AAET;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA,kCAAiC;AACjC;AACA;AACA;AACA,kCAAiC;AACjC;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA,kCAAiC;AACjC;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA;AACA,kCAAiC;AACjC;AACA;AACA;AACA,kCAAiC;AACjC;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA,kCAAiC;AACjC,kBAAiB;AACjB,cAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA,kCAAiC;AACjC;AACA;AACA;AACA,kCAAiC;AACjC;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA;AACA,kCAAiC;AACjC;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA,kCAAiC;AACjC;AACA;AACA;AACA,kCAAiC;AACjC;AACA;AACA;AACA;AACA,sCAAqC;AACrC;AACA,kCAAiC;AACjC,kBAAiB;AACjB,U;AACA,M;;AAEA,4D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gC;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA,0CAAyC;;AAEzC;AACA;AACA,4F;AACA;AACA;AACA;AACA;AACA;AACA,0E;AACA,6E;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8B;AACA;AACA,sBAAqB;;AAErB;AACA;AACA,sB;AACA;AACA,kD;AACA,qDAAoD,wBAAwB;AAC5E;AACA;AACA,kBAAiB;AACjB,cAAa;AACb;AACA;;AAEA;AACA;AACA;AACA,U;AACA;;AAEA;AACA;AACA,kD;AACA,8BAA6B,KAAK;AAClC;AACA;AACA,8BAA6B,KAAK;AAClC;;AAEA,4BAA2B;AAC3B;;AAEA;AACA,6B;AACA,qC;AACA;AACA;AACA,c;AACA,oD;AACA;AACA,U;AACA;;AAEA;AACA;AACA,qC;AACA;AACA;AACA;AACA,oD;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,cAAa,a;;AAEb;AACA,kCAAiC,KAAK;AACtC,oCAAmC;;AAEnC,kE;AACA;AACA,sCAAqC,KAAK;AAC1C,wCAAuC;AACvC,kBAAiB;AACjB,cAAa;AACb,UAAS;AACT;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA,uD;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA,0C;AACA;AACA;AACA,U;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,kBAAiB;AACjB;AACA;AACA;AACA,sBAAqB;AACrB;AACA,sBAAqB;AACrB;AACA,c;AACA;AACA,O;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,gCAA+B;AAC/B;AACA;;AAEA;AACA;AACA,MAAK;;AAEL;AACA;AACA,MAAK;AACL,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA,qBAAoB;AACpB;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,gCAA+B,4BAA4B,W;AAC3D,oD;AACA,+BAA8B;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,uD;AACA;AACA;AACA,kF;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA,MAAK;AACL;AACA,MAAK;AACL,EAAC;;AAED;;AAEA,qBAAoB;AACpB;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,0BAAyB,4BAA4B;AACrD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,sBAAqB,oBAAoB;AACzC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb,UAAS;;AAET;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kDAAiD,YAAY;AAC7D;AACA;;AAEA;AACA,kDAAiD,YAAY;AAC7D;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0BAAyB;AACzB;AACA;AACA,cAAa;AACb;AACA,MAAK;;;AAGL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB,cAAa;AACb;AACA;AACA;AACA;AACA;;AAEA;AACA,sCAAqC;AACrC;AACA;AACA;;AAEA;AACA,gCAA+B,mEAAmE;AAClG;;AAEA,+B;AACA;AACA;AACA,EAAC;;;;;;;ACtqBD,oFAAmF,0HAA0H,2DAA2D,oBAAoB,+SAA+S,oBAAoB,4BAA4B,oBAAoB,mFAAmF,8BAA8B,sJAAsJ,sBAAsB,mHAAmH,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AEA;;AAEA;AACA;AACA;AACA;;AAEA;;;AAGA;AACA;AACA;;AAEA;AACA,2BAA0B;AAC1B;AACA;;AAEA,oCAAmC,SAAS;AAC5C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF,4BAA2B;AAC3B;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAI;;AAEJ;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA,4BAA2B;AAC3B;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA,yBAAwB,cAAc;AACtC;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF,iCAAgC;AAChC;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA,cAAa,4BAA4B;AACzC;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,yBAAwB,yBAAyB;;;AAGjD;AACA;;AAEA;AACA;AACA,IAAG;AACH;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,EAAC;;AAED;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,8BAA6B;AAC7B;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA,+BAA8B,QAAQ;;AAEtC;AACA;AACA;;AAEA;;AAEA,iDAAgD,SAAS;AACzD;AACA;AACA;;AAEA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,sCAAqC;AACrC;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA,mDAAkD;;AAElD;AACA,4EAA2E,aAAa;;AAExF,uDAAsD;AACtD;AACA;;AAEA;AACA;;AAEA,kCAAiC,SAAS;AAC1C;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;;AAGA,KAAI;AACJ;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF,sCAAqC;AACrC;AACA;AACA;AACA,GAAE;;AAEF,sDAAqD;;AAErD;AACA;AACA;;AAEA;AACA;AACA;;AAEA,+EAA8E,aAAa;;AAE3F;AACA;AACA;;AAEA;;AAEA,kCAAiC,SAAS;AAC1C;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,KAAI;AACJ;;AAEA;AACA,oCAAmC,QAAQ;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF,oCAAmC;AACnC;AACA;AACA;;AAEA,+BAA8B,SAAS,2BAA2B;;AAElE;AACA;;AAEA;AACA;AACA;;AAEA,uCAAsC,SAAS;AAC/C;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,wCAAuC,SAAS;AAChD;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;;AAEA,mFAAkF,aAAa;;AAE/F;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA,6BAA4B;AAC5B,WAAU,QAAQ;;AAElB;;AAEA,sCAAqC,SAAS;AAC9C;AACA;AACA;;AAEA;AACA;AACA,4BAA2B;AAC3B;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF,+BAA8B;AAC9B;AACA;AACA;AACA,GAAE;;AAEF,8BAA6B;AAC7B;AACA,GAAE;;AAEF,4BAA2B;AAC3B;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF,4BAA2B;AAC3B;;AAEA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF,iCAAgC;AAChC;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA,6BAA4B;AAC5B;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,sCAAqC;AACrC;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA,4DAA2D,OAAO;;AAElE;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA,IAAG;;AAEH;;AAEA;AACA,yBAAwB,OAAO;;AAE/B;AACA;;AAEA;AACA,IAAG;;AAEH;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,yCAAwC,SAAS;AACjD;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,IAAG;AACH;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;;AAEA;AACA;;AAEA,IAAG;;AAEH;AACA;;AAEA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA,uBAAsB,QAAQ;AAC9B;;AAEA;;AAEA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;;AAEA,kBAAiB,kBAAkB;AACnC;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF,gDAA+C;;AAE/C;AACA;;AAEA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,cAAa;;AAEb;AACA;AACA;AACA,UAAS;AACT,MAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;;AAEb;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;;AAEA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA,GAAE;AACF,EAAC;;;AAGD;AACA;AACA;;AAEA,sCAAqC;AACrC;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA,0BAAyB;AACzB,cAAa,cAAc;;AAE3B;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF,kCAAiC;AACjC;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,gCAA+B;AAC/B;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF,yBAAwB;AACxB;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA,6BAA4B;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AAIA;AACA;AACA;;AAEA,mDAAkD;AAClD,mBAAkB,QAAQ;;AAE1B;;AAEA,uCAAsC,SAAS;AAC/C;AACA;AACA;;AAEA;AACA;AACA,0BAAyB;AACzB,cAAa,aAAa;;AAE1B;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA,+BAA8B;AAC9B;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF,0BAAyB;AACzB;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF,4BAA2B;AAC3B;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA,GAAE;;AAEF,iCAAgC;AAChC;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF,6BAA4B;AAC5B,iBAAgB,cAAc;;AAE9B;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;;AAEA,mCAAkC;AAClC;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;;;AAGA;AACA;AACA;;AAEA;AACA;;AAEA,8BAA6B;AAC7B;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF,+BAA8B;AAC9B;AACA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA,0CAAyC;AACzC;AACA;;AAEA;AACA,GAAE;;AAEF,yCAAwC;AACxC;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA,2BAA0B;AAC1B;AACA;;AAEA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;AACA;;AAEA,6BAA4B;AAC5B;;AAEA;AACA;;AAEA,8BAA6B;AAC7B;AACA;AACA;AACA;AACA,EAAC;;AAED,+BAA8B;AAC9B;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA,6BAA4B;AAC5B;;AAEA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF,sCAAqC;AACrC;;;AAGA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA,0DAAyD,YAAY;AACrE;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;;AAGF;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,gDAA+C,cAAc;AAC7D,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;;AAEA,yCAAwC,cAAc;AACtD,GAAE;;AAEF;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF,qCAAoC;AACpC,4CAA2C,aAAa;AACxD,GAAE;;AAEF,4BAA2B;AAC3B;AACA;;AAEA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA,kCAAiC,aAAa;;AAE9C;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA,0BAAyB,aAAa;;AAEtC;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA,2BAA0B,aAAa;;AAEvC;AACA;AACA;;AAEA;;AAEA;AACA,8BAA6B,aAAa;AAC1C;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA,gBAAe,cAAc;;AAE7B;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA,uBAAsB,aAAa;;AAEnC;AACA;AACA;AACA,IAAG,sBAAsB,cAAc;;AAEvC;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,gCAA+B,aAAa;;AAE5C;AACA;;AAEA,IAAG;AACH;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA,uBAAsB,aAAa;;AAEnC;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;;AAGF;;AAEA,0BAAyB;AACzB;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF,qDAAoD;AACpD;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA,IAAG;;AAEH;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;;AAGF;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;;AAGF;;AAEA,oCAAmC;AACnC;AACA;AACA,GAAE;;AAEF,qCAAoC;AACpC;AACA;AACA,GAAE;;AAEF,wCAAuC;AACvC;AACA;AACA,GAAE;;AAEF,yCAAwC;AACxC;AACA;AACA,GAAE;;AAEF,gDAA+C;AAC/C;AACA,GAAE;;AAEF,gDAA+C;AAC/C;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF,4CAA2C;AAC3C;AACA,GAAE;;AAEF,wCAAuC;AACvC;AACA,GAAE;;AAEF,oCAAmC;AACnC;AACA,GAAE;;;AAGF;;AAEA;AACA;;AAEA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,uCAAsC,SAAS;AAC/C;AACA;AACA,GAAE;;;AAGF;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA,IAAG;AACH;AACA;;AAEA;;AAEA;AACA;;AAEA,2BAA0B,yBAAyB;;AAEnD;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA,yBAAwB,yBAAyB;AACjD,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,yBAAwB;AACxB;AACA,IAAG;AACH;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;AACA,qBAAoB,QAAQ;;AAE5B;;AAEA;;AAEA;AACA;AACA;;AAEA,mCAAkC,SAAS;AAC3C;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,wBAAuB,sBAAsB,sBAAsB,EAAE,EAAE;AACvE,GAAE;;AAEF;AACA;AACA;AACA;AACA,wCAAuC,QAAQ;;AAE/C;AACA;AACA,GAAE;;AAEF;AACA,iDAAgD,QAAQ;;AAExD;;AAEA;;AAEA,uCAAsC,QAAQ;;AAE9C;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA,+CAA8C,SAAS;AACvD;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,0BAAyB,aAAa;AACtC,GAAE;;;AAGF;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,iBAAgB,eAAe;;AAE/B;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,iBAAgB,eAAe;;AAE/B;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA,yCAAwC;AACxC;;AAEA;AACA;;AAEA;AACA;;AAEA,8BAA6B;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF,+BAA8B;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;;;AAIA,6BAA4B;AAC5B;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,GAAE;AACF,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA,KAAI;AACJ;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA,KAAI;AACJ;;AAEA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,iBAAgB,WAAW;AAC3B;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;AACA;AACA;;AAEA,mCAAkC,SAAS;;AAE3C;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA,KAAI;AACJ;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,6BAA4B,uBAAuB;AACnD;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;;AAEA,oBAAmB,QAAQ;;AAE3B;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;;AAEA,yBAAwB,mBAAmB;AAC3C,0BAAyB,mBAAmB;AAC5C;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA,2BAA0B,QAAQ;;AAElC;AACA;AACA;AACA,IAAG;;AAEH;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA,cAAa,iBAAiB;AAC9B;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,iBAAgB;AAChB;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA,iDAAgD,cAAc;AAC9D;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA,+CAA8C,cAAc;AAC5D;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,4BAA2B,0BAA0B;;AAErD;AACA;AACA;;AAEA,IAAG;AACH;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA,oCAAmC;;AAEnC;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,KAAI;AACJ;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF,uCAAsC;;AAEtC;;AAEA,8BAA6B;AAC7B;;AAEA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF,oCAAmC;;AAEnC;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,yCAAwC,iCAAiC;;AAEzE;AACA,GAAE;;AAEF;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,iBAAgB,WAAW;AAC3B;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF,+CAA8C;AAC9C;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA,IAAG;AACH;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;;AAEA;;AAEA,mCAAkC,SAAS;AAC3C;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,IAAG;;AAEH;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA,6BAA4B,uBAAuB;AACnD,GAAE;;AAEF;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;;AAGA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA,GAAE;;AAEF;;AAEA,iCAAgC,QAAQ;;AAExC;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA,kBAAiB,mBAAmB;AACpC;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA,oBAAmB,QAAQ;;AAE3B,yGAAwG,QAAQ;;AAEhH;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA,GAAE;;AAEF;;AAEA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA,0BAAyB,YAAY;;AAErC;AACA,oCAAmC,YAAY;AAC/C;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,+CAA8C;;AAE9C;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA,2BAA0B,YAAY;;AAEtC;AACA,qCAAoC,YAAY;AAChD;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA,oBAAmB,QAAQ;;AAE3B;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,mCAAkC;AAClC;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA,wBAAuB,QAAQ;;AAE/B;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA,GAAE;;AAEF;AACA,oBAAmB,QAAQ;;AAE3B;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA,GAAE;;AAEF;AACA,+BAA8B,QAAQ;;AAEtC;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,gEAA+D;AAC/D;AACA;AACA,+CAA8C;AAC9C;AACA;AACA,iEAAgE;AAChE;AACA;AACA,+CAA8C;AAC9C;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA,gDAA+C;AAC/C;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA,uBAAsB,eAAe;;AAErC;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,oCAAmC,SAAS;AAC5C;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA,gBAAe,cAAc;;AAE7B;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA,iCAAgC,aAAa;AAC7C,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA,oCAAmC,aAAa;AAChD,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA,IAAG;;AAEH;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,mBAAkB,mBAAmB;AACrC;AACA;AACA;AACA,GAAE;;AAEF;AACA,0DAAyD,QAAQ;;AAEjE;AACA,GAAE;;AAEF;AACA,uDAAsD,QAAQ;;AAE9D;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,MAAK;AACL,KAAI;AACJ;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;AACA;AACA;AACA;;AAEA,qBAAoB,eAAe;AACnC;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA,GAAE;AACF;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,IAAG;AACH;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA,6CAA4C;AAC5C;AACA;AACA,EAAC;;AAED,mDAAkD;AAClD;AACA,wBAAuB,QAAQ;;AAE/B;AACA;AACA;;AAEA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA,wCAAuC,SAAS;AAChD,6CAA4C,UAAU;AACtD;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA,8BAA6B,QAAQ;;AAErC;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA,gDAA+C,QAAQ;;AAEvD;AACA;AACA;AACA;AACA;;AAEA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED,gFAA+E;AAC/E;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,2BAA0B,QAAQ;AAClC;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA,cAAa,SAAS;AACtB;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;;AAEA;AACA;;AAEA,sBAAqB,eAAe;AACpC;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA,iDAAgD,SAAS;AACzD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA,KAAI;AACJ;AACA;AACA;;AAEA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA,kBAAiB;AACjB;AACA,IAAG,qBAAqB;AACxB;AACA,IAAG,qBAAqB;AACxB;AACA,IAAG,qBAAqB;AACxB;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,4BAA2B;AAC3B;AACA,IAAG,+BAA+B;AAClC;AACA;AACA,4BAA2B;AAC3B;AACA,IAAG,+BAA+B;AAClC;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,8CAA6C,SAAS;AACtD;AACA;AACA,GAAE;;AAEF;AACA,sDAAqD,SAAS;AAC9D;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF,8BAA6B;AAC7B;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,uCAAsC,UAAU;AAChD;AACA,wCAAuC,SAAS;AAChD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,oCAAmC,SAAS;AAC5C;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,qDAAoD,UAAU;AAC9D;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA,qBAAoB,aAAa;AACjC;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA,sCAAqC,SAAS;AAC9C;AACA;AACA,GAAE;;AAEF;AACA,oBAAmB,QAAQ;;AAE3B;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,kCAAiC,SAAS;AAC1C;AACA;;AAEA;AACA,aAAY,OAAO;AACnB;AACA;;AAEA,gDAA+C,SAAS;AACxD;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA,yCAAwC,SAAS;AACjD;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA,sBAAqB,QAAQ;;AAE7B;;AAEA,wCAAuC,SAAS;AAChD;;AAEA,6CAA4C,UAAU;AACtD;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;;AAEA,6BAA4B,QAAQ;;AAEpC,4CAA2C,SAAS;AACpD;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,KAAI;;AAEJ;AACA;AACA;;AAEA;AACA;AACA;AACA,OAAM;AACN;AACA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA,KAAI;;AAEJ;AACA;;AAEA;AACA;AACA,MAAK;;AAEL;AACA;AACA,IAAG;AACH;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA,uCAAsC;AACtC;AACA;AACA;;AAEA;AACA,YAAW;AACX;;AAEA,wCAAuC,SAAS;AAChD;AACA,iDAAgD,UAAU;AAC1D;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA,sCAAqC;AACrC;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA,wCAAuC,SAAS;AAChD;;AAEA,iDAAgD,UAAU;AAC1D;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA,qCAAoC;AACpC;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA,2CAA0C;AAC1C;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA,sCAAqC,SAAS;AAC9C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA,oDAAmD,QAAQ;;AAE3D;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,oCAAmC,SAAS;AAC5C;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,iDAAgD,SAAS;;AAEzD;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF,qCAAoC;AACpC;AACA,GAAE;;AAEF,kEAAiE;AACjE;AACA;;AAEA,mCAAkC,SAAS;AAC3C;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,wCAAuC,SAAS;AAChD;AACA;;AAEA;AACA,GAAE;;AAEF;AACA,qCAAoC,kBAAkB,sBAAsB;AAC5E,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA,EAAC;;AAED;AACA;AACA;AACA;;AAEA;;AAEA;AACA,yCAAwC,SAAS;AACjD;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA,EAAC;;AAED;AACA;AACA;AACA;;AAEA;AACA;AACA,KAAI;;AAEJ;AACA;AACA;AACA,KAAI;AACJ;AACA;;AAEA,2BAA0B,6CAA6C;AACvE,0BAAyB,0CAA0C;;AAEnE;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAI;;AAEJ;AACA;AACA;AACA;AACA,MAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA,kDAAiD;;AAEjD;AACA;AACA;;AAEA,kBAAiB,aAAa;;AAE9B;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA,KAAI;;AAEJ;AACA;;AAEA;AACA,4CAA2C,QAAQ;AACnD;AACA;;AAEA;;AAEA,KAAI;AACJ;AACA;AACA;AACA;;AAEA;AACA,KAAI;AACJ;AACA;;AAEA,IAAG;AACH;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF,4CAA2C;;AAE3C;AACA;AACA;;AAEA,kBAAiB,aAAa;;AAE9B;AACA;AACA,IAAG;AACH;;AAEA,IAAG;;AAEH;AACA;AACA;;AAEA,KAAI;AACJ;AACA,KAAI;AACJ;AACA;AACA,IAAG;AACH;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;;AAEA;AACA;AACA,IAAG;AACH;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,6CAA4C,QAAQ;AACpD;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF,iBAAgB;;AAEhB;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA,kBAAiB,aAAa;;AAE9B;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF,0BAAyB;AACzB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA,uBAAsB,QAAQ;;AAE9B,6CAA4C,QAAQ;AACpD;AACA;;AAEA;AACA,GAAE;;AAEF;AACA,wBAAuB,QAAQ;;AAE/B,6CAA4C,QAAQ;AACpD;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,2EAA0E,QAAQ;;AAElF;;AAEA,+BAA8B,QAAQ;;AAEtC;AACA;;AAEA,sBAAqB,QAAQ;;AAE7B;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,gCAA+B,QAAQ;AACvC,wEAAuE,QAAQ;;AAE/E;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,KAAI;AACJ;;AAEA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA,uBAAsB,QAAQ;;AAE9B;AACA;AACA,GAAE;;AAEF;AACA,wBAAuB,QAAQ;;AAE/B;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,KAAI;;AAEJ;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA,IAAG;;AAEH;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA,KAAI;AACJ;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAM;AACN,MAAK;AACL;AACA;AACA;AACA,EAAC;;AAED;;;AAGA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,EAAC;;AAED;;;AAGA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA,gBAAe,QAAQ;;AAEvB;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,EAAC;;AAED;;;AAGA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,sBAAqB,EAAE;AACvB;;AAEA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,mBAAkB,qBAAqB;AACvC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,oBAAmB,qBAAqB;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;;AAEA;AACA,qGAAoG,QAAQ;;AAE5G,mBAAkB,oBAAoB;AACtC;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA,mBAAkB,oBAAoB;AACtC;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,qFAAoF,QAAQ;;AAE5F;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA,gEAA+D,QAAQ;;AAEvE;AACA;;AAEA;AACA;;AAEA,2BAA0B,QAAQ;;AAElC;AACA;AACA,kEAAiE,QAAQ;AACzE;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,EAAC;;AAED;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA,oBAAmB,QAAQ;;AAE3B;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA,8DAA6D,cAAc;;AAE3E;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;;AAEA;AACA;;AAEA,kDAAiD,QAAQ;;AAEzD;AACA;AACA;;AAEA;;AAEA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA,uBAAsB,QAAQ;;AAE9B;AACA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA,gCAA+B;AAC/B;AACA;;AAEA,uCAAsC,SAAS;AAC/C;AACA;AACA,wCAAuC,SAAS;AAChD;AACA;AACA,uCAAsC,SAAS;AAC/C;AACA;AACA,qCAAoC,SAAS;AAC7C;AACA;AACA,GAAE;;AAEF;AACA,iCAAgC;AAChC;AACA;;AAEA,yCAAwC,SAAS;AACjD;AACA;AACA,0CAAyC,SAAS;AAClD;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;;AAEA,mDAAkD,QAAQ;;AAE1D;;AAEA;AACA;AACA;;AAEA,IAAG;AACH;;AAEA,IAAG;AACH;AACA;;AAEA;AACA;AACA,EAAC;;AAED;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,sBAAqB,eAAe;AACpC;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA,0CAAyC;AACzC;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;;AAIA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA,eAAc,QAAQ;;AAEtB;AACA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA,eAAc,QAAQ;;AAEtB;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA,oBAAmB,QAAQ;;AAE3B;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA,IAAG;AACH;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;;AAEA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;;AAEJ;AACA;AACA,IAAG;AACH;AACA;;AAEA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA,cAAa,QAAQ;;AAErB;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;;AAEA,cAAa,eAAe;AAC5B;AACA;;AAEA;AACA;;AAEA,KAAI;AACJ;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;;AAEA,uDAAsD;AACtD;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA,2BAA0B,QAAQ;;AAElC;AACA;;AAEA;AACA;AACA,wCAAuC;AACvC,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,mBAAkB,QAAQ;AAC1B;AACA;AACA,IAAG;AACH;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA,2BAA0B,QAAQ;AAClC;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA,EAAC;;;AAGD;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,8BAA6B,yBAAyB;AACtD,6BAA4B,yBAAyB;AACrD;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,KAAI;AACJ;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,IAAG;AACH;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA,mFAAkF,cAAc;;AAEhG;;AAEA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;AACA;;AAEA;;AAEA,uDAAsD;AACtD;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA,2BAA0B,QAAQ;;AAElC;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;AACA;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;;AAEA,yCAAwC;;AAExC;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;;AAEA,6BAA4B,aAAa;;AAEzC;;AAEA;AACA;AACA,+EAA8E,cAAc;;AAE5F;AACA;AACA;AACA;;AAEA;AACA,sEAAqE,cAAc;;AAEnF;AACA;AACA;;AAEA;;AAEA;AACA,GAAE;;AAEF;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA,8BAA6B,QAAQ;;AAErC;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA,uCAAsC;;AAEtC;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA,kCAAiC,SAAS;AAC1C;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;;AAEA,kCAAiC,SAAS;AAC1C;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,EAAC;;;AAGD;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;;AAEA;;AAEA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,EAAC;;;AAGD,EAAC,oB;;;;;;AC/8RD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC,qBAAqB;AACtB;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;AACD;;AAEA;AACA,8BAA6B;AAC7B,4CAA2C;AAC3C,kCAAiC;AACjC,4BAA2B;;AAE3B;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA,QAAO;AACP;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA,WAAU,iBAAiB;AAC3B,WAAU,iBAAiB;AAC3B;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA;AACA,QAAO;AACP,iFAAgF;AAChF;AACA;AACA;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,YAAW;AACX;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA,QAAO;AACP,MAAK;;AAEL;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA,2CAA0C,OAAO;AACjD;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,YAAW;AACX;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,MAAK;;AAEL;AACA;AACA,wBAAuB,yBAAyB;AAChD;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;;AAEA;AACA,2EAA0E;AAC1E;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA;AACA,YAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb;AACA;AACA;;AAEA,0BAAyB,iBAAiB;AAC1C;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAe;AACf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,mGAAkG;;AAElG;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAe;;AAEf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,6EAA4E;;AAE5E;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAe;;AAEf;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;;AAEA;AACA;AACA,YAAW;AACX;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,cAAa;AACb;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,mDAAkD;AAClD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;;AAET;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,MAAK;AACL;AACA;AACA;AACA,QAAO;AACP;AACA;AACA,MAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,YAAW;AACX;AACA;AACA,cAAa;AACb;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,MAAK;AACL;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,MAAK;AACL;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,QAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,oCAAmC,EAAE;AACrC;AACA,EAAC;;;;;;;ACl9BD;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;AACD;AACA;AACA,EAAC;;AAED;AACA;;AAEA;AACA;AACA,MAAK;;AAEL;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT,MAAK;;AAEL;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA,MAAK;;AAEL;AACA;AACA,MAAK;;AAEL;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA,UAAS;;AAET;AACA,MAAK;;AAEL;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,cAAa;;AAEb;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;;AAEA,4CAA2C,OAAO;AAClD;AACA;AACA;AACA,MAAK;;AAEL;AACA;;AAEA,4CAA2C,OAAO;AAClD;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB,cAAa;AACb;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA,MAAK;;AAEL;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;;AAEA,4CAA2C,OAAO;AAClD;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,UAAS;AACT;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;;AAEA,4CAA2C,OAAO;AAClD;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,cAAa;AACb;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,UAAS;AACT;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;AACA,wCAAuC,GAAG,kBAAkB;;AAE5D;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA,iDAAgD,kBAAkB;AAClE;AACA,MAAK;;AAEL;AACA;AACA,MAAK;;AAEL;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;;AAEA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;AACA,MAAK;;AAEL;AACA;AACA,wBAAuB,0CAA0C;AACjE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA,MAAK;;AAEL;AACA;;AAEA;AACA,MAAK;;AAEL;AACA;AACA;;AAEA;AACA,8BAA6B,oBAAoB;;AAEjD;;AAEA;AACA;AACA;;AAEA,kEAAiE,OAAO;AACxE;AACA;AACA;;AAEA;;AAEA;AACA;AACA,MAAK;;AAEL;AACA;;AAEA,4CAA2C,OAAO;AAClD;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;;AAEA,gCAA+B,OAAO;AACtC;;AAEA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA,MAAK;;AAEL;AACA;AACA;AACA,EAAC;;;;;;;ACzkBD;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA,gBAAe,sBAAsB,EAAE;AACvC;;AAEA;AACA,gBAAe,0BAA0B,EAAE;AAC3C;AACA,gBAAe,oBAAoB,EAAE;AACrC;AACA,sCAAqC,iBAAiB;AACtD,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;;AAGF;AACA;AACA;;AAEA;AACA;AACA,GAAE;;;AAGF;AACA;AACA;AACA;AACA,EAAC;;AAED;AACA;AACA;AACA,aAAY,+BAA+B;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,G","file":"app-9051a9b407771f2e8508.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 9051a9b407771f2e8508","require('./app.js');\n\n\n// WEBPACK FOOTER //\n// ./scripts/index.js","import './trackerCaptureModule';\r\n\r\n// Tracker core\r\nimport 'd2-tracker/lib/dhis2.angular.services.js';\r\nimport 'd2-tracker/lib/dhis2.angular.directives.js';\r\nimport 'd2-tracker/lib/dhis2.angular.validations.js';\r\nimport 'd2-tracker/lib/dhis2.angular.filters.js';\r\nimport 'd2-tracker/lib/dhis2.angular.controllers.js';\r\nimport 'd2-tracker/lib/dhis2.angular.templates.js';\r\n\r\n// App files\r\nimport '../scripts/services.js';\r\nimport '../scripts/filters.js';\r\nimport '../scripts/directives.js';\r\nimport '../scripts/controllers.js';\r\nimport '../scripts/leftbar-menu-controller.js';\r\nimport '../scripts/report-types-controller.js';\r\nimport '../scripts/display-mode-controller.js';\r\nimport '../scripts/sticky.min.js';\r\nimport '../scripts/custom-services.js';\r\nimport '../scripts/queue/queue-controller.js';\r\nimport '../components/dashboard/dashboard-controller.js';\r\nimport '../components/dashboard/dashboard-widgets-controller.js';\r\nimport '../components/registration/registration-controller.js';\r\nimport '../components/enrollment/enrollment-controller.js';\r\nimport '../components/dataentry/dataentry-controller.js';\r\nimport '../components/dataentry/referral-controller.js';\r\nimport '../components/dataentry/modal-default-form-controller.js';\r\nimport '../components/dataentry/new-event-controller.js';\r\nimport '../components/dataentry/event-cocbo-controller.js';\r\nimport '../components/report/tei-report-controller.js';\r\nimport '../components/report/program-summary-controller.js';\r\nimport '../components/report/program-statistics-controller.js';\r\nimport '../components/report/overdue-events-controller.js';\r\nimport '../components/report/upcoming-events-controller.js';\r\nimport '../components/selected/selected-controller.js';\r\nimport '../components/relationship/relationship-controller.js';\r\nimport '../components/teiadd/tei-add-controller.js';\r\nimport '../components/profile/profile-controller.js';\r\nimport '../components/notes/notes-controller.js';\r\nimport '../components/rulebound/rulebound-controller.js';\r\nimport '../components/messaging/messaging-controller.js';\r\n\r\nimport L from 'leaflet';\r\nimport 'leaflet-geocoder-mapzen';\r\nimport 'leaflet-contextmenu';\r\nimport 'd2-tracker/lib/Google.js';\r\n\r\nL.Icon.Default.imagePath = '../dhis-web-commons/leaflet/images';\r\n\r\n/* App Module */\r\nangular.module('trackerCapture')\r\n\r\n.value('DHIS2URL', '../api/26')\r\n\r\n.value('DHIS2COORDINATESIZE', 6)\r\n\r\n.config(function($httpProvider, $routeProvider, $translateProvider, $logProvider) {\r\n\r\n    $httpProvider.defaults.useXDomain = true;\r\n    delete $httpProvider.defaults.headers.common['X-Requested-With'];\r\n\r\n    $routeProvider.when('/', {\r\n        templateUrl:'views/home.html',\r\n        controller: 'SelectionController'\r\n    }).when('/dashboard',{\r\n        templateUrl:'components/dashboard/dashboard.html',\r\n        controller: 'DashboardController'\r\n    }).when('/report-types',{\r\n        templateUrl:'views/report-types.html',\r\n        controller: 'ReportTypesController'\r\n    }).when('/program-summary',{\r\n        templateUrl:'components/report/program-summary.html',\r\n        controller: 'ProgramSummaryController'\r\n    }).when('/program-statistics',{\r\n        templateUrl:'components/report/program-statistics.html',\r\n        controller: 'ProgramStatisticsController',\r\n        css: '../dhis-web-commons/javascripts/nvd3/nv.d3.css'\r\n    }).when('/overdue-events',{\r\n        templateUrl:'components/report/overdue-events.html',\r\n        controller: 'OverdueEventsController'\r\n    }).when('/upcoming-events',{\r\n        templateUrl:'components/report/upcoming-events.html',\r\n        controller: 'UpcomingEventsController'\r\n    }).when('/queue',{\r\n        templateUrl:'views/queue.html',\r\n        controller: 'QueueController'\r\n    }).when('/queue',{\r\n        templateUrl:'views/Apexqueue.html',\r\n        controller: 'ApexQueueController'\r\n    }).otherwise({\r\n        redirectTo : '../dhis-web-commons/security/login.action'\r\n    });\r\n\r\n    $translateProvider.preferredLanguage('en');\r\n    $translateProvider.useSanitizeValueStrategy('escaped');\r\n    $translateProvider.useLoader('i18nLoader');\r\n\r\n    $logProvider.debugEnabled(false);\r\n\r\n})\r\n\r\n.run(function($templateCache, $http, $rootScope){\r\n    $http.get('components/dataentry/inner-form.html').then(function(page){\r\n        $templateCache.put('components/dataentry/inner-form.html', page.data);\r\n    });\r\n    $http.get('components/dataentry/section-inner-form.html').then(function(page){\r\n        $templateCache.put('components/dataentry/section-inner-form.html', page.data);\r\n    });\r\n\r\n    $rootScope.maxGridColumnSize = 1;\r\n    $rootScope.maxOptionSize = 30;\r\n});\r\n\n\n\n// WEBPACK FOOTER //\n// ./scripts/app.js","export default angular.module('trackerCapture', [\n    'ui.bootstrap',\n    'ngRoute',\n    'ngCookies',\n    'ngSanitize',\n    'ngMessages',\n    'trackerCaptureServices',\n    'trackerCaptureFilters',\n    'trackerCaptureDirectives',\n    'd2Directives',\n    'd2Filters',\n    'd2Services',\n    'd2Controllers',\n    'd2Templates',\n    'angularLocalStorage',\n    'ui.select',\n    'ui.select2',\n    'infinite-scroll',\n    'sticky',\n    'nvd3ChartDirectives',\n    'pascalprecht.translate',\n    'leaflet-directive',\n    'angularCSS'\n]);\n\n\n\n// WEBPACK FOOTER //\n// ./scripts/trackerCaptureModule.js","/* Pagination service */\n/* global angular, dhis2, moment */\n\nvar d2Services = angular.module('d2Services', ['ngResource'])\n\n/* Factory for loading translation strings */\n.factory('i18nLoader', function ($q, $http, SessionStorageService, DHIS2URL) {\n\n    var getTranslationStrings = function (locale) {\n        var defaultUrl = 'i18n/i18n_app.properties';\n        var url = '';\n        if (locale === 'en' || !locale) {\n            url = defaultUrl;\n        }\n        else {\n            url = 'i18n/i18n_app_' + locale + '.properties';\n        }\n\n        var tx = {locale: locale};\n\n        var promise = $http.get(url).then(function (response) {\n            tx = {locale: locale, keys: dhis2.util.parseJavaProperties(response.data)};\n            return tx;\n        }, function () {\n\n            var p = $http.get(defaultUrl).then(function (response) {\n                tx = {locale: locale, keys: dhis2.util.parseJavaProperties(response.data)};\n                return tx;\n            });\n            return p;\n        });\n        return promise;\n    };\n\n    var getProfile = function () {\n        var locale = 'en';\n\n        var promise = $http.get( DHIS2URL + '/me.json?fields=id,displayName,userCredentials[username,userRoles[id,programs,authorities]],organisationUnits[id,displayName,level,path,children[id,displayName,level,children[id]]],dataViewOrganisationUnits[id,displayName,level,path,children[id,displayName,level,children[id]]],teiSearchOrganisationUnits[id,displayName,level,path,children[id,displayName,level,children[id]]]').then(function (response) {\n            SessionStorageService.set('USER_PROFILE', response.data);\n            if (response.data && response.data.settings && response.data.settings.keyUiLocale) {\n                locale = response.data.settings.keyUiLocale;\n            }\n            return locale;\n        }, function () {\n            return locale;\n        });\n\n        return promise;\n    };\n    return function () {\n        var deferred = $q.defer(), translations;\n        var userProfile = SessionStorageService.get('USER_PROFILE');\n        if (userProfile && userProfile.settings && userProfile.settings.keyUiLocale) {\n            getTranslationStrings(userProfile.settings.keyUiLocale).then(function (response) {\n                translations = response.keys;\n                deferred.resolve(translations);\n            });\n            return deferred.promise;\n        }\n        else {\n            getProfile().then(function (locale) {\n                getTranslationStrings(locale).then(function (response) {\n                    translations = response.keys;\n                    deferred.resolve(translations);\n                });\n            });\n            return deferred.promise;\n        }\n    };\n})\n\n.service('AuthorityService', function () {\n    var getAuthorities = function (roles) {\n        var authority = {};\n        if (roles && roles.userCredentials && roles.userCredentials.userRoles) {\n            angular.forEach(roles.userCredentials.userRoles, function (role) {\n                angular.forEach(role.authorities, function (auth) {\n                    authority[auth] = true;\n                });\n            });\n        }\n        return authority;\n    };\n\n    return {\n        getUserAuthorities: function (roles) {\n            var auth = getAuthorities(roles);\n            var authority = {};\n            authority.canDeleteEvent = auth['F_TRACKED_ENTITY_DATAVALUE_DELETE'] || auth['ALL'] ? true : false;\n            authority.canAddOrUpdateEvent = auth['F_TRACKED_ENTITY_DATAVALUE_ADD'] || auth['ALL'] ? true : false;\n            authority.canSearchTei = auth['F_TRACKED_ENTITY_INSTANCE_SEARCH'] || auth['ALL'] ? true : false;\n            authority.canDeleteTei = auth['F_TRACKED_ENTITY_INSTANCE_DELETE'] || auth['ALL'] ? true : false;\n            authority.canRegisterTei = auth['F_TRACKED_ENTITY_INSTANCE_ADD'] || auth['ALL'] ? true : false;\n            authority.canEnrollTei = auth['F_PROGRAM_ENROLLMENT'] || auth['ALL'] ? true : false;\n            authority.canUnEnrollTei = auth['F_PROGRAM_UNENROLLMENT'] || auth['ALL'] ? true : false;\n            authority.canAdministerDashboard = auth['F_PROGRAM_DASHBOARD_CONFIG_ADMIN'] || auth['ALL'] ? true : false;\n            return authority;\n        }\n    };\n})\n\n/* Factory for loading external data */\n.factory('ExternalDataFactory', function ($http) {\n\n    return {\n        get: function (fileName) {\n            var promise = $http.get(fileName).then(function (response) {\n                return response.data;\n            });\n            return promise;\n        }\n    };\n})\n\n/* service for wrapping sessionStorage '*/\n.service('SessionStorageService', function ($window) {\n    return {\n        get: function (key) {\n            return JSON.parse($window.sessionStorage.getItem(key));\n        },\n        set: function (key, obj) {\n            $window.sessionStorage.setItem(key, JSON.stringify(obj));\n        },\n        clearAll: function () {\n            for (var key in $window.sessionStorage) {\n                $window.sessionStorage.removeItem(key);\n            }\n        }\n    };\n})\n\n/* service for getting calendar setting */\n.service('CalendarService', function (storage, $rootScope) {\n\n    return {\n        getSetting: function () {\n\n            var dhis2CalendarFormat = {keyDateFormat: 'yyyy-MM-dd', keyCalendar: 'gregorian', momentFormat: 'YYYY-MM-DD'};\n            var storedFormat = storage.get('SYSTEM_SETTING');\n            \n            if (angular.isObject(storedFormat) && storedFormat.keyDateFormat && storedFormat.keyCalendar) {\n                if (storedFormat.keyCalendar === 'iso8601') {\n                    storedFormat.keyCalendar = 'gregorian';\n                }\n\n                if (storedFormat.keyDateFormat === 'dd-MM-yyyy') {\n                    dhis2CalendarFormat.momentFormat = 'DD-MM-YYYY';\n                }\n\n                dhis2CalendarFormat.keyCalendar = storedFormat.keyCalendar;\n                dhis2CalendarFormat.keyDateFormat = storedFormat.keyDateFormat;\n            }\n            $rootScope.dhis2CalendarFormat = dhis2CalendarFormat;\n            return dhis2CalendarFormat;\n        }\n    };\n})\n\n/* service for dealing with dates */\n.service('DateUtils', function ($filter, CalendarService, NotificationService, $translate) {\n\n    return {        \n        getDate: function (dateValue) {\n            if (!dateValue) {\n                return;\n            }\n            var calendarSetting = CalendarService.getSetting();\n            dateValue = moment(dateValue, calendarSetting.momentFormat)._d;\n            return Date.parse(dateValue);\n        },\n        format: function (dateValue) {\n            if (!dateValue) {\n                return;\n            }\n\n            var calendarSetting = CalendarService.getSetting();\n            dateValue = moment(dateValue, calendarSetting.momentFormat)._d;\n            dateValue = $filter('date')(dateValue, calendarSetting.keyDateFormat);\n            return dateValue;\n        },\n        formatToHrsMins: function (dateValue) {\n            var calendarSetting = CalendarService.getSetting();\n            var dateFormat = 'YYYY-MM-DD @ hh:mm A';\n            if (calendarSetting.keyDateFormat === 'dd-MM-yyyy') {\n                dateFormat = 'DD-MM-YYYY @ hh:mm A';\n            }\n            return moment(dateValue).format(dateFormat);\n        },\n        formatToHrsMinsSecs: function (dateValue) {\n            var calendarSetting = CalendarService.getSetting();\n            var dateFormat = 'YYYY-MM-DD @ hh:mm:ss A';\n            if (calendarSetting.keyDateFormat === 'dd-MM-yyyy') {\n                dateFormat = 'DD-MM-YYYY @ hh:mm:ss A';\n            }\n            return moment(dateValue).format(dateFormat);\n        },\n        getToday: function () {\n            var calendarSetting = CalendarService.getSetting();\n            var tdy = $.calendars.instance(calendarSetting.keyCalendar).newDate();\n            var today = moment(tdy._year + '-' + tdy._month + '-' + tdy._day, 'YYYY-MM-DD')._d;\n            today = Date.parse(today);\n            today = $filter('date')(today, calendarSetting.keyDateFormat);\n            return today;\n        },\n        isValid: function( dateValue ){\n            if( !dateValue ){\n                return false;\n            }\n            var convertedDate = this.format(angular.copy(dateValue));\n            return dateValue === convertedDate;\n        },\n        isBeforeToday: function (dateValue) {\n            if (!dateValue) {\n                return;\n            }\n            dateValue = moment(dateValue, \"YYYY-MM-DD\");\n            if (dateValue.isBefore(moment())) {\n                return true;\n            }\n            return false;\n        },\n        isAfterToday: function (dateValue) {\n            if (!dateValue) {\n                return;\n            }\n            dateValue = moment(dateValue, \"YYYY-MM-DD\");\n            if (dateValue.isAfter(moment())) {\n                return true;\n            }\n            return false;\n        },\n        formatFromUserToApi: function (dateValue) {\n            if (!dateValue) {\n                return;\n            }\n            var calendarSetting = CalendarService.getSetting();\n            dateValue = moment(dateValue, calendarSetting.momentFormat)._d;\n            dateValue = Date.parse(dateValue);\n            dateValue = $filter('date')(dateValue, 'yyyy-MM-dd');\n            return dateValue;\n        },\n        formatFromApiToUser: function (dateValue) {\n            if (!dateValue) {\n                return;\n            }\n            var calendarSetting = CalendarService.getSetting();\n            if (moment(dateValue, calendarSetting.momentFormat).format(calendarSetting.momentFormat) === dateValue) {\n                return dateValue;\n            }\n            dateValue = moment(dateValue, 'YYYY-MM-DD')._d;\n            return $filter('date')(dateValue, calendarSetting.keyDateFormat);\n        },\n        getDateAfterOffsetDays: function (offSetDays) {\n            var date = new Date();\n            date.setDate(date.getDate()+offSetDays);\n            var calendarSetting = CalendarService.getSetting();\n            var tdy = $.calendars.instance(calendarSetting.keyCalendar).fromJSDate(date);\n            var dateAfterOffset = moment(tdy._year + '-' + tdy._month + '-' + tdy._day, 'YYYY-MM-DD')._d;\n            dateAfterOffset = Date.parse(dateAfterOffset);\n            dateAfterOffset = $filter('date')(dateAfterOffset, calendarSetting.keyDateFormat);\n            return dateAfterOffset;\n        },\n        verifyExpiryDate: function(date, expiryPeriodType, expiryDays){\n            var eventPeriodEndDate, eventDate, eventPeriod;\n            var isValid = true;\n            var calendarSetting, dateFormat, generator, today;\n            if(!date || !expiryPeriodType || !expiryDays) {\n                return isValid;\n            }\n            calendarSetting = CalendarService.getSetting();\n            dateFormat = calendarSetting.momentFormat;\n            generator = new dhis2.period.PeriodGenerator($.calendars.instance(calendarSetting.keyCalendar), dateFormat);\n            today = moment(this.getToday(), dateFormat);\n            eventDate = moment(date, dateFormat);\n            eventPeriod = generator.getPeriodForTheDate(eventDate.format(\"YYYY-MM-DD\"), expiryPeriodType, true);\n            if (eventPeriod && eventPeriod.endDate) {\n                eventPeriodEndDate = moment(eventPeriod.endDate, \"YYYY-MM-DD\").add(expiryDays, \"day\");\n                if (today.isAfter(eventPeriodEndDate)) {\n                    NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"event_date_out_of_range\"));\n                    isValid = false;\n                }\n            }\n            return isValid;\n        },\n        verifyOrgUnitPeriodDate: function(date, periodStartDate, periodEndDate) {\n            var isValid = true;\n            var dateFormat, startDate, endDate, eventDate, calendarSetting;\n            if(!date) {\n                hideHeaderMessage();\n                return isValid;\n            }\n            if (!periodStartDate && !periodEndDate) {\n                hideHeaderMessage();\n                return isValid;\n            } else {\n                calendarSetting = CalendarService.getSetting();\n                dateFormat = calendarSetting.momentFormat;\n                eventDate = moment(date, dateFormat);\n                if (!periodStartDate) {\n                    endDate = moment(periodEndDate, \"YYYY-MM-DD\");\n                    if (eventDate.isAfter(endDate)) {\n                        isValid = false;\n                    }\n                } else if (!periodEndDate) {\n                    startDate = moment(periodStartDate, \"YYYY-MM-DD\");\n                    if (eventDate.isBefore(startDate)) {\n                        isValid = false;\n                    }\n                } else {\n                    startDate = moment(periodStartDate, \"YYYY-MM-DD\");\n                    endDate = moment(periodEndDate, \"YYYY-MM-DD\");\n                    if (eventDate.isBefore(startDate) || eventDate.isAfter(endDate)) {\n                        isValid = false;\n                    }\n                }\n            }\n            if(!isValid) {\n                setHeaderDelayMessage($translate.instant(\"date_out_of_ou_period\"));\n            } else {\n                hideHeaderMessage();\n            }\n            return isValid;\n        },\n        getAge: function( _dob ){\n            var calendarSetting = CalendarService.getSetting();\n            var now = moment();\n            var dob = moment( _dob, calendarSetting.momentFormat);\n            var age = {};\n\n            age.years = now.diff(dob, 'years');\n            dob.add(age.years, 'years');\n\n            age.months = now.diff(dob, 'months');\n            dob.add(age.months, 'months');\n\n            age.days = now.diff(dob, 'days');\n            \n            return age;\n        },\n        getDateFromUTCString: function(utcDateTimeString) {\n            var calendarSetting = CalendarService.getSetting();\n            return moment(utcDateTimeString).format(calendarSetting.momentFormat);\n        }\n    };\n})\n\n/* Service for option name<->code conversion */\n.factory('OptionSetService', function() {\n    return {\n        getCode: function(options, key){\n            if(options){\n                for(var i=0; i<options.length; i++){\n                    if( key === options[i].displayName){\n                        return options[i].code;\n                    }\n                }\n            }\n            return key;\n        },\n        getName: function(options, key){\n            if(options){\n                for(var i=0; i<options.length; i++){\n                    if( key === options[i].code){\n                        return options[i].displayName;\n                    }\n                }\n            }\n            return key;\n        }\n    };\n})\n\n/* service for common utils */\n.service('CommonUtils', function($translate, DateUtils, OptionSetService, CurrentSelection, FileService, OrgUnitFactory, NotificationService, SessionStorageService, storage){\n    \n    var setFileName = function(event, valueId, dataElementId){\n        var fileNames = CurrentSelection.getFileNames() || {};\n        FileService.get(valueId).then(function(response){\n            if(response && response.displayName){\n                if(!fileNames[event.event]){\n                    fileNames[event.event] = {};\n                }\n                fileNames[event.event][dataElementId] = response.displayName;\n                CurrentSelection.setFileNames( fileNames );\n            }\n        });\n    };\n    \n    var setOrgUnitName = function( id ){\n        var orgUnitNames = CurrentSelection.getOrgUnitNames() || {};\n        if( !orgUnitNames[id] ){                \n            OrgUnitFactory.getFromStoreOrServer( id ).then(function (response) {\n                if(response && response.displayName) {                                                        \n                    orgUnitNames[id] = response.displayName;\n                    CurrentSelection.setOrgUnitNames( orgUnitNames );\n                }\n            });\n        }\n    };\n    \n    return {\n        formatDataValue: function(event, val, obj, optionSets, destination){\n            if(val &&\n                obj.valueType === 'NUMBER' ||\n                obj.valueType === 'PERCENTAGE' ||\n                obj.valueType === 'INTEGER' ||\n                obj.valueType === 'INTEGER_POSITIVE' ||\n                obj.valueType === 'INTEGER_NEGATIVE' ||\n                obj.valueType === 'INTEGER_ZERO_OR_POSITIVE'){\n                if( dhis2.validation.isNumber(val)){\n                    if(obj.valueType === 'NUMBER'){\n                        val = parseFloat(val);\n                    }else{\n                        val = parseInt(val);\n                    }\n                }\n            }\n            if(val && obj.optionSetValue && obj.optionSet && obj.optionSet.id && optionSets[obj.optionSet.id] && optionSets[obj.optionSet.id].options  ){\n                if(destination === 'USER'){\n                    val = OptionSetService.getName(optionSets[obj.optionSet.id].options, String(val));\n                }\n                else{\n                    val = OptionSetService.getCode(optionSets[obj.optionSet.id].options, val);\n                }\n\n            }\n            if(val && obj.valueType === 'DATE'){\n                if(destination === 'USER'){\n                    val = DateUtils.formatFromApiToUser(val);\n                }\n                else{\n                    val = DateUtils.formatFromUserToApi(val);\n                }\n            }\n            if(obj.valueType === 'TRUE_ONLY'){\n                if(destination === 'USER'){\n                    val = val === 'true' ? true : '';\n                }\n                else{\n                    val = val === true ? 'true' : '';\n                }\n            }\n            if( val && obj.valueType === 'ORGANISATION_UNIT' ){\n                if( destination === 'USER' ){                    \n                    setOrgUnitName( val );\n                }\n            }\n            if(event && val && destination === 'USER' && obj.valueType === 'FILE_RESOURCE'){                \n                setFileName(event, val, obj.id);\n            }\n            return val;\n        },\n        displayBooleanAsYesNo: function(value, dataElement){\n            if(angular.isUndefined(dataElement) || dataElement.valueType === \"BOOLEAN\"){\n                if(value === \"true\" || value === true){\n                    return \"Yes\";\n                }\n                else if(value === \"false\" || value === false){\n                    return \"No\";\n                }\n            }\n            return value;\n        },\n        userHasValidRole: function(obj, prop, userRoles){\n        \tif( !obj || !prop || !userRoles){\n                return false;\n        \t}\n        \tfor(var i=0; i < userRoles.length; i++){            \n                if( userRoles[i].authorities && userRoles[i].authorities.indexOf('ALL') !== -1 ){\n                    return true;\n                }\n                if( userRoles[i][prop] && userRoles[i][prop].length > 0 ){\n                    for( var j=0; j< userRoles[i][prop].length; j++){\n                        if( obj.id === userRoles[i][prop][j].id ){\n                            return true;\n                        }\n                    }\n                }\n            }\n            return false;            \t\n        },        \n        checkAndSetOrgUnitName: function( id ){\n            setOrgUnitName( id );\n        },\n        checkAndSetFileName: function(event, valueId, dataElementId ){\n            setFileName(event, valueId, dataElementId);\n        },\n        getUsername: function(){            \n            var userProfile = SessionStorageService.get('USER_PROFILE');\n            var username = userProfile && userProfile.userCredentials && userProfile.userCredentials.username ? userProfile.userCredentials.username : '';\n            return username;\n        },\n        getSystemSetting: function(){\n            var settings = storage.get('SYSTEM_SETTING');            \n            return settings;\n        }\n    };\n})\n\n/* service for dealing with custom form */\n.service('CustomFormService', function ($translate, NotificationService) {\n\n    return {\n        getForProgramStage: function (programStage, programStageDataElements) {\n\n            var htmlCode = programStage.dataEntryForm ? programStage.dataEntryForm.htmlCode : null;\n\n            if (htmlCode) {\n                var inputRegex = /<input.*?\\/>/g,\n                    match,\n                    inputFields = [],\n                    hasEventDate = false;\n\n                while (match = inputRegex.exec(htmlCode)) {\n                    inputFields.push(match[0]);\n                }\n\n                for (var i = 0; i < inputFields.length; i++) {\n                    var inputField = inputFields[i];\n                    \n                    var inputElement = $.parseHTML(inputField);\n                    var attributes = {};\n\n                    $(inputElement[0].attributes).each(function () {\n                        attributes[this.nodeName] = this.value;\n                    });\n\n                    var fieldId = '', newInputField;\n                    if (attributes.hasOwnProperty('id')) {\n\n                        if (attributes['id'] === 'executionDate') {\n                            fieldId = 'eventDate';\n                            hasEventDate = true;\n\n                            //name needs to be unique so that it can be used for validation in angularjs\n                            if (attributes.hasOwnProperty('name')) {\n                                attributes['name'] = fieldId;\n                            }\n\n                            newInputField = '<span class=\"hideInPrint\"><input type=\"text\" ' +\n                                this.getAttributesAsString(attributes) +\n                                ' ng-model=\"currentEvent.' + fieldId + '\"' +\n                                ' ng-disabled=\"model.editingDisabled\"' +\n                                ' input-field-id=\"' + fieldId + '\"' +\n                                ' d2-date ' +\n                                ' d2-date-validator ' +\n                                ' max-date=\"' + 0 + '\"' +\n                                ' placeholder=\"{{dhis2CalendarFormat.keyDateFormat}}\" ' +\n                                ' ng-change=\"verifyExpiryDate()\"'+\n                                ' ng-class=\"getInputNotifcationClass(prStDes.' + fieldId + '.dataElement.id,true)\"' +\n                                ' blur-or-change=\"saveDatavalue(prStDes.' + fieldId + ')\"' +\n                                ' ng-required=\"{{true}}\"></span><span class=\"not-for-screen\"><input type=\"text\" value={{currentEvent.' + fieldId + '}}></span>';\n                        }\n                        else {\n                            fieldId = attributes['id'].substring(4, attributes['id'].length - 1).split(\"-\")[1];\n\n                            //name needs to be unique so that it can be used for validation in angularjs\n                            if (attributes.hasOwnProperty('name')) {\n                                attributes['name'] = fieldId;\n                            }\n\n                            var prStDe = programStageDataElements[fieldId];\n\n                            if (prStDe && prStDe.dataElement && prStDe.dataElement.valueType) {\n\n                                var commonInputFieldProperty = this.getAttributesAsString(attributes) +\n                                    ' ng-model=\"currentEvent.' + fieldId + '\" ' +\n                                    ' input-field-id=\"' + fieldId + '\"' +\n                                    ' ng-disabled=\"model.editingDisabled || isHidden(prStDes.' + fieldId + '.dataElement.id) || selectedEnrollment.status===\\'CANCELLED\\' || selectedEnrollment.status===\\'COMPLETED\\' || currentEvent[uid]==\\'uid\\' || currentEvent.editingNotAllowed \"'+\n                                    ' ng-required=\"{{prStDes.' + fieldId + '.compulsory}}\" ';\n\n                                \n                                //check if dataelement has optionset\n                                if (prStDe.dataElement.optionSetValue) {\n                                    var optionSetId = prStDe.dataElement.optionSet.id;\n                                    newInputField = '<span class=\"hideInPrint\"><ui-select theme=\"select2\" ' + commonInputFieldProperty + ' ng-disabled=\"model.editingDisabled\" on-select=\"saveDatavalue(prStDes.' + fieldId + ', outerForm.' + fieldId + ')\" >' +\n                                        '<ui-select-match ng-class=\"getInputNotifcationClass(prStDes.' + fieldId + '.dataElement.id, true)\" allow-clear=\"true\" placeholder=\"' + $translate.instant('select_or_search') + '\">{{$select.selected.displayName || $select.selected}}</ui-select-match>' +\n                                        '<ui-select-choices ' +\n                                        ' repeat=\"option.displayName as option in optionSets.' + optionSetId + '.options | filter: $select.search | limitTo:maxOptionSize\">' +\n                                        '<span ng-bind-html=\"option.displayName | highlight: $select.search\">' +\n                                        '</span>' +\n                                        '</ui-select-choices>' +\n                                        '</ui-select></span><span class=\"not-for-screen\"><input type=\"text\" value={{currentEvent.' + fieldId + '}}></span>';\n                                }\n                                else {\n                                    //check data element type and generate corresponding angular input field\n                                    if (prStDe.dataElement.valueType === \"NUMBER\" ||\n                                        prStDe.dataElement.valueType === \"PERCENTAGE\" ||\n                                        prStDe.dataElement.valueType === \"INTEGER\" ||\n                                        prStDe.dataElement.valueType === \"INTEGER_POSITIVE\" ||\n                                        prStDe.dataElement.valueType === \"INTEGER_NEGATIVE\" ||\n                                        prStDe.dataElement.valueType === \"INTEGER_ZERO_OR_POSITIVE\") {\n                                        newInputField = '<span class=\"hideInPrint\"><input type=\"number\" ' +\n                                            ' d2-number-validator ' +\n                                            ' ng-class=\"{{getInputNotifcationClass(prStDes.' + fieldId + '.dataElement.id, true)}}\" ' +\n                                            ' number-type=\"' + prStDe.dataElement.valueType + '\" ' +\n                                            ' ng-blur=\"saveDatavalue(prStDes.' + fieldId + ', outerForm.' + fieldId + ')\"' +\n                                            commonInputFieldProperty + 'ng-disabled=\"model.editingDisabled\"></span><span class=\"not-for-screen\"><input type=\"text\" value={{currentEvent.' + fieldId + '}}></span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"BOOLEAN\") {\n                                    \tnewInputField = '<span class=\"hideInPrint\"><d2-radio-button ' +\n                                                                    ' dh-required=\"prStDes.' + fieldId + '.compulsory\" ' +\n                                                                    ' dh-disabled=\"model.editingDisabled || isHidden(prStDes.' + fieldId + '.dataElement.id) || selectedEnrollment.status===\\'CANCELLED\\' || selectedEnrollment.status===\\'COMPLETED\\' || currentEvent[uid]==\\'uid\\' || currentEvent.editingNotAllowed\" ' +\n                                                                    ' dh-value=\"currentEvent.' + fieldId + '\" ' +\n                                                                    ' dh-name=\"foo\" ' +\n                                                                    ' dh-current-element=\"currentElement\" ' +\n                                                                    ' dh-event=\"currentEvent.event\" ' +\n                                                                    ' dh-id=\"prStDes.' + fieldId + '.dataElement.id\" ' +\n                                                                    ' dh-click=\"saveDatavalue(prStDes.' + fieldId + ', currentEvent, value )\">' +\n                                                            ' </d2-radio-button></span> ' +\n                                                            '<span class=\"not-for-screen\">' +\n                                                            \t'<label class=\"radio-inline\"><input type=\"radio\" value=\"true\" ng-model=\"currentEvent.' + fieldId +'\">{{\\'yes\\' | translate}}</label>' +\n                                                            \t'<label class=\"radio-inline\"><input type=\"radio\" value=\"false\" ng-model=\"currentEvent.' + fieldId + '\">{{\\'no\\' | translate}}</label>' +\n                                                            '</span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"DATE\") {\n                                        var maxDate = prStDe.allowFutureDate ? '' : 0;\n                                        newInputField = '<span class=\"hideInPrint\"><input type=\"text\" ' +\n                                            ' placeholder=\"{{dhis2CalendarFormat.keyDateFormat}}\" ' +\n                                            ' ng-class=\"{{getInputNotifcationClass(prStDes.' + fieldId + '.dataElement.id, true)}}\" ' +\n                                            ' ng-disabled=\"model.editingDisabled\"'+\n                                            ' d2-date ' +\n                                            ' d2-date-validator ' +\n                                            ' max-date=\"' + maxDate + '\"' +\n                                            ' ng-change=\"verifyExpiryDate()\"'+\n                                            ' blur-or-change=\"saveDatavalue(prStDes.' + fieldId + ', outerForm.' + fieldId + ')\"' +\n                                            commonInputFieldProperty + ' ></span><span class=\"not-for-screen\"><input type=\"text\" value={{currentEvent.' + fieldId + '}}></span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"TRUE_ONLY\") {\n                                        newInputField = '<span class=\"hideInPrint\"><input type=\"checkbox\" ng-disabled=\"model.editingDisabled\"' +\n                                            ' ng-class=\"{{getInputNotifcationClass(prStDes.' + fieldId + '.dataElement.id, true)}}\" ' +\n                                            ' ng-change=\"saveDatavalue(prStDes.' + fieldId + ', outerForm.' + fieldId + ')\"' +\n                                            commonInputFieldProperty + ' ></span><span class=\"not-for-screen\"><input type=\"checkbox\" ng-checked={{currentEvent.' + fieldId + '}}></span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"LONG_TEXT\") {\n                                        newInputField = '<span class=\"hideInPrint\"><textarea ng-disabled=\"model.editingDisabled\" row=\"3\" ' +\n                                            ' ng-class=\"{{getInputNotifcationClass(prStDes.' + fieldId + '.dataElement.id, true)}}\" ' +\n                                            ' ng-blur=\"saveDatavalue(prStDes.' + fieldId + ', outerForm.' + fieldId + ')\"' +\n                                            commonInputFieldProperty + '></textarea></span><span class=\"not-for-screen\"><textarea row=\"3\" value={{currentEvent.' + fieldId + '}}></textarea></span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"FILE_RESOURCE\") {\n                                        newInputField = '<span ng-disabled=\"model.editingDisabled\" class=\"input-group hideInPrint\">\\n\\\n                                                        <span ng-if=\"currentEvent.' + fieldId + '\">\\n\\\n                                                            <a href ng-click=\"downloadFile(null, \\'' + fieldId + '\\', null)\" title=\"fileNames[currentEvent.event][' + fieldId + ']\" >{{fileNames[currentEvent.event][' + fieldId + '].length > 20 ? fileNames[currentEvent.event][' + fieldId + '].substring(0,20).concat(\\'...\\') : fileNames[currentEvent.event][' + fieldId + ']}}</a>\\n\\\n                                                        </span>\\n\\\n                                                        <span class=\"input-group-btn\">\\n\\\n                                                            <span class=\"btn btn-grp btn-file\">\\n\\\n                                                                <span ng-if=\"currentEvent.' + fieldId + '\" title=\"{{\\'delete\\' | translate}}\" d2-file-input-name=\"fileNames[currentEvent.event][' + fieldId + ']\" d2-file-input-delete=\"currentEvent.' + fieldId + '\">\\n\\\n                                                                    <a href ng-click=\"deleteFile(\\'' + fieldId + '\\')\"><i class=\"fa fa-trash alert-danger\"></i></a>\\n\\\n                                                                </span>\\n\\\n                                                                <span ng-if=\"!currentEvent.' + fieldId + '\" title=\"{{\\'upload\\' | translate}}\" >\\n\\\n                                                                    <i class=\"fa fa-upload\"></i>\\n\\\n                                                                    <input  type=\"file\" \\n\\\n                                                                            ' + this.getAttributesAsString(attributes) + '\\n\\\n                                                                            input-field-id=\"' + fieldId + '\"\\n\\\n                                                                            d2-file-input-ps=\"currentStage\"\\n\\\n                                                                            d2-file-input=\"currentEvent\"\\n\\\n                                                                            d2-file-input-current-name=\"currentFileNames\"\\n\\\n                                                                            d2-file-input-name=\"fileNames\">\\n\\\n                                                                </span>\\n\\\n                                                            </span>\\n\\\n                                                        </span>\\n\\\n                                                    </span>' \n                                                    '<span class=\"not-for-screen\">' +\n                                                    \t'<input type=\"text\" value={{currentEvent.' + fieldId + '}}' +\n                                                    '</span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"AGE\") {\n                                    \tnewInputField = '<span class=\"hideInPrint\"><d2-age ' +\n                                    \t\t\t\t\t\t\t' id=\" ' + fieldId + '\" ' +\n\t\t\t\t\t\t                                        ' d2-object=\"currentEvent\" ' + \n\t\t\t\t\t\t                                        ' d2-disabled=\"model.editingDisabled || isHidden(prStDes.' + fieldId + '.dataElement.id) || selectedEnrollment.status===\\'CANCELLED\\' || selectedEnrollment.status===\\'COMPLETED\\' || currentEvent[uid]==\\'uid\\' || currentEvent.editingNotAllowed\" ' +\n                                                                                        ' d2-required=\"prStDes.' + fieldId + '.compulsory\" ' +\n\t\t\t\t\t\t                                        ' d2-function=\"saveDatavalue(arg1)\" ' +\t\t\t\t\t\t                                        \n\t\t\t\t\t\t                                        ' d2-function-param-text=\"prStDes.' + fieldId + '\" >' +\n\t\t\t\t\t\t                                '</d2-age></span>' +\n                                                        '<span class=\"not-for-screen\">' +\n                                                    \t\t'<input type=\"text\" value={{currentEvent.' + fieldId + '}}' +\n                                                    \t'</span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"COORDINATE\") {\n                                    \tnewInputField = '<span class=\"hideInPrint\"><d2-map ' +\n                                    \t\t\t\t\t\t\t' id=\" ' + fieldId + '\" ' +\n\t\t\t\t\t\t                                        ' d2-object=\"currentEvent\" ' + \n\t\t\t\t\t\t                                        ' d2-coordinate-format=\"\\'TEXT\\'\" ' + \n\t\t\t\t\t\t                                        ' d2-disabled=\"model.editingDisabled || isHidden(prStDes.' + fieldId + '.dataElement.id) || selectedEnrollment.status===\\'CANCELLED\\' || selectedEnrollment.status===\\'COMPLETED\\' || currentEvent[uid]==\\'uid\\' || currentEvent.editingNotAllowed\" ' +\n                                                                                        ' d2-required=\"prStDes.' + fieldId + '.compulsory\" ' +\n\t\t\t\t\t\t                                        ' d2-function=\"saveDatavalue(arg1)\" ' +\t\t\t\t\t\t                                        \n\t\t\t\t\t\t                                        ' d2-function-param-text=\"prStDes.' + fieldId + '\" ' +\n\t\t\t\t\t\t                                        ' d2-function-param-coordinate=\"\\'LATLNG\\'\" > ' +\n\t\t\t\t\t\t                                '</d2-map></span>' +\n\t\t\t\t\t\t                                '<span class=\"not-for-screen\">' +\n                                                    \t\t'<input type=\"text\" value={{currentEvent.' + fieldId + '}}' +\n                                                    \t'</span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"ORGANISATION_UNIT\") {\n                                    \tnewInputField = '<span class=\"hideInPrint\"><d2-org-unit-tree ' +\n\t\t\t\t\t                                            ' selected-org-unit-id=\"{{selectedOrgUnit.id}}\" ' +\n\t\t\t\t\t                                            ' id=\"{{prStDes.' + fieldId + '.dataElement.id}}\" ' +\n\t\t\t\t\t                                            ' d2-object=\"currentEvent\" ' +\n\t\t\t\t\t                                            ' d2-value=\"currentEvent.' + fieldId + '\" ' +\n\t\t\t\t\t                                            ' d2-disabled=\"model.editingDisabled || isHidden(prStDes.' + fieldId + '.dataElement.id) || selectedEnrollment.status===\\'CANCELLED\\' || selectedEnrollment.status===\\'COMPLETED\\' || currentEvent[uid]==\\'uid\\' || currentEvent.editingNotAllowed\" ' +\n\t\t\t\t\t                                            ' d2-required=\"prStDes.' + fieldId + '.compulsory\" ' +\n                                                                                    ' d2-orgunit-names=\"orgUnitNames\" ' +\n\t\t\t\t\t                                            ' d2-function=\"saveDatavalue(prStDes.' + fieldId + ', currentEvent, value )\" >' +\n\t\t\t\t\t                                    ' </d2-org-unit-tree></span>' +\n\t\t\t\t\t                                    '<span class=\"not-for-screen\">' +\n                                                    \t\t'<input type=\"text\" value={{currentEvent.' + fieldId + '}}' +\n                                                    \t'</span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"PHONE_NUMBER\") {\n                                        newInputField = '<span class=\"hideInPrint\"><input ng-disabled=\"model.editingDisabled\" type=\"text\" ' +\n                                            ' ng-class=\"{{getInputNotifcationClass(prStDes.' + fieldId + '.dataElement.id, true)}}\" ' +\n                                            ' ng-blur=\"saveDatavalue(prStDes.' + fieldId + ', outerForm.' + fieldId + ')\"' +\n                                            commonInputFieldProperty + '></span><span class=\"not-for-screen\"><input type=\"text\" value={{currentEvent.' + fieldId + '}}></span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"EMAIL\") {\n                                        newInputField = '<span class=\"hideInPrint\"><input style=\"width:100%;\" type=\"email\" ng-disabled=\"model.editingDisabled\"' +\n                                            ' ng-blur=\"saveDatavalue(prStDes.' + fieldId + ', outerForm.' + fieldId + ')\" ' +\n                                            commonInputFieldProperty +\n                                            ' ng-model=\"currentEvent.' + fieldId + '\">' +\n                                            '<span class=\"not-for-screen\"><input type=\"email\" value={{currentEvent.' + fieldId + '}}></span>';\n                                    }\n                                    else if (prStDe.dataElement.valueType === \"TEXT\") {\n                                        newInputField = '<span class=\"hideInPrint\"><input ng-disabled=\"model.editingDisabled\" type=\"text\" ' +\n                                            ' ng-class=\"{{getInputNotifcationClass(prStDes.' + fieldId + '.dataElement.id, true)}}\" ' +\n                                            ' ng-blur=\"saveDatavalue(prStDes.' + fieldId + ', outerForm.' + fieldId + ')\"' +\n                                            commonInputFieldProperty + '></span><span class=\"not-for-screen\"><input type=\"text\" value={{currentEvent.' + fieldId + '}}></span>';\n                                    }\n                                    else{\n                                    \tnewInputField = ' {{\"unsupported_value_type\" | translate }}: ' + prStDe.dataElement.valueType;\n                                    }\n                                }\n                            }\n                            else{\n                                NotificationService.showNotifcationDialog($translate.instant(\"error\"),\n                                    $translate.instant(\"custom_form_has_invalid_dataelement\"));\n\n                                return;\n                            }\n                            \n                            \n                        }\n                        newInputField = newInputField + ' <span ng-messages=\"outerForm.' + fieldId + '.$error\" class=\"required\" ng-if=\"interacted(outerForm.' + fieldId + ')\" ng-messages-include=\"./templates/error-messages.html\"></span>';\n\n                        htmlCode = htmlCode.replace(inputField, newInputField);\n\n                    }\n                }\n                htmlCode = addPopOver(htmlCode, programStageDataElements);\n                return {htmlCode: htmlCode, hasEventDate: hasEventDate};\n            }\n            return null;\n        },\n        getForTrackedEntity: function (trackedEntityForm, target) {\n            if (!trackedEntityForm) {\n                return null;\n            }\n\n            var htmlCode = trackedEntityForm.htmlCode ? trackedEntityForm.htmlCode : null;\n            if (htmlCode) {\n\n                var trackedEntityFormAttributes = [];\n                angular.forEach(trackedEntityForm.attributes, function (att) {\n                    trackedEntityFormAttributes[att.id] = att;\n                });\n\n\n                var inputRegex = /<input.*?\\/>/g, match, inputFields = [];\n                var hasProgramDate = false;\n                while (match = inputRegex.exec(htmlCode)) {\n                    inputFields.push(match[0]);\n                }\n\n                for (var i = 0; i < inputFields.length; i++) {\n                    var inputField = inputFields[i];\n                    var inputElement = $.parseHTML(inputField);\n                    var attributes = {};\n\n                    $(inputElement[0].attributes).each(function () {\n                        attributes[this.nodeName] = this.value;\n                    });\n\n                    var attId = '', fieldName = '', newInputField, programId;\n                    if (attributes.hasOwnProperty('attributeid')) {\n                        attId = attributes['attributeid'];\n                        fieldName = attId;\n                        var att = trackedEntityFormAttributes[attId];\n\n                        if (att) {\n                            var attMaxDate = att.allowFutureDate ? '' : 0;\n                            var isTrackerAssociate = att.valueType === 'TRACKER_ASSOCIATE';\n                            var commonInputFieldProperty = ' name=\"' + fieldName + '\"' +\n                                ' element-id=\"' + i + '\"' +\n                                this.getAttributesAsString(attributes) +\n                                ' d2-focus-next-on-enter' +\n                                ' ng-model=\"selectedTei.' + attId + '\" ' +\n                                ' attribute-data=\"attributesById.' + attId + '\" ' +\n                                ' selected-program-id=\"selectedProgram.id\" ' +\n                                ' selected-tei-id=\"selectedTei.trackedEntityInstance\" ' +\n                                ' ng-disabled=\"selectedOrgUnit.closedStatus || editingDisabled || isHidden(attributesById.' + attId + '.id) || ' + isTrackerAssociate+ '|| attributesById.' + attId + '.generated\"' +\n                                ' d2-attribute-validator ' +\n                                ' ng-required=\" ' + att.mandatory + '\" ';\n\n                            //check if attribute has optionset\n                            if (att.optionSetValue) {\n                                var optionSetId = att.optionSet.id;\n                                newInputField = '<span class=\"hideInPrint\"><ui-select style=\"width:100%;\" ng-disabled=\"selectedOrgUnit.closedStatus\" theme=\"select2\" ' + commonInputFieldProperty + '  on-select=\"teiValueUpdated(selectedTei,\\'' + attId + '\\')\" >' +\n                                    '<ui-select-match allow-clear=\"true\" placeholder=\"' + $translate.instant('select_or_search') + '\">{{$select.selected.displayName || $select.selected}}</ui-select-match>' +\n                                    '<ui-select-choices ' +\n                                    'repeat=\"option.displayName as option in optionSets.' + optionSetId + '.options | filter: $select.search | limitTo:maxOptionSize\">' +\n                                    '<span ng-bind-html=\"option.displayName | highlight: $select.search\"></span>' +\n                                    '</ui-select-choices>' +\n                                    '</ui-select></span><span class=\"not-for-screen\"><input type=\"text\" value={{selectedTei.' + attId + '}}></span>';\n                            }\n                            else {\n                                //check attribute type and generate corresponding angular input field\n                                if (att.valueType === \"NUMBER\" ||\n                                    att.valueType === \"PERCENTAGE\" ||\n                                    att.valueType === \"INTEGER\" ||\n                                \t\tatt.valueType === \"INTEGER_POSITIVE\" ||\n                                \t\tatt.valueType === \"INTEGER_NEGATIVE\" ||\n                                \t\tatt.valueType === \"INTEGER_ZERO_OR_POSITIVE\" ) {\n                                    newInputField = '<span class=\"hideInPrint\"><input style=\"width:100%;\" ng-disabled=\"selectedOrgUnit.closedStatus\"  type=\"number\"' +\n                                        ' d2-number-validator ' +\n                                        ' number-type=\"' + att.valueType + '\" ' +\n                                        ' ng-blur=\"teiValueUpdated(selectedTei,\\'' + attId + '\\')\" ' +\n                                        commonInputFieldProperty + ' ></span><span class=\"not-for-screen\"><input type=\"text\" value={{selectedTei.' + attId + '}}></span>';\n                                }\n                                else if (att.valueType === \"BOOLEAN\") {\n                                \tnewInputField = '<span class=\"hideInPrint\"><d2-radio-button ' +\n                                                            ' dh-required=\" ' + (att.mandatory || att.unique) + '\" ' +\n                                                            ' dh-disabled=\"selectedOrgUnit.closedStatus || editingDisabled || isHidden(attributesById.' + attId + '.id) || ' + isTrackerAssociate + '\"' +\n                                                            ' dh-value=\"selectedTei.' + attId + '\" ' +\n                                                            ' dh-name=\"foo\" ' +\n                                                            ' dh-current-element=\"currentElement\" ' +\n                                                            ' dh-event=\"currentEvent.event\" ' +\n                                                            ' dh-id=\"' + attId + '\" >' +\n                                                    ' </d2-radio-button></span>' +\n                                                    '<span class=\"not-for-screen\">' +\n                                                        '<label class=\"radio-inline\"><input type=\"radio\" value=\"true\" ng-model=\"selectedTei.' + attId + '\">{{\\'yes\\' | translate}}</label>' +\n                                                        '<label class=\"radio-inline\"><input type=\"radio\" value=\"false\" ng-model=\"selectedTei.' + attId + '\">{{\\'no\\' | translate}}</label>' +\n                                                    '</span>';\n                                }\n                                else if (att.valueType === \"DATE\") {\n                                    newInputField = '<span class=\"hideInPrint\"><input  style=\"width:100%;\" type=\"text\"' +\n                                        ' ng-disabled=\"selectedOrgUnit.closedStatus\"'+\n                                        ' placeholder=\"{{dhis2CalendarFormat.keyDateFormat}}\" ' +\n                                        ' max-date=\" ' + attMaxDate + ' \" ' +\n                                        ' d2-date' +\n                                        ' ng-change=\"verifyExpiryDate(\\'selectedTei.'+attId+'\\')\"'+\n                                        ' blur-or-change=\"teiValueUpdated(selectedTei,\\'' + attId + '\\')\" ' +\n                                        commonInputFieldProperty + ' ></span>' +\n                                        '<span class=\"not-for-screen\"><input type=\"text\" value={{selectedTei.' + attId + '}}></span>';\n                                }\n                                else if (att.valueType === \"TRUE_ONLY\") {\n                                    newInputField = '<span class=\"hideInPrint\"><input style=\"width:100%;\" ng-disabled=\"selectedOrgUnit.closedStatus\" type=\"checkbox\" ' +\n                                        ' ng-change=\"teiValueUpdated(selectedTei,\\'' + attId + '\\')\" ' +\n                                        commonInputFieldProperty + ' ></span>' +\n                                        '<span class=\"not-for-screen\"><input type=\"checkbox\" ng-checked={{selectedTei.' + attId + '}}></span>';\n                                }\n                                else if (att.valueType === \"EMAIL\") {\n                                    newInputField = '<span class=\"hideInPrint\"><input style=\"width:100%;\" type=\"email\" ng-disabled=\"selectedOrgUnit.closedStatus\"' +\n                                        ' ng-blur=\"teiValueUpdated(selectedTei,\\'' + attId + '\\')\" ' +\n                                        commonInputFieldProperty + ' >' +\n                                        '<span class=\"not-for-screen\"><input type=\"text\" value={{selectedTei.' + attId + '}}></span>';\n                                }\n                                else if (att.valueType === \"TRACKER_ASSOCIATE\") {\n                                \tnewInputField = '<span class=\"input-group hideInPrint\"> ' +\n                                                                        ' <input type=\"text\" style=\"width:100%;\"' +\n                                                                        ' ng-blur=\"teiValueUpdated(selectedTei,\\'' + attId + '\\')\" ' +\n                                                                        commonInputFieldProperty + ' >' +\n                                                                        '<span class=\"input-group-btn input-group-btn-no-width\"> ' +\n                                                            '<button class=\"btn btn-grp default-btn-height\" type=\"button\" ' + \n                                                                ' title=\"{{\\'add\\' | translate}} {{attributesById.' + attId + '.displayName}}\" ' +\n                                                                ' ng-if=\"!selectedTei.' + attId + '\" ' +\n                                                                ' ng-disabled=\"selectedOrgUnit.closedStatus\"'+\n                                                                ' ng-class=\"{true: \\'disable-clicks\\'} [editingDisabled]\" ' +\n                                                                ' ng-click=\"getTrackerAssociate(attributesById.' + attId + ', selectedTei.' + attId + ')\" >' +\n                                                                '<i class=\"fa fa-external-link\"></i> ' +\n                                                            '</button> ' + \n                                                            '<button class=\"btn btn-grp default-btn-height\" type=\"button\" ' + \n                                                                ' title=\"{{\\'remove\\' | translate}} {{attributesById.' + attId + '.displayName}}\" ' +\n                                                                ' ng-if=\"selectedTei.' + attId + '\" ' +\n                                                                ' ng-disabled=\"selectedOrgUnit.closedStatus\"'+\n                                                                ' ng-class=\"{true: \\'disable-clicks\\'} [editingDisabled]\" ' +\n                                                                ' ng-click=\"selectedTei.' + attId + ' = null\" >' +\n                                                                '<i class=\"fa fa-trash-o\"></i> ' +\n                                                            '</button> ' + \n                                                        '</span>'+\n                                                    '</span>'+\n                                                    '<span class=\"not-for-screen\"><input type=\"text\" value={{selectedTei.' + attId + '}}></span>';\n                                }\n                                else if (att.valueType === \"AGE\") {\n                                \tnewInputField = '<span class=\"hideInPrint\"><d2-age ' +\n                                                                                    ' id=\" ' + attId + '\" ' +\n\t\t\t\t\t\t                                    ' d2-object=\"selectedTei\" ' +  \t\t\t\t\t\t                                    \n\t\t\t\t\t\t                                    ' d2-required=\" ' + (att.mandatory || att.unique) + '\" ' +\n                                                                                    ' d2-disabled=\"selectedOrgUnit.closedStatus || editingDisabled || isHidden(attributesById.' + attId + '.id) || ' + isTrackerAssociate+ ' || attributesById.' + attId + '.generated\" >' +\n\t\t\t\t\t\t                            '</d2-age></span>'+\n                                                                            '<span class=\"not-for-screen\"><input type=\"text\" value={{selectedTei.' + attId + '}}></span>';\n                                }\n                                else if (att.valueType === \"COORDINATE\") {\n                                \tnewInputField = '<span class=\"hideInPrint\"><d2-map ' +\n                                                                                    ' id=\" ' + attId + '\" ' +\n\t\t\t\t\t\t                                    ' d2-object=\"selectedTei\" ' +  \n\t\t\t\t\t\t                                    ' d2-value=\"selectedTei.' + attId + '\" ' +\n\t\t\t\t\t\t                                    ' d2-required=\" ' + (att.mandatory || att.unique) + '\" ' +\n\t\t\t\t\t                                        ' d2-disabled=\"selectedOrgUnit.closedStatus || editingDisabled || isHidden(attributesById.' + attId + '.id) || ' + isTrackerAssociate+ ' || attributesById.' + attId + '.generated\"' +\n\t\t\t\t\t\t                                    ' d2-coordinate-format=\"\\'TEXT\\'\" > ' +\n\t\t\t\t\t\t                            '</d2-map></span>'+\n                                                                            '<span class=\"not-for-screen\"><input type=\"text\" value={{selectedTei.' + attId + '}}></span>';\n                                }\n                                else if (att.valueType === \"ORGANISATION_UNIT\") {\n                                \tnewInputField = '<span class=\"hideInPrint\"><d2-org-unit-tree ' +\n\t\t\t\t                                            ' selected-org-unit-id=\"{{selectedOrgUnit.id}}\" ' +\n\t\t\t\t                                            ' id=\" ' + attId + '\" ' +\n\t\t\t\t                                            ' d2-object=\"selectedTei\" ' +  \n\t\t\t\t\t\t                                    ' d2-value=\"selectedTei.' + attId + '\" ' +\n\t\t\t\t\t\t                                    ' d2-required=\" ' + (att.mandatory || att.unique) + '\" ' +\n\t\t\t\t\t                                        ' d2-disabled=\"selectedOrgUnit.closedStatus || editingDisabled || isHidden(attributesById.' + attId + '.id) || ' + isTrackerAssociate+ ' || attributesById.' + attId + '.generated\"' +\n                                                                                ' d2-orgunit-names=\"orgUnitNames\" ' +\n\t\t\t\t\t                                        ' d2-function=\"teiValueUpdated()\" >' +\n\t\t\t\t                                    ' </d2-org-unit-tree></span>'+\n                                                                    '<span class=\"not-for-screen\"><input type=\"text\" value={{selectedTei.' + attId + '}}></span>';\n                                }\n                                else if (att.valueType === \"LONG_TEXT\") {\n                                    newInputField = '<span><textarea style=\"width:100%;\" ng-disabled=\"selectedOrgUnit.closedStatus\" row =\"3\" ' +\n                                        ' ng-blur=\"teiValueUpdated(selectedTei,\\'' + attId + '\\')\" ' +\n                                        commonInputFieldProperty + ' ></textarea></span>';\n                                }\n                                else if (att.valueType === \"TEXT\") {\n                                    newInputField = '<input type=\"text\" style=\"width:100%;\" ng-disabled=\"selectedOrgUnit.closedStatus\"' +\n                                        ' ng-blur=\"teiValueUpdated(selectedTei,\\'' + attId + '\\')\" ' +\n                                        commonInputFieldProperty + '>';\n                                }\n                                else if (att.valueType === \"PHONE_NUMBER\") {\n                                    newInputField = '<input type=\"text\" style=\"width:100%;\" ng-disabled=\"selectedOrgUnit.closedStatus\"' +\n                                        ' ng-blur=\"teiValueUpdated(selectedTei,\\'' + attId + '\\')\" ' +\n                                        commonInputFieldProperty + '>';\n                                }\n                                else {                                \t\n                                    newInputField = ' {{\"unsupported_value_type\" | translate }} ' + att.valueType;\n                                }                                \n                            }\n                        }\n                        else{\n                            NotificationService.showNotifcationDialog($translate.instant(\"error\"),\n                                $translate.instant(\"custom_form_has_invalid_attribute\"));\n                            return;\n                        }\n                    }\n\n                    if (attributes.hasOwnProperty('programid')) {\n                        hasProgramDate = true;\n                        programId = attributes['programid'];\n                        if (programId === 'enrollmentDate') {\n                            fieldName = 'dateOfEnrollment';\n                            var enMaxDate = trackedEntityForm.selectEnrollmentDatesInFuture ? '' : 0;\n                            newInputField = '<input type=\"text\" style=\"width:100%;\"' +\n                                ' name=\"' + fieldName + '\"' +\n                                ' element-id=\"' + i + '\"' +\n                                this.getAttributesAsString(attributes) +\n                                ' d2-focus-next-on-enter' +\n                                ' placeholder=\"{{dhis2CalendarFormat.keyDateFormat}}\" ' +\n                                ' ng-model=\"selectedEnrollment.dateOfEnrollment\" ' +\n                                ' ng-change=\"verifyExpiryDate(\\'selectedEnrollment.dateOfEnrollment\\')\"'+\n                                ' ng-disabled=\"\\'' + target + '\\' === \\'PROFILE\\' || selectedOrgUnit.closedStatus\"' +\n                                ' d2-date' +\n                                ' max-date=\"' + enMaxDate + '\"' +\n                                ' ng-required=\"true\">';\n                        }\n                        if (programId === 'dateOfIncident' && trackedEntityForm.displayIncidentDate) {\n                            fieldName = 'dateOfIncident';\n                            var inMaxDate = trackedEntityForm.selectIncidentDatesInFuture ? '' : 0;\n                            newInputField = '<input type=\"text\" style=\"width:100%;\"' +\n                                ' name=\"' + fieldName + '\"' +\n                                ' element-id=\"' + i + '\"' +\n                                this.getAttributesAsString(attributes) +\n                                ' d2-focus-next-on-enter' +\n                                ' placeholder=\"{{dhis2CalendarFormat.keyDateFormat}}\" ' +\n                                ' ng-model=\"selectedEnrollment.dateOfIncident\" ' +\n                                ' ng-change=\"verifyExpiryDate(\\'selectedEnrollment.dateOfIncident\\')\"'+\n                                ' ng-disabled=\"\\'' + target + '\\' === \\'PROFILE\\' || selectedOrgUnit.closedStatus\"' +\n                                ' d2-date ' +\n                                ' max-date=\"' + inMaxDate + '\">';\n                        }\n                    }\n\n                    newInputField = newInputField + ' <span ng-messages=\"outerForm.' + fieldName + '.$error\" class=\"required\" ng-if=\"interacted(outerForm.' + fieldName + ')\" ng-messages-include=\"./templates/error-messages.html\"></span>';\n\n                    htmlCode = htmlCode.replace(inputField, newInputField);\n                }\n                htmlCode = addPopOver(htmlCode, trackedEntityFormAttributes);\n                return {htmlCode: htmlCode, hasProgramDate: hasProgramDate};\n            }\n            return null;\n        },\n        getAttributesAsString: function (attributes) {\n            if (attributes) {\n                var attributesAsString = '';\n                for (var prop in attributes) {\n                    if (prop !== 'value') {\n                        attributesAsString += prop + '=\"' + attributes[prop] + '\" ';\n                    }\n                }\n                return attributesAsString;\n            }\n            return null;\n        }\n    };\n    /* This function inserts the d2-pop-over attributes into the tags containing d2-input-label attribute to\n     * add description and url popover to those tags */\n    function addPopOver(htmlCodeToInsertPopOver, popOverContent) {\n\n        var inputRegex = /<span.*?\\/span>/g;\n        var match, tagToInsertPopOver, tagWithPopOver;\n        var htmlCode = htmlCodeToInsertPopOver;\n        while (match = inputRegex.exec(htmlCodeToInsertPopOver)) {\n            if (match[0].indexOf(\"d2-input-label\") > -1) {\n                tagToInsertPopOver = match[0];\n                tagWithPopOver = insertPopOverSpanToTag(tagToInsertPopOver, popOverContent);\n                htmlCode = htmlCode.replace(tagToInsertPopOver,tagWithPopOver);\n            }\n        }\n        return htmlCode;\n\n    }\n\n    function insertPopOverSpanToTag(tagToInsertPopOverSpan, popOverContent)  {\n\n        var attribute, attributes, fieldId, description, url, element, attValue;\n        var popOverSpanElement, tagWithPopOverSpan;\n\n        element = $(tagToInsertPopOverSpan);\n        attributes = element[0].attributes;\n\n        for (var index = 0; index < attributes.length; index++) {\n            if (attributes[index].name === \"d2-input-label\") {\n                attValue = attributes[index].value;\n                break;\n            }\n        }\n        if (attValue) {\n            popOverSpanElement = $('<span></span>');\n            popOverSpanElement.attr(\"d2-pop-over\",\"\");\n            popOverSpanElement.attr(\"details\",\"{{'details'| translate}}\");\n            popOverSpanElement.attr(\"trigger\",\"click\");\n            popOverSpanElement.attr(\"placement\",\"right\");\n            popOverSpanElement.attr(\"class\",\"popover-label\");\n\n            if (attValue.indexOf(\"attributeId.\") > -1) {\n                fieldId = attValue.split(\".\")[1];\n                description = popOverContent[fieldId].description ? \"'\" + popOverContent[fieldId].description + \"'\" :\n                    \"undefined\";\n                popOverSpanElement.attr(\"content\",\"{description: \" + description + \"}\");\n                popOverSpanElement.attr(\"template\",\"attribute-details.html\");\n\n            } else {\n                fieldId = attValue.split(\"-\")[1];\n                description = popOverContent[fieldId].dataElement.description ? \"'\" +\n                popOverContent[fieldId].dataElement.description + \"'\" : \"undefined\";\n                url = popOverContent[fieldId].dataElement.url ? \"'\" +\n                popOverContent[fieldId].dataElement.url + \"'\" : \"undefined\";\n                popOverSpanElement.attr(\"content\",\"{description: \" + description + \", url:\" + url + \"}\");\n                popOverSpanElement.attr(\"template\",\"dataelement-details.html\");\n            }\n            popOverSpanElement.html(\"<a href title=\\\"{{'details'| translate}}\\\" class=\\\"wrap-text\\\" tabindex=\\\"-1\\\">\" +element.html() + \"</a>\");\n            element.html(popOverSpanElement[0].outerHTML.replace('d2-pop-over=\"\"','d2-pop-over'));\n            tagWithPopOverSpan = element[0].outerHTML;\n        }\n        return tagWithPopOverSpan;\n    }\n})\n\n/* Context menu for grid*/\n.service('ContextMenuSelectedItem', function () {\n    this.selectedItem = '';\n\n    this.setSelectedItem = function (selectedItem) {\n        this.selectedItem = selectedItem;\n    };\n\n    this.getSelectedItem = function () {\n        return this.selectedItem;\n    };\n})\n\n/* Modal service for user interaction */\n.service('ModalService', ['$modal', function ($modal) {\n\n    var modalDefaults = {\n        backdrop: true,\n        keyboard: true,\n        modalFade: true,\n        templateUrl: 'views/modal.html'\n    };\n\n    var modalOptions = {\n        closeButtonText: 'Close',\n        actionButtonText: 'OK',\n        headerText: 'Proceed?',\n        bodyText: 'Perform this action?'\n    };\n\n    this.showModal = function (customModalDefaults, customModalOptions) {\n        if (!customModalDefaults)\n            customModalDefaults = {};\n        customModalDefaults.backdrop = 'static';\n        return this.show(customModalDefaults, customModalOptions);\n    };\n\n    this.show = function (customModalDefaults, customModalOptions) {\n        //Create temp objects to work with since we're in a singleton service\n        var tempModalDefaults = {};\n        var tempModalOptions = {};\n\n        //Map angular-ui modal custom defaults to modal defaults defined in service\n        angular.extend(tempModalDefaults, modalDefaults, customModalDefaults);\n\n        //Map modal.html $scope custom properties to defaults defined in service\n        angular.extend(tempModalOptions, modalOptions, customModalOptions);\n\n        if (!tempModalDefaults.controller) {\n            tempModalDefaults.controller = ['$scope','$modalInstance', function ($scope, $modalInstance) {\n                $scope.modalOptions = tempModalOptions;\n                $scope.modalOptions.ok = function (result) {\n                    $modalInstance.close(result);\n                };\n                $scope.modalOptions.close = function (result) {\n                    $modalInstance.dismiss('cancel');\n                };\n            }];\n        }\n\n        return $modal.open(tempModalDefaults).result;\n    };\n\n}])\n\n/* Dialog service for user interaction */\n.service('DialogService', ['$modal', function ($modal) {\n\n    var dialogDefaults = {\n        backdrop: true,\n        keyboard: true,\n        backdropClick: true,\n        modalFade: true,\n        templateUrl: 'views/dialog.html'\n    };\n\n    var dialogOptions = {\n        closeButtonText: 'close',\n        actionButtonText: 'ok',\n        headerText: 'dhis2_tracker',\n        bodyText: 'Perform this action?'\n    };\n\n    this.showDialog = function (customDialogDefaults, customDialogOptions, summaries) {\n        if (!customDialogDefaults)\n            customDialogDefaults = {};\n        customDialogDefaults.backdropClick = false;\n        return this.show(customDialogDefaults, customDialogOptions, summaries);\n    };\n\n    this.show = function (customDialogDefaults, customDialogOptions, summaries) {\n        //Create temp objects to work with since we're in a singleton service\n        var tempDialogDefaults = {};\n        var tempDialogOptions = {};\n\n        //Map angular-ui modal custom defaults to modal defaults defined in service\n        angular.extend(tempDialogDefaults, dialogDefaults, customDialogDefaults);\n\n        //Map modal.html $scope custom properties to defaults defined in service\n        angular.extend(tempDialogOptions, dialogOptions, customDialogOptions);\n\n        if (!tempDialogDefaults.controller) {\n            tempDialogDefaults.controller = ['$scope','$modalInstance', function ($scope, $modalInstance) {\n                $scope.dialogOptions = tempDialogOptions;\n                $scope.dialogOptions.ok = function (result) {\n                    $modalInstance.close(result);\n                };\n                if(summaries) {\n                    $scope.summaries = summaries;\n                }\n            }];\n            \n        }\n\n        return $modal.open(tempDialogDefaults).result;\n    };\n\n}])\n.service('NotificationService', function (DialogService, $timeout) {\n    this.showNotifcationDialog = function(errorMsgheader, errorMsgBody, errorResponse){\n        var dialogOptions = {\n            headerText: errorMsgheader,\n            bodyText: errorMsgBody\n        };\n        var summaries = null;\n        if (errorResponse && errorResponse.data) {\n            if(errorResponse.data.message && (errorResponse.data.status === 'ERROR' || errorResponse.data.status === 'WARNING')) {\n                dialogOptions.bodyText += \"<br/>\"+errorResponse.data.message+\"<br/>\";\n            }\n            if( errorResponse.data.response && errorResponse.data.response.importSummaries && errorResponse.data.response.importSummaries.length > 0 ){\n                summaries = JSON.stringify(errorResponse.data.response.importSummaries);\n            }\n        }\n        DialogService.showDialog({}, dialogOptions, summaries);\n    };\n\n    this.showNotifcationWithOptions = function(dialogDefaults, dialogOptions){\n        DialogService.showDialog(dialogDefaults, dialogOptions);\n    };\n    \n    this.displayDelayedHeaderMessage = function( message ){\n        setHeaderDelayMessage( message );\n    };\n    \n    this.displayHeaderMessage = function( message ){\n        $timeout(function(){\n            setHeaderMessage( message );\n        }, 1000);\n    };\n    \n    this.removeHeaderMessage = function(){\n        hideHeaderMessage();\n    };\n})\n.service('Paginator', function () {\n    this.page = 1;\n    this.pageSize = 50;\n    this.itemCount = 0;\n    this.pageCount = 0;\n    this.toolBarDisplay = 5;\n\n    this.setPage = function (page) {\n        if (page > this.getPageCount()) {\n            return;\n        }\n\n        this.page = page;\n    };\n\n    this.getPage = function () {\n        return this.page;\n    };\n\n    this.setPageSize = function (pageSize) {\n        this.pageSize = pageSize;\n    };\n\n    this.getPageSize = function () {\n        return this.pageSize;\n    };\n\n    this.setItemCount = function (itemCount) {\n        this.itemCount = itemCount;\n    };\n\n    this.getItemCount = function () {\n        return this.itemCount;\n    };\n\n    this.setPageCount = function (pageCount) {\n        this.pageCount = pageCount;\n    };\n\n    this.getPageCount = function () {\n        return this.pageCount;\n    };\n\n    this.setToolBarDisplay = function (toolBarDisplay) {\n        this.toolBarDisplay = toolBarDisplay;\n    };\n\n    this.getToolBarDisplay = function () {\n        return this.toolBarDisplay;\n    };\n\n    this.lowerLimit = function () {\n        var pageCountLimitPerPageDiff = this.getPageCount() - this.getToolBarDisplay();\n\n        if (pageCountLimitPerPageDiff < 0) {\n            return 0;\n        }\n\n        if (this.getPage() > pageCountLimitPerPageDiff + 1) {\n            return pageCountLimitPerPageDiff;\n        }\n\n        var low = this.getPage() - (Math.ceil(this.getToolBarDisplay() / 2) - 1);\n\n        return Math.max(low, 0);\n    };\n})\n\n.service('GridColumnService', function ($http, $q, DHIS2URL, $translate, SessionStorageService, NotificationService) {\n    var GRIDCOLUMNS_URL = DHIS2URL+'/userDataStore/gridColumns/';\n    return {\n        columnExists: function (cols, id) {\n            var colExists = false;\n            if (!angular.isObject(cols) || !id || angular.isObject(cols) && !cols.length) {\n                return colExists;\n            }\n\n            for (var i = 0; i < cols.length && !colExists; i++) {\n                if (cols[i].id === id) {\n                    colExists = true;\n                }\n            }\n            return colExists;\n        },\n        set: function (gridColumns, name) {\n            var deferred = $q.defer();\n            var httpMessage = {\n                method: \"put\",\n                url: GRIDCOLUMNS_URL + name,\n                data: {\"gridColumns\": gridColumns},\n                headers: {'Content-Type': 'application/json;charset=UTF-8'}\n            };\n\n            $http(httpMessage).then(function (response) {\n                deferred.resolve(response.data);\n            },function (error) {\n                httpMessage.method = \"post\";\n                $http(httpMessage).then(function (response) {\n                    deferred.resolve(response.data);\n                }, function (error) {\n                    if (error && error.data) {\n                        deferred.resolve(error.data);\n                    } else {\n                        deferred.resolve(null);\n                    }\n                });\n            });\n            return deferred.promise;\n        },\n        get: function (name) {\n            var promise = $http.get(GRIDCOLUMNS_URL+name).then(function (response) {\n                if (response && response.data && response.data.gridColumns) {\n                    SessionStorageService.set(name, {id:name, columns:response.data.gridColumns});\n                    return response.data.gridColumns;\n                } else {\n                    NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"gridColumns_invalid\"));\n                    return null;\n                }\n            }, function (error) {\n                var gridColumnsFromSessionStore = SessionStorageService.get(name);\n                if (gridColumnsFromSessionStore && gridColumnsFromSessionStore.columns) {\n                    return gridColumnsFromSessionStore.columns;\n                }\n                return null;\n            });\n            return promise;\n        }\n    };\n})\n\n/* Service for uploading/downloading file */\n.service('FileService', function ($http, DHIS2URL) {\n\n    return {\n        get: function (uid) {\n            var promise = $http.get(DHIS2URL + '/fileResources/' + uid).then(function (response) {\n                return response.data;\n            } ,function(error) {\n                return null;\n            });\n            return promise;\n        },\n        download: function (fileName) {\n            var promise = $http.get(fileName).then(function (response) {\n                return response.data;\n            }, function(error) {\n                return null;\n            });\n            return promise;\n        },\n        upload: function(file){\n            var formData = new FormData();\n            formData.append('file', file);\n            var headers = {transformRequest: angular.identity, headers: {'Content-Type': undefined}};\n            var promise = $http.post(DHIS2URL + '/fileResources', formData, headers).then(function(response){\n                return response.data;\n            },function(error) {\n               return null;\n            });\n            return promise;\n        }\n    };\n})\n/* Returns a function for getting rules for a specific program */\n.factory('RulesFactory', function($q,MetaDataFactory,$filter){\n    var staticReplacements = \n                        [{regExp:new RegExp(\"([^\\w\\d])(and)([^\\w\\d])\",\"gi\"), replacement:\"$1&&$3\"},\n                        {regExp:new RegExp(\"([^\\w\\d])(or)([^\\w\\d])\",\"gi\"), replacement:\"$1||$3\"},\n                        {regExp:new RegExp(\"V{execution_date}\",\"g\"), replacement:\"V{event_date}\"}];\n\n    var performStaticReplacements = function(expression) {\n        angular.forEach(staticReplacements, function(staticReplacement) {\n            expression = expression.replace(staticReplacement.regExp, staticReplacement.replacement);\n        });\n\n        return expression;\n    };\n\n    return{        \n        loadRules : function(programUid){            \n            var def = $q.defer();            \n            MetaDataFactory.getAll('constants').then(function(constants) {\n                MetaDataFactory.getByProgram('programIndicators',programUid).then(function(pis){                    \n                    var variables = [];\n                    var programRules = [];\n                    angular.forEach(pis, function(pi){\n                        if(pi.displayInForm){\n                            var newAction = {\n                                    id:pi.id,\n                                    content:pi.displayDescription ? pi.displayDescription : pi.displayName,\n                                    data:pi.expression,\n                                    programRuleActionType:'DISPLAYKEYVALUEPAIR',\n                                    location:'indicators'\n                                };\n                            var newRule = {\n                                    displayName:pi.displayName,\n                                    id: pi.id,\n                                    shortname:pi.shortname,\n                                    code:pi.code,\n                                    program:pi.program,\n                                    description:pi.description,\n                                    condition:pi.filter ? pi.filter : 'true',\n                                    programRuleActions: [newAction]\n                                };\n\n                            programRules.push(newRule);\n\n                            var variablesInCondition = newRule.condition.match(/[A#]{\\w+.?\\w*}/g);\n                            var variablesInData = newAction.data.match(/[A#]{\\w+.?\\w*}/g);\n                            var valueCountPresent = newRule.condition.indexOf(\"V{value_count}\") >= 0 \n                                                            || newAction.data.indexOf(\"V{value_count}\") >= 0;\n                            var positiveValueCountPresent = newRule.condition.indexOf(\"V{zero_pos_value_count}\") >= 0\n                                                            || newAction.data.indexOf(\"V{zero_pos_value_count}\") >= 0;\n                            var variableObjectsCurrentExpression = [];\n\n                            var pushDirectAddressedVariable = function(variableWithCurls) {\n                                var variableName = $filter('trimvariablequalifiers')(variableWithCurls);\n                                var variableNameParts = variableName.split('.');\n\n                                var newVariableObject;\n\n                                if(variableNameParts.length === 2) {\n                                    //this is a programstage and dataelement specification. translate to program variable:\n                                    newVariableObject = {\n                                        displayName:variableName,\n                                        programRuleVariableSourceType:'DATAELEMENT_CURRENT_EVENT',\n                                        dataElement:variableNameParts[1],\n                                        program:programUid,\n                                        useCodeForOptionSet:true\n                                    };\n                                }\n                                else if(variableNameParts.length === 1)\n                                {\n                                    //This is an attribute - let us translate to program variable:\n                                    newVariableObject = {\n                                        displayName:variableName,\n                                        programRuleVariableSourceType:'TEI_ATTRIBUTE',\n                                        trackedEntityAttribute:variableNameParts[0],\n                                        program:programUid,\n                                        useCodeForOptionSet:true\n                                    };\n                                }\n                                \n                                variables.push(newVariableObject);\n\n                                return newVariableObject;\n\n                            };\n\n                            angular.forEach(variablesInCondition, function(variableInCondition) {\n                                var pushed = pushDirectAddressedVariable(variableInCondition);\n                            });\n\n                            angular.forEach(variablesInData, function(variableInData) {\n                                var pushed = pushDirectAddressedVariable(variableInData);\n\n                                //We only count the number of values in the data part of the rule\n                                //(Called expression in program indicators)\n                                variableObjectsCurrentExpression.push(pushed);\n                            });\n\n                            //Change expression or data part of the rule to match the program rules execution model\n                            if(valueCountPresent) {\n                                var valueCountText;\n                                angular.forEach(variableObjectsCurrentExpression, function(variableCurrentRule) {\n                                   if(valueCountText) {\n                                       //This is not the first value in the value count part of the expression. \n                                       valueCountText +=  ' + d2:count(\\'' + variableCurrentRule.displayName + '\\')';\n                                   }\n                                   else\n                                   {\n                                       //This is the first part value in the value count expression:\n                                       valueCountText = '(d2:count(\\'' + variableCurrentRule.displayName + '\\')';\n                                   }\n                                });\n                                //To finish the value count expression we need to close the paranthesis:\n                                valueCountText += ')';\n\n                                //Replace all occurrences of value counts in both the data and expression:\n                                newRule.condition = newRule.condition.replace(new RegExp(\"V{value_count}\", 'g'),valueCountText);\n                                newAction.data = newAction.data.replace(new RegExp(\"V{value_count}\", 'g'),valueCountText);\n                            }\n                            if(positiveValueCountPresent) {\n                                var zeroPosValueCountText;\n                                angular.forEach(variableObjectsCurrentExpression, function(variableCurrentRule) {\n                                   if(zeroPosValueCountText) {\n                                       //This is not the first value in the value count part of the expression. \n                                       zeroPosValueCountText +=  '+ d2:countifzeropos(\\'' + variableCurrentRule.displayName + '\\')';\n                                   }\n                                   else\n                                   {\n                                       //This is the first part value in the value count expression:\n                                       zeroPosValueCountText = '(d2:countifzeropos(\\'' + variableCurrentRule.displayName + '\\')';\n                                   }\n                                });\n                                //To finish the value count expression we need to close the paranthesis:\n                                zeroPosValueCountText += ')';\n\n                                //Replace all occurrences of value counts in both the data and expression:\n                                newRule.condition = newRule.condition.replace(new RegExp(\"V{zero_pos_value_count}\", 'g'),zeroPosValueCountText);\n                                newAction.data = newAction.data.replace(new RegExp(\"V{zero_pos_value_count}\", 'g'),zeroPosValueCountText);\n                            }\n\n                            newAction.data = performStaticReplacements(newAction.data);\n                            newRule.condition = performStaticReplacements(newRule.condition);\n                        }\n                    });\n\n                    var programIndicators = {rules:programRules, variables:variables};\n\n                    MetaDataFactory.getByProgram('programValidations',programUid).then(function(programValidations){                    \n                        MetaDataFactory.getByProgram('programRuleVariables',programUid).then(function(programVariables){                    \n                            MetaDataFactory.getByProgram('programRules',programUid).then(function(prs){\n                                var programRules = [];\n                                angular.forEach(prs, function(rule){\n                                    rule.actions = [];\n                                    rule.programStageId = rule.programStage && rule.programStage.id ? rule.programStage.id : null;\n                                    programRules.push(rule);\n                                });                                \n                                def.resolve({constants: constants, programIndicators: programIndicators, programValidations: programValidations, programVariables: programVariables, programRules: programRules});\n                            });\n                        });\n                    });\n                }); \n            });                        \n            return def.promise;\n        }\n    };  \n})\n/* service for building variables based on the data in users fields */\n.service('VariableService', function(DateUtils,OptionSetService,$filter,$log){\n    var processSingleValue = function(processedValue,valueType){\n        //First clean away single or double quotation marks at the start and end of the variable name.\n        processedValue = $filter('trimquotes')(processedValue);\n\n        if(processedValue === \"Yes\") {\n            processedValue = true;\n        }\n        if(processedValue === \"No\") {\n            processedValue = false;\n        }\n\n        //Append single quotation marks in case the variable is of text or date type:\n        if(valueType === 'LONG_TEXT' || valueType === 'TEXT' || valueType === 'DATE' || valueType === 'OPTION_SET') {\n            if(processedValue) {\n                processedValue = \"'\" + processedValue + \"'\";\n            } else {\n                processedValue = \"''\";\n            }\n        }\n        else if(valueType === 'BOOLEAN' || valueType === 'TRUE_ONLY') {\n            if(processedValue && eval(processedValue)) {\n                processedValue = true;\n            }\n            else {\n                processedValue = false;\n            }\n        }\n        else if( valueType === \"INTEGER\" || valueType === \"NUMBER\" || valueType === \"INTEGER_POSITIVE\"\n             ||  valueType === \"INTEGER_NEGATIVE\" || valueType === \"INTEGER_ZERO_OR_POSITIVE\" ||\n                 valueType === \"PERCENTAGE\") {\n            if(processedValue) {\n                processedValue = Number(processedValue);\n            } else {\n                processedValue = 0;\n            }\n        }\n        else{\n            $log.warn(\"unknown datatype:\" + valueType);\n        }\n\n        return processedValue;\n    };\n\n    var pushVariable = function(variables, variablename, varValue, allValues, varType, variablefound, variablePrefix, variableEventDate, useCodeForOptionSet) {\n\n        var processedValues = [];\n\n        angular.forEach(allValues, function(alternateValue) {\n            processedValues.push(processSingleValue(alternateValue,varType));\n        });\n\n        variables[variablename] = {\n            variableValue:processSingleValue(varValue, varType),\n            useCodeForOptionSet:useCodeForOptionSet,\n            variableType:varType,\n            hasValue:variablefound,\n            variableEventDate:variableEventDate,\n            variablePrefix:variablePrefix,\n            allValues:processedValues\n        };\n        return variables;\n    };\n    \n    var getDataElementValueOrCodeForValueInternal = function(useCodeForOptionSet, value, dataElementId, allDes, optionSets) {\n        return useCodeForOptionSet && allDes && allDes[dataElementId].dataElement.optionSet ? \n                                            OptionSetService.getCode(optionSets[allDes[dataElementId].dataElement.optionSet.id].options, value)\n                                            : value;\n    };\n\n    return {\n        processValue: function(value, type) {\n            return processSingleValue(value,type);\n        },\n        getDataElementValueOrCode: function(useCodeForOptionSet, event, dataElementId, allDes, optionSets) {\n            return getDataElementValueOrCodeForValueInternal(useCodeForOptionSet, event[dataElementId], dataElementId, allDes, optionSets);\n        },\n        getDataElementValueOrCodeForValue: function(useCodeForOptionSet, value, dataElementId, allDes, optionSets) {\n            return getDataElementValueOrCodeForValueInternal(useCodeForOptionSet, value, dataElementId, allDes, optionSets);\n        },\n        getVariables: function(allProgramRules, executingEvent, evs, allDes, selectedEntity, selectedEnrollment, optionSets) {\n\n            var variables = {};\n\n            var programVariables = allProgramRules.programVariables;\n\n            programVariables = programVariables.concat(allProgramRules.programIndicators.variables);\n\n            angular.forEach(programVariables, function(programVariable) {\n                var dataElementId = programVariable.dataElement;\n                if(programVariable.dataElement && programVariable.dataElement.id) {\n                    dataElementId = programVariable.dataElement.id;\n                }\n\n                var trackedEntityAttributeId = programVariable.trackedEntityAttribute;\n                if(programVariable.trackedEntityAttribute && programVariable.trackedEntityAttribute.id) {\n                    trackedEntityAttributeId = programVariable.trackedEntityAttribute.id;\n                }\n\n                var programStageId = programVariable.programStage;\n                if(programVariable.programStage && programVariable.programStage.id) {\n                    programStageId = programVariable.programStage.id;\n                }\n\n                var valueFound = false;\n                //If variable evs is not defined, it means the rules is run before any events is registered, skip the types that require an event\n                if(programVariable.programRuleVariableSourceType === \"DATAELEMENT_NEWEST_EVENT_PROGRAM_STAGE\" && evs && evs.byStage){\n                    if(programStageId) {\n                        var allValues = [];\n                        angular.forEach(evs.byStage[programStageId], function(event) {\n                            if(event[dataElementId] !== null) {\n                                if(angular.isDefined(event[dataElementId])\n                                        && event[dataElementId] !== \"\"){\n                                    var value = getDataElementValueOrCodeForValueInternal(programVariable.useCodeForOptionSet, event[dataElementId], dataElementId, allDes, optionSets);\n                                            \n                                    allValues.push(value);\n                                    valueFound = true;\n                                    variables = pushVariable(variables, programVariable.displayName, value, allValues, allDes[dataElementId].dataElement.valueType, valueFound, '#', event.eventDate, programVariable.useCodeForOptionSet);\n                                }\n                            }\n                        });\n                    } else {\n                        $log.warn(\"Variable id:'\" + programVariable.id + \"' name:'\" + programVariable.displayName\n                            + \"' does not have a programstage defined,\"\n                            + \" despite that the variable has sourcetype DATAELEMENT_NEWEST_EVENT_PROGRAM_STAGE\" );\n                    }\n                }\n                else if(programVariable.programRuleVariableSourceType === \"DATAELEMENT_NEWEST_EVENT_PROGRAM\" && evs){\n                    var allValues = [];\n                    angular.forEach(evs.all, function(event) {\n                        if(angular.isDefined(event[dataElementId])\n                            && event[dataElementId] !== null \n                            && event[dataElementId] !== \"\"){\n                            var value = getDataElementValueOrCodeForValueInternal(programVariable.useCodeForOptionSet, event[dataElementId], dataElementId, allDes, optionSets);\n                                    \n                            allValues.push(value);\n                            valueFound = true;\n                            variables = pushVariable(variables, programVariable.displayName, value, allValues, allDes[dataElementId].dataElement.valueType, valueFound, '#', event.eventDate, programVariable.useCodeForOptionSet);\n                        }\n                    });\n                }\n                else if(programVariable.programRuleVariableSourceType === \"DATAELEMENT_CURRENT_EVENT\" && evs){\n                    if(angular.isDefined(executingEvent[dataElementId])\n                        && executingEvent[dataElementId] !== null \n                        && executingEvent[dataElementId] !== \"\"){\n                        var value = getDataElementValueOrCodeForValueInternal(programVariable.useCodeForOptionSet, executingEvent[dataElementId], dataElementId, allDes, optionSets);\n                            \n                        valueFound = true;\n                        variables = pushVariable(variables, programVariable.displayName, value, null, allDes[dataElementId].dataElement.valueType, valueFound, '#', executingEvent.eventDate, programVariable.useCodeForOptionSet );\n                    }\n                }\n                else if(programVariable.programRuleVariableSourceType === \"DATAELEMENT_PREVIOUS_EVENT\" && evs){\n                    //Only continue checking for a value if there is more than one event.\n                    if(evs.all && evs.all.length > 1) {\n                        var allValues = [];\n                        var previousvalue = null;\n                        var previousEventDate = null;\n                        var currentEventPassed = false;\n                        for(var i = 0; i < evs.all.length; i++) {\n                            //Store the values as we iterate through the stages\n                            //If the event[i] is not the current event, it is older(previous). Store the previous value if it exists\n                            if(!currentEventPassed && evs.all[i] !== executingEvent &&\n                                angular.isDefined(evs.all[i][dataElementId])\n                                && evs.all[i][dataElementId] !== \"\") {\n                                previousvalue = getDataElementValueOrCodeForValueInternal(programVariable.useCodeForOptionSet, evs.all[i][dataElementId], dataElementId, allDes, optionSets);\n                                previousEventDate = evs.all[i].eventDate;\n                                allValues.push(value);\n                                valueFound = true;\n                            }\n                            else if(evs.all[i] === executingEvent) {\n                                //We have iterated to the newest event - store the last collected variable value - if any is found:\n                                if(valueFound) {\n                                    variables = pushVariable(variables, programVariable.displayName, previousvalue, allValues, allDes[dataElementId].dataElement.valueType, valueFound, '#', previousEventDate, programVariable.useCodeForOptionSet);\n                                }\n                                //Set currentEventPassed, ending the iteration:\n                                currentEventPassed = true;\n                            }\n                        }\n                    }\n                }\n                else if(programVariable.programRuleVariableSourceType === \"TEI_ATTRIBUTE\"){\n                    angular.forEach(selectedEntity.attributes , function(attribute) {\n                        if(!valueFound) {\n                            if(attribute.attribute === trackedEntityAttributeId\n                                    && angular.isDefined(attribute.value)\n                                    && attribute.value !== null\n                                    && attribute.value !== \"\") {\n                                valueFound = true;\n                                //In registration, the attribute type is found in .type, while in data entry the same data is found in .valueType.\n                                //Handling here, but planning refactor in registration so it will always be .valueType\n                                variables = pushVariable(variables, \n                                    programVariable.displayName, \n                                    programVariable.useCodeForOptionSet ? (angular.isDefined(attribute.optionSetCode) ? attribute.optionSetCode : attribute.value) : attribute.value,\n                                    null, \n                                    attribute.type ? attribute.type : attribute.valueType, valueFound, \n                                    'A', \n                                    '',\n                                    programVariable.useCodeForOptionSet);\n                            }\n                        }\n                    });\n                }\n                else if(programVariable.programRuleVariableSourceType === \"CALCULATED_VALUE\"){\n                    //We won't assign the calculated variables at this step. The rules execution will calculate and assign the variable.\n                }\n                else {\n                    //If the rules was executed without events, we ended up in this else clause as expected, as most of the variables require an event to be mapped\n                    if(evs)\n                    {\n                        //If the rules was executed and events was supplied, we should have found an if clause for the the source type, and not ended up in this dead end else.\n                        $log.warn(\"Unknown programRuleVariableSourceType:\" + programVariable.programRuleVariableSourceType);\n                    }\n                }\n\n\n                if(!valueFound){\n                    //If there is still no value found, assign default value:\n                    if(dataElementId && allDes) {\n                        var dataElement = allDes[dataElementId];\n                        if( dataElement ) {\n                            variables = pushVariable(variables, programVariable.displayName, \"\", null, dataElement.dataElement.valueType, false, '#', '', programVariable.useCodeForOptionSet );\n                        }\n                        else {\n                            $log.warn(\"Variable #{\" + programVariable.displayName + \"} is linked to a dataelement that is not part of the program\");\n                            variables = pushVariable(variables, programVariable.displayName, \"\", null, \"TEXT\",false, '#', '', programVariable.useCodeForOptionSet );\n                        }\n                    }\n                    else if (programVariable.trackedEntityAttribute) {\n                        //The variable is an attribute, set correct prefix and a blank value\n                        variables = pushVariable(variables, programVariable.displayName, \"\", null, \"TEXT\",false, 'A', '', programVariable.useCodeForOptionSet );\n                    }\n                    else {\n                        //Fallback for calculated(assigned) values:\n                        variables = pushVariable(variables, programVariable.displayName, \"\", null, \"TEXT\",false, '#', '', programVariable.useCodeForOptionSet );\n                    }\n                }\n            });\n\n            //add context variables:\n            //last parameter \"valuefound\" is always true for event date\n            variables = pushVariable(variables, 'current_date', DateUtils.getToday(), null, 'DATE', true, 'V', '', false );\n\n            variables = pushVariable(variables, 'event_date', executingEvent.eventDate, null, 'DATE', true, 'V', '', false );\n            variables = pushVariable(variables, 'due_date', executingEvent.dueDate, null, 'DATE', true, 'V', '' );\n            variables = pushVariable(variables, 'event_count', evs ? evs.all.length : 0, null, 'INTEGER', true, 'V', '', false );\n\n            variables = pushVariable(variables, 'enrollment_date', selectedEnrollment ? selectedEnrollment.enrollmentDate : '', null, 'DATE', selectedEnrollment ? true : false, 'V', '', false );\n            variables = pushVariable(variables, 'enrollment_id', selectedEnrollment ? selectedEnrollment.enrollment : '', null, 'TEXT',  selectedEnrollment ? true : false, 'V', '', false );\n            variables = pushVariable(variables, 'event_id', executingEvent ? executingEvent.event : '', null, 'TEXT',  executingEvent ? true : false, 'V', executingEvent ? executingEvent.eventDate : false, false);\n\n            variables = pushVariable(variables, 'incident_date', selectedEnrollment ? selectedEnrollment.incidentDate : '', null, 'DATE',  selectedEnrollment ? true : false, 'V', '', false);\n            variables = pushVariable(variables, 'enrollment_count', selectedEnrollment ? 1 : 0, null, 'INTEGER', true, 'V', '', false);\n            variables = pushVariable(variables, 'tei_count', selectedEnrollment ? 1 : 0, null, 'INTEGER', true, 'V', '', false);\n\n            //Push all constant values:\n            angular.forEach(allProgramRules.constants, function(constant){\n                variables = pushVariable(variables, constant.id, constant.value, null, 'INTEGER', true, 'C', '', false);\n            });\n\n            return variables;\n        }\n    };\n})\n\n/* service for executing tracker rules and broadcasting results */\n.service('TrackerRulesExecutionService', function($translate, VariableService, DateUtils, NotificationService, DHIS2EventFactory, RulesFactory, CalendarService, OptionSetService, $rootScope, $q, $log, $filter, orderByFilter){\n    var NUMBER_OF_EVENTS_IN_SCOPE = 10;\n\n    //Variables for storing scope and rules in memory from rules execution to rules execution:\n    var allProgramRules = false; \n    var crossEventRulesExist = false;\n    var lastEventId = null;\n    var lastEventDate = null;\n    var lastProgramId = null;\n    var eventScopeExceptCurrent = false;\n\n    var replaceVariables = function(expression, variablesHash){\n        //replaces the variables in an expression with actual variable values.\n\n        //Check if the expression contains program rule variables at all(any curly braces):\n        if(expression.indexOf('{') !== -1) {\n            //Find every variable name in the expression;\n            var variablespresent = expression.match(/[A#CV]{\\w+.?\\w*}/g);\n            //Replace each matched variable:\n            angular.forEach(variablespresent, function(variablepresent) {\n                //First strip away any prefix and postfix signs from the variable name:\n                variablepresent = variablepresent.replace(\"#{\",\"\").replace(\"A{\",\"\").replace(\"C{\",\"\").replace(\"V{\",\"\").replace(\"}\",\"\");\n\n                if(angular.isDefined(variablesHash[variablepresent])) {\n                    //Replace all occurrences of the variable name(hence using regex replacement):\n                    expression = expression.replace(new RegExp( variablesHash[variablepresent].variablePrefix + \"{\" + variablepresent + \"}\", 'g'),\n                        variablesHash[variablepresent].variableValue);\n                }\n                else {\n                    $log.warn(\"Expression \" + expression + \" conains variable \" + variablepresent\n                        + \" - but this variable is not defined.\" );\n                }\n            });\n        }\n\n        //Check if the expression contains environment  variables\n        if(expression.indexOf('V{') !== -1) {\n            //Find every variable name in the expression;\n            var variablespresent = expression.match(/V{\\w+.?\\w*}/g);\n            //Replace each matched variable:\n            angular.forEach(variablespresent, function(variablepresent) {\n                //First strip away any prefix and postfix signs from the variable name:\n                variablepresent = variablepresent.replace(\"V{\",\"\").replace(\"}\",\"\");\n\n                if(angular.isDefined(variablesHash[variablepresent]) &&\n                    variablesHash[variablepresent].variablePrefix === 'V') {\n                    //Replace all occurrences of the variable name(hence using regex replacement):\n                    expression = expression.replace(new RegExp(\"V{\" + variablepresent + \"}\", 'g'),\n                        variablesHash[variablepresent].variableValue);\n                }\n                else {\n                    $log.warn(\"Expression \" + expression + \" conains context variable \" + variablepresent\n                        + \" - but this variable is not defined.\" );\n                }\n            });\n        }\n\n        //Check if the expression contains attribute variables:\n        if(expression.indexOf('A{') !== -1) {\n            //Find every attribute in the expression;\n            var variablespresent = expression.match(/A{\\w+.?\\w*}/g);\n            //Replace each matched variable:\n            angular.forEach(variablespresent, function(variablepresent) {\n                //First strip away any prefix and postfix signs from the variable name:\n                variablepresent = variablepresent.replace(\"A{\",\"\").replace(\"}\",\"\");\n\n                if(angular.isDefined(variablesHash[variablepresent]) &&\n                    variablesHash[variablepresent].variablePrefix === 'A') {\n                    //Replace all occurrences of the variable name(hence using regex replacement):\n                    expression = expression.replace(new RegExp(\"A{\" + variablepresent + \"}\", 'g'),\n                        variablesHash[variablepresent].variableValue);\n                }\n                else {\n                    $log.warn(\"Expression \" + expression + \" conains attribute \" + variablepresent\n                        + \" - but this attribute is not defined.\" );\n                }\n            });\n        }\n\n        //Check if the expression contains constants\n        if(expression.indexOf('C{') !== -1) {\n            //Find every constant in the expression;\n            var variablespresent = expression.match(/C{\\w+.?\\w*}/g);\n            //Replace each matched variable:\n            angular.forEach(variablespresent, function(variablepresent) {\n                //First strip away any prefix and postfix signs from the variable name:\n                variablepresent = variablepresent.replace(\"C{\",\"\").replace(\"}\",\"\");\n\n                if(angular.isDefined(variablesHash[variablepresent]) &&\n                    variablesHash[variablepresent].variablePrefix === 'C') {\n                    //Replace all occurrences of the variable name(hence using regex replacement):\n                    expression = expression.replace(new RegExp(\"C{\" + variablepresent + \"}\", 'g'),\n                        variablesHash[variablepresent].variableValue);\n                }\n                else {\n                    $log.warn(\"Expression \" + expression + \" conains constant \" + variablepresent\n                        + \" - but this constant is not defined.\" );\n                }\n            });\n        }\n\n        return expression;\n    };\n\n    var runDhisFunctions = function(expression, variablesHash, flag){\n        //Called from \"runExpression\". Only proceed with this logic in case there seems to be dhis function calls: \"d2:\" is present.\n        if(angular.isDefined(expression) && expression.indexOf(\"d2:\") !== -1){\n            var dhisFunctions = [{name:\"d2:daysBetween\",parameters:2},\n                {name:\"d2:weeksBetween\",parameters:2},\n                {name:\"d2:monthsBetween\",parameters:2},\n                {name:\"d2:yearsBetween\",parameters:2},\n                {name:\"d2:floor\",parameters:1},\n                {name:\"d2:modulus\",parameters:2},\n                {name:\"d2:concatenate\"},\n                {name:\"d2:addDays\",parameters:2},\n                {name:\"d2:zing\",parameters:1},\n                {name:\"d2:oizp\",parameters:1},\n                {name:\"d2:count\",parameters:1},\n                {name:\"d2:countIfZeroPos\",parameters:1},\n                {name:\"d2:countIfValue\",parameters:2},\n                {name:\"d2:ceil\",parameters:1},\n                {name:\"d2:round\",parameters:1},\n                {name:\"d2:hasValue\",parameters:1},\n                {name:\"d2:lastEventDate\",parameters:1},\n                {name:\"d2:validatePattern\",parameters:2},\n                {name:\"d2:addControlDigits\",parameters:1},\n                {name:\"d2:checkControlDigits\",parameters:1},\n                {name:\"d2:left\",parameters:2},\n                {name:\"d2:right\",parameters:2},\n                {name:\"d2:substring\",parameters:3},\n                {name:\"d2:split\",parameters:3},\n                {name:\"d2:length\",parameters:1}];\n            var continueLooping = true;\n            //Safety harness on 10 loops, in case of unanticipated syntax causing unintencontinued looping\n            for(var i = 0; i < 10 && continueLooping; i++ ) {\n                var expressionUpdated = false;\n                var brokenExecution = false;\n                angular.forEach(dhisFunctions, function(dhisFunction){\n                    //Select the function call, with any number of parameters inside single quotations, or number parameters witout quotations\n                    var regularExFunctionCall = new RegExp(dhisFunction.name + \"\\\\( *(([\\\\d/\\\\*\\\\+\\\\-%\\.]+)|( *'[^']*'))*( *, *(([\\\\d/\\\\*\\\\+\\\\-%\\.]+)|'[^']*'))* *\\\\)\",'g');\n                    var callsToThisFunction = expression.match(regularExFunctionCall);\n                    angular.forEach(callsToThisFunction, function(callToThisFunction){\n                        //Remove the function name and paranthesis:\n                        var justparameters = callToThisFunction.replace(/(^[^\\(]+\\()|\\)$/g,\"\");\n                        //Remove white spaces before and after parameters:\n                        justparameters = justparameters.trim();\n                        //Then split into single parameters:\n                        var parameters = justparameters.match(/(('[^']+')|([^,]+))/g);\n\n                        //Show error if no parameters is given and the function requires parameters,\n                        //or if the number of parameters is wrong.\n                        if(angular.isDefined(dhisFunction.parameters)){\n                            //But we are only checking parameters where the dhisFunction actually has a defined set of parameters(concatenate, for example, does not have a fixed number);\n                            var numParameters = parameters ? parameters.length : 0;\n                            \n                            if(numParameters !== dhisFunction.parameters){\n                                $log.warn(dhisFunction.name + \" was called with the incorrect number of parameters\");\n                                \n                                //Mark this function call as broken:\n                                brokenExecution = true;\n                            }\n                        }\n\n                        //In case the function call is nested, the parameter itself contains an expression, run the expression.\n                        if(!brokenExecution && angular.isDefined(parameters) && parameters !== null) {\n                            for (var i = 0; i < parameters.length; i++) {\n                                parameters[i] = runExpression(parameters[i],dhisFunction.name,\"parameter:\" + i, flag, variablesHash);\n                            }\n                        }\n\n                        //Special block for d2:weeksBetween(*,*) - add such a block for all other dhis functions.\n                        if(brokenExecution) {\n                            //Function call is not possible to evaluate, remove the call:\n                            expression = expression.replace(callToThisFunction, \"false\");\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:daysBetween\") {\n                            var firstdate = $filter('trimquotes')(parameters[0]);\n                            var seconddate = $filter('trimquotes')(parameters[1]);\n                            firstdate = moment(firstdate);\n                            seconddate = moment(seconddate);\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, seconddate.diff(firstdate,'days'));\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:weeksBetween\") {\n                            var firstdate = $filter('trimquotes')(parameters[0]);\n                            var seconddate = $filter('trimquotes')(parameters[1]);\n                            firstdate = moment(firstdate);\n                            seconddate = moment(seconddate);\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, seconddate.diff(firstdate,'weeks'));\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:monthsBetween\") {\n                            var firstdate = $filter('trimquotes')(parameters[0]);\n                            var seconddate = $filter('trimquotes')(parameters[1]);\n                            firstdate = moment(firstdate);\n                            seconddate = moment(seconddate);\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, seconddate.diff(firstdate,'months'));\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:yearsBetween\") {\n                            var firstdate = $filter('trimquotes')(parameters[0]);\n                            var seconddate = $filter('trimquotes')(parameters[1]);\n                            firstdate = moment(firstdate);\n                            seconddate = moment(seconddate);\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, seconddate.diff(firstdate,'years'));\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:floor\") {\n                            var floored = Math.floor(parameters[0]);\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, floored);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:modulus\") {\n                            var dividend = Number(parameters[0]);\n                            var divisor = Number(parameters[1]);\n                            var rest = dividend % divisor;\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, rest);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:concatenate\") {\n                            var returnString = \"'\";\n                            for (var i = 0; i < parameters.length; i++) {\n                                returnString += parameters[i];\n                            }\n                            returnString += \"'\";\n                            expression = expression.replace(callToThisFunction, returnString);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:addDays\") {\n                            var date = $filter('trimquotes')(parameters[0]);\n                            var daystoadd = $filter('trimquotes')(parameters[1]);\n                            var newdate = DateUtils.format( moment(date, CalendarService.getSetting().momentFormat).add(daystoadd, 'days') );\n                            var newdatestring = \"'\" + newdate + \"'\";\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, newdatestring);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:zing\") {\n                            var number = parameters[0];\n                            if( number < 0 ) {\n                                number = 0;\n                            }\n\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, number);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:oizp\") {\n                            var number = parameters[0];\n                            var output = 1;\n                            if( number < 0 ) {\n                                output = 0;\n                            }\n\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, output);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:count\") {\n                            var variableName = parameters[0];\n                            var variableObject = variablesHash[variableName];\n                            var count = 0;\n                            if(variableObject)\n                            {\n                                if(variableObject.hasValue){\n                                    if(variableObject.allValues)\n                                    {\n                                        count = variableObject.allValues.length;\n                                    } else {\n                                        //If there is a value found for the variable, the count is 1 even if there is no list of alternate values\n                                        //This happens for variables of \"DATAELEMENT_CURRENT_STAGE\" and \"TEI_ATTRIBUTE\"\n                                        count = 1;\n                                    }\n                                }\n                            }\n                            else\n                            {\n                                $log.warn(\"could not find variable to count: \" + variableName);\n                            }\n\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, count);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:countIfZeroPos\") {\n                            var variableName = $filter('trimvariablequalifiers') (parameters[0]);\n                            var variableObject = variablesHash[variableName];\n\n                            var count = 0;\n                            if(variableObject)\n                            {\n                                if( variableObject.hasValue ) {\n                                    if(variableObject.allValues && variableObject.allValues.length > 0)\n                                    {\n                                        for(var i = 0; i < variableObject.allValues.length; i++)\n                                        {\n                                            if(variableObject.allValues[i] >= 0) {\n                                                count++;\n                                            }\n                                        }\n                                    }\n                                    else {\n                                        //The variable has a value, but no list of alternates. This means we only compare the elements real value\n                                        if(variableObject.variableValue >= 0) {\n                                            count = 1;\n                                        }\n                                    }\n                                }\n                            }\n                            else\n                            {\n                                $log.warn(\"could not find variable to countifzeropos: \" + variableName);\n                            }\n\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, count);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:countIfValue\") {\n                            var variableName = parameters[0];\n                            var variableObject = variablesHash[variableName];\n\n                            var valueToCompare = VariableService.processValue(parameters[1],variableObject.variableType);\n\n                            var count = 0;\n                            if(variableObject)\n                            {\n                                if( variableObject.hasValue )\n                                {\n                                    if( variableObject.allValues )\n                                    {\n                                        for(var i = 0; i < variableObject.allValues.length; i++)\n                                        {\n                                            if(valueToCompare === variableObject.allValues[i]) {\n                                                count++;\n                                            }\n                                        }\n                                    } else {\n                                        //The variable has a value, but no list of alternates. This means we compare the standard variablevalue\n                                        if(valueToCompare === variableObject.variableValue) {\n                                            count = 1;\n                                        }\n                                    }\n\n                                }\n                            }\n                            else\n                            {\n                                $log.warn(\"could not find variable to countifvalue: \" + variableName);\n                            }\n\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, count);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:ceil\") {\n                            var ceiled = Math.ceil(parameters[0]);\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, ceiled);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:round\") {\n                            var rounded = Math.round(parameters[0]);\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, rounded);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:hasValue\") {\n                            var variableName = parameters[0];\n                            var variableObject = variablesHash[variableName];\n                            var valueFound = false;\n                            if(variableObject)\n                            {\n                                if(variableObject.hasValue){\n                                    valueFound = true;\n                                }\n                            }\n                            else\n                            {\n                                $log.warn(\"could not find variable to check if has value: \" + variableName);\n                            }\n\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, valueFound);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:lastEventDate\") {\n                            var variableName = parameters[0];\n                            var variableObject = variablesHash[variableName];\n                            var valueFound = \"''\";\n                            if(variableObject)\n                            {\n                                if(variableObject.variableEventDate){\n                                    valueFound = VariableService.processValue(variableObject.variableEventDate, 'DATE');\n                                }\n                                else {\n                                    $log.warn(\"no last event date found for variable: \" + variableName);\n                                }\n                            }\n                            else\n                            {\n                                $log.warn(\"could not find variable to check last event date: \" + variableName);\n                            }\n\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, valueFound);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:validatePattern\") {\n                            var inputToValidate = parameters[0].toString();\n                            var pattern = parameters[1];\n                            var regEx = new RegExp(pattern,'g');\n                            var match = inputToValidate.match(regEx);\n                            \n                            var matchFound = false;\n                            if(match !== null && inputToValidate === match[0]) {\n                                matchFound = true;\n                            }\n\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, matchFound);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:addControlDigits\") {\n\n                            var baseNumber = parameters[0];\n                            var baseDigits = baseNumber.split('');\n                            var error = false;\n\n                            var firstDigit = 0;\n                            var secondDigit = 0;\n\n                            if(baseDigits && baseDigits.length < 10 ) {\n                                var firstSum = 0;\n                                var baseNumberLength = baseDigits.length;\n                                //weights support up to 9 base digits:\n                                var firstWeights = [3,7,6,1,8,9,4,5,2];\n                                for(var i = 0; i < baseNumberLength && !error; i++) {\n                                    firstSum += parseInt(baseDigits[i]) * firstWeights[i];\n                                }\n                                firstDigit = firstSum % 11;\n\n                                //Push the first digit to the array before continuing, as the second digit is a result of the\n                                //base digits and the first control digit.\n                                baseDigits.push(firstDigit);\n                                //Weights support up to 9 base digits plus first control digit:\n                                var secondWeights = [5,4,3,2,7,6,5,4,3,2];\n                                var secondSum = 0;\n                                for(var i = 0; i < baseNumberLength + 1 && !error; i++) {\n                                    secondSum += parseInt(baseDigits[i]) * secondWeights[i];\n                                }\n                                secondDigit = secondSum % 11;\n\n                                if(firstDigit === 10) {\n                                    $log.warn(\"First control digit became 10, replacing with 0\");\n                                    firstDigit = 0;\n                                }\n                                if(secondDigit === 10) {\n                                    $log.warn(\"Second control digit became 10, replacing with 0\");\n                                    secondDigit = 0;\n                                }\n                            }\n                            else\n                            {\n                                $log.warn(\"Base nuber not well formed(\" + baseNumberLength + \" digits): \" + baseNumber);\n                            }\n\n                            if(!error) {\n                                //Replace the end evaluation of the dhis function:\n                                expression = expression.replace(callToThisFunction, baseNumber + firstDigit + secondDigit);\n                                expressionUpdated = true;\n                            }\n                            else\n                            {\n                                //Replace the end evaluation of the dhis function:\n                                expression = expression.replace(callToThisFunction, baseNumber);\n                                expressionUpdated = true;\n                            }\n                        }\n                        else if(dhisFunction.name === \"d2:checkControlDigits\") {\n                            $log.warn(\"checkControlDigits not implemented yet\");\n\n                            //Replace the end evaluation of the dhis function:\n                            expression = expression.replace(callToThisFunction, parameters[0]);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:left\") {\n                            var string = String(parameters[0]);\n                            var numChars = string.length < parameters[1] ? string.length : parameters[1];\n                            var returnString =  string.substring(0,numChars);\n                            returnString = VariableService.processValue(returnString, 'TEXT');\n                            expression = expression.replace(callToThisFunction, returnString);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:right\") {\n                            var string = String(parameters[0]);\n                            var numChars = string.length < parameters[1] ? string.length : parameters[1];\n                            var returnString =  string.substring(string.length - numChars, string.length);\n                            returnString = VariableService.processValue(returnString, 'TEXT');\n                            expression = expression.replace(callToThisFunction, returnString);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:substring\") {\n                            var string = String(parameters[0]);\n                            var startChar = string.length < parameters[1] - 1 ? -1 : parameters[1];\n                            var endChar = string.length < parameters[2] ? -1 : parameters[2];\n                            if(startChar < 0 || endChar < 0) {\n                                expression = expression.replace(callToThisFunction, \"''\");\n                                expressionUpdated = true;\n                            } else {\n                                var returnString =  string.substring(startChar, endChar);\n                                returnString = VariableService.processValue(returnString, 'TEXT');\n                                expression = expression.replace(callToThisFunction, returnString);\n                                expressionUpdated = true;\n                            }\n                        }\n                        else if(dhisFunction.name === \"d2:split\") {\n                            var string = String(parameters[0]);\n                            var splitArray = string.split(parameters[1]);\n                            var returnPart = \"\";\n                            if (splitArray.length >= parameters[2]) {\n                                returnPart = splitArray[parameters[2]];\n                            }\n                            returnPart = VariableService.processValue(returnPart, 'TEXT');\n                            expression = expression.replace(callToThisFunction, returnPart);\n                            expressionUpdated = true;\n                        }\n                        else if(dhisFunction.name === \"d2:length\") {\n                            expression = expression.replace(callToThisFunction, String(parameters[0]).length);\n                            expressionUpdated = true;\n                        }\n                    });\n                });\n\n                //We only want to continue looping until we made a successful replacement,\n                //and there is still occurrences of \"d2:\" in the code. In cases where d2: occur outside\n                //the expected d2: function calls, one unneccesary iteration will be done and the\n                //successfulExecution will be false coming back here, ending the loop. The last iteration\n                //should be zero to marginal performancewise.\n                if(expressionUpdated && expression.indexOf(\"d2:\") !== -1) {\n                    continueLooping = true;\n                } else {\n                    continueLooping = false;\n                }\n            }\n        }\n\n        return expression;\n    };\n\n    var runExpression = function(expression, beforereplacement, identifier, flag, variablesHash ){\n        //determine if expression is true, and actions should be effectuated\n        //If DEBUG mode, use try catch and report errors. If not, omit the heavy try-catch loop.:\n        var answer = false;\n        if(flag && flag.debug) {\n            try{\n\n                var dhisfunctionsevaluated = runDhisFunctions(expression, variablesHash, flag);\n                answer = eval(dhisfunctionsevaluated);\n\n                if(flag.verbose)\n                {\n                    $log.info(\"Expression with id \" + identifier + \" was successfully run. Original condition was: \" + beforereplacement + \" - Evaluation ended up as:\" + expression + \" - Result of evaluation was:\" + answer);\n                }\n            }\n            catch(e)\n            {\n                $log.warn(\"Expression with id \" + identifier + \" could not be run. Original condition was: \" + beforereplacement + \" - Evaluation ended up as:\" + expression + \" - error message:\" + e);\n            }\n        }\n        else {\n            //Just run the expression. This is much faster than the debug route: http://jsperf.com/try-catch-block-loop-performance-comparison\n            var dhisfunctionsevaluated = runDhisFunctions(expression, variablesHash, flag);\n            answer = eval(dhisfunctionsevaluated);\n        }\n        return answer;\n    };\n\n    var determineValueType = function(value) {\n        var valueType = 'TEXT';\n        if(value === 'true' || value === 'false') {\n            valueType = 'BOOLEAN';\n        }\n        else if(angular.isNumber(value) || !isNaN(value)) {\n            if(value % 1 !== 0) {\n                valueType = 'NUMBER';\n            }\n            else {\n                valueType = 'INTEGER';\n            }\n        }\n        return valueType;\n    };\n\n    var performCreateEventAction = function(effect, selectedEntity, selectedEnrollment, currentEvents,executingEvent, programStage){\n        var valArray = [];\n        if(effect.data) {\n            valArray = effect.data.split(',');\n            var newEventDataValues = [];\n            var idList = {active:false};\n\n            angular.forEach(valArray, function(value) {\n                var valParts = value.split(':');                \n                if(valParts && valParts.length >= 1) {\n                    var valId = valParts[0];\n\n                    //Check wether one or more fields is marked as the id to use for comparison purposes:\n                    if(valId.trim().substring(0, 4) === \"[id]\") {\n                        valId = valId.substring(4,valId.length);\n                        idList[valId] = true;\n                        idList.active = true;\n                    }\n\n                    var valVal = \"\";\n                    if(valParts.length > 1) {\n                        valVal = valParts[1];\n                    }\n                    var valueType = determineValueType(valVal);\n\n                    var processedValue = VariableService.processValue(valVal, valueType);\n                    processedValue = $filter('trimquotes')(processedValue);\n                    newEventDataValues.push({dataElement:valId,value:processedValue});\n                    newEventDataValues[valId] = processedValue;\n                }\n            });\n\n            var valuesAlreadyExists = false;\n            angular.forEach(currentEvents, function(currentEvent) {\n                var misMatch = false;\n                angular.forEach(newEventDataValues, function(value) {\n                    var valueFound = false;\n                    angular.forEach(currentEvent.dataValues, function(currentDataValue) {\n                        //Only count as mismatch if there is no particular ID to use, or the current field is part of the same ID\n                        if(!idList.active || idList[currentDataValue.dataElement]){\n                            if(currentDataValue.dataElement === value.dataElement) {\n                                valueFound = true;\n                                //Truthy comparison is needed to avoid false negatives for differing variable types:\n                                if( currentDataValue.value != newEventDataValues[value.dataElement] ) {\n                                    misMatch = true;\n                                }\n                            }\n                        }\n                    });\n                    //Also treat no value found as a mismatch, but when ID fields is set, only concider ID fields\n                    if((!idList.active || idList[value.dataElement] ) && !valueFound) {\n                        misMatch = true;\n                    }\n                });\n                if(!misMatch) {\n                    //if no mismatches on this point, the exact same event already exists, and we dont create it.\n                    valuesAlreadyExists = true;\n                }\n            });\n\n            if(!valuesAlreadyExists) {\n                var eventDate = DateUtils.getToday();\n                var dueDate = DateUtils.getToday();\n\n                var newEvent = {\n                    trackedEntityInstance: selectedEnrollment.trackedEntityInstance,\n                    program: selectedEnrollment.program,\n                    programStage: effect.programStage.id,\n                    enrollment: selectedEnrollment.enrollment,\n                    orgUnit: selectedEnrollment.orgUnit,\n                    dueDate: dueDate,\n                    eventDate: eventDate,\n                    notes: [],\n                    dataValues: newEventDataValues,\n                    status: 'ACTIVE',\n                    event: dhis2.util.uid()\n                };\n\n                if(programStage && programStage.dontPersistOnCreate){\n                    newEvent.notPersisted = true;\n                    newEvent.executingEvent = executingEvent;\n                    $rootScope.$broadcast(\"eventcreated\", { event:newEvent });\n                }\n                else{\n                    DHIS2EventFactory.create(newEvent).then(function(result){\n                       $rootScope.$broadcast(\"eventcreated\", { event:newEvent });\n                    }); \n                }\n                //1 event created\n                return 1;\n            }\n            else\n            {\n                //no events created\n                return 0;\n            }\n        } else {\n            $log.warn(\"Cannot create event with empty content.\");\n        }\n    };\n    \n    var internalExecuteRules = function(allProgramRules, executingEvent, evs, allDataElements, selectedEntity, selectedEnrollment, optionSets, flag) {\n        if(allProgramRules) {\n            var variablesHash = {};\n\n            //Concatenate rules produced by indicator definitions into the other rules:\n            var rules = $filter('filter')(allProgramRules.programRules, {programStageId: null});\n\n            if(executingEvent && executingEvent.programStage){\n                if(!rules) {\n                    rules = [];\n                }\n                rules = rules.concat($filter('filter')(allProgramRules.programRules, {programStageId: executingEvent.programStage}));\n            }\n            if(!rules) {\n                rules = [];\n            }\n            rules = rules.concat(allProgramRules.programIndicators.rules);\n\n            //Run rules in priority - lowest number first(priority null is last)\n            rules = orderByFilter(rules, 'priority');\n\n            variablesHash = VariableService.getVariables(allProgramRules, executingEvent, evs, allDataElements, selectedEntity, selectedEnrollment, optionSets);\n\n            if(angular.isObject(rules) && angular.isArray(rules)){\n                //The program has rules, and we want to run them.\n                //Prepare repository unless it is already prepared:\n                if(angular.isUndefined( $rootScope.ruleeffects ) ) {\n                    $rootScope.ruleeffects = {};\n                }\n\n                var ruleEffectKey = executingEvent.event ? executingEvent.event : executingEvent;\n                if( executingEvent.event && angular.isUndefined( $rootScope.ruleeffects[ruleEffectKey] )){\n                    $rootScope.ruleeffects[ruleEffectKey] = {};\n                }\n\n                if(!angular.isObject(executingEvent) && angular.isUndefined( $rootScope.ruleeffects[ruleEffectKey] )){\n                    $rootScope.ruleeffects[ruleEffectKey] = {};\n                }\n\n                var updatedEffectsExits = false;\n                var eventsCreated = 0;\n\n                angular.forEach(rules, function(rule) {\n                    var ruleEffective = false;\n\n                    var expression = rule.condition;\n                    //Go through and populate variables with actual values, but only if there actually is any replacements to be made(one or more \"$\" is present)\n                    if(expression) {\n                        if(expression.indexOf('{') !== -1) {\n                            expression = replaceVariables(expression, variablesHash);\n                        }\n                        \n                        //run expression:\n                        if( runExpression(expression, rule.condition, \"rule:\" + rule.id, flag, variablesHash) ){\n                            ruleEffective = true;\n                        }\n                    } else {\n                        $log.warn(\"Rule id:'\" + rule.id + \"'' and name:'\" + rule.name + \"' had no condition specified. Please check rule configuration.\");\n                    }\n\n                    angular.forEach(rule.programRuleActions, function(action){\n                        //In case the effect-hash is not populated, add entries\n                        if(angular.isUndefined( $rootScope.ruleeffects[ruleEffectKey][action.id] )){\n                            $rootScope.ruleeffects[ruleEffectKey][action.id] =  {\n                                id:action.id,\n                                location:action.location,\n                                action:action.programRuleActionType,\n                                dataElement:action.dataElement,\n                                trackedEntityAttribute:action.trackedEntityAttribute,\n                                programStage: action.programStage,\n                                programIndicator: action.programIndicator,\n                                programStageSection: action.programStageSection && action.programStageSection.id ? action.programStageSection.id : null,\n                                content:action.content,\n                                data:action.data,\n                                ineffect:undefined\n                            };\n                        }\n\n                        //In case the rule is effective and contains specific data,\n                        //the effect be refreshed from the variables list.\n                        //If the rule is not effective we can skip this step\n                        if(ruleEffective && action.data)\n                        {\n                            //Preserve old data for comparison:\n                            var oldData = $rootScope.ruleeffects[ruleEffectKey][action.id].data;\n\n                            //The key data might be containing a dollar sign denoting that the key data is a variable.\n                            //To make a lookup in variables hash, we must make a lookup without the dollar sign in the variable name\n                            //The first strategy is to make a direct lookup. In case the \"data\" expression is more complex, we have to do more replacement and evaluation.\n\n                            var nameWithoutBrackets = action.data.replace('#{','').replace('}','');\n                            if(angular.isDefined(variablesHash[nameWithoutBrackets]))\n                            {\n                                //The variable exists, and is replaced with its corresponding value\n                                $rootScope.ruleeffects[ruleEffectKey][action.id].data =\n                                    variablesHash[nameWithoutBrackets].variableValue;\n                            }\n                            else if(action.data.indexOf('{') !== -1 || action.data.indexOf('d2:') !== -1)\n                            {\n                                //Since the value couldnt be looked up directly, and contains a curly brace or a dhis function call,\n                                //the expression was more complex than replacing a single variable value.\n                                //Now we will have to make a thorough replacement and separate evaluation to find the correct value:\n                                $rootScope.ruleeffects[ruleEffectKey][action.id].data = replaceVariables(action.data, variablesHash);\n                                //In a scenario where the data contains a complex expression, evaluate the expression to compile(calculate) the result:\n                                $rootScope.ruleeffects[ruleEffectKey][action.id].data = runExpression($rootScope.ruleeffects[ruleEffectKey][action.id].data, action.data, \"action:\" + action.id, flag, variablesHash);\n                            }\n\n                            if(oldData !== $rootScope.ruleeffects[ruleEffectKey][action.id].data) {\n                                updatedEffectsExits = true;\n                            }\n                        }\n\n                        //Update the rule effectiveness if it changed in this evaluation;\n                        if($rootScope.ruleeffects[ruleEffectKey][action.id].ineffect !== ruleEffective)\n                        {\n                            //There is a change in the rule outcome, we need to update the effect object.\n                            updatedEffectsExits = true;\n                            $rootScope.ruleeffects[ruleEffectKey][action.id].ineffect = ruleEffective;\n                        }\n\n                        //In case the rule is of type CREATEEVENT, run event creation:\n                        if($rootScope.ruleeffects[ruleEffectKey][action.id].action === \"CREATEEVENT\" && $rootScope.ruleeffects[ruleEffectKey][action.id].ineffect){\n                            if(evs && evs.byStage){\n                                if($rootScope.ruleeffects[ruleEffectKey][action.id].programStage) {\n                                    var createdNow = performCreateEventAction($rootScope.ruleeffects[ruleEffectKey][action.id], selectedEntity, selectedEnrollment, evs.byStage[$rootScope.ruleeffects[ruleEffectKey][action.id].programStage.id]);\n                                    eventsCreated += createdNow;\n                                } else {\n                                    $log.warn(\"No programstage defined for CREATEEVENT action: \" + action.id);\n                                }\n                            } else {\n                                $log.warn(\"Events to evaluate for CREATEEVENT action: \" + action.id + \". Could it have been triggered at the wrong time or during registration?\");\n                            }\n                        }\n                        //In case the rule is of type \"assign variable\" and the rule is effective,\n                        //the variable data result needs to be applied to the correct variable:\n                        else if($rootScope.ruleeffects[ruleEffectKey][action.id].action === \"ASSIGN\" && $rootScope.ruleeffects[ruleEffectKey][action.id].ineffect){\n                            //from earlier evaluation, the data portion of the ruleeffect now contains the value of the variable to be assigned.\n                            //the content portion of the ruleeffect defines the name for the variable, when the qualidisers are removed:\n                            var variabletoassign = $rootScope.ruleeffects[ruleEffectKey][action.id].content ?\n                                $rootScope.ruleeffects[ruleEffectKey][action.id].content.replace(\"#{\",\"\").replace(\"A{\",\"\").replace(\"}\",\"\") : null;\n\n                            if(variabletoassign && !angular.isDefined(variablesHash[variabletoassign])){\n                                //If a variable is mentioned in the content of the rule, but does not exist in the variables hash, show a warning:\n                                $log.warn(\"Variable \" + variabletoassign + \" was not defined.\");\n                            }\n\n                            if(variablesHash[variabletoassign]){\n                                var updatedValue = $rootScope.ruleeffects[ruleEffectKey][action.id].data;\n                                \n                                var valueType = determineValueType(updatedValue);\n                                \n                                if($rootScope.ruleeffects[ruleEffectKey][action.id].dataElement) {\n                                    updatedValue = VariableService.getDataElementValueOrCodeForValue(variablesHash[variabletoassign].useCodeForOptionSet, updatedValue, $rootScope.ruleeffects[ruleEffectKey][action.id].dataElement.id, allDataElements, optionSets);\n                                }\n                                updatedValue = VariableService.processValue(updatedValue, valueType);\n\n                                variablesHash[variabletoassign] = {\n                                    variableValue:updatedValue,\n                                    variableType:valueType,\n                                    hasValue:true,\n                                    variableEventDate:'',\n                                    variablePrefix:variablesHash[variabletoassign].variablePrefix ? variablesHash[variabletoassign].variablePrefix : '#',\n                                    allValues:[updatedValue]\n                                };\n                                \n                                if(variablesHash[variabletoassign].variableValue !== updatedValue) {\n                                    //If the variable was actually updated, we assume that there is an updated ruleeffect somewhere:\n                                    updatedEffectsExits = true;\n                                }\n                            }\n                        }\n                    });\n                });\n\n                //Broadcast rules finished if there was any actual changes to the event.\n                if(updatedEffectsExits){\n                    $rootScope.$broadcast(\"ruleeffectsupdated\", { event: ruleEffectKey, callerId:flag.callerId, eventsCreated:eventsCreated });\n                }\n            }\n\n            return true;\n        }\n    };\n    \n    var internalProcessEventGrid = function( eventGrid ){\n    \tvar events = [];\n    \tif( eventGrid && eventGrid.rows && eventGrid.headers ){    \t\t\n    \t\tangular.forEach(eventGrid.rows, function(row) {\n    \t\t\tvar ev = {};\n    \t\t\tvar i = 0;\n        \t\tangular.forEach(eventGrid.headers, function(h){\n        \t\t\tev[h] = row[i];\n        \t\t\ti++;\n        \t\t});                            \n            });\n    \t}\n    \treturn events;\n    };\n\n    var internalGetOrLoadScope = function(currentEvent,programStageId,orgUnitId) {        \n        if(crossEventRulesExist) {\n            //If crossEventRulesExist, we need to get a scope that contains more than the current event.\n            if(lastEventId !== currentEvent.event \n                    || lastEventDate !== currentEvent.eventDate \n                    || !eventScopeExceptCurrent) {\n                //The scope might need updates, as the parameters of the event has changed\n\n                lastEventId = currentEvent.event;\n                lastEventDate = currentEvent.eventDate;\n\n                \n                var pager = {pageSize: NUMBER_OF_EVENTS_IN_SCOPE};                \n                var ordering = {id:\"eventDate\",direction:\"desc\"};\n                \n                return DHIS2EventFactory.getByStage(orgUnitId, programStageId, null, pager, true, null, null, ordering).then(function(events) {                \t\n                \tvar allEventsWithPossibleDuplicates = internalProcessEventGrid( events );                \t\n                    var filterUrl = '&dueDateStart=' + DateUtils.formatFromUserToApi(lastEventDate) + '&dueDateEnd=' + DateUtils.formatFromUserToApi(lastEventDate); \n                    return DHIS2EventFactory.getByStage(orgUnitId, programStageId, null, pager, true, null, filterUrl, ordering).then(function(events) {\n                    \tallEventsWithPossibleDuplicates = allEventsWithPossibleDuplicates.concat( internalProcessEventGrid( events ) );\n                        eventScopeExceptCurrent = [];\n                        var eventIdDictionary = {};\n                        angular.forEach(allEventsWithPossibleDuplicates, function(eventInScope) {\n                            if(currentEvent.event !== eventInScope.event \n                                    && !eventIdDictionary[eventInScope.event]) {\n                                //Add event and update dictionary to avoid duplicates:                                \n                                eventIdDictionary[eventInScope.event] = true;\n                            }\n                        });\n\n                        //make a sorted list of all events to pass to rules execution service:\n                        var allEventsInScope = eventScopeExceptCurrent.concat([currentEvent]);\n                        allEventsInScope = orderByFilter(allEventsInScope, '-eventDate').reverse();\n                        var byStage = {};\n                        byStage[currentEvent.programStage] = allEventsInScope;\n                        return {all: allEventsInScope, byStage:byStage};\n                    });\n                });   \n            }\n            else\n            {\n                //make a sorted list of all events to pass to rules execution service:\n                var allEvents = eventScopeExceptCurrent.concat([currentEvent]);\n                allEvents = orderByFilter(allEvents, '-eventDate').reverse();\n                var byStage = {};\n                byStage[currentEvent.programStage] = allEvents;\n                return $q.when({all: allEvents, byStage:byStage});\n            }\n        }\n        else\n        {\n            //return a scope containing only the current event\n            var byStage = {};\n            byStage[currentEvent.programStage] = [currentEvent];\n            return $q.when({all: [currentEvent], byStage:byStage});\n        }\n    };\n    var internalGetOrLoadRules = function(programId) {\n        //If no rules is stored in memory, or this service is being called in the context of a different program, get the rules again:\n        if(allProgramRules === false || lastProgramId !== programId)\n        {\n            return RulesFactory.loadRules(programId).then(function(rules){                    \n                allProgramRules = rules;\n                lastProgramId = programId;\n\n                //Check if any of the rules is using any source type thar requires a bigger event scope\n                crossEventRulesExist = false;\n                if(rules.programVariables && rules.programVariables.length) {\n                    for(var i = 0; i < rules.programVariables.length; i ++) {\n                        if( rules.programVariables[i].programRuleVariableSourceType ===\n                                \"DATAELEMENT_NEWEST_EVENT_PROGRAM\" ||\n                            rules.programVariables[i].programRuleVariableSourceType ===\n                                \"DATAELEMENT_NEWEST_EVENT_PROGRAM_STAGE\" ||\n                            rules.programVariables[i].programRuleVariableSourceType ===\n                                \"DATAELEMENT_PREVIOUS_EVENT\")\n                        {\n                            crossEventRulesExist = true;\n                        }\n                    }\n                }\n\n                return rules;\n            });  \n        }\n        else\n        {\n            return $q.when(allProgramRules);\n        }\n    };\n    return {\n        executeRules: function(allProgramRules, executingEvent, evs, allDataElements, selectedEntity, selectedEnrollment, optionSets, flags) {\n            internalExecuteRules(allProgramRules, executingEvent, evs, allDataElements, selectedEntity, selectedEnrollment, optionSets, flags);\n        },\n        loadAndExecuteRulesScope: function(currentEvent, programId, programStageId, programStageDataElements, optionSets, orgUnitId, flags){\n            internalGetOrLoadRules(programId).then(function(rules) {\n                internalGetOrLoadScope(currentEvent,programStageId,orgUnitId).then(function(scope) {\n                    internalExecuteRules(rules, currentEvent, scope, programStageDataElements, null, null, optionSets, flags);\n                });\n            });\n        },\n        processRuleEffectsForTrackedEntityAttributes: function(context, currentTei, teiOriginalValues, attributesById, optionSets ) {\n            var hiddenFields = {};\n            var assignedFields = {};\n            var hiddenSections = {};\n            var warningMessages = [];\n            \n            angular.forEach($rootScope.ruleeffects[context], function (effect) {\n                if (effect.ineffect) {\n                    if (effect.action === \"HIDEFIELD\" && effect.trackedEntityAttribute) {\n                        if (currentTei[effect.trackedEntityAttribute.id]) {\n                            //If a field is going to be hidden, but contains a value, we need to take action;\n                            if (effect.content) {\n                                //TODO: Alerts is going to be replaced with a proper display mecanism.\n                                alert(effect.content);\n                            }\n                            else {\n                                //TODO: Alerts is going to be replaced with a proper display mecanism.\n                                alert(attributesById[effect.trackedEntityAttribute.id].displayName + \" was blanked out and hidden by your last action\");\n                            }\n\n                            //Blank out the value:\n                            currentTei[effect.trackedEntityAttribute.id] = \"\";\n                        }\n\n                        hiddenFields[effect.trackedEntityAttribute.id] = true;\n                    } else if (effect.action === \"SHOWERROR\" && effect.trackedEntityAttribute) {\n                        if(effect.ineffect) {\n                            var headerText =  $translate.instant('validation_error');\n                            var bodyText = effect.content + (effect.data ? effect.data : \"\");\n\n                            NotificationService.showNotifcationDialog(headerText, bodyText);\n                            if( effect.trackedEntityAttribute ) {\n                                currentTei[effect.trackedEntityAttribute.id] = teiOriginalValues[effect.trackedEntityAttribute.id];\n                            }\n                        }\n                    } else if (effect.action === \"SHOWWARNING\" && effect.trackedEntityAttribute) {\n                        if(effect.ineffect) {\n                            var message = effect.content + (angular.isDefined(effect.data) ? effect.data : \"\");\n                            warningMessages.push(message);\n\n                            if( effect.trackedEntityAttribute ) {\n                                warningMessages[effect.trackedEntityAttribute.id] = message;\n                            }\n                        }\n                    }\n                    else if (effect.action === \"ASSIGN\" && effect.trackedEntityAttribute) {\n                        var processedValue = $filter('trimquotes')(effect.data);\n\n                        if(attributesById[effect.trackedEntityAttribute.id]\n                                && attributesById[effect.trackedEntityAttribute.id].optionSet) {\n                            processedValue = OptionSetService.getName(\n                                    optionSets[attributesById[effect.trackedEntityAttribute.id].optionSet.id].options, processedValue)\n                        }\n\n                        processedValue = processedValue === \"true\" ? true : processedValue;\n                        processedValue = processedValue === \"false\" ? false : processedValue;\n\n                        //For \"ASSIGN\" actions where we have a dataelement, we save the calculated value to the dataelement:\n                        currentTei[effect.trackedEntityAttribute.id] = processedValue;\n                        assignedFields[effect.trackedEntityAttribute.id] = true;\n                    }\n                }\n            });\n            return {currentTei: currentTei, hiddenFields: hiddenFields, hiddenSections: hiddenSections, warningMessages: warningMessages, assignedFields: assignedFields};\n        },\n        processRuleEffectsForEvent: function(eventId, currentEvent, currentEventOriginalValues, prStDes, optionSets ) {\n            var hiddenFields = {};\n            var assignedFields = {};\n            var hiddenSections = {};\n            var warningMessages = [];\n            \n            angular.forEach($rootScope.ruleeffects[eventId], function (effect) {\n                if (effect.ineffect) {\n                    if (effect.action === \"HIDEFIELD\" && effect.dataElement) {\n                        if(currentEvent[effect.dataElement.id]) {\n                            //If a field is going to be hidden, but contains a value, we need to take action;\n                            if(effect.content) {\n                                //TODO: Alerts is going to be replaced with a proper display mecanism.\n                                alert(effect.content);\n                            }\n                            else {\n                                //TODO: Alerts is going to be replaced with a proper display mecanism.\n                                alert(prStDes[effect.dataElement.id].dataElement.formName + \"Was blanked out and hidden by your last action\");\n                            }\n\n                        }\n                        \n                        hiddenFields[effect.dataElement.id] = true;\n                    }\n                    else if(effect.action === \"HIDESECTION\") {\n                        if(effect.programStageSection){\n                            hiddenSections[effect.programStageSection] = effect.programStageSection;\n                        }\n                    }\n                    else if(effect.action === \"SHOWERROR\" && effect.dataElement.id){\n                        var headerTxt =  $translate.instant('validation_error');\n                        var bodyTxt = effect.content + (effect.data ? effect.data : \"\");\n                        NotificationService.showNotifcationDialog(headerTxt, bodyTxt);\n\n                        currentEvent[effect.dataElement.id] = currentEventOriginalValues[effect.dataElement.id];\n                    }\n                    else if(effect.action === \"SHOWWARNING\"){\n                        warningMessages.push(effect.content + (effect.data ? effect.data : \"\"));\n                    }\n                    else if (effect.action === \"ASSIGN\" && effect.dataElement) {\n                        var processedValue = $filter('trimquotes')(effect.data);\n\n                        if(prStDes[effect.dataElement.id] \n                                && prStDes[effect.dataElement.id].dataElement.optionSet) {\n                            processedValue = OptionSetService.getName(\n                                    optionSets[prStDes[effect.dataElement.id].dataElement.optionSet.id].options, processedValue)\n                        }\n\n                        processedValue = processedValue === \"true\" ? true : processedValue;\n                        processedValue = processedValue === \"false\" ? false : processedValue;\n\n                        currentEvent[effect.dataElement.id] = processedValue;\n                        assignedFields[effect.dataElement.id] = true;\n                    }\n                }\n            });\n        \n            return {currentEvent: currentEvent, hiddenFields: hiddenFields, hiddenSections: hiddenSections, warningMessages: warningMessages, assignedFields: assignedFields};\n        },\n        processRuleEffectAttribute: function(context, selectedTei, tei, currentEvent, currentEventOriginialValue, affectedEvent, attributesById, prStDes, hiddenFields, hiddenSections, warningMessages, assignedFields, optionSets){\n            //Function used from registration controller to process effects for the tracked entity instance and for the events in the same operation\n            var teiAttributesEffects = this.processRuleEffectsForTrackedEntityAttributes(context, selectedTei, tei, attributesById, optionSets );\n            teiAttributesEffects.selectedTei = teiAttributesEffects.currentTei;\n            \n            if(context === \"SINGLE_EVENT\" && currentEvent && prStDes ) {\n                var eventEffects = this.processRuleEffectsForEvent(\"SINGLE_EVENT\", currentEvent, currentEventOriginialValue, prStDes, optionSets);\n                teiAttributesEffects.warningMessages = angular.extend(teiAttributesEffects.warningMessages,eventEffects.warningMessages);\n                teiAttributesEffects.hiddenFields = angular.extend(teiAttributesEffects.hiddenFields,eventEffects.hiddenFields);\n                teiAttributesEffects.hiddenSections = angular.extend(teiAttributesEffects.hiddenSections,eventEffects.hiddenSections);\n                teiAttributesEffects.assignedFields = angular.extend(teiAttributesEffects.assignedFields,eventEffects.assignedFields);\n                teiAttributesEffects.currentEvent = eventEffects.currentEvent;\n            }\n            \n            return teiAttributesEffects;\n        }\n    };\n})\n\n/* service for dealing with events */\n.service('DHIS2EventService', function(DateUtils){\n    return {\n        //for simplicity of grid display, events were changed from\n        //event.datavalues = [{dataElement: dataElement, value: value}] to\n        //event[dataElement] = value\n        //now they are changed back for the purpose of storage.\n        reconstructEvent: function(event, programStageDataElements){\n            var e = {};\n\n            e.event         = event.event;\n            e.status        = event.status;\n            e.program       = event.program;\n            e.programStage  = event.programStage;\n            e.orgUnit       = event.orgUnit;\n            e.eventDate     = event.eventDate;\n\n            var dvs = [];\n            angular.forEach(programStageDataElements, function(prStDe){\n                if(event.hasOwnProperty(prStDe.dataElement.id)){\n                    dvs.push({dataElement: prStDe.dataElement.id, value: event[prStDe.dataElement.id]});\n                }\n            });\n\n            e.dataValues = dvs;\n\n            if(event.coordinate){\n                e.coordinate = {latitude: event.coordinate.latitude ? event.coordinate.latitude : '',\n                    longitude: event.coordinate.longitude ? event.coordinate.longitude : ''};\n            }\n\n            return e;\n        },\n        refreshList: function(eventList, currentEvent){\n            if(!eventList || !eventList.length){\n                return;\n            }\n            var continueLoop = true;\n            for(var i=0; i< eventList.length && continueLoop; i++){\n                if(eventList[i].event === currentEvent.event ){\n                    eventList[i] = currentEvent;\n                    continueLoop = false;\n                }\n            }\n            return eventList;\n        },\n        getEventExpiryStatus : function (event, program, selectedOrgUnit) {\n            var completedDate, today, daysAfterCompletion;\n\n            if ((event.orgUnit !== selectedOrgUnit) || ( program.completeEventsExpiryDays === 0) ||\n                !event.status) {\n                return false;\n            }\n\n            completedDate = moment(event.completedDate,'YYYY-MM-DD');\n            today = moment(DateUtils.getToday(),'YYYY-MM-DD');\n            daysAfterCompletion = today.diff(completedDate, 'days');\n            if (daysAfterCompletion < program.completeEventsExpiryDays) {\n                return false;\n            }\n            return true;\n        }\n    };\n})\n\n/* current selections */\n.service('CurrentSelection', function(){\n    this.currentSelection = {};\n    this.relationshipInfo = {};\n    this.optionSets = null;\n    this.attributesById = null;\n    this.ouLevels = null;\n    this.sortedTeiIds = [];\n    this.selectedTeiEvents = null;\n    this.relationshipOwner = {};\n    this.selectedTeiEvents = [];\n    this.fileNames = {};\n    this.orgUnitNames = {};\n    this.location = null;\n    this.advancedSearchOptions = null;\n\tthis.trackedEntities = null;\n\n    this.set = function(currentSelection){\n        this.currentSelection = currentSelection;\n    };\n    this.get = function(){\n        return this.currentSelection;\n    };\n\n    this.setRelationshipInfo = function(relationshipInfo){\n        this.relationshipInfo = relationshipInfo;\n    };\n    this.getRelationshipInfo = function(){\n        return this.relationshipInfo;\n    };\n\n    this.setOptionSets = function(optionSets){\n        this.optionSets = optionSets;\n    };\n    this.getOptionSets = function(){\n        return this.optionSets;\n    };\n\n    this.setAttributesById = function(attributesById){\n        this.attributesById = attributesById;\n    };\n    this.getAttributesById = function(){\n        return this.attributesById;\n    };\n\n    this.setOuLevels = function(ouLevels){\n        this.ouLevels = ouLevels;\n    };\n    this.getOuLevels = function(){\n        return this.ouLevels;\n    };\n\n    this.setSortedTeiIds = function(sortedTeiIds){\n        this.sortedTeiIds = sortedTeiIds;\n    };\n    this.getSortedTeiIds = function(){\n        return this.sortedTeiIds;\n    };\n\n    this.setSelectedTeiEvents = function(selectedTeiEvents){\n        this.selectedTeiEvents = selectedTeiEvents;\n    };\n    this.getSelectedTeiEvents = function(){\n        return this.selectedTeiEvents;\n    };\n\n    this.setRelationshipOwner = function(relationshipOwner){\n        this.relationshipOwner = relationshipOwner;\n    };\n    this.getRelationshipOwner = function(){\n        return this.relationshipOwner;\n    };\n\n    this.setFileNames = function(fileNames){\n        this.fileNames = fileNames;\n    };\n    this.getFileNames = function(){\n        return this.fileNames;\n    };\n    \n    this.setOrgUnitNames = function(orgUnitNames){\n        this.orgUnitNames = orgUnitNames;\n    };\n    this.getOrgUnitNames = function(){\n        return this.orgUnitNames;\n    };\n    \n    this.setLocation = function(location){\n        this.location = location;\n    };\n    this.getLocation = function(){\n        return this.location;\n    };\n    \n    this.setAdvancedSearchOptions = function (searchOptions) {\n        this.advancedSearchOptions = searchOptions;\n    };\n    this.getAdvancedSearchOptions = function () {\n        return this.advancedSearchOptions;\n    };\n\n    this.setTrackedEntities = function (trackedEntities) {\n        this.trackedEntities = trackedEntities;\n    };\n    this.getTrackedEntities = function () {\n        return this.trackedEntities;\n    };\n\n    this.setSortColumn = function (sortColumn) {\n        if (this.advancedSearchOptions) {\n            this.advancedSearchOptions.sortColumn = sortColumn;\n        }\n    };\n\n    this.setColumnReverse = function (reverseSortStatus) {\n        if (this.advancedSearchOptions) {\n            this.advancedSearchOptions.reverse = reverseSortStatus;\n        }\n    };\n\n    this.setGridColumns = function (gridColumns) {\n        if (this.advancedSearchOptions) {\n            this.advancedSearchOptions.gridColumns = gridColumns;\n        }\n    }\n})\n\n.service('AuditHistoryDataService', function( $http, $translate, NotificationService, DHIS2URL ) {\n    this.getAuditHistoryData = function(dataId, dataType ) {\n        var url=\"\";\n        if (dataType === \"attribute\") {\n            url=\"/audits/trackedEntityAttributeValue?tei=\"+dataId+\"&skipPaging=true\";\n            \n        } else {\n            url=\"/audits/trackedEntityDataValue?psi=\"+dataId+\"&skipPaging=true\";\n        }\n\n        var promise = $http.get(DHIS2URL + url).then(function( response ) {\n            return response.data;\n        }, function( response ) {\n            if( response && response.data && response.data.status === 'ERROR' ) {\n                var headerText = response.data.status;\n                var bodyText = response.data.message ? response.data.message : $translate.instant('unable_to_fetch_data_from_server');\n                NotificationService.showNotifcationDialog(headerText, bodyText);\n            }\n        });\n        return promise;\n    }\n})\n\n\n\n/* Factory for fetching OrgUnit */\n.factory('OrgUnitFactory', function($http, DHIS2URL, $q, $window, $translate, SessionStorageService, DateUtils, CurrentSelection) {\n    var orgUnit, orgUnitPromise, rootOrgUnitPromise,orgUnitTreePromise;\n    var indexedDB = $window.indexedDB;\n    var db = null;\n    function openStore(){\n        var deferred = $q.defer();\n        var request = indexedDB.open(\"dhis2ou\");\n\n        request.onsuccess = function(e) {\n            db = e.target.result;\n            deferred.resolve();\n        };\n\n        request.onerror = function(){\n            deferred.reject();\n        };\n\n        return deferred.promise;\n    }\n    return {\n        getChildren: function(uid){\n            if( orgUnit !== uid ){\n                orgUnitPromise = $http.get( DHIS2URL + '/organisationUnits/'+ uid + '.json?fields=id,path,children[id,displayName,level,children[id]]&paging=false' ).then(function(response){\n                    orgUnit = uid;\n                    return response.data;\n                });\n            }\n            return orgUnitPromise;\n        },\n        get: function(uid){\n            if( orgUnit !== uid ){\n                orgUnitPromise = $http.get( DHIS2URL + '/organisationUnits/'+ uid + '.json?fields=id,displayName,level,path' ).then(function(response){\n                    orgUnit = uid;\n                    return response.data;\n                });\n            }\n            return orgUnitPromise;\n        },\n        getViewTreeRoot: function(){\n            var def = $q.defer();            \n            var settings = SessionStorageService.get('USER_PROFILE');            \n            if( settings && settings.organisationUnits ){\n                var ous = {};\n                ous.organisationUnits = settings && settings.dataViewOrganisationUnits && settings.dataViewOrganisationUnits.length > 0 ? settings.dataViewOrganisationUnits : settings && settings.organisationUnits ? settings.organisationUnits : [];                \n                def.resolve( ous );\n            }\n            else{\n                var url = DHIS2URL + '/me.json?fields=organisationUnits[id,displayName,level,path,children[id,displayName,level,children[id]]],dataViewOrganisationUnits[id,displayName,level,path,children[id,displayName,level,children[id]]]&paging=false';\n                $http.get( url ).then(function(response){\n                    response.data.organisationUnits = response.data.dataViewOrganisationUnits && response.data.dataViewOrganisationUnits.length > 0 ? response.data.dataViewOrganisationUnits : response.data.organisationUnits;\n                    delete response.data.dataViewOrganisationUnits;\n                    def.resolve( response.data );\n                });\n            }            \n            return def.promise;\n        },\n        getSearchTreeRoot: function(){\n            var def = $q.defer();            \n            var settings = SessionStorageService.get('USER_PROFILE');            \n            if( settings && settings.organisationUnits ){\n                var ous = {};\n                ous.organisationUnits = settings && settings.teiSearchOrganisationUnits && settings.teiSearchOrganisationUnits.length > 0 ? settings.teiSearchOrganisationUnits : settings && settings.organisationUnits ? settings.organisationUnits : [];\n                def.resolve( ous );\n            }\n            else{\n                var url = DHIS2URL + '/me.json?fields=organisationUnits[id,displayName,level,path,children[id,displayName,level,children[id]]],teiSearchOrganisationUnits[id,displayName,level,path,children[id,displayName,level,children[id]]]&paging=false';\n                $http.get( url ).then(function(response){\n                    response.data.organisationUnits = response.data.teiSearchOrganisationUnits && response.data.teiSearchOrganisationUnits.length > 0 ? response.data.teiSearchOrganisationUnits : response.data.organisationUnits;\n                    delete response.data.teiSearchOrganisationUnits;\n                    def.resolve( response.data );\n                });\n            }            \n            return def.promise;\n        },\n        getOrgUnits: function(uid,fieldUrl){\n            var url = DHIS2URL + '/organisationUnits.json?filter=id:eq:'+uid+'&'+fieldUrl+'&paging=false';\n            orgUnitTreePromise = $http.get(url).then(function(response){\n                return response.data;\n            });\n            return orgUnitTreePromise;\n        },\n        getOrgUnit: function(uid) {\n            var def = $q.defer();\n            var selectedOrgUnit = CurrentSelection.get()[\"orgUnit\"];//SessionStorageService.get('SELECTED_OU');\n            if (selectedOrgUnit && selectedOrgUnit.id === uid ) {\n                def.resolve( selectedOrgUnit );\n            }\n            else if(uid){\n                this.get(uid).then(function (response) {\n                    def.resolve( response ? response : null );\n                });\n            }\n            return def.promise;\n        },\n        getOrgUnitReportDateRange: function(orgUnit) {\n            var reportDateRange = { maxDate: DateUtils.getToday(), minDate: ''};\n            var cdate = orgUnit.cdate ? orgUnit.cdate : orgUnit.closedDate ? DateUtils.getDateFromUTCString(orgUnit.closedDate) : null;\n            var odate = orgUnit.odate ? orgUnit.odate : orgUnit.openingDate ? DateUtils.getDateFromUTCString(orgUnit.openingDate) : null;\n            if (odate) {\n                /*If the orgunit has an opening date, then it is taken as the min-date otherwise the min-date is open*/\n                reportDateRange.minDate = DateUtils.formatFromApiToUser(odate);\n            }\n            if (cdate) {\n                /*If closed date of the org-unit is later than today then today's date is taken as the max-date otherwise\n                * the closed date of the org-unit is taken as the max-date*/\n                if (DateUtils.isBeforeToday(cdate)) {\n                    reportDateRange.maxDate = DateUtils.formatFromApiToUser(cdate);\n                }\n            }\n            return reportDateRange;\n        },\n        getFromStoreOrServer: function(uid){\n            var deferred = $q.defer();\n            var orgUnitFactory = this;\n            if (db === null) {\n                openStore().then(getOu, function () {\n                    deferred.reject(\"DB not opened\");\n                });\n            }\n            else {                \n                getOu();                \n            }\n\n            function getOu() {\n                var tx = db.transaction([\"ou\"]);\n                var store = tx.objectStore(\"ou\");\n                var query = store.get(uid);\n\n                query.onsuccess = function(e){\n                    if(e.target.result){\n                        e.target.result.closedStatus = getOrgUnitClosedStatus(e.target.result);\n                        e.target.result.reportDateRange = orgUnitFactory.getOrgUnitReportDateRange(e.target.result);\n                        e.target.result.id = uid;\n                        e.target.result.displayName = e.target.result.n;\n                        delete(e.target.result.n);\n                        deferred.resolve(e.target.result);\n                    }\n                    else{\n                        var t = db.transaction([\"ouPartial\"]);\n                        var s = t.objectStore(\"ouPartial\");\n                        var q = s.get(uid);\n                        q.onsuccess = function(e){\n                            if( e.target.result ){\n                                e.target.result.closedStatus = getOrgUnitClosedStatus(e.target.result);\n                                e.target.result.reportDateRange = orgUnitFactory.getOrgUnitReportDateRange(e.target.result);\n                                e.target.result.id = uid;\n                                e.target.result.displayName = e.target.result.n;\n                                delete(e.target.result.n);\n                                deferred.resolve(e.target.result);\n                            }\n                            else{\n                                $http.get( DHIS2URL + '/organisationUnits/'+ uid + '.json?fields=id,displayName,closedDate,openingDate' ).then(function(response){\n                                    if( response && response.data ){\n                                        deferred.resolve({\n                                            id: response.data.id,\n                                            displayName: response.data.displayName,\n                                            cdate: response.data.closedDate,\n                                            odate: response.data.openingDate,\n                                            closedStatus: getOrgUnitClosedStatus(response.data),\n                                            reportDateRange: orgUnitFactory.getOrgUnitReportDateRange(response.data)\n                                        });\n                                    }\n                                });\n                            }\n                        };\n                        q.onerror = function(e){                            \n                            deferred.reject();\n                        };\n                    }\n                };\n                query.onerror = function(e){\n                    deferred.reject();\n                };\n            }\n\n\n            function getOrgUnitClosedStatus(ou){\n                var closed = false;\n                if( ou ){\n                    if( ou.cdate ){\n                        closed = DateUtils.isBeforeToday( ou.cdate ) ? true : false;\n                    }\n                    if(!closed && ou.odate ){\n                        closed = DateUtils.isAfterToday( ou.odate ) ? true : false;\n                    }\n                }\n                if(closed) {\n                    setHeaderDelayMessage($translate.instant(\"orgunit_closed\"));\n                } else {\n                    hideHeaderMessage();\n                }\n                return closed;\n            }\n            return deferred.promise;\n        }\n    };\n});\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/d2-tracker/lib/dhis2.angular.services.js\n// module id = 3\n// module chunks = 0","/* global moment, angular, directive, dhis2, selection */\n\n'use strict';\n\n/* Directives */\n\nvar d2Directives = angular.module('d2Directives', [])\n\n\n.directive('selectedOrgUnit', function ($timeout, $location) {\n    return {\n        restrict: 'A',\n        link: function (scope, element, attrs) {\n            var orgUnitFromUrl;\n            $(\"#orgUnitTree\").one(\"ouwtLoaded\", function (event, ids, names) {\n                if (dhis2.tc && dhis2.tc.metaDataCached) {\n                    $timeout(function () {\n                        scope.treeLoaded = true;\n                        scope.$apply();\n                    });\n                    selection.responseReceived();\n                }\n                else {\n                    console.log('Finished loading orgunit tree');\n                    orgUnitFromUrl = ($location.search()).ou;\n                    $(\"#orgUnitTree\").addClass(\"disable-clicks\"); //Disable ou selection until meta-data has downloaded\n                    $timeout(function () {\n                        scope.treeLoaded = true;\n                        scope.$apply();\n                    });\n                    downloadMetaData();\n                }\n            });\n\n            //listen to user selection, and inform angular\n            selection.setListenerFunction(setSelectedOu, true);\n            function setSelectedOu(ids, names) {\n                var ou = {id: ids[0], displayName: names[0]};\n                if(orgUnitFromUrl && ou.id !== orgUnitFromUrl) {\n                    selection.setOrgUnitFromURL(orgUnitFromUrl);\n                    orgUnitFromUrl = null;\n                } else {\n                    $timeout(function () {\n                        scope.selectedOrgUnit = ou;\n                        scope.$apply();\n                    });\n                }\n            }\n        }\n    };\n})\n\n.directive('d2SetFocus', function ($timeout) {\n\n    return {\n        scope: { trigger: '@d2SetFocus' },\n        link: function(scope, element) {\n            scope.$watch('trigger', function(value) {\n                if(value === \"true\") {\n                    $timeout(function() {\n                        element[0].focus();\n                    });\n                }\n            });\n        }\n    };\n})\n\n.directive('d2LeftBar', function () {\n\n    return {\n        restrict: 'E',\n        templateUrl: 'views/left-bar.html',\n        link: function (scope, element, attrs) {\n\n            $(\"#searchIcon\").click(function () {\n                $(\"#searchSpan\").toggle();\n                $(\"#searchField\").focus();\n            });\n\n            $(\"#searchField\").autocomplete({\n                source: \"../dhis-web-commons/ouwt/getOrganisationUnitsByName.action\",\n                select: function (event, ui) {\n                    $(\"#searchField\").val(ui.item.value);\n                    selection.findByName();\n                }\n            });\n        }\n    };\n})\n\n.directive('blurOrChange', function () {\n\n    return function (scope, elem, attrs) {\n        elem.calendarsPicker({\n            onSelect: function () {\n                scope.$apply(attrs.blurOrChange);\n                $(this).change();\n            }\n        }).change(function () {\n            scope.$apply(attrs.blurOrChange);\n        });\n    };\n})\n\n.directive('d2Enter', function () {\n    return function (scope, element, attrs) {\n        element.bind(\"keydown keypress\", function (event) {\n            if (event.which === 13) {\n                scope.$apply(function () {\n                    scope.$eval(attrs.d2Enter);\n                });\n                event.preventDefault();\n            }\n        });\n    };\n})\n\n.directive('d2PopOver', function ($compile, $templateCache, $translate) {\n\n    return {\n        restrict: 'EA',\n        scope: {\n            content: '=',\n            program: '=',\n            title: '@details',\n            template: \"@template\",\n            placement: \"@placement\",\n            trigger: \"@trigger\"\n        },\n        link: function (scope, element) {\n            var content, program;\n            if (scope.content) {\n                content = $templateCache.get(scope.template);\n                content = $compile(content)(scope);\n                if( scope.program ){\n                    program = $templateCache.get(scope.template);\n                    program = $compile(program)(scope);\n                }\n                var options = {\n                    content: content,\n                    program: program,\n                    placement: scope.placement ? scope.placement : 'auto',\n                    trigger: scope.trigger ? scope.trigger : 'hover',\n                    html: true,\n                    title: $translate.instant('_details')\n                };\n                element.popover(options);\n\n                $('body').on('click', function (e) {\n                    if (!element[0].contains(e.target)) {\n                        element.popover('hide');\n                    }\n                });\n            }\n        }\n    };\n})\n\n.directive('d2Sortable', function ($timeout) {\n\n    return {\n        restrict: 'A',\n        link: function (scope, element, attrs) {\n            element.sortable({\n                connectWith: \".connectedSortable\",\n                placeholder: \"ui-state-highlight\",\n                tolerance: \"pointer\",\n                handle: '.handle',\n                change: function (event, ui) {\n                    getSortedItems(ui);\n                },\n                receive: function (event, ui) {\n                    getSortedItems(ui);\n                }\n            });\n\n            var getSortedItems = function (ui) {\n                var biggerWidgets = $(\"#biggerWidget\").sortable(\"toArray\");\n                var smallerWidgets = $(\"#smallerWidget\").sortable(\"toArray\");\n                var movedIsIdentifeid = false;\n\n                //look for the moved item in the bigger block\n                for (var i = 0; i < biggerWidgets.length && !movedIsIdentifeid; i++) {\n                    if (biggerWidgets[i] === \"\") {\n                        biggerWidgets[i] = ui.item[0].id;\n                        movedIsIdentifeid = true;\n                    }\n                }\n\n                //look for the moved item in the smaller block\n                for (var i = 0; i < smallerWidgets.length && !movedIsIdentifeid; i++) {\n                    if (smallerWidgets[i] === \"\") {\n                        smallerWidgets[i] = ui.item[0].id;\n                        movedIsIdentifeid = true;\n                    }\n                }\n                var layout = {smallerWidgets: smallerWidgets, biggerWidgets: biggerWidgets};\n                scope.applyWidgetsOrderChange( layout );\n            };\n        }\n    };\n})\n\n.directive('serversidePaginator', function factory() {\n\n    return {\n        restrict: 'E',\n        controller: function ($scope, Paginator) {\n            $scope.paginator = Paginator;\n        },\n        templateUrl: './templates/serverside-pagination.html'\n    };\n})\n\n.directive('d2CustomDataEntryForm', function ($compile) {\n    return{\n        restrict: 'E',\n        link: function (scope, elm, attrs) {\n            scope.$watch('customDataEntryForm', function () {\n                if (angular.isObject(scope.customDataEntryForm)) {\n                    elm.html(scope.customDataEntryForm.htmlCode);\n                    $compile(elm.contents())(scope);\n                }\n            });\n        }\n    };\n})\n\n.directive('d2CustomRegistrationForm', function ($compile) {\n    return{\n        restrict: 'E',\n        link: function (scope, elm, attrs) {\n            scope.$watch('customRegistrationForm', function () {\n                if (angular.isObject(scope.customRegistrationForm)) {\n                    elm.html(scope.customRegistrationForm.htmlCode);\n                    $compile(elm.contents())(scope);\n                }\n            });\n        }\n    };\n})\n\n/* TODO: this directive access an element #contextMenu somewhere in the document. Looks like it has to be rewritten */\n.directive('d2ContextMenu', function () {\n\n    return {\n        restrict: 'A',\n        link: function (scope, element, attrs) {\n            var contextMenu = $(\"#contextMenu\");\n\n            element.click(function (e) {\n                var menuHeight = contextMenu.height();\n                var menuWidth = contextMenu.width();\n                var winHeight = $(window).height();\n                var winWidth = $(window).width();\n\n                var pageX = e.pageX;\n                var pageY = e.pageY;\n\n                contextMenu.show();\n\n                if ((menuWidth + pageX) > winWidth) {\n                    pageX -= menuWidth;\n                }\n\n                if ((menuHeight + pageY) > winHeight) {\n                    pageY -= menuHeight;\n\n                    if (pageY < 0) {\n                        pageY = e.pageY;\n                    }\n                }\n\n                contextMenu.css({\n                    left: pageX,\n                    top: pageY\n                });\n\n                return false;\n            });\n\n            contextMenu.on(\"click\", \"a\", function () {\n                contextMenu.hide();\n            });\n\n            $(document).click(function () {\n                contextMenu.hide();\n            });\n        }\n    };\n})\n\n.directive('d2Date', function (CalendarService, $parse) {\n    return {\n        restrict: 'A',\n        require: 'ngModel',\n        link: function (scope, element, attrs, ctrl) {\n            var calendarSetting = CalendarService.getSetting();\n            var dateFormat = 'yyyy-mm-dd';\n            if (calendarSetting.keyDateFormat === 'dd-MM-yyyy') {\n                dateFormat = 'dd-mm-yyyy';\n            }\n\n            var minDate = $parse(attrs.minDate)(scope);\n            var maxDate = $parse(attrs.maxDate)(scope);\n            var calendar = $.calendars.instance(calendarSetting.keyCalendar);\n\n            var initializeDatePicker = function( sDate, eDate ){\n                element.calendarsPicker({\n                    changeMonth: true,\n                    dateFormat: dateFormat,\n                    yearRange: '-120:+30',\n                    minDate: sDate,\n                    maxDate: eDate,\n                    calendar: calendar,\n                    duration: \"fast\",\n                    showAnim: \"\",\n                    renderer: $.calendars.picker.themeRollerRenderer,\n                    onSelect: function () {\n                        $(this).change();\n                    },\n                    onClose:function(){\n                        $(this).blur();\n                    }\n                }).change(function () {\n                    ctrl.$setViewValue(this.value);\n                    this.focus();\n                    scope.$apply();\n                });\n            };\n\n            initializeDatePicker(minDate, maxDate);\n\n            scope.$watch(attrs.minDate, function(value){\n                element.calendarsPicker('destroy');\n                initializeDatePicker( value, $parse(attrs.maxDate)(scope));\n            });\n\n            scope.$watch(attrs.maxDate, function(value){\n                element.calendarsPicker('destroy');\n                initializeDatePicker( $parse(attrs.minDate)(scope), value);\n            });\n        }\n    };\n})\n\n.directive('d2FileInput', function($translate, DHIS2EventService, DHIS2EventFactory, FileService, NotificationService){\n\n    return {\n        restrict: \"A\",\n        scope: {\n            d2FileInputList: '=',\n            d2FileInput: '=',\n            d2FileInputName: '=',\n            d2FileInputCurrentName: '=',\n            d2FileInputPs: '='\n        },\n        link: function (scope, element, attrs) {\n\n            var de = attrs.inputFieldId;\n\n            var updateModel = function () {\n\n                var update = scope.d2FileInput.event &&  scope.d2FileInput.event !== 'SINGLE_EVENT' ? true : false;\n\n                FileService.upload(element[0].files[0]).then(function(data){\n\n                    if(data && data.status === 'OK' && data.response && data.response.fileResource && data.response.fileResource.id && data.response.fileResource.name){\n                        scope.d2FileInput[de] = data.response.fileResource.id;\n                        scope.d2FileInputCurrentName[de] = data.response.fileResource.name;\n                        if(!scope.d2FileInputName[scope.d2FileInput.event]){\n                            scope.d2FileInputName[scope.d2FileInput.event] = {};\n                        }\n                        scope.d2FileInputName[scope.d2FileInput.event][de] = data.response.fileResource.name;\n                        if( update ){\n                            var updatedSingleValueEvent = {event: scope.d2FileInput.event, dataValues: [{value: data.response.fileResource.id, dataElement:  de}]};\n                            var updatedFullValueEvent = DHIS2EventService.reconstructEvent(scope.d2FileInput, scope.d2FileInputPs.programStageDataElements);\n                            DHIS2EventFactory.updateForSingleValue(updatedSingleValueEvent, updatedFullValueEvent).then(function(data){\n                                scope.d2FileInputList = DHIS2EventService.refreshList(scope.d2FileInputList, scope.d2FileInput);\n                            });\n                        }\n                    }\n                    else{\n                        NotificationService.showNotifcationDialog($translate.instant(\"error\"),\n                            $translate.instant(\"file_upload_failed\"));\n                    }\n\n                });\n            };\n            element.bind('change', updateModel);\n        }\n    };\n})\n\n.directive('d2FileInputDelete', function($parse, $timeout, $translate, FileService, NotificationService){\n\n    return {\n        restrict: \"A\",\n        link: function (scope, element, attrs) {\n            var valueGetter = $parse(attrs.d2FileInputDelete);\n            var nameGetter = $parse(attrs.d2FileInputName);\n            var nameSetter = nameGetter.assign;\n\n            if(valueGetter(scope)) {\n                FileService.get(valueGetter(scope)).then(function(data){\n                    if(data && data.name && data.id){\n                        $timeout(function(){\n                            nameSetter(scope, data.name);\n                            scope.$apply();\n                        });\n                    }\n                    else{\n                        NotificationService.showNotifcationDialog($translate.instant(\"error\"),\n                            $translate.instant(\"file_missing\"));\n                    }\n                });\n            }\n        }\n    };\n})\n\n.directive('d2Audit', function (CurrentSelection, MetaDataFactory ) {\n    return {\n        restrict: 'E',\n        template: '<span class=\"hideInPrint audit-icon\" title=\"{{\\'audit_history\\' | translate}}\" data-ng-click=\"showAuditHistory()\">' +\n        '<i class=\"glyphicon glyphicon-user\"\"></i>' +\n        '</span>',\n        scope: {\n            eventId: '@',\n            type: '@',\n            nameIdMap: '='\n        },\n        controller: function ($scope, $modal) {\n            $scope.showAuditHistory = function () {\n\n                var openModal = function( ops ){\n                    $modal.open({\n                        templateUrl: \"./templates/audit-history.html\",\n                        controller: \"AuditHistoryController\",\n                        resolve: {\n                            eventId: function () {\n                                return $scope.eventId;\n                            },\n                            dataType: function () {\n                                return $scope.type;\n                            },\n                            nameIdMap: function () {\n                                return $scope.nameIdMap;\n                            },\n                            optionSets: function(){\n                                return ops;\n                            }\n                        }\n                    });\n                };\n\n                var optionSets = CurrentSelection.getOptionSets();\n                if(!optionSets){\n                    optionSets = [];\n                    MetaDataFactory.getAll('optionSets').then(function(optionSets){\n                        angular.forEach(optionSets, function(optionSet){\n                            optionSets[optionSet.id] = optionSet;\n                        });\n                        CurrentSelection.setOptionSets(optionSets);\n                        openModal(optionSets);\n                    });\n                }\n                else{\n                    openModal(optionSets);\n                }\n            };\n        }\n    };\n})\n\n.directive('d2RadioButton', function (){\n    return {\n        restrict: 'E',\n        templateUrl: './templates/radio-button.html',\n        scope: {\n            required: '=dhRequired',\n            value: '=dhValue',\n            disabled: '=dhDisabled',\n            name: '@dhName',\n            customOnClick: '&dhClick',\n            currentElement: '=dhCurrentElement',\n            event: '=dhEvent',\n            id: '=dhId'\n        },\n        controller: [\n            '$scope',\n            '$element',\n            '$attrs',\n            '$q',\n            'CommonUtils',\n            function($scope, $element, $attrs, $q, CommonUtils){\n\n                $scope.status = \"\";\n                $scope.clickedButton = \"\";\n\n                $scope.valueClicked = function (buttonValue){\n\n                    $scope.clickedButton = buttonValue;\n\n                    var originalValue = $scope.value;\n                    var tempValue = buttonValue;\n                    if($scope.value === buttonValue){\n                        tempValue = \"\";\n                    }\n\n                    if(angular.isDefined($scope.customOnClick)){\n                        var promise = $scope.customOnClick({value: tempValue});\n                        if(angular.isDefined(promise) && angular.isDefined(promise.then)){\n                            promise.then(function(status){\n                                if(angular.isUndefined(status) || status !== \"notSaved\"){\n                                    $scope.status = \"saved\";\n                                }\n                                $scope.value = tempValue;\n                            }, function(){\n                                $scope.status = \"error\";\n                                $scope.value = originalValue;\n                            });\n                        }\n                        else if(angular.isDefined(promise)){\n                            if(promise === false){\n                                $scope.value = originalValue;\n                            }\n                            else {\n                                $scope.value = tempValue;\n                            }\n                        }\n                        else{\n                            $scope.value = tempValue;\n                        }\n                    }\n                    else{\n                        $scope.value = tempValue;\n                    }\n                };\n\n                $scope.getDisabledValue = function(inValue){\n                    return CommonUtils.displayBooleanAsYesNo(inValue);\n                };\n\n                $scope.getDisabledIcon = function(inValue){\n                    if(inValue === true || inValue === \"true\"){\n                        return \"fa fa-check\";\n                    }\n                    else if(inValue === false || inValue === \"false\"){\n                        return \"fa fa-times\";\n                    }\n                    return '';\n                }\n\n            }],\n        link: function (scope, element, attrs) {\n\n            scope.radioButtonColor = function(buttonValue){\n\n                if(scope.value !== \"\"){\n                    if(scope.status === \"saved\"){\n                        if(angular.isUndefined(scope.currentElement) || (scope.currentElement.id === scope.id && scope.currentElement.event === scope.event)){\n                            if(scope.clickedButton === buttonValue){\n                                return 'radio-save-success';\n                            }\n                        }\n                        //different solution with text chosen\n                        /*else if(scope.status === \"error\"){\n                         if(scope.clickedButton === buttonValue){\n                         return 'radio-save-error';\n                         }\n                         }*/\n                    }\n                }\n                return 'radio-white';\n            };\n\n            scope.errorStatus = function(){\n\n                if(scope.status === 'error'){\n                    if(angular.isUndefined(scope.currentElement) || (scope.currentElement.id === scope.id && scope.currentElement.event === scope.event)){\n                        return true;\n                    }\n                }\n                return false;\n            };\n\n            scope.radioButtonImage = function(buttonValue){\n\n                if(angular.isDefined(scope.value)){\n                    if(scope.value === buttonValue && buttonValue === \"true\"){\n                        return 'fa fa-stack-1x fa-check';\n                    }\n                    else if(scope.value === buttonValue && buttonValue === \"false\"){\n                        return 'fa fa-stack-1x fa-times';\n                    }\n                }\n                return 'fa fa-stack-1x';\n            };\n        }\n    };\n})\n\n.directive('d2Radio', function(  DateUtils ){\n    return {\n        restrict: 'EA',            \n        templateUrl: \"./templates/radio-input.html\",\n        scope: {            \n            id: '=',\n            name: '@d2Name',\n            d2Object: '=',\n            d2ValueSaved: '=',\n            d2Disabled: '=',\n            d2Required: '=',\n            d2Options: '=',\n            d2CallbackFunction: '&d2Function'\n        },\n        link: function (scope, element, attrs) {\n            \n        },\n        controller: function($scope){\n            \n            $scope.model = {radio: $scope.d2Object[$scope.id] ? $scope.d2Object[$scope.id] : null};\n            \n            $scope.saveValue = function( value ){\n                $scope.model.radio = value;\n                if( $scope.model.radio === $scope.d2Object[$scope.id] ){\n                    $scope.model.radio = null;\n                }\n                \n                $scope.d2Object[$scope.id] = $scope.model.radio;\n                if( angular.isDefined( $scope.d2CallbackFunction ) ){\n                    $scope.d2CallbackFunction({value: $scope.model.radio});\n                }\n            };\n        }\n    };\n})\n\n.directive('dhis2Deselect', function ($document) {\n    return {\n        restrict: 'A',\n        scope: {\n            onDeselected: '&dhOnDeselected',\n            id: '@dhId',\n            preSelected: '=dhPreSelected',\n            abortDeselect: '&dhAbortDeselect'\n        },\n        controller: [\n            '$scope',\n            '$element',\n            '$attrs',\n            '$q',\n            function($scope, $element, $attrs, $q){\n\n                $scope.documentEventListenerSet = false;\n                $scope.elementClicked = false;\n\n                $element.on('click', function(event) {\n\n                    $scope.elementClicked = true;\n                    if($scope.documentEventListenerSet === false){\n                        $document.on('click', $scope.documentClick);\n                        $scope.documentEventListenerSet = true;\n                    }\n                });\n\n                $scope.documentClick = function(event){\n                    var modalPresent = $(\".modal-backdrop\").length > 0;\n                    var calendarPresent = $(\".calendars-popup\").length > 0;\n                    var calendarPresentInEvent = $(event.target).parents(\".calendars-popup\").length > 0;\n                    if($scope.abortDeselect()){\n                        $document.off('click', $scope.documentClick);\n                        $scope.documentEventListenerSet = false;\n                    }else if($scope.elementClicked === false &&\n                        modalPresent === false &&\n                        calendarPresent === false &&\n                        calendarPresentInEvent === false){\n                        $scope.onDeselected({id:$scope.id});\n                        $scope.$apply();\n                        $document.off('click', $scope.documentClick);\n                        $scope.documentEventListenerSet = false;\n                    }\n                    $scope.elementClicked = false;\n                };\n\n                if(angular.isDefined($scope.preSelected) && $scope.preSelected === true){\n                    $document.on('click', $scope.documentClick);\n                    $scope.documentEventListenerSet = true;\n                }\n\n            }],\n        link: function (scope, element, attrs) {\n        }\n    };\n})\n\n.directive('d2OrgUnitTree', function(OrgUnitFactory){\n    return {\n        restrict: 'EA',            \n        templateUrl: \"./templates/orgunit-input.html\",\n        scope: {            \n            selectedOrgUnitId: '@',\n            id: '@',\n            d2Object: '=',\n            d2Disabled: '=',\n            d2Required: '=',\n            d2CallbackFunction: '&d2Function',\n            d2OrgunitNames: '='\n        },\n        link: function (scope, element, attrs) {\n        },\n        controller: function($scope, $modal){\n            \n            if( !$scope.d2OrgUnitNames ){\n                $scope.d2OrgUnitNames = {};\n            }\n            \n            if( $scope.id && $scope.d2Object[$scope.id] ){                \n                OrgUnitFactory.getFromStoreOrServer($scope.d2Object[$scope.id]).then(function (response) {\n                    if(response && response.n) {\n                        $scope.d2OrgunitNames[$scope.d2Object[$scope.id]] = response.n;\n                    }\n                });\n            }\n            \n            $scope.showOrgUnitTree = function( dataElementId ){\n                \n                var modalInstance = $modal.open({\n                    templateUrl: \"./templates/orgunit-tree.html\",\n                    controller: 'OrgUnitTreeController',\n                    resolve: {\n                        orgUnitId: function(){\n                            return $scope.d2Object[dataElementId] ? $scope.d2Object[dataElementId] : $scope.selectedOrgUnitId;\n                        },\n                        orgUnitNames: function(){\n                            return $scope.d2OrgunitNames;\n                        }\n                    }\n                });\n\n                modalInstance.result.then(function ( res ) {\n                    if( res && res.selected && res.selected.id ){\n                        $scope.d2Object[dataElementId] = res.selected.id;\n                        $scope.d2OrgunitNames = res.names;\n                        if( angular.isDefined( $scope.d2CallbackFunction ) ){\n                            $scope.d2CallbackFunction($scope.d2Object, dataElementId);\n                        }                            \n                    }                    \n                }, function () {\n                });\n            };\n            \n            $scope.removeSelectedOrgUnit = function( dataElementId ){\n                delete $scope.d2Object[dataElementId];\n                if( angular.isDefined( $scope.d2CallbackFunction ) ){\n                    $scope.d2CallbackFunction($scope.d2Object, dataElementId);\n                }\n            };\n        }\n        \n    };\n})\n\n.directive('d2Map', function(){\n    return {\n        restrict: 'E',            \n        templateUrl: \"./templates/coordinate-input.html\",\n        scope: {\n            id: '@',            \n            d2Object: '=',            \n            d2CallbackFunction: '&d2Function',\n            d2CallbackFunctionParamText: '=d2FunctionParamText',\n            d2CallbackFunctionParamCoordinate: '=d2FunctionParamCoordinate',\n            d2Disabled: '=',\n            d2Required: '=',\n            d2LatSaved: '=',\n            d2LngSaved: '=',\n            d2CoordinateFormat: '='\n        },\n        controller: function($scope, $modal, $filter, $translate, DHIS2COORDINATESIZE, NotificationService){            \n            $scope.coordinateObject = angular.copy( $scope.d2Object );\n            \n            function processCoordinate(){\n            \tif( $scope.d2CoordinateFormat === 'TEXT' ){        \n                    if( $scope.d2Object[$scope.id] && $scope.d2Object[$scope.id] !== ''){                        \n                        var coordinatePattern = /^\\[-?\\d+\\.?\\d+\\,-?\\d+\\.?\\d+\\]$/;\n                        if( !coordinatePattern.test( $scope.d2Object[$scope.id] ) ){\n                            NotificationService.showNotifcationDialog($translate.instant('error'), $translate.instant('invalid_coordinate_format') + \":  \" + $scope.d2Object[$scope.id] );\n                        }\n                        \n                    \tvar coordinates = $scope.d2Object[$scope.id].slice(1,-1).split( \",\");                        \n                    \tif( !dhis2.validation.isNumber( coordinates[0] ) || !dhis2.validation.isNumber( coordinates[0] ) ){\n                            NotificationService.showNotifcationDialog($translate.instant('error'), $translate.instant('invalid_coordinate_format') + \":  \" + $scope.d2Object[$scope.id] );\n                    \t}\n                        $scope.coordinateObject.coordinate = {latitude: parseFloat(coordinates[1]), longitude: parseFloat(coordinates[0])};\n                    }\n                    else{\n                        $scope.coordinateObject.coordinate = {};\n                    }\n                }            \n                if( !$scope.coordinateObject.coordinate ){\n                    $scope.coordinateObject.coordinate = {};\n                }\n            };\n            \n            processCoordinate();\n            \n            $scope.showMap = function(){                \n                \n            \tprocessCoordinate();            \t\n                            \n                var modalInstance = $modal.open({\n                    templateUrl: './templates/map.html',\n                    controller: 'MapController',\n                    windowClass: 'modal-map-window',\n                    resolve: {\n                        location: function () {\n                            return {lat: $scope.coordinateObject.coordinate.latitude, lng:  $scope.coordinateObject.coordinate.longitude};\n                        }\n                    }\n                });\n                \n                modalInstance.result.then(function (location) {                    \n                    if(angular.isObject(location)){\n                    \t\n                    \tif( dhis2.validation.isNumber( location.lat ) ){\n                    \t\tlocation.lat = parseFloat( $filter('number')(location.lat, DHIS2COORDINATESIZE) );\n                    \t}\n                    \t\n                    \tif( dhis2.validation.isNumber( location.lng ) ){\n                    \t\tlocation.lng = parseFloat( $filter('number')(location.lng, DHIS2COORDINATESIZE) );\n                    \t}\n                    \t\n                        $scope.coordinateObject.coordinate.latitude = location.lat;\n                        $scope.coordinateObject.coordinate.longitude = location.lng;                        \n\n                        if( $scope.d2CoordinateFormat === 'TEXT' ){                        \n                            $scope.d2Object[$scope.id] = '[' + location.lng + ',' + location.lat + ']';\n                            if( angular.isDefined( $scope.d2CallbackFunction ) ){\n                                $scope.d2CallbackFunction( {arg1: $scope.d2CallbackFunctionParamText} );\n                            }\n                        }\n                        else{\n                            $scope.d2Object.coordinate.latitude = location.lat;\n                            $scope.d2Object.coordinate.longitude = location.lng;\n                            if( angular.isDefined( $scope.d2CallbackFunction ) ){\n                                $scope.d2CallbackFunction( {arg1: $scope.d2CallbackFunctionParamCoordinate} );\n                            }\n                        }                                                \n                    }\n                }, function () {\n                });\n            };\n            \n            $scope.coordinateInteracted = function (field, form) {        \n                var status = false;\n                if (field) {\n                    if(angular.isDefined(form)){\n                        status = form.$submitted || field.$dirty;\n                    }\n                    else {\n                        status = $scope.coordinateForm.$submitted || field.$dirty;\n                    }            \n                }\n                return status;\n            };\n            \n            $scope.saveD2Coordinate = function(){\n                \n                var saveCoordinate = function( format, param ){\n                    if( !$scope.coordinateObject.coordinate.longitude && !$scope.coordinateObject.coordinate.latitude ){\n                        if( format === 'COORDINATE' ){\n                            $scope.d2Object.coordinate = {latitude: \"\", longitude: \"\"};\n                        }\n                        else{\n                            $scope.d2Object[$scope.id] = '';\n                        }\n                        $scope.d2CallbackFunction( {arg1: param} );                            \n                    }\n                    else{\n                        if( $scope.coordinateObject.coordinate.longitude && $scope.coordinateObject.coordinate.latitude ){\n                            $scope.d2CallbackFunction( {arg1: param} );\n                        }\n                    }                    \n                };\n                \n                if( angular.isDefined( $scope.d2CallbackFunction ) ){\n                \t\n                \tif( dhis2.validation.isNumber( $scope.coordinateObject.coordinate.latitude ) ){\n                \t\t$scope.coordinateObject.coordinate.latitude = parseFloat( $filter('number')($scope.coordinateObject.coordinate.latitude, DHIS2COORDINATESIZE) );\n                \t}\n                \t\n                \tif( dhis2.validation.isNumber( $scope.coordinateObject.coordinate.longitude ) ){\n                \t\t$scope.coordinateObject.coordinate.longitude = parseFloat( $filter('number')($scope.coordinateObject.coordinate.longitude, DHIS2COORDINATESIZE) );\n                \t}\n                \t\n                    if( $scope.d2CoordinateFormat === 'TEXT' ){                    \n                        $scope.d2Object[$scope.id] = '[' + $scope.coordinateObject.coordinate.longitude + ',' + $scope.coordinateObject.coordinate.latitude + ']';                        \n                        saveCoordinate( 'TEXT',  $scope.prStDe);\n                    }\n                    else{\n                        $scope.d2Object.coordinate.latitude = $scope.coordinateObject.coordinate.latitude;\n                        $scope.d2Object.coordinate.longitude = $scope.coordinateObject.coordinate.longitude;\n                        \n                        saveCoordinate( 'COORDINATE',  $scope.d2CallbackFunctionParam );                        \n                    }\n                }\n            };    \n        },\n        link: function (scope, element, attrs) {\n            \n        }\n    };\n})\n\n.directive('d2Age', function( CalendarService, DateUtils ){\n    return {\n        restrict: 'EA',            \n        templateUrl: \"./templates/age-input.html\",\n        scope: {\n            id: '@',\n            d2Object: '=',\n            d2AgeSaved: '=',\n            d2Disabled: '=',\n            d2Required: '=',\n            d2CallbackFunction: '&d2Function'\n        },\n        link: function (scope, element, attrs) {\n            \n        },\n        controller: function($scope){            \n            \n            $scope.age = {};\n            \n            if( $scope.id && $scope.d2Object && $scope.d2Object[$scope.id] ){\n                $scope.age.dob = $scope.d2Object[$scope.id];\n                formatAge();\n            }\n            \n            function formatAge(){\n                if( $scope.age && $scope.age.dob !== \"\" ){\n                    var _age = DateUtils.getAge( $scope.age.dob );                    \n                    $scope.age.years = _age.years;\n                    $scope.age.months = _age.months;\n                    $scope.age.days = _age.days;\n                }\n            }\n            \n            $scope.$watch('age.dob', function( newValue, oldValue ){\n                if( newValue !== oldValue ){\n                    $scope.d2Object[$scope.id] = $scope.age.dob;\n                    if( angular.isDefined( $scope.d2CallbackFunction ) ){\n                        $scope.d2CallbackFunction($scope.d2Object, $scope.id);\n                    }\n                }\n            });\n            \n            $scope.saveDOB = function(){                \n                formatAge();                \n            };\n            \n            $scope.saveAge = function(){\n                var dob = moment().subtract({days: $scope.age.days ? $scope.age.days : 0, months: $scope.age.months ? $scope.age.months : 0, years: $scope.age.years ? $scope.age.years : 0});\n                $scope.age.dob = DateUtils.format( dob );\n                formatAge();\n            };\n            \n            $scope.removeAge = function(){\n                $scope.age = {};\n            };\n            \n            $scope.ageInteracted = function (field, form) {        \n                var status = false;\n                if (field) {\n                    if(angular.isDefined(form)){\n                        status = form.$submitted || field.$dirty;\n                    }\n                    else {\n                        status = $scope.ageForm.$submitted || field.$dirty;\n                    }            \n                }\n                return status;\n            };\n        }\n    };\n});\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/d2-tracker/lib/dhis2.angular.directives.js\n// module id = 4\n// module chunks = 0","angular.module(\"d2Directives\")\n.directive('d2NumberValidator', function() {\n    return {\n        require: 'ngModel',\n        restrict: 'A',\n        link: function (scope, element, attrs, ngModel) {\n            \n            function setValidity(numberType, isRequired){\n                if(numberType === 'NUMBER'){\n                    ngModel.$validators.number = function(value) {\n                    \tvalue = value === 0 ? value.toString(): value; \n                        return value === 'null' || !value ? !isRequired : dhis2.validation.isNumber(value);\n                    };\n                }\n                else if(numberType === 'INTEGER_POSITIVE'){\n                    ngModel.$validators.posInt = function(value) {\n                    \tvalue = value === 0 ? value.toString(): value; \n                        return value === 'null' || !value ? !isRequired : dhis2.validation.isPositiveInt(value);\n                    };\n                }\n                else if(numberType === 'INTEGER_NEGATIVE'){\n                    ngModel.$validators.negInt = function(value) {\n                    \tvalue = value === 0 ? value.toString(): value;\n                        return value === 'null' || !value ? !isRequired : dhis2.validation.isNegativeInt(value);\n                    };\n                }\n                else if(numberType === 'INTEGER_ZERO_OR_POSITIVE'){\n                    ngModel.$validators.zeroPositiveInt = function(value) {\n                    \tvalue = value === 0 ? value.toString(): value; \n                        return value === 'null' || !value ? !isRequired : dhis2.validation.isZeroOrPositiveInt(value);\n                    };\n                }\n                else if(numberType === 'INTEGER'){\n                    ngModel.$validators.integer = function(value) {\n                    \tvalue = value === 0 ? value.toString(): value;\n                        return value === 'null' || !value ? !isRequired : dhis2.validation.isInt(value);\n                    };\n                }\n                if(numberType === 'PERCENTAGE'){\n                    ngModel.$validators.percentValue = function(value) {\n                        if (value < 0 || value > 100) {\n                            return false;\n                        }\n                        value = value === 0 ? value.toString(): value;\n                        return value === 'null' || !value ? !isRequired : dhis2.validation.isNumber(value);\n                    };\n                }\n            }\n\n            var numberType = attrs.numberType;\n            var isRequired = attrs.ngRequired === 'true';            \n            setValidity(numberType, isRequired);\n        }\n    };\n})\n\n.directive(\"d2DateValidator\", function(DateUtils, CalendarService, $parse) {\n    return {\n        restrict: \"A\",         \n        require: \"ngModel\",         \n        link: function(scope, element, attrs, ngModel) {\n        \t\n            var calendarSetting = CalendarService.getSetting();\n            var isRequired = attrs.ngRequired === 'true';\n        \t\n            ngModel.$validators.dateValidator = function(value) {\n                if(!value){\n                    return !isRequired;\n                }                \n                var convertedDate = DateUtils.format(angular.copy(value));\n                var isValid = value === convertedDate;\n                return isValid;\n            };\n            \n            ngModel.$validators.futureDateValidator = function(value) {\n                if(!value){\n                    return !isRequired;\n                }\n                var maxDate = $parse(attrs.maxDate)(scope);\n                var convertedDate = DateUtils.format(angular.copy(value));\n                var isValid = value === convertedDate;\n                if(isValid){\n                    isValid = maxDate === 0 ? !moment(convertedDate, calendarSetting.momentFormat).isAfter(moment(DateUtils.getToday(), calendarSetting.momentFormat)) : isValid;\n                }\n                return isValid;\n            };\n        }\n    };\n})\n\n.directive(\"d2CustomCoordinateValidator\", function() {\n    return {\n        restrict: \"A\",         \n        require: \"ngModel\",         \n        link: function(scope, element, attrs, ngModel) {\n            \n            var isRequired = attrs.ngRequired === 'true';\n            \n            ngModel.$validators.customCoordinateValidator = function(value) {\n                if(!value){\n                    return !isRequired;\n                }\n                \n                var coordinate = value.split(\",\");\n                \n                if( !coordinate || coordinate.length !== 2 ){\n                    return false;\n                }\n\n                if( !dhis2.validation.isNumber(coordinate[0]) ){\n                    return false;\n                }\n                \n                if( !dhis2.validation.isNumber(coordinate[1]) ){\n                    return false;\n                }\n                \n                return coordinate[0] >= -180 && coordinate[0] <= 180 && coordinate[1] >= -90 && coordinate[1] <= 90;\n            };           \n        }\n    };\n})\n\n.directive(\"d2CoordinateValidator\", function() {\n    return {\n        restrict: \"A\",         \n        require: \"ngModel\",         \n        link: function(scope, element, attrs, ngModel) {\n            \n            var isRequired = attrs.ngRequired === 'true';\n            \n            if(attrs.name === 'latitude'){\n                ngModel.$validators.latitudeValidator = function(value) {\n                    if(!value){\n                        return !isRequired;\n                    }\n\n                    if(!dhis2.validation.isNumber(value)){\n                        return false;\n                    }\n                    return value >= -90 && value <= 90;\n                };\n            }\n            \n            if(attrs.name === 'longitude'){\n                ngModel.$validators.longitudeValidator = function(value) {\n                    if(!value){\n                        return !isRequired;\n                    }\n\n                    if(!dhis2.validation.isNumber(value)){\n                        return false;\n                    }\n                    return value >= -180 && value <= 180;\n                };\n            }            \n        }\n    };\n})\n\n.directive(\"d2OptionValidator\", function($translate, NotificationService) {\n    return {\n        restrict: \"A\",         \n        require: \"ngModel\",         \n        link: function(scope, element, attrs, ngModel) {\n        \t\n            var isRequired = attrs.ngRequired === 'true';\n            \n            ngModel.$validators.optionValidator = function(value) {               \n                \n                var res = !value ? !isRequired : true;\n                \n                if(!res){\n                    var headerText = $translate.instant(\"validation_error\");\n                    var bodyText = $translate.instant(\"option_required\");\n                    NotificationService.showNotifcationDialog(headerText, bodyText);\n                }\n                return res;\n            };\n        }\n    };\n})\n\n.directive(\"d2AttributeValidator\", function($q, TEIService, SessionStorageService) {\n    return {\n        restrict: \"A\",         \n        require: \"ngModel\",\n        link: function(scope, element, attrs, ngModel) {            \n            \n            function uniqunessValidatior(attributeData){\n                \n                ngModel.$asyncValidators.uniqunessValidator = function (modelValue, viewValue) {\n                    var pager = {pageSize: 1, page: 1, toolBarDisplay: 5};\n                    var deferred = $q.defer(), currentValue = modelValue || viewValue, programUrl = null, ouMode = 'ALL';\n                    \n                    if (currentValue) {\n                        \n                        attributeData.value = currentValue;                        \n                        var attUrl = 'filter=' + attributeData.id + ':EQ:' + attributeData.value;\n                        var ouId = SessionStorageService.get('ouSelected');\n                        \n                        if(attrs.selectedProgram && attributeData.programScope){\n                            programUrl = 'program=' + attrs.selectedProgram;\n                        }\n                        \n                        if(attributeData.orgUnitScope){\n                            ouMode = 'SELECTED';\n                        }                        \n\n                        TEIService.search(ouId, ouMode, null, programUrl, attUrl, pager, true).then(function(data) {\n                            if(attrs.selectedTeiId){\n                                if(data && data.rows && data.rows.length && data.rows[0] && data.rows[0].length && data.rows[0][0] !== attrs.selectedTeiId){\n                                    deferred.reject();\n                                }\n                            }\n                            else{\n                                if (data.rows.length > 0) {    \n                                    deferred.reject();\n                                }\n                            }                            \n                            deferred.resolve();\n                        });\n                    }\n                    else {\n                        deferred.resolve();\n                    }\n\n                    return deferred.promise;\n                };\n            }                      \n            \n            scope.$watch(attrs.ngDisabled, function(value){\n                var attributeData = scope.$eval(attrs.attributeData);\n                if(!value){\n                    if( attributeData && attributeData.unique && !value ){\n                        uniqunessValidatior(attributeData);\n                    }\n                }              \n            });     \n        }\n    };\n});\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/d2-tracker/lib/dhis2.angular.validations.js\n// module id = 5\n// module chunks = 0","'use strict';\n\n/* Filters */\n\nvar d2Filters = angular.module('d2Filters', [])\n\n.filter('gridFilter', function($filter, CalendarService){\n    \n    return function(data, filters, filterTypes){\n\n        if(!data ){\n            return;\n        }\n        \n        if(!filters){\n            return data;\n        }        \n        else{            \n            \n            var dateFilter = {}, \n                textFilter = {}, \n                numberFilter = {},\n                filteredData = data;\n            \n            for(var key in filters){\n                \n                if(filterTypes[key] === 'DATE'){\n                    if(filters[key].start || filters[key].end){\n                        dateFilter[key] = filters[key];\n                    }\n                }\n                else if(filterTypes[key] === 'NUMBER' || \n                \t\t\tfilterTypes[key] === 'INTEGER' ||\n                \t\t\tfilterTypes[key] === 'INTEGER_POSITIVE' || \n                \t\t\tfilterTypes[key] === 'INTEGER_NEGATIVE' || \n                \t\t\tfilterTypes[key] === 'INTEGER_ZERO_OR_POSITIVE'){\n                    if(filters[key].start || filters[key].end){\n                        numberFilter[key] = filters[key];\n                    }\n                }\n                else{\n                    textFilter[key] = filters[key];\n                }\n            }\n            \n            filteredData = $filter('filter')(filteredData, textFilter); \n            filteredData = $filter('filter')(filteredData, dateFilter, dateComparator);            \n            filteredData = $filter('filter')(filteredData, numberFilter, numberComparator);\n                        \n            return filteredData;\n        } \n    }; \n    \n    function dateComparator(data,filter){\n    \tvar calendarSetting = CalendarService.getSetting(); \n        var start = moment(filter.start, calendarSetting.momentFormat);\n        var end = moment(filter.end, calendarSetting.momentFormat);  \n        var date = moment(data, calendarSetting.momentFormat); \n        \n        if(filter.start && filter.end){\n            return ( Date.parse(date) <= Date.parse(end) ) && (Date.parse(date) >= Date.parse(start));\n        }        \n        return ( Date.parse(date) <= Date.parse(end) ) || (Date.parse(date) >= Date.parse(start));\n    }\n    \n    function numberComparator(data,filter){\n        var start = filter.start;\n        var end = filter.end;\n        \n        if(filter.start && filter.end){\n            return ( data <= end ) && ( data >= start );\n        }        \n        return ( data <= end ) || ( data >= start );\n    }\n})\n\n.filter('paginate', function(Paginator) {\n    return function(input, rowsPerPage) {\n        if (!input) {\n            return input;\n        }\n\n        if (rowsPerPage) {\n            Paginator.rowsPerPage = rowsPerPage;\n        }       \n        \n        Paginator.itemCount = input.length;\n\n        return input.slice(parseInt(Paginator.page * Paginator.rowsPerPage), parseInt((Paginator.page + 1) * Paginator.rowsPerPage + 1) - 1);\n    };\n})\n\n/* trim away all single and double quotes in the start and end of a string*/\n.filter('trimquotes', function() {\n    return function(input) {\n        if (!input || (typeof input !== 'string' && !(input instanceof String))) {\n            return input;\n        }\n        \n        var beingTrimmed = input;\n        var trimmingComplete = false;\n        //Trim until no more quotes can be removed.\n        while(!trimmingComplete) {\n            var beforeTrimming = beingTrimmed;\n            beingTrimmed = input.replace(/^'/,\"\").replace(/'$/,\"\");\n            beingTrimmed = beingTrimmed.replace(/^\"/,\"\").replace(/\"$/,\"\");\n            \n            if(beforeTrimming.length === beingTrimmed.length) {\n                trimmingComplete = true;\n            }\n        }\n        \n        \n        return beingTrimmed;\n    };\n})\n\n/* filter out confidential attributes from a list */\n.filter('nonConfidential', function() {\n  return function( items ) {\n    var filtered = [];\n    angular.forEach(items, function(item) {\n      if(!item.confidential) {\n        filtered.push(item);\n      }\n    });\n    return filtered;\n  };\n})\n\n/* trim away the qualifiers before and after a variable name */\n.filter('trimvariablequalifiers', function() {\n    return function(input) {\n        if (!input || (typeof input !== 'string' && !(input instanceof String))) {\n            return input;\n        }\n        \n        var trimmed = input.replace(/^[#VCAvca]{/,\"\").replace(/}$/,\"\");\n        \n        return trimmed;\n    };\n})\n\n.filter('forLoop', function() {\n    return function(input, start, end) {\n        input = new Array(end - start);\n        for (var i = 0; start < end; start++, i++) {\n            input[i] = start;\n        }\n        return input;\n    };\n})\n\n.filter('parseAge', function(DateUtils){\n    return function(input){        \n        if( DateUtils.isValid( input ) ){            \n            var age = DateUtils.getAge( input );\n            return '[' + age.years + 'y, ' + age.months + 'm, ' + age.days + 'd]';\n        }\n        return input;\n    };\n})\n\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/d2-tracker/lib/dhis2.angular.filters.js\n// module id = 6\n// module chunks = 0","'use strict';\n\n/* Controllers */\nvar d2Controllers = angular.module('d2Controllers', [])\n\n//Controller for column show/hide\n.controller('ColumnDisplayController', \n    function($scope, \n            $modalInstance,\n            hiddenGridColumns,\n            gridColumns,\n            gridColumnDomainKey,\n            gridColumnKey,\n            gridColumnsInUserStore,\n            GridColumnService){\n    \n    $scope.gridColumns = gridColumns;\n    $scope.hiddenGridColumns = hiddenGridColumns;\n    \n    $scope.close = function () {\n        $modalInstance.close($scope.gridColumns);\n    };\n    \n    $scope.showHideColumns = function(gridColumn){\n       \n        if(gridColumn.show){                \n            $scope.hiddenGridColumns--;            \n        }\n        else{\n            $scope.hiddenGridColumns++;            \n        }\n        \n        if(gridColumnKey) {\n            gridColumnsInUserStore[gridColumnKey] = angular.copy($scope.gridColumns);\n        }\n        GridColumnService.set(gridColumnsInUserStore, gridColumnDomainKey);\n    };    \n})\n\n//controller for dealing with google map\n.controller('MapController',\n        function($scope, \n                $modalInstance,                \n                $translate,\n                $http,\n                $window,\n                $q,\n                CommonUtils,\n                leafletData,\n                CurrentSelection,\n                DHIS2URL,\n                NotificationService,\n                location) {\n    \n    $scope.tilesDictionary = {\n        openstreetmap: {\n            url: \"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",\n            options: {\n                attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n            }\n        },\n        googlemap: {\n            layers: {\n                baselayers: {\n                    googleRoadmap: {\n                        name: 'Google Streets',\n                        layerType: 'ROADMAP',\n                        type: 'google'\n                    },\n                    googleHybrid: {\n                        name: 'Google Hybrid',\n                        layerType: 'HYBRID',\n                        type: 'google'\n                    },\n                    googleTerrain: {\n                        name: 'Google Terrain',\n                        layerType: 'TERRAIN',\n                        type: 'google'\n                    }\n                }\n            }\n        }\n    };\n    \n    $scope.tilesDictionaryKeys = ['openstreetmap', 'googlemap'];    \n    \n    $scope.selectedTileKey = 'openstreetmap';\n    \n    $scope.location = location;\n    \n    var currentLevel = 0, ouLevels = CurrentSelection.getOuLevels();\n    \n    $scope.maxZoom = 8;\n    \n    $scope.center = {lat: 8.88, lng: -11.55, zoom: $scope.maxZoom};    \n    \n    var systemSetting = CommonUtils.getSystemSetting();\n    \n    if( !systemSetting.keyGoogleMapsApiKey || systemSetting.keyGoogleMapsApiKey === '' ){\n        NotificationService.showNotifcationDialog($translate.instant(\"warning\"), $translate.instant(\"missing_google_maps_api_key\"));\n        systemSetting.keyGoogleMapsApiKey = 'AIzaSyBjlDmwuON9lJbPMDlh_LI3zGpGtpK9erc';\n    }\n    \n    if( !systemSetting.keyMapzenSearchApiKey || systemSetting.keyMapzenSearchApiKey === '' ){\n        NotificationService.showNotifcationDialog($translate.instant(\"warning\"), $translate.instant(\"missing_mapzen_search_api_key\"));\n        systemSetting.keyMapzenSearchApiKey = 'search-Se1CFzK';\n    }    \n    \n    var setCoordinateLabel = '<i class=\"fa fa-map-marker fa-2x\"></i><span class=\"small-horizontal-spacing\">' + $translate.instant('set_coordinate') + '</span>';\n    var zoomInLabel = '<i class=\"fa fa-search-plus fa-2x\"></i><span class=\"small-horizontal-spacing\">' + $translate.instant('zoom_in') + '</span>';\n    var zoomOutLabel = '<i class=\"fa fa-search-minus fa-2x\"></i><span class=\"small-horizontal-spacing\">' + $translate.instant('zoom_out') + '</span>';\n    var centerMapLabel = '<i class=\"fa fa-crosshairs fa-2x\"></i><span class=\"small-horizontal-spacing\">' + $translate.instant('center_map') + '</span>';\n    \n    var contextmenuItems = [{\n                        text: setCoordinateLabel,\n                        callback: setCoordinate,\n                        index: 0\n                    },\n                    {\n                        separator: true,\n                        index: 1\n                    },\n                    {\n                        text: zoomInLabel,\n                        callback: zoomIn,\n                        index: 2\n                    },\n                    {\n                        text: zoomOutLabel,\n                        callback: zoomOut,\n                        index: 3\n                    },\n                    {\n                        separator: true,\n                        index: 4\n                    },\n                    {\n                        text: centerMapLabel,\n                        callback: centerMap,\n                        index: 5\n                    }];\n                        \n    $scope.mapDefaults = {map: {\n                            contextmenu: true,\n                            contextmenuWidth: 180,\n                            contextmenuItems: contextmenuItems\n                        }};\n    \n    var geojsonMarkerOptions = {\n\t\t\t    radius: 15,\n\t\t\t    fillColor: '#ff7800',\n\t\t\t    color: '#000',\n\t\t\t    weight: 1,\n\t\t\t    opacity: 1,\n\t\t\t    fillOpacity: 0.8\n\t\t\t};\n                        \n    var style = {fillColor: \"green\",\n                    weight: 1,\n                    opacity: 0.8,\n                    color: 'black',\n                    fillOpacity: 0\n                };\n\n    $scope.marker = $scope.location && $scope.location.lat && $scope.location.lng ? {m1: {lat: $scope.location.lat, lng: $scope.location.lng, draggable: true}} : {};\n    \n    function pointToLayer( feature, latlng ){\n        return L.circleMarker(latlng, geojsonMarkerOptions);\n    };\n    \n    function onEachFeature(feature, layer) {\n        \n        layer.on(\"mouseover\",function(e){            \n            $(\"#polygon-label\").text( feature.properties.name );\n        });\n        layer.on(\"mouseout\",function(e){\n            $(\"#polygon-label\").text('');\n        });        \n        \n        if( layer._layers ){\n            layer.eachLayer(function (l) {\n                l.bindContextMenu({\n                    contextmenu: true,\n                    contextmenuWidth: 180,                \n                    contextmenuItems: [{\n                                    text: setCoordinateLabel,\n                                    callback: function(e){\n                                        setCoordinate(e, feature);\n                                    },\n                                    index: 0\n                                },\n                                {\n                                    separator: true,\n                                    index: 1\n                                },\n                                {\n                                    text: zoomInLabel,\n                                    callback: function(e){\n                                        zoomIn(e, feature);\n                                    },\n                                    index: 2\n                                },\n                                {\n                                    text: zoomOutLabel,\n                                    callback: function(e){\n                                        zoomOut(e, feature);\n                                    },\n                                    index: 3,\n                                    disabled: currentLevel < 1\n                                },\n                                {\n                                    separator: true,\n                                    index: 4\n                                },\n                                {\n                                    text: centerMapLabel,\n                                    callback: function(e){\n                                        centerMap(e, feature);\n                                    },\n                                    index: 5\n                                }]\n                });\n            });\n        }\n        else{\n            layer.bindContextMenu({\n                    contextmenu: true,\n                    contextmenuWidth: 180,\n                    contextmenuInheritItems: false,\n                    contextmenuItems: [{\n                                    text: setCoordinateLabel,\n                                    callback: function(e){\n                                        setCoordinate(e, feature, layer);\n                                    },\n                                    index: 0\n                                },\n                                {\n                                    separator: true,\n                                    index: 1\n                                },\n                                {\n                                    text: zoomInLabel,\n                                    callback: function(e){\n                                        zoomIn(e, feature);\n                                    },\n                                    disabled: true,\n                                    index: 2\n                                },\n                                {\n                                    text: zoomOutLabel,\n                                    callback: function(e){\n                                        zoomOut(e, feature);\n                                    },\n                                    index: 3\n                                },\n                                {\n                                    separator: true,\n                                    index: 4\n                                },\n                                {\n                                    text: centerMapLabel,\n                                    callback: function(e){\n                                        centerMap(e, feature);\n                                    },\n                                    index: 5\n                                }]\n                });\n        }        \n    }    \n            \n    function getGeoJsonByOuLevel(initialize, event, mode) {                    \n        var url = null, parent = null;\n        if (initialize) {\n            currentLevel = 0;\n            url = DHIS2URL + '/organisationUnits.geojson?level=' + ouLevels[currentLevel].level;\n        }\n        else {\n            if (mode === 'IN') {\n                currentLevel++;\n                parent = event.id;\n            }\n            if (mode === 'OUT') {\n                currentLevel--;                \n                var parents = event.properties.parentGraph.substring(1, event.properties.parentGraph.length - 1).split('/');\n                parent = parents[parents.length - 2];\n            }\n            \n            if( ouLevels[currentLevel] && ouLevels[currentLevel].level && parent && !initialize ){\n                url = url = DHIS2URL + '/organisationUnits.geojson?level=' + ouLevels[currentLevel].level + '&parent=' + parent;\n            }\n        }\n\n        if( url ){\n            \n            $http.get(url).success(function (data) {\n\n                $scope.currentGeojson = {data: data, style: style, onEachFeature: onEachFeature, pointToLayer: pointToLayer};\n                \n                leafletData.getMap().then(function( map ){\n                    var latlngs = [];\n                    angular.forEach($scope.currentGeojson.data.features, function(feature){                \n                        if( feature.geometry.type === \"Point\"){\n                            //latlngs.push( L.latLng( $scope.currentGeojson.data.features[0].geometry.coordinates) );\n                            //isPoints = true;\n                        }\n                        else{\n                            for (var i in feature.geometry.coordinates) {                        \n                                var coord = feature.geometry.coordinates[i];                    \n                                for (var j in coord) {\n                                    var points = coord[j];\n                                    for (var k in points) {\n                                        latlngs.push(L.GeoJSON.coordsToLatLng(points[k]));\n                                    }\n                                }\n                            }                        \n                        }\n                    });\n                    \n                    if( $scope.location && $scope.location.lat && $scope.location.lng ){\n                        map.setView([$scope.location.lat, $scope.location.lng], $scope.maxZoom);\n                    } \n                    else{\n                        if( latlngs.length > 0 ){                            \n                            map.fitBounds(latlngs, {maxZoom: $scope.maxZoom});\n                        }\n                    }\n                });\n            });\n        }\n    }\n    \n    function zoomMap(event, mode) {\n        if(ouLevels && ouLevels.length > 0){\n            getGeoJsonByOuLevel(false, event, mode);\n        }                    \n    }\n    \n    function setCoordinate(e, feature, layer){\n        if( feature && feature.geometry && feature.geometry.type === 'Point'){\n            var m = feature.geometry.coordinates;            \n            $scope.marker = {m1: {lat: m[1], lng: m[0], draggable: true}};\n        }\n        else{\n            $scope.marker = {m1: {lat: e.latlng.lat, lng: e.latlng.lng, draggable: true}};\n        }\n        \n        $scope.location = {lat: $scope.marker.m1.lat, lng: $scope.marker.m1.lng};\n    };\n    \n    function zoomIn(e, feature){\n        $scope.maxZoom += 2; \n        if( feature && feature.id ){            \n            zoomMap( feature, 'IN');\n        }\n        else{            \n            $scope.center = angular.copy(e.latlng);            \n            $scope.center.zoom = $scope.maxZoom;\n        }        \n    };\n    \n    function zoomOut(e, feature){\n        $scope.maxZoom -= 2;\n        if( feature && feature.id ){             \n            zoomMap( feature, 'OUT');\n        }\n        else{\n            $scope.center = angular.copy(e.latlng);            \n            $scope.center.zoom = $scope.maxZoom;\n        }\n    };\n    \n    function centerMap(e, feature){\n        $scope.maxZoom += 2;\n        $scope.center.lat = e.latlng.lat;\n        $scope.center.lng = e.latlng.lng;\n    };\n    \n    function integrateMapzen(){\n        \n        leafletData.getMap($scope.selectedTileKey).then(function( map ){\n                        \n            if( $scope.marker && $scope.marker.m1 && $scope.marker.m1.lat && $scope.marker.m1.lng ){\n                map.setView([$scope.marker.m1.lat, $scope.marker.m1.lng], $scope.maxZoom);\n            }\n            \n            $scope.geocoder = L.control.geocoder(systemSetting.keyMapzenSearchApiKey,{\n                markers: {\n                    draggable: true\n                }\n            }).addTo(map);            \n            \n            $scope.geocoder.on('select', function (e) {\n                $scope.marker = {m1: {lat: e.latlng.lat, lng: e.latlng.lng, draggable: true}};\n                $scope.location = {lat: e.latlng.lat, lng: e.latlng.lng};\n\n                $scope.geocoder.marker.on('dragend', function(e){                \n                    var c = e.target.getLatLng();\n                    $scope.marker = {m1: {lat: c.lat, lng: c.lng, draggable: true}};\n                    $scope.location = {lat: c.lat, lng: c.lng};\n                });\n            });\n        });\n    }\n    \n    function loadGoogleMapApi() {\n        \n        var deferred = $q.defer();\n        $window.initMap = function() {\n            deferred.resolve();\n        };\n        \n        var script = document.createElement('script'); \n        script.src = 'https://maps.google.com/maps/api/js?callback=initMap&key=' + systemSetting.keyGoogleMapsApiKey;\n        document.body.appendChild(script);\n        return deferred.promise;\n    }\n    \n    getGeoJsonByOuLevel(true);\n    \n    integrateMapzen();\n            \n    $scope.setTile = function( tileKey ){        \n        if( tileKey === $scope.selectedTileKey ){\n            return;\n        }        \n        if( tileKey ){\n            if( tileKey === 'openstreetmap' ){\n                $scope.googleMapLayers = null;\n                $scope.selectedTileKey = tileKey;\n                integrateMapzen();\n            }\n            else if( tileKey === 'googlemap' ){\n                if ($window.google && $window.google.maps) {\n                    $scope.selectedTileKey = tileKey;\n                    integrateMapzen();\n                    \n                }else {\n                    loadGoogleMapApi().then(function () {\n                        $scope.selectedTileKey = tileKey;\n                        integrateMapzen();\n                    }, function () {\n                        console.log('Google map loading failed.');\n                    });\n                }\n            }            \n        }\n    };        \n    \n    $scope.close = function () {\n        $modalInstance.close();\n    };\n    \n    $scope.captureCoordinate = function(){\n        if( $scope.location && $scope.location.lng && $scope.location.lat ){\n            $modalInstance.close( $scope.location );\n    \t}\n    \telse{\n            //notify user\n            NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"nothing_captured\"));\n            return;\n    \t}\n    };\n    \n    function setLocation( args ){\n        if( args ){\n            $scope.marker.m1.lng = args.model.lng;\n            $scope.marker.m1.lat = args.model.lat;\n\n            $scope.location = {lng: args.model.lng, lat: args.model.lat};\n        }\n    }\n    \n    $scope.$on('leafletDirectiveMarker.googlemap.dragend', function (e, args) {\n        setLocation( args );\n    });\n    \n    $scope.$on('leafletDirectiveMarker.openstreetmap.dragend', function (e, args) {\n        setLocation( args );\n    });\n})\n\n//Controller for audit history\n.controller('AuditHistoryController', \n    function ($scope, \n            $modalInstance,\n            $translate,\n            AuditHistoryDataService, \n            DateUtils, \n            eventId, \n            dataType, \n            nameIdMap,\n            optionSets,\n            CommonUtils) {\n\n\n    $scope.model = {type: dataType, \n    \t\t\t\tname: dataType === 'dataElement' ? $translate.instant('data_element') : $translate.instant('attribute'),\n    \t\t\t\tsearchPlaceholder: dataType === 'dataElement' ? $translate.instant('search_by_data_element') : $translate.instant('search_by_attribute'),\n                    auditColumns: ['name', 'auditType', 'value', 'modifiedBy', 'created'], itemList:[], uniqueRows:[]};\n\n    $scope.close = function () {\n        $modalInstance.close();\n    };\n    $scope.model.showStatus=\"waiting\";\n    AuditHistoryDataService.getAuditHistoryData(eventId, dataType).then(function (data) {\n\n        $scope.model.itemList = [];\n        $scope.model.uniqueRows = [];\n        \n        var reponseData = data.trackedEntityDataValueAudits ? data.trackedEntityDataValueAudits :\n            data.trackedEntityAttributeValueAudits ? data.trackedEntityAttributeValueAudits : null;\n\n        if (reponseData) {\n            for (var index = 0; index < reponseData.length; index++) {                \n                var dataValue = reponseData[index];                \n                var audit = {}, obj = {};\n                if (dataType === \"attribute\") {\n                    if (nameIdMap[dataValue.trackedEntityAttribute.id]) {\n                        obj = nameIdMap[dataValue.trackedEntityAttribute.id];\n                        audit.name = obj.displayName;\n                        audit.valueType = obj.valueType;\n                    }\n                } else if (dataType === \"dataElement\") {\n                    if (nameIdMap[dataValue.dataElement.id] && nameIdMap[dataValue.dataElement.id].dataElement) {\n                        obj = nameIdMap[dataValue.dataElement.id].dataElement;\n                        audit.name = obj.displayFormName;\n                        audit.valueType = obj.valueType;\n                    }\n                }\n                \n                dataValue.value = CommonUtils.formatDataValue(null, dataValue.value, obj, optionSets, 'USER');\n                audit.auditType = dataValue.auditType;                \n                audit.value = dataValue.value;\n                audit.modifiedBy = dataValue.modifiedBy;\n                audit.created = DateUtils.formatToHrsMinsSecs(dataValue.created);                \n                \n                $scope.model.itemList.push(audit);\n                if( $scope.model.uniqueRows.indexOf(audit.name) === -1){\n                \t$scope.model.uniqueRows.push(audit.name);\n                }\n                \n                if($scope.model.uniqueRows.length > 0){\n                \t$scope.model.uniqueRows = $scope.model.uniqueRows.sort();\n                }\n            }\n        }\n        if ($scope.model.itemList.length === 0) {\n            $scope.model.showStatus=\"data_unavailable\";\n        } else {\n            $scope.model.showStatus=\"data_available\";\n        }\n    },function(){\n        $scope.model.showStatus=\"data_unavailable\";\n    });\n})\n\n.controller('OrgUnitTreeController', function($scope, $modalInstance, OrgUnitFactory, orgUnitId, orgUnitNames) {\n    \n    $scope.model = {selectedOrgUnitId: orgUnitId ? orgUnitId : null};\n    $scope.orgUnitNames = orgUnitNames;\n\n    function expandOrgUnit( orgUnit, ou ){\n        if( ou.path.indexOf( orgUnit.path ) !== -1 ){\n            orgUnit.show = true;\n        }\n\n        orgUnit.hasChildren = orgUnit.children && orgUnit.children.length > 0 ? true : false;\n        if( orgUnit.hasChildren ){\n            for( var i=0; i< orgUnit.children.length; i++){\n                if( ou.path.indexOf( orgUnit.children[i].path ) !== -1 ){\n                    orgUnit.children[i].show = true;\n                    expandOrgUnit( orgUnit.children[i], ou );\n                }\n            }\n        }\n        return orgUnit;\n    };\n\n    function attachOrgUnit( orgUnits, orgUnit ){\n        for( var i=0; i< orgUnits.length; i++){\n            if( orgUnits[i].id === orgUnit.id ){\n                orgUnits[i] = orgUnit;\n                orgUnits[i].show = true;\n                orgUnits[i].hasChildren = orgUnits[i].children && orgUnits[i].children.length > 0 ? true : false;\n                return;\n            }\n            if( orgUnits[i].children && orgUnits[i].children.length > 0 ){\n                attachOrgUnit(orgUnits[i].children, orgUnit);\n            }\n        }\n        return orgUnits;\n    };\n\n    //Get orgunits for the logged in user\n    OrgUnitFactory.getViewTreeRoot().then(function(response) {\n        $scope.orgUnits = response.organisationUnits;\n        var selectedOuFetched = false;\n        var levelsFetched = 0;\n        angular.forEach($scope.orgUnits, function(ou){\n            ou.show = true;\n            levelsFetched = ou.level;\n            if( orgUnitId && orgUnitId === ou.id ){\n                selectedOuFetched = true;\n            }\n            angular.forEach(ou.children, function(o){\n                levelsFetched = o.level;\n                o.hasChildren = o.children && o.children.length > 0 ? true : false;\n                if( orgUnitId && !selectedOuFetched && orgUnitId === ou.id ){\n                    selectedOuFetched = true;\n                }\n            });\n        });\n\n        levelsFetched = levelsFetched > 0 ? levelsFetched - 1 : levelsFetched;\n\n        if( orgUnitId && !selectedOuFetched ){\n            var parents = null;\n            OrgUnitFactory.get( orgUnitId ).then(function( ou ){\n                if( ou && ou.path ){\n                    parents = ou.path.substring(1, ou.path.length);\n                    parents = parents.split(\"/\");\n                    if( parents && parents.length > 0 ){\n                        var url = \"fields=id,displayName,path,level,\";\n                        for( var i=levelsFetched; i<ou.level; i++){\n                            url = url + \"children[id,displayName,level,path,\";\n                        }\n\n                        url = url.substring(0, url.length-1);\n                        for( var i=levelsFetched; i<ou.level; i++){\n                            url = url + \"]\";\n                        }\n\n                        OrgUnitFactory.getOrgUnits(parents[levelsFetched], url).then(function(response){\n                            if( response && response.organisationUnits && response.organisationUnits[0] ){\n                                response.organisationUnits[0].show = true;\n                                response.organisationUnits[0].hasChildren = response.organisationUnits[0].children && response.organisationUnits[0].children.length > 0 ? true : false;\n                                response.organisationUnits[0] = expandOrgUnit(response.organisationUnits[0], ou );\n                                $scope.orgUnits = attachOrgUnit( $scope.orgUnits, response.organisationUnits[0] );\n                            }\n                        });\n                    }\n                }\n            });\n        }\n    });\n\n\n    //expand/collapse of search orgunit tree\n    $scope.expandCollapse = function(orgUnit) {\n        if( orgUnit.hasChildren ){\n            //Get children for the selected orgUnit\n            OrgUnitFactory.getChildren(orgUnit.id).then(function(ou) {\n                orgUnit.show = !orgUnit.show;\n                orgUnit.hasChildren = false;\n                orgUnit.children = ou.children;\n                angular.forEach(orgUnit.children, function(ou){\n                    ou.hasChildren = ou.children && ou.children.length > 0 ? true : false;\n                });\n            });\n        }\n        else{\n            orgUnit.show = !orgUnit.show;\n        }\n    };\n\n    $scope.setSelectedOrgUnit = function( orgUnit ){\n    \t$scope.model.selectedOrgUnit = {id: orgUnit.id, displayName: orgUnit.displayName};\n        $scope.model.selectedOrgUnitId = orgUnit.id;\n        $scope.orgUnitNames[orgUnit.id] = orgUnit.displayName;\n    };\n\n    $scope.select = function () {\n        $modalInstance.close( {selected: $scope.model.selectedOrgUnit, names: $scope.orgUnitNames} );\n    };\n\n    $scope.close = function(){        \n        $modalInstance.close();\n    };\n});\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/d2-tracker/lib/dhis2.angular.controllers.js\n// module id = 7\n// module chunks = 0","angular.module('d2Templates', []).run(['$templateCache', function($templateCache) {$templateCache.put('./templates/age-input.html','<div ng-form=\"ageForm\">\\n    <div class=\"input-group\" style=\"width: 100%;\">\\n        <input type=\"text\" \\n               popover=\"{{\\'dob\\'| translate}}\"\\n               popover-trigger=\"focus\"\\n               d2-date name=\"dob\" \\n               d2-date-validator\\n               ng-model=\"age.dob\"\\n               blur-or-change=\"saveDOB()\"\\n               ng-required=\"d2Required\"\\n               ng-disabled=\"d2Disabled\"\\n               placeholder=\"{{\\'dob\\'| translate}}\" \\n               title=\"{{\\'dob\\'| translate}}\" \\n               class=\"form-control no-right-radius\"\\n               ng-class=\"{\\'input-success\\': d2AgeSaved}\"/>\\n        <span class=\"input-group-btn empty-span\"></span>\\n        <input type=\"number\" \\n               name=\"years\" \\n               popover=\"{{\\'years\\'| translate}}\"\\n               popover-trigger=\"focus\"\\n               ng-model=\"age.years\" \\n               ng-model-options=\"{updateOn: \\'blur\\'}\"\\n               ng-change=\"saveAge()\"\\n               ng-disabled=\"d2Disabled\"\\n               d2-number-validator\\n               number-type=\"INTEGER_ZERO_OR_POSITIVE\"\\n               placeholder=\"{{\\'years\\'| translate}}\"\\n               title=\"{{\\'years\\'| translate}}\" \\n               class=\"form-control no-right-radius no-left-radius\"\\n               ng-class=\"{\\'input-success\\': d2AgeSaved}\"/>\\n        <span class=\"input-group-btn empty-span\"></span>\\n        <input type=\"number\" \\n               name=\"months\" \\n               popover=\"{{\\'months\\'| translate}}\"\\n               popover-trigger=\"focus\"\\n               ng-model=\"age.months\" \\n               ng-model-options=\"{updateOn: \\'blur\\'}\"\\n               ng-change=\"saveAge()\"\\n               ng-disabled=\"d2Disabled\"\\n               d2-number-validator\\n               number-type=\"INTEGER_ZERO_OR_POSITIVE\"\\n               placeholder=\"{{\\'months\\'| translate}}\"\\n               title=\"{{\\'months\\'| translate}}\" \\n               class=\"form-control no-right-radius no-left-radius\"\\n               ng-class=\"{\\'input-success\\': d2AgeSaved}\"/>\\n        <span class=\"input-group-btn empty-span\"></span>\\n        <input type=\"number\" \\n               name=\"days\" \\n               popover=\"{{\\'days\\'| translate}}\"\\n               popover-trigger=\"focus\"\\n               ng-model=\"age.days\" \\n               ng-model-options=\"{updateOn: \\'blur\\'}\"\\n               ng-change=\"saveAge()\"\\n               ng-disabled=\"d2Disabled\"\\n               d2-number-validator\\n               number-type=\"INTEGER_ZERO_OR_POSITIVE\"\\n               placeholder=\"{{\\'days\\'| translate}}\"\\n               title=\"{{\\'days\\'| translate}}\" \\n               class=\"form-control no-left-radius no-right-radius\"\\n               ng-class=\"{\\'input-success\\': d2AgeSaved}\"/>\\n        <span class=\"input-group-btn\"> \\n            <button class=\"btn btn-danger hideInPrint trim\" type=\"button\" title=\"{{\\'remove\\'| translate}}\" ng-click=\"removeAge()\" ng-disabled=\"!age.dob || d2Disabled\"> \\n                <i class=\"fa fa-trash-o\"></i> \\n            </button>\\n        </span>\\n    </div>\\n    <div ng-messages=\"ageForm.years.$error\" ng-if=\"ageInteracted(ageForm.years)\" class=\"required\" ng-messages-include=\"./templates/error-messages.html\"></div>\\n    <div ng-messages=\"ageForm.months.$error\" ng-if=\"ageInteracted(ageForm.months)\" class=\"required\" ng-messages-include=\"./templates/error-messages.html\"></div>\\n    <div ng-messages=\"ageForm.months.$error\" ng-if=\"ageInteracted(ageForm.days)\" class=\"required\" ng-messages-include=\"./templates/error-messages.html\"></div>\\n</div>');\n$templateCache.put('./templates/audit-history.html','<div class=\"modal-header\">\\n    <h2>{{\\'audit_history\\'| translate}}</h2>\\n</div>\\n<div class=\"modal-body page\" ng-class=\"{\\'waiting-box\\':model.showStatus === \\'waiting\\'}\">\\n    <div ng-if=\"model.showStatus === \\'data_available\\'\">\\n        <span class=\"row\">\\n            <input class=\"form-control col-md-7\" ng-model=\"model.searchText\" placeholder=\"{{model.searchPlaceholder}}\" type=\"search\" />\\n        </span>\\n        <div class=\"scroll\">\\n            <table class=\"listTable dhis2-table-striped-border\">\\n                <thead>\\n                    <tr>\\n                        <th ng-repeat=\"col in model.auditColumns\">\\n                            <span ng-switch=\"col\">\\n                                <span ng-switch-when=\"name\">\\n                                    {{model.name}}\\n                                </span>\\n                                <span ng-switch-default>\\n                                \\t{{col | translate}}\\n                                </span>                                    \\n                            </span>\\n                        </th>\\n                    </tr>\\n                </thead>\\n                <tbody ng-repeat=\"row in model.uniqueRows\">\\n                    <tr ng-repeat=\"item in model.itemList | orderBy: \\'created\\':reverse | filter: {name: row} | filter: {name: model.searchText}\" ng-init=\"rowIndex = $index\">\\n                        <td ng-repeat=\"col in model.auditColumns\"\\n                            rowspan=\"{{(model.itemList | filter: {name: row} | filter: model.searchText).length}}\"\\n                            ng-if=\"col === \\'name\\' && rowIndex === 0\">\\n                            {{item[col]}}\\n                        </td>\\n                        <td class=\"wrap-text\" ng-repeat=\"col in model.auditColumns\" ng-if=\"col !== \\'name\\'\">\\n                        \\t<span ng-if=\"col === \\'value\\'\">\\n                        \\t\\t<span ng-switch=\"item.valueType\">\\n\\t\\t\\t\\t                    <span ng-switch-when=\"BOOLEAN\">\\n\\t\\t\\t\\t                        <span ng-if=\"item[col] === \\'true\\'\">{{\\'yes\\'| translate}}</span>\\n\\t\\t\\t\\t                        <span ng-if=\"item[col] === \\'false\\'\">{{ \\'no\\' | translate}}</span>\\n\\t\\t\\t\\t                    </span>\\n\\t\\t\\t\\t                    <span ng-switch-when=\"TRUE_ONLY\">\\n\\t\\t\\t\\t                        <span ng-if=\"item[col]\">\\n\\t\\t\\t\\t                            <i class=\"fa fa-check\"></i>\\n\\t\\t\\t\\t                        </span>\\n\\t\\t\\t\\t                    </span>\\n\\t\\t\\t\\t                    <span ng-switch-default>{{item[col]}}</span>\\n\\t\\t\\t\\t                </span>\\n                        \\t</span>\\n                        \\t<span ng-if=\"col !== \\'value\\'\">\\n                        \\t\\t{{item[col]}}\\n                        \\t</span>\\n                        \\t                            \\n                        </td>\\n                    </tr>\\n                </tbody>\\n            </table>\\n        </div>\\n    </div>\\n    <div ng-if=\"model.showStatus === \\'data_unavailable\\'\">\\n        <div class=\"alert alert-warning\">{{\\'audit_history_unavailable\\'| translate}}</div>\\n    </div>\\n    <div ng-if=\"model.showStatus === \\'waiting\\'\">\\n        <i class=\"fa fa-spinner fa-spin audit-spinner\"></i>\\n        <div class=\"loading-audit-data\">{{\\'loading-audit-data\\' | translate}}</div>\\n    </div>\\n</div>\\n<div class=\"modal-footer\" ng-if=\"model.showStatus !== \\'waiting\\'\">\\n    <button type=\"button\" class=\"btn btn-default\" data-ng-click=\"close()\">{{\\'close\\'| translate}}</button>\\n</div>');\n$templateCache.put('./templates/coordinate-input.html','<div  ng-form=\"coordinateForm\">\\n    <div class=\"input-group\">\\n        <input type=\"number\" \\n               ng-model=\"coordinateObject.coordinate.latitude\" \\n               placeholder=\"{{\\'latitude\\'| translate}}\"\\n               ng-class=\"{\\'input-success\\': d2LatSaved}\"\\n               name=\"latitude\" \\n               d2-coordinate-validator\\n               ng-required=\"d2Required\"\\n               ng-disabled=\"d2Disabled\"\\n               ng-blur=\"saveD2Coordinate()\"\\n               class=\"form-control no-right-radius\"/>\\n        <span class=\"input-group-btn empty-span\"></span>\\n        <input type=\"number\" \\n               ng-model=\"coordinateObject.coordinate.longitude\" \\n               placeholder=\"{{\\'longitude\\'| translate}}\"\\n               ng-class=\"{\\'input-success\\': d2LngSaved}\"\\n               name=\"longitude\" \\n               d2-coordinate-validator\\n               ng-required=\"d2Required\"\\n               ng-disabled=\"d2Disabled\"\\n               ng-blur=\"saveD2Coordinate()\"\\n               class=\"form-control no-left-radius no-right-radius\"/>\\n        <span class=\"input-group-btn hideInPrint\">\\n            <button class=\"btn btn-grp trim hideInPrint\" \\n                    type=\"button\"\\n                    ng-disabled=\"{{d2Disabled}}\"\\n                    title=\"{{\\'get_from_map\\'| translate}}\"\\n                    ng-click=\"showMap(coordinateObject)\"> \\n                <i class=\"fa fa-map-marker\"></i>                             \\n            </button>\\n        </span>    \\n    </div>\\n    <div ng-messages=\"coordinateForm.latitude.$error\" ng-if=\"coordinateInteracted(coordinateForm.latitude)\" class=\"required\" ng-messages-include=\"./templates/error-messages.html\"></div>\\n    <div ng-messages=\"coordinateForm.longitude.$error\" ng-if=\"coordinateInteracted(coordinateForm.longitude)\" class=\"required\" ng-messages-include=\"./templates/error-messages.html\"></div>\\n</div>');\n$templateCache.put('./templates/custom-dataentry-form.html','<d2-custom-data-entry-form custom-data-entry-form=\"customDataEntryForm\"></d2-custom-data-entry-form>');\n$templateCache.put('./templates/custom-registration-form.html','<d2-custom-registration-form custom-registration-form=\"customRegistrationForm\"></d2-custom-registration-form>');\n$templateCache.put('./templates/error-messages.html','<span ng-message=\"required\">{{\\'required\\' | translate}}</span>\\n<span ng-message=\"number\">{{\\'value_must_be_number\\' | translate}}</span>\\n<span ng-message=\"percentValue\">{{\\'value_must_be_valid_percentValue\\' | translate}}</span>\\n<span ng-message=\"posInt\">{{\\'value_must_be_posInt\\' | translate}}</span>\\n<span ng-message=\"negInt\">{{\\'value_must_be_negInt\\' | translate}}</span>\\n<span ng-message=\"zeroPositiveInt\">{{\\'value_must_be_zeroPositiveInt\\' | translate}}</span>\\n<span ng-message=\"integer\">{{\\'value_must_be_int\\' | translate}}</span>\\n<span ng-message=\"dateValidator\">{{\\'date_required\\' | translate}} ({{dhis2CalendarFormat.keyDateFormat}})</span>\\n<span ng-message=\"futureDateValidator\">{{\\'future_date_not_allowed\\' | translate}}</span>\\n<span ng-message=\"optionValidator\">{{\\'option_required\\' | translate}}</span>\\n<span ng-message=\"latitudeValidator\">{{\\'latitude_required\\' | translate}}</span>\\n<span ng-message=\"longitudeValidator\">{{\\'longitude_required\\' | translate}}</span>\\n<span ng-message=\"customCoordinateValidator\">{{\\'latitude_longitude_required\\' | translate}}</span>\\n<span ng-message=\"uniqunessValidator\">{{\\'value_not_unique\\' | translate}}</span>\\n<span ng-message=\"email\">{{\\'value_must_be_email\\' | translate}}</span>\\n');\n$templateCache.put('./templates/map.html','<div class=\"modal-header\">\\n    <h2>\\n        {{\\'point_and_click_for_coordinate\\'| translate}}        \\n    </h2>\\n    <div class=\"align-center\">\\n        <span id=\\'polygon-label\\'></span>\\n    </div>\\n</div>\\n<div class=\"modal-body map-area\">\\n    <span ng-switch=\"selectedTileKey\">        \\n        <span ng-switch-when=\"openstreetmap\">\\n            <leaflet id=\"openstreetmap\" lf-center=\"center\" geojson=\"currentGeojson\" defaults=\"mapDefaults\" markers=\"marker\" tiles=\"tilesDictionary[selectedTileKey]\"></leaflet>\\n        </span>\\n        <span ng-switch-when=\"googlemap\">\\n            <leaflet id=\"googlemap\" lf-center=\"center\" geojson=\"currentGeojson\" defaults=\"mapDefaults\" markers=\"marker\" layers=\"tilesDictionary[selectedTileKey].layers\"></leaflet>\\n        </span>\\n    </span>\\n</div>\\n<div class=\"modal-footer\">\\n    \\n    <div class=\"pull-left\">\\n        <ul class=\"nav nav-pills\">\\n            <li ng-class=\"{true: \\'active\\'} [selectedTileKey === key]\" ng-repeat=\"key in tilesDictionaryKeys\">\\n                <a href ng-click=\"setTile(key)\">{{key | translate}}</a>\\n            </li>\\n        </ul>\\n    </div>\\n    \\n    <button class=\"btn btn-primary\" data-ng-click=\"captureCoordinate()\">{{\\'capture\\'| translate}}</button>\\n    <button class=\"btn btn-default\" data-ng-click=\"close()\">{{\\'cancel\\'| translate}}</button>        \\n</div>');\n$templateCache.put('./templates/orgunit-input.html','<div class=\"input-group\">    \\n    <input type=\"text\" name=\"foo\" ng-disabled=\"true\" class=\"form-control\" placeholder=\"{{\\'please_select\\' | translate}}\" ng-model=\"d2OrgunitNames[d2Object[id]]\" ng-disabled=\"{{d2Disabled}}\" ng-required=\"{{d2Required}}\"> \\n    <span class=\"input-group-btn\"> \\n        <button class=\"btn btn-danger hideInPrint trim\" type=\"button\" title=\"{{\\'remove\\' | translate}}\" ng-disabled=\"d2Disabled\" ng-click=\"removeSelectedOrgUnit(id)\" ng-if=\"d2Object[id]\"> \\n            <i class=\"fa fa-trash-o\"></i> \\n        </button> \\n        <button class=\"btn btn-default hideInPrint trim\" type=\"button\" title=\"{{\\'get_from_tree\\' | translate}}\" ng-disabled=\"d2Disabled\" ng-click=\"showOrgUnitTree(id)\"> \\n            <i class=\"fa fa-plus-square-o\"></i> \\n        </button> \\n    </span> \\n</div>');\n$templateCache.put('./templates/orgunit-tree.html','<div class=\"modal-header page\">\\n    <h3>{{\\'org_unit\\'| translate}}</h3>\\n</div>\\n<div class=\"modal-body page\">\\n    <div class=\"org-unit-tree\" data-stop-propagation=\"true\">\\n        <script type=\"text/ng-template\" id=\"orgUnitTree.html\">\\n            <span class=\"org-unit-tree-button\" ng-click=\"expandCollapse(orgUnit)\" ng-show=\"orgUnit.show && orgUnit.children.length > 0\"><i class=\"fa fa-minus-square-o\"></i></span>\\n            <span class=\"org-unit-tree-button\" ng-click=\"expandCollapse(orgUnit)\" ng-show=\"(!orgUnit.show && orgUnit.children.length > 0) || (!orgUnit.show && orgUnit.hasChildren)\"><i class=\"fa fa-plus-square-o\"></i></span>\\n            <span class=\"org-unit-tree-button\" ng-click=\"setSelectedOrgUnit(orgUnit)\" ng-class=\"{\\'selected-org-unit\\' : orgUnit.id === model.selectedOrgUnitId}\">{{orgUnit.displayName}}</span>\\n            <ul class=\"tree\" id=\"tree\" ng-show=\"orgUnit.show\">\\n                <li ng-repeat=\"orgUnit in orgUnit.children | orderBy:\\'displayName\\'\" ng-include=\"\\'orgUnitTree.html\\'\"></li>\\n            </ul>\\n        </script>\\n        <ul class=\"tree\" id=\"tree\">\\n            <li ng-repeat=\"orgUnit in orgUnits | orderBy:\\'displayName\\'\" ng-include=\"\\'orgUnitTree.html\\'\"></li>\\n        </ul>\\n    </div>\\n</div>\\n<div class=\"modal-footer page\">\\n    <button class=\"btn btn-primary\" data-ng-click=\"select()\">{{\\'select\\'| translate}}</button>\\n    <button class=\"btn btn-default\" data-ng-click=\"close()\">{{\\'close\\'| translate}}</button>\\n</div>');\n$templateCache.put('./templates/radio-button.html','<!--\\nCopyright (c) 2015, UiO\\nAll rights reserved.\\n\\nRedistribution and use in source and binary forms, with or without\\nmodification, are permitted provided that the following conditions are met:\\n\\n* Redistributions of source code must retain the above copyright notice, this\\n  list of conditions and the following disclaimer.\\n* Redistributions in binary form must reproduce the above copyright notice,\\n  this list of conditions and the following disclaimer in the documentation\\n  and/or other materials provided with the distribution.\\n\\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\\nAND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\\nIMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\\nARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE\\nLIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR\\nCONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\\nSUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\\nINTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\\nCONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\\nARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\\nPOSSIBILITY OF SUCH DAMAGE.\\n-->\\n \\n\\n<div tabindex=\"0\" ng-if=\"!disabled\" class=\"custom-radio-group custom-radio-container\">\\n    <span ng-click=\"valueClicked(\\'true\\')\" class=\"cursor-pointer\">\\n        <span class=\"fa-stack\">                                                                                                        \\n            <span class=\\'fa fa-stack-1x fa-circle radio-default fa-stack-custom-large\\' ng-class=\\'radioButtonColor(\"true\")\\'></span>        \\n            <span class=\"fa fa-stack-1x fa-circle-thin fa-stack-custom-large\"></span>\\n            <span class=\"fa-stack-custom-small\" ng-class=\"radioButtonImage(\\'true\\')\"></span>\\n        </span>\\n        <span class=\"custom-radio-text\">\\n            {{\\'Yes\\' | translate }}\\n        </span>\\n    </span>\\n    &nbsp;&nbsp;    \\n    <span ng-click=\"valueClicked(\\'false\\')\" class=\"cursor-pointer\">\\n        <span class=\"fa-stack\">                                                                                                        \\n            <span class=\\'fa fa-stack-1x fa-circle fa-stack-custom-large\\' ng-class=\\'radioButtonColor(\"false\")\\'></span>                                                    \\n            <span class=\"fa fa-stack-1x fa-circle-thin fa-stack-custom-large\"></span>\\n            <span class=\"fa-stack-custom-small\" ng-class=\"radioButtonImage(\\'false\\')\"></span>\\n        </span>\\n        <span class=\"custom-radio-text\">\\n            {{\\'No\\' | translate }}\\n        </span>        \\n    </span>\\n    <div ng-if=\"status === \\'error\\'\" class=\"custom-radio-error input-error\"><span>{{\\'save failed\\' | translate}}</span></div>\\n    \\n    \\n    <div ng-show=\"false\">\\n        <label class=\"radio-inline\">                                                    \\n            <input class=\"radio-display-none\" ng-required=\"required\" style=\\'margin-top: 1px\\' type=\"radio\" ng-model=\"value\" ng-disabled=\"disabled\" name=\"{{name}}\" value=\"true\">                                                    \\n        </label>                                                \\n        <label class=\"radio-inline\">\\n            <input class=\"radio-display-none\" ng-required=\"required\" style=\\'margin-top: 1px\\' type=\"radio\" ng-model=\"value\" ng-disabled=\"disabled\" name=\"{{name}}\" value=\"false\">\\n        </label>\\n    </div>\\n</div>\\n<div ng-if=\"disabled\" class=\"custom-radio-container\">\\n    <span class=\"fa-icon-width\" ng-class=\"getDisabledIcon(value)\"></span>\\n    <span>{{getDisabledValue(value) | translate}}</span>         \\n</div>');\n$templateCache.put('./templates/radio-input.html','<span ng-repeat=\"option in d2Options\" \\n      class=\"col-sm-12 form-control cursor-pointer\" \\n      ng-disabled=\"d2Disabled\"\\n      ng-class=\"{\\'input-success\\': d2ValueSaved && model.radio === option.displayName}\"\\n      ng-click=\"saveValue(option.displayName)\">\\n    <span class=\"fa fa-circle-thin fa-stack-custom-large\" ng-if=\"option.displayName !== model.radio\"></span> \\n    <span class=\"fa fa-dot-circle-o fa-stack-custom-large\" ng-if=\"option.displayName === model.radio\"></span> \\n    {{option.displayName}}\\n</span>\\n\\n\\n<span ng-show=\"false\">\\n    <label ng-repeat=\"option in d2Options\" class=\"radio-display-none\">\\n    <input type=\"radio\" \\n           name=\"{{name}}\"\\n           ng-required=\"d2Required\"\\n           ng-disabled=\"d2Disabled\"\\n           ng-model=\"model.radio\"\\n           value=\"{{option.displayName}}\"> {{option.displayName}}\\n    </label>    \\n</span>');\n$templateCache.put('./templates/serverside-pagination.html','<div class=\"paging-container\">\\n    <table style=\"background-color: #ebf0f6;\" width=\\'100%\\'>\\n        <tr>\\n            <td>\\n                {{\\'total_number_of_pages\\'| translate}}: {{pager.pageCount}}\\n            </td>\\n            <td>\\n                <span>{{\\'rows_per_page\\'| translate}}:</span> <input type=\"text\" min=\"1\" style=\"width:50px;\" ng-model=\"pager.pageSize\" d2-enter=\"resetPageSize()\" ng-blur=\"resetPageSize()\"> \\n            </td>\\n            <td>\\n                <span>{{\\'jump_to_page\\'| translate}}:</span> <input type=\"text\" min=\"1\" style=\"width:50px;\" ng-model=\"pager.page\" d2-enter=\"jumpToPage()\" ng-blur=\"jumpToPage()\"> \\n            </td>\\n        </tr>\\n        <tr>\\n            <td colspan=\"3\"><hr/></td>\\n        </tr>\\n        <tr>\\n            <td colspan=\"3\">\\n                <div class=\"paging\">\\n                    <span ng-show=\"pager.page > 1\">\\n                        <a href ng-click=\"getPage(1)\" title=\"{{\\'first\\'| translate}}\"> \\n                            &laquo;&laquo;\\n                        </a>\\n                        <a href ng-click=\"getPage(pager.page - 1)\" title=\"{{\\'previous\\'| translate}}\"> \\n                            &laquo;\\n                        </a>                    \\n                    </span>\\n                    <span ng-hide=\"pager.page > 1\">\\n                        <span title=\"{{\\'first\\'| translate}}\">&laquo;&laquo;</span>\\n                        <span title=\"{{\\'previous\\'| translate}}\">&laquo;</span>\\n                    </span>\\n                    <a href ng-click=\"getPage(i+1)\" title=\"{{\\'page\\'| translate}} {{i + 1}}\" ng-repeat=\"i in []| forLoop:paginator.lowerLimit():pager.pageCount | limitTo : pager.toolBarDisplay\" ng-class=\"pager.page == i + 1 && \\'active\\'\">\\n                        {{i + 1}}\\n                    </a>\\n\\n                    <span ng-show=\"pager.page < pager.pageCount\">\\n                        <a href ng-click=\"getPage(pager.page + 1)\" title=\"{{\\'next\\'| translate}}\" > \\n                            &raquo;\\n                        </a>\\n                        <a href ng-click=\"getPage(pager.pageCount)\" title=\"{{\\'last\\'| translate}}\"> \\n                            &raquo;&raquo;\\n                        </a>\\n                    </span>\\n                    <span ng-hide=\"pager.page < pager.pageCount\">\\n                        <span class=\"next\" title=\"{{\\'next\\'| translate}}\">&raquo; </span>\\n                        <span class=\"last\" title=\"{{\\'last\\'| translate}}\">&raquo;&raquo;</span>\\n                    </span>\\n                </div>\\n            </td>\\n        </tr>\\n    </table>   \\n</div>');}]);\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/d2-tracker/lib/dhis2.angular.templates.js\n// module id = 8\n// module chunks = 0","/* global angular, moment, dhis2 */\r\n\r\n'use strict';\r\n\r\n/* Services */\r\n\r\nvar trackerCaptureServices = angular.module('trackerCaptureServices', ['ngResource'])\r\n\r\n.factory('TCStorageService', function(){\r\n    var store = new dhis2.storage.Store({\r\n        name: \"dhis2tc\",\r\n        adapters: [dhis2.storage.IndexedDBAdapter, dhis2.storage.DomSessionStorageAdapter, dhis2.storage.InMemoryAdapter],        \r\n        objectStores: ['programs', 'trackedEntities', 'attributes', 'relationshipTypes', 'optionSets', 'programValidations', 'programIndicators', 'ouLevels', 'programRuleVariables', 'programRules','constants', 'dataElements']\r\n    });\r\n    return{\r\n        currentStore: store\r\n    };\r\n})\r\n\r\n/* Service to fetch/store dasboard widgets */\r\n.service('DashboardLayoutService', function($http, DHIS2URL, NotificationService, $translate) {\r\n    \r\n    var ButtonIds = { Complete: \"Complete\", Incomplete: \"Incomplete\", Validate: \"Validate\", Delete: \"Delete\", Skip: \"Skip\", Unskip: \"Unskip\", Note: \"Note\" };\r\n      \r\n    var w = {};\r\n    w.enrollmentWidget = {title: 'enrollment', view: \"components/enrollment/enrollment.html\", show: true, expand: true, parent: 'biggerWidget', order: 0};\r\n    w.indicatorWidget = {title: 'indicators', view: \"components/rulebound/rulebound.html\", show: true, expand: true, parent: 'biggerWidget', order: 1};\r\n    w.dataentryWidget = {title: 'dataentry', view: \"components/dataentry/dataentry.html\", show: true, expand: true, parent: 'biggerWidget', order: 2};\r\n    w.dataentryTabularWidget = {title: 'dataentryTabular', view: \"components/dataentry/dataentry-tabular-layout.html\", show: false, expand: true, parent: 'biggerWidget', order: 3};\r\n    w.reportWidget = {title: 'report', view: \"components/report/tei-report.html\", show: true, expand: true, parent: 'biggerWidget', order: 4};\r\n    w.selectedWidget = {title: 'current_selections', view: \"components/selected/selected.html\", show: false, expand: true, parent: 'smallerWidget', order: 0};\r\n    w.feedbackWidget = {title: 'feedback', view: \"components/rulebound/rulebound.html\", show: true, expand: true, parent: 'smallerWidget', order: 1};\r\n    w.profileWidget = {title: 'profile', view: \"components/profile/profile.html\", show: true, expand: true, parent: 'smallerWidget', order: 2};    \r\n    w.relationshipWidget = {title: 'relationships', view: \"components/relationship/relationship.html\", show: true, expand: true, parent: 'smallerWidget', order: 3};\r\n    w.notesWidget = {title: 'notes', view: \"components/notes/notes.html\", show: true, expand: true, parent: 'smallerWidget', order: 4};\r\n    w.messagingWidget = {title: 'messaging', view: \"components/messaging/messaging.html\", show: false, expand: true, parent: 'smallerWidget', order: 5};\r\n    var defaultLayout = new Object();\r\n    \r\n    defaultLayout['DEFAULT'] = {widgets: w, program: 'DEFAULT'};\r\n    \r\n    var getDefaultLayout = function(customLayout){\r\n        var dashboardLayout = {customLayout: customLayout, defaultLayout: defaultLayout};        \r\n        var promise = $http.get(  DHIS2URL + '/systemSettings/keyTrackerDashboardDefaultLayout' ).then(function(response){\r\n            angular.extend(dashboardLayout.defaultLayout, response.data);\r\n            return dashboardLayout;\r\n        }, function(){\r\n            if(!dashboardLayout.customLayout){\r\n                NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"dashboard_layout_not_fetched\"));\r\n            }\r\n            return dashboardLayout;\r\n        });\r\n        return promise;        \r\n    };\r\n    \r\n    return {\r\n        saveLayout: function(dashboardLayout, saveAsDefault){\r\n            var url = saveAsDefault ? DHIS2URL + '/systemSettings/keyTrackerDashboardDefaultLayout' : DHIS2URL + '/userSettings/keyTrackerDashboardLayout';\r\n            var promise = $http({\r\n                method: \"post\",\r\n                url: url,\r\n                data: dashboardLayout,\r\n                headers: {'Content-Type': 'text/plain;charset=utf-8'}\r\n            }).then(function(response){\r\n                return response.data;\r\n            },function(error){\r\n                var errorMsgHdr, errorMsgBody;\r\n                errorMsgHdr = $translate.instant(\"error\");\r\n                if(saveAsDefault) {\r\n                    errorMsgBody = $translate.instant(\"dashboard_layout_not_saved_as_default\");\r\n                } else {\r\n                    errorMsgBody = $translate.instant(\"dashboard_layout_not_saved\");\r\n                }\r\n                NotificationService.showNotifcationDialog(errorMsgHdr, errorMsgBody);\r\n                return null;\r\n            });\r\n            return promise;            \r\n        },\r\n        get: function(){\r\n            var promise = $http.get(  DHIS2URL + '/userSettings/keyTrackerDashboardLayout' ).then(function(response){\r\n                return getDefaultLayout(response.data);\r\n            }, function(){\r\n                return getDefaultLayout(null);\r\n            });\r\n            return promise;\r\n        }\r\n    };\r\n})\r\n\r\n.service('DasboardWidgetService', function() {\r\n    var dashboardUpdateCallback;\r\n    var numberOfWidgetsReady = 0;\r\n    return {\r\n        registerDashboardUpdateCallback: function (callback) {\r\n            numberOfWidgetsReady = 0;\r\n            dashboardUpdateCallback = callback;\r\n        },\r\n        updateDashboard: function () {\r\n            numberOfWidgetsReady++;\r\n            dashboardUpdateCallback(numberOfWidgetsReady);\r\n        }\r\n    }\r\n})\r\n\r\n/* current selections */\r\n.service('PeriodService', function(DateUtils, CalendarService, $filter){\r\n\r\n    var calendarSetting = CalendarService.getSetting();    \r\n    \r\n    var splitDate = function(dateValue){\r\n        if(!dateValue){\r\n            return;\r\n        }\r\n        var calendarSetting = CalendarService.getSetting();            \r\n\r\n        return {year: moment(dateValue, calendarSetting.momentFormat).year(), month: moment(dateValue, calendarSetting.momentFormat).month(), week: moment(dateValue, calendarSetting.momentFormat).week(), day: moment(dateValue, calendarSetting.momentFormat).day()};\r\n    };\r\n    \r\n    function processPeriodsForEvent(periods,event){\r\n        var index = -1;\r\n        var occupied = null;\r\n        for(var i=0; i<periods.length && index === -1; i++){\r\n            if(moment(periods[i].endDate).isSame(event.sortingDate) ||\r\n                    moment(periods[i].startDate).isSame(event.sortingDate) ||\r\n                    moment(periods[i].endDate).isAfter(event.sortingDate) && moment(event.sortingDate).isAfter(periods[i].endDate)){\r\n                index = i;\r\n                occupied = angular.copy(periods[i]);\r\n            }\r\n        }\r\n        \r\n        if(index !== -1){\r\n            periods.splice(index,1);\r\n        }\r\n        \r\n        return {available: periods, occupied: occupied};\r\n    };\r\n    \r\n    this.getPeriods = function(events, stage, enrollment, _periodOffset){\r\n     \r\n        if(!stage || !enrollment){\r\n            return;\r\n        }\r\n        \r\n        var referenceDate = enrollment.incidentDate ? enrollment.incidentDate : enrollment.enrollmentDate;\r\n        var offset = stage.minDaysFromStart;\r\n        \r\n        if(stage.generatedByEnrollmentDate){\r\n            referenceDate = enrollment.enrollmentDate;\r\n        }        \r\n               \r\n        var occupiedPeriods = [];\r\n        var availablePeriods = [];\r\n        var hasFuturePeriod = false;\r\n        if(!stage.periodType){\r\n            angular.forEach(events, function(event){\r\n                occupiedPeriods.push({event: event.event, name: event.sortingDate, stage: stage.id});\r\n            });            \r\n        }\r\n        else{\r\n\r\n            var startDate = DateUtils.format( moment(referenceDate, calendarSetting.momentFormat).add(offset, 'days') );\r\n            var periodOffset = _periodOffset && dhis2.validation.isNumber( _periodOffset ) ? _periodOffset : splitDate(startDate).year - splitDate(DateUtils.getToday()).year;\r\n            var eventDateOffSet = moment(referenceDate, calendarSetting.momentFormat).add('d', offset)._d;\r\n            eventDateOffSet = $filter('date')(eventDateOffSet, calendarSetting.keyDateFormat);\r\n            \r\n            //generate availablePeriods\r\n            var pt = new PeriodType();\r\n            var d2Periods = pt.get(stage.periodType).generatePeriods({offset: periodOffset, filterFuturePeriods: false, reversePeriods: false});\r\n            \r\n            angular.forEach(d2Periods, function(p){\r\n                p.endDate = DateUtils.formatFromApiToUser(p.endDate);\r\n                p.startDate = DateUtils.formatFromApiToUser(p.startDate);\r\n                \r\n                if(moment(p.endDate, calendarSetting.momentFormat).isAfter(moment(eventDateOffSet,calendarSetting.momentFormat))){\r\n                    availablePeriods.push( p );\r\n                }\r\n                \r\n                if( !hasFuturePeriod && moment(p.endDate, calendarSetting.momentFormat).isAfter(DateUtils.getToday())){                    \r\n                    hasFuturePeriod = true;\r\n                }\r\n            });                \r\n\r\n            //get occupied periods\r\n            angular.forEach(events, function(event){\r\n                var ps = processPeriodsForEvent(availablePeriods, event);\r\n                availablePeriods = ps.available;\r\n                if(ps.occupied){\r\n                    occupiedPeriods.push(ps.occupied);\r\n                }\r\n            });\r\n        }\r\n        \r\n        return {occupiedPeriods: occupiedPeriods, availablePeriods: availablePeriods, periodOffset: periodOffset, hasFuturePeriod: hasFuturePeriod};\r\n    };\r\n    \r\n    this.managePeriods = function( periods, isNewEvent ){\r\n        \r\n        //remove future periods\r\n        if( isNewEvent ){                        \r\n            periods = $filter('removeFuturePeriod')(periods, {endDate: DateUtils.getToday()});            \r\n        }\r\n        \r\n        return periods;\r\n    };\r\n})\r\n\r\n/* Factory to fetch optionSets */\r\n.factory('OptionSetService', function($q, $rootScope, TCStorageService) { \r\n    return {\r\n        getAll: function(){\r\n            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.getAll('optionSets').done(function(optionSets){\r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(optionSets);\r\n                    });                    \r\n                });\r\n            });            \r\n            \r\n            return def.promise;            \r\n        },\r\n        get: function(uid){\r\n            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.get('optionSets', uid).done(function(optionSet){                    \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(optionSet);\r\n                    });\r\n                });\r\n            });                        \r\n            return def.promise;            \r\n        },        \r\n        getCode: function(options, key){\r\n            if(options){\r\n                for(var i=0; i<options.length; i++){\r\n                    if( key === options[i].displayName){\r\n                        return options[i].code;\r\n                    }\r\n                }\r\n            }            \r\n            return key;\r\n        },        \r\n        getName: function(options, key){\r\n            if(options){\r\n                for(var i=0; i<options.length; i++){                    \r\n                    if( key === options[i].code){\r\n                        return options[i].displayName;\r\n                    }\r\n                }\r\n            }            \r\n            return key;\r\n        }\r\n    };\r\n})\r\n\r\n/* Factory to fetch relationships */\r\n.factory('RelationshipFactory', function($q, $rootScope, TCStorageService) { \r\n    return {\r\n        getAll: function(){\r\n            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.getAll('relationshipTypes').done(function(relationshipTypes){\r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(relationshipTypes);\r\n                    });                    \r\n                });\r\n            });            \r\n            \r\n            return def.promise;            \r\n        },\r\n        get: function(uid){\r\n            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.get('relationshipTypes', uid).done(function(relationshipType){                    \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(relationshipType);\r\n                    });\r\n                });\r\n            });                        \r\n            return def.promise;            \r\n        }\r\n    };\r\n})\r\n\r\n/* Factory to fetch programs */\r\n.factory('ProgramFactory', function($q, $rootScope, $location, SessionStorageService, TCStorageService, orderByFilter, OrgUnitFactory, CommonUtils) { \r\n\r\n    return {        \r\n        \r\n        getAll: function(){\r\n            \r\n            var roles = SessionStorageService.get('USER_PROFILE');\r\n            var userRoles = roles && roles.userCredentials && roles.userCredentials.userRoles ? roles.userCredentials.userRoles : [];\r\n            var def = $q.defer();\r\n            OrgUnitFactory.getOrgUnit(($location.search()).ou).then(function (orgUnit) {\r\n                var ou = orgUnit;\r\n\r\n                TCStorageService.currentStore.open().done(function () {\r\n                    TCStorageService.currentStore.getAll('programs').done(function (prs) {\r\n                        var programs = [];\r\n                        angular.forEach(prs, function (pr) {\r\n                            if (pr.organisationUnits.hasOwnProperty(ou.id) && CommonUtils.userHasValidRole(pr, 'programs', userRoles)) {\r\n                                programs.push(pr);\r\n                            }\r\n                        });\r\n                        $rootScope.$apply(function () {\r\n                            def.resolve(programs);\r\n                        });\r\n                    });\r\n                });\r\n\t\t\t});\r\n            \r\n            return def.promise;            \r\n        },\r\n        getAllForUser: function(selectedProgram){\r\n            var roles = SessionStorageService.get('USER_PROFILE');\r\n            var userRoles = roles && roles.userCredentials && roles.userCredentials.userRoles ? roles.userCredentials.userRoles : [];\r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.getAll('programs').done(function(prs){\r\n                    var programs = [];\r\n                    angular.forEach(prs, function(pr){                            \r\n                        if(CommonUtils.userHasValidRole(pr, 'programs', userRoles)){\r\n                            programs.push(pr);\r\n                        }\r\n                    });\r\n                    \r\n                    programs = orderByFilter(programs, '-displayName').reverse();\r\n                    \r\n                    if(programs.length === 0){\r\n                        selectedProgram = null;\r\n                    }\r\n                    else if(programs.length === 1){\r\n                        selectedProgram = programs[0];\r\n                    } \r\n                    else{\r\n                        if(selectedProgram){\r\n                            var continueLoop = true;\r\n                            for(var i=0; i<programs.length && continueLoop; i++){\r\n                                if(programs[i].id === selectedProgram.id){                                \r\n                                    selectedProgram = programs[i];\r\n                                    continueLoop = false;\r\n                                }\r\n                            }\r\n                            if(continueLoop){\r\n                                selectedProgram = null;\r\n                            }\r\n                        }\r\n                    }\r\n                        \r\n                    if(!selectedProgram || angular.isUndefined(selectedProgram) && programs.legth > 0){\r\n                        selectedProgram = programs[0];\r\n                    }\r\n                    \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve({programs: programs, selectedProgram: selectedProgram});\r\n                    });                      \r\n                });\r\n            });\r\n            \r\n            return def.promise;\r\n        },\r\n        get: function(uid){\r\n            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.get('programs', uid).done(function(pr){                    \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(pr);\r\n                    });\r\n                });\r\n            });                        \r\n            return def.promise;            \r\n        },\r\n        getProgramsByOu: function(ou, selectedProgram){\r\n            var roles = SessionStorageService.get('USER_PROFILE');\r\n            var userRoles = roles && roles.userCredentials && roles.userCredentials.userRoles ? roles.userCredentials.userRoles : [];\r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.getAll('programs').done(function(prs){\r\n                    var programs = [];\r\n                    angular.forEach(prs, function(pr){                            \r\n                        if(pr.organisationUnits.hasOwnProperty( ou.id ) && CommonUtils.userHasValidRole(pr, 'programs', userRoles)){\r\n                            programs.push(pr);\r\n                        }\r\n                    });\r\n                    \r\n                    programs = orderByFilter(programs, '-displayName').reverse();\r\n                    \r\n                    if(programs.length === 0){\r\n                        selectedProgram = null;\r\n                    }\r\n                    else if(programs.length === 1){\r\n                        selectedProgram = programs[0];\r\n                    } \r\n                    else{\r\n                        if(selectedProgram){\r\n                            var continueLoop = true;\r\n                            for(var i=0; i<programs.length && continueLoop; i++){\r\n                                if(programs[i].id === selectedProgram.id){                                \r\n                                    selectedProgram = programs[i];\r\n                                    continueLoop = false;\r\n                                }\r\n                            }\r\n                            if(continueLoop){\r\n                                selectedProgram = null;\r\n                            }\r\n                        }\r\n                    }\r\n                                        \r\n                    if(!selectedProgram || angular.isUndefined(selectedProgram) && programs.legth > 0){\r\n                        selectedProgram = programs[0];\r\n                    }\r\n                    \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve({programs: programs, selectedProgram: selectedProgram});\r\n                    });                      \r\n                });\r\n            });\r\n            \r\n            return def.promise;\r\n        }\r\n    };\r\n})\r\n\r\n/* Factory to fetch programValidations */\r\n.factory('ProgramValidationFactory', function($q, $rootScope, TCStorageService) {  \r\n    \r\n    return {        \r\n        get: function(uid){\r\n            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.get('programValidations', uid).done(function(pv){                    \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(pv);\r\n                    });\r\n                });\r\n            });                        \r\n            return def.promise;\r\n        },\r\n        getByProgram: function(program){\r\n            var def = $q.defer();\r\n            var programValidations = [];\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.getAll('programValidations').done(function(pvs){   \r\n                    angular.forEach(pvs, function(pv){\r\n                        if(pv.program.id === program){                            \r\n                            programValidations.push(pv);                               \r\n                        }                        \r\n                    });\r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(programValidations);\r\n                    });\r\n                });                \r\n            });            \r\n            return def.promise;\r\n        }\r\n    };        \r\n})\r\n\r\n/* service to deal with TEI registration and update */\r\n.service('RegistrationService', function(TEIService, $q){\r\n    return {\r\n        registerOrUpdate: function(tei, optionSets, attributesById){\r\n            if(tei){\r\n                var def = $q.defer();\r\n                if(tei.trackedEntityInstance){\r\n                    TEIService.update(tei, optionSets, attributesById).then(function(response){\r\n                        def.resolve(response); \r\n                    });\r\n                }\r\n                else{\r\n                    TEIService.register(tei, optionSets, attributesById).then(function(response){\r\n                        def.resolve(response); \r\n                    });\r\n                }\r\n                return def.promise;\r\n            }            \r\n        },\r\n        processForm: function(existingTei, formTei, originalTei, attributesById){\r\n            var tei = angular.copy(existingTei);            \r\n            tei.attributes = [];\r\n            var formEmpty = true;            \r\n            for(var k in attributesById){\r\n                if(originalTei && formTei[k] !== originalTei[k] && !formTei[k] && !originalTei[k]){\r\n                    formChanged = true;\r\n                }\r\n                if( formTei[k] ){\r\n                    var att = attributesById[k];\r\n                    tei.attributes.push({attribute: att.id, value: formTei[k], displayName: att.displayName, valueType: att.valueType});\r\n                    formEmpty = false;              \r\n                }\r\n                delete tei[k];\r\n            }\r\n            formTei.attributes = tei.attributes;\r\n            \r\n            var formChanged = false;\r\n            for(var k in attributesById){                \r\n                if(originalTei && formTei[k] !== originalTei[k]){\r\n                    if(!formEmpty){\r\n                        formChanged = true;\r\n                        break;\r\n                    }\r\n                    if(formEmpty && (formTei[k] || originalTei[k]) ){\r\n                        formChanged = true;\r\n                        break;\r\n                    }                    \r\n                }\r\n            }\r\n            if (originalTei) {\r\n                angular.forEach(originalTei.attributes, function (att) {\r\n                    if (tei[att.attribute]) {\r\n                        delete tei[att.attribute];\r\n                    }\r\n                });\r\n            }\r\n            return {tei: tei, formEmpty: formEmpty, formChanged: formChanged};\r\n        }\r\n    };\r\n})\r\n\r\n/* Service to deal with enrollment */\r\n.service('EnrollmentService', function($http, DHIS2URL, DateUtils, NotificationService, $translate) {\r\n    \r\n    var convertFromApiToUser = function(enrollment){\r\n        if(enrollment.enrollments){\r\n            angular.forEach(enrollment.enrollments, function(enrollment){\r\n                enrollment.incidentDate = DateUtils.formatFromApiToUser(enrollment.incidentDate);\r\n                enrollment.enrollmentDate = DateUtils.formatFromApiToUser(enrollment.enrollmentDate);                \r\n            });\r\n        }\r\n        else{\r\n            enrollment.incidentDate = DateUtils.formatFromApiToUser(enrollment.incidentDate);\r\n            enrollment.enrollmentDate = DateUtils.formatFromApiToUser(enrollment.enrollmentDate);\r\n        }\r\n        \r\n        return enrollment;\r\n    };\r\n    var convertFromUserToApi = function(enrollment){\r\n        enrollment.incidentDate = DateUtils.formatFromUserToApi(enrollment.incidentDate);\r\n        enrollment.enrollmentDate = DateUtils.formatFromUserToApi(enrollment.enrollmentDate);\r\n        delete enrollment.orgUnitName;\r\n        return enrollment;\r\n    };\r\n    var errorHeader = $translate.instant(\"error\");\r\n    return {        \r\n        get: function( enrollmentUid ){\r\n            var promise = $http.get(  DHIS2URL + '/enrollments/' + enrollmentUid ).then(function(response){\r\n                return convertFromApiToUser(response.data);\r\n            },function(response){\r\n                var errorBody = $translate.instant('failed_to_fetch_enrollment');\r\n                if (response && response.data && response.data.status === 'ERROR') {\r\n                    if (response.data.message) {\r\n                        errorBody = response.data.message\r\n                    }\r\n                }\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        getByEntity: function( entity ){\r\n            var promise = $http.get(  DHIS2URL + '/enrollments.json?ouMode=ACCESSIBLE&trackedEntityInstance=' + entity + '&fields=:all&paging=false').then(function(response){\r\n                return convertFromApiToUser(response.data);\r\n            },function(response){\r\n                var errorBody = $translate.instant('failed_to_fetch_enrollment');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        getByEntityAndProgram: function( entity, program ){\r\n            var promise = $http.get(  DHIS2URL + '/enrollments.json?ouMode=ACCESSIBLE&trackedEntityInstance=' + entity + '&program=' + program + '&fields=:all&paging=false').then(function(response){\r\n                return convertFromApiToUser(response.data);\r\n            }, function(response){\r\n                var errorBody = $translate.instant('failed_to_fetch_enrollment');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        getByStartAndEndDate: function( program, orgUnit, ouMode, startDate, endDate ){\r\n            var promise = $http.get(  DHIS2URL + '/enrollments.json?ouMode=ACCESSIBLE&program=' + program + '&orgUnit=' + orgUnit + '&ouMode='+ ouMode + '&startDate=' + startDate + '&endDate=' + endDate + '&fields=:all&paging=false').then(function(response){\r\n                return convertFromApiToUser(response.data);\r\n            }, function(response){\r\n                var errorBody = $translate.instant('failed_to_fetch_enrollment');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        enroll: function( enrollment ){\r\n            var en = convertFromUserToApi(angular.copy(enrollment));\r\n            var promise = $http.post(  DHIS2URL + '/enrollments', en ).then(function(response){\r\n                return response.data;\r\n            }, function(response){\r\n                var errorBody = $translate.instant('failed_to_save_enrollment');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        update: function( enrollment ){\r\n            var en = convertFromUserToApi(angular.copy(enrollment));\r\n            delete en.notes;\r\n            var promise = $http.put( DHIS2URL + '/enrollments/' + en.enrollment , en ).then(function(response){\r\n                return response.data;\r\n            }, function(response){\r\n                var errorBody = $translate.instant('failed_to_update_enrollment');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        delete: function( enrollmentUid ){\r\n            var promise = $http.delete(DHIS2URL + '/enrollments/' + enrollmentUid).then(function(response){\r\n                return response.data;               \r\n            }, function (response) {\r\n                if (response && response.data && response.data.status === 'ERROR') {\r\n                    var errorBody = $translate.instant('failed_to_delete_enrollment');\r\n                    NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                }\r\n                \r\n                return response.data;\r\n            });\r\n            return promise;           \r\n        },\r\n        updateForNote: function( enrollment ){\r\n            var promise = $http.post(DHIS2URL + '/enrollments/' + enrollment.enrollment + '/note', enrollment).then(function(response){\r\n                return response.data;         \r\n            }, function(response){\r\n                var errorBody = $translate.instant('failed_to_update_enrollment');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        }\r\n    };   \r\n})\r\n\r\n/* Service for getting tracked entity */\r\n.factory('TEService', function(TCStorageService, $q, $rootScope) {\r\n\r\n    return {        \r\n        getAll: function(){            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.getAll('trackedEntities').done(function(entities){\r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(entities);\r\n                    });                    \r\n                });\r\n            });            \r\n            return def.promise;\r\n        },\r\n        get: function(uid){            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.get('trackedEntities', uid).done(function(te){                    \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(te);\r\n                    });\r\n                });\r\n            });                        \r\n            return def.promise;            \r\n        }\r\n    };\r\n})\r\n\r\n/* Service for getting tracked entity instances */\r\n.factory('TEIService', function($http, $translate, DHIS2URL, $q, AttributesFactory, CommonUtils, CurrentSelection, DateUtils, NotificationService ) {\r\n    var errorHeader = $translate.instant(\"error\");\r\n    return {\r\n        get: function(entityUid, optionSets, attributesById){\r\n            var promise = $http.get( DHIS2URL + '/trackedEntityInstances/' +  entityUid + '.json').then(function(response){\r\n                var tei = response.data;\r\n                angular.forEach(tei.attributes, function(att){\r\n                    if(attributesById[att.attribute]){\r\n                        att.displayName = attributesById[att.attribute].displayName;                        \r\n                        att.value = CommonUtils.formatDataValue(null, att.value, attributesById[att.attribute], optionSets, 'USER');\r\n                    }\r\n                });\r\n                return tei;\r\n            }, function(error){\r\n                if(error){\r\n                    var headerText = errorHeader;\r\n                    var bodyText = $translate.instant('access_denied');\r\n\r\n                    if(error.statusText) {\r\n                        headerText = error.statusText;\r\n                    }\r\n                    if(error.data && error.data.message) {\r\n                        bodyText = error.data.message;\r\n                    }\r\n                    NotificationService.showNotifcationDialog( headerText,  bodyText);\r\n                }\r\n            });\r\n            \r\n            return promise;\r\n        },\r\n        delete: function(entityUid){\r\n            var promise = $http.delete(DHIS2URL + '/trackedEntityInstances/' + entityUid).then(function(response){\r\n                return response.data;               \r\n            }, function (response) {\r\n                var errorBody;\r\n                if (response && response.data && response.data.status === 'ERROR') {\r\n                    errorBody = $translate.instant('delete_error_audit');\r\n                    NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                }\r\n                \r\n                return response.data;\r\n            });\r\n            return promise;           \r\n        },\r\n        search: function(ouId, ouMode, queryUrl, programUrl, attributeUrl, pager, paging, format, attributesList, attrNamesIdMap, optionSets) {\r\n            var url;\r\n            var deferred = $q.defer();\r\n\r\n            if (format === \"csv\") {\r\n                url = DHIS2URL + '/trackedEntityInstances/query.csv?ou=' + ouId + '&ouMode=' + ouMode;\r\n            } else if (format === \"xml\") {\r\n                url = DHIS2URL + '/trackedEntityInstances/query.json?ou=' + ouId + '&ouMode=' + ouMode;\r\n            }else {\r\n                url = DHIS2URL + '/trackedEntityInstances/query.json?ou=' + ouId + '&ouMode=' + ouMode;\r\n            }\r\n            \r\n            if(queryUrl){\r\n                url = url + '&'+ queryUrl;\r\n            }\r\n            if(programUrl){\r\n                url = url + '&' + programUrl;\r\n            }\r\n            if(attributeUrl){\r\n                url = url + '&' + attributeUrl;\r\n            }\r\n            if(paging){\r\n                var pgSize = pager ? pager.pageSize : 50;\r\n                var pg = pager ? pager.page : 1;\r\n                pgSize = pgSize > 1 ? pgSize  : 1;\r\n                pg = pg > 1 ? pg : 1;\r\n                url = url + '&pageSize=' + pgSize + '&page=' + pg + '&totalPages=true';\r\n            }\r\n            else{\r\n                url = url + '&paging=false';\r\n            }\r\n            \r\n            $http.get( url ).then(function(response){\r\n                var xmlData, rows, headers, index, itemName, value, jsonData;\r\n                var trackedEntityInstance, attributesById;\r\n                if (format) {\r\n                    attributesById = CurrentSelection.getAttributesById();\r\n                    if (format === \"json\") {\r\n                        jsonData = {\"trackedEntityInstances\": []};\r\n                        rows = response.data.rows;\r\n                        headers = response.data.headers;\r\n                        for (var i = 0; i < rows.length; i++) {\r\n                            trackedEntityInstance = null;\r\n                            for (var j = 0; j < rows[i].length; j++) {\r\n                                index = attributesList.indexOf(headers[j].name);\r\n                                itemName = headers[j].column;\r\n                                value = rows[i][j].replace(/&/g, \"&amp;\");\r\n                                if (attributesById[headers[j].name]) {\r\n                                    value = CommonUtils.formatDataValue(null, value, attributesById[headers[j].name], optionSets, 'USER');\r\n                                } else if ((headers[j].name === \"created\") || ((headers[j].name === \"lastupdated\"))) {\r\n                                    value = DateUtils.formatFromApiToUser(value);\r\n                                }\r\n\r\n                                if (trackedEntityInstance === null) {\r\n                                    trackedEntityInstance = {};\r\n                                }\r\n\r\n                                if (index > -1) {\r\n                                    if (!trackedEntityInstance[\"attributes\"]) {\r\n                                        trackedEntityInstance[\"attributes\"] = [];\r\n                                    }\r\n                                    trackedEntityInstance[\"attributes\"].push({\r\n                                        id: attrNamesIdMap[itemName], name: itemName,\r\n                                        value: value\r\n                                    });\r\n                                } else {\r\n                                    trackedEntityInstance[headers[j].name] = value;\r\n                                }\r\n                            }\r\n                            if (trackedEntityInstance !== null) {\r\n                                jsonData[\"trackedEntityInstances\"].push(trackedEntityInstance);\r\n                            }\r\n                        }\r\n                        if (jsonData) {\r\n                            deferred.resolve(JSON.stringify(jsonData, null, 2));\r\n                        }\r\n                    } else if (format === \"xml\") {\r\n                        xmlData = \"\";\r\n                        if (response.data && response.data.rows) {\r\n                            xmlData += \"<trackedEntityInstances>\";\r\n                            rows = response.data.rows;\r\n                            headers = response.data.headers;\r\n                            for (var i = 0; i < rows.length; i++) {\r\n                                xmlData += \"<trackedEntityInstance>\";\r\n                                for (var j = 0; j < rows[i].length; j++) {\r\n                                    index = attributesList.indexOf(headers[j].name);\r\n                                    itemName = headers[j].column;\r\n                                    value = rows[i][j].replace(/&/g, \"&amp;\");\r\n                                    if (attributesById[headers[j].name]) {\r\n                                        value = CommonUtils.formatDataValue(null, value, attributesById[headers[j].name], optionSets, 'USER');\r\n                                    } else if ((headers[j].name === \"created\") || ((headers[j].name === \"lastupdated\"))) {\r\n                                        value = DateUtils.formatFromApiToUser(value);\r\n                                    }\r\n                                    if (index > -1) {\r\n                                        xmlData += '<attribute id=\"' + attrNamesIdMap[itemName] + '\" ' +\r\n                                            'name=\"' + itemName + '\" value=\"' + value + '\"></attribute>';\r\n                                    } else {\r\n                                        xmlData += '<' + headers[j].name + ' value=\"' + value + '\"></' + headers[j].name + '>';\r\n                                    }\r\n\r\n                                }\r\n                                xmlData += \"</trackedEntityInstance>\";\r\n\r\n                            }\r\n                            xmlData += \"</trackedEntityInstances>\";\r\n                            deferred.resolve(xmlData);\r\n                        }\r\n                    } else if (format === \"csv\") {\r\n                        deferred.resolve(response.data);\r\n                    }\r\n                } else {\r\n                    deferred.resolve(response.data);\r\n                }\r\n            }, function(error){\r\n                if(error && error.status === 403){\r\n                    NotificationService.showNotifcationDialog( $translate.instant('error'),  $translate.instant('access_denied'));\r\n                }\r\n                deferred.resolve(null);\r\n            });            \r\n            return deferred.promise;\r\n        },                \r\n        update: function(tei, optionSets, attributesById){\r\n            var formattedTei = angular.copy(tei);\r\n            angular.forEach(formattedTei.attributes, function(att){\r\n                att.value = CommonUtils.formatDataValue(null, att.value, attributesById[att.attribute], optionSets, 'API');\r\n            });\r\n            var promise = $http.put( DHIS2URL + '/trackedEntityInstances/' + formattedTei.trackedEntityInstance , formattedTei ).then(function(response){                    \r\n                return response.data;\r\n            }, function(response){\r\n                NotificationService.showNotifcationDialog($translate.instant('update_error'), $translate.instant('failed_to_update_tei'), response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        register: function(tei, optionSets, attributesById){\r\n            var formattedTei = angular.copy(tei);\r\n            var attributes = [];\r\n            angular.forEach(formattedTei.attributes, function(att){ \r\n                attributes.push({attribute: att.attribute, value: CommonUtils.formatDataValue(null, att.value, attributesById[att.attribute], optionSets, 'API')});\r\n            });\r\n            \r\n            formattedTei.attributes = attributes;\r\n            var promise = $http.post( DHIS2URL + '/trackedEntityInstances' , formattedTei ).then(function(response){                    \r\n                return response.data;\r\n            }, function(response) {\r\n                //Necessary now that import errors gives a 409 response from the server.\r\n                //The 409 response is treated as an error response.\r\n                var errorBody = $translate.instant('failed_to_register_tei');\r\n                NotificationService.showNotifcationDialog($translate.instant('register_error'), errorBody, response);\r\n                return null;\r\n            });                    \r\n            return promise;            \r\n        },\r\n        processAttributes: function(selectedTei, selectedProgram, selectedEnrollment){\r\n            var def = $q.defer();            \r\n            if(selectedTei.attributes){\r\n                if(selectedProgram && selectedEnrollment){\r\n                    //show attribute for selected program and enrollment\r\n                    AttributesFactory.getByProgram(selectedProgram).then(function(atts){\r\n                        selectedTei.attributes = AttributesFactory.showRequiredAttributes(atts,selectedTei.attributes, true);\r\n                        def.resolve(selectedTei);\r\n                    }); \r\n                }\r\n                if(selectedProgram && !selectedEnrollment){\r\n                    //show attributes for selected program            \r\n                    AttributesFactory.getByProgram(selectedProgram).then(function(atts){    \r\n                        selectedTei.attributes = AttributesFactory.showRequiredAttributes(atts,selectedTei.attributes, false);\r\n                        def.resolve(selectedTei);\r\n                    }); \r\n                }\r\n                if(!selectedProgram && !selectedEnrollment){\r\n                    //show attributes in no program            \r\n                    AttributesFactory.getWithoutProgram().then(function(atts){                \r\n                        selectedTei.attributes = AttributesFactory.showRequiredAttributes(atts,selectedTei.attributes, false);     \r\n                        def.resolve(selectedTei);\r\n                    });\r\n                }\r\n            }       \r\n            return def.promise;\r\n        },\r\n        getGeneratedAttributeValue: function(attribute) {\r\n            var deferred = $q.defer();\r\n            $http.get(DHIS2URL + '/trackedEntityAttributes/' + attribute + '/generate').then(function (response) {\r\n                if (response && response.data) {\r\n                    deferred.resolve(response.data);\r\n                }\r\n            }, function (response) {\r\n                var errorBody = $translate.instant('failed_to_generate_tracked_entity_attribute');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                deferred.resolve(response.data);\r\n                return null;\r\n            });\r\n            return deferred.promise;\r\n        }\r\n    };\r\n})\r\n\r\n/* Factory for getting tracked entity attributes */\r\n.factory('AttributesFactory', function($q, $rootScope, TCStorageService, orderByFilter, DateUtils, OptionSetService, OperatorFactory) {      \r\n\r\n    return {\r\n        getAll: function(){\r\n            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.getAll('attributes').done(function(attributes){                    \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(attributes);\r\n                    });\r\n                });\r\n            });            \r\n            return def.promise;            \r\n        }, \r\n        getByProgram: function(program){\r\n            var def = $q.defer();\r\n            this.getAll().then(function(atts){                \r\n                \r\n                if(program && program.id){\r\n                    var attributes = [];\r\n                    var programAttributes = [];\r\n                    angular.forEach(atts, function(attribute){\r\n                        attributes[attribute.id] = attribute;\r\n                    });\r\n\r\n                    angular.forEach(program.programTrackedEntityAttributes, function(pAttribute){\r\n                        var att = attributes[pAttribute.trackedEntityAttribute.id];\r\n                        if (att) {\r\n                            att.mandatory = pAttribute.mandatory;\r\n                            if (pAttribute.displayInList) {\r\n                                att.displayInListNoProgram = true;\r\n                            }\r\n                            programAttributes.push(att);\r\n                        }\r\n                    });\r\n                    \r\n                    def.resolve(programAttributes);\r\n                }                \r\n                else{\r\n                    var attributes = [];\r\n                    angular.forEach(atts, function(attribute){\r\n                        if (attribute.displayInListNoProgram) {\r\n                            attributes.push(attribute);\r\n                        }\r\n                    });     \r\n                    \r\n                    attributes = orderByFilter(attributes, '-sortOrderInListNoProgram').reverse();\r\n                    def.resolve(attributes);\r\n                }                \r\n            });\r\n            return def.promise;    \r\n        },\r\n        getWithoutProgram: function(){   \r\n            \r\n            var def = $q.defer();\r\n            this.getAll().then(function(atts){\r\n                var attributes = [];\r\n                angular.forEach(atts, function(attribute){\r\n                    if (attribute.displayInListNoProgram) {\r\n                        attributes.push(attribute);\r\n                    }\r\n                });     \r\n                def.resolve(attributes);             \r\n            });     \r\n            return def.promise;\r\n        },        \r\n        getMissingAttributesForEnrollment: function(tei, program){\r\n            var def = $q.defer();\r\n            this.getByProgram(program).then(function(atts){\r\n                var programAttributes = atts;\r\n                var existingAttributes = tei.attributes;\r\n                var missingAttributes = [];\r\n                \r\n                for(var i=0; i<programAttributes.length; i++){\r\n                    var exists = false;\r\n                    for(var j=0; j<existingAttributes.length && !exists; j++){\r\n                        if(programAttributes[i].id === existingAttributes[j].attribute){\r\n                            exists = true;\r\n                        }\r\n                    }\r\n                    if(!exists){\r\n                        missingAttributes.push(programAttributes[i]);\r\n                    }\r\n                }\r\n                def.resolve(missingAttributes);\r\n            });            \r\n            return def.promise();            \r\n        },\r\n        showRequiredAttributes: function(requiredAttributes, teiAttributes, fromEnrollment){        \r\n            \r\n            //first reset teiAttributes\r\n            for(var j=0; j<teiAttributes.length; j++){\r\n                teiAttributes[j].show = false;\r\n            }\r\n\r\n            //identify which ones to show\r\n            for(var i=0; i<requiredAttributes.length; i++){\r\n                var processed = false;\r\n                for(var j=0; j<teiAttributes.length && !processed; j++){\r\n                    if(requiredAttributes[i].id === teiAttributes[j].attribute){                    \r\n                        processed = true;\r\n                        teiAttributes[j].show = true;\r\n                        teiAttributes[j].order = i;\r\n                        teiAttributes[j].mandatory = requiredAttributes[i].mandatory ? requiredAttributes[i].mandatory : false;\r\n                        teiAttributes[j].allowFutureDate = requiredAttributes[i].allowFutureDate ? requiredAttributes[i].allowFutureDate : false;\r\n                        teiAttributes[j].displayName = requiredAttributes[i].displayName;\r\n                    }\r\n                }\r\n\r\n                if(!processed && fromEnrollment){//attribute was empty, so a chance to put some value\r\n                    teiAttributes.push({show: true, order: i, allowFutureDate: requiredAttributes[i].allowFutureDate ? requiredAttributes[i].allowFutureDate : false, mandatory: requiredAttributes[i].mandatory ? requiredAttributes[i].mandatory : false, attribute: requiredAttributes[i].id, displayName: requiredAttributes[i].displayName, type: requiredAttributes[i].valueType, value: ''});\r\n                }                   \r\n            }\r\n\r\n            teiAttributes = orderByFilter(teiAttributes, '-order');\r\n            teiAttributes.reverse();\r\n            return teiAttributes;\r\n        },\r\n        generateAttributeFilters: function(attributes){\r\n            angular.forEach(attributes, function(attribute){\r\n                if(attribute.valueType === 'NUMBER' || attribute.valueType === 'DATE'){\r\n                    attribute.operator = OperatorFactory.defaultOperators[0];\r\n                }\r\n            });            \r\n            return attributes;\r\n        }\r\n    };\r\n})\r\n\r\n/* factory for handling events */\r\n.factory('DHIS2EventFactory', function($http, DHIS2URL, NotificationService, $translate) {\r\n\r\n    var skipPaging = \"&skipPaging=true\";\r\n    var errorHeader = $translate.instant(\"error\");\r\n    return {     \r\n        \r\n        getEventsByStatus: function(entity, orgUnit, program, programStatus){   \r\n            var promise = $http.get( DHIS2URL + '/events.json?ouMode=ACCESSIBLE&' + 'trackedEntityInstance=' + entity + '&orgUnit=' + orgUnit + '&program=' + program + '&programStatus=' + programStatus  + skipPaging).then(function(response){\r\n                return response.data.events;\r\n            }, function (response) {\r\n\r\n                var errorBody = $translate.instant('failed_to_fetch_events');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n            });\r\n\r\n            return promise;\r\n        },\r\n        getEventsByProgram: function(entity, program, attributeCategory){            \r\n            var url = DHIS2URL + '/events.json?ouMode=ACCESSIBLE&' + 'trackedEntityInstance=' + entity + skipPaging;            \r\n            \r\n            if(program){\r\n                url = url + '&program=' + program;\r\n            }\r\n            \r\n            if( attributeCategory && !attributeCategory.default){\r\n                url = url + '&attributeCc=' + attributeCategory.cc + '&attributeCos=' + attributeCategory.cp;\r\n            }\r\n            \r\n            var promise = $http.get( url ).then(function(response){\r\n                return response.data.events;\r\n            }, function (response) {\r\n                var errorBody = $translate.instant('failed_to_fetch_events');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        getEventsByProgramStage: function(entity, programStage){\r\n          var url = DHIS2URL + '/events.json?ouMode=ACCESSIBLE&' + 'trackedEntityInstance=' + entity + skipPaging; \r\n          if(programStage){\r\n              url += '&programStage='+programStage;\r\n          }\r\n          var promise = $http.get(url).then(function(response){\r\n             return response.data.events;\r\n          }, function (response) {\r\n              var errorBody = $translate.instant('failed_to_fetch_events');\r\n              NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n              return null;\r\n          });\r\n          return promise;\r\n        },\r\n        getByOrgUnitAndProgram: function(orgUnit, ouMode, program, startDate, endDate){\r\n            var url;\r\n            if(startDate && endDate){\r\n                url = DHIS2URL + '/events.json?' + 'orgUnit=' + orgUnit + '&ouMode='+ ouMode + '&program=' + program + '&startDate=' + startDate + '&endDate=' + endDate + skipPaging;\r\n            }\r\n            else{\r\n                url = DHIS2URL + '/events.json?' + 'orgUnit=' + orgUnit + '&ouMode='+ ouMode + '&program=' + program + skipPaging;\r\n            }\r\n            var promise = $http.get( url ).then(function(response){\r\n                return response.data.events;\r\n            }, function(response){\r\n                if( response && response.data && response.data.status === 'ERROR'){\r\n                    var errorBody = $translate.instant('unable_to_fetch_data_from_server');\r\n                    NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                }\r\n            });\r\n            return promise;\r\n        },\r\n        get: function(eventUid){            \r\n            var promise = $http.get(DHIS2URL + '/events/' + eventUid + '.json').then(function(response){               \r\n                return response.data;\r\n            }, function (response) {\r\n                if (response && response.data && response.data.status === 'ERROR') {\r\n                    var errorBody = $translate.instant('failed_to_fetch_events');\r\n                    NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                }\r\n            });\r\n            return promise;\r\n        },        \r\n        create: function(dhis2Event){    \r\n            var promise = $http.post(DHIS2URL + '/events.json', dhis2Event).then(function(response){\r\n                return response.data;           \r\n            }, function (response) {\r\n                if (response && response.data && (response.data.status === 'ERROR' || response.data.status === 'WARNING')) {\r\n                    var errorBody = $translate.instant('event_creation_error');\r\n                    NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                    return null;\r\n                }\r\n            });\r\n            return promise;            \r\n        },\r\n        delete: function(dhis2Event){\r\n            var promise = $http.delete(DHIS2URL + '/events/' + dhis2Event.event).then(function(response){\r\n                return response.data;               \r\n            }, function (response) {\r\n                if (response && response.data && response.data.status === 'ERROR') {\r\n                    var errorBody = $translate.instant('delete_error_audit');\r\n                    NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                }\r\n            });\r\n            return promise;           \r\n        },\r\n        update: function(dhis2Event){   \r\n            var promise = $http.put(DHIS2URL + '/events/' + dhis2Event.event, dhis2Event).then(function(response){\r\n                return response.data;         \r\n            }, function (response) {\r\n                var errorBody = $translate.instant('failed_to_update_event');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n            });\r\n            return promise;\r\n        },        \r\n        updateForSingleValue: function(singleValue){   \r\n            var promise = $http.put(DHIS2URL + '/events/' + singleValue.event + '/' + singleValue.dataValues[0].dataElement, singleValue ).then(function(response){\r\n                return response.data;\r\n            }, function (response) {\r\n                var errorBody = $translate.instant('failed_to_update_event');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        updateForNote: function(dhis2Event){   \r\n            var promise = $http.post(DHIS2URL + '/events/' + dhis2Event.event + '/note', dhis2Event).then(function(response){\r\n                return response.data;         \r\n            }, function (response) {\r\n                var errorBody = $translate.instant('failed_to_update_event');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        },\r\n        updateForEventDate: function(dhis2Event){\r\n            var promise = $http.put(DHIS2URL + '/events/' + dhis2Event.event + '/eventDate', dhis2Event).then(function(response){\r\n                return response.data;         \r\n            }, function (response) {\r\n                var errorBody = $translate.instant('failed_to_update_event');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });\r\n            return promise;\r\n        }\r\n    };    \r\n})\r\n\r\n/* factory for handling event reports */\r\n.factory('EventReportService', function($http, DHIS2URL, $translate, NotificationService) {\r\n    var errorHeader = $translate.instant(\"error\");\r\n    return {\r\n\r\n        getEventReport: function(orgUnit, ouMode, program, startDate, endDate, programStatus, eventStatus, pager){\r\n            \r\n            var url = DHIS2URL + '/events/eventRows.json?' + 'orgUnit=' + orgUnit + '&ouMode='+ ouMode + '&program=' + program;\r\n            \r\n            if( programStatus ){\r\n                url = url + '&programStatus=' + programStatus;\r\n            }\r\n            \r\n            if( eventStatus ){\r\n                url = url + '&eventStatus=' + eventStatus;\r\n            }\r\n            \r\n            if(startDate && endDate){\r\n                url = url + '&startDate=' + startDate + '&endDate=' + endDate ;\r\n            }\r\n            \r\n            if( pager ){\r\n                var pgSize = pager ? pager.pageSize : 50;\r\n                var pg = pager ? pager.page : 1;\r\n                pgSize = pgSize > 1 ? pgSize  : 1;\r\n                pg = pg > 1 ? pg : 1;\r\n                url = url + '&pageSize=' + pgSize + '&page=' + pg + '&totalPages=true';\r\n            } \r\n            \r\n            var promise = $http.get( url ).then(function(response){\r\n                return response.data;\r\n            }, function(response){\r\n                var errorBody = $translate.instant('failed_to_update_event');\r\n                NotificationService.showNotifcationDialog(errorHeader, errorBody, response);\r\n                return null;\r\n            });            \r\n            return promise;\r\n        }\r\n    };    \r\n})\r\n\r\n.factory('OperatorFactory', function($translate){\r\n    \r\n    var defaultOperators = [$translate.instant('IS'), $translate.instant('RANGE') ];\r\n    var boolOperators = [$translate.instant('yes'), $translate.instant('no')];\r\n    return{\r\n        defaultOperators: defaultOperators,\r\n        boolOperators: boolOperators\r\n    };  \r\n})\r\n\r\n/* factory to fetch and process programValidations */\r\n.factory('MetaDataFactory', function($q, $rootScope, TCStorageService) {  \r\n    \r\n    return {        \r\n        get: function(store, uid){\r\n            \r\n            var def = $q.defer();\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.get(store, uid).done(function(pv){                    \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(pv);\r\n                    });\r\n                });\r\n            });                        \r\n            return def.promise;\r\n        },\r\n        getByProgram: function(store, program){\r\n            var def = $q.defer();\r\n            var obj = [];\r\n            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.getAll(store, program).done(function(pvs){   \r\n                    angular.forEach(pvs, function(pv){\r\n                        if(pv.program.id === program){                            \r\n                            obj.push(pv);                               \r\n                        }                        \r\n                    });\r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(obj);\r\n                    });\r\n                });                \r\n            });            \r\n            return def.promise;\r\n        },\r\n        getAll: function(store){\r\n            var def = $q.defer();            \r\n            TCStorageService.currentStore.open().done(function(){\r\n                TCStorageService.currentStore.getAll(store).done(function(pvs){                       \r\n                    $rootScope.$apply(function(){\r\n                        def.resolve(pvs);\r\n                    });\r\n                });                \r\n            });            \r\n            return def.promise;\r\n        }\r\n    };        \r\n})\r\n\r\n/* Returns a function for getting rules for a specific program */\r\n.factory('TrackerRulesFactory', function($q,MetaDataFactory,$filter){\r\n    var staticReplacements = \r\n                        [{regExp:new RegExp(\"([^\\w\\d])(and)([^\\w\\d])\",\"gi\"), replacement:\"$1&&$3\"},\r\n                        {regExp:new RegExp(\"([^\\w\\d])(or)([^\\w\\d])\",\"gi\"), replacement:\"$1||$3\"},\r\n                        {regExp:new RegExp(\"V{execution_date}\",\"g\"), replacement:\"V{event_date}\"}];\r\n                    \r\n    var performStaticReplacements = function(expression) {\r\n        angular.forEach(staticReplacements, function(staticReplacement) {\r\n            expression = expression.replace(staticReplacement.regExp, staticReplacement.replacement);\r\n        });\r\n        \r\n        return expression;\r\n    };\r\n    \r\n    return{                \r\n        getRules : function(programUid){            \r\n            var def = $q.defer();            \r\n            MetaDataFactory.getAll('constants').then(function(constants) {\r\n                MetaDataFactory.getByProgram('programIndicators',programUid).then(function(pis){                    \r\n                    var variables = [];\r\n                    var programRules = [];\r\n                    angular.forEach(pis, function(pi){\r\n                        if(pi.displayInForm){\r\n                            var newAction = {\r\n                                    id:pi.id,\r\n                                    content:pi.displayDescription ? pi.displayDescription : pi.displayName,\r\n                                    data:pi.expression,\r\n                                    programRuleActionType:'DISPLAYKEYVALUEPAIR',\r\n                                    location:'indicators'\r\n                                };\r\n                            var newRule = {\r\n                                    name:pi.displayName,\r\n                                    id: pi.id,\r\n                                    shortname:pi.shortname,\r\n                                    code:pi.code,\r\n                                    program:pi.program,\r\n                                    description:pi.description,\r\n                                    condition:pi.filter ? pi.filter : 'true',\r\n                                    programRuleActions: [newAction]\r\n                                };\r\n\r\n                            programRules.push(newRule);\r\n\r\n                            var variablesInCondition = newRule.condition.match(/[A#]{\\w+.?\\w*}/g);\r\n                            var variablesInData = newAction.data.match(/[A#]{\\w+.?\\w*}/g);\r\n                            var valueCountPresent = newRule.condition.indexOf(\"V{value_count}\") >= 0 \r\n                                                            || newAction.data.indexOf(\"V{value_count}\") >= 0;\r\n                            var positiveValueCountPresent = newRule.condition.indexOf(\"V{zero_pos_value_count}\") >= 0\r\n                                                            || newAction.data.indexOf(\"V{zero_pos_value_count}\") >= 0;\r\n                            var variableObjectsCurrentExpression = [];\r\n                            \r\n                            var pushDirectAddressedVariable = function(variableWithCurls) {\r\n                                var variableName = $filter('trimvariablequalifiers')(variableWithCurls);\r\n                                var variableNameParts = variableName.split('.');\r\n\r\n                                var newVariableObject;\r\n\r\n                                if(variableNameParts.length === 2) {\r\n                                    //this is a programstage and dataelement specification. translate to program variable:\r\n                                    newVariableObject = {\r\n                                        displayName:variableName,\r\n                                        programRuleVariableSourceType:'DATAELEMENT_NEWEST_EVENT_PROGRAM_STAGE',\r\n                                        dataElement:variableNameParts[1],\r\n                                        programStage:variableNameParts[0],\r\n                                        program:programUid,\r\n                                        useCodeForOptionSet:true\r\n                                    };\r\n                                }\r\n                                else if(variableNameParts.length === 1)\r\n                                {\r\n                                    //This is an attribute - let us translate to program variable:\r\n                                    newVariableObject = {\r\n                                        displayName:variableName,\r\n                                        programRuleVariableSourceType:'TEI_ATTRIBUTE',\r\n                                        trackedEntityAttribute:variableNameParts[0],\r\n                                        program:programUid,\r\n                                        useCodeForOptionSet:true\r\n                                    };\r\n                                }\r\n                                variables.push(newVariableObject);\r\n                                \r\n                                return newVariableObject;\r\n                                \r\n                            };\r\n                            \r\n                            angular.forEach(variablesInCondition, function(variableInCondition) {\r\n                                var pushed = pushDirectAddressedVariable(variableInCondition);\r\n                            });\r\n\r\n                            angular.forEach(variablesInData, function(variableInData) {\r\n                                var pushed = pushDirectAddressedVariable(variableInData);\r\n                                \r\n                                //We only count the number of values in the data part of the rule\r\n                                //(Called expression in program indicators)\r\n                                variableObjectsCurrentExpression.push(pushed);\r\n                            });\r\n                            \r\n                            //Change expression or data part of the rule to match the program rules execution model\r\n                            \r\n                            if(valueCountPresent) {\r\n                                var valueCountText;\r\n                                angular.forEach(variableObjectsCurrentExpression, function(variableCurrentRule) {\r\n                                   if(valueCountText) {\r\n                                       //This is not the first value in the value count part of the expression. \r\n                                       valueCountText +=  ' + d2:count(\\'' + variableCurrentRule.displayName + '\\')';\r\n                                   }\r\n                                   else\r\n                                   {\r\n                                       //This is the first part value in the value count expression:\r\n                                       valueCountText = '(d2:count(\\'' + variableCurrentRule.displayName + '\\')';\r\n                                   }\r\n                                });\r\n                                //To finish the value count expression we need to close the paranthesis:\r\n                                valueCountText += ')';\r\n\r\n                                //Replace all occurrences of value counts in both the data and expression:\r\n                                newRule.condition = newRule.condition.replace(new RegExp(\"V{value_count}\", 'g'),valueCountText);\r\n                                newAction.data = newAction.data.replace(new RegExp(\"V{value_count}\", 'g'),valueCountText);\r\n                            }\r\n                            if(positiveValueCountPresent) {\r\n                                var zeroPosValueCountText;\r\n                                angular.forEach(variableObjectsCurrentExpression, function(variableCurrentRule) {\r\n                                   if(zeroPosValueCountText) {\r\n                                       //This is not the first value in the value count part of the expression. \r\n                                       zeroPosValueCountText +=  '+ d2:countifzeropos(\\'' + variableCurrentRule.displayName + '\\')';\r\n                                   }\r\n                                   else\r\n                                   {\r\n                                       //This is the first part value in the value count expression:\r\n                                       zeroPosValueCountText = '(d2:countifzeropos(\\'' + variableCurrentRule.displayName + '\\')';\r\n                                   }\r\n                                });\r\n                                //To finish the value count expression we need to close the paranthesis:\r\n                                zeroPosValueCountText += ')';\r\n\r\n                                //Replace all occurrences of value counts in both the data and expression:\r\n                                newRule.condition = newRule.condition.replace(new RegExp(\"V{zero_pos_value_count}\", 'g'),zeroPosValueCountText);\r\n                                newAction.data = newAction.data.replace(new RegExp(\"V{zero_pos_value_count}\", 'g'),zeroPosValueCountText);\r\n                            }\r\n                            \r\n                            newAction.data = performStaticReplacements(newAction.data);\r\n                            newRule.condition = performStaticReplacements(newRule.condition);\r\n                        }\r\n                    });\r\n\r\n                    var programIndicators = {rules:programRules, variables:variables};\r\n                    \r\n                    MetaDataFactory.getByProgram('programValidations',programUid).then(function(programValidations){                    \r\n                        MetaDataFactory.getByProgram('programRuleVariables',programUid).then(function(programVariables){                    \r\n                            MetaDataFactory.getByProgram('programRules',programUid).then(function(prs){\r\n                                var programRules = [];\r\n                                angular.forEach(prs, function(rule){\r\n                                    rule.actions = [];\r\n                                    rule.programStageId = rule.programStage && rule.programStage.id ? rule.programStage.id : null;\r\n                                    programRules.push(rule);\r\n                                });                                \r\n                                def.resolve({constants: constants, programIndicators: programIndicators, programValidations: programValidations, programVariables: programVariables, programRules: programRules});\r\n                            });\r\n                        });\r\n                    });\r\n                }); \r\n            });                        \r\n            return def.promise;\r\n        }\r\n    };  \r\n})\r\n\r\n.service('EntityQueryFactory', function(OperatorFactory, DateUtils){  \r\n    \r\n    this.getAttributesQuery = function(attributes, enrollment){\r\n\r\n        var query = {url: null, hasValue: false};\r\n        \r\n        angular.forEach(attributes, function(attribute){           \r\n\r\n            if(attribute.valueType === 'DATE' || attribute.valueType === 'NUMBER'){\r\n                var q = '';\r\n                \r\n                if(attribute.operator === OperatorFactory.defaultOperators[0]){\r\n                    if(attribute.exactValue && attribute.exactValue !== ''){\r\n                        query.hasValue = true;\r\n                        if(attribute.valueType === 'DATE'){\r\n                            attribute.exactValue = DateUtils.formatFromUserToApi(attribute.exactValue);\r\n                        }\r\n                        q += 'EQ:' + attribute.exactValue + ':';\r\n                    }\r\n                }                \r\n                if(attribute.operator === OperatorFactory.defaultOperators[1]){\r\n                    if(attribute.startValue && attribute.startValue !== ''){\r\n                        query.hasValue = true;\r\n                        if(attribute.valueType === 'DATE'){\r\n                            attribute.startValue = DateUtils.formatFromUserToApi(attribute.startValue);\r\n                        }\r\n                        q += 'GT:' + attribute.startValue + ':';\r\n                    }\r\n                    if(attribute.endValue && attribute.endValue !== ''){\r\n                        query.hasValue = true;\r\n                        if(attribute.valueType === 'DATE'){\r\n                            attribute.endValue = DateUtils.formatFromUserToApi(attribute.endValue);\r\n                        }\r\n                        q += 'LT:' + attribute.endValue + ':';\r\n                    }\r\n                }                \r\n                if(query.url){\r\n                    if(q){\r\n                        q = q.substr(0,q.length-1);\r\n                        query.url = query.url + '&filter=' + attribute.id + ':' + q;\r\n                    }\r\n                }\r\n                else{\r\n                    if(q){\r\n                        q = q.substr(0,q.length-1);\r\n                        query.url = 'filter=' + attribute.id + ':' + q;\r\n                    }\r\n                }\r\n            }\r\n            else{\r\n                if(attribute.value && attribute.value !== ''){                    \r\n                    query.hasValue = true;                \r\n\r\n                    if(angular.isArray(attribute.value)){\r\n                        var q = '';\r\n                        angular.forEach(attribute.value, function(val){                        \r\n                            q += val + ';';\r\n                        });\r\n\r\n                        q = q.substr(0,q.length-1);\r\n\r\n                        if(query.url){\r\n                            if(q){\r\n                                query.url = query.url + '&filter=' + attribute.id + ':IN:' + q;\r\n                            }\r\n                        }\r\n                        else{\r\n                            if(q){\r\n                                query.url = 'filter=' + attribute.id + ':IN:' + q;\r\n                            }\r\n                        }                    \r\n                    }\r\n                    else{                        \r\n                        if(query.url){\r\n                            query.url = query.url + '&filter=' + attribute.id + ':LIKE:' + attribute.value;\r\n                        }\r\n                        else{\r\n                            query.url = 'filter=' + attribute.id + ':LIKE:' + attribute.value;\r\n                        }\r\n                    }\r\n                }\r\n            }            \r\n        });\r\n        \r\n        if(enrollment){\r\n            var q = '';\r\n            if(enrollment.programEnrollmentStartDate && enrollment.programEnrollmentStartDate !== ''){                \r\n                query.hasValue = true;\r\n                q += '&programEnrollmentStartDate=' + DateUtils.formatFromUserToApi(enrollment.programEnrollmentStartDate);\r\n            }\r\n            if(enrollment.programEnrollmentEndDate && enrollment.programEnrollmentEndDate !== ''){\r\n                query.hasValue = true;\r\n                q += '&programEnrollmentEndDate=' + DateUtils.formatFromUserToApi(enrollment.programEnrollmentEndDate);\r\n            }\r\n            if(enrollment.programIncidentStartDate && enrollment.programIncidentStartDate !== ''){                \r\n                query.hasValue = true;\r\n                q += '&programIncidentStartDate=' + DateUtils.formatFromUserToApi(enrollment.programIncidentStartDate);\r\n            }\r\n            if(enrollment.programIncidentEndDate && enrollment.programIncidentEndDate !== ''){\r\n                query.hasValue = true;\r\n                q += '&programIncidentEndDate=' + DateUtils.formatFromUserToApi(enrollment.programIncidentEndDate);\r\n            }\r\n            if(q){\r\n                if(query.url){\r\n                    query.url = query.url + q;\r\n                }\r\n                else{\r\n                    query.url = q;\r\n                }\r\n            }            \r\n        }\r\n        return query;\r\n        \r\n    };   \r\n    \r\n    this.resetAttributesQuery = function(attributes, enrollment){\r\n        \r\n        angular.forEach(attributes, function(attribute){\r\n            attribute.exactValue = '';\r\n            attribute.startValue = '';\r\n            attribute.endValue = '';\r\n            attribute.value = '';           \r\n        });\r\n        \r\n        if(enrollment){\r\n            enrollment.programStartDate = '';\r\n            enrollment.programEndDate = '';          \r\n        }        \r\n        return attributes;        \r\n    }; \r\n})\r\n\r\n.service('TEIGridService', function(OptionSetService, CommonUtils, CurrentSelection, DateUtils, $location, $translate, $filter){\r\n    \r\n    return {\r\n        format: function(selectedOrgUnitId, grid, map, optionSets, invalidTeis, isFollowUp){\r\n            var ouId = ($location.search()).ou;\r\n            if (!ouId) {\r\n                ouId = selectedOrgUnitId;\r\n            }\r\n\r\n\r\n            invalidTeis = !invalidTeis ? [] : invalidTeis;\r\n            if (!grid || !grid.rows) {\r\n                return;\r\n            }\r\n\r\n            //grid.headers[0-6] = Instance, Created, Last updated, OU ID, Ou Name, Tracked entity, Inactive\r\n            //grid.headers[7..] = Attribute, Attribute,....\r\n            var attributes = [];\r\n            for (var i = 6; i < grid.headers.length; i++) {\r\n                attributes.push({\r\n                    id: grid.headers[i].name,\r\n                    displayName: grid.headers[i].column,\r\n                    type: grid.headers[i].type\r\n                });\r\n            }\r\n\r\n            var entityList = {own: [], other: []};\r\n\r\n            var attributesById = CurrentSelection.getAttributesById();\r\n            \r\n            angular.forEach(grid.rows, function (row) {\r\n                if (invalidTeis.indexOf(row[0]) === -1) {\r\n                    var entity = {};\r\n                    var isEmpty = true;\r\n\r\n                    entity.id = row[0];\r\n                    entity.created = DateUtils.formatFromApiToUser(row[1]);\r\n\r\n                    entity.orgUnit = row[3];\r\n                    entity.orgUnitName = row[4];\r\n                    entity.type = row[5];\r\n                    entity.inactive = row[6] !== \"\" ? row[6] : false;\r\n                    entity.followUp = isFollowUp;\r\n\r\n                    for (var i = 7; i < row.length; i++) {\r\n                        if (row[i] && row[i] !== '') {\r\n                            isEmpty = false;\r\n                            var val = row[i];\r\n\r\n                            if (attributesById[grid.headers[i].name] &&\r\n                                attributesById[grid.headers[i].name].optionSetValue &&\r\n                                optionSets &&\r\n                                attributesById[grid.headers[i].name].optionSet &&\r\n                                optionSets[attributesById[grid.headers[i].name].optionSet.id]) {\r\n                                val = OptionSetService.getName(optionSets[attributesById[grid.headers[i].name].optionSet.id].options, val);\r\n                            }\r\n                            if (attributesById[grid.headers[i].name] && attributesById[grid.headers[i].name].valueType ) {                                \r\n                                switch ( attributesById[grid.headers[i].name].valueType ){\r\n                                    case \"ORGANISATION_UNIT\":\r\n                                        CommonUtils.checkAndSetOrgUnitName( val );\r\n                                        break;\r\n                                    case \"DATE\":\r\n                                        val = DateUtils.formatFromApiToUser(val);\r\n                                        break;\r\n                                }\r\n                            }\r\n                            \r\n                            entity[grid.headers[i].name] = val;\r\n                        }\r\n                    }\r\n\r\n                    if (!isEmpty) {\r\n                        if (map) {\r\n                            entityList[entity.id] = entity;\r\n                        }\r\n                        else {\r\n                            if (entity.orgUnit === ouId) {\r\n                                entityList.own.push(entity);\r\n                            }\r\n                            else {\r\n                                entityList.other.push(entity);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            var len = entityList.own.length + entityList.other.length;\r\n            return {headers: attributes, rows: entityList, pager: grid.metaData.pager, length: len};\r\n        },\r\n        generateGridColumns: function(attributes, ouMode, nonConfidential){\r\n            \r\n            if( ouMode === null ){\r\n                ouMode = 'SELECTED';\r\n            }\r\n            var filterTypes = {}, filterText = {};\r\n            var columns = [];\r\n            \r\n            var returnAttributes = [];\r\n            if(nonConfidential) {\r\n                //Filter out attributes that is confidential, so they will not be part of any grid:\r\n                returnAttributes = angular.copy($filter('nonConfidential')(attributes));\r\n            }\r\n            else\r\n            {\r\n                returnAttributes = angular.copy(attributes);\r\n            }\r\n       \r\n            //also add extra columns which are not part of attributes (orgunit for example)\r\n            columns.push({id: 'orgUnitName', displayName: $translate.instant('registering_unit'), valueType: 'TEXT', displayInListNoProgram: false, attribute: false});\r\n            columns.push({id: 'created', displayName: $translate.instant('registration_date'), valueType: 'DATE', displayInListNoProgram: false, attribute: false});\r\n            columns.push({id: 'inactive', displayName: $translate.instant('inactive'), valueType: 'BOOLEAN', displayInListNoProgram: false, attribute: false});\r\n            columns = columns.concat(returnAttributes ? returnAttributes : []);\r\n            \r\n            //generate grid column for the selected program/attributes\r\n            angular.forEach(columns, function(column){\r\n                column.attribute = angular.isUndefined(column.attribute) ? true : false;\r\n                column.show = false;\r\n\r\n                if( (column.id === 'orgUnitName' && ouMode !== 'SELECTED') ||\r\n                    column.displayInListNoProgram || \r\n                    column.displayInList){\r\n                    column.show = true;\r\n                }                \r\n                column.showFilter = false;                \r\n                filterTypes[column.id] = column.valueType;\r\n                if(column.valueType === 'DATE' || column.valueType === 'NUMBER' ){\r\n                    filterText[column.id]= {};\r\n                }\r\n            });\r\n            return {columns: columns, filterTypes: filterTypes, filterText: filterText};\r\n        },\r\n        getData: function(rows, columns){\r\n            var data = [];\r\n            angular.forEach(rows, function(row){\r\n                var d = {};\r\n                angular.forEach(columns, function(col){\r\n                    if(col.show){\r\n                        d[col.displayName] = row[col.id];\r\n                    }                \r\n                });\r\n                data.push(d);            \r\n            });\r\n            return data;\r\n        },\r\n        getHeader: function(columns){\r\n            var header = []; \r\n            angular.forEach(columns, function(col){\r\n                if(col.show){\r\n                    header.push($translate.instant(col.displayName));\r\n                }\r\n            });        \r\n            return header;\r\n        }\r\n    };\r\n})\r\n\r\n.service('EventUtils', function(DateUtils, CommonUtils, PeriodService, CalendarService, CurrentSelection, $translate, $filter, $rootScope, orderByFilter){\r\n    \r\n    var getEventDueDate = function(eventsByStage, programStage, enrollment){       \r\n        \r\n        var referenceDate = enrollment.incidentDate ? enrollment.incidentDate : enrollment.enrollmentDate,\r\n            offset = programStage.minDaysFromStart,\r\n            calendarSetting = CalendarService.getSetting(),\r\n            dueDate;\r\n\r\n        if(programStage.generatedByEnrollmentDate){\r\n            referenceDate = enrollment.enrollmentDate;\r\n        }\r\n\r\n        if(programStage.repeatable){\r\n            var evs = [];                \r\n            angular.forEach(eventsByStage, function(ev){\r\n                if(ev.eventDate){\r\n                    evs.push(ev);\r\n                }\r\n            });\r\n\r\n            if(evs.length > 0){\r\n                evs = orderByFilter(evs, '-eventDate');                \r\n                if(programStage.periodType){\r\n                    \r\n                }\r\n                else{\r\n                    referenceDate = evs[0].eventDate;\r\n                    offset = programStage.standardInterval;\r\n                }\r\n            }                \r\n        }\r\n        dueDate = moment(referenceDate, calendarSetting.momentFormat).add('d', offset)._d;\r\n        dueDate = $filter('date')(dueDate, calendarSetting.keyDateFormat);        \r\n        return dueDate;\r\n    };\r\n    \r\n    var getEventDuePeriod = function(eventsByStage, programStage, enrollment){ \r\n        \r\n        var evs = [];                \r\n        angular.forEach(eventsByStage, function(ev){\r\n            if(ev.eventDate){\r\n                evs.push(ev);\r\n            }\r\n        });\r\n\r\n        if(evs.length > 0){\r\n            evs = orderByFilter(evs, '-eventDate');\r\n        }\r\n        \r\n        return PeriodService.getPeriods(evs,programStage, enrollment);\r\n    };\r\n    \r\n    var reconstructEvent = function(dhis2Event, programStage, optionSets){\r\n        var e = {dataValues: [], \r\n                event: dhis2Event.event, \r\n                program: dhis2Event.program, \r\n                programStage: dhis2Event.programStage, \r\n                orgUnit: dhis2Event.orgUnit, \r\n                trackedEntityInstance: dhis2Event.trackedEntityInstance,\r\n                status: dhis2Event.status,\r\n                dueDate: DateUtils.formatFromUserToApi(dhis2Event.dueDate)\r\n            };\r\n\r\n        angular.forEach(programStage.programStageDataElements, function(prStDe){\r\n            if(dhis2Event[prStDe.dataElement.id]){                    \r\n                var value = CommonUtils.formatDataValue(dhis2Event.event, dhis2Event[prStDe.dataElement.id], prStDe.dataElement, optionSets, 'API');                    \r\n                var val = {value: value, dataElement: prStDe.dataElement.id};\r\n                if(dhis2Event.providedElsewhere[prStDe.dataElement.id]){\r\n                    val.providedElsewhere = dhis2Event.providedElsewhere[prStDe.dataElement.id];\r\n                }\r\n                e.dataValues.push(val);\r\n            }                                \r\n        });\r\n\r\n        if(programStage.captureCoordinates){\r\n            e.coordinate = {latitude: dhis2Event.coordinate.latitude ? dhis2Event.coordinate.latitude : 0,\r\n                            longitude: dhis2Event.coordinate.longitude ? dhis2Event.coordinate.longitude : 0};\r\n        }\r\n\r\n        if(dhis2Event.eventDate){\r\n            e.eventDate = DateUtils.formatFromUserToApi(dhis2Event.eventDate);\r\n        }\r\n\r\n        return e;\r\n    };\r\n    \r\n    return {\r\n        createDummyEvent: function(eventsPerStage, tei, program, programStage, orgUnit, enrollment){\r\n            var today = DateUtils.getToday();\r\n            var dummyEvent = {trackedEntityInstance: tei.trackedEntityInstance, \r\n                              programStage: programStage.id, \r\n                              program: program.id,\r\n                              orgUnit: orgUnit.id,\r\n                              orgUnitName: orgUnit.displayName ? orgUnit.displayName : orgUnit.n ? orgUnit.n : null,\r\n                              name: programStage.displayName,\r\n                              executionDateLabel: programStage.executionDateLabel ? programStage.executionDateLabel : $translate.instant('report_date'),\r\n                              enrollmentStatus: 'ACTIVE',\r\n                              enrollment: enrollment.enrollment,\r\n                              status: 'SCHEDULED'};\r\n                          \r\n            if(programStage.periodType){\r\n                var prds = getEventDuePeriod(eventsPerStage, programStage, enrollment);\r\n                var periods = prds && prds.availablePeriods && prds.availablePeriods.length ? prds.availablePeriods : [];\r\n                if( periods.length > 0 ){\r\n                    dummyEvent.dueDate = periods[0].endDate;\r\n                    dummyEvent.periodName = periods[0].displayName;\r\n                    dummyEvent.eventDate = dummyEvent.dueDate;\r\n                    dummyEvent.periods = periods;\r\n                    dummyEvent.periodOffset = prds.periodOffset;\r\n                    dummyEvent.hasFuturePeriod = prds.hasFuturePeriod;\r\n                }\r\n            }\r\n            else{\r\n                dummyEvent.dueDate = getEventDueDate(eventsPerStage, programStage, enrollment);\r\n            }\r\n            \r\n            dummyEvent.sortingDate = dummyEvent.dueDate;\r\n            \r\n            \r\n            if(programStage.captureCoordinates){\r\n                dummyEvent.coordinate = {};\r\n            }\r\n            \r\n            dummyEvent.statusColor = 'alert-warning';//'stage-on-time';\r\n            if(moment(today).isAfter(dummyEvent.dueDate)){\r\n                dummyEvent.statusColor = 'alert-danger';//'stage-overdue';\r\n            }\r\n            return dummyEvent;        \r\n        },\r\n        getEventStatusColor: function(dhis2Event){    \r\n            var eventDate = DateUtils.getToday();\r\n            var calendarSetting = CalendarService.getSetting();\r\n            \r\n            if(dhis2Event.eventDate){\r\n                eventDate = dhis2Event.eventDate;\r\n            }\r\n    \r\n            if(dhis2Event.status === 'COMPLETED'){\r\n                return 'custom-tracker-complete';//'stage-completed';\r\n            }\r\n            else if(dhis2Event.status === 'SKIPPED'){\r\n                return 'alert-default'; //'stage-skipped';\r\n            }\r\n            else{                \r\n                if(dhis2Event.eventDate){\r\n                    return 'alert-warning'; //'stage-executed';\r\n                }\r\n                else{\r\n                    if(moment(eventDate, calendarSetting.momentFormat).isAfter(dhis2Event.dueDate)){\r\n                        return 'alert-danger';//'stage-overdue';\r\n                    }                \r\n                    return 'alert-success';//'stage-on-time';\r\n                }               \r\n            }            \r\n        },\r\n        autoGenerateEvents: function(teiId, program, orgUnit, enrollment, availableEvent){\r\n            var dhis2Events = {events: []};\r\n            if(teiId && program && orgUnit && enrollment){\r\n                angular.forEach(program.programStages, function(stage){\r\n                    if(availableEvent && availableEvent.programStage && availableEvent.programStage === stage.id){\r\n                        var ev = availableEvent;\r\n                        ev.dueDate = ev.dueDate ? ev.dueDate : ev.eventDate;\r\n                        ev.trackedEntityInstance = teiId;\r\n                        ev.enrollment = enrollment.enrollment;\r\n                        delete ev.event;\r\n                        ev = reconstructEvent(ev, stage, CurrentSelection.getOptionSets());\r\n                        dhis2Events.events.push(ev);\r\n                    }\r\n                    \r\n                    if(stage.autoGenerateEvent && (!availableEvent || availableEvent && availableEvent.programStage && availableEvent.programStage !== stage.id)){\r\n                        var newEvent = {\r\n                                trackedEntityInstance: teiId,\r\n                                program: program.id,\r\n                                programStage: stage.id,\r\n                                orgUnit: orgUnit.id,\r\n                                enrollment: enrollment.enrollment\r\n                            };\r\n                        if(stage.periodType){\r\n                            var periods = getEventDuePeriod(null, stage, enrollment);\r\n                            newEvent.dueDate = DateUtils.formatFromUserToApi(periods[0].endDate);\r\n                            newEvent.eventDate = newEvent.dueDate;\r\n                        }\r\n                        else{\r\n                            newEvent.dueDate = DateUtils.formatFromUserToApi(getEventDueDate(null,stage, enrollment));\r\n                        }\r\n                        \r\n                        if(stage.openAfterEnrollment){\r\n                            if(stage.reportDateToUse === 'incidentDate'){\r\n                                newEvent.eventDate = DateUtils.formatFromUserToApi(enrollment.incidentDate);\r\n                            }\r\n                            else{\r\n                                newEvent.eventDate = DateUtils.formatFromUserToApi(enrollment.enrollmentDate);\r\n                            }\r\n                        }\r\n\r\n                        newEvent.status = newEvent.eventDate ? 'ACTIVE' : 'SCHEDULE';\r\n                        \r\n                        dhis2Events.events.push(newEvent);\r\n                    }\r\n                });\r\n            }\r\n            \r\n           return dhis2Events;\r\n        },\r\n        reconstruct: function(dhis2Event, programStage, optionSets){            \r\n            return reconstructEvent(dhis2Event, programStage, optionSets);            \r\n        },\r\n        processEvent: function(event, stage, optionSets, prStDes){\r\n            event.providedElsewhere = {};\r\n            angular.forEach(event.dataValues, function(dataValue){\r\n                \r\n                var prStDe = prStDes[dataValue.dataElement];\r\n\r\n                if( prStDe ){                \r\n                    var val = dataValue.value;\r\n                    if(prStDe.dataElement){\r\n                        val = CommonUtils.formatDataValue(event.event, val, prStDe.dataElement, optionSets, 'USER');                        \r\n                    }    \r\n                    event[dataValue.dataElement] = val;\r\n                    if(dataValue.providedElsewhere){\r\n                        event.providedElsewhere[dataValue.dataElement] = dataValue.providedElsewhere;\r\n                    }\r\n                    \r\n                    switch( prStDe.dataElement.valueType ){                        \r\n                        case \"ORGANISATION_UNIT\":\r\n                            CommonUtils.checkAndSetOrgUnitName( val );\r\n                            break;\r\n                    }\r\n                }\r\n\r\n            });        \r\n\r\n            if(stage.captureCoordinates){\r\n                event.coordinate = {latitude: event.coordinate.latitude ? event.coordinate.latitude : '',\r\n                                         longitude: event.coordinate.longitude ? event.coordinate.longitude : ''};\r\n            }        \r\n\r\n            event.allowProvidedElsewhereExists = false;        \r\n            for(var i=0; i<stage.programStageDataElements.length; i++){\r\n                if(stage.programStageDataElements[i].allowProvidedElsewhere){\r\n                    event.allowProvidedElsewhereExists = true;\r\n                    break;\r\n                }\r\n            }\r\n            return event;\r\n        },\r\n        getGridColumns: function(stage, prStDes){\r\n            var partial = [], allColumns = [];\r\n            partial.push({id: 'sortingDate', valueType: 'DATE', name: stage.executionDateLabel ? stage.executionDateLabel : $translate.instant('report_date')});\r\n            partial.push({id: 'orgUnitName', valueType: 'TEXT', name: $translate.instant('org_unit')});            \r\n            allColumns.push({id: 'sortingDate', valueType: 'DATE', name: stage.executionDateLabel ? stage.executionDateLabel : $translate.instant('report_date')});\r\n            allColumns.push({id: 'orgUnitName', valueType: 'TEXT', name: $translate.instant('org_unit')});\r\n            \r\n            var displayInReports = $filter('filter')(stage.programStageDataElements, {displayInReports: true});            \r\n            if( displayInReports.length > 0 ){\r\n                angular.forEach(displayInReports, function(c){\r\n                    if ( prStDes[c.dataElement.id] && prStDes[c.dataElement.id].dataElement) {\r\n                        partial.push({id: c.dataElement.id, valueType: prStDes[c.dataElement.id].dataElement.valueType, name: prStDes[c.dataElement.id].dataElement.displayFormName});\r\n                    }\r\n                });\r\n            }\r\n            for(var i=0; i<stage.programStageDataElements.length; i++){\r\n                if( i < $rootScope.maxGridColumnSize && displayInReports.length === 0){\r\n                    partial.push({id: stage.programStageDataElements[i].dataElement.id, valueType: stage.programStageDataElements[i].dataElement.valueType, name: prStDes[stage.programStageDataElements[i].dataElement.id].dataElement.displayFormName});\r\n                }                        \r\n                allColumns.push({id: stage.programStageDataElements[i].dataElement.id, valueType: stage.programStageDataElements[i].dataElement.valueType, name: prStDes[stage.programStageDataElements[i].dataElement.id].dataElement.displayFormName});\r\n            }            \r\n            return {partial: partial, all: allColumns};\r\n        },\r\n        getEditingStatus: function(dhis2Event, stage, orgUnit, tei, enrollment){\r\n            return (dhis2Event.orgUnit !== orgUnit.id && DateUtils.isValid(dhis2Event.eventDate)) || (stage.blockEntryForm && dhis2Event.status === 'COMPLETED') || tei.inactive || enrollment.status !== 'ACTIVE';\r\n        }\r\n    };    \r\n})\r\n\r\n.service('EventCreationService', function($modal){\r\n            \r\n        this.showModal = function(eventsByStage, stage, availableStages,programStages,selectedEntity,selectedProgram,selectedOrgUnit,selectedEnrollment, autoCreate, eventCreationAction,allEventsSorted, suggestedStage, selectedCategories){\r\n            var modalInstance = $modal.open({\r\n                templateUrl: 'components/dataentry/new-event.html',\r\n                controller: 'EventCreationController',\r\n                resolve: {                    \r\n                    eventsByStage: function () {\r\n                        return eventsByStage;\r\n                    },\r\n                    stage: function () {\r\n                        return stage;\r\n                    },                \r\n                    stages: function(){\r\n                        return availableStages;\r\n                    },\r\n                    allStages: function(){\r\n                        return programStages;\r\n                    },\r\n                    tei: function(){\r\n                        return selectedEntity;\r\n                    },\r\n                    program: function(){\r\n                        return selectedProgram;\r\n                    },\r\n                    orgUnit: function(){\r\n                        return selectedOrgUnit;\r\n                    },\r\n                    enrollment: function(){\r\n                        return selectedEnrollment;\r\n                    },\r\n                    autoCreate: function () {\r\n                        return autoCreate;\r\n                    },\r\n                    eventCreationAction: function(){\r\n                        return eventCreationAction;\r\n                    },\r\n                    events: function(){\r\n                        return allEventsSorted;\r\n                    },\r\n                    suggestedStage: function(){\r\n                        return suggestedStage;\r\n                    },\r\n                \tselectedCategories: function () {\r\n                    \treturn selectedCategories;\r\n\t                }\r\n                }\r\n            }).result;\r\n            return modalInstance;\r\n        };\r\n        this.eventCreationActions = { add: 'ADD',  schedule: 'SCHEDULE', referral: 'REFERRAL'};\r\n})\r\n\r\n.service('MessagingService', function($http, $translate,  NotificationService, DHIS2URL){\r\n    return {\r\n        sendMessage: function(message){            \r\n            var promise = $http.post( DHIS2URL + '/messages' , message).then(function(response){\r\n                var headerText, bodyText;\r\n                if (response && response.data && response.data.summaries) {\r\n                    var summary = response.data.summaries[0];\r\n                    if (summary.status) {\r\n                        headerText = summary.status;\r\n                        if (summary.responseMessage) {\r\n                            bodyText = summary.responseMessage;\r\n                        } else if (summary.errorMessage) {\r\n                            bodyText = summary.errorMessage;\r\n                        }else {\r\n                            bodyText = $translate.instant(\"failed_to_send_message\");\r\n                        }\r\n                        NotificationService.showNotifcationDialog(headerText, bodyText);\r\n                    }\r\n                }\r\n                return response.data;\r\n            }, function(response){\r\n                var headerText = $translate.instant('error');\r\n                var bodyText = $translate.instant('failed_to_send_message');\r\n                if (response && response.summaries && response.summaries[0].errorMessage) {\r\n                    bodyText = response.summaries[0].errorMessage;\r\n                }\r\n                NotificationService.showNotifcationDialog(headerText, bodyText);\r\n                return null;\r\n            });\r\n            return promise;            \r\n        }\r\n    };\r\n});\r\n\r\n\r\n\n\n\n// WEBPACK FOOTER //\n// ./scripts/services.js","'use strict';\r\n\r\n/* Filters */\r\n\r\nvar trackerCaptureFilters = angular.module('trackerCaptureFilters', [])\r\n\r\n.filter('eventListFilter', function($filter){    \r\n    \r\n    return function(pagedList, fullList, filterText){\r\n\r\n        if(!pagedList ){\r\n            return;\r\n        }\r\n        \r\n        if(!filterText){\r\n            return pagedList;\r\n        }        \r\n           \r\n        var filteredData = fullList && fullList.length ? fullList : pagedList;\r\n        filteredData = $filter('filter')(filteredData, filterText);\r\n        return filteredData;\r\n    }; \r\n})\r\n\r\n.filter('removeFuturePeriod', function($filter, CalendarService, DateUtils){\r\n\r\n    return function(periods, endDate){\r\n        \r\n        if(!periods){\r\n            return;\r\n        }\r\n        \r\n        if(!endDate){\r\n            return periods;\r\n        }\r\n        \r\n        var calendarSetting = CalendarService.getSetting();\r\n        periods = $filter('filter')(periods, function(period){            \r\n            return moment(DateUtils.getToday(), calendarSetting.momentFormat).isAfter(moment(period.startDate, calendarSetting.momentFormat)) || moment(DateUtils.getToday(), calendarSetting.momentFormat).isSame(moment(period.startDate, calendarSetting.momentFormat));\r\n        });\r\n\r\n        return periods;        \r\n           \r\n    };\r\n});\n\n\n// WEBPACK FOOTER //\n// ./scripts/filters.js","/* global directive, selection, dhis2, angular */\r\n\r\n'use strict';\r\n\r\n/* Directives */\r\n\r\nvar trackerCaptureDirectives = angular.module('trackerCaptureDirectives', [])\r\n\r\n.directive('stringToNumber', function () {\r\n    return {\r\n        require: 'ngModel',\r\n        link: function (scope, element, attrs, ngModel) {\r\n            ngModel.$parsers.push(function (value) {\r\n                return '' + value;\r\n            });\r\n            ngModel.$formatters.push(function (value) {\r\n                return parseFloat(value, 10);\r\n            });\r\n        }\r\n    };\r\n})\r\n.directive('heightChangeSource', function ($window) {\r\n    return {\r\n        link: function (scope, element, attrs) {\r\n            element.css(\"width\",\"100%\");\r\n            var w = angular.element($window);\r\n            scope.getWindowDimensions = function () {\r\n                return {\r\n                    'h': w.height(),\r\n                    'w': w.width()\r\n                };\r\n            };\r\n            scope.$watch(function(){\r\n                if(element.height()!== scope._height){\r\n                    scope._height = element.height();\r\n                }\r\n            });\r\n            scope.$watch(scope.getWindowDimensions, function (newValue, oldValue) {\r\n                if(scope._height !== element.height()){\r\n                    scope._height = element.height();\r\n                    console.log(\"heightChangeSourceb\");\r\n                }\r\n\r\n            }, true);\r\n            \r\n            w.bind('resize', function () {\r\n                scope.$apply();\r\n            });\r\n        }\r\n    };\r\n})\r\n.directive('heightChangeTarget', function () {\r\n    return {\r\n        link: function (scope, element, attrs) {\r\n            scope.$watch('_height', function (newValue, oldValue) {\r\n                if(newValue && newValue !== oldValue){\r\n                    element.css('padding-top',newValue);     \r\n                }\r\n\r\n            }, true);\r\n        }\r\n    };\r\n})\r\n\r\n.directive('eventstatusInTable', function (){\r\n    return {\r\n        restrict: 'E',\r\n        templateUrl: 'components/dataentry/eventstatus-in-table.html',\r\n        scope: {\r\n            event: '=',            \r\n            chosenEventWrapped: '=', //two-way-binding not working if not wrapped in object!\r\n            getEventStyle: '=',\r\n            programStage: '=',\r\n            optionSets: '=',            \r\n            completeActionCustom: '=', //optional\r\n            reopenActionCustom: '=', //optional\r\n            validateActionCustom: '=', //optional\r\n            deleteActionCustom: '=', //optional\r\n            skipActionCustom: '=', //optional\r\n            unskipActionCustom: '=', //optional\r\n            notesActionCustom: '=', //optional            \r\n            applicableButtons: '=', //optional\r\n            actions: '=',\r\n            allEvents: '=',\r\n            formData: '=',\r\n            buttonsEnabled: '&',\r\n            deleteActionExtended: '='\r\n        },\r\n        controller: [\r\n            '$scope',\r\n            '$element',\r\n            '$attrs',\r\n            '$q',\r\n            'EventUtils',\r\n            'DHIS2EventFactory',\r\n            'NotificationService',\r\n            '$translate',\r\n            function($scope, $element, $attrs, $q, EventUtils, DHIS2EventFactory, NotificationService, $translate){\r\n                \r\n                $scope.EVENTSTATUSCOMPLETELABEL = \"COMPLETED\";\r\n                $scope.EVENTSTATUSSKIPPEDLABEL = \"SKIPPED\";\r\n                $scope.EVENTSTATUSVISITEDLABEL = \"VISITED\";\r\n                $scope.EVENTSTATUSACTIVELABEL = \"ACTIVE\";\r\n                $scope.EVENTSTATUSSCHEDULELABEL = \"SCHEDULE\";\r\n                var COMPLETE = \"Complete\";\r\n                var INCOMPLETE = \"Incomplete\";\r\n                var VALIDATE = \"Validate\";\r\n                var DELETE = \"Delete\";    \r\n                var SKIP = \"Skip\";\r\n                var UNSKIP = \"Unskip\";\r\n                var NOTE = \"Note\";     \r\n                \r\n                $scope.completeAction = function() {                    \r\n                    if(angular.isDefined($scope.completeActionCustom)){\r\n                        $scope.completeActionCustom();\r\n                    }\r\n                    else {\r\n                        $scope.completeActionDefault();\r\n                    }\r\n                };     \r\n                \r\n                $scope.reopenAction = function() {                    \r\n                     if(angular.isDefined($scope.reopenActionCustom)){\r\n                        $scope.reopenActionCustom();\r\n                    }\r\n                    else {\r\n                        $scope.reopenActionDefault();\r\n                    }                  \r\n                };\r\n                \r\n                $scope.validateAction = function(){\r\n                    if(angular.isDefined($scope.validateActionCustom)){\r\n                        $scope.validateActionCustom();\r\n                    }                    \r\n                };\r\n                \r\n                $scope.deleteAction = function(){\r\n                    \r\n                    if(angular.isDefined($scope.deleteActionCustom)){\r\n                        $scope.deleteActionCustom();\r\n                    }\r\n                    else {\r\n                        var promise = $scope.deleteActionDefault();\r\n                        if(angular.isDefined($scope.deleteActionExtended)){\r\n                            promise.then(function(){\r\n                                $scope.deleteActionExtended();\r\n                            });\r\n                        }                        \r\n                    }\r\n\r\n                };\r\n                \r\n                $scope.skipAction = function(){\r\n                    if(angular.isDefined($scope.skipActionCustom)){\r\n                        $scope.skipActionCustom();\r\n                    }                    \r\n                };\r\n                \r\n                $scope.unskipAction = function(){\r\n                    if(angular.isDefined($scope.unskipActionCustom)){\r\n                        $scope.unskipActionCustom();\r\n                    }                    \r\n                };\r\n                \r\n                $scope.showNotes = function(){\r\n                    if(angular.isDefined($scope.notesActionCustom)){\r\n                        $scope.notesActionCustom();\r\n                    }\r\n                    else {\r\n                        $scope.notesModal();\r\n                    }                                       \r\n                };\r\n                \r\n                $scope.showNoteExistsIcon = true;\r\n                if(angular.isDefined($scope.applicableButtons)){\r\n                    $scope.showNoteExistsIcon = false;\r\n                    for(var i = 0; i < $scope.applicableButtons.length; i++){\r\n                        if($scope.applicableButtons[i] === NOTE){\r\n                            $scope.showNoteExistsIcon = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n                \r\n                $scope.notesSummary = function(){\r\n                    var summary = \"\";\r\n                    angular.forEach($scope.event.notes, function(note){                        \r\n                        if(summary !== \"\"){\r\n                            summary += \"<br/>\";\r\n                        }\r\n                        \r\n                        if(note.value.length > 30){\r\n                            //find index of space\r\n                            var noteSubstring = note.value.substr(0, 30);\r\n                            var lastSpace = noteSubstring.lastIndexOf(\" \");\r\n                            if(lastSpace !== -1){\r\n                                noteSubstring = noteSubstring.substr(0, lastSpace + 1);\r\n                            }                            \r\n                            \r\n                            summary += \"- \" + noteSubstring + \"...\";\r\n                        }\r\n                        else {\r\n                            summary += \"- \" + note.value;\r\n                        }\r\n                    });\r\n                    \r\n                    var summaryHeader = $translate.instant('notes');\r\n                    summaryHeader += \":<br/>\";\r\n                    \r\n                    var summaryFooter = \"<br/>(\" + $translate.instant('click_to_edit_view_complete_notes') + \")\";\r\n                    summary = \"<p align='left'>\" + summaryHeader + summary + summaryFooter + \"</p>\";\r\n                    return summary;\r\n                };\r\n                \r\n                $scope.eventTableOptions = {};    \r\n                $scope.eventTableOptions[COMPLETE] = {text: \"Complete\", tooltip: 'Complete', icon: \"<span class='glyphicon glyphicon-check'></span>\", value: COMPLETE, onClick: $scope.completeAction, sort: 0};\r\n                $scope.eventTableOptions[INCOMPLETE] = {text: \"Reopen\", tooltip: 'Reopen', icon: \"<span class='glyphicon glyphicon-pencil'></span>\", value: INCOMPLETE, onClick: $scope.reopenAction, sort: 1};\r\n                $scope.eventTableOptions[VALIDATE] = {text: \"Validate\", tooltip: 'Validate', icon: \"<span class='glyphicon glyphicon-cog'></span>\", value: VALIDATE, onClick: $scope.validateAction, sort: 2};    \r\n                $scope.eventTableOptions[DELETE] = {text: \"Delete\", tooltip: 'Delete', icon: \"<span class='glyphicon glyphicon-floppy-remove'></span>\", value: DELETE, onClick: $scope.deleteAction, sort: 3};\r\n                $scope.eventTableOptions[SKIP] = {text: \"Skip\", tooltip: 'Skip', icon: \"<span class='glyphicon glyphicon-step-forward'></span>\", value: SKIP, onClick: $scope.skipAction, sort: 4};\r\n                $scope.eventTableOptions[UNSKIP] = {text: \"Schedule back\", tooltip: 'Schedule back', icon: \"<span class='glyphicon glyphicon-step-backward'></span>\", value: UNSKIP, onClick: $scope.unskipAction, sort: 5};\r\n                $scope.eventTableOptions[NOTE] = {text: \"Notes\", tooltip: 'Show notes', icon: \"<span class='glyphicon glyphicon-list-alt'></span>\", value: NOTE, onClick: $scope.showNotes, sort: 6};\r\n                \r\n                $scope.event.validatedEventDate = $scope.event.eventDate;   \r\n    \r\n                updateEventTableOptions();\r\n\r\n                $scope.$watch(\"event.status\", function(newValue, oldValue){        \r\n                    \r\n                    if(newValue !== oldValue){\r\n                        updateEventTableOptions();\r\n                    }\r\n                });\r\n\r\n                $scope.$watch(\"validatedDateSetForEvent\", function(newValue, oldValue){                        \r\n\r\n                    if(angular.isDefined(newValue)){\r\n                        if(!angular.equals(newValue, {})){\r\n                            var updatedEvent = newValue.event;\r\n                            if(updatedEvent === $scope.event){                    \r\n                                    $scope.event.validatedEventDate = newValue.date; \r\n                                    updateEventTableOptions();                    \r\n                            }\r\n                        }\r\n                    } \r\n                });\r\n\r\n                function updateEventTableOptions(){\r\n\r\n                    var eventRow = $scope.event;        \r\n\r\n                    for(var key in $scope.eventTableOptions){\r\n                        $scope.eventTableOptions[key].show = true;\r\n                        $scope.eventTableOptions[key].disabled = false;\r\n                    }\r\n\r\n                    $scope.eventTableOptions[UNSKIP].show = false;        \r\n\r\n                    switch(eventRow.status){\r\n                        case $scope.EVENTSTATUSCOMPLETELABEL:\r\n                            $scope.eventTableOptions[COMPLETE].show = false;\r\n                            $scope.eventTableOptions[SKIP].show = false;                            \r\n                            $scope.eventTableOptions[VALIDATE].show = false;                                      \r\n                            $scope.defaultOption = $scope.eventTableOptions[INCOMPLETE];\r\n                            $scope.defaultOption2 = $scope.eventTableOptions[DELETE];\r\n                            break;\r\n                        case $scope.EVENTSTATUSSKIPPEDLABEL:\r\n                            $scope.eventTableOptions[COMPLETE].show = false;\r\n                            $scope.eventTableOptions[INCOMPLETE].show = false;\r\n                            $scope.eventTableOptions[VALIDATE].show = false;                \r\n                            $scope.eventTableOptions[SKIP].show = false;\r\n\r\n                            $scope.eventTableOptions[UNSKIP].show = true;\r\n                            $scope.defaultOption = $scope.eventTableOptions[UNSKIP];\r\n                            $scope.defaultOption2 = $scope.eventTableOptions[DELETE];\r\n                            break;            \r\n                        default:                 \r\n                            if(eventRow.validatedEventDate){\r\n                                $scope.eventTableOptions[INCOMPLETE].show = false;\r\n                                $scope.defaultOption = $scope.eventTableOptions[COMPLETE];\r\n                                $scope.defaultOption2 = $scope.eventTableOptions[DELETE];\r\n                            }\r\n                            else {\r\n                                $scope.eventTableOptions[INCOMPLETE].show = false;                    \r\n                                $scope.eventTableOptions[VALIDATE].show = false;\r\n                                $scope.eventTableOptions[COMPLETE].disabled = true;\r\n                                $scope.defaultOption = $scope.eventTableOptions[COMPLETE];\r\n                                $scope.defaultOption2 = $scope.eventTableOptions[DELETE];\r\n                            }                          \r\n                            break;\r\n                    }\r\n\r\n                    createOptionsArray();\r\n                }\r\n\r\n                function createOptionsArray(){\r\n                    $scope.eventTableOptionsArr = [];                            \r\n                   \r\n                    if(angular.isDefined($scope.applicableButtons)){\r\n                        var defaultFound = false;\r\n                        for(var key in $scope.eventTableOptions){\r\n                            var show = false;\r\n                            \r\n                            for(var i = 0; i < $scope.applicableButtons.length; i++){\r\n                                if($scope.applicableButtons[i] === key){\r\n                                    show = true;\r\n                                    break;\r\n                                }\r\n                            }\r\n                            \r\n                            if(show){\r\n                                if($scope.eventTableOptions[key] === $scope.defaultOption){\r\n                                    defaultFound = true;\r\n                                }\r\n                                $scope.eventTableOptionsArr.push($scope.eventTableOptions[key]);\r\n                            }\r\n                        }\r\n                        \r\n                        $scope.eventTableOptionsArr.sort(function(a,b){                           \r\n                            return a.sort - b.sort;\r\n                        });\r\n                        \r\n                        if(!defaultFound){\r\n                            $scope.defaultOption = $scope.defaultOption2;\r\n                        }\r\n                    }\r\n                    else {\r\n                        for(var key in $scope.eventTableOptions){\r\n                            $scope.eventTableOptionsArr[$scope.eventTableOptions[key].sort] = $scope.eventTableOptions[key];\r\n                        }\r\n                    }\r\n                }\r\n                \r\n                //-----------                \r\n                $scope.notesModal = function(){\r\n                    \r\n                    var def = $q.defer();\r\n                    \r\n                    var bodyList = [];\r\n                    if($scope.event.notes) {\r\n                        for(var i = 0; i < $scope.event.notes.length; i++){\r\n                            var currentNote = $scope.event.notes[i];            \r\n                            bodyList.push({value1: currentNote.storedDate, value2: currentNote.value});\r\n                        }\r\n                    }\r\n\r\n                    var dialogOptions = {\r\n                        closeButtonText: 'Close',            \r\n                        textAreaButtonText: 'Add',\r\n                        textAreaButtonShow: $scope.event.status === $scope.EVENTSTATUSSKIPPEDLABEL ? false : true,\r\n                        headerText: 'Notes',\r\n                        bodyTextAreas: [{model: 'note', placeholder: 'Add another note here', required: true, show: $scope.event.status === $scope.EVENTSTATUSSKIPPEDLABEL ? false : true}],\r\n                        bodyList: bodyList,\r\n                        currentEvent: $scope.event\r\n                    };        \r\n\r\n                    var dialogDefaults = {\r\n\r\n                        templateUrl: 'views/list-with-textarea-modal.html',\r\n                        controller: function ($scope, $modalInstance, DHIS2EventFactory, DateUtils) {                    \r\n                                $scope.modalOptions = dialogOptions;\r\n                                $scope.formSubmitted = false;\r\n                                $scope.currentEvent = $scope.modalOptions.currentEvent;\r\n                                $scope.textAreaValues = [];\r\n\r\n                                $scope.textAreaButtonClick = function(){                                               \r\n                                    if($scope.textAreaModalForm.$valid){                                \r\n                                        $scope.note = $scope.textAreaValues[\"note\"];\r\n                                        $scope.addNote();\r\n                                        $scope.textAreaModalForm.$setUntouched();\r\n                                        $scope.formSubmitted = false;                            \r\n                                    }\r\n                                    else {\r\n                                        $scope.formSubmitted = true;\r\n                                    }\r\n                                };                   \r\n\r\n                                $scope.modalOptions.close = function(){                        \r\n                                    $modalInstance.close($scope.currentEvent);\r\n                                };\r\n\r\n                                $scope.addNote = function(){\r\n\r\n                                    var newNote = {value: $scope.note};\r\n                                    var date = DateUtils.formatToHrsMins(new Date());                                    \r\n\r\n                                    var e = {event: $scope.currentEvent.event,\r\n                                            program: $scope.currentEvent.program,\r\n                                            programStage: $scope.currentEvent.programStage,\r\n                                            orgUnit: $scope.currentEvent.orgUnit,\r\n                                            trackedEntityInstance: $scope.currentEvent.trackedEntityInstance,\r\n                                            notes: [newNote]\r\n                                    };\r\n\r\n                                    DHIS2EventFactory.updateForNote(e).then(function (data) {\r\n                                        if (angular.isUndefined($scope.modalOptions.bodyList) || $scope.modalOptions.bodyList.length === 0) {\r\n                                            $scope.modalOptions.bodyList = [{value1: date, value2: newNote.value}];\r\n                                            $scope.modalOptions.currentEvent.notes = [{storedDate: date, value: newNote.value}];\r\n                                        }\r\n                                        else {\r\n                                            $scope.modalOptions.bodyList.splice(0, 0, {value1: date, value2: newNote.value});\r\n                                            $scope.modalOptions.currentEvent.notes.splice(0,0,{storedDate: date, value: newNote.value});\r\n                                        }\r\n                                            $scope.note = $scope.textAreaValues[\"note\"] = \"\";\r\n                                    });\r\n\r\n                                };                    \r\n                            }            \r\n                    };\r\n\r\n                    NotificationService.showNotifcationWithOptions (dialogDefaults, dialogOptions).then(function(e){\r\n                        $scope.event.notes = e.notes;\r\n                        def.resolve();\r\n                    });\r\n                    \r\n                    return def.promise;\r\n                };   \r\n                \r\n                if(angular.isDefined($scope.actions)){                    \r\n                    $scope.actions[$scope.event.event] = {};\r\n                    $scope.actions[$scope.event.event].notes = $scope.notesModal;\r\n                }\r\n                //-----------\r\n                \r\n                $scope.deleteActionDefault = function() {\r\n\r\n                    return DHIS2EventFactory.delete($scope.event).then(function (data) {\r\n                        \r\n                        var foundIndex = -1;\r\n                        //find index\r\n                        for(var i = 0; i < $scope.allEvents.length; i++){\r\n                            if($scope.allEvents[i] === $scope.event){\r\n                                foundIndex = i;\r\n                                break;\r\n                            }\r\n                        }\r\n                        \r\n                        if(foundIndex !== -1){\r\n                            $scope.allEvents.splice(foundIndex,1);                            \r\n                        }\r\n                        setChosenEventToNothing();\r\n                    });\r\n                };\r\n                \r\n                $scope.completeActionDefault = function() {                    \r\n                    \r\n                    $scope.event.submitted = true;\r\n                    if($scope.formData.$valid){\r\n                        var dhis2EventToUpdate = makeDhis2EventToUpdate();\r\n                        dhis2EventToUpdate.status = $scope.EVENTSTATUSCOMPLETELABEL;\r\n                        DHIS2EventFactory.update(dhis2EventToUpdate).then(function (data) {\r\n                            $scope.event.status = $scope.EVENTSTATUSCOMPLETELABEL;                                                  \r\n                            setChosenEventToNothing();  \r\n                            \r\n                            //reset dataElementStatus for event\r\n                            $scope.event.deStatus = {};\r\n                        });\r\n                    }\r\n                };\r\n                \r\n                $scope.reopenActionDefault = function () {\r\n                    var dhis2EventToUpdate = makeDhis2EventToUpdate();\r\n                    dhis2EventToUpdate.status = $scope.EVENTSTATUSACTIVELABEL;\r\n                    DHIS2EventFactory.update(dhis2EventToUpdate).then(function (data) {\r\n                        $scope.event.status = $scope.EVENTSTATUSACTIVELABEL;\r\n                    });\r\n                }\r\n                \r\n                function makeDhis2EventToUpdate() {\r\n                    \r\n                    var dhis2EventToUpdate = {};\r\n                    \r\n                    if(angular.isDefined($scope.programStage) && angular.isDefined($scope.optionSets)){\r\n                                                \r\n                        var dhis2Event = EventUtils.reconstruct($scope.event, $scope.programStage, $scope.optionSets);\r\n                        dhis2EventToUpdate = angular.copy(dhis2Event);\r\n                    }\r\n                    else {\r\n                        dhis2EventToUpdate = angular.copy($scope.event);                      \r\n                    }\r\n                    \r\n                    /*\r\n                    dhis2EventToUpdate.dataValues = [];\r\n                    \r\n                    for(var key in $scope.event[assocValuesProp]){\r\n                        dhis2EventToUpdate.dataValues.push($scope.event[assocValuesProp][key]);\r\n                    } */                   \r\n                    \r\n                    return dhis2EventToUpdate;\r\n                }\r\n                \r\n                function setChosenEventToNothing(){\r\n                    $scope.chosenEventWrapped.currentEvent = {};\r\n                }\r\n                \r\n                $scope.$watch('chosenEventWrapped.currentEvent', function(newEvent, oldEvent){                          \r\n                    if(angular.isDefined(newEvent)){\r\n                        \r\n                        if(newEvent !== oldEvent){\r\n                            $scope.chosenEvent = newEvent;\r\n                        }\r\n                    }                                        \r\n                });\r\n                \r\n                \r\n            }\r\n        ]\r\n    };\r\n})\r\n.directive('dhis2CompiledInclude', [\r\n  '$templateCache',\r\n  function($templateCache) {\r\n    return {\r\n      restrict: 'A',\r\n      priority: 400, // Same as ng-include\r\n      compile: function(element, attrs){        \r\n        var templateName = attrs.dhis2CompiledInclude;\r\n        if(!templateName){\r\n          throw new Error('ngInline: expected template name');\r\n        }\r\n        var template = $templateCache.get(templateName);\r\n     \t  if(angular.isUndefined(template)){\r\n          throw new Error('ngInline: unknown template ' + templateName);\r\n        }\r\n        element.html(template);\r\n      }\r\n    };\r\n  }\r\n])\r\n.directive('modalBody', function (){\r\n    return {\r\n        restrict: 'E',\r\n        templateUrl: 'views/modal-body.html',\r\n        scope: {\r\n            body: '='\r\n        },\r\n        controller: [\r\n            '$scope',\r\n            '$translate',\r\n            function($scope, $translate){\r\n                \r\n            }\r\n        ]\r\n    }\r\n});\n\n\n// WEBPACK FOOTER //\n// ./scripts/directives.js","var trackerCapture = angular.module('trackerCapture');\r\n\r\ntrackerCapture.controller('SelectionController',\r\nfunction($rootScope,\r\n         $scope,\r\n         $modal,\r\n         $location,\r\n         $filter,\r\n         $timeout,\r\n         $translate,\r\n         $q,\r\n         orderByFilter,\r\n         Paginator,\r\n         SessionStorageService,\r\n         MetaDataFactory,\r\n         DateUtils,\r\n         OrgUnitFactory,\r\n         OperatorFactory,\r\n         ProgramFactory,\r\n         AttributesFactory,\r\n         EntityQueryFactory,\r\n         CurrentSelection,\r\n         TEIGridService,\r\n         TEIService,\r\n         EventReportService,\r\n         TCStorageService,\r\n         GridColumnService) {\r\n    var savedAdvancedSeachOptions = null;\r\n    var defaultColumn = {\r\n        id: 'created',\r\n        displayName: 'registration_date',\r\n        valueType: 'date',\r\n        displayInListNoProgram: false,\r\n        showFilter: false,\r\n        show: false\r\n    };\r\n    $scope.maxOptionSize = 30;\r\n    $scope.eventsTodayFilters = [{name: $translate.instant('events_today_all'), value: 'all'},{name: $translate.instant('events_today_completeoractive'),value: 'completedOrActive', status:['COMPLETED', 'ACTIVE']},{name: $translate.instant('events_today_skipped') , value: 'skipped', status:['SKIPPED']},{name: $translate.instant('events_today_scheduled'), value: 'scheduled', status:['SCHEDULE']}];\r\n    $scope.selectedEventsTodayFilter = $scope.eventsTodayFilters[0];\r\n    $scope.availablePrograms = {};\r\n    $scope.fileNames = {};\r\n    $scope.orgUnitNames = {};\r\n\r\n    //Selection\r\n    $scope.ouModes = [{name: 'SELECTED'}, {name: 'CHILDREN'}, {name: 'DESCENDANTS'}, {name: 'ACCESSIBLE'}];\r\n    $scope.selectedOuMode = $scope.ouModes[2];\r\n    $scope.dashboardProgramId = ($location.search()).program;\r\n    $scope.selectedOrgUnitId = ($location.search()).ou;\r\n    $scope.treeLoaded = false;\r\n    $scope.searchOuTree = {open: true};\r\n    $scope.teiListMode = {onlyActive: false};\r\n    $scope.enrollmentStatus = 'FIND';\r\n\r\n    //Searching\r\n    $scope.showSearchDiv = false;\r\n    $scope.model = {searchText: null, exportFormats:[\"XML\",\"JSON\",\"CSV\"]};\r\n    $scope.searchFilterExists = false;\r\n    $scope.defaultOperators = OperatorFactory.defaultOperators;\r\n    $scope.boolOperators = OperatorFactory.boolOperators;\r\n    $scope.enrollment = {enrollmentStartDate: '', enrollmentEndDate: '', incidentStartDate: '', incidentEndDate: '', operator: $scope.defaultOperators[0]};\r\n    $scope.searchMode = { listAll: 'LIST_ALL', freeText: 'FREE_TEXT', attributeBased: 'ATTRIBUTE_BASED' };\r\n    $scope.optionSets = null;\r\n    $scope.attributesById = null;\r\n    $scope.dataElementTranslations = null;\r\n    $scope.doSearch = true;\r\n\r\n    $scope.sortColumn = defaultColumn;\r\n\r\n\r\n    function resetParams(goToPage){\r\n        $scope.trackedEntityList = null;\r\n        $scope.sortColumn = {};\r\n        $scope.emptySearchText = false;\r\n        $scope.emptySearchAttribute = false;\r\n        $scope.showRegistrationDiv = false;\r\n        $scope.showTrackedEntityDiv = false;\r\n        $scope.teiFetched = false;\r\n        $scope.queryUrl = null;\r\n        $scope.programUrl = null;\r\n        $scope.teiFetched = false;\r\n        $scope.frontPageListEnabled = false;\r\n        $scope.attributeUrl = {url: null, hasValue: false};\r\n        if(!goToPage){\r\n            $scope.pager = {pageSize: 50, page: 1, toolBarDisplay: 5};\r\n        }\r\n\r\n    }\r\n\r\n    //watch for selection of org unit from tree\r\n    $scope.$watch('selectedOrgUnit', function() {\r\n        if( angular.isObject($scope.selectedOrgUnit)){\r\n            var selections = CurrentSelection.get();\r\n            var currentOrgUnit =  selections.orgUnit;//SessionStorageService.get('SELECTED_OU');\r\n            var newOrgUnitSelected = false;\r\n            if(currentOrgUnit) {\r\n                if(currentOrgUnit.id !== $scope.selectedOrgUnit.id){\r\n                    newOrgUnitSelected = true;\r\n                    updateOrgUnitInCurrentSelection();\r\n                    CurrentSelection.setAdvancedSearchOptions(null);\r\n                    if ($scope.attributes) {\r\n                        for (var index = 0; index < $scope.attributes.length; index++) {\r\n                            if ($scope.attributes[index].value && !$scope.attributes[index].confidential) {\r\n                                $scope.attributes[index].value = null;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            } else {\r\n                updateOrgUnitInCurrentSelection();\r\n            }\r\n\r\n            function updateOrgUnitInCurrentSelection() {\r\n                OrgUnitFactory.getFromStoreOrServer($scope.selectedOrgUnit.id).then(function (orgUnitFromStore) {\r\n                    if(orgUnitFromStore) {\r\n                        selections.orgUnit = orgUnitFromStore;\r\n                        CurrentSelection.set(selections);\r\n                        $scope.selectedOrgUnit.closedStatus = orgUnitFromStore.closedStatus;\r\n                    }\r\n                });\r\n            }\r\n\r\n            $scope.doSearch = true;\r\n            $scope.searchingOrgUnit = $scope.selectedOrgUnit;\r\n            $scope.trackedEntityList = null;\r\n            $scope.model.searchText = null;\r\n            $scope.optionSets = CurrentSelection.getOptionSets();\r\n            $scope.attributesById = CurrentSelection.getAttributesById();\r\n            savedAdvancedSeachOptions = CurrentSelection.getAdvancedSearchOptions();\r\n            if (savedAdvancedSeachOptions) {\r\n                if (!newOrgUnitSelected) {\r\n                    $scope.searchingOrgUnit = angular.copy(savedAdvancedSeachOptions.searchingOrgUnit);\r\n                }\r\n                $scope.selectedOuMode = angular.copy(savedAdvancedSeachOptions.selectedOuMode);\r\n                $scope.enrollment.programEnrollmentStartDate = savedAdvancedSeachOptions.programEnrollmentStartDate;\r\n                $scope.enrollment.programEnrollmentEndDate = savedAdvancedSeachOptions.programEnrollmentEndDate;\r\n                $scope.enrollment.programIncidentStartDate = savedAdvancedSeachOptions.programIncidentStartDate;\r\n                $scope.enrollment.programIncidentEndDate = savedAdvancedSeachOptions.programIncidentEndDate;\r\n                if (savedAdvancedSeachOptions.searchText) {\r\n                    $scope.model.searchText = savedAdvancedSeachOptions.searchText;\r\n                }\r\n                if (savedAdvancedSeachOptions.sortColumn) {\r\n                    $scope.sortColumn = angular.copy(savedAdvancedSeachOptions.sortColumn);\r\n                }\r\n\r\n                $scope.showSearchDiv = savedAdvancedSeachOptions.showSearchDiv;\r\n                $scope.teiFetched = savedAdvancedSeachOptions.teiFetched;\r\n                $scope.doSearch = savedAdvancedSeachOptions.doSearch;\r\n            }\r\n\r\n            if (newOrgUnitSelected) {\r\n                $scope.savedTeis = null;\r\n            } else {\r\n                $scope.savedTeis = CurrentSelection.getTrackedEntities();\r\n            }\r\n\r\n            if(!$scope.attributesById){\r\n                $scope.attributesById = [];\r\n                MetaDataFactory.getAll('attributes').then(function(atts){\r\n                    angular.forEach(atts, function(att){\r\n                        $scope.attributesById[att.id] = att;\r\n                    });\r\n                    CurrentSelection.setAttributesById($scope.attributesById);\r\n                });\r\n            }\r\n\r\n            if(!$scope.optionSets){\r\n                $scope.optionSets = [];\r\n                MetaDataFactory.getAll('optionSets').then(function(optionSets){\r\n                    angular.forEach(optionSets, function(optionSet){\r\n                        $scope.optionSets[optionSet.id] = optionSet;\r\n                    });\r\n                    CurrentSelection.setOptionSets($scope.optionSets);\r\n                });\r\n            }\r\n\r\n            GridColumnService.get(\"trackerCaptureGridColumns\").then(function (gridColumns) {\r\n                $scope.gridColumnsInUserStore = gridColumns;\r\n                $scope.ouLevels = CurrentSelection.getOuLevels();\r\n                if(!$scope.ouLevels){\r\n                    TCStorageService.currentStore.open().done(function(){\r\n                        TCStorageService.currentStore.getAll('ouLevels').done(function(response){\r\n                            var ouLevels = angular.isObject(response) ? orderByFilter(response, '-level').reverse() : [];\r\n                            CurrentSelection.setOuLevels(orderByFilter(ouLevels, '-level').reverse());\r\n                        });\r\n                    });\r\n                }\r\n\r\n            //Labels\r\n                $scope.trackerCaptureLabel = $translate.instant('tracker_capture');\r\n                $scope.orgUnitLabel = $translate.instant('org_unit');\r\n                $scope.listAllLabel = $translate.instant('list_all');\r\n                $scope.registerLabel = $translate.instant('register');\r\n                $scope.searchOusLabel = $translate.instant('locate_organisation_unit_by_name');\r\n                $scope.printLabel = $translate.instant('print');\r\n                $scope.searchLabel = $translate.instant('search');\r\n                $scope.findLabel = $translate.instant('find');\r\n                $scope.advancedSearchLabel = $translate.instant('advanced_search');\r\n                $scope.allEnrollmentsLabel = $translate.instant('all_enrollment');\r\n                $scope.completedEnrollmentsLabel = $translate.instant('completed_enrollment');\r\n                $scope.activeEnrollmentsLabel = $translate.instant('active_enrollment');\r\n                $scope.cancelledEnrollmentsLabel = $translate.instant('cancelled_enrollment');\r\n                $scope.searchCriteriaLabel = $translate.instant('type_your_search_criteria_here');\r\n                $scope.programSelectLabel = $translate.instant('please_select_a_program');\r\n                $scope.settingsLabel = $translate.instant('settings');\r\n                $scope.showHideLabel = $translate.instant('show_hide_columns');\r\n                $scope.listProgramsLabel = $translate.instant('list_programs');\r\n                $scope.settingsLabel = $translate.instant('settings');\r\n                $scope.todayLabel = $translate.instant('events_today_persons');\r\n                angular.forEach($scope.eventsTodayFilters, function(filter){\r\n                    filter.name = $translate.instant(filter.name);\r\n                });\r\n                $scope.displayModeLabel = $translate.instant('display_mode');\r\n\r\n                resetParams();\r\n                //$scope.doSearch = true;\r\n                $scope.loadPrograms($scope.selectedOrgUnit);\r\n            });\r\n        }\r\n    });\r\n\r\n    //watch for changes in ou mode - mode could be selected without notifcation to grid column generator\r\n    $scope.$watch('selectedOuMode.name', function() {\r\n        if( $scope.selectedOuMode.name && angular.isObject($scope.gridColumns)){\r\n            var continueLoop = true;\r\n            for(var i=0; i<$scope.gridColumns.length && continueLoop; i++){\r\n                if($scope.gridColumns[i].id === 'orgUnitName' && $scope.selectedOuMode.name !== 'SELECTED'){\r\n                    $scope.gridColumns[i].show = true;\r\n                    continueLoop = false;\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n    //watch for program feedback (this is when coming back from dashboard)\r\n    if($scope.dashboardProgramId && $scope.dashboardProgramId !== 'null'){\r\n        ProgramFactory.get($scope.dashboardProgramId).then(function(program){\r\n            $scope.selectedProgram = program;\r\n        });\r\n    }\r\n\r\n    //load programs associated with the selected org unit.\r\n    $scope.loadPrograms = function(orgUnit) {\r\n        $scope.selectedOrgUnit = orgUnit;\r\n\r\n        if (angular.isObject($scope.selectedOrgUnit)) {\r\n\r\n            ProgramFactory.getProgramsByOu($scope.selectedOrgUnit, $scope.selectedProgram).then(function(response){\r\n                $scope.programs = response.programs;\r\n                $scope.selectedProgram = response.selectedProgram;\r\n                $scope.model.selectedProgram = $scope.selectedProgram;\r\n                $scope.trackedEntityList = null;\r\n                $scope.selectedSearchMode = $scope.searchMode.listAll;\r\n                $scope.processAttributes();\r\n                $scope.restoreGridColumnsFromUserStore();\r\n            });\r\n        }\r\n    };\r\n\r\n    $scope.getProgramAttributes = function(program){\r\n        resetParams();\r\n        $scope.doSearch = true;\r\n        $scope.selectedProgram = program;\r\n        $scope.trackedEntityList = null;\r\n        $scope.model.searchText = null;\r\n        $scope.savedTeis = null;\r\n        CurrentSelection.setAdvancedSearchOptions(null);\r\n        savedAdvancedSeachOptions = null;\r\n        $scope.gridColumns = null;\r\n        $scope.processAttributes();\r\n        $scope.restoreGridColumnsFromUserStore();\r\n    };\r\n\r\n    /*If gridCoulumns for a program is stored in user data store then it is restored when\r\n     * the program is selected. If the grid columns are not stored then the grid columns are set\r\n     * as the default one for that program (in $scope.search() function)*/\r\n    $scope.restoreGridColumnsFromUserStore = function() {\r\n        if($scope.gridColumnsInUserStore && $scope.selectedProgram && $scope.selectedProgram.id) {\r\n            if ($scope.gridColumnsInUserStore[$scope.selectedProgram.id]) {\r\n                $scope.gridColumns = $scope.gridColumnsInUserStore[$scope.selectedProgram.id];\r\n            }\r\n        }\r\n    }\r\n\r\n    $scope.processAttributes = function(){\r\n        if(savedAdvancedSeachOptions && savedAdvancedSeachOptions.sortColumn) {\r\n            $scope.sortColumn = angular.copy(savedAdvancedSeachOptions.sortColumn);\r\n        } else {\r\n            $scope.sortColumn = {};\r\n        }\r\n        AttributesFactory.getByProgram($scope.selectedProgram).then(function(atts){\r\n            if (savedAdvancedSeachOptions) {\r\n                $scope.attributes = angular.copy(savedAdvancedSeachOptions.attributes);\r\n            } else {\r\n                $scope.attributes = AttributesFactory.generateAttributeFilters(atts);\r\n            }\r\n            if($scope.showRegistrationDiv){\r\n                $scope.doSearch = false;\r\n            }\r\n\r\n            $scope.setEnrollmentStatus();\r\n            if ($scope.savedTeis) {\r\n                restoreSavedTeis();\r\n            } else {\r\n                if ($scope.doSearch && $scope.selectedProgram && ($scope.selectedProgram.displayFrontPageList)) {\r\n                    $scope.search($scope.searchMode);\r\n                }\r\n            }\r\n        });\r\n\r\n        function restoreSavedTeis() {\r\n            if (savedAdvancedSeachOptions) {\r\n                $scope.gridColumns = angular.copy(savedAdvancedSeachOptions.gridColumns);\r\n                $scope.pager = angular.copy(savedAdvancedSeachOptions.pager);\r\n                Paginator.setPage($scope.pager.page);\r\n                Paginator.setPageCount($scope.pager.pageCount);\r\n                Paginator.setPageSize($scope.pager.pageSize);\r\n                Paginator.setItemCount($scope.pager.total);\r\n\r\n                $scope.frontPageListEnabled = savedAdvancedSeachOptions.frontPageListEnabled;\r\n                $scope.showTrackedEntityDiv = savedAdvancedSeachOptions.showTrackedEntityDiv;\r\n\r\n                //process tei grid\r\n                $scope.showSearchDiv = savedAdvancedSeachOptions.showSearchDiv;\r\n                $scope.teiFetched = savedAdvancedSeachOptions.teiFetched;\r\n                $scope.doSearch = savedAdvancedSeachOptions.doSearch;\r\n                $scope.reverse = savedAdvancedSeachOptions.reverse;\r\n                $scope.selectedSearchMode = savedAdvancedSeachOptions.searchMode;\r\n            }\r\n            $scope.trackedEntityList = $scope.savedTeis;\r\n            if (!$scope.sortColumn.id) {\r\n                $scope.sortColumn = defaultColumn;\r\n            }\r\n        }\r\n    };\r\n\r\n    $scope.setEnrollmentStatus =  function(){\r\n        if($rootScope.enrollmentStatus){\r\n            $scope.enrollmentStatus = $rootScope.enrollmentStatus;\r\n            $rootScope.enrollmentStatus = null;\r\n            $scope.filterByEnrollmentStatus($scope.enrollmentStatus, true);\r\n        }else if($scope.selectedProgram){\r\n            $scope.enrollmentStatus = 'ALL';\r\n        }\r\n    };\r\n\r\n    //sortGrid\r\n    $scope.sortGrid = function(gridHeader){\r\n        if ($scope.sortColumn && $scope.sortColumn.id === gridHeader.id){\r\n            $scope.reverse = !$scope.reverse;\r\n            CurrentSelection.setColumnReverse( $scope.reverse);\r\n            return;\r\n        }\r\n        $scope.sortColumn = gridHeader;\r\n        if($scope.sortColumn.valueType === 'date'){\r\n            $scope.reverse = true;\r\n        }\r\n        else{\r\n            $scope.reverse = false;\r\n        }\r\n        CurrentSelection.setSortColumn( $scope.sortColumn);\r\n        CurrentSelection.setColumnReverse( $scope.reverse);\r\n    };\r\n\r\n    $scope.d2Sort = function(tei){\r\n        if($scope.sortColumn && $scope.sortColumn.valueType === 'date'){\r\n            var d = tei[$scope.sortColumn.id];\r\n            return DateUtils.getDate(d);\r\n        }\r\n        return tei[$scope.sortColumn.id];\r\n    };\r\n\r\n    //$scope.searchParam = {bools: []};\r\n    $scope.search = function(mode,goToPage){\r\n        //resetParams(goToPage);\r\n        var grid;\r\n        if (!$scope.gridColumns) {\r\n            grid = TEIGridService.generateGridColumns($scope.attributes, $scope.selectedOuMode.name, true);\r\n            $scope.gridColumns = grid.columns;\r\n        }\r\n\r\n        $scope.selectedSearchMode = mode;\r\n        $scope.savedTeis = null;\r\n\r\n\r\n        //check search mode\r\n        if( $scope.selectedSearchMode === $scope.searchMode.freeText ){\r\n            $scope.frontPageListEnabled = true;\r\n            if($scope.enrollmentStatus === 'TODAY') {\r\n                $scope.enrollmentStatus = 'ALL';\r\n            }\r\n            if($scope.model.searchText){\r\n                $scope.queryUrl = 'query=LIKE:' + $scope.model.searchText;\r\n            } else {\r\n                if(!$scope.selectedProgram || !$scope.selectedProgram.displayFrontPageList){\r\n                    $scope.emptySearchText = true;\r\n                    $scope.teiFetched = false;\r\n                    return;\r\n                }\r\n            }\r\n            $scope.attributes = EntityQueryFactory.resetAttributesQuery($scope.attributes, $scope.enrollment);\r\n            $scope.searchingOrgUnit = $scope.selectedSearchingOrgUnit && $scope.selectedSearchingOrgUnit.id ? $scope.selectedSearchingOrgUnit : $scope.selectedOrgUnit;\r\n        } else {\r\n            $scope.model.searchText = null;\r\n            $scope.queryUrl = null;\r\n        }\r\n\r\n        if($scope.selectedProgram){\r\n            $scope.programUrl = 'program=' + $scope.selectedProgram.id;\r\n            if($scope.enrollmentStatus !== 'ALL'){\r\n                $scope.programUrl = 'program=' + $scope.selectedProgram.id + '&programStatus=' + $scope.enrollmentStatus;\r\n            }\r\n        }\r\n\r\n        if( $scope.selectedSearchMode === $scope.searchMode.attributeBased ) {\r\n            $scope.attributeUrl = EntityQueryFactory.getAttributesQuery($scope.attributes, $scope.enrollment);\r\n\r\n            if (!$scope.attributeUrl.hasValue) {\r\n                $scope.emptySearchAttribute = true;\r\n                $scope.teiFetched = false;\r\n                return;\r\n            }\r\n\r\n            $scope.searchingOrgUnit = $scope.selectedSearchingOrgUnit && $scope.selectedSearchingOrgUnit.id ? $scope.selectedSearchingOrgUnit : $scope.selectedOrgUnit;\r\n\r\n        } else {\r\n            if( $scope.attributeUrl && $scope.attributeUrl.hasValue) {\r\n                $scope.attributeUrl.url = null;\r\n                $scope.attributeUrl.hasValue = false;\r\n            }\r\n        }\r\n\r\n        if( $scope.selectedSearchMode === $scope.searchMode.listAll ){\r\n            $scope.model.searchText = null;\r\n            $scope.attributes = EntityQueryFactory.resetAttributesQuery($scope.attributes, $scope.enrollment);\r\n            $scope.searchingOrgUnit = $scope.selectedSearchingOrgUnit && $scope.selectedSearchingOrgUnit.id ? $scope.selectedSearchingOrgUnit : $scope.selectedOrgUnit;\r\n        }\r\n\r\n        $scope.doSearch = false;\r\n        $scope.fetchTeis();\r\n    };\r\n    $scope.fetchTeisEventsToday = function(eventsTodayFilter){\r\n        if(!$scope.selectedProgram){\r\n            $scope.teiFetched = true;\r\n            return;\r\n        }\r\n        $scope.teiFetched = false;\r\n        $scope.selectedEventsTodayFilter = eventsTodayFilter;\r\n        $scope.trackedEntityList = null;\r\n        var today = DateUtils.formatFromUserToApi(DateUtils.getToday());\r\n        var promises = [];\r\n        if(!eventsTodayFilter.status){\r\n            promises.push(EventReportService.getEventReport($scope.selectedOrgUnit.id,$scope.selectedOuMode.name, $scope.selectedProgram.id,today,today,'ACTIVE',null,$scope.pager));\r\n        }else{\r\n            angular.forEach(eventsTodayFilter.status, function(status){\r\n                promises.push(EventReportService.getEventReport($scope.selectedOrgUnit.id,$scope.selectedOuMode.name, $scope.selectedProgram.id,today,today,'ACTIVE',status,$scope.pager));\r\n            });\r\n        }\r\n        $q.all(promises).then(function(data){\r\n            $scope.trackedEntityList = { rows: {own:[]}};\r\n            var ids = [];\r\n            angular.forEach(data, function(result){\r\n                if(result && result.eventRows){\r\n                    angular.forEach(result.eventRows, function(eventRow){\r\n                        if(ids.indexOf(eventRow.trackedEntityInstance) === -1){\r\n\r\n                            var row = {\r\n                                id: eventRow.trackedEntityInstance,\r\n                                created: DateUtils.formatFromApiToUser(eventRow.trackedEntityInstanceCreated),\r\n                                orgUnit: eventRow.trackedEntityInstanceOrgUnit,\r\n                                orgUnitName: eventRow.trackedEntityInstanceOrgUnitName,\r\n                                inactive: eventRow.trackedEntityInstanceInactive\r\n                            };\r\n\r\n                            angular.forEach(eventRow.attributes, function(attr){\r\n                                row[attr.attribute] = attr.value;\r\n                            });\r\n                            $scope.trackedEntityList.rows.own.push(row);\r\n                            ids.push(eventRow.trackedEntityInstance);\r\n\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n            $scope.trackedEntityList.length = $scope.trackedEntityList.rows.own.length;\r\n            $scope.teiFetched = true;\r\n        });\r\n    };\r\n\r\n    $scope.fetchTeis = function(){\r\n        $scope.teiFetched = false;\r\n        $scope.trackedEntityList = null;\r\n        $scope.showTrackedEntityDiv = true;\r\n        $scope.eventsToday = false;\r\n        //get events for the specified parameters\r\n        if($scope.enrollmentStatus==='TODAY'){\r\n            $scope.fetchTeisEventsToday($scope.selectedEventsTodayFilter);\r\n        }else{\r\n            TEIService.search($scope.searchingOrgUnit.id,\r\n                $scope.selectedOuMode.name,\r\n                $scope.queryUrl,\r\n                $scope.programUrl,\r\n                $scope.attributeUrl.url,\r\n                $scope.pager,\r\n                true).then(function(data){\r\n                if (data && data.metaData && data.metaData.pager) {\r\n                    $scope.pager = data.metaData.pager;\r\n                    $scope.pager.toolBarDisplay = 5;\r\n\r\n                    Paginator.setPage($scope.pager.page);\r\n                    Paginator.setPageCount($scope.pager.pageCount);\r\n                    Paginator.setPageSize($scope.pager.pageSize);\r\n                    Paginator.setItemCount($scope.pager.total);\r\n                }\r\n\r\n                //process tei grid\r\n\r\n                $scope.trackedEntityList = TEIGridService.format($scope.selectedOrgUnit.id, data, false, $scope.optionSets, null);\r\n                $scope.showSearchDiv = false;\r\n                $scope.teiFetched = true;\r\n                $scope.doSearch = true;\r\n\r\n                if (!$scope.sortColumn.id) {\r\n                    $scope.sortGrid(defaultColumn);\r\n                }\r\n                CurrentSelection.setAdvancedSearchOptions({\r\n                    searchingOrgUnit: angular.copy($scope.searchingOrgUnit),\r\n                    searchMode: $scope.selectedSearchMode,\r\n                    gridColumns: angular.copy($scope.gridColumns),\r\n                    attributes: angular.copy($scope.attributes),\r\n                    selectedOuMode: angular.copy($scope.selectedOuMode),\r\n                    programEnrollmentStartDate: $scope.enrollment.programEnrollmentStartDate,\r\n                    programEnrollmentEndDate: $scope.enrollment.programEnrollmentEndDate,\r\n                    programIncidentStartDate: $scope.enrollment.programIncidentStartDate,\r\n                    programIncidentEndDate: $scope.enrollment.programIncidentEndDate,\r\n                    searchText: $scope.model.searchText,\r\n                    sortColumn: angular.copy($scope.sortColumn),\r\n                    pager: angular.copy($scope.pager),\r\n                    showSearchDiv: $scope.showSearchDiv,\r\n                    teiFetched: $scope.teiFetched,\r\n                    doSearch: $scope.doSearch,\r\n                    frontPageListEnabled: $scope.frontPageListEnabled,\r\n                    showTrackedEntityDiv: $scope.showTrackedEntityDiv,\r\n                    reverse: $scope.reverse\r\n                });\r\n                CurrentSelection.setTrackedEntities($scope.trackedEntityList);\r\n                $scope.fileNames = CurrentSelection.getFileNames();\r\n                $scope.orgUnitNames = CurrentSelection.getOrgUnitNames();\r\n            });\r\n        }\r\n    };\r\n\r\n    $scope.jumpToPage = function(){\r\n        if($scope.pager && $scope.pager.page && $scope.pager.pageCount && $scope.pager.page > $scope.pager.pageCount){\r\n            $scope.pager.page = $scope.pager.pageCount;\r\n        }\r\n        $scope.search($scope.selectedSearchMode,true);\r\n    };\r\n\r\n    $scope.resetPageSize = function(){\r\n        $scope.pager.page = 1;\r\n        $scope.search(null,true);\r\n    };\r\n\r\n    $scope.getPage = function(page){\r\n        $scope.pager.page = page;\r\n        $scope.search($scope.selectedSearchMode, true);\r\n    };\r\n\r\n    $scope.clearEntities = function(){\r\n        $scope.trackedEntityList = null;\r\n    };\r\n\r\n    $scope.showRegistration = function(){\r\n        $scope.showRegistrationDiv = !$scope.showRegistrationDiv;\r\n        if($scope.showRegistrationDiv){\r\n            $scope.showTrackedEntityDiv = false;\r\n            $scope.showSearchDiv = false;\r\n            $timeout(function() {\r\n                $rootScope.$broadcast('registrationWidget', {registrationMode: 'REGISTRATION'});\r\n            }, 200);\r\n        }\r\n    };\r\n\r\n    $scope.showDisplayMode = function(){\r\n\r\n        var modalInstance = $modal.open({\r\n            templateUrl: 'views/display-mode-modal.html',\r\n            controller: 'DisplayModeController',\r\n            resolve: {\r\n                programs: function(){\r\n                    return $scope.programs;\r\n                }\r\n            }\r\n        });\r\n\r\n        modalInstance.result.then(function () {\r\n        }, function () {});\r\n    };    \r\n\r\n    $scope.showHideColumns = function(){\r\n        $scope.gridColumnsInUserStore = $scope.gridColumnsInUserStore ? $scope.gridColumnsInUserStore : {};\r\n        if($scope.selectedProgram) {\r\n            $scope.gridColumnsInUserStore[$scope.selectedProgram.id] = angular.copy( $scope.gridColumns );\r\n        }\r\n\r\n\r\n        var modalInstance = $modal.open({\r\n            templateUrl: 'views/column-modal.html',\r\n            controller: 'ColumnDisplayController',\r\n            resolve: {\r\n                gridColumns: function () {\r\n                    return $scope.gridColumns;\r\n                },\r\n                hiddenGridColumns: function(){\r\n                    return ($filter('filter')($scope.gridColumns, {show: false})).length;\r\n                },\r\n                gridColumnDomainKey: function(){\r\n                    return \"trackerCaptureGridColumns\";\r\n                },\r\n                gridColumnKey: function(){\r\n                    if(!$scope.selectedProgram) {\r\n                        return null;\r\n                    }\r\n                    return $scope.selectedProgram.id;\r\n                },\r\n                gridColumnsInUserStore: function(){\r\n                    return $scope.gridColumnsInUserStore;\r\n                }\r\n            }\r\n        });\r\n\r\n        modalInstance.result.then(function (gridColumns) {\r\n        }, function () {\r\n        });\r\n    };\r\n\r\n    $scope.showDashboard = function(currentEntity){\r\n        var sortedTei = [];\r\n        var sortedTeiIds = [];\r\n        if($scope.trackedEntityList.rows && $scope.trackedEntityList.rows.own) {\r\n            sortedTei = sortedTei.concat($scope.trackedEntityList.rows.own);\r\n        }\r\n        if($scope.trackedEntityList.rows && $scope.trackedEntityList.rows.other) {\r\n            sortedTei = sortedTei.concat($scope.trackedEntityList.rows.other);\r\n        }\r\n        sortedTei = $filter('orderBy')(sortedTei, function(tei) {\r\n            return $scope.d2Sort(tei);\r\n        }, $scope.reverse);\r\n\r\n        angular.forEach(sortedTei, function(tei){\r\n            sortedTeiIds.push(tei.id);\r\n        });\r\n\r\n        CurrentSelection.setSortedTeiIds(sortedTeiIds);\r\n        $rootScope.enrollmentStatus = $scope.enrollmentStatus;\r\n        $location.path('/dashboard').search({tei: currentEntity.id,\r\n            program: $scope.selectedProgram ? $scope.selectedProgram.id: null,\r\n            ou: $scope.selectedOrgUnit.id});\r\n    };\r\n\r\n    $scope.getHelpContent = function(){\r\n    };\r\n\r\n    //Get orgunits for the logged in user\r\n    OrgUnitFactory.getSearchTreeRoot().then(function(response) {\r\n        $scope.orgUnits = response.organisationUnits;\r\n        angular.forEach($scope.orgUnits, function(ou){\r\n            ou.show = true;\r\n            angular.forEach(ou.children, function(o){\r\n                o.hasChildren = o.children && o.children.length > 0 ? true : false;\r\n            });\r\n        });\r\n        $scope.selectedSearchingOrgUnit = $scope.orgUnits[0] ? $scope.orgUnits[0] : null;\r\n    });\r\n    \r\n    \r\n    //expand/collapse of search orgunit tree\r\n    $scope.expandCollapse = function(orgUnit) {\r\n        if( orgUnit.hasChildren ){\r\n            //Get children for the selected orgUnit\r\n            OrgUnitFactory.getChildren(orgUnit.id).then(function(ou) {\r\n                orgUnit.show = !orgUnit.show;\r\n                orgUnit.hasChildren = false;\r\n                orgUnit.children = ou.children;\r\n                angular.forEach(orgUnit.children, function(ou){\r\n                    ou.hasChildren = ou.children && ou.children.length > 0 ? true : false;\r\n                });\r\n            });\r\n        }\r\n        else{\r\n            orgUnit.show = !orgUnit.show;\r\n        }\r\n    };\r\n\r\n    $scope.filterByEnrollmentStatus = function(status, doNotFetch){\r\n        if(status !== $scope.enrollmentStatus){\r\n            $scope.enrollmentStatus = status;\r\n            if($scope.enrollmentStatus === 'ALL'){\r\n                $scope.programUrl = 'program=' + $scope.selectedProgram.id;\r\n            }else if($scope.enrollmentStatus ==='TODAY'){\r\n                $scope.programUrl = 'program=' + $scope.selectedProgram.id + '&programStatus=' + $scope.enrollmentStatus;\r\n            }\r\n            else{\r\n                $scope.programUrl = 'program=' + $scope.selectedProgram.id + '&programStatus=' + $scope.enrollmentStatus;\r\n            }\r\n            if(!doNotFetch){\r\n                $scope.fetchTeis();\r\n            }\r\n\r\n        }\r\n    };\r\n\r\n    //load programs for the selected orgunit (from tree)\r\n    $scope.setSelectedSearchingOrgUnit = function(orgUnit){\r\n        $scope.selectedSearchingOrgUnit = orgUnit;\r\n    };\r\n\r\n    $scope.getExportList = function (format) {\r\n        var deferred = $q.defer();\r\n        var attrIdList = null;\r\n        var attrNamesList = [];\r\n        var attrNamesIdMap = {};\r\n        if (!format || ($scope.model.exportFormats.indexOf(format) === -1)) {\r\n            return;\r\n        }\r\n        format = format.toLowerCase();\r\n\r\n        angular.forEach($scope.gridColumns, function (item) {\r\n            if (item.show && item.attribute) {\r\n                if (!attrIdList) {\r\n                    attrIdList = \"attribute=\" + item.id;\r\n                } else {\r\n                    attrIdList += \"&attribute=\" + item.id;\r\n                }\r\n                attrNamesList.push(item.id);\r\n                attrNamesIdMap[item.displayName] = item.id;\r\n            }\r\n        });\r\n\r\n\r\n        TEIService.search($scope.searchingOrgUnit.id, $scope.selectedOuMode.name, $scope.queryUrl,\r\n            $scope.programUrl, attrIdList, false, false, format, attrNamesList, attrNamesIdMap, $scope.optionSets).then(function (data) {\r\n            var fileName = \"trackedEntityList.\" + format;// any file name with any extension\r\n            var a = document.createElement('a');\r\n            var blob, url;\r\n            a.style = \"display: none\";\r\n            blob = new Blob(['' + data], {type: \"octet/stream\", endings: 'native'});\r\n            url = window.URL.createObjectURL(blob);\r\n            a.href = url;\r\n            a.download = fileName;\r\n            document.body.appendChild(a);\r\n            a.click();\r\n            setTimeout(function () {\r\n                document.body.removeChild(a);\r\n                window.URL.revokeObjectURL(url);\r\n            }, 300);\r\n            deferred.resolve(data);\r\n        });\r\n        return deferred.promise;\r\n    };\r\n\r\n    $scope.exportEnabled = function() {\r\n        return $scope.trackedEntityList && $scope.trackedEntityList.length > 0 ;\r\n    };\r\n});\n\n\n// WEBPACK FOOTER //\n// ./scripts/controllers.js","//Controller for column show/hide\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('LeftBarMenuController',\n        function($scope,\n                $location) {\n    $scope.showHome = function(){\n        selection.load();\n        $location.path('/').search();\n    }; \n    \n    $scope.showReportTypes = function(){\n        $location.path('/report-types').search();\n    };\n\n    $scope.showQueueInterface = function(){\n        $location.path('/queue').search();\n    };\n\n    $scope.showApexQueueInterface = function(){\n       $location.path('/Apexqueue').search();\n    };\n\n});\n\n\n// WEBPACK FOOTER //\n// ./scripts/leftbar-menu-controller.js","//Controller for the header section\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('ReportTypesController',\n        function($scope,\n                $location) {    \n    $scope.programSummary = function(){\n        selection.load();\n        $location.path('/program-summary').search();\n    };\n    \n    $scope.programStatistics = function(){   \n        selection.load();\n        $location.path('/program-statistics').search();\n    };\n    \n    $scope.overdueEvents = function(){   \n        selection.load();\n        $location.path('/overdue-events').search();\n    };   \n    \n    $scope.upcomingEvents = function(){\n        selection.load();\n        $location.path('/upcoming-events').search();\n    };\n});\n\n\n// WEBPACK FOOTER //\n// ./scripts/report-types-controller.js","//Controller for column show/hide\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('DisplayModeController',\n        function($scope, $modalInstance) {\n    \n    $scope.close = function () {\n      $modalInstance.close($scope.gridColumns);\n    };\n});\n\n\n// WEBPACK FOOTER //\n// ./scripts/display-mode-controller.js","(function () {\n  'use strict';\n\n  var module = angular.module('sticky', []);\n\n  // Directive: sticky\n  //\n  module.directive('sticky', ['$window', function ($window) {\n      return {\n        restrict: 'A', // this directive can only be used as an attribute.\n        scope: {\n          disabled: '=disabledSticky'\n        },\n        link: function linkFn($scope, $elem, $attrs) {\n          var mediaQuery, stickyClass, unstickyClass, bodyClass, elem, $body,\n            doc, initialCSS, initialStyle, isSticking,\n            stickyLine, stickyBottomLine, offset, anchor, confine, prevOffset, matchMedia, usePlaceholder, placeholder;\n\n          $scope.initSticky = function () {\n            isSticking = false;\n\n            matchMedia = $window.matchMedia;\n\n            // elements\n            $body = angular.element(document.body);\n            elem = $elem[0];\n            doc = document.documentElement;\n\n            // attributes\n            mediaQuery = $attrs.mediaQuery || false;\n            stickyClass = $attrs.stickyClass || '';\n            unstickyClass = $attrs.unstickyClass || '';\n            bodyClass = $attrs.bodyClass || '';\n\n            usePlaceholder = $attrs.useplaceholder !== undefined;\n\n            initialStyle = $elem.attr('style') || '';\n\n            offset = typeof $attrs.offset === 'string' ?\n              parseInt($attrs.offset.replace(/px;?/, '')) :\n              0;\n\n            anchor = typeof $attrs.anchor === 'string' ?\n              $attrs.anchor.toLowerCase().trim()\n              : 'top';\n            // Define the confine attribute - will confine sticky to it's parent\n            confine = typeof $attrs.confine === 'string' ?\n              $attrs.confine.toLowerCase().trim() : 'false';\n\n            confine = (confine === 'true');\n\n            // initial style\n            initialCSS = {\n              zIndex: $elem.css('z-index'),\n              top: $elem.css('top'),\n              width: $elem.css('width'),\n              position: $elem.css('position'),\n              marginTop: $elem.css('margin-top'),\n              cssLeft: $elem.css('left')\n            };\n\n            switch (anchor) {\n              case 'top':\n              case 'bottom':\n                break;\n              default:\n                anchor = 'top';\n                break;\n            }\n\n            // Watcher\n            //\n            prevOffset = $scope.getTopOffset(elem);\n\n            // Listeners\n            //\n            angular.element($window).on('scroll', $scope.checkIfShouldStick);\n            angular.element($window).on('resize', $scope.$apply.bind($scope, $scope.onResize));\n            $scope.$on('$destroy', $scope.onDestroy);\n          };\n\n          $scope.getScrollTop = function () {\n            if (typeof $window.pageYOffset !== 'undefined') {\n              //most browsers except IE before #9\n              return $window.pageYOffset;\n            }\n            else {\n              var B = document.body; //IE 'quirks'\n              var D = document.documentElement; //IE with doctype\n              D = (D.clientHeight) ? D : B;\n              return D.scrollTop;\n            }\n          };\n\n          $scope.getTopOffset = function (element) {\n            if (element.getBoundingClientRect) {\n              // Using getBoundingClientRect is vastly faster, if it's available\n              return element.getBoundingClientRect().top + document.documentElement.scrollTop;\n            } else {\n              var pixels = 0;\n\n              if (element.offsetParent) {\n                do {\n                  pixels += element.offsetTop;\n                  element = element.offsetParent;\n                } while (element);\n              }\n\n              return pixels;\n            }\n          };\n\n          $scope.getBottomOffset = function (element) {\n            return element.offsetTop + element.clientHeight;\n          };\n\n          $scope.shouldStickWithLimit = function (shouldApplyWithLimit) {\n            if (shouldApplyWithLimit === 'true') {\n              var elementHeight = elem.offsetHeight;\n              var windowHeight = $window.innerHeight;\n              return (windowHeight - (elementHeight + parseInt(offset)) < 0);\n            } else {\n              return false;\n            }\n          };\n\n          $scope.onResize = function () {\n            initialCSS.offsetWidth = elem.offsetWidth;\n            $scope.unStickElement();\n            $scope.checkIfShouldStick();\n\n            if (isSticking) {\n              var parent = $window.getComputedStyle(elem.parentElement, null),\n                initialOffsetWidth = elem.parentElement.offsetWidth -\n                  parent.getPropertyValue('padding-right').replace('px', '') -\n                  parent.getPropertyValue('padding-left').replace('px', '');\n\n              $elem.css('width', initialOffsetWidth + 'px');\n            }\n          };\n\n          $scope.onDestroy = function () {\n            angular.element($window).off('scroll', $scope.checkIfShouldStick);\n            angular.element($window).off('resize', $scope.onResize);\n\n            if (bodyClass) {\n              $body.removeClass(bodyClass);\n            }\n\n            if (placeholder) {\n              placeholder.remove();\n            }\n          };\n\n          // Methods\n          //\n\n          // Simple helper function to find closest value\n          // from a set of numbers in an array\n          $scope.getClosest = function (array, num) {\n            var minDiff = 1000;\n            var ans;\n            for (var i in array) {\n              var m = Math.abs(num - array[i]);\n              if (m < minDiff) {\n                minDiff = m;\n                ans = array[i];\n              }\n            }\n            return ans;\n          };\n\n          $scope.stickElement = function () {\n            var rect, absoluteLeft;\n\n            rect = $elem[0].getBoundingClientRect();\n            absoluteLeft = rect.left;\n\n            initialCSS.offsetWidth = elem.offsetWidth;\n\n            isSticking = true;\n\n            if (bodyClass) {\n              $body.addClass(bodyClass);\n            }\n\n            if (unstickyClass) {\n              if ($elem.hasClass(unstickyClass)) {\n                $elem.removeClass(unstickyClass);\n              }\n            }\n\n            if (stickyClass) {\n              $elem.addClass(stickyClass);\n            }\n\n            //create placeholder to avoid jump\n            if (usePlaceholder) {\n              placeholder = angular.element('<div>');\n              var elementsHeight = $elem[0].offsetHeight;\n              placeholder.css('height', elementsHeight + 'px');\n              $elem.after(placeholder);\n            }\n\n            $elem\n              .css('z-index', '10')\n              .css('width', elem.offsetWidth + 'px')\n              .css('position', 'fixed')\n              .css(anchor, offset + 'px')\n              .css('left', absoluteLeft + 'px')\n              .css('margin-top', 0);\n\n            if (anchor === 'bottom') {\n              $elem.css('margin-bottom', 0);\n            }\n          };\n\n          $scope.checkIfShouldStick = function () {\n            if ($scope.disabled === true){\n              $scope.unStickElement();\n              return false;\n            }\n\n            var scrollTop, shouldStick, scrollBottom, scrolledDistance;\n\n            if (mediaQuery && !(matchMedia('(' + mediaQuery + ')').matches || matchMedia(mediaQuery).matches)) {\n              // Make sure to unstick element if media query no longer matches\n              if (isSticking) {\n                $scope.unStickElement();\n              }\n              return;\n            }\n\n            if (anchor === 'top') {\n              scrolledDistance = $window.pageYOffset || doc.scrollTop;\n              scrollTop = scrolledDistance - (doc.clientTop || 0);\n              if (confine === true) {\n                shouldStick = scrollTop >= stickyLine && scrollTop <= stickyBottomLine;\n              } else {\n                shouldStick = scrollTop >= stickyLine;\n              }\n\n            } else {\n              scrollBottom = $window.pageYOffset + $window.innerHeight;\n              shouldStick = scrollBottom <= stickyLine;\n            }\n\n            // Switch the sticky mode if the element crosses the sticky line\n            // $attrs.stickLimit - when it's equal to true it enables the user\n            // to turn off the sticky function when the elem height is\n            // bigger then the viewport\n            if (shouldStick && !$scope.shouldStickWithLimit($attrs.stickLimit) && !isSticking) {\n              $scope.stickElement();\n            } else if (!shouldStick && isSticking) {\n              // could probably do this better\n              var from, compare, closest;\n              compare = [stickyLine, stickyBottomLine];\n              closest = $scope.getClosest(compare, scrollTop);\n              // Check to see if we are closer to the top or bottom confines\n              // and set from to let the unstick element know the origin\n              if (closest === stickyLine) {\n                from = 'top';\n              } else if (closest === stickyBottomLine) {\n                from = 'bottom';\n              }\n\n              $scope.unStickElement(from, scrollTop);\n            }\n          };\n\n          // Passing in scrolltop and directional origin to help\n          // with some math later\n          $scope.unStickElement = function (fromDirection) {\n            $elem.attr('style', initialStyle);\n            isSticking = false;\n\n            if (bodyClass) {\n              $body.removeClass(bodyClass);\n            }\n\n            if (stickyClass) {\n              $elem.removeClass(stickyClass);\n            }\n\n            if (unstickyClass) {\n              $elem.addClass(unstickyClass);\n            }\n\n            if (fromDirection === 'top') {\n              $elem\n                .css('z-index', initialCSS.zIndex)\n                .css('width', '')\n                .css('top', initialCSS.top)\n                .css('position', initialCSS.position)\n                .css('left', initialCSS.cssLeft)\n                .css('margin-top', initialCSS.marginTop);\n\n            } else if (fromDirection === 'bottom' && confine === true) {\n              // make sure we are checking to see if the element is confined to the parent\n              $elem\n                .css('z-index', initialCSS.zIndex)\n                .css('width', '')\n                .css('top', '')\n                .css('bottom', 0)\n                .css('position', 'absolute')\n                .css('left', initialCSS.cssLeft)\n                .css('margin-top', initialCSS.marginTop)\n                .css('margin-bottom', initialCSS.marginBottom);\n            }\n\n            if (placeholder) {\n              placeholder.remove();\n            }\n          };\n\n          $scope.$watch(function () {\n            // triggered on load and on digest cycle\n            if ($scope.disabled === true){\n              $scope.unStickElement();\n              return;\n            }\n\n            if (isSticking) {\n              return prevOffset + $scope.getScrollTop();\n            }\n\n            prevOffset =\n              (anchor === 'top') ?\n                $scope.getTopOffset(elem) :\n                $scope.getBottomOffset(elem);\n\n            return prevOffset + $scope.getScrollTop();\n\n          }, function (newVal, oldVal) {\n            if (( newVal !== oldVal || typeof stickyLine === 'undefined' ) && newVal !== 0 && !isSticking) {\n              stickyLine = newVal - offset;\n\n              // IF the sticky is confined, we want to make sure the parent is relatively positioned,\n              // otherwise it won't bottom out properly\n\n              if (confine) {\n                $elem.parent().css({\n                  'position': 'relative'\n                });\n              }\n\n              // Get Parent height, so we know when to bottom out for confined stickies\n              var parent = $elem.parent()[0];\n              var parentHeight = parseInt(parent.offsetHeight);\n\n              // and now lets ensure we adhere to the bottom margins\n              // TODO: make this an attribute? Maybe like ignore-margin?\n              var marginBottom = parseInt($elem.css('margin-bottom').replace(/px;?/, '')) || 0;\n\n              // specify the bottom out line for the sticky to unstick\n              stickyBottomLine = parentHeight - (elem.offsetTop + elem.offsetHeight) + offset + marginBottom;\n\n              $scope.checkIfShouldStick();\n            }\n          });\n\n          // Init the directive\n          $scope.initSticky();\n        }\n      };\n    }]\n  );\n\n  // Shiv: matchMedia\n  //\n  window.matchMedia = window.matchMedia || (function () {\n      var warning = 'angular-sticky: This browser does not support ' +\n        'matchMedia, therefore the minWidth option will not work on ' +\n        'this browser. Polyfill matchMedia to fix this issue.';\n\n      if (window.console && console.warn) {\n        console.warn(warning);\n      }\n\n      return function () {\n        return {\n          matches: true\n        };\n      };\n    }());\n}());\n\n\n// WEBPACK FOOTER //\n// ./scripts/sticky.min.js","/* global angular, moment, dhis2 */\r\n\r\n'use strict';\r\n\r\n/* Services */\r\n\r\n/**\r\n * Created by hisp on 30/12/15.\r\n */\r\n\r\n\r\nangular.module('trackerCaptureServices')\r\n\r\n\r\n    .service('CustomIDGenerationService',function($http,$q,ProgramFactory,RegistrationService,CustomIdService){\r\n\r\n        return {\r\n            getOu: function (ou) {\r\n                var def = $q.defer();\r\n                $http.get('../api/organisationUnits/' + ou.id + \".json?fields=id,name,code,parent[id],attributeValues[attribute[id,name,code],value]\").then(function (response) {\r\n\r\n                    def.resolve(response.data);\r\n                });\r\n                return def.promise;\r\n            },\r\n            getCurrentToRootAttributeValue: function (ou, result, def) {\r\n                var promise = this.getOu(ou);\r\n                var thiz = this;\r\n                promise.then(function (ou) {\r\n\r\n                        for (var i=0;i<ou.attributeValues.length;i++){\r\n                            if (ou.attributeValues[i].attribute.code == \"facilityCode\"){\r\n                                result =   ou.attributeValues[i].value  + result;\r\n                            }\r\n                        }\r\n                    result =  \":\"+result;\r\n\r\n                    if (ou.parent == undefined) {\r\n                        def.resolve(result);\r\n                        return;\r\n                    } else {\r\n                        return thiz.getCurrentToRootAttributeValue(ou.parent, result, def);\r\n                    }\r\n                });\r\n                return def.promise();\r\n            },\r\n            createCustomId :  function(regDate,totalTeiCount,orgUnitCode){\r\n\r\n                var thisDef = $.Deferred();\r\n\r\n               \r\n                var prefix = \"\";\r\n                //console.log( \"total Count -- \" + response.data.height);\r\n                //var totalTei = response.data.height + 1;\r\n\r\n                var totalTei = totalTeiCount;\r\n                // for Reset after count 9999\r\n                //totalTei = 10000;\r\n                totalTei = totalTei%10000;\r\n\r\n                if( totalTei == 0 ) totalTei = 1;\r\n\r\n                if( totalTei <10) prefix=\"00\";\r\n                else if (totalTei >9 && totalTei<100) prefix=\"0\";\r\n                //else if(totalTei>99 && totalTei<1000) prefix=\"00\";\r\n               // else if(totalTei>999 && totalTei<10000) prefix=\"0\";\r\n                // change in requirement - adding random number\r\n                //prefix=Math.floor(Math.random()*(9999-1000) + 1000);\r\n                //def.resolve(constant + prefix + totalTei );\r\n\r\n                var finalCustomId = orgUnitCode +\"-\" + regDate + \"-\"+ prefix + totalTei;\r\n                thisDef.resolve(finalCustomId);\r\n\r\n                /*\r\n\r\n                def.then(function(currentToRootOrgunitCodes){\r\n                    var referenceLevel = 6;\r\n                    var codes = currentToRootOrgunitCodes.split(\":\");\r\n                    var level2Code = \"00\";\r\n                    var level5code = \"0000\";\r\n                    var level6code = \"00\";\r\n                    var randomNo =  Math.floor(Math.random()*(99999-10000) + 10000);\r\n                    if (codes[referenceLevel-4]){\r\n                        level2Code = codes[referenceLevel-4].substr(0,2);\r\n                    }\r\n                    if (codes[referenceLevel-1]){\r\n                        level5code = codes[referenceLevel-1].substr(0,4);\r\n                    }\r\n                    if (codes[referenceLevel]){\r\n                        level6code = codes[referenceLevel].substr(0,2);\r\n                    }\r\n\r\n                    var Id = level2Code+ level5code+ level6code+ randomNo;\r\n                    thisDef.resolve(Id);\r\n                })\r\n\r\n                 function random (low, high) {\r\n                 return Math.random() * (high - low) + low;\r\n                 }\r\n\r\n\r\n\r\n\r\n                 */\r\n\r\n                return thisDef;\r\n\r\n            },\r\n            createCustomIdAndSave: function(tei,customIDAttribute,optionSets,attributesById,regDate,totalTeiCount,orgUnitCode){\r\n                var def = $.Deferred();\r\n                console.log( regDate +\"--\"+ totalTeiCount + \"--\" + orgUnitCode);\r\n                this.createCustomId(regDate,totalTeiCount,orgUnitCode).then(function(customId){\r\n                    var attributeExists = false;\r\n                    angular.forEach(tei.attributes,function(attribute){\r\n                        if (attribute.attribute == customIDAttribute.id){\r\n                            attribute.value = customId;\r\n                            attributeExists = true;\r\n                        }\r\n                    });\r\n\r\n                    if (!attributeExists) {\r\n                        customIDAttribute.value = customId;\r\n                        tei.attributes.push(customIDAttribute);\r\n                    }\r\n\r\n                    var teI = {\r\n                        \"trackedEntity\": tei.trackedEntityInstance,\r\n                        \"orgUnit\": tei.orgUnit,\r\n                        \"attributes\": tei.attributes\r\n                    }\r\n                    RegistrationService.registerOrUpdate(tei,optionSets,attributesById).then(function(response){\r\n                        if (response.response.status == \"SUCCESS\"){\r\n                            //alert(\"Beneficiary Id : \" + customId);\r\n                        }\r\n                        def.resolve(response.data);\r\n                    })\r\n\r\n\r\n                });\r\n\r\n                return def;\r\n            },\r\n            validateAndCreateCustomId : function(tei,programUid,tEAttributes,destination,optionSets,attributesById,enrolmentdate) {\r\n                var def = $.Deferred();\r\n                var thiz = this;\r\n                var customIDAttribute;\r\n                var isValidProgram = false;\r\n                var isValidAttribute = false;\r\n                if (destination == 'PROFILE' || !destination || !programUid){\r\n                    def.resolve(\"Not Needed\");\r\n                    return def;\r\n                }\r\n                //ProgramFactory.get(programUid).then(function(program) {\r\n                CustomIdService.getProgramAttributeAndValue(programUid).then(function(data){\r\n                    if( data.attributeValues != undefined )\r\n                    {\r\n                        for (var i=0;i<data.attributeValues.length;i++)\r\n                        {\r\n                            if (data.attributeValues[i].attribute.code == 'allowRegistration' && data.attributeValues[i].value == \"true\"){\r\n                                isValidProgram = true; break;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    CustomIdService.getTEAttributesAttributeAndValue().then(function(tea) {\r\n                        if( tea.trackedEntityAttributes != undefined )\r\n                        {\r\n                            for (var j=0;j<tea.trackedEntityAttributes.length;j++)\r\n                            {\r\n                                if( tea.trackedEntityAttributes[j].attributeValues != undefined )\r\n                                {\r\n                                    for (var k=0;k<tea.trackedEntityAttributes[j].attributeValues.length;k++)\r\n                                    {\r\n                                        if (tea.trackedEntityAttributes[j].attributeValues[k].attribute.code == 'toBeUsedForCustomID' && tea.trackedEntityAttributes[j].attributeValues[k].value == \"true\")\r\n                                        {\r\n                                            isValidAttribute = true;\r\n                                            customIDAttribute = {\r\n                                                attribute : tea.trackedEntityAttributes[j].id,\r\n                                                displayName : tea.trackedEntityAttributes[j].name,\r\n                                                valueType : tea.trackedEntityAttributes[j].valueType,\r\n                                                value : \"\"\r\n                                            };\r\n                                            break;\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        if (isValidAttribute && isValidProgram)\r\n                        {\r\n                            var regDate = enrolmentdate;\r\n\t\t\t\t\t\t\tvar customRegDate=enrolmentdate.substring(8);\r\n\r\n                            //var customRegDate = regDate.split(\"-\")[2]+regDate.split(\"-\")[1]+regDate.split(\"-\")[0];\r\n\t\t\t\t\t\t//\tvar customRegDate = regDate.split(\"-\")[2]+regDate.split(\"-\")[2];\r\n\t\t\t\t\t\t\t\r\n                          //  var customRegDate = regDate.split(\"-\")[1]+regDate.split(\"-\")[0].slice(-2);\r\n\r\n                            CustomIdService.getTotalTeiByProgramAndOrgUnit(programUid,tei.orgUnit).then(function(teiResponse){\r\n\r\n                                var totalTei = teiResponse.trackedEntityInstances.length;\r\n                                CustomIdService.getOrgunitCode(tei.orgUnit).then(function(orgUnitCodeResponse){\r\n                                var orgUnitCode = orgUnitCodeResponse.code;\r\n                                    thiz.createCustomIdAndSave(tei,customIDAttribute,optionSets,attributesById,customRegDate,totalTei,orgUnitCode).then(function(response){\r\n                                        def.resolve(response);\r\n                                    });\r\n\r\n                                });\r\n\r\n                            });\r\n\r\n                        }\r\n                        else\r\n                        {\r\n                            def.resolve(\"Validation Failed\");\r\n                        }\r\n\r\n\r\n                    });\r\n\r\n                });\r\n\r\n                    /*\r\n                    var promise = this.getProgramAttributeAndValue(program);\r\n                    if( program.attributeValues != undefined )\r\n                    {\r\n                        for (var i=0;i<program.attributeValues.length;i++)\r\n                        {\r\n                            if (program.attributeValues[i].attribute.code == 'allowRegistration' && program.attributeValues[i].value == \"true\"){\r\n                                isValidProgram = true; break;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    angular.forEach(tEAttributes, function (tEAttribute) {\r\n                        if( tEAttribute.attributeValues != undefined )\r\n                        {\r\n                            for (var j=0;j<tEAttribute.attributeValues.length;j++)\r\n                            {\r\n                                if (tEAttribute.attributeValues[j].attribute.code == 'toBeUsedForCustomID' && tEAttribute.attributeValues[j].value == \"true\") {\r\n                                    isValidAttribute = true;\r\n                                    customIDAttribute = {\r\n                                        attribute : tEAttribute.id,\r\n                                        displayName : tEAttribute.name,\r\n                                        type : tEAttribute.valueType,\r\n                                        value : \"\"\r\n                                    };\r\n                                    break;\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                    });\r\n                    */\r\n                return def;\r\n            }\r\n        }\r\n    })\r\n\r\n    /*\r\n    .service('ProgramStageSequencingService',function(CalendarService,$filter,orderByFilter) {\r\n        return {\r\n            updateCurrentEventAfterDataValueChange: function(currentEvent,dataValue){\r\n                var isDePresent = false;\r\n\r\n                if (!currentEvent.dataValues){\r\n                    currentEvent.dataValues = [];\r\n                }\r\n                for (var i=0;i< currentEvent.dataValues.length;i++){\r\n                    if (currentEvent.dataValues[i].dataElement == dataValue.dataElement){\r\n                        currentEvent.dataValues[i].value = dataValue.value;\r\n                        isDePresent = true;\r\n                    }\r\n                }\r\n\r\n                if (!isDePresent){\r\n\r\n                    currentEvent.dataValues.push(dataValue);\r\n                }\r\n            },\r\n            getTargetStage : function(programStages,stagesById,currentStage){\r\n                \r\n                for (var i=0; i < programStages.length; i++){\r\n                    if (programStages[i].sortOrder == (currentStage.sortOrder % programStages.length)+1){\r\n                        return programStages[i];\r\n                    }\r\n                }\r\n                return currentStage;\r\n            },\r\n            addOffsetAndFormatDate : function(referenceDate,offset){\r\n                var calendarSetting = CalendarService.getSetting();\r\n\r\n                var date = moment(referenceDate, calendarSetting.momentFormat).add('d', offset)._d;\r\n                date = $filter('date')(date, calendarSetting.keyDateFormat);\r\n                \r\n                return date;\r\n            },\r\n            applySequencingOperationIfStageFlagged: function (dummyEvent,currentEvent,eventsByStage,programStages,stagesById,prStDes,currentStage) {\r\n\r\n                // initial checking for null values - happens when no events exist\r\n                if (!currentEvent || !currentStage)\r\n                    return dummyEvent;\r\n\r\n                var isStageSequencingEnabled = false;\r\n                var isDeValid = false;\r\n                var customTimeInterval = null;\r\n                var isCustomTimeIntervalEnabled = false;\r\n                var targetProgramStage = this.getTargetStage(programStages,stagesById,currentStage);\r\n\r\n\r\n                //check if stage is valid\r\n                for (var stageIndex=0;stageIndex<currentStage.attributeValues.length;stageIndex++){\r\n                    if (currentStage.attributeValues[stageIndex].attribute.code == \"isStageSequencingEnabled\" && currentStage.attributeValues[stageIndex].value == \"true\"){\r\n                        isStageSequencingEnabled = true;\r\n                    }\r\n                    if (currentStage.attributeValues[stageIndex].attribute.code == \"isCustomTimeIntervalEnabled\" && currentStage.attributeValues[stageIndex].value == \"true\"){\r\n                        isCustomTimeIntervalEnabled  = true;\r\n                    }\r\n                    if (currentStage.attributeValues[stageIndex].attribute.code == \"customTimeInterval\" && currentStage.attributeValues[stageIndex].value ){\r\n                        customTimeInterval  = currentStage.attributeValues[stageIndex].value;\r\n                    }\r\n\r\n                }\r\n                \r\n                if (isCustomTimeIntervalEnabled ){\r\n                    if (currentStage.periodType || !customTimeInterval){\r\n                        return dummyEvent;\r\n                    }\r\n                        var timeRange = customTimeInterval.split(\"-\");\r\n                        var evs = eventsByStage[currentStage.id];\r\n\r\n                        evs = orderByFilter(evs, '-eventDate');\r\n                        dummyEvent.dueDate = this.addOffsetAndFormatDate(evs[0].eventDate,timeRange[evs.length] ? timeRange[evs.length] : 0);\r\n                    return dummyEvent;\r\n                }\r\n                \r\n               \r\n                if (!isStageSequencingEnabled || !currentEvent.dataValues){\r\n                    return dummyEvent;\r\n                }\r\n\r\n                for (var dataValueIndex=0;dataValueIndex<currentEvent.dataValues.length;dataValueIndex++){\r\n                    for (var dataElementAttributeValueIndex=0;dataElementAttributeValueIndex<prStDes[currentEvent.dataValues[dataValueIndex].dataElement].dataElement.attributeValues.length;dataElementAttributeValueIndex++){\r\n                        if (prStDes[currentEvent.dataValues[dataValueIndex].dataElement].dataElement.attributeValues[dataElementAttributeValueIndex].attribute.code == \"stageSequencingSkipLogicDataValue\" &&\r\n                            prStDes[currentEvent.dataValues[dataValueIndex].dataElement].dataElement.attributeValues[dataElementAttributeValueIndex].value == currentEvent.dataValues[dataValueIndex].value){\r\n                            isDeValid = true;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (isDeValid){\r\n                    dummyEvent.programStage = targetProgramStage.id;\r\n                    dummyEvent.name = targetProgramStage.name;\r\n                    dummyEvent.reportDateDescription = targetProgramStage.reportDateDescription;\r\n\r\n                    if (!targetProgramStage.periodType){\r\n                        dummyEvent.dueDate = this.addOffsetAndFormatDate(currentEvent.eventDate,targetProgramStage.standardInterval ?  targetProgramStage.standardInterval : 0);\r\n                    }\r\n                }\r\n\r\n                return dummyEvent;\r\n            }\r\n\r\n\r\n        }\r\n    })\r\n\r\n*/\r\n// New Service for CustomId\r\n//http://127.0.0.1:8090/dhis/api/programs/y6lXVg8TdOj.json?fields=id,name,code,attributeValues[attribute[id,name,code],value]&paging=false\r\n//http://127.0.0.1:8090/dhis/api/trackedEntityAttributes.json?fields=id,name,valueType,attributeValues[attribute[id,name,code],value]&paging=false\r\n//var url =  'http://127.0.0.1:8090/dhis/api/trackedEntityInstances.json?program=y6lXVg8TdOj&ouMode=ALL;\r\n//127.0.0.1:8090/dhis/api/organisationUnits/sGXSQmbYeMk.json?fields=id,name,code,parent[id],attributeValues[attribute[id,name,code],value]&paging=false\r\n.service('CustomIdService',  function ($http,  $q){\r\n    return {\r\n        /*\r\n        getAllReportConfiguration: function () {\r\n            var promise = $http.get('../api/systemSettings/reportApp-configuration-json').then(function (response) {\r\n                return response.data ;\r\n            });\r\n            return promise;\r\n        },\r\n\r\n        saveReportConfiguration: function (configuration) {\r\n            var reportConfigurationJson = JSON.stringify(configuration);\r\n            var promise = $http.post('../api/systemSettings/reportApp-configuration-json?value=' + reportConfigurationJson, '', {headers: {'Content-Type': 'text/plain;charset=utf-8'}}).then(function (response) {\r\n                return response.data;\r\n            });\r\n            return promise;\r\n        },\r\n        deleteReportConfiguration: function(){\r\n            var promise = $http.delete('../api/systemSettings/reportApp-configuration-json').then(function (response) {\r\n                return response.data ;\r\n            });\r\n            return promise;\r\n        }\r\n        */\r\n\r\n        getProgramAttributeAndValue: function ( programUid ) {\r\n            var def = $q.defer();\r\n            $http.get('../api/programs/' + programUid + \".json?fields=id,name,code,attributeValues[attribute[id,name,code],value]&paging=false\").then(function (response) {\r\n\r\n                def.resolve(response.data);\r\n            });\r\n            return def.promise;\r\n        },\r\n\r\n        getTEAttributesAttributeAndValue: function () {\r\n            var def = $q.defer();\r\n            $http.get('../api/trackedEntityAttributes.json?fields=id,name,valueType,attributeValues[attribute[id,name,code],value]&paging=false').then(function (response) {\r\n\r\n                def.resolve(response.data);\r\n            });\r\n            return def.promise;\r\n        },\r\n\r\n        getTotalTeiByProgram: function ( programUid ) {\r\n            var def = $q.defer();\r\n            $http.get('../api/trackedEntityInstances.json?program=' + programUid + \"&ouMode=ALL&skipPaging=true\").then(function (response) {\r\n\r\n                def.resolve(response.data);\r\n            });\r\n            return def.promise;\r\n        },\r\n\r\n        getTotalTeiByProgramAndOrgUnit: function ( programUid,orgUnitId ) {\r\n            var def = $q.defer();\r\n            $http.get('../api/trackedEntityInstances.json?program=' + programUid + '&ou=' + orgUnitId + \"&skipPaging=true\").then(function (response) {\r\n\r\n                def.resolve(response.data);\r\n            });\r\n            return def.promise;\r\n        },\r\n        getOrgunitCode: function ( orgUnitUid ) {\r\n            var def = $q.defer();\r\n            $http.get('../api/organisationUnits/' + orgUnitUid + \".json?fields=id,name,code,parent[id],attributeValues[attribute[id,name,code],value]&paging=false\").then(function (response) {\r\n\r\n                def.resolve(response.data);\r\n            });\r\n            return def.promise;\r\n        }\r\n\r\n    };\r\n})\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n    .service('HideProgramFromDashboardService', function(){\r\n        return {\r\n            isProgramToBeUsedForRegistration : function(program){\r\n\r\n                for(var i=0;i < program.attributeValues.length;i++){\r\n                    if (program.attributeValues[i].attribute.code == \"allowRegistration\" && program.attributeValues[i].value == \"true\"){\r\n                        return true;\r\n                    }\r\n                }\r\n                return false;\r\n            }\r\n        }\r\n\r\n        });\r\n\r\n\r\n\n\n\n// WEBPACK FOOTER //\n// ./scripts/custom-services.js","/* global trackerCapture, angular */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('QueueController',\n                          function($rootScope,\n                                   $scope,\n                                   $timeout,$location,SessionStorageService,CurrentSelection\n                                  ) {\n\n\n\n                              var ouid = SessionStorageService.get('ouSelected');\n                              var selections = CurrentSelection.get();\n                              selection.load();\n\n                              debugger\n                              $scope.goToDashboard = function(ev){\n                                  ev.clicked=true;\n                                  var base = location.protocol + '//' + location.host+\"/dhis\";//+window.location.pathname;\n                                  $location.path('/dashboard').search({tei: ev.tei,\n                                                                       program: \"a9cQSlDVI2n\",\n                                                                       //  ou: \"CPtzIhyn36z\",\n                                                                       ou:ouid ,                        \n                                                                       queue:true});\n                                  // $window.open(base+'/dhis-web-tracker-capture/index.html#/dashboard?tei='+ev.tei+'&program=a9cQSlDVI2n&ou=CPtzIhyn36z'+$scope.ouId, '_blank');\n\n                              }\n                              \n                              $scope.loadQueue = function(){\n                                  var filtered_events = [];\n                                  $.getJSON('../api/sqlViews/eUtAa9bQ0rE/data.json?var=orgunit:'+ouid,function(response){\n\t\t\t\t      \n\t\t\t\t      var events = response.rows;\n                                      var sampleCollectedFlag = false;\n\t\t\t\t      console.log(response);\n\t\t\t\t      for(var i=0;i<response.rows.length;i++){\n                                          sampleCollectedFlag = false;\n\t\t\t\t          events[i].tei = response.rows[i][0];\n\t\t\t\t          events[i].aesid = response.rows[i][1];\n\t\t\t\t          events[i].nid = response.rows[i][2];\n\t\t\t\t          events[i].name = response.rows[i][3];\n\t\t\t\t          events[i].age = response.rows[i][4];\n\t\t\t\t          if(response.rows[i][6]==\"true\"){events[i].csfc = \"./images/tick.png\";\n                                                                         sampleCollectedFlag = true;\n                                                                         }\n\t\t\t\t          else{events[i].csfc = \"./images/cross.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][8]==\"true\"){events[i].serumc = \"./images/tick.png\";\n                                                                          sampleCollectedFlag = true;\n                                                                         }\n\t\t\t\t          else{events[i].serumc = \"./images/cross.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][10]==\"true\"){events[i].wbc = \"./images/tick.png\";\n                                                                           sampleCollectedFlag = true;\n                                                                           \n                                                                          }\n\t\t\t\t          else{events[i].wbc = \"./images/cross.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][11]==\"\"){events[i].csfwbcc = \"./images/cross.png\";}\n\t\t\t\t          else{events[i].csfwbcc = \"./images/tick.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][12]==\"\"){events[i].csfje = \"./images/cross.png\";}\n\t\t\t\t          else{events[i].csfje = \"./images/tick.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][13]==\"\"){events[i].csfg = \"./images/cross.png\";}\n\t\t\t\t          else{events[i].csfg = \"./images/tick.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][14]==\"\"){events[i].csfp = \"./images/cross.png\";}\n\t\t\t\t          else{events[i].csfp = \"./images/tick.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][15]==\"\"){events[i].csfwbcc2 = \"./images/cross.png\";}\n\t\t\t\t          else{events[i].csfwbcc2 = \"./images/tick.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][16]==\"\"){events[i].csfje2 = \"./images/cross.png\";}\n\t\t\t\t          else{events[i].csfje2 = \"./images/tick.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][17]==\"\"){events[i].serumje = \"./images/cross.png\";}\n\t\t\t\t          else{events[i].serumje = \"./images/tick.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][18]==\"\"){events[i].serumig = \"./images/cross.png\";}\n\t\t\t\t          else{events[i].serumig = \"./images/tick.png\";}\n\t\t\t\t          \n\t\t\t\t          if(response.rows[i][19]==\"\"){events[i].serumsti = \"./images/cross.png\";}\n\t\t\t\t          else{events[i].serumsti = \"./images/tick.png\";}\n\t\t\t\t          \n                                          if (sampleCollectedFlag){\n\t\t\t\t          filtered_events.push(events[i])\n                                          }\n\t\t\t\t      }\n\t\t\t\t      \n\t\t\t\t      \n                                      $timeout(function(){\n                                          $scope.queueEvents = filtered_events;\n                                      })\n                                  });\n                              }\n\n                              $scope.loadQueue();\n\n                              $scope.$watch('selectedOrgUnit', function() {\n                                  $scope.loadQueue();\n\n\n                              });\n                          });\n\n\n\n// WEBPACK FOOTER //\n// ./scripts/queue/queue-controller.js","/* global trackerCapture, angular */\n\n//Controller for dashboard\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('DashboardController',\n    function ($rootScope,\n            $scope,\n            $location,\n            $modal,\n            $timeout,\n            $filter,\n            $translate,\n            $q,\n            TCStorageService,\n            orderByFilter,\n            SessionStorageService,\n            TEIService,\n            TEService,\n            MetaDataFactory,\n            EnrollmentService,\n            ProgramFactory,\n            DHIS2EventFactory,\n            DashboardLayoutService,\n            AttributesFactory,\n            CurrentSelection,\n            ModalService,\n            AuthorityService,\n            OrgUnitFactory,\n            NotificationService) {\n    \n    //selections\n    var orgUnitUrl = ($location.search()).ou;\n    var queueRedirect = ($location.search()).queue;\n\n    $scope.displayEnrollment = false;\n    $scope.dataEntryMainMenuItemSelected = false;    \n    $scope.metaDataCached = false;\n    $scope.model = {orgUnitClosed: false};\n    if ( !dhis2.tc.metaDataCached){\n        downloadMetaData().then(function () {\n            updateDashboard();\n        });\n    }\n    else {\n        updateDashboard();\n    }\n\n    function getOrgUnit() {\n        var def = $q.defer();\n        var selection = CurrentSelection.get();\n        if(selection.orgUnit && selection.orgUnit.id === orgUnitUrl) {\n            def.resolve(selection.orgUnit);\n        } else {\n            OrgUnitFactory.getFromStoreOrServer(orgUnitUrl).then(function(ou){\n                def.resolve(ou);\n            })\n        }\n        return def.promise;\n    }    \n\n    function updateDashboard() {\n        \n        $scope.metaDataCached = true;\n\n        getOrgUnit().then(function (orgUnit) {\n            if (!orgUnit) {\n                return;\n            }\n\n            $scope.selectedTeiId = ($location.search()).tei;\n            $scope.selectedProgramId = ($location.search()).program;\n            $scope.selectedOrgUnit = orgUnit;\n            $scope.userAuthority = AuthorityService.getUserAuthorities(SessionStorageService.get('USER_PROFILE'));\n            $scope.sortedTeiIds = CurrentSelection.getSortedTeiIds();\n            $scope.useTopBar = false;\n            $scope.showSettingsButton = true;\n            $scope.topbarClass = $scope.showSettingsButton ? \"dashboard-info-box-sm\" : \"dashboard-info-box-lg\";\n            $scope.topbarRightSizeClass = $scope.showSettingsButton ? \"dashboard-info-btn-right-two-buttons\" : \"dashboard-info-btn-right-one-button\";\n\n            //Labels\n            $scope.removeLabel = $translate.instant('remove');\n            $scope.expandLabel = $translate.instant('expand');\n            $scope.collapseLabel = $translate.instant('collapse');\n            $scope.noDataReportLabel = $translate.instant('no_data_report');\n            $scope.noRelationshipLabel = $translate.instant('no_relationship');\n            $scope.settingsLabel = $translate.instant('settings');\n            $scope.showHideWidgetsLabel = $translate.instant('show_hide_widgets');\n            $scope.notEnrolledLabel = $translate.instant('not_yet_enrolled_data_entry');\n            $scope.stickLabel = $translate.instant('stick_right_widgets');\n            $scope.unstickLabel = $translate.instant('unstick_right_widgets');\n\n            $scope.model.stickyDisabled = true;\n            $scope.previousTeiExists = false;\n            $scope.nextTeiExists = false;\n\n            $scope.temporaryHideWidgets = [];\n            $scope.temporaryShowWidgets = [];\n\n            if ($scope.sortedTeiIds && $scope.sortedTeiIds.length > 0) {\n                var current = $scope.sortedTeiIds.indexOf($scope.selectedTeiId);\n\n                if (current !== -1) {\n                    if ($scope.sortedTeiIds.length - 1 > current) {\n                        $scope.nextTeiExists = true;\n                    }\n\n                    if (current > 0) {\n                        $scope.previousTeiExists = true;\n                    }\n                }\n            }\n\n            //get ouLevels\n            TCStorageService.currentStore.open().done(function () {\n                TCStorageService.currentStore.getAll('ouLevels').done(function (response) {\n                    var ouLevels = angular.isObject(response) ? orderByFilter(response, '-level').reverse() : [];\n                    CurrentSelection.setOuLevels(orderByFilter(ouLevels, '-level').reverse());\n                });\n            });\n\n            if ($scope.selectedTeiId) {\n\n                //get option sets\n                $scope.optionSets = [];\n\n                MetaDataFactory.getAll('optionSets').then(function (optionSets) {\n                    angular.forEach(optionSets, function (optionSet) {\n                        $scope.optionSets[optionSet.id] = optionSet;\n                    });\n\n                    AttributesFactory.getAll().then(function (atts) {\n\n                        $scope.attributesById = [];\n                        angular.forEach(atts, function (att) {\n                            $scope.attributesById[att.id] = att;\n                        });\n\n                        CurrentSelection.setAttributesById($scope.attributesById);\n\n                        //Fetch the selected entity\n                        TEIService.get($scope.selectedTeiId, $scope.optionSets, $scope.attributesById).then(function (response) {\n                            if (response) {\n                                $scope.selectedTei = response;\n\n                                //get the entity type\n                                TEService.get($scope.selectedTei.trackedEntity).then(function (te) {\n                                    $scope.trackedEntity = te;\n\n                                    //get enrollments for the selected tei\n                                    EnrollmentService.getByEntity($scope.selectedTeiId).then(function (response) {\n                                        if(!response) {\n                                            return;\n                                        }\n                                        var enrollments = angular.isObject(response) && response.enrollments ? response.enrollments : [];\n                                        var selectedEnrollment = null, backupSelectedEnrollment = null;\n                                        if (enrollments.length === 1) {\n                                            selectedEnrollment = enrollments[0];\n                                        } else {\n                                            if ($scope.selectedProgramId) {\n                                                angular.forEach(enrollments, function (en) {\n                                                    if (en.program === $scope.selectedProgramId) {\n                                                        if (en.status === 'ACTIVE') {\n                                                            selectedEnrollment = en;\n                                                        } else {\n                                                            backupSelectedEnrollment = en;\n                                                        }\n                                                    }\n                                                });\n                                            }\n                                        }\n                                        selectedEnrollment = selectedEnrollment ? selectedEnrollment : backupSelectedEnrollment;\n\n                                        ProgramFactory.getAll().then(function (programs) {\n                                            $scope.programs = [];\n                                            $scope.programNames = [];\n                                            $scope.programStageNames = [];\n\n                                            //get programs valid for the selected ou and tei\n                                            angular.forEach(programs, function (program) {\n                                                if (program.trackedEntity.id === $scope.selectedTei.trackedEntity) {\n                                                    $scope.programs.push(program);\n                                                    $scope.programNames[program.id] = {\n                                                        id: program.id,\n                                                        displayName: program.displayName\n                                                    };\n                                                    angular.forEach(program.programStages, function (stage) {\n                                                        $scope.programStageNames[stage.id] = {\n                                                            id: stage.id,\n                                                            displayName: stage.displayName\n                                                        };\n                                                    });\n\n                                                    if ($scope.selectedProgramId && program.id === $scope.selectedProgramId || selectedEnrollment && selectedEnrollment.program === program.id) {\n                                                        $scope.selectedProgram = program;\n                                                    }\n                                                }\n                                            });\n\n                                            //filter those enrollments that belong to available programs\n                                            var len = enrollments.length;\n                                            while (len--) {\n                                                if (enrollments[len].program && !$scope.programNames[enrollments[len].program]) {\n                                                    enrollments.splice(len, 1);\n                                                }\n                                            }\n\n                                            DHIS2EventFactory.getEventsByProgram($scope.selectedTeiId, null).then(function (events) {\n                                                //prepare selected items for broadcast\n                                                CurrentSelection.setSelectedTeiEvents(events);\n                                                CurrentSelection.set({\n                                                    tei: $scope.selectedTei,\n                                                    te: $scope.trackedEntity,\n                                                    prs: $scope.programs,\n                                                    pr: $scope.selectedProgram,\n                                                    prNames: $scope.programNames,\n                                                    prStNames: $scope.programStageNames,\n                                                    enrollments: enrollments,\n                                                    selectedEnrollment: selectedEnrollment,\n                                                    optionSets: $scope.optionSets,\n                                                    orgUnit: $scope.selectedOrgUnit\n                                                });\n                                                getDashboardLayout();\n                                            });\n                                        });\n                                    });\n                                });\n                            }\n                        });\n                    });\n                });\n            }            \n        });\n    }\n    \n    //dashboard items\n    var getDashboardLayout = function () {\n        $rootScope.dashboardWidgets = [];\n        $scope.widgetsChanged = [];\n        $scope.dashboardStatus = [];\n        $scope.dashboardWidgetsOrder = {biggerWidgets: [], smallerWidgets: []};\n        $scope.orderChanged = false;\n\n        DashboardLayoutService.get().then(function (response) {\n            $scope.dashboardLayouts = response;            \n            var defaultLayout = $scope.dashboardLayouts.defaultLayout['DEFAULT'];\n            var selectedLayout = null;\n            if ($scope.selectedProgram && $scope.selectedProgram.id) {\n                selectedLayout = $scope.dashboardLayouts.customLayout && $scope.dashboardLayouts.customLayout[$scope.selectedProgram.id] ? $scope.dashboardLayouts.customLayout[$scope.selectedProgram.id] : $scope.dashboardLayouts.defaultLayout[$scope.selectedProgram.id];\n            }\n            selectedLayout = !selectedLayout ? defaultLayout : selectedLayout;\n\n            $scope.model.stickyDisabled = selectedLayout.stickRightSide ? !selectedLayout.stickRightSide : true;\n\n            angular.forEach(selectedLayout.widgets, function (widget) {\n                if (widget.title !== \"activePrograms\") {\n                    $rootScope[widget.title + 'Widget'] = widget;\n                    $rootScope.dashboardWidgets.push($rootScope[widget.title + 'Widget']);\n                    $scope.dashboardStatus[widget.title] = angular.copy(widget);\n                }\n            });\n\n            angular.forEach(defaultLayout.widgets, function (w) {\n                if (!$scope.dashboardStatus[w.title]) {\n                    $rootScope[w.title + 'Widget'] = w;\n                    $rootScope.dashboardWidgets.push($rootScope[w.title + 'Widget']);\n                    $scope.dashboardStatus[w.title] = angular.copy(w);\n                }\n            });\n\n            $scope.hasBigger = false;\n            angular.forEach(orderByFilter($filter('filter')($scope.dashboardWidgets, {parent: \"biggerWidget\"}), 'order'), function (w) {\n                if (w.show) {\n                    $scope.hasBigger = true;\n                }\n                $scope.dashboardWidgetsOrder.biggerWidgets.push(w.title);\n            });\n\n            $scope.hasSmaller = false;\n            angular.forEach(orderByFilter($filter('filter')($scope.dashboardWidgets, {parent: \"smallerWidget\"}), 'order'), function (w) {\n                if (w.show) {\n                    $scope.hasSmaller = true;\n                }\n                $scope.dashboardWidgetsOrder.smallerWidgets.push(w.title);\n            });\n\n            setWidgetsSize();\n            $scope.broadCastSelections();\n            setInactiveMessage();\n        });\n    };\n\n    var setWidgetsSize = function () {\n\n        $scope.widgetSize = {smaller: \"col-sm-6 col-md-4\", bigger: \"col-sm-6 col-md-8\"};\n\n        if (!$scope.hasSmaller) {\n            $scope.widgetSize = {smaller: \"col-sm-1\", bigger: \"col-sm-11\"};\n        }\n\n        if (!$scope.hasBigger) {\n            $scope.widgetSize = {smaller: \"col-sm-11\", bigger: \"col-sm-1\"};\n        }\n    };\n\n    var setInactiveMessage = function () {\n        if ($scope.selectedTei.inactive) {\n            var teName = $scope.trackedEntity && $scope.trackedEntity.displayName ? $scope.trackedEntity.displayName : $translate.instance('tracked_entity_instance');\n            setHeaderDelayMessage(teName + \" \" + $translate.instant('tei_inactive_only_read'));\n        }\n    };\n    \n    //listen for any change to program selection\n    //it is possible that such could happen during enrollment.\n    $scope.$on('mainDashboard', function (event, args) {\n        var selections = CurrentSelection.get();\n        $scope.selectedProgram = null;\n        angular.forEach($scope.programs, function (pr) {\n            if (pr.id === selections.pr) {\n                $scope.selectedProgram = pr;\n            }\n        });\n\n        $scope.applySelectedProgram();\n    });\n\n    function getCurrentDashboardLayout() {\n        var widgets = [];\n        $scope.hasBigger = false;\n        $scope.hasSmaller = false;\n        angular.forEach($rootScope.dashboardWidgets, function (widget) {\n            var w = angular.copy(widget);\n            if ($scope.orderChanged) {\n                if ($scope.widgetsOrder.biggerWidgets.indexOf(w.title) !== -1) {\n                    $scope.hasBigger = $scope.hasBigger || w.show;\n                    w.parent = 'biggerWidget';\n                    w.order = $scope.widgetsOrder.biggerWidgets.indexOf(w.title);\n                }\n\n                if ($scope.widgetsOrder.smallerWidgets.indexOf(w.title) !== -1) {\n                    $scope.hasSmaller = $scope.hasSmaller || w.show;\n                    w.parent = 'smallerWidget';\n                    w.order = $scope.widgetsOrder.smallerWidgets.indexOf(w.title);\n                }\n            }\n            widgets.push(w);\n        });\n\n        return {widgets: widgets, program: $scope.selectedProgram && $scope.selectedProgram.id ? $scope.selectedProgram.id : 'DEFAULT'};\n    }\n\n    function saveDashboardLayout() {\n        var currentLayout = $scope.dashboardLayouts.customLayout ? angular.copy($scope.dashboardLayouts.customLayout) : {};\n        var programId = $scope.selectedProgram && $scope.selectedProgram.id ? $scope.selectedProgram.id : 'DEFAULT';        \n        currentLayout[programId] = getCurrentDashboardLayout();\n        \n        DashboardLayoutService.saveLayout(currentLayout, false).then(function () {\n            if (!$scope.orderChanged) {\n                $scope.hasSmaller = $filter('filter')($scope.dashboardWidgets, {\n                    parent: \"smallerWidget\",\n                    show: true\n                }).length > 0;\n                $scope.hasBigger = $filter('filter')($scope.dashboardWidgets, {\n                    parent: \"biggerWidget\",\n                    show: true\n                }).length > 0;\n            }\n            setWidgetsSize();\n        });\n    };\n    \n    $scope.saveDashboarLayoutAsDefault = function () {\n        var layout = angular.copy($scope.dashboardLayouts.defaultLayout);        \n        var programId = $scope.selectedProgram && $scope.selectedProgram.id ? $scope.selectedProgram.id : 'DEFAULT';        \n        layout[programId] = getCurrentDashboardLayout();\n        delete layout.DEFAULT;\n        DashboardLayoutService.saveLayout(layout, true);\n    };\n\n    //persist widget sorting\n    $scope.applyWidgetsOrderChange = function(param){\n        $scope.widgetsOrder = param;\n        $scope.orderChanged = false;\n        for (var i = 0; i < $scope.widgetsOrder.smallerWidgets.length; i++) {\n            if ($scope.widgetsOrder.smallerWidgets.length === $scope.dashboardWidgetsOrder.smallerWidgets.length && $scope.widgetsOrder.smallerWidgets[i] !== $scope.dashboardWidgetsOrder.smallerWidgets[i]) {\n                $scope.orderChanged = true;\n            }\n\n            if ($scope.widgetsOrder.smallerWidgets.length !== $scope.dashboardWidgetsOrder.smallerWidgets.length) {\n                $scope.orderChanged = true;\n            }\n        }\n\n        for (var i = 0; i < $scope.widgetsOrder.biggerWidgets.length; i++) {\n            if ($scope.widgetsOrder.biggerWidgets.length === $scope.dashboardWidgetsOrder.biggerWidgets.length && $scope.widgetsOrder.biggerWidgets[i] !== $scope.dashboardWidgetsOrder.biggerWidgets[i]) {\n                $scope.orderChanged = true;\n            }\n\n            if ($scope.widgetsOrder.biggerWidgets.length !== $scope.dashboardWidgetsOrder.biggerWidgets.length) {\n                $scope.orderChanged = true;\n            }\n        }\n\n        if ($scope.orderChanged) {\n            saveDashboardLayout();\n        }\n    };\n\n    $scope.$on('DataEntryMainMenuItemSelected', function (event) {\n        $scope.dataEntryMainMenuItemSelected = true;\n    });\n\n    $scope.$on('DataEntryMainMenuVisibilitySet', function (event, data) {\n        if (data.visible) {\n            //hide all widgets except visibleItems in data\n            angular.forEach($scope.dashboardWidgets, function (widget) {\n                if (!data.visibleItems[widget.title]) {\n                    $scope.temporaryHideWidgets[widget.title] = true;\n                } else {\n                    $scope.temporaryShowWidgets[widget.title] = true;\n                }\n\n            });\n        } else if (data.closingStage) {//Palestine, show only closing stage\n\n        } else {\n            //show widgets, reset temporary settings\n            $scope.temporaryHideWidgets = [];\n            $scope.temporaryShowWidgets = [];\n\n        }\n    });\n    \n    $scope.applySelectedProgram = function (pr) {\n        if (pr) {\n            $scope.selectedProgram = pr;\n        }\n        getDashboardLayout();\n    };\n\n    $scope.broadCastSelections = function (tei) {\n\n        var selections = CurrentSelection.get();\n        if (tei) {\n            $scope.selectedTei = tei;\n        } else {\n            $scope.selectedTei = selections.tei;\n        }\n\n        $scope.trackedEntity = selections.te;\n        $scope.optionSets = selections.optionSets;\n        $scope.selectedEnrollment = null;\n\n        if ($scope.selectedProgram) {\n            for (var i = 0; i < selections.enrollments.length; i++) {\n                if (selections.enrollments[i].program === $scope.selectedProgram.id) {\n                    $scope.selectedEnrollment = selections.enrollments[i];\n                    break;\n                }\n            }\n        }\n\n        CurrentSelection.set({\n            tei: $scope.selectedTei,\n            te: $scope.trackedEntity,\n            prs: $scope.programs,\n            pr: $scope.selectedProgram,\n            prNames: $scope.programNames,\n            prStNames: $scope.programStageNames,\n            enrollments: selections.enrollments,\n            selectedEnrollment: $scope.selectedEnrollment,\n            optionSets: $scope.optionSets,\n            orgUnit: $scope.selectedOrgUnit\n        });\n        $timeout(function () {\n            $rootScope.$broadcast('selectedItems', {programExists: $scope.programs.length > 0});\n        }, 500);\n    };\n\n    $scope.activiateTEI = function () {\n        var st = !$scope.selectedTei.inactive || $scope.selectedTei.inactive === '' ? true : false;\n\n        var modalOptions = {\n            closeButtonText: 'no',\n            actionButtonText: 'yes',\n            headerText: st ? 'deactivate' : 'activate',\n            bodyText: 'are_you_sure_to_proceed'\n        };\n\n        ModalService.showModal({}, modalOptions).then(function (result) {\n\n            $scope.selectedTei.inactive = st;\n            TEIService.update($scope.selectedTei, $scope.optionSets, $scope.attributesById).then(function (data) {\n                setInactiveMessage();\n                $scope.broadCastSelections($scope.selectedTei);\n            });\n        }, function () {\n        });\n    };\n    \n    $scope.deleteTEI = function () {\n        var modalOptions = {\n            closeButtonText: 'no',\n            actionButtonText: 'yes',\n            headerText: 'delete',\n            bodyText: $translate.instant('are_you_sure_to_proceed') + ' ' + $translate.instant('will_delete_all_data_associated') + ' ' + $scope.trackedEntity.displayName\n        };\n        \n        ModalService.showModal({}, modalOptions).then(function (result) {\n            TEIService.delete($scope.selectedTeiId).then(function (response) {\n                if( !response ){\n                    var teis = CurrentSelection.getTrackedEntities();                \n                    if( teis && teis.rows && teis.rows.own && teis.rows.own.length > 0 ){\n                        var index = -1;\n                        for( var i=0; i<teis.rows.own.length && index === -1; i++ ){\n                            if( teis.rows.own[i].id === $scope.selectedTeiId ){\n                                index = i;\n                            }\n                        }\n\n                        if( index !== -1 ){\n                            teis.rows.own.splice(index, 1);\n                            CurrentSelection.setTrackedEntities(teis);\n                        }\n                    }\n                    \n                    NotificationService.showNotifcationDialog($translate.instant('success'), $scope.trackedEntity.displayName + ' ' + $translate.instant('deleted'));                \n                    $scope.back();\n                }\n                \n            });\n        });\n    };\n\n    $scope.back = function () {debugger\n        if (queueRedirect){\n            $location.path('/queue').search();\n            return\n        }\n        if (!$scope.dataEntryMainMenuItemSelected) {\n            //reload OU tree\n            selection.load();\n            $location.path('/').search({program: $scope.selectedProgramId});\n        } else {\n            $rootScope.$broadcast('DashboardBackClicked');\n            $scope.dataEntryMainMenuItemSelected = false;\n        }\n    };\n            \n    $scope.getBackButtonText = function () {\n        if (!$scope.dataEntryMainMenuItemSelected) {\n            return $translate.instant('back');\n        } else {\n            return $translate.instant('menu');\n        }\n    };\n\n    $scope.showEnrollment = function () {\n        $scope.displayEnrollment = true;\n    };\n\n    $scope.removeWidget = function (widget) {\n        widget.show = false;\n        saveDashboardLayout();\n    };\n\n    $scope.expandCollapse = function (widget) {\n        widget.expand = !widget.expand;\n        saveDashboardLayout();\n    };\n\n    $scope.showHideWidgets = function () {\n        var modalInstance = $modal.open({\n            templateUrl: \"components/dashboard/dashboard-widgets.html\",\n            controller: \"DashboardWidgetsController\"\n        });\n\n        modalInstance.result.then(function () {\n        });\n    };\n\n    $rootScope.closeOpenWidget = function () {\n        saveDashboardLayout();\n    };\n\n    $scope.fetchTei = function (mode) {\n        var current = $scope.sortedTeiIds.indexOf($scope.selectedTeiId);\n        var pr = ($location.search()).program;\n        var tei = null;\n        if (mode === 'NEXT') {\n            tei = $scope.sortedTeiIds[current + 1];\n        } else {\n            tei = $scope.sortedTeiIds[current - 1];\n        }\n        $location.path('/dashboard').search({tei: tei, program: pr ? pr : null, ou: orgUnitUrl ? orgUnitUrl : null});\n    };\n});\n\n\n\n// WEBPACK FOOTER //\n// ./components/dashboard/dashboard-controller.js","//Controller for the dashboard widgets\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('DashboardWidgetsController', \n    function($scope, \n            $modalInstance){\n    \n    $scope.close = function () {\n        $modalInstance.close();\n    };       \n});\n\n\n// WEBPACK FOOTER //\n// ./components/dashboard/dashboard-widgets-controller.js","/* global trackerCapture, angular */\r\n\r\nvar trackerCapture = angular.module('trackerCapture');\r\ntrackerCapture.controller('RegistrationController', \r\n        function($rootScope,\r\n                $scope,\r\n                $location,\r\n                $timeout,\r\n                $modal,\r\n                $translate,\r\n                $parse,\r\n                orderByFilter,\r\n                AttributesFactory,\r\n                DHIS2EventFactory,\r\n                TEService,\r\n                CustomFormService,\r\n                EnrollmentService,\r\n                NotificationService,\r\n                CurrentSelection,\r\n                MetaDataFactory,\r\n                EventUtils,\r\n                RegistrationService,\r\n                DateUtils,\r\n                TEIGridService,\r\n                TEIService,\r\n                TrackerRulesFactory,\r\n                TrackerRulesExecutionService,\r\n                TCStorageService,\r\n                ModalService,\r\n                 CustomIDGenerationService) {\r\n    $scope.today = DateUtils.getToday();\r\n    $scope.trackedEntityForm = null;\r\n    $scope.customRegistrationForm = null;    \r\n    $scope.selectedTei = {};\r\n    $scope.tei = {};    \r\n    $scope.warningMessages = [];\r\n    $scope.hiddenFields = [];    \r\n    $scope.assignedFields = [];\r\n    $scope.errorMessages = {};\r\n    $scope.hiddenSections = [];\r\n    $scope.currentEvent = null;\r\n    $scope.prStDes = null;\r\n    $scope.registrationAndDataEntry = false;\r\n    $scope.model={autoGeneratedAttFailed : false, savingRegistration: false};\r\n    $scope.helpTexts = {};\r\n    $scope.registrationMode = 'REGISTRATION';\r\n    var flag = {debug: true, verbose: false};\r\n    $rootScope.ruleeffects = {};\r\n\r\n    $scope.attributesById = CurrentSelection.getAttributesById();\r\n\r\n    if(!$scope.attributesById){\r\n        $scope.attributesById = [];\r\n        AttributesFactory.getAll().then(function(atts){\r\n            angular.forEach(atts, function(att){\r\n                $scope.attributesById[att.id] = att;\r\n            });\r\n            \r\n            CurrentSelection.setAttributesById($scope.attributesById);\r\n        });\r\n    }\r\n    \r\n    //get ouLevels\r\n    $scope.ouLevels = CurrentSelection.getOuLevels();\r\n    if(!$scope.ouLevels){\r\n        TCStorageService.currentStore.open().done(function(){\r\n            TCStorageService.currentStore.getAll('ouLevels').done(function(response){\r\n                var ouLevels = angular.isObject(response) ? orderByFilter(response, '-level').reverse() : [];\r\n                CurrentSelection.setOuLevels(orderByFilter(ouLevels, '-level').reverse());\r\n            });\r\n        });\r\n    }\r\n    \r\n    $scope.optionSets = CurrentSelection.getOptionSets();        \r\n    if(!$scope.optionSets){\r\n        $scope.optionSets = [];\r\n        MetaDataFactory.getAll('optionSets').then(function(optionSets){\r\n            angular.forEach(optionSets, function(optionSet){                        \r\n                $scope.optionSets[optionSet.id] = optionSet;\r\n            });\r\n            CurrentSelection.setOptionSets($scope.optionSets);\r\n        });\r\n    }\r\n    \r\n    \r\n    $scope.isDisabled = function(attribute) {\r\n        return attribute.generated || $scope.assignedFields[attribute.id] || $scope.editingDisabled;\r\n    };\r\n\r\n    var selectedOrgUnit = CurrentSelection.get()[\"orgUnit\"];\r\n\r\n    if (selectedOrgUnit) {\r\n        $scope.selectedOrgUnit = selectedOrgUnit;\r\n        $scope.model.orgUnitId = $scope.selectedOrgUnit.id;\r\n    } else {\r\n        $scope.model.orgUnitId = ($location.search()).ou;\r\n    }\r\n\r\n    $scope.selectedEnrollment = {\r\n        enrollmentDate: $scope.today,\r\n        incidentDate: $scope.today,\r\n        orgUnitName: $scope.selectedOrgUnit ? $scope.selectedOrgUnit.displayName : \"\"\r\n    };\r\n\r\n    $scope.trackedEntities = {available: []};\r\n    TEService.getAll().then(function (entities) {\r\n        $scope.trackedEntities.available = entities;\r\n        $scope.trackedEntities.selected = $scope.trackedEntities.available[0];\r\n    });\r\n\r\n    var getProgramRules = function () {\r\n        $scope.trackedEntityForm = null;\r\n        $scope.customRegistrationForm = null;\r\n        $scope.allProgramRules = {\r\n            constants: [],\r\n            programIndicators: {},\r\n            programValidations: [],\r\n            programVariables: [],\r\n            programRules: []\r\n        };\r\n        if (angular.isObject($scope.selectedProgram) && $scope.selectedProgram.id) {\r\n            return TrackerRulesFactory.getRules($scope.selectedProgram.id).then(function (rules) {\r\n                $scope.allProgramRules = rules;\r\n            });\r\n        }\r\n    };\r\n\r\n    //watch for selection of program\r\n    $scope.$watch('selectedProgram', function (newValue, oldValue) {\r\n        if (newValue !== oldValue) {\r\n            getProgramRules();\r\n\r\n            if ($scope.registrationMode === 'REGISTRATION') {\r\n                $scope.getAttributes($scope.registrationMode);\r\n            }\r\n        }\r\n        $scope.model.minEnrollmentDate = \"\";\r\n        $scope.model.maxEnrollmentDate =  ($scope.selectedProgram && $scope.selectedProgram.selectEnrollmentDatesInFuture) ? '' : \"0\";\r\n        if ($scope.selectedOrgUnit.reportDateRange) {\r\n            if ($scope.selectedOrgUnit.reportDateRange.minDate) {\r\n                $scope.model.minEnrollmentDate = $scope.selectedOrgUnit.reportDateRange.minDate;\r\n            }\r\n            if ($scope.selectedOrgUnit.reportDateRange.maxDate) {\r\n                $scope.model.maxEnrollmentDate = $scope.selectedOrgUnit.reportDateRange.maxDate;\r\n            }\r\n        }\r\n    });\r\n\r\n\r\n\r\n    //listen to modes of registration\r\n    $scope.$on('registrationWidget', function (event, args) {\r\n        $scope.selectedTei = {};\r\n        $scope.tei = {};\r\n        $scope.registrationMode = args.registrationMode;\r\n        $scope.orgUnitNames = CurrentSelection.getOrgUnitNames();\r\n\r\n        if ($scope.registrationMode !== 'REGISTRATION') {\r\n            $scope.selectedTei = args.selectedTei;\r\n            $scope.tei = angular.copy(args.selectedTei);\r\n        }\r\n\r\n        $scope.teiOriginal = angular.copy($scope.tei);\r\n\r\n        if ($scope.registrationMode === 'PROFILE') {\r\n            $scope.selectedEnrollment = args.enrollment ? args.enrollment : {};\r\n        }\r\n\r\n        $scope.getAttributes($scope.registrationMode);\r\n\r\n        if ($scope.selectedProgram && $scope.selectedProgram.id) {\r\n            getProgramRules().then( function (rules) {\r\n                $scope.executeRules();\r\n            });\r\n        }\r\n    });\r\n\r\n    $scope.getAttributes = function (_mode) {\r\n        var mode = _mode ? _mode : 'ENROLLMENT';\r\n        $scope.customRegistrationFormExists = false;\r\n        $scope.customDataEntryForm = null;\r\n        $scope.schedulingEnabled = true;\r\n\r\n        if( $scope.selectedProgram && $scope.selectedProgram.captureCoordinates && angular.isObject($scope.selectedEnrollment) ){                \r\n            $scope.selectedEnrollment.coordinate = $scope.selectedEnrollment.coordinate ? $scope.selectedEnrollment.coordinate : {};\r\n        }\r\n\r\n        AttributesFactory.getByProgram($scope.selectedProgram).then(function (atts) {\r\n            $scope.attributes = TEIGridService.generateGridColumns(atts, null, false).columns;\r\n            fetchGeneratedAttributes();\r\n            if ($scope.selectedProgram && $scope.selectedProgram.id) {\r\n                if ($scope.selectedProgram.dataEntryForm && $scope.selectedProgram.dataEntryForm.htmlCode) {\r\n                    $scope.customRegistrationFormExists = true;\r\n                    $scope.trackedEntityForm = $scope.selectedProgram.dataEntryForm;\r\n                    $scope.trackedEntityForm.attributes = $scope.attributes;\r\n                    $scope.trackedEntityForm.selectIncidentDatesInFuture = $scope.selectedProgram.selectIncidentDatesInFuture;\r\n                    $scope.trackedEntityForm.selectEnrollmentDatesInFuture = $scope.selectedProgram.selectEnrollmentDatesInFuture;\r\n                    $scope.trackedEntityForm.displayIncidentDate = $scope.selectedProgram.displayIncidentDate;\r\n                    $scope.customRegistrationForm = CustomFormService.getForTrackedEntity($scope.trackedEntityForm, mode);\r\n                }\r\n\r\n                if ($scope.selectedProgram.programStages && $scope.selectedProgram.programStages[0] && $scope.selectedProgram.useFirstStageDuringRegistration && $scope.registrationMode === 'REGISTRATION') {\r\n                    $scope.currentEvent = {};\r\n                    $scope.registrationAndDataEntry = true;\r\n                    $scope.prStDes = [];\r\n                    $scope.currentStage = $scope.selectedProgram.programStages[0];\r\n                    $scope.currentEvent.event = 'SINGLE_EVENT';\r\n                    $scope.currentEvent.providedElsewhere = {};\r\n                    $scope.currentEvent.orgUnit = $scope.selectedOrgUnit.id;\r\n                    $scope.currentEvent.program = $scope.selectedProgram.id;\r\n                    $scope.currentEvent.programStage = $scope.currentStage.id;\r\n                    $scope.currentEvent.enrollmentStatus = $scope.currentEvent.status = 'ACTIVE';\r\n                    $scope.currentEvent.executionDateLabel = $scope.currentStage.executionDateLabel;\r\n                    $rootScope.ruleeffects[$scope.currentEvent.event] = {};\r\n                    $scope.selectedEnrollment.status = 'ACTIVE';\r\n\r\n                    if( $scope.currentStage.captureCoordinates ){                            \r\n                        $scope.currentEvent.coordinate = {};\r\n                    }\r\n\r\n                    angular.forEach($scope.currentStage.programStageDataElements, function (prStDe) {                            \r\n                        $scope.prStDes[prStDe.dataElement.id] = prStDe;\r\n                        if (prStDe.allowProvidedElsewhere) {\r\n                            $scope.allowProvidedElsewhereExists[$scope.currentStage.id] = true;\r\n                        }\r\n                    });\r\n\r\n                    $scope.customDataEntryForm = CustomFormService.getForProgramStage($scope.currentStage, $scope.prStDes);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    var fetchGeneratedAttributes = function() {\r\n        angular.forEach($scope.attributes, function(att) {\r\n            if (att.generated && !$scope.selectedTei[att.id]) {\r\n                TEIService.getGeneratedAttributeValue(att.id).then(function (data) {\r\n                    if (data && data.status === \"ERROR\") {\r\n                        NotificationService.showNotifcationDialog($translate.instant(\"error\"), data.message);\r\n                        $scope.model.autoGeneratedAttFailed = true;\r\n                    } else {\r\n                        if (att.valueType === \"NUMBER\") {\r\n                            $scope.selectedTei[att.id] = Number(data);\r\n                        } else {\r\n                            $scope.selectedTei[att.id] = data;\r\n                        }\r\n                        $scope.model.autoGeneratedAttFailed = false;\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    var goToDashboard = function (destination, teiId) {\r\n        //reset form\r\n        $scope.selectedTei = {};\r\n        $scope.selectedEnrollment = {\r\n            enrollmentDate: $scope.today,\r\n            incidentDate: $scope.today,\r\n            orgUnitName: $scope.selectedOrgUnit.displayName\r\n        };\r\n        $scope.outerForm.submitted = false;\r\n        $scope.outerForm.$setPristine();\r\n\r\n        if (destination === 'DASHBOARD') {\r\n            $location.path('/dashboard').search({\r\n                tei: teiId,\r\n                program: $scope.selectedProgram ? $scope.selectedProgram.id : null,\r\n                ou:$scope.selectedOrgUnit.id\r\n            });\r\n        }\r\n        else if (destination === 'SELF') {\r\n            //notify user\r\n            var headerText =  $translate.instant(\"success\");\r\n            var bodyText =  $translate.instant(\"registration_complete\");\r\n            NotificationService.showNotifcationDialog(headerText, bodyText);\r\n            $scope.selectedTei = {};\r\n            $scope.tei = {};\r\n            fetchGeneratedAttributes();\r\n        }\r\n    };\r\n\r\n    var reloadProfileWidget = function () {\r\n        var selections = CurrentSelection.get();\r\n        CurrentSelection.set({\r\n            tei: $scope.selectedTei,\r\n            te: $scope.selectedTei.trackedEntity,\r\n            prs: selections.prs,\r\n            pr: $scope.selectedProgram,\r\n            prNames: selections.prNames,\r\n            prStNames: selections.prStNames,\r\n            enrollments: selections.enrollments,\r\n            selectedEnrollment: $scope.selectedEnrollment,\r\n            optionSets: selections.optionSets,\r\n            orgUnit: selections.orgUnit\r\n        });\r\n        $timeout(function () {\r\n            $rootScope.$broadcast('profileWidget', {});\r\n        }, 200);\r\n    };\r\n\r\n    var notifyRegistrtaionCompletion = function (destination, teiId) {\r\n        if ($scope.registrationMode === 'ENROLLMENT') {\r\n            broadcastTeiEnrolled();\r\n        }\r\n        else {\r\n  // goToDashboard(destination ? destination : 'DASHBOARD', teiId);\r\n\t\t  // CustomIDGenerationService\r\n// add for Generate CustomId for plan-customizations\r\n       CustomIDGenerationService.validateAndCreateCustomId($scope.tei,$scope.selectedEnrollment.program,$scope.attributes,destination,$scope.optionSets,$scope.attributesById,$scope.selectedEnrollment.enrollmentDate).then(function(){\r\n           console.log(\"Custom ID\")\r\n           goToDashboard( destination ? destination : 'DASHBOARD', teiId );\r\n       });\r\n\t}\r\n    };\r\n\r\n    var performRegistration = function (destination) {\r\n        if (destination === \"DASHBOARD\" || destination === \"SELF\") {\r\n           $scope.model.savingRegistration = true;\r\n        }\r\n        RegistrationService.registerOrUpdate($scope.tei, $scope.optionSets, $scope.attributesById).then(function (registrationResponse) {\r\n            var reg = registrationResponse.response ? registrationResponse.response : {};\r\n            if (reg.reference && reg.status === 'SUCCESS') {\r\n                $scope.tei.trackedEntityInstance = reg.reference;\r\n\r\n                if ($scope.registrationMode === 'PROFILE') {\r\n                    reloadProfileWidget();\r\n                    $rootScope.$broadcast('teiupdated', {});\r\n                    $scope.model.savingRegistration = false;\r\n                }\r\n                else {\r\n                    if ($scope.selectedProgram) {\r\n\r\n                        //enroll TEI\r\n                        var enrollment = {};\r\n                        enrollment.trackedEntityInstance = $scope.tei.trackedEntityInstance;\r\n                        enrollment.program = $scope.selectedProgram.id;\r\n                        enrollment.status = 'ACTIVE';\r\n                        enrollment.orgUnit = $scope.selectedOrgUnit.id;\r\n                        enrollment.enrollmentDate = $scope.selectedEnrollment.enrollmentDate;\r\n                        enrollment.incidentDate = $scope.selectedEnrollment.incidentDate === '' ? $scope.selectedEnrollment.enrollmentDate : $scope.selectedEnrollment.incidentDate;\r\n\r\n                        if( $scope.selectedEnrollment.coordinate ){\r\n                            enrollment.coordinate = $scope.selectedEnrollment.coordinate;\r\n                        }\r\n\r\n                        EnrollmentService.enroll(enrollment).then(function (enrollmentResponse) {\r\n                            $scope.model.savingRegistration = false;\r\n                            if(enrollmentResponse) {\r\n                                var en = enrollmentResponse.response && enrollmentResponse.response.importSummaries &&\r\n                                enrollmentResponse.response.importSummaries[0] ? enrollmentResponse.response.importSummaries[0] : {};\r\n                                if (en.reference && en.status === 'SUCCESS') {\r\n                                    enrollment.enrollment = en.reference;\r\n                                    $scope.selectedEnrollment = enrollment;\r\n                                    var avilableEvent = $scope.currentEvent && $scope.currentEvent.event ? $scope.currentEvent : null;\r\n                                    var dhis2Events = EventUtils.autoGenerateEvents($scope.tei.trackedEntityInstance, $scope.selectedProgram, $scope.selectedOrgUnit, enrollment, avilableEvent);\r\n                                    if (dhis2Events.events.length > 0) {\r\n                                        DHIS2EventFactory.create(dhis2Events).then(function () {\r\n                                            notifyRegistrtaionCompletion(destination, $scope.tei.trackedEntityInstance);\r\n                                        });\r\n                                    } else {\r\n                                        notifyRegistrtaionCompletion(destination, $scope.tei.trackedEntityInstance);\r\n                                    }\r\n                                }\r\n                                else {\r\n                                    //enrollment has failed\r\n                                    NotificationService.showNotifcationDialog($translate.instant(\"enrollment_error\"), enrollmentResponse.message);\r\n                                    return;\r\n                                }\r\n                            }\r\n                        });\r\n                    }\r\n                    else {\r\n                        notifyRegistrtaionCompletion(destination, $scope.tei.trackedEntityInstance);\r\n                        $scope.model.savingRegistration = false;\r\n                    }\r\n                }\r\n            }\r\n            else {//update/registration has failed\r\n                var headerText = $scope.tei && $scope.tei.trackedEntityInstance ? $translate.instant('update_error') :\r\n                                 $translate.instant('registration_error');\r\n                var bodyText = registrationResponse.message;\r\n                NotificationService.showNotifcationDialog(headerText, bodyText);\r\n                $scope.model.savingRegistration = false;\r\n                return;\r\n            }\r\n        });\r\n\r\n    };\r\n\r\n    function broadcastTeiEnrolled() {\r\n        $rootScope.$broadcast('teienrolled', {});\r\n    }\r\n\r\n    $scope.registerEntity = function (destination) {\r\n        //check for form validity\r\n        $scope.outerForm.submitted = true;\r\n        if ($scope.outerForm.$invalid) {\r\n            return false;\r\n        }\r\n\r\n        if ($scope.model.autoGeneratedAttFailed) {\r\n            NotificationService.showNotifcationDialog($translate.instant(\"registration_error\"), $translate.instant(\"auto_generate_failed\"));\r\n            return false;\r\n        }\r\n\r\n        if ($scope.registrationAndDataEntry) {\r\n            $scope.outerDataEntryForm.submitted = true;\r\n            if ($scope.outerDataEntryForm.$invalid) {\r\n                return false;\r\n            }\r\n        }\r\n\r\n        //form is valid, continue the registration\r\n        //get selected entity\r\n        if (!$scope.selectedTei.trackedEntityInstance) {\r\n            $scope.selectedTei.trackedEntity = $scope.tei.trackedEntity = $scope.selectedProgram && $scope.selectedProgram.trackedEntity && $scope.selectedProgram.trackedEntity.id ? $scope.selectedProgram.trackedEntity.id : $scope.trackedEntities.selected.id;\r\n            $scope.selectedTei.orgUnit = $scope.tei.orgUnit = $scope.selectedOrgUnit.id;\r\n            $scope.selectedTei.attributes = $scope.tei.attributes = [];\r\n        }\r\n\r\n        //get tei attributes and their values\r\n        //but there could be a case where attributes are non-mandatory and\r\n        //registration form comes empty, in this case enforce at least one value\r\n        var result = RegistrationService.processForm($scope.tei, $scope.selectedTei, $scope.teiOriginal, $scope.attributesById);\r\n        $scope.formEmpty = result.formEmpty;\r\n        $scope.tei = result.tei;\r\n\r\n        if ($scope.formEmpty) {//registration form is empty\r\n            NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"form_is_empty_fill_at_least_one\"));\r\n            return;\r\n        }\r\n        performRegistration(destination);\r\n    };\r\n\r\n    $scope.executeRules = function () {\r\n        //repopulate attributes with updated values\r\n        $scope.selectedTei.attributes = [];\r\n        angular.forEach($scope.attributes, function (metaAttribute) {\r\n            var newAttributeInArray = {\r\n                attribute: metaAttribute.id,\r\n                code: metaAttribute.code,\r\n                displayName: metaAttribute.displayName,\r\n                type: metaAttribute.valueType,\r\n                value: $scope.selectedTei[metaAttribute.id]\r\n            };\r\n\r\n            $scope.selectedTei.attributes.push(newAttributeInArray);\r\n        });\r\n\r\n        if ($scope.selectedProgram && $scope.selectedProgram.id) {\r\n            var eventExists = $scope.currentEvent && $scope.currentEvent.event;\r\n            var evs = null;\r\n            if( eventExists ){\r\n                evs = {all: [], byStage: {}};\r\n                evs.all = [$scope.currentEvent];\r\n                evs.byStage[$scope.currentStage.id] = [$scope.currentEvent];\r\n            }\r\n            \r\n            TrackerRulesExecutionService.executeRules(\r\n                $scope.allProgramRules, \r\n                eventExists ? $scope.currentEvent : 'registration', \r\n                evs,\r\n                $scope.prStDes, \r\n                $scope.selectedTei, \r\n                $scope.selectedEnrollment, \r\n                $scope.optionSets, \r\n                flag);\r\n        }\r\n    };\r\n\r\n    //check if field is hidden\r\n    $scope.isHidden = function (id) {\r\n        //In case the field contains a value, we cant hide it.\r\n        //If we hid a field with a value, it would falsely seem the user was aware that the value was entered in the UI.\r\n        return $scope.selectedTei[id] ? false : $scope.hiddenFields[id];\r\n    };\r\n\r\n    $scope.teiValueUpdated = function (tei, field) {\r\n        $scope.executeRules();\r\n    };\r\n\r\n\r\n    $scope.saveDataValueForRadio = function(field, context, value){\r\n        if(field.dataElement) {\r\n            //The saveDataValueForRadio was called from the dataentry template. Update dataelement og current event:\r\n            context[field.dataElement.id] = value;\r\n        }\r\n        else {\r\n            //The saveDataValueForRadio was called from the registration controller. Update the selected TEI:\r\n            context[field.id] = value;\r\n        }\r\n\r\n        $scope.executeRules();\r\n    }\r\n\r\n    //listen for rule effect changes\r\n    $scope.$on('ruleeffectsupdated', function (event, args) {\r\n        if (args.event === \"registration\" || args.event === 'SINGLE_EVENT') {\r\n            $scope.warningMessages = [];\r\n            $scope.hiddenFields = [];\r\n            $scope.assignedFields = [];\r\n            $scope.errorMessages = {};\r\n            $scope.hiddenSections = [];\r\n\r\n            var effectResult = TrackerRulesExecutionService.processRuleEffectAttribute(args.event, $scope.selectedTei, $scope.tei, $scope.currentEvent, {}, $scope.currentEvent, $scope.attributesById, $scope.prStDes, $scope.hiddenFields, $scope.hiddenSections, $scope.warningMessages, $scope.assignedFields, $scope.optionSets);\r\n            $scope.selectedTei = effectResult.selectedTei;\r\n            $scope.currentEvent = effectResult.currentEvent;\r\n            $scope.hiddenFields = effectResult.hiddenFields;\r\n            $scope.hiddenSections = effectResult.hiddenSections;\r\n            $scope.assignedFields = effectResult.assignedFields;\r\n            $scope.warningMessages = effectResult.warningMessages;\r\n        }\r\n    });\r\n\r\n    $scope.interacted = function (field) {\r\n        var status = false;\r\n        if (field) {\r\n            status = $scope.outerForm.submitted || field.$dirty;\r\n        }\r\n        return status;\r\n    };\r\n\r\n    $scope.getTrackerAssociate = function (selectedAttribute, existingAssociateUid) {\r\n        var modalInstance = $modal.open({\r\n            templateUrl: 'components/teiadd/tei-add.html',\r\n            controller: 'TEIAddController',\r\n            windowClass: 'modal-full-window',\r\n            resolve: {\r\n                relationshipTypes: function () {\r\n                    return $scope.relationshipTypes;\r\n                },\r\n                addingRelationship: function () {\r\n                    return false;\r\n                },\r\n                selections: function () {\r\n                    return CurrentSelection.get();\r\n                },\r\n                selectedTei: function () {\r\n                    return $scope.selectedTei;\r\n                },\r\n                selectedAttribute: function () {\r\n                    return selectedAttribute;\r\n                },\r\n                existingAssociateUid: function () {\r\n                    return existingAssociateUid;\r\n                },\r\n                selectedProgram: function () {\r\n                    return $scope.selectedProgram;\r\n                },\r\n                relatedProgramRelationship: function () {\r\n                    return $scope.relatedProgramRelationship;\r\n                }\r\n            }\r\n        });\r\n        modalInstance.result.then(function (res) {\r\n            if (res && res.id) {\r\n                $scope.selectedTei[selectedAttribute.id] = res.id;\r\n            }\r\n        });\r\n    };\r\n\r\n    $scope.cancelRegistrationWarning = function (cancelFunction) {\r\n        var result = RegistrationService.processForm($scope.tei, $scope.selectedTei, $scope.teiOriginal, $scope.attributesById);\r\n        var prStDe;\r\n        if (!result.formChanged) {\r\n            if ($scope.currentStage &&  $scope.currentStage.programStageDataElements) {\r\n                for (var index = 0; index < $scope.currentStage.programStageDataElements.length; index++) {\r\n                    prStDe = $scope.currentStage.programStageDataElements[index];\r\n                    if ($scope.currentEvent[prStDe.dataElement.id]) {\r\n                        result.formChanged = true;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (result.formChanged) {\r\n            var modalOptions = {\r\n                closeButtonText: 'no',\r\n                actionButtonText: 'yes',\r\n                headerText: 'cancel',\r\n                bodyText: 'are_you_sure_to_cancel_registration'\r\n            };\r\n\r\n            ModalService.showModal({}, modalOptions).then(function () {\r\n                $scope.outerForm.$setPristine();\r\n                cancelFunction();\r\n            });\r\n        }\r\n        else {\r\n            $scope.outerForm.$setPristine();\r\n            cancelFunction();\r\n        }\r\n    };\r\n\r\n    $scope.showAttributeMap = function (obj, id) {\r\n        var lat = \"\",\r\n            lng = \"\";\r\n        if (obj[id] && obj[id].length > 0) {\r\n            var coordinates = obj[id].split(\",\");\r\n            lng = coordinates[0];\r\n            lat = coordinates[1];\r\n        }\r\n        var modalInstance = $modal.open({\r\n            templateUrl: '../dhis-web-commons/angular-forms/map.html',\r\n            controller: 'MapController',\r\n            windowClass: 'modal-full-window',\r\n            resolve: {\r\n                location: function () {\r\n                    return {lat: lat, lng: lng};\r\n                }\r\n            }\r\n        });\r\n\r\n        modalInstance.result.then(function (location) {\r\n            if (angular.isObject(location)) {\r\n                obj[id] = location.lng + ',' + location.lat;\r\n            }\r\n        }, function () {\r\n        });\r\n    };\r\n\r\n    $scope.showDataElementMap = function (obj, id) {\r\n        var lat = \"\",\r\n            lng = \"\";\r\n        if (obj[id] && obj[id].length > 0) {\r\n            var coordinates = obj[id].split(\",\");\r\n            lng = coordinates[0];\r\n            lat = coordinates[1];\r\n        }\r\n        var modalInstance = $modal.open({\r\n            templateUrl: '../dhis-web-commons/angular-forms/map.html',\r\n            controller: 'MapController',\r\n            windowClass: 'modal-full-window',\r\n            resolve: {\r\n                location: function () {\r\n                    return {lat: lat, lng: lng};\r\n                }\r\n            }\r\n        });\r\n\r\n        modalInstance.result.then(function (location) {\r\n            if (angular.isObject(location)) {\r\n                obj[id] = location.lng + ',' + location.lat;\r\n            }\r\n        }, function () {\r\n        });\r\n    };\r\n\r\n    $scope.showProgramStageMap = function(event){\r\n        var modalInstance = $modal.open({\r\n            templateUrl: '../dhis-web-commons/angular-forms/map.html',\r\n            controller: 'MapController',\r\n            windowClass: 'modal-full-window',\r\n            resolve: {\r\n                location: function () {\r\n                    return {lat: event.coordinate.latitude, lng: event.coordinate.longitude};\r\n                }\r\n            }\r\n        });\r\n\r\n        modalInstance.result.then(function (location) {\r\n            if(angular.isObject(location)){\r\n                event.coordinate.latitude = location.lat;\r\n                event.coordinate.longitude = location.lng;\r\n            }\r\n        }, function () {\r\n        });\r\n    };\r\n\r\n    $scope.saveDatavalue = function () {\r\n        $scope.executeRules();\r\n    };\r\n\r\n    $scope.verifyExpiryDate = function(eventDateStr) {\r\n        var dateGetter, dateSetter, date;\r\n        dateGetter = $parse(eventDateStr);\r\n        dateSetter = dateGetter.assign;\r\n        date = dateGetter($scope);\r\n        if(!date) {\r\n            return;\r\n        }\r\n        if($scope.model.ouDates) {\r\n            if (!DateUtils.verifyOrgUnitPeriodDate(date, $scope.model.ouDates.startDate, $scope.model.ouDates.endDate)) {\r\n                dateSetter($scope, null);\r\n                return;\r\n            }\r\n        }\r\n        if (!DateUtils.verifyExpiryDate(date, $scope.selectedProgram.expiryPeriodType, $scope.selectedProgram.expiryDays)) {\r\n            dateSetter($scope, null);\r\n        }\r\n    };\r\n});\r\n\n\n\n// WEBPACK FOOTER //\n// ./components/registration/registration-controller.js","/* global trackerCapture, angular */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('EnrollmentController',\n        function($rootScope,\n                $scope,  \n                $route,\n                $location,\n                $timeout,\n                $translate,\n                $parse,\n                DateUtils,\n                SessionStorageService,\n                CurrentSelection,\n                EnrollmentService,\n                ModalService,\n                NotificationService) {\n    \n        var selections;\n\n        //listen for the selected items\n        $scope.$on('selectedItems', function (event, args) {\n            selections = CurrentSelection.get();\n            $scope.today = DateUtils.getToday();\n            $scope.selectedOrgUnit = selections.orgUnit;\n            $scope.attributes = [];\n            $scope.historicalEnrollments = [];\n            $scope.showEnrollmentDiv = false;\n            $scope.showEnrollmentHistoryDiv = false;\n            $scope.hasEnrollmentHistory = false;\n            $scope.selectedEnrollment = null;\n            $scope.currentEnrollment = null;\n            $scope.newEnrollment = {};\n\n            processSelectedTei();\n\n            $scope.selectedEntity = selections.te;\n            $scope.selectedProgram = selections.pr;\n            $scope.optionSets = selections.optionSets;\n            $scope.programs = selections.prs;\n            $scope.hasOtherPrograms = $scope.programs.length > 1 ? true : false;\n            var selectedEnrollment = selections.selectedEnrollment;\n            $scope.enrollments = selections.enrollments;\n            $scope.programExists = args.programExists;\n            $scope.programNames = selections.prNames;\n\n            $scope.programStageNames = selections.prStNames;\n            $scope.attributesById = CurrentSelection.getAttributesById();\n            $scope.activeEnrollments = [];\n            angular.forEach(selections.enrollments, function (en) {\n                if (en.status === \"ACTIVE\" && $scope.selectedProgram && $scope.selectedProgram.id !== en.program) {\n                    $scope.activeEnrollments.push(en);\n                }\n            });\n            if ($scope.selectedProgram) {\n\n                $scope.stagesById = [];\n                angular.forEach($scope.selectedProgram.programStages, function (stage) {\n                    $scope.stagesById[stage.id] = stage;\n                });\n\n                angular.forEach($scope.enrollments, function (enrollment) {\n                    if (enrollment.program === $scope.selectedProgram.id) {\n                        if (enrollment.status === 'ACTIVE') {\n                            selectedEnrollment = enrollment;\n                            $scope.currentEnrollment = enrollment;\n                        }\n                        if (enrollment.status === 'CANCELLED' || enrollment.status === 'COMPLETED') {\n                            $scope.historicalEnrollments.push(enrollment);\n                            $scope.hasEnrollmentHistory = true;\n                        }\n                    }\n                });\n                if (selectedEnrollment && selectedEnrollment.status === 'ACTIVE') {\n                    $scope.selectedEnrollment = selectedEnrollment;\n                    $scope.loadEnrollmentDetails(selectedEnrollment);\n                }\n                else {\n                    $scope.selectedEnrollment = null;\n                    $scope.showEnrollmentHistoryDiv = true;\n                    $scope.broadCastSelections('dashboardWidgets');\n                }\n            }\n            else {\n                $scope.broadCastSelections('dashboardWidgets');\n            }\n        });\n        $scope.$on('teienrolled', function (event, args) {\n            $route.reload();\n\n        });\n        $scope.verifyExpiryDate = function(eventDateStr) {\n            var dateGetter = $parse(eventDateStr);\n            var dateSetter = dateGetter.assign;\n            var date = dateGetter($scope);\n            if(!date) {\n                return;\n            }\n\n            if (!DateUtils.verifyExpiryDate(date, $scope.selectedProgram.expiryPeriodType, $scope.selectedProgram.expiryDays)) {\n                dateSetter($scope, null);\n            }\n        };\n        $scope.loadEnrollmentDetails = function (enrollment) {\n            $scope.showEnrollmentHistoryDiv = false;\n            $scope.selectedEnrollment = enrollment;\n\n            if ($scope.selectedEnrollment.enrollment && $scope.selectedEnrollment.orgUnit) {\n                $scope.broadCastSelections('dashboardWidgets');\n            }\n        };\n\n        $scope.showNewEnrollment = function () {\n            $scope.showEnrollmentDiv = !$scope.showEnrollmentDiv;\n            if(!$scope.showEnrollmentDiv) {\n                return;\n            }\n\n            if ($scope.showEnrollmentDiv) {\n\n                $scope.showEnrollmentHistoryDiv = false;\n\n                //load new enrollment details\n                $scope.selectedEnrollment = {orgUnitName: $scope.selectedOrgUnit.displayName};\n                \n                if( $scope.selectedProgram && $scope.selectedProgram.captureCoordinates ){\n                    $scope.selectedEnrollment.coordinate = {};\n                }\n\n                $scope.loadEnrollmentDetails($scope.selectedEnrollment);\n                \n                $timeout(function () {\n                    $rootScope.$broadcast('registrationWidget', {\n                        registrationMode: 'ENROLLMENT',\n                        selectedTei: $scope.selectedTei\n                    });\n                }, 200);\n            }\n            else {\n                hideEnrollmentDiv();\n            }\n        };\n\n        $scope.showEnrollmentHistory = function () {\n\n            $scope.showEnrollmentHistoryDiv = !$scope.showEnrollmentHistoryDiv;\n\n            if ($scope.showEnrollmentHistoryDiv) {\n                $scope.selectedEnrollment = null;\n                $scope.showEnrollmentDiv = false;\n\n                $scope.broadCastSelections('dashboardWidgets');\n            }\n        };\n\n        $scope.broadCastSelections = function (listeners) {\n            var tei = selections.tei;\n            CurrentSelection.set({\n                tei: tei,\n                te: $scope.selectedEntity,\n                prs: $scope.programs,\n                pr: $scope.selectedProgram,\n                prNames: $scope.programNames,\n                prStNames: $scope.programStageNames,\n                enrollments: $scope.enrollments,\n                selectedEnrollment: $scope.selectedEnrollment,\n                optionSets: $scope.optionSets,\n                orgUnit: selections.orgUnit\n            });\n            $timeout(function () {\n                $rootScope.$broadcast(listeners, {});\n            }, 200);\n        };\n\n        var processSelectedTei = function () {\n            $scope.selectedTei = angular.copy(selections.tei);\n            angular.forEach($scope.selectedTei.attributes, function (att) {\n                $scope.selectedTei[att.attribute] = att.value;\n            });\n        };\n\n        var hideEnrollmentDiv = function () {\n\n            /*currently the only way to cancel enrollment window is by going through\n             * the main dashboard controller. Here I am mixing program and programId,\n             * as I didn't want to refetch program from server, the main dashboard\n             * has already fetched the programs. With the ID passed to it, it will\n             * pass back the actual program than ID.\n             */\n            processSelectedTei();\n            $scope.selectedProgram = ($location.search()).program;\n            $scope.broadCastSelections('mainDashboard');\n        };\n\n        $scope.activateDeactivateEnrollment = function () {\n            \n            if($scope.enrollmentForm && $scope.enrollmentForm.$invalid){\n                NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"form_invalid\"));\n                return;\n            }\n            \n            var modalOptions = {\n                closeButtonText: 'no',\n                actionButtonText: 'yes',\n                headerText: $scope.selectedEnrollment.status === 'CANCELLED' ? 'activate_enrollment' : 'deactivate_enrollment',\n                bodyText: $scope.selectedEnrollment.status === 'CANCELLED' ? 'are_you_sure_to_activate_enrollment' : 'are_you_sure_to_deactivate_enrollment'\n            };\n\n\n            ModalService.showModal({}, modalOptions).then(function (result) {\n                \n                var en = angular.copy( $scope.selectedEnrollment );\n                en.status = $scope.selectedEnrollment.status === 'CANCELLED' ? 'ACTIVE' : 'CANCELLED';\n                EnrollmentService.update( en ).then(function ( data ) {\n                    if( data && data.status === 'OK' ){\n                        $scope.selectedEnrollment.status = $scope.selectedEnrollment.status === 'CANCELLED' ? 'ACTIVE' : 'CANCELLED';\n                        $scope.loadEnrollmentDetails($scope.selectedEnrollment);\n                    }                    \n                });\n            });\n        };\n\n        $scope.completeReopenEnrollment = function () {\n            \n            if($scope.enrollmentForm && $scope.enrollmentForm.$invalid){\n                NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"form_invalid\"));\n                return;\n            }\n            \n            var modalOptions = {\n                closeButtonText: 'no',\n                actionButtonText: 'yes',\n                headerText: $scope.selectedEnrollment.status === 'ACTIVE' ? 'complete_enrollment' : 'reopen_enrollment',\n                bodyText: $scope.selectedEnrollment.status === 'ACTIVE' ? 'are_you_sure_to_complete_enrollment' : 'are_you_sure_to_reopen_enrollment'\n            };\n\n\n            ModalService.showModal({}, modalOptions).then(function (result) {\n                \n                var en = angular.copy( $scope.selectedEnrollment );\n                en.status = $scope.selectedEnrollment.status === 'ACTIVE' ? 'COMPLETED' : 'ACTIVE';\n                EnrollmentService.update( en ).then(function (data) {\n                    if( data && data.status === 'OK' ){\n                        $scope.selectedEnrollment.status = $scope.selectedEnrollment.status === 'ACTIVE' ? 'COMPLETED' : 'ACTIVE';\n                        $scope.loadEnrollmentDetails($scope.selectedEnrollment);\n                    }\n                });\n            });\n        };\n        \n        $scope.deleteEnrollment = function () {\n\n            var modalOptions = {\n                closeButtonText: 'no',\n                actionButtonText: 'yes',\n                headerText: 'delete_enrollment',\n                bodyText: 'are_you_sure_to_delete_enrollment'\n            };\n\n            ModalService.showModal({}, modalOptions).then(function (result) {                \n                EnrollmentService.delete( $scope.selectedEnrollment.enrollment ).then(function (data) {\n                    $scope.selectedEnrollment = null;\n                    $scope.broadCastSelections('mainDashboard');\n                });\n            });\n        };\n\n        $scope.markForFollowup = function () {\n            \n            if($scope.enrollmentForm && $scope.enrollmentForm.$invalid){\n                NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"form_invalid\"));\n                return;\n            }\n            \n            $scope.selectedEnrollment.followup = !$scope.selectedEnrollment.followup;\n            EnrollmentService.update($scope.selectedEnrollment);\n        };\n\n        $scope.changeProgram = function (program) {\n            var pr = $location.search().program;\n            if (pr && pr === program) {\n                $route.reload();\n            }\n            else {\n                $location.path('/dashboard').search({tei: $scope.selectedTeiId, program: program, ou: $scope.selectedOrgUnit.id});\n            }\n        };\n\n        $scope.canUseEnrollment = function () {\n\n            if ($scope.selectedTei.inactive) {\n                return false;\n            }\n\n            if ($scope.currentEnrollment && $scope.selectedEnrollment.enrollment !== $scope.currentEnrollment.enrollment) {\n                if ($scope.currentEnrollment.status === 'ACTIVE') {\n                    return false;\n                }\n            }\n            return true;\n        };\n        \n        $scope.saveCoordinate = function(param){            \n            var en = angular.copy( $scope.currentEnrollment );            \n            $scope.enrollmentLatSaved = false;\n            $scope.enrollmentLngSaved = false;            \n            EnrollmentService.update( en ).then(function (data) {\n                $scope.enrollmentLatSaved = true;\n                $scope.enrollmentLngSaved = true;\n            });\n        };\n});\n\n\n\n// WEBPACK FOOTER //\n// ./components/enrollment/enrollment-controller.js","/* global angular, trackerCapture */\r\n\r\nvar trackerCapture = angular.module('trackerCapture');\r\ntrackerCapture.controller('DataEntryController',\r\n                          function ($rootScope,$http,\r\n                                    $scope,\r\n                                    $modal,\r\n                                    $filter,\r\n                                    $log,\r\n                                    $timeout,\r\n                                    $translate,\r\n                                    $window,\r\n                                    $q,\r\n                                    $parse,\r\n                                    $location,\r\n                                    CommonUtils,                \r\n                                    DateUtils,\r\n                                    EventUtils,\r\n                                    orderByFilter,\r\n                                    SessionStorageService,\r\n                                    EnrollmentService,\r\n                                    DHIS2EventFactory,\r\n                                    ModalService,\r\n                                    NotificationService,\r\n                                    CurrentSelection,\r\n                                    TrackerRulesExecutionService,\r\n                                    CustomFormService,\r\n                                    PeriodService,\r\n                                    OptionSetService,\r\n                                    TrackerRulesFactory,\r\n                                    EventCreationService) {\r\n                              \r\n                              //Unique instance id for the controller:\r\n                              $scope.instanceId = Math.floor(Math.random() * 1000000000);\r\n                              $scope.printForm = false;\r\n                              $scope.printEmptyForm = false;\r\n                              $scope.eventPageSize = 4;\r\n                              $scope.maxOptionSize = 30;\r\n                              $scope.eventPagingStart = 0;\r\n                              $scope.eventPagingEnd = $scope.eventPageSize;\r\n                              $scope.showAttributeCategoryOptions = false;\r\n                              \r\n                              //Data entry form\r\n                              $scope.outerDataEntryForm = {longitude: {}, latitude: {}};\r\n                              $scope.displayCustomForm = false;\r\n                              $scope.currentElement = {};\r\n                              $scope.schedulingEnabled = false;\r\n                              $scope.eventPeriods = [];\r\n                              $scope.currentPeriod = [];\r\n                              $scope.showEventsAsTables = false;\r\n                              //variable is set while looping through the program stages later.\r\n                              $scope.stagesCanBeShownAsTable = false;\r\n                              $scope.hiddenFields = [];\r\n                              $scope.assignedFields = [];\r\n                              $scope.errorMessages = {};\r\n                              $scope.warningMessages = {};\r\n                              $scope.hiddenSections = {};\r\n                              $scope.stagesNotShowingInStageTasks = {};\r\n                              $scope.tabularEntryStages = [];\r\n                              $scope.tableMaxNumberOfDataElements = 15;\r\n                              $scope.xVisitScheduleDataElement = false;\r\n                              $scope.reSortStageEvents = true;\r\n                              $scope.eventsLoaded = false;\r\n                              $scope.dashBoardWidgetFirstRun = true;\r\n                              $scope.showSelf = true;\r\n                              $scope.orgUnitNames = {};\r\n                              \r\n                              var eventLockEnabled = false;\r\n                              var eventLockHours = 8; //Number of hours before event is locked after completing.\r\n\r\n                              $scope.useMainMenu = false;\r\n                              $scope.mainMenuStages = [];\r\n                              $scope.useBottomLine = false; \r\n                              \r\n                              //hideTopLineEventsForFormTypes is only used with main menu\r\n                              $scope.hideTopLineEventsForFormTypes = {TABLE: true, COMPARE: true};\r\n                              \r\n                              $scope.visibleWidgetsInMainMenu = {enrollment: true, dataentry: true, close_file: true};    \r\n                              $rootScope.$broadcast('DataEntryMainMenuVisibilitySet', {visible: $scope.useMainMenu, visibleItems: $scope.visibleWidgetsInMainMenu});\r\n                              \r\n\r\n                              var modalCompleteIncompleteActions = { complete: 'complete', completeAndExit: 'completeandexit', completeEnrollment: 'completeenrollment', edit: 'edit'};\r\n\r\n                              //Labels\r\n                              $scope.dataElementLabel = $translate.instant('data_element');\r\n                              $scope.valueLabel = $translate.instant('value');\r\n                              $scope.providedElsewhereLabel = $translate.instant('provided_elsewhere');\r\n                              \r\n                              $scope.EVENTSTATUSCOMPLETELABEL = \"COMPLETED\";\r\n                              $scope.EVENTSTATUSSKIPPEDLABEL = \"SKIPPED\";\r\n                              $scope.EVENTSTATUSVISITEDLABEL = \"VISITED\";\r\n                              $scope.EVENTSTATUSACTIVELABEL = \"ACTIVE\";\r\n                              $scope.EVENTSTATUSSCHEDULELABEL = \"SCHEDULE\";\r\n                              $scope.validatedDateSetForEvent = {};\r\n                              $scope.eventCreationActions = EventCreationService.eventCreationActions;\r\n                              \r\n                              var userProfile = SessionStorageService.get('USER_PROFILE');\r\n                              var storedBy = userProfile && userProfile.username ? userProfile.username : '';\r\n\r\n                              var today = DateUtils.getToday();\r\n                              $scope.invalidDate = false;\r\n\r\n                              //note\r\n                              $scope.note = {};    \r\n                              \r\n                              $scope.eventStyles = [\r\n                                  {color: 'custom-tracker-complete', description: 'completed', showInStageLegend: true, showInEventLegend: true},\r\n                                  {color: 'alert-warning', description: 'executed', showInStageLegend: true, showInEventLegend: true},        \r\n                                  {color: 'alert-success', description: 'ontime', showInStageLegend: true, showInEventLegend: true},\r\n                                  {color: 'alert-danger', description: 'overdue', showInStageLegend: true, showInEventLegend: true},        \r\n                                  {color: 'alert-default', description: 'skipped', showInStageLegend: false, showInEventLegend: true}/*,\r\n                                                                                                                                       {color: '', description: 'empty', showInStageLegend: true, showInEventLegend: false}*/\r\n                              ];\r\n                              \r\n                              $scope.model= {};\r\n                              $scope.model.showLegend = false;\r\n                              $scope.model.showEventSearch = false;\r\n                              $scope.model.eventSearchText = '';\r\n                              \r\n                              $scope.filterLegend = function(){\r\n                                  if($scope.mainMenuStageSelected()){\r\n                                      return {showInEventLegend: true};\r\n                                  }\r\n                                  else {\r\n                                      return {showInStageLegend: true};\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.getLegendText = function(description){\r\n                                  var useInStage = true;\r\n                                  if($scope.mainMenuStageSelected()){\r\n                                      useInStage = false;            \r\n                                  }\r\n                                  return $scope.getDescriptionTextForDescription(description, $scope.descriptionTypes.full, useInStage);\r\n                              };\r\n\r\n                              $scope.verifyExpiryDate = function(eventDateStr) {\r\n                                  var dateGetter = $parse(eventDateStr);\r\n                                  var dateSetter = dateGetter.assign;\r\n                                  var date = dateGetter($scope);\r\n                                  if(!date) {\r\n                                      return;\r\n                                  }\r\n                                  if($scope.selectedProgram.expiryPeriodType && $scope.selectedProgram.expiryDays) {\r\n                                      if (!DateUtils.verifyExpiryDate(date, $scope.selectedProgram.expiryPeriodType, $scope.selectedProgram.expiryDays)) {\r\n                                          dateSetter($scope, null);\r\n                                      }\r\n                                  }\r\n                              };\r\n                              \r\n                              \r\n                              //listen for new events created\r\n                              $scope.$on('eventcreated', function (event, args) {\r\n                                  //TODO: Sort this out:\r\n                                  $scope.addNewEvent(args.event);\r\n                              });\r\n                              \r\n                              $scope.$on('teiupdated', function(event, args){\r\n                                  var selections = CurrentSelection.get();        \r\n                                  $scope.selectedTei = selections.tei;\r\n                                  $scope.executeRules();\r\n                              });\r\n\r\n                              //listen for rule effect changes\r\n                              $scope.$on('ruleeffectsupdated', function (event, args) {\r\n                                  if ($rootScope.ruleeffects[args.event]) {\r\n                                      processRuleEffect(args.event, args.callerId);\r\n                                  }\r\n                              });\r\n                              $scope.useReferral = false;\r\n                              $scope.showReferral = false;\r\n                              //Check if user is allowed to make referrals\r\n                              if($scope.useReferral){\r\n                                  var roles = SessionStorageService.get('USER_PROFILE');\r\n                                  if( roles && roles.userCredentials && roles.userCredentials.userRoles){\r\n                                      var userRoles = roles.userCredentials.userRoles;\r\n                                      for(var i=0; i<userRoles.length; i++){\r\n                                          if(userRoles[i].authorities.indexOf('ALL') !== -1 || userRoles[i].authorities.indexOf('F_TRACKED_ENTITY_INSTANCE_SEARCH_IN_ALL_ORGUNITS') !== -1 ){\r\n                                              $scope.showReferral = true;\r\n                                              i=userRoles.length;\r\n                                          }\r\n                                      } \r\n                                  }\r\n                              }\r\n                              \r\n                              $scope.$watch(\"model.eventSearchText\", function(newValue, oldValue){        \r\n                                  if($scope.model.eventSearchText !== ''){\r\n                                      $scope.currentEvent = null;\r\n                                  }\r\n                              });\r\n                              \r\n                              $scope.print = function(divName){\r\n                                  $scope.printForm = true;\r\n                                  $scope.printEmptyForm = true;\r\n                                  var printContents = document.getElementById(divName).innerHTML;\r\n                                  var popupWin = window.open('', '_blank', 'fullscreen=1');\r\n                                  popupWin.document.open();\r\n                                  popupWin.document.write('<html>\\n\\\r\n<head>\\n\\\r\n<link rel=\"stylesheet\" type=\"text/css\" href=\"../dhis-web-commons/bootstrap/css/bootstrap.min.css\" />\\n\\\r\n<link type=\"text/css\" rel=\"stylesheet\" href=\"../dhis-web-commons/javascripts/angular/plugins/select.css\">\\n\\\r\n<link type=\"text/css\" rel=\"stylesheet\" href=\"../dhis-web-commons/javascripts/angular/plugins/select2.css\">\\n\\\r\n<link rel=\"stylesheet\" type=\"text/css\" href=\"styles/style.css\" />\\n\\\r\n<link rel=\"stylesheet\" type=\"text/css\" href=\"styles/print.css\" />\\n\\\r\n</head>\\n\\\r\n<body onload=\"window.print()\">' + printContents + \r\n                                                          '</html>');\r\n                                  popupWin.document.close();\r\n                                  $scope.printForm = false;\r\n                                  $scope.printEmptyForm = false;\r\n                              };\r\n\r\n                              var processRuleEffect = function(event, callerId){\r\n                                  //Establish which event was affected:\r\n                                  var affectedEvent = $scope.currentEvent;\r\n                                  if (!affectedEvent || !affectedEvent.event) {\r\n                                      //The data entry widget does not have an event selected. \r\n                                      //Therefore applying rule effects from registration instead.\r\n                                      affectedEvent = 'registration';\r\n                                  }\r\n                                  else if(event === 'registration' || event === 'dataEntryInit') {\r\n                                      //The data entry widget is associated with an event, \r\n                                      //and therefore we do not want to process rule effects from the registration form\r\n                                      return;\r\n                                  }\r\n\r\n                                  //In most cases the updated effects apply to the current event. In case the affected event is not the current event, fetch the correct event to affect:\r\n                                  if (event !== affectedEvent.event) {\r\n                                      angular.forEach($scope.allEventsSorted, function (searchedEvent) {\r\n                                          if (searchedEvent.event === event) {\r\n                                              affectedEvent = searchedEvent;\r\n                                          }\r\n                                      });\r\n                                  }\r\n\r\n                                  $scope.assignedFields[event] = [];\r\n                                  $scope.hiddenSections[event] = [];\r\n                                  $scope.warningMessages[event] = [];\r\n                                  $scope.errorMessages[event] = [];\r\n                                  $scope.hiddenFields[event] = [];\r\n                                  \r\n                                  angular.forEach($rootScope.ruleeffects[event], function (effect) {\r\n                                      //in the data entry controller we only care about the \"hidefield\", showerror and showwarning actions\r\n                                      if (effect.action === \"HIDEFIELD\") {                    \r\n                                          if (effect.dataElement) {\r\n\r\n                                              if(affectedEvent.status !== 'SCHEDULE' &&\r\n                                                 affectedEvent.status !== 'SKIPPED' &&\r\n                                                 !affectedEvent.editingNotAllowed) {\r\n                                                  if (effect.ineffect && affectedEvent[effect.dataElement.id]) {\r\n                                                      //If a field is going to be hidden, but contains a value, we need to take action;\r\n                                                      if (effect.content) {\r\n                                                          //TODO: Alerts is going to be replaced with a proper display mecanism.\r\n                                                          alert(effect.content);\r\n                                                      }\r\n                                                      else {\r\n                                                          //TODO: Alerts is going to be replaced with a proper display mecanism.\r\n                                                          alert($scope.prStDes[effect.dataElement.id].dataElement.displayFormName + \" was blanked out and hidden by your last action\");\r\n                                                      }\r\n\r\n                                                      //Blank out the value:\r\n                                                      affectedEvent[effect.dataElement.id] = \"\";\r\n                                                      $scope.saveDataValueForEvent($scope.prStDes[effect.dataElement.id], null, affectedEvent, true);\r\n                                                  }\r\n                                              }\r\n\r\n                                              if(effect.ineffect) {\r\n                                                  $scope.hiddenFields[event][effect.dataElement.id] = true;\r\n                                              } \r\n                                              else if( !$scope.hiddenFields[event][effect.dataElement.id]) {\r\n                                                  $scope.hiddenFields[event][effect.dataElement.id] = false;\r\n                                              }\r\n                                              \r\n                                          }\r\n                                          else {\r\n                                              $log.warn(\"ProgramRuleAction \" + effect.id + \" is of type HIDEFIELD, bot does not have a dataelement defined\");\r\n                                          }\r\n                                      } else if (effect.action === \"SHOWERROR\" \r\n                                                 || effect.action === \"ERRORONCOMPLETE\") {\r\n                                          if (effect.ineffect) {\r\n                                              var message = effect.content + (effect.data ? effect.data : \"\");\r\n                                              \r\n                                              if(effect.dataElement && $scope.prStDes[effect.dataElement.id]) {\r\n                                                  if(effect.action === \"SHOWERROR\") {\r\n                                                      //only SHOWERROR messages is going to be shown in the form as the user works\r\n                                                      $scope.errorMessages[event][effect.dataElement.id] = message;\r\n                                                  }\r\n                                                  $scope.errorMessages[event].push($translate.instant($scope.prStDes[effect.dataElement.id].dataElement.displayName) + \": \" + message);\r\n                                              }\r\n                                              else\r\n                                              {\r\n                                                  $scope.errorMessages[event].push(message);\r\n                                              }\r\n                                          }\r\n                                      } else if (effect.action === \"SHOWWARNING\" \r\n                                                 || effect.action === \"WARNINGONCOMPLETE\") {\r\n                                          if (effect.ineffect) {\r\n                                              var message = effect.content + (effect.data ? effect.data : \"\");\r\n                                              \r\n                                              if(effect.dataElement && $scope.prStDes[effect.dataElement.id]) {\r\n                                                  if(effect.action === \"SHOWWARNING\") {\r\n                                                      //only SHOWWARNING messages is going to show up in the form as the user works\r\n                                                      $scope.warningMessages[event][effect.dataElement.id] = message;\r\n                                                  }\r\n                                                  $scope.warningMessages[event].push($translate.instant($scope.prStDes[effect.dataElement.id].dataElement.displayName) + \": \" + message);\r\n                                              } else {\r\n                                                  $scope.warningMessages[event].push(message);\r\n                                              }\r\n                                          }\r\n                                      } else if (effect.action === \"HIDESECTION\"){                    \r\n                                          if(effect.programStageSection){\r\n                                              if(effect.ineffect){\r\n                                                  $scope.hiddenSections[event][effect.programStageSection] = true;\r\n                                              } else if (!$scope.hiddenSections[event][effect.programStageSection]) {\r\n                                                  $scope.hiddenSections[event][effect.programStageSection] = false;\r\n                                              }\r\n                                          }\r\n                                          else {\r\n                                              $log.warn(\"ProgramRuleAction \" + effect.id + \" is of type HIDESECTION, bot does not have a section defined\");\r\n                                          }\r\n                                      } else if (effect.action === \"ASSIGN\") {\r\n                                          if(affectedEvent.status !== 'SCHEDULE' &&\r\n                                             affectedEvent.status !== 'SKIPPED' &&\r\n                                             !affectedEvent.editingNotAllowed) {\r\n                                              if(effect.ineffect && effect.dataElement) {\r\n                                                  //For \"ASSIGN\" actions where we have a dataelement, we save the calculated value to the dataelement:\r\n                                                  //Blank out the value:\r\n                                                  var processedValue = $filter('trimquotes')(effect.data);\r\n\r\n                                                  if($scope.prStDes[effect.dataElement.id].dataElement.optionSet) {\r\n                                                      processedValue = OptionSetService.getName(\r\n                                                          $scope.optionSets[$scope.prStDes[effect.dataElement.id].dataElement.optionSet.id].options, processedValue);\r\n                                                  }\r\n\r\n                                                  processedValue = processedValue === \"true\" ? true : processedValue;\r\n                                                  processedValue = processedValue === \"false\" ? false : processedValue;\r\n\r\n                                                  affectedEvent[effect.dataElement.id] = processedValue;\r\n                                                  $scope.assignedFields[event][effect.dataElement.id] = true;\r\n                                                  \r\n                                                  if(callerId === $scope.instanceId) {\r\n                                                      $scope.saveDataValueForEvent($scope.prStDes[effect.dataElement.id], null, affectedEvent, true);\r\n                                                  }\r\n                                              }\r\n                                          }\r\n                                      }\r\n                                      else if (effect.action === \"HIDEPROGRAMSTAGE\") {\r\n                                          if (effect.programStage) {\r\n                                              if($scope.stagesNotShowingInStageTasks[effect.programStage.id] !== effect.ineffect )\r\n                                              {\r\n                                                  $scope.stagesNotShowingInStageTasks[effect.programStage.id] = effect.ineffect;\r\n                                              }\r\n                                          }\r\n                                          else {\r\n                                              $log.warn(\"ProgramRuleAction \" + effect.id + \" is of type HIDEPROGRAMSTAGE, bot does not have a stage defined\");\r\n                                          }\r\n                                      }\r\n                                  });\r\n                                  \r\n                                  updateTabularEntryStages();\r\n                              };\r\n                              \r\n                              function updateTabularEntryStages() {\r\n                                  $scope.tabularEntryStages = [];\r\n                                  angular.forEach($scope.programStages, function(programStage){\r\n                                      if(!$scope.stagesNotShowingInStageTasks[programStage.id]\r\n                                         || ($scope.eventsByStage[programStage.id] && \r\n                                              $scope.eventsByStage[programStage.id].length > 0)) {\r\n                                          $scope.tabularEntryStages.push(programStage);\r\n                                      }\r\n                                  });\r\n                                  $scope.tabularEntryStages = orderByFilter($scope.tabularEntryStages, '-sortOrder').reverse();\r\n                              };\r\n                              \r\n                              $scope.mainMenuStageSelected = function(){\r\n                                  if(angular.isDefined($scope.selectedMainMenuStage) && !angular.equals({}, $scope.selectedMainMenuStage)){\r\n                                      return true;\r\n                                  }\r\n                                  return false;\r\n                              };\r\n                              \r\n                              $scope.buildMainMenuStages = function(){\r\n                                  $scope.mainMenuStages = [];\r\n                                  angular.forEach($scope.programStages, function(stage){\r\n                                      if((angular.isUndefined($scope.neverShowItems) || angular.isUndefined($scope.neverShowItems[stage.id]) || $scope.neverShowItems[stage.id] === false) &&\r\n                                         (angular.isUndefined($scope.headerCombineStages) || angular.isUndefined($scope.headerCombineStages[stage.id]))){\r\n                                          $scope.mainMenuStages.push(stage);                    \r\n                                      }\r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.openStageFromMenu = function(stage){    \r\n                                  \r\n                                  $scope.deSelectCurrentEvent();        \r\n                                  $scope.selectedMainMenuStage = stage;\r\n                                  var timelineFilter = stage.id;\r\n                                  \r\n                                  if(angular.isDefined($scope.headerCombineStages)){\r\n                                      for(var key in $scope.headerCombineStages){\r\n                                          if(key === stage.id){\r\n                                              timelineFilter += \",\" + $scope.headerCombineStages[key];\r\n                                          }\r\n                                          else if($scope.headerCombineStages[key] === stage.id){\r\n                                              timelineFilter += \",\" + key;\r\n                                          }\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  $scope.openStageEventFromMenu(stage, timelineFilter);\r\n                                  \r\n                                  $rootScope.$broadcast('DataEntryMainMenuItemSelected');\r\n                                  \r\n                                  $rootScope.$broadcast('DataEntryMainMenuVisibilitySet', {visible: false});\r\n                              };\r\n                              \r\n                              $scope.$on('DashboardBackClicked', function(event){\r\n                                  $scope.backToMainMenu();\r\n                              });\r\n                              \r\n                              \r\n                              $scope.backToMainMenu = function(){\r\n                                  $scope.selectedMainMenuStage = {};\r\n                                  $scope.deSelectCurrentEvent();\r\n                                  $rootScope.$broadcast('DataEntryMainMenuVisibilitySet', {visible: true, visibleItems: $scope.visibleWidgetsInMainMenu});\r\n                              };\r\n                              \r\n                              $scope.bottomLineItems = {};\r\n                              $scope.neverShowItems = {};\r\n                              $scope.topLineStageFilter = {};\r\n                              $scope.headerStages = [];\r\n                              $scope.headerCombineStages = {};\r\n                              \r\n                              $scope.getHeaderStages = function(){\r\n                                  angular.forEach($scope.programStages, function(stage){\r\n                                      if((angular.isUndefined($scope.bottomLineItems) || angular.isUndefined($scope.bottomLineItems[stage.id]) || $scope.bottomLineItems[stage.id] === false) && \r\n                                         (angular.isUndefined($scope.neverShowItems) || angular.isUndefined($scope.neverShowItems[stage.id]) || $scope.neverShowItems[stage.id] === false) &&\r\n                                         (angular.isUndefined($scope.headerCombineStages) || angular.isUndefined($scope.headerCombineStages[stage.id]))){\r\n                                          $scope.headerStages.push(stage);                    \r\n                                      }\r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.headerStagesWithoutCurrent = function(){        \r\n                                  if($scope.headerStages.length > 0){\r\n                                      if(angular.isDefined($scope.selectedMainMenuStage)){                \r\n                                          var withoutCurrent = [];\r\n                                          var currentStage = $scope.selectedMainMenuStage;\r\n                                          if(angular.isDefined($scope.headerCombineStages) && $scope.headerCombineStages[$scope.selectedMainMenuStage.id]){                    \r\n                                              currentStage = $scope.stagesById[$scope.headerCombineStages[$scope.selectedMainMenuStage.id]];\r\n                                          }\r\n                                          \r\n                                          angular.forEach($scope.headerStages, function(headerStage){\r\n                                              if(headerStage.id !== currentStage.id){\r\n                                                  withoutCurrent.push(headerStage);\r\n                                              }\r\n                                          });\r\n                                          return withoutCurrent;\r\n                                      }\r\n                                      else {\r\n                                          return $scope.headerStages;\r\n                                      }\r\n                                  }        \r\n                              };\r\n                              \r\n                              $scope.headerCurrentStageName = function(){\r\n                                  \r\n                                  var name = \"\";\r\n                                  if($scope.selectedMainMenuStage && angular.isDefined($scope.selectedMainMenuStage.displayName)){\r\n                                      name = $scope.selectedMainMenuStage.displayName;\r\n                                      if(angular.isDefined($scope.headerCombineStages) && $scope.headerCombineStages[$scope.selectedMainMenuStage.id]){\r\n                                          var stageWithName = $scope.stagesById[$scope.headerCombineStages[$scope.selectedMainMenuStage.id]];\r\n                                          if(angular.isDefined(stageWithName) && angular.isObject(stageWithName)){\r\n                                              name = stageWithName.displayName;\r\n                                          }\r\n                                      }\r\n                                  }        \r\n                                  return name;\r\n                              };\r\n                              \r\n                              $scope.displayEventInTopLine = function(item) {\r\n                                  if($scope.neverShowItems[item.id]) {\r\n                                      return false;\r\n                                  }\r\n                                  if($scope.bottomLineItems[item.id]) {\r\n                                      return false;\r\n                                  }\r\n                                  return true;\r\n                              };\r\n                              \r\n                              $scope.displayEventInBottomLine = function(item) {\r\n                                  if($scope.neverShowItems[item.id]) {\r\n                                      return false;\r\n                                  }\r\n                                  if($scope.bottomLineItems[item.id]) {\r\n                                      return true;\r\n                                  }\r\n                                  return false;\r\n                              };\r\n                              \r\n                              function topLineEventsIsFiltered(){               \r\n                                  if((angular.isDefined($scope.neverShowItems) && !angular.equals({},$scope.neverShowItems)) ||\r\n                                     (angular.isDefined($scope.bottomLineItems) && !angular.equals({}, $scope.bottomLineItems)) ||\r\n                                     (angular.isDefined($scope.topLineStageFilter) && !angular.equals({}, $scope.topLineStageFilter))){\r\n                                      return true;\r\n                                  }\r\n                                  return false;\r\n                              }\r\n                              \r\n                              $scope.topLineEvents = [];\r\n                              function getTopLineEvents(allEvents){              \r\n                                  if(!topLineEventsIsFiltered()){\r\n                                      $scope.topLineEvents = $scope.allEventsSorted;\r\n                                      return $scope.topLineEvents;\r\n                                  }        \r\n                                  else {\r\n                                      $scope.topLineEvents = [];\r\n                                      \r\n                                      if(angular.isDefined($scope.topLineStageFilter) && !angular.equals({}, $scope.topLineStageFilter)){\r\n                                          \r\n                                          var filterStages = [];\r\n                                          for(var key in $scope.topLineStageFilter){\r\n                                              filterStages.push($scope.stagesById[key]);\r\n                                          }\r\n                                          filterStages.sort(function(a,b){\r\n                                              return a.sortOrder - b.sortOrder;\r\n                                          });\r\n                                          \r\n                                          angular.forEach(filterStages, function(filterStage){\r\n                                              var stageEvents = $scope.eventsByStage[filterStage.id];                    \r\n                                              $scope.topLineEvents = $scope.topLineEvents.concat(stageEvents);                    \r\n                                          });            \r\n                                      }\r\n                                      else {\r\n                                          var hiddenStages = [];\r\n                                          if(angular.isDefined($scope.neverShowItems) && angular.isDefined($scope.bottomLineItems)){\r\n                                              hiddenStages = angular.extend({}, $scope.neverShowItems, $scope.bottomLineItems);\r\n                                          }\r\n                                          else if(angular.isDefined($scope.neverShowItems)){\r\n                                              hiddenStages = $scope.neverShowItems;\r\n                                          }\r\n                                          else if(angular.isDefined($scope.bottomLineItems)){\r\n                                              hiddenStages = $scope.bottomLineItems;\r\n                                          }\r\n\r\n                                          angular.forEach($scope.allEventsSorted, function(event){\r\n                                              if(!hiddenStages[event.programStage]){\r\n                                                  $scope.topLineEvents.push(event);\r\n                                              }                \r\n                                          });\r\n                                      }\r\n                                      \r\n                                      return $scope.topLineEvents;\r\n                                  }        \r\n                              }\r\n                              \r\n                              $scope.getTopLineEventsPage = function(){\r\n                                  \r\n                                  if($scope.allEventsSorted && $scope.allEventsSorted.length > 0){            \r\n                                      var topLineEvents = getTopLineEvents($scope.allEventsSorted);            \r\n                                      $scope.getEventPageForEvent($scope.currentEvent);\r\n                                      return topLineEvents.slice($scope.eventPagingStart, $scope.eventPagingEnd);\r\n                                  }\r\n                                  return [];\r\n                              };\r\n                              \r\n                              $scope.isCompulsory = function(dataElement) {\r\n                                  return $scope.currentStage.programStageDataElementsCollection[dataElement.id].compulsory;\r\n                              };\r\n                              \r\n                              //check if field is hidden\r\n                              $scope.isHidden = function (id, event) {\r\n                                  //In case the field contains a value, we cant hide it. \r\n                                  //If we hid a field with a value, it would falsely seem the user was aware that the value was entered in the UI.\r\n                                  var EventToCheck = angular.isDefined(event) ? event : $scope.currentEvent;\r\n                                  \r\n                                  if (EventToCheck[id]) {\r\n                                      return false;\r\n                                  }\r\n                                  else {            \r\n                                      if(angular.isDefined($scope.hiddenFields[EventToCheck.event])){\r\n                                          return $scope.hiddenFields[EventToCheck.event][id];\r\n                                      }\r\n                                      else {\r\n                                          return false;\r\n                                      }            \r\n                                  }\r\n                              };\r\n\r\n                              $scope.executeRules = function () {        \r\n                                  if (!$scope.currentEvent) {\r\n                                      return;\r\n                                  }\r\n                                  \r\n                                  var allSorted = [];\r\n                                  for(var ps = 0; ps < $scope.programStages.length; ps++ ) {\r\n                                      for(var e = 0; e < $scope.eventsByStage[$scope.programStages[ps].id].length; e++) {\r\n                                          allSorted.push($scope.eventsByStage[$scope.programStages[ps].id][e]);\r\n                                      }\r\n                                  }\r\n                                  allSorted = orderByFilter(allSorted, '-sortingDate').reverse();\r\n                                  \r\n                                  var evs = {all: allSorted, byStage: $scope.eventsByStage};\r\n                                  \r\n                                  var flag = {debug: true, verbose: true, callerId: $scope.instanceId};\r\n                                  \r\n                                  //If the events is displayed in a table, it is necessary to run the rules for all visible events.        \r\n                                  if ($scope.currentStage && $scope.currentStage.displayEventsInTable && angular.isUndefined($scope.currentStage.rulesExecuted)) {\r\n                                      angular.forEach($scope.currentStageEvents, function (event) {\r\n                                          TrackerRulesExecutionService.executeRules($scope.allProgramRules, event, evs, $scope.prStDes, $scope.selectedTei, $scope.selectedEnrollment, $scope.optionSets, flag);\r\n                                          $scope.currentStage.rulesExecuted = true;\r\n                                      });\r\n                                  } else {\r\n                                      TrackerRulesExecutionService.executeRules($scope.allProgramRules, $scope.currentEvent, evs, $scope.prStDes, $scope.selectedTei, $scope.selectedEnrollment, $scope.optionSets, flag);\r\n                                  }\r\n                              };\r\n\r\n\r\n                              //listen for the selected items\r\n                              $scope.$on('dashboardWidgets', function () {\r\n                                  $scope.showDataEntryDiv = false;\r\n                                  $scope.showEventCreationDiv = false;\r\n                                  $scope.currentEvent = null;\r\n                                  $scope.currentStage = null;\r\n                                  $scope.currentStageEvents = null;\r\n                                  $scope.totalEvents = 0;\r\n                                  $scope.eventsLoaded = false;\r\n                                  $scope.stageStyleLabels = [];\r\n                                  $scope.eventStyleLabels = [];\r\n\r\n                                  $scope.allowEventCreation = false;\r\n                                  $scope.repeatableStages = [];\r\n                                  $scope.eventsByStage = [];\r\n                                  $scope.eventsByStageDesc = [];\r\n                                  $scope.programStages = [];\r\n                                  $scope.tabularEntryStages = [];\r\n                                  $rootScope.ruleeffects = {};        \r\n                                  $scope.prStDes = [];\r\n                                  $scope.allProgramRules = [];\r\n                                  $scope.allowProvidedElsewhereExists = [];\r\n                                  $scope.optionsReady = false;\r\n                                  \r\n                                  var selections = CurrentSelection.get();\r\n                                  $scope.selectedOrgUnit = selections.orgUnit;\r\n                                  $scope.selectedEntity = selections.tei;\r\n                                  $scope.selectedProgram = selections.pr;\r\n                                  $scope.selectedEnrollment = selections.selectedEnrollment;\r\n                                  \r\n                                  var ouNames = CurrentSelection.getOrgUnitNames();            \r\n                                  ouNames[$scope.selectedOrgUnit.id] = $scope.selectedOrgUnit.displayName;\r\n                                  CurrentSelection.setOrgUnitNames( ouNames );\r\n\r\n                                  $scope.showSelf = true;\r\n                                  if(angular.isUndefined($scope.selectedEnrollment) || $scope.selectedEnrollment === null || ($scope.dashBoardWidgetFirstRun && $scope.selectedEnrollment.status === \"COMPLETED\")){\r\n                                      //onOpenEnrollment\r\n                                      $scope.showSelf = false;\r\n                                  }\r\n\r\n                                  $rootScope.$broadcast('BeforeOpenEnrollment', $scope.showSelf);\r\n                                  $scope.dashBoardWidgetFirstRun = false;\r\n                                  \r\n    \t                          $scope.optionSets = selections.optionSets;\r\n\r\n    \t                          $scope.stagesById = [];    \t    \r\n    \t                          if ($scope.selectedOrgUnit && $scope.selectedProgram && $scope.selectedProgram.id && $scope.selectedEntity ){\r\n                                      if ($scope.selectedOrgUnit.reportDateRange) {\r\n                                          if ($scope.selectedOrgUnit.reportDateRange.minDate) {\r\n                                              $scope.model.minDate = $scope.selectedOrgUnit.reportDateRange.minDate;\r\n                                          }\r\n                                          if ($scope.selectedOrgUnit.reportDateRange.maxDate) {\r\n                                              $scope.model.maxDate = $scope.selectedOrgUnit.reportDateRange.maxDate;\r\n                                          }\r\n                                      }\r\n                                      \r\n                                      $scope.programStages = $scope.tabularEntryStages = $scope.selectedProgram.programStages;\r\n                                      \r\n                                      angular.forEach($scope.selectedProgram.programStages, function (stage) {\r\n                                          if (stage.openAfterEnrollment) {\r\n                                              $scope.currentStage = stage;\r\n                                          }\r\n\r\n                                          stage.programStageDataElementsCollection = {};\r\n\r\n                                          stage.executionDateLabel = stage.executionDateLabel ? stage.executionDateLabel : $translate.instant('report_date');\r\n                                          angular.forEach(stage.programStageDataElements, function (prStDe) {\r\n                                              $scope.prStDes[prStDe.dataElement.id] = prStDe;\r\n                                              if(prStDe.allowProvidedElsewhere){\r\n                                                  $scope.allowProvidedElsewhereExists[stage.id] = true;\r\n                                              }\r\n\r\n                                              stage.programStageDataElementsCollection[prStDe.dataElement.id] = prStDe;\r\n                                          });\r\n\r\n                                          $scope.stagesById[stage.id] = stage;\r\n                                          $scope.eventsByStage[stage.id] = [];\r\n\r\n                                          //If one of the stages has less than $scope.tableMaxNumberOfDataElements data elements, allow sorting as table:\r\n                                          if ($scope.stageCanBeShownAsTable(stage)) {\r\n                                              $scope.stagesCanBeShownAsTable = true;\r\n                                          }\r\n                                      });\r\n\r\n                                      $scope.programStages = orderByFilter($scope.programStages, '-sortOrder').reverse();\r\n                                      if (!$scope.currentStage) {\r\n                                          $scope.currentStage = $scope.programStages[0];\r\n                                      }\r\n\r\n                                      $scope.setCurrentStage($scope.currentStage);                \r\n\r\n                                      if($scope.useMainMenu){\r\n                                          $scope.buildMainMenuStages();\r\n                                      }\r\n\r\n                                      $scope.setDisplayTypeForStages();\r\n                                      $scope.getHeaderStages();\r\n\r\n                                      $scope.selectedCategories = [];\r\n                                      if($scope.selectedProgram.categoryCombo && \r\n                                         !$scope.selectedProgram.categoryCombo.isDefault &&\r\n                                         $scope.selectedProgram.categoryCombo.categories){\r\n                                          $scope.selectedCategories = $scope.selectedProgram.categoryCombo.categories;                    \r\n                                      }\r\n                                      else{\r\n                                          $scope.optionsReady = true;\r\n                                      }\r\n\r\n                                      TrackerRulesFactory.getRules($scope.selectedProgram.id).then(function(rules){\r\n                                          $scope.allProgramRules = rules;\r\n                                          $scope.getEvents();\r\n                                          broadcastDataEntryControllerData();\r\n                                      });    \t        \r\n    \t                          }\r\n                              });\r\n\r\n                              $scope.openEventExternal = function(event){\r\n                                  if($scope.useMainMenu){\r\n                                      var stage = $scope.stagesById[event.programStage];\r\n                                      $scope.openStageFromMenu(stage);\r\n                                  }else{\r\n                                      $scope.showDataEntry(event, true, true);\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.deleteScheduleAndOverdueEvents = function(){\r\n                                  var promises = [];\r\n                                  for(var i = 0; i < $scope.programStages.length; i++ ) {\r\n                                      for(var e = 0; e < $scope.eventsByStage[$scope.programStages[i].id].length; e++) {\r\n                                          if($scope.eventsByStage[$scope.programStages[i].id][e].status ==='SCHEDULE' || $scope.eventsByStage[$scope.programStages[i].id][e].status ==='OVERDUE'){\r\n                                              promises.push(DHIS2EventFactory.delete($scope.eventsByStage[$scope.programStages[i].id][e]));\r\n                                          }\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  return $q.all(promises);\r\n                              };\r\n                              \r\n                              function broadcastDataEntryControllerData(){\r\n                                  $rootScope.$broadcast('dataEntryControllerData', {programStages: $scope.programStages, eventsByStage: $scope.eventsByStage, addNewEvent: $scope.addNewEvent, openEvent: $scope.openEventExternal, deleteScheduleOverDueEvents: $scope.deleteScheduleAndOverdueEvents, executeRules: $scope.executeRules });\r\n                              }\r\n                              \r\n                              $scope.getEvents = function () {\r\n\r\n                                  $scope.allEventsSorted = [];\r\n                                  var events = CurrentSelection.getSelectedTeiEvents();        \r\n                                  events = $filter('filter')(events, {program: $scope.selectedProgram.id});\r\n                                  if (angular.isObject(events) && events.length > 0) {\r\n                                      angular.forEach(events, function (dhis2Event) {\r\n                                          if ($scope.selectedEnrollment && $scope.selectedEnrollment.enrollment === dhis2Event.enrollment && dhis2Event.orgUnit) {\r\n                                              if (dhis2Event.notes) {\r\n                                                  dhis2Event.notes = orderByFilter(dhis2Event.notes, '-storedDate');\r\n                                                  angular.forEach(dhis2Event.notes, function (note) {\r\n                                                      note.displayDate = DateUtils.formatFromApiToUser(note.storedDate);\r\n                                                      note.storedDate = DateUtils.formatToHrsMins(note.storedDate);\r\n                                                  });\r\n                                              }\r\n                                              var eventStage = $scope.stagesById[dhis2Event.programStage];\r\n                                              if (angular.isObject(eventStage)) {\r\n                                                  dhis2Event.name = eventStage.displayName;\r\n                                                  dhis2Event.executionDateLabel = eventStage.executionDateLabel ? eventStage.executionDateLabel : $translate.instant('report_date');\r\n                                                  dhis2Event.dueDate = DateUtils.formatFromApiToUser(dhis2Event.dueDate);\r\n                                                  dhis2Event.sortingDate = dhis2Event.dueDate;\r\n\r\n                                                  if (dhis2Event.eventDate) {                            \r\n                                                      dhis2Event.eventDate = DateUtils.formatFromApiToUser(dhis2Event.eventDate);\r\n                                                      dhis2Event.sortingDate = dhis2Event.eventDate;                            \r\n                                                  }\r\n                                                  \r\n                                                  dhis2Event.editingNotAllowed = EventUtils.getEditingStatus(dhis2Event, eventStage, $scope.selectedOrgUnit, $scope.selectedTei, $scope.selectedEnrollment);\r\n                                                  \r\n                                                  dhis2Event.statusColor = EventUtils.getEventStatusColor(dhis2Event);\r\n                                                  dhis2Event = EventUtils.processEvent(dhis2Event, eventStage, $scope.optionSets, $scope.prStDes);\r\n                                                  $scope.eventsByStage[dhis2Event.programStage].push(dhis2Event);\r\n                                                  \r\n                                                  if ($scope.currentStage && $scope.currentStage.id === dhis2Event.programStage) {\r\n                                                      $scope.currentEvent = dhis2Event;\r\n                                                  }\r\n                                              }\r\n                                              \r\n                                              $scope.allEventsSorted.push(dhis2Event);\r\n                                          }\r\n                                      });\r\n                                      \r\n                                      $scope.orgUnitNames = CurrentSelection.getOrgUnitNames();\r\n                                      $scope.fileNames = CurrentSelection.getFileNames();\r\n                                      $scope.allEventsSorted = orderByFilter($scope.allEventsSorted, '-sortingDate').reverse();\r\n                                      sortEventsByStage(null);\r\n                                      $scope.showDataEntry($scope.currentEvent, true, true);\r\n                                      $scope.eventsLoaded = true;\r\n                                  }\r\n                                  else {\r\n                                      //There is no events - so loading is finished:\r\n                                      $scope.eventsLoaded = true;\r\n                                  }\r\n                              };\r\n\r\n                              $scope.enableRescheduling = function () {\r\n                                  $scope.schedulingEnabled = !$scope.schedulingEnabled;\r\n                              };\r\n\r\n                              $scope.stageCanBeShownAsTable = function (stage) {\r\n                                  if (stage.programStageDataElements \r\n                                      && stage.programStageDataElements.length <= $scope.tableMaxNumberOfDataElements\r\n                                      && stage.repeatable) {\r\n                                      return true;\r\n                                  }\r\n                                  return false;\r\n                              };\r\n\r\n                              $scope.toggleEventsTableDisplay = function () {       \r\n                                  $scope.showEventsAsTables = !$scope.showEventsAsTables;                \r\n\r\n                                  $scope.setDisplayTypeForStages();\r\n\r\n                                  \r\n                                  if ($scope.currentStage && $scope.stageCanBeShownAsTable($scope.currentStage)) {\r\n                                      //If the current event was deselected, select the first event in the current Stage before showing data entry:\r\n                                      if(!$scope.currentEvent.event \r\n                                         && $scope.eventsByStage[$scope.currentStage.id]) {\r\n                                          $scope.currentEvent = $scope.eventsByStage[$scope.currentStage.id][0];\r\n                                      }\r\n                                      \r\n                                      $scope.getDataEntryForm();\r\n                                  } \r\n                              };\r\n                              \r\n                              $scope.setDisplayTypeForStages = function(){\r\n                                  angular.forEach($scope.programStages, function (stage) {\r\n                                      $scope.setDisplayTypeForStage(stage);\r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.setDisplayTypeForStage = function(stage){\r\n                                  if ($scope.stageCanBeShownAsTable(stage)) {\r\n                                      stage.displayEventsInTable = $scope.showEventsAsTables;\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.stageNeedsEventErrors = {enrollment: 1, complete: 2, scheduleDisabled: 3, scheduledFound: 4, notRepeatable: 5};\r\n                              \r\n                              $scope.stageNeedsEventOfType = function (stage, type, completeRequired, errorResponseContainer) {\r\n                                  \r\n                                  if(type === $scope.eventCreationActions.schedule || type === $scope.eventCreationActions.referral){\r\n                                      if(stage.hideDueDate === true){\r\n                                          if(angular.isDefined(errorResponseContainer)){\r\n                                              errorResponseContainer.errorCode = $scope.stageNeedsEventErrors.scheduleDisabled;\r\n                                          }                \r\n                                          return false;\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  return $scope.stageNeedsEvent(stage, completeRequired, errorResponseContainer);\r\n                              };\r\n                              \r\n                              $scope.stageNeedsEvent = function (stage, completeRequired, errorResponseContainer) {\r\n                                  \r\n                                  if(!stage){\r\n                                      return false;\r\n                                  }\r\n                                  \r\n                                  var calculatedCompleteRequired = (angular.isDefined(completeRequired) && completeRequired) || (angular.isDefined(stage.onlyOneIncompleteEvent) && stage.onlyOneIncompleteEvent);\r\n                                  \r\n                                  if($scope.selectedEnrollment && $scope.selectedEnrollment.status === 'ACTIVE'){\r\n                                      if(!stage){\r\n                                          if(!$scope.allEventsSorted || $scope.allEventsSorted.length === 0){\r\n                                              return true;\r\n                                          }\r\n                                          for(var key in $scope.eventsByStage){\r\n                                              stage = $scope.stagesById[key];\r\n                                              if(stage && stage.repeatable){\r\n                                                  for (var j = 0; j < $scope.eventsByStage[stage.id].length; j++) {\r\n                                                      if (!$scope.eventsByStage[stage.id][j].eventDate && $scope.eventsByStage[stage.id][j].status !== 'SKIPPED') {\r\n                                                          return true;\r\n                                                      }\r\n                                                  }\r\n                                                  return true;\r\n                                              }\r\n                                          }\r\n                                          return false;\r\n                                      }\r\n\r\n                                      //In case the event is a table, we sould always allow adding more events(rows)\r\n                                      if (stage.displayEventsInTable) {\r\n                                          return true;\r\n                                      }\r\n                                      \r\n                                      if ($scope.eventsByStage[stage.id].length === 0) {\r\n                                          return true;\r\n                                      }\r\n                                      \r\n                                      if (stage.repeatable) {\r\n                                          for (var j = 0; j < $scope.eventsByStage[stage.id].length; j++) {\r\n                                              if(angular.isDefined(calculatedCompleteRequired) && calculatedCompleteRequired === true){\r\n                                                  var foundEvent = $scope.eventsByStage[stage.id][j];\r\n                                                  if(foundEvent.status !== $scope.EVENTSTATUSCOMPLETELABEL && foundEvent.status !== $scope.EVENTSTATUSSKIPPEDLABEL){\r\n                                                      if(angular.isDefined(errorResponseContainer)){\r\n                                                          errorResponseContainer.errorCode = $scope.stageNeedsEventErrors.complete;\r\n                                                      }\r\n                                                      return false;\r\n                                                  }                            \r\n                                              }\r\n                                              else if (!$scope.eventsByStage[stage.id][j].eventDate && $scope.eventsByStage[stage.id][j].status !== 'SKIPPED') {\r\n                                                  if(angular.isDefined(errorResponseContainer)){\r\n                                                      errorResponseContainer.errorCode = $scope.stageNeedsEventErrors.scheduledFound;\r\n                                                  }\r\n                                                  return false;\r\n                                              }\r\n                                          }\r\n                                          return true;\r\n                                      }\r\n                                      else{\r\n                                          if(angular.isDefined(errorResponseContainer)){\r\n                                              errorResponseContainer.errorCode = $scope.stageNeedsEventErrors.notRepeatable;\r\n                                          }\r\n                                          return false;\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  if(angular.isDefined(errorResponseContainer)){\r\n                                      errorResponseContainer.errorCode = $scope.stageNeedsEventErrors.enrollment;\r\n                                  }\r\n                                  return false;\r\n                              };\r\n                              \r\n                              $scope.creatableStagesExist = function(stageList) {\r\n                                  if(stageList && stageList.length > 0) {\r\n                                      return true;\r\n                                  }\r\n                                  \r\n                                  return false;\r\n                              };\r\n                              \r\n                              $scope.getTopLineColumnStyle = function(colNr){\r\n                                  if($scope.useMainMenu && ($scope.topLineEvents.length === 0 || $scope.hideTopLineEventsForFormTypes[$scope.displayCustomForm])){\r\n                                      if(colNr === 1){\r\n                                          return 'col-xs-12';\r\n                                      }\r\n                                      else {\r\n                                          return '';\r\n                                      }\r\n                                  }\r\n                                  else if($scope.showStageTasks){\r\n                                      if(colNr === 1){\r\n                                          return $scope.selectedEnrollment.status !== 'ACTIVE' ? 'col-xs-12' : 'col-xs-6 col-sm-9';\r\n                                      }\r\n                                      else {\r\n                                          return 'col-xs-6 col-sm-3';\r\n                                      }\r\n                                  }\r\n                                  else {\r\n                                      if(colNr === 1){\r\n                                          return $scope.selectedEnrollment.status !== 'ACTIVE' ? 'col-xs-12' : 'col-xs-10 col-sm-11';\r\n                                      }\r\n                                      else {\r\n                                          return 'col-xs-2 col-sm-1';\r\n                                      }\r\n                                  }        \r\n                              };    \r\n                              \r\n                              $scope.displayStageTasksInTopLine = function(stage) {\r\n                                  if($scope.stagesNotShowingInStageTasks[stage.id]){\r\n                                      return false;\r\n                                  }   \r\n                                  \r\n                                  return $scope.stageNeedsEvent(stage);\r\n                              };\r\n                              \r\n                              $scope.showStageTasks = false;\r\n                              $scope.toggleShowStageTasks = function(){\r\n                                  $scope.showStageTasks = !$scope.showStageTasks;\r\n                              };\r\n                              \r\n                              $scope.addNewEvent = function(newEvent,setProgramStage) {\r\n                                  //Have to make sure the event is preprocessed - this does not happen unless \"Dashboardwidgets\" is invoked.\r\n                                  newEvent = EventUtils.processEvent(newEvent, $scope.stagesById[newEvent.programStage], $scope.optionSets, $scope.prStDes);\r\n                                  if(setProgramStage) $scope.currentStage = $scope.stagesById[newEvent.programStage];\r\n                                  $scope.eventsByStage[newEvent.programStage].push(newEvent);\r\n                                  sortEventsByStage('ADD', newEvent);\r\n                                  broadcastDataEntryControllerData();\r\n                              };\r\n                              \r\n                              function getApplicableStagesForStageTasks(){\r\n                                  \r\n                                  if(angular.isUndefined($scope.stagesNotShowingInStageTasks)){\r\n                                      return $scope.programStages;\r\n                                  }\r\n                                  else {\r\n                                      var applicableStages = [];\r\n                                      angular.forEach($scope.programStages, function(stage){\r\n                                          if(!$scope.stagesNotShowingInStageTasks[stage.id]){\r\n                                              applicableStages.push(stage);\r\n                                          }\r\n                                      });\r\n                                      return applicableStages;\r\n                                  }\r\n                              }\r\n                              \r\n                              $scope.stageErrorInEventLayout = [];\r\n                              $scope.showCreateEventIfStageNeedsEvent = function(stage, eventCreationAction, requireStageEventsToBeCompleted, showModalOnNoEventsNeeded){\r\n\r\n                                  \r\n                                  showModalOnNoEventsNeeded = angular.isDefined(showModalOnNoEventsNeeded) && showModalOnNoEventsNeeded === true ? true : false;\r\n                                  var errorResponseContainer = {};\r\n                                  \r\n                                  if($scope.stageNeedsEventOfType(stage, eventCreationAction, requireStageEventsToBeCompleted, errorResponseContainer)){\r\n                                      if(!showModalOnNoEventsNeeded){\r\n                                          $scope.stageErrorInEventLayout[stage.id] = \"\";\r\n                                      }            \r\n                                      $scope.showCreateEvent(stage, eventCreationAction);\r\n                                  }\r\n                                  else {\r\n                                      if(showModalOnNoEventsNeeded){\r\n                                          var errorMessage = \"\";\r\n                                          if(angular.isDefined(errorResponseContainer.errorCode)){\r\n\r\n                                              switch(errorResponseContainer.errorCode){\r\n                                              case $scope.stageNeedsEventErrors.enrollment:\r\n                                                  errorMessage = $translate.instant('enrollment_is_not_active');\r\n                                                  break;\r\n                                              case $scope.stageNeedsEventErrors.complete:\r\n                                                  errorMessage = $translate.instant('please_complete_all_events');\r\n                                                  break;                    \r\n                                              case $scope.stageNeedsEventErrors.scheduleDisabled:\r\n                                                  errorMessage = $translate.instant('scheduling_disabled_for_programstage');\r\n                                                  break;\r\n                                              case $scope.stageNeedsEventErrors.scheduledFound:\r\n                                                  errorMessage = $translate.instant('event_already_scheduled');\r\n                                                  break;                    \r\n                                              case $scope.stageNeedsEventErrors.notRepeatable:\r\n                                                  errorMessage = $translate.instant('programstage_multiple_events_disabled');\r\n                                                  break;\r\n                                              default:\r\n                                                  break;                    \r\n                                              }\r\n                                          }\r\n                                          var headerText = $translate.instant('event_cant_be_created');\r\n                                          var bodyText = errorMessage;\r\n                                          NotificationService.showNotifcationDialog(headerText, bodyText);\r\n\r\n                                      }\r\n                                      else {\r\n                                          $scope.stageErrorInEventLayout[stage.id] = eventCreationAction;\r\n                                      }\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.showCreateEvent = function (stage, eventCreationAction, suggestedStage) {        \r\n                                  \r\n                                  var availableStages = [];\r\n                                  if(!stage){\r\n                                      \r\n                                      //get applicable events\r\n                                      var allApplicableEvents = [];\r\n                                      if(!$scope.allEventsSorted || $scope.allEventsSorted.length === 0){\r\n                                          \r\n                                      }\r\n                                      else if(angular.isUndefined($scope.stagesNotShowingInStageTasks)){\r\n                                          allApplicableEvents = $scope.allEventsSorted.slice();\r\n                                      }\r\n                                      else {\r\n                                          angular.forEach($scope.allEventsSorted, function(event){\r\n                                              if(angular.isUndefined($scope.stagesNotShowingInStageTasks[event.programStage])){\r\n                                                  allApplicableEvents.push(event);\r\n                                              }\r\n                                          }); \r\n                                      }         \r\n                                      \r\n                                      var applicableStages = getApplicableStagesForStageTasks();           \r\n                                      \r\n                                      if(allApplicableEvents.length === 0 && applicableStages.length > 0){                               \r\n                                          availableStages = applicableStages;\r\n                                      }\r\n                                      else{\r\n                                          angular.forEach(applicableStages, function(stage){\r\n                                              if($scope.stageNeedsEvent(stage)){\r\n                                                  availableStages.push(stage);\r\n                                              }\r\n                                          });\r\n                                      }           \r\n                                      if(availableStages.length === 0) {\r\n                                          var headerText = $translate.instant(\"error\");\r\n                                          var bodyText = $translate.instant(\"no_stages_available\");\r\n                                          NotificationService.showNotifcationDialog(headerText, bodyText);\r\n                                          return;\r\n                                      }\r\n                                  }\r\n                                  var autoCreate = stage && stage.displayEventsInTable ? stage.displayEventsInTable : false;\r\n                                  EventCreationService.showModal($scope.eventsByStage, stage, availableStages, $scope.programStages, $scope.selectedEntity, $scope.selectedProgram, $scope.selectedOrgUnit, $scope.selectedEnrollment, autoCreate, eventCreationAction, allApplicableEvents,suggestedStage, $scope.selectedCategories)\r\n                                      .then(function (eventContainer) {\r\n                                          if(angular.isDefined(eventContainer)){                \r\n                                              var ev = eventContainer.ev;\r\n                                              var dummyEvent = eventContainer.dummyEvent;      \r\n\r\n                                              if (angular.isObject(ev) && angular.isObject(dummyEvent)) {\r\n\r\n                                                  var newEvent = ev;\r\n                                                  newEvent.orgUnitName = dummyEvent.orgUnitName;\r\n                                                  newEvent.name = dummyEvent.name;\r\n                                                  newEvent.executionDateLabel = dummyEvent.executionDateLabel;\r\n                                                  newEvent.sortingDate = ev.eventDate ? ev.eventDate : ev.dueDate,\r\n                                                  newEvent.statusColor = EventUtils.getEventStatusColor(ev);\r\n                                                  newEvent.eventDate = DateUtils.formatFromApiToUser(ev.eventDate);\r\n                                                  newEvent.dueDate = DateUtils.formatFromApiToUser(ev.dueDate);\r\n                                                  newEvent.enrollmentStatus = dummyEvent.enrollmentStatus;\r\n\r\n                                                  if (dummyEvent.coordinate) {\r\n                                                      newEvent.coordinate = {};\r\n                                                  }\r\n\r\n\r\n                                                  $scope.addNewEvent(newEvent, true);\r\n                                                  \r\n                                                  $scope.currentEvent = null;\r\n                                                  $scope.showDataEntry(newEvent, true, true);\r\n\r\n                                              }\r\n                                          }\r\n                                      }, function () {\r\n                                      });\r\n                              };\r\n\r\n                              $scope.setCurrentStage = function(stage){\r\n                                  if (!stage) {\r\n                                      return;\r\n                                  }\r\n                                  $scope.currentStage = stage;\r\n                                  $scope.currentEvent = null;\r\n                                  $scope.eventGridColumns = EventUtils.getGridColumns($scope.currentStage, $scope.prStDes);\r\n                                  if( $scope.eventsByStage[stage.id].length === 1 ){\r\n                                      $scope.currentEvent = $scope.eventsByStage[stage.id][0];\r\n                                  }\r\n                                  \r\n                                  $scope.showAttributeCategoryOptions = false;\r\n                              };\r\n\r\n                              $scope.showDataEntry = function (event, suppressToggling, resetStage) {\r\n                                  if (event) {\r\n                                      if ($scope.currentEvent && !suppressToggling && $scope.currentEvent.event === event.event &&\r\n                                          $scope.currentStage.programStageDataElements.length > 5) {\r\n                                          //clicked on the same stage, do toggling\r\n                                          $scope.deSelectCurrentEvent(resetStage);\r\n                                      }\r\n                                      else {\r\n                                          $scope.currentElement = {};                \r\n                                          $scope.currentEvent = event;\r\n                                          \r\n                                          var index = -1;\r\n                                          for (var i = 0; i < $scope.eventsByStage[event.programStage].length && index === -1; i++) {\r\n                                              if ($scope.eventsByStage[event.programStage][i].event === event.event) {\r\n                                                  index = i;\r\n                                              }\r\n                                          }                \r\n                                          if(index !== -1){\r\n                                              $scope.currentEvent = $scope.eventsByStage[event.programStage][index];                    \r\n                                          }\r\n                                          \r\n                                          $scope.showDataEntryDiv = true;\r\n                                          $scope.showEventCreationDiv = false;\r\n\r\n                                          if ($scope.currentEvent.notes) {\r\n                                              angular.forEach($scope.currentEvent.notes, function (note) {\r\n                                                  note.displayDate = DateUtils.formatFromApiToUser(note.storedDate);\r\n                                                  note.storedDate = DateUtils.formatToHrsMins(note.storedDate);\r\n                                              });\r\n\r\n                                              if ($scope.currentEvent.notes.length > 0) {\r\n                                                  $scope.currentEvent.notes = orderByFilter($scope.currentEvent.notes, '-storedDate');\r\n                                              }\r\n                                          }\r\n                                          \r\n                                          $scope.getDataEntryForm();\r\n                                      }\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.deSelectCurrentEvent = function(resetStage){\r\n                                  if( resetStage ){\r\n                                      $scope.currentStage = null;\r\n                                  }\r\n                                  $scope.currentEvent = null;\r\n                                  $scope.currentElement = {id: '', saved: false};\r\n                                  $scope.showDataEntryDiv = !$scope.showDataEntryDiv;\r\n                              };\r\n                              \r\n                              $scope.tableRowIsEditable = function(eventRow){\r\n                                  if( eventRow === $scope.currentEvent &&\r\n                                      eventRow.status !== $scope.EVENTSTATUSCOMPLETELABEL &&\r\n                                      eventRow.status !== $scope.EVENTSTATUSSKIPPEDLABEL &&\r\n                                      $scope.tableEditMode !== $scope.tableEditModes.form){\r\n                                      \r\n                                      return true;\r\n                                  }\r\n                                  return false;\r\n                              };\r\n                              \r\n                              $scope.tableRowStatusButtonsEnabled = function(event){\r\n                                  return event.orgUnit === $scope.selectedOrgUnit.id && $scope.selectedEntity.inactive === false && $scope.selectedEnrollment.status === 'ACTIVE';\r\n                              };\r\n                              \r\n                              $scope.tableEditModes = { form: 0, table: 1, tableAndForm: 2 };\r\n                              $scope.tableEditMode = $scope.tableEditModes.table;\r\n                              \r\n                              $scope.toggleTableEditMode = function(){        \r\n                                  $scope.tableEditMode = $scope.tableEditMode === $scope.tableEditModes.tableAndForm ? $scope.tableEditModes.form : $scope.tableEditModes.tableAndForm;\r\n                              };\r\n                              \r\n                              $scope.eventRowChanged = false;\r\n                              $scope.eventRowClicked = function(event){        \r\n                                  \r\n                                  if($scope.currentEvent !== event){\r\n                                      $scope.eventRowChanged = true;\r\n                                      $scope.switchToEventRow(event);\r\n                                  }\r\n                                  else {\r\n                                      $scope.eventRowChanged = false;\r\n                                  }        \r\n                                  \r\n                                  if($scope.tableEditMode === $scope.tableEditModes.form){\r\n                                      $scope.openEventEditFormModal(event);\r\n                                  }\r\n                                  \r\n                              };\r\n                              \r\n                              $scope.eventRowDblClicked = function(event){\r\n                                  \r\n                                  if($scope.currentEvent === event &&\r\n                                     $scope.tableEditMode === $scope.tableEditModes.tableAndForm &&\r\n                                     $scope.eventRowChanged === false){           \r\n                                      $scope.openEventEditFormModal(event);\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.openEventEditFormModal = function(event){\r\n\r\n                                  var stage = $scope.stagesById[event.programStage];        \r\n                                  if( stage && stage.id ){\r\n                                      event.editingNotAllowed = EventUtils.getEditingStatus(event, stage, $scope.selectedOrgUnit, $scope.selectedTei, $scope.selectedEnrollment);\r\n                                  }        \r\n                                  \r\n                                  $scope.eventEditFormModalInstance = modalInstance = $modal.open({\r\n                                      templateUrl: 'components/dataentry/modal-default-form.html',\r\n                                      scope: $scope           \r\n                                  });\r\n\r\n                                  $scope.eventEditFormModalInstance.result.then(function (status) {                        \r\n                                      //completed, deleted or skipped\r\n                                      $scope.currentEvent = {};            \r\n                                  }, function(){\r\n                                      //closed            \r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.switchToEventRowDeselected = function(event){\r\n                                  if($scope.currentEvent !== event) {\r\n                                      $scope.showDataEntry(event,false, true);\r\n                                  }\r\n                                  $scope.currentEvent = {};\r\n                              };\r\n                              \r\n                              $scope.switchToEventRow = function (event) {\r\n                                  if($scope.currentEvent !== event) {\r\n                                      $scope.reSortStageEvents = false;\r\n                                      $scope.showDataEntry(event,false, true);\r\n                                      $scope.reSortStageEvents = true;\r\n                                  }\r\n                              };\r\n\r\n                              $scope.switchDataEntryForm = function () {\r\n                                  $scope.displayCustomForm = !$scope.displayCustomForm;\r\n                              };\r\n                              \r\n                              $scope.buildOtherValuesLists = function () {\r\n                                  var otherValues = {};\r\n                                  //Only default forms need to build an other values list.\r\n                                  if($scope.displayCustomForm === \"DEFAULT\" || $scope.displayCustomForm === false) {\r\n                                      //Build a list of datavalues OUTSIDE the current event. \r\n                                      angular.forEach($scope.currentStage.programStageDataElements, function(programStageDataElement) {\r\n                                          angular.forEach($scope.programStages, function(stage) {\r\n                                              for(var i = 0; i < $scope.eventsByStage[stage.id].length; i++) {\r\n                                                  //We are not interested in the values from the current stage:\r\n                                                  if($scope.eventsByStage[stage.id][i] !== $scope.currentEvent) {\r\n                                                      var currentId = programStageDataElement.dataElement.id;\r\n                                                      if ( $scope.eventsByStage[stage.id][i][currentId] ) {\r\n                                                          //The current stage has a dataelement of the type in question\r\n\r\n                                                          //Init the list if not already done:\r\n                                                          if(!otherValues[currentId]) {\r\n                                                              otherValues[currentId] = [];\r\n                                                          }\r\n                                                          \r\n                                                          //Decorate and push the alternate value to the list:\r\n                                                          \r\n                                                          var alternateValue = $scope.eventsByStage[stage.id][i][currentId];                                \r\n                                                          alternateValue = CommonUtils.displayBooleanAsYesNo(alternateValue, programStageDataElement.dataElement);\r\n                                                          \r\n\r\n                                                          //Else decorate with the event date:\r\n                                                          alternateValue = $scope.eventsByStage[stage.id][i].eventDate + ': ' + alternateValue;\r\n                                                          otherValues[currentId].push(alternateValue);\r\n                                                      }\r\n                                                  }\r\n                                              }\r\n                                          });\r\n                                      });\r\n                                  }\r\n                                  \r\n                                  return otherValues;\r\n                              };\r\n                              \r\n                              $scope.getDataEntryForm = function () {\r\n                                  $scope.showAttributeCategoryOptions = false;\r\n                                  $scope.currentFileNames = $scope.fileNames ? ($scope.fileNames[$scope.currentEvent.event] ? $scope.fileNames[$scope.currentEvent.event] : []) : [];\r\n                                  $scope.currentStage = $scope.stagesById[$scope.currentEvent.programStage];\r\n                                  $scope.currentStageEvents = $scope.eventsByStage[$scope.currentEvent.programStage];       \r\n\r\n                                  angular.forEach($scope.currentStage.programStageSections, function (section) {\r\n                                      section.open = true;\r\n                                  });\r\n                                  \r\n                                  $scope.setDisplayTypeForStage($scope.currentStage);\r\n                                  \r\n                                  $scope.customDataEntryForm = CustomFormService.getForProgramStage($scope.currentStage, $scope.prStDes);        \r\n                                  \r\n                                  if ($scope.customDataEntryForm) {\r\n                                      $scope.displayCustomForm = \"CUSTOM\";\r\n                                  }\r\n                                  else if ($scope.currentStage.displayEventsInTable) {\r\n                                      if($scope.reSortStageEvents === true){\r\n                                          sortStageEvents($scope.currentStage);            \r\n                                          if($scope.eventsByStage.hasOwnProperty($scope.currentStage.id)){\r\n                                              $scope.currentStageEvents = $scope.eventsByStage[$scope.currentStage.id];\r\n                                          }            \r\n                                      }\r\n                                      $scope.displayCustomForm = \"TABLE\";\r\n                                      \r\n                                  }\r\n                                  else {\r\n                                      $scope.displayCustomForm = \"DEFAULT\";\r\n                                  }\r\n\r\n                                  $scope.currentEvent.editingNotAllowed = EventUtils.getEditingStatus($scope.currentEvent, $scope.currentStage, $scope.selectedOrgUnit, $scope.selectedTei, $scope.selectedEnrollment);\r\n                                  \r\n                                  $scope.currentEventOriginal = angular.copy($scope.currentEvent);\r\n                                  \r\n                                  $scope.currentStageEventsOriginal = angular.copy($scope.currentStageEvents);\r\n                                  \r\n                                  var period = {event: $scope.currentEvent.event, stage: $scope.currentEvent.programStage, name: $scope.currentEvent.sortingDate};\r\n                                  $scope.currentPeriod[$scope.currentEvent.programStage] = period;        \r\n                                  \r\n                                  //Because of separatae dataentry-controllers for tabular and timeline data entry,\r\n                                  //the rule effects might already be in place:\r\n                                  processRuleEffect($scope.currentEvent.event);\r\n                                  \r\n                                  //Execute rules for the first time, to make the initial page appear correctly.\r\n                                  //Subsequent calls will be made from the \"saveDataValue\" function.        \r\n                                  $scope.executeRules();\r\n                              };\r\n\r\n                              $scope.saveDatavalue = function (prStDe, field) {\r\n                                  $scope.saveDataValueForEvent(prStDe, field, $scope.currentEvent, false);\r\n                              };\r\n                              \r\n                              $scope.saveDataValueForRadio = function(prStDe, event, value){\r\n                                  \r\n                                  var def = $q.defer();\r\n                                  \r\n                                  event[prStDe.dataElement.id] = value;\r\n                                  \r\n                                  var saveReturn = $scope.saveDataValueForEvent(prStDe, null, event, false);\r\n                                  if(angular.isDefined(saveReturn)){\r\n                                      if(saveReturn === true){\r\n                                          def.resolve(\"saved\");                \r\n                                      }\r\n                                      else if(saveReturn === false){\r\n                                          def.reject(\"error\");\r\n                                      }\r\n                                      else{\r\n                                          saveReturn.then(function(){\r\n                                              def.resolve(\"saved\");\r\n                                          }, function(){\r\n                                              def.reject(\"error\");\r\n                                          });\r\n                                      }\r\n                                  }\r\n                                  else {\r\n                                      def.resolve(\"notSaved\");\r\n                                  }\r\n\r\n                                  \r\n                                  return def.promise;\r\n                              };\r\n                              \r\n                              $scope.saveDataValueForEvent = function (prStDe, field, eventToSave, backgroundUpdate) {\r\n                                  \r\n                                  if( !prStDe ){\r\n                                      return;\r\n                                  }\r\n                                  \r\n                                  //Do not change the input notification variables for background updates\r\n                                  if(!backgroundUpdate) {\r\n                                      //Blank out the input-saved class on the last saved due date:\r\n                                      $scope.eventDateSaved = false;\r\n\r\n                                      //check for input validity\r\n                                      $scope.updateSuccess = false;\r\n                                  }\r\n                                  \r\n                                  var oldValue = null;\r\n                                  for(var i=0; i<$scope.currentStageEventsOriginal.length; i++){\r\n                                      if($scope.currentStageEventsOriginal[i].event === eventToSave.event) {\r\n                                          oldValue = $scope.currentStageEventsOriginal[i][prStDe.dataElement.id];\r\n                                          break;\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  if (field && field.$invalid) {\r\n                                      $scope.currentEvent[prStDe.dataElement.id] = oldValue;\r\n                                      $scope.currentElement = {id: prStDe.dataElement.id, saved: false, event: eventToSave.event};\r\n                                      return false;\r\n                                  }\r\n\r\n                                  //input is valid\r\n                                  var value = eventToSave[prStDe.dataElement.id];\r\n\r\n                                  if (oldValue !== value) {\r\n                                      \r\n                                      value = CommonUtils.formatDataValue(eventToSave.event, value, prStDe.dataElement, $scope.optionSets, 'API');\r\n                                      \r\n                                      //Do not change the input notification variables for background updates\r\n                                      if(!backgroundUpdate) {\r\n                                          $scope.updateSuccess = false;\r\n                                          $scope.currentElement = {id: prStDe.dataElement.id, event: eventToSave.event, saved: false, failed:false, pending:true};            \r\n                                      }\r\n                                      \r\n                                      var ev = {event: eventToSave.event,\r\n                                                orgUnit: eventToSave.orgUnit,\r\n                                                program: eventToSave.program,\r\n                                                programStage: eventToSave.programStage,\r\n                                                status: eventToSave.status,\r\n                                                trackedEntityInstance: eventToSave.trackedEntityInstance,\r\n                                                dataValues: [\r\n                                                    {\r\n                                                        dataElement: prStDe.dataElement.id,\r\n                                                        value: value,\r\n                                                        providedElsewhere: eventToSave.providedElsewhere[prStDe.dataElement.id] ? true : false\r\n                                                    }\r\n                                                ]\r\n                                               };\r\n                                      return DHIS2EventFactory.updateForSingleValue(ev).then(function (response) {\r\n                                          if(!response) {\r\n                                              if(!backgroundUpdate) {\r\n                                                  $scope.currentElement.saved = false;\r\n                                                  $scope.currentElement.pending = false;\r\n                                                  $scope.currentElement.failed = true;\r\n                                              } else {\r\n                                                  $log.warn(\"Could not perform background update of \" + prStDe.dataElement.id + \" with value \" +\r\n                                                            value);\r\n                                              }\r\n                                              return;\r\n                                          }\r\n\r\n                                          $scope.updateFileNames();\r\n                                          \r\n                                          if(!backgroundUpdate) {\r\n                                              $scope.currentElement.saved = true;\r\n                                              $scope.currentElement.pending = false;\r\n                                              $scope.currentElement.failed = false;                    \r\n                                              $scope.latitudeSaved = false;\r\n                                              $scope.longitudeSaved = false;\r\n                                          }\r\n                                          \r\n                                          $scope.currentEventOriginal = angular.copy($scope.currentEvent);\r\n\r\n                                          $scope.currentStageEventsOriginal = angular.copy($scope.currentStageEvents);\r\n\r\n                                          //In some cases, the rules execution should be suppressed to avoid the \r\n                                          //possibility of infinite loops(rules updating datavalues, that triggers a new \r\n                                          //rule execution)\r\n                                          if(!backgroundUpdate) {\r\n                                              //Run rules on updated data:\r\n                                              $scope.executeRules();\r\n                                          }\r\n\r\n                                      });\r\n\r\n                                  }\r\n                              };\r\n\r\n                              $scope.saveDatavalueLocation = function (prStDe) {\r\n\r\n                                  $scope.updateSuccess = false;\r\n\r\n                                  if (!angular.isUndefined($scope.currentEvent.providedElsewhere[prStDe.dataElement.id])) {\r\n\r\n                                      //currentEvent.providedElsewhere[prStDe.dataElement.id];\r\n                                      var value = $scope.currentEvent[prStDe.dataElement.id];\r\n                                      var ev = {event: $scope.currentEvent.event,\r\n                                                orgUnit: $scope.currentEvent.orgUnit,\r\n                                                program: $scope.currentEvent.program,\r\n                                                programStage: $scope.currentEvent.programStage,\r\n                                                status: $scope.currentEvent.status,\r\n                                                trackedEntityInstance: $scope.currentEvent.trackedEntityInstance,\r\n                                                dataValues: [\r\n                                                    {\r\n                                                        dataElement: prStDe.dataElement.id,\r\n                                                        value: value,\r\n                                                        providedElsewhere: $scope.currentEvent.providedElsewhere[prStDe.dataElement.id] ? true : false\r\n                                                    }\r\n                                                ]\r\n                                               };\r\n                                      DHIS2EventFactory.updateForSingleValue(ev).then(function (response) {\r\n                                          $scope.updateSuccess = true;\r\n                                      });\r\n                                  }\r\n                              };\r\n\r\n                              $scope.saveEventDate = function (reOrder) {        \r\n                                  $scope.saveEventDateForEvent($scope.currentEvent, reOrder);        \r\n                              };\r\n\r\n                              $scope.saveEventDateForEvent = function (eventToSave, reOrder) {\r\n                                  if(!eventToSave.eventDate) {\r\n                                      return;\r\n                                  }\r\n                                  $scope.eventDateSaved = false;\r\n                                  \r\n                                  $scope.currentElement = {id: \"eventDate\", event: eventToSave.event, saved: false};\r\n                                  \r\n                                  var e = {event: eventToSave.event,\r\n                                           enrollment: eventToSave.enrollment,\r\n                                           dueDate: DateUtils.formatFromUserToApi(eventToSave.dueDate),\r\n                                           status: eventToSave.status === 'SCHEDULE' ? 'ACTIVE' : eventToSave.status,\r\n                                           program: eventToSave.program,\r\n                                           programStage: eventToSave.programStage,\r\n                                           orgUnit: eventToSave.dataValues && eventToSave.dataValues.length > 0 ? eventToSave.orgUnit : $scope.selectedOrgUnit.id,\r\n                                           eventDate: DateUtils.formatFromUserToApi(eventToSave.eventDate),\r\n                                           trackedEntityInstance: eventToSave.trackedEntityInstance\r\n                                          };\r\n                                  \r\n                                  DHIS2EventFactory.updateForEventDate(e).then(function (data) {\r\n                                      eventToSave.sortingDate = eventToSave.eventDate;\r\n                                      \r\n                                      $scope.invalidDate = false;\r\n                                      $scope.validatedDateSetForEvent = {date: eventToSave.eventDate, event: eventToSave};\r\n                                      \r\n                                      $scope.eventDateSaved = eventToSave.event;\r\n                                      eventToSave.statusColor = EventUtils.getEventStatusColor(eventToSave); \r\n                                      eventToSave.status = e.status;\r\n                                      \r\n                                      $scope.currentEvent.sortingDate = eventToSave.sortingDate;\r\n                                      $scope.currentEvent.orgUnit = e.orgUnit;\r\n                                      $scope.currentEvent.statusColor = eventToSave.statusColor;\r\n                                      $scope.currentEvent.status = eventToSave.status;\r\n                                      $scope.currentEvent.orgUnitName = $scope.selectedOrgUnit.displayName;\r\n                                      \r\n                                      sortEventsByStage('UPDATE');\r\n                                      \r\n                                      $scope.currentElement = {id: \"eventDate\", event: eventToSave.event, saved: true};\r\n                                      $scope.executeRules();\r\n                                  });\r\n                              };\r\n\r\n                              $scope.saveDueDate = function () {\r\n                                  $scope.dueDateSaved = false;\r\n\r\n                                  var e = {event: $scope.currentEvent.event,\r\n                                           enrollment: $scope.currentEvent.enrollment,\r\n                                           dueDate: DateUtils.formatFromUserToApi($scope.currentEvent.dueDate),\r\n                                           status: $scope.currentEvent.status,\r\n                                           program: $scope.currentEvent.program,\r\n                                           programStage: $scope.currentEvent.programStage,\r\n                                           orgUnit: $scope.selectedOrgUnit.id,\r\n                                           trackedEntityInstance: $scope.currentEvent.trackedEntityInstance\r\n                                          };\r\n\r\n                                  if ($scope.currentStage.periodType) {\r\n                                      e.eventDate = e.dueDate;\r\n                                  }\r\n\r\n                                  if ($scope.currentEvent.coordinate) {\r\n                                      e.coordinate = $scope.currentEvent.coordinate;\r\n                                  }\r\n\r\n                                  DHIS2EventFactory.update(e).then(function (data) {\r\n                                      $scope.invalidDueDate = false;\r\n                                      $scope.dueDateSaved = true;\r\n\r\n                                      if (e.eventDate && !$scope.currentEvent.eventDate && $scope.currentStage.periodType) {\r\n                                          $scope.currentEvent.eventDate = $scope.currentEvent.dueDate;\r\n                                      }\r\n                                      \r\n                                      $scope.currentEvent.sortingDate = $scope.currentEvent.dueDate;\r\n                                      $scope.currentEvent.statusColor = EventUtils.getEventStatusColor($scope.currentEvent);\r\n                                      $scope.currentEvent.status = e.status;\r\n                                      \r\n                                      $scope.schedulingEnabled = !$scope.schedulingEnabled;\r\n                                      sortEventsByStage('UPDATE');\r\n                                  });        \r\n                                  \r\n                              };\r\n\r\n                              $scope.saveCoordinate = function (type) {\r\n                                  \r\n                                  if (type === 'LAT' || type === 'LATLNG') {\r\n                                      $scope.latitudeSaved = false;\r\n                                  }\r\n                                  if (type === 'LNG' || type === 'LATLNG') {\r\n                                      $scope.longitudeSaved = false;\r\n                                  }\r\n\r\n                                  if ($scope.currentEvent.coordinate.latitude === $scope.currentEventOriginal.coordinate.latitude \r\n                                      && $scope.currentEvent.coordinate.longitude === $scope.currentEventOriginal.coordinate.longitude) {//no change\r\n                                      return;\r\n                                  }\r\n\r\n                                  //valid coordinate(s), proceed with the saving\r\n                                  var dhis2Event = $scope.makeDhis2EventToUpdate();\r\n\r\n                                  DHIS2EventFactory.update(dhis2Event).then(function (response) {\r\n                                      if( response ){\r\n                                          $scope.currentEventOriginal = angular.copy($scope.currentEvent);\r\n                                          $scope.currentStageEventsOriginal = angular.copy($scope.currentStageEvents);\r\n                                          \r\n                                          $scope.latitudeSaved = true;\r\n                                          $scope.longitudeSaved = true;\r\n                                      }\r\n                                      else{                \r\n                                          $scope.currentEvent = angular.copy( $scope.currentEventOriginal );\r\n                                          $scope.latitudeSaved = false;\r\n                                          $scope.longitudeSaved = false;\r\n                                      }            \r\n                                      $scope.currentElement = {};            \r\n                                  });\r\n                              };\r\n\r\n                              $scope.addNote = function () {\r\n                                  \r\n                                  if(!$scope.note.value){\r\n                                      var headerText =  $translate.instant(\"error\");\r\n                                      var bodyText =  $translate.instant(\"please_add_some_text\");\r\n                                      NotificationService.showNotifcationDialog(headerText, bodyText);\r\n                                      return;\r\n                                  }\r\n                                  var newNote = {value: $scope.note.value};\r\n                                  \r\n                                  if (angular.isUndefined($scope.currentEvent.notes)) {\r\n                                      $scope.currentEvent.notes = [{value: newNote.value, storedDate: today, displayDate: today, storedBy: storedBy}];\r\n                                  }\r\n                                  else {\r\n                                      $scope.currentEvent.notes.splice(0, 0, {value: newNote.value, storedDate: today, displayDate: today, storedBy: storedBy});\r\n                                  }\r\n\r\n                                  var e = {event: $scope.currentEvent.event,\r\n                                           program: $scope.currentEvent.program,\r\n                                           programStage: $scope.currentEvent.programStage,\r\n                                           orgUnit: $scope.currentEvent.orgUnit,\r\n                                           trackedEntityInstance: $scope.currentEvent.trackedEntityInstance,\r\n                                           notes: [newNote]\r\n                                          };\r\n\r\n                                  DHIS2EventFactory.updateForNote(e).then(function (data) {\r\n                                      $scope.note = {};\r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.notesModal = function(){\r\n                                  \r\n                                  var bodyList = [];\r\n\r\n                                  if($scope.currentEvent.notes) {\r\n                                      for(i = 0; i < $scope.currentEvent.notes.length; i++){\r\n                                          var currentNote = $scope.currentEvent.notes[i];            \r\n                                          bodyList.push({value1: currentNote.storedDate, value2: currentNote.value});\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  var dialogOptions = {\r\n                                      closeButtonText: 'Close',            \r\n                                      textAreaButtonText: 'Add',\r\n                                      textAreaButtonShow: $scope.currentEvent.status === $scope.EVENTSTATUSSKIPPEDLABEL ? false : true,\r\n                                      headerText: 'Notes',\r\n                                      bodyTextAreas: [{model: 'note', placeholder: 'Add another note here', required: true, show: $scope.currentEvent.status === $scope.EVENTSTATUSSKIPPEDLABEL ? false : true}],\r\n                                      bodyList: bodyList,\r\n                                      currentEvent: $scope.currentEvent\r\n                                  };        \r\n                                  \r\n                                  var dialogDefaults = {\r\n                                      \r\n                                      templateUrl: 'views/list-with-textarea-modal.html',\r\n                                      controller: function ($scope, $modalInstance, DHIS2EventFactory, DateUtils) {                    \r\n                                          $scope.modalOptions = dialogOptions;\r\n                                          $scope.formSubmitted = false;\r\n                                          $scope.currentEvent = $scope.modalOptions.currentEvent;\r\n                                          $scope.textAreaValues = [];\r\n                                          \r\n                                          $scope.textAreaButtonClick = function(){                                               \r\n                                              if($scope.textAreaModalForm.$valid){                                \r\n                                                  $scope.note = $scope.textAreaValues[\"note\"];\r\n                                                  $scope.addNote();\r\n                                                  $scope.textAreaModalForm.$setUntouched();\r\n                                                  $scope.formSubmitted = false;                            \r\n                                              }\r\n                                              else {\r\n                                                  $scope.formSubmitted = true;\r\n                                              }\r\n                                          };                   \r\n\r\n                                          \r\n                                          $scope.modalOptions.close = function(){                        \r\n                                              $modalInstance.close($scope.currentEvent);\r\n                                          };\r\n                                          \r\n                                          $scope.addNote = function(){\r\n                                              \r\n                                              newNote = {value: $scope.note};\r\n                                              var date = DateUtils.formatToHrsMins(new Date());\r\n                                              var today = DateUtils.getToday();\r\n\r\n                                              var e = {event: $scope.currentEvent.event,\r\n                                                       program: $scope.currentEvent.program,\r\n                                                       programStage: $scope.currentEvent.programStage,\r\n                                                       orgUnit: $scope.currentEvent.orgUnit,\r\n                                                       trackedEntityInstance: $scope.currentEvent.trackedEntityInstance,\r\n                                                       notes: [newNote]\r\n                                                      };\r\n                                              DHIS2EventFactory.updateForNote(e).then(function (data) {\r\n                                                  if (angular.isUndefined($scope.modalOptions.bodyList) || $scope.modalOptions.bodyList.length === 0) {\r\n                                                      $scope.modalOptions.bodyList = [{value1: date, value2: newNote.value}];\r\n                                                      $scope.modalOptions.currentEvent.notes = [{storedDate: date,displayDate: today, value: newNote.value}];\r\n                                                  }\r\n                                                  else {\r\n                                                      $scope.modalOptions.bodyList.splice(0, 0, {value1: date, value2: newNote.value});\r\n                                                      $scope.modalOptions.currentEvent.notes.splice(0,0,{storedDate: date,displayDate: today, value: newNote.value});\r\n                                                  }\r\n                                                  $scope.note = $scope.textAreaValues[\"note\"] = \"\";\r\n                                              });\r\n                                          };                    \r\n                                      }            \r\n                                  };\r\n                                  \r\n                                  NotificationService.showNotifcationWithOptions(dialogDefaults, dialogOptions).then(function(e){\r\n                                      $scope.currentEvent.notes = e.notes;\r\n                                  });\r\n                                  \r\n                              };\r\n\r\n                              $scope.clearNote = function () {\r\n                                  $scope.note = {};\r\n                              };\r\n\r\n                              $scope.getInputDueDateClass = function (event) {\r\n                                  if (event.event === $scope.eventDateSaved) {\r\n                                      return 'input-success';\r\n                                  }\r\n                                  else {\r\n                                      return '';\r\n                                  }\r\n\r\n                              };\r\n\r\n                              $scope.getInputNotifcationClass = function(id, custom, event){\r\n                                  if(!event) {\r\n                                      event = $scope.currentEvent;\r\n                                  }\r\n                                  if($scope.currentElement.id && $scope.currentElement.id === id && $scope.currentElement.event && $scope.currentElement.event === event.event){\r\n                                      if($scope.currentElement.pending){\r\n                                          if(custom){\r\n                                              return 'input-pending';\r\n                                          }\r\n                                          return 'form-control input-pending';\r\n                                      }\r\n                                      \r\n                                      if($scope.currentElement.saved){\r\n                                          if(custom){\r\n                                              return 'input-success';\r\n                                          }\r\n                                          return 'form-control input-success';\r\n                                      }            \r\n                                      else{\r\n                                          if(custom){\r\n                                              return 'input-error';\r\n                                          }\r\n                                          return 'form-control input-error';\r\n                                      }            \r\n                                  }  \r\n                                  if(custom){\r\n                                      return '';\r\n                                  }\r\n                                  return 'form-control';\r\n                              };\r\n\r\n                              var completeEnrollmentAllowed = function(ignoreEventId){\r\n                                  for(var i = 0; i < $scope.programStages.length; i++ ) {\r\n                                      for(var e = 0; e < $scope.eventsByStage[$scope.programStages[i].id].length; e++) {\r\n                                          if($scope.eventsByStage[$scope.programStages[i].id][e].status ==='ACTIVE' && $scope.eventsByStage[$scope.programStages[i].id][e].event !== ignoreEventId){\r\n                                              return false;\r\n                                          }\r\n                                      }\r\n                                  }\r\n                                  return true;\r\n                              };\r\n                              \r\n                              \r\n                              var completeEnrollment = function () {\r\n                                  $scope.deleteScheduleAndOverdueEvents().then(function(result){\r\n                                      \r\n                                      var en = angular.copy( $scope.selectedEnrollment );\r\n                                      en.status = 'COMPLETED';\r\n                                      EnrollmentService.update(en).then(function (data) {\r\n                                          if( data && data.status === 'OK' ){\r\n                                              $scope.selectedEnrollment.status = 'COMPLETED';\r\n                                              selection.load();\r\n                                              $location.path('/').search({program: $scope.selectedProgramId});\r\n                                          }                \r\n                                      });\r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.makeDhis2EventToUpdate = function(){\r\n                                  var dhis2Event = EventUtils.reconstruct($scope.currentEvent, $scope.currentStage, $scope.optionSets);\r\n                                  var dhis2EventToUpdate = angular.copy(dhis2Event);\r\n                                  dhis2EventToUpdate.dataValues = [];\r\n                                  \r\n                                  if(dhis2Event.dataValues){\r\n                                      angular.forEach(dhis2Event.dataValues, function(dataValue){\r\n                                          if(dataValue.value && dataValue.value.selections){\r\n                                              angular.forEach(dataValue.value.selections, function(selection){\r\n                                                  var dv = {\r\n                                                      dataElement: selection.id,\r\n                                                      value: true,\r\n                                                      providedElsewhere: false\r\n                                                  };\r\n                                                  dhis2EventToUpdate.dataValues.push(dv);\r\n                                              });\r\n                                          }else{\r\n                                              dhis2EventToUpdate.dataValues.push(dataValue);\r\n                                          }\r\n                                      });\r\n                                  };\r\n                                  return dhis2EventToUpdate;\r\n                              };\r\n                              \r\n                              $scope.completeIncompleteEvent = function (inTableView, outerDataEntryForm) {\r\n                                  \r\n                                  if($scope.currentEvent.status !== 'COMPLETED'){\r\n                                      $scope.outerDataEntryForm.submitted = true;\r\n                                      if($scope.outerDataEntryForm.$invalid){\r\n                                          NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"form_invalid\"));\r\n                                          return;\r\n                                      }\r\n                                  }\r\n\r\n                                  var modalOptions;\r\n                                  \r\n                                  var modalDefaults = {};\r\n                                  var dhis2Event = $scope.makeDhis2EventToUpdate();        \r\n                                  \r\n                                  if ($scope.currentEvent.status === 'COMPLETED') {//activiate event\r\n                                      modalOptions = {\r\n                                          closeButtonText: 'cancel',\r\n                                          headerText: 'edit',\r\n                                          bodyText: 'are_you_sure_to_incomplete_event'\r\n                                      };\r\n                                      dhis2Event.status = 'ACTIVE';\r\n                                  }\r\n                                  else {//complete event    \r\n                                      //We must execute the rules right before deciding wheter to allow completion:\r\n                                      $scope.executeRules();\r\n                                      \r\n                                      if(angular.isUndefined(inTableView) || inTableView === false || inTableView === null){\r\n                                          \r\n                                          if(!outerDataEntryForm){\r\n                                              outerDataEntryForm = $scope.outerDataEntryForm;\r\n                                          }\r\n                                          outerDataEntryForm.$setSubmitted();\r\n                                          if(outerDataEntryForm.$invalid){\r\n                                              var dialogOptions = {\r\n                                                  headerText: 'errors',\r\n                                                  bodyText: 'form_invalid',\r\n                                                  sections: sections\r\n                                              };\r\n                                              NotificationService.showNotifcationWithOptions({}, dialogOptions);                    \r\n                                              return;\r\n                                          }\r\n                                      }\r\n                                      \r\n                                      //Warnings might be put into both dialogs with errors and dialogs without errors.\r\n                                      //preparing a warnings section in case it is needed by one of the other dialogs.\r\n                                      var warningSection = false;\r\n                                      if(angular.isDefined($scope.warningMessages[$scope.currentEvent.event]) && $scope.warningMessages[$scope.currentEvent.event].length > 0) {\r\n                                          warningSection = {\r\n                                              bodyText:'validation_warnings',\r\n                                              bodyList:$scope.warningMessages[$scope.currentEvent.event],\r\n                                              itemType:'warning'\r\n                                          };\r\n                                      }\r\n                                      \r\n                                      if(angular.isDefined($scope.errorMessages[$scope.currentEvent.event]) && $scope.errorMessages[$scope.currentEvent.event].length > 0) {\r\n                                          //There is unresolved program rule errors - show error message.\r\n                                          var sections = [\r\n                                              {\r\n                                                  bodyList:$scope.errorMessages[$scope.currentEvent.event],\r\n                                                  itemType:'danger'\r\n                                              }\r\n                                          ];\r\n                                          \r\n                                          if(warningSection) {\r\n                                              sections.push(warningSection);\r\n                                          }\r\n                                          \r\n                                          var dialogOptions = {\r\n                                              headerText: 'errors',\r\n                                              bodyText: 'please_fix_errors_before_completing',\r\n                                              sections: sections\r\n                                          };                \r\n                                          \r\n                                          NotificationService.showNotifcationWithOptions({}, dialogOptions);\r\n                                          return;\r\n                                      }\r\n                                      else\r\n                                      {\r\n                                          modalOptions = {\r\n                                              closeButtonText: 'cancel',\r\n                                              headerText: 'complete',\r\n                                              bodyText: 'are_you_sure_to_complete_event'\r\n                                          };\r\n                                          \r\n                                          if(warningSection) {\r\n                                              modalOptions.sections = [warningSection];\r\n                                          }\r\n                                          \r\n                                          modalOptions.actionButtons =[{ text: 'complete', action: modalCompleteIncompleteActions.complete, class: 'btn btn-primary'}];\r\n\r\n                                          modalOptions.actionButtons.push({text: 'complete_and_exit', action: modalCompleteIncompleteActions.completeAndExit, class: 'btn btn-primary'});                \r\n                                          \r\n                                          if($scope.currentStage.remindCompleted){\r\n                                              modalOptions.bodyText = 'are_you_sure_to_complete_event_and_enrollment';                    \r\n                                              modalOptions.actionButtons.push({text: 'complete_event_and_enrollment', action: modalCompleteIncompleteActions.completeEnrollment, class: 'btn btn-primary'});\r\n                                          }\r\n                                          \r\n                                          modalDefaults.templateUrl = 'components/dataentry/modal-complete-event.html';\r\n                                          dhis2Event.status = 'COMPLETED';\r\n                                          dhis2Event.completedDate = today;\r\n                                      }\r\n                                  }\r\n                                  ModalService.showModal(modalDefaults, modalOptions).then(function (modalResult) {\r\n                                      if(modalResult===modalCompleteIncompleteActions.completeEnrollment){\r\n                                          if(!completeEnrollmentAllowed(dhis2Event.event)){\r\n                                              modalOptions = {\r\n                                                  actionButtonText: 'OK',\r\n                                                  headerText: 'complete_enrollment_failed',\r\n                                                  bodyText: 'complete_active_events_before_completing_enrollment'\r\n                                              };\r\n                                              ModalService.showModal({},modalOptions);\r\n                                          }else{\r\n                                              modalOptions = {\r\n                                                  closeButtonText: 'cancel',\r\n                                                  actionButtonText: 'complete',\r\n                                                  headerText: 'complete_enrollment',\r\n                                                  bodyText: 'are_you_sure_to_complete_enrollment_delete_schedule'\r\n                                              };\r\n                                              ModalService.showModal({},modalOptions).then(function(){\r\n                                                  $scope.executeCompleteIncompleteEvent(dhis2Event,modalResult);\r\n                                              });\r\n                                          }\r\n                                      }else{\r\n                                          $scope.executeCompleteIncompleteEvent(dhis2Event,modalResult);               \r\n                                      }\r\n                                  });           \r\n                              };\r\n                              \r\n                              $scope.executeCompleteIncompleteEvent = function(dhis2Event, modalResult){\r\n                                  var modalOptions = {};\r\n                                  if(eventLockEnabled && eventIsLocked(dhis2Event)){\r\n                                      modalOptions = {\r\n                                          actionButtonText: 'OK',\r\n                                          headerText: 'Event locked',\r\n                                          bodyText: 'event is locked. Contact system administrator to reopen'\r\n                                      };\r\n                                      return ModalService.showModal({},modalOptions);\r\n                                  }\r\n                                  \r\n                                  return DHIS2EventFactory.update(dhis2Event).then(function (data) {\r\n\r\n                                      if(modalResult === modalCompleteIncompleteActions.completeAndExit){\r\n                                          selection.load();\r\n                                          $location.path('/').search({program: $scope.selectedProgramId}); \r\n                                      }else{\r\n                                          if ($scope.currentEvent.status === 'COMPLETED') {//activiate event                    \r\n                                              $scope.currentEvent.status = 'ACTIVE';\r\n                                          }\r\n                                          else {//complete event                    \r\n                                              $scope.currentEvent.status = 'COMPLETED';\r\n\r\n                                          }\r\n\r\n                                          setStatusColor();\r\n                                          $scope.currentEvent.editingNotAllowed = EventUtils.getEditingStatus($scope.currentEvent, $scope.currentStage, $scope.selectedOrgUnit, $scope.selectedTei, $scope.selectedEnrollment);\r\n                                          \r\n                                          for(var i=0;i<$scope.allEventsSorted.length;i++){\r\n                                              if($scope.allEventsSorted[i].event === $scope.currentEvent.event){\r\n                                                  $scope.allEventsSorted[i] = $scope.currentEvent;\r\n                                                  i=$scope.allEventsSorted.length;\r\n                                              }\r\n                                          }\r\n                                          \r\n                                          if ($scope.currentEvent.status === 'COMPLETED') {\r\n                                              //send alerts\r\n                                              sendAlerts();\r\n                                              if (modalResult === modalCompleteIncompleteActions.completeEnrollment) {\r\n                                                  completeEnrollment();\r\n                                              }\r\n                                              else {\r\n                                                  if ($scope.currentStage.allowGenerateNextVisit) {\r\n                                                      if($scope.currentStage.repeatable){\r\n                                                          $scope.showCreateEvent($scope.currentStage, $scope.eventCreationActions.schedule);\r\n                                                      }\r\n                                                      else{\r\n                                                          var index = -1, stage = null;\r\n                                                          for(var i=0; i<$scope.programStages.length && index===-1; i++){\r\n                                                              if($scope.currentStage.id === $scope.programStages[i].id){\r\n                                                                  index = i;\r\n                                                                  stage = $scope.programStages[i+1];\r\n                                                              }\r\n                                                          }\r\n                                                          if(stage ){\r\n                                                              if(!$scope.eventsByStage[stage.id] || $scope.eventsByStage[stage.id] && $scope.eventsByStage[stage.id].length === 0){\r\n                                                                  $scope.showCreateEvent(stage, $scope.eventCreationActions.schedule);\r\n                                                              }\r\n                                                          }                                \r\n                                                      }\r\n                                                  }\r\n                                              }\r\n                                          }\r\n                                      }\r\n                                      broadcastDataEntryControllerData();\r\n                                  });\r\n                              };\r\n\r\n                              function sendAlerts(){\r\n\r\n                                  var data = {\r\n                                      event : $scope.currentEvent.event,\r\n                                      orgUnit :  $scope.currentEvent.orgUnit\r\n                                  }\r\n                                  $http.post(\"http://139.162.61.147:8001/sendSMS\",data).then(function(response){\r\n\r\n                                  })\r\n\r\n                              }\r\n\r\n                              function eventIsLocked(){\r\n                                  if($scope.currentEvent.status === 'COMPLETED'){\r\n                                      var now = moment();\r\n                                      var completedDate = moment($scope.currentEvent.completedDate);\r\n                                      if(now.diff(completedDate, 'hours') > eventLockHours){\r\n                                          return true;\r\n                                      }\r\n                                  }\r\n                                  return false;\r\n                              }\r\n                              \r\n                              $scope.skipUnskipEvent = function () {\r\n                                  var modalOptions;\r\n                                  var dhis2Event = $scope.makeDhis2EventToUpdate();\r\n\r\n                                  if ($scope.currentEvent.status === 'SKIPPED') {//unskip event\r\n                                      modalOptions = {\r\n                                          closeButtonText: 'cancel',\r\n                                          actionButtonText: 'unskip',\r\n                                          headerText: 'unskip',\r\n                                          bodyText: 'are_you_sure_to_unskip_event'\r\n                                      };\r\n                                      dhis2Event.status = 'ACTIVE';\r\n                                  }\r\n                                  else {//skip event\r\n                                      modalOptions = {\r\n                                          closeButtonText: 'cancel',\r\n                                          actionButtonText: 'skip',\r\n                                          headerText: 'skip',\r\n                                          bodyText: 'are_you_sure_to_skip_event'\r\n                                      };\r\n                                      dhis2Event.status = 'SKIPPED';\r\n                                  }\r\n\r\n                                  ModalService.showModal({}, modalOptions).then(function (result) {\r\n                                      \r\n                                      $scope.executeSkipUnskipEvent(dhis2Event);\r\n                                      \r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.executeSkipUnskipEvent = function(dhis2Event){\r\n                                  \r\n                                  return DHIS2EventFactory.update(dhis2Event).then(function (data) {\r\n\r\n                                      if ($scope.currentEvent.status === 'SKIPPED') {//activiate event                    \r\n                                          $scope.currentEvent.status = 'SCHEDULE';\r\n                                      }\r\n                                      else {//complete event                    \r\n                                          $scope.currentEvent.status = 'SKIPPED';\r\n                                      }\r\n\r\n                                      setStatusColor();                \r\n                                      $scope.currentEvent.editingNotAllowed = EventUtils.getEditingStatus($scope.currentEvent, $scope.currentStage, $scope.selectedOrgUnit, $scope.selectedTei, $scope.selectedEnrollment);\r\n                                  });\r\n                                  \r\n                              };\r\n                              \r\n\r\n                              var setStatusColor = function () {\r\n                                  var statusColor = EventUtils.getEventStatusColor($scope.currentEvent);\r\n                                  var continueLoop = true;\r\n                                  for (var i = 0; i < $scope.eventsByStage[$scope.currentEvent.programStage].length && continueLoop; i++) {\r\n                                      if ($scope.eventsByStage[$scope.currentEvent.programStage][i].event === $scope.currentEvent.event) {\r\n                                          $scope.eventsByStage[$scope.currentEvent.programStage][i].statusColor = statusColor;\r\n                                          $scope.currentEvent.statusColor = statusColor;\r\n                                          continueLoop = false;\r\n                                      }\r\n                                  }\r\n                              };\r\n\r\n                              $scope.deleteEvent = function () {\r\n                                  \r\n                                  var modalOptions = {\r\n                                      closeButtonText: 'cancel',\r\n                                      actionButtonText: 'delete',\r\n                                      headerText: 'delete',\r\n                                      bodyText: 'are_you_sure_to_delete_event_with_audit'\r\n                                  };\r\n\r\n                                  ModalService.showModal({}, modalOptions).then(function (result) {\r\n                                      $scope.executeDeleteEvent();\r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.executeDeleteEvent = function(){\r\n                                  \r\n                                  return DHIS2EventFactory.delete($scope.currentEvent).then(function (data) {\r\n\r\n                                      var continueLoop = true, index = -1;\r\n                                      for (var i = 0; i < $scope.eventsByStage[$scope.currentEvent.programStage].length && continueLoop; i++) {\r\n                                          if ($scope.eventsByStage[$scope.currentEvent.programStage][i].event === $scope.currentEvent.event) {\r\n                                              $scope.eventsByStage[$scope.currentEvent.programStage][i] = $scope.currentEvent;\r\n                                              continueLoop = false;\r\n                                              index = i;\r\n                                          }\r\n                                      }\r\n                                      \r\n                                      var programStageID = $scope.currentEvent.programStage;\r\n\r\n                                      $scope.eventsByStage[programStageID].splice(index, 1);\r\n                                      $scope.currentStageEvents = $scope.eventsByStage[programStageID];\r\n                                      \r\n                                      //if event is last event in allEventsSorted and only element on page, show previous page\r\n                                      var GetPreviousEventPage = false;\r\n                                      if($scope.allEventsSorted[$scope.allEventsSorted.length-1].event === $scope.currentEvent.event){\r\n                                          var index = $scope.allEventsSorted.length - 1;\r\n                                          if(index !== 0){\r\n                                              if(index % $scope.eventPageSize === 0){                            \r\n                                                  GetPreviousEventPage = true;\r\n                                              }\r\n                                          }\r\n                                      }                \r\n                                      sortEventsByStage('REMOVE');                                          \r\n                                      if(GetPreviousEventPage){\r\n                                          $scope.getEventPage(\"BACKWARD\");\r\n                                      }                \r\n                                      \r\n                                      if($scope.displayCustomForm === \"TABLE\"){\r\n                                          $scope.currentEvent = {};                \r\n                                      }\r\n                                      else if($scope.displayCustomForm === \"COMPARE\"){\r\n                                          $scope.openStagesEvent([$scope.currentStage.id], function(){\r\n                                              $scope.openEmptyStage($scope.currentStage.id);\r\n                                          }); \r\n                                      }\r\n                                      else {\r\n                                          $scope.deSelectCurrentEvent();                    \r\n                                      }\r\n                                      \r\n                                      broadcastDataEntryControllerData();\r\n                                      \r\n                                  }, function(error){   \r\n                                      \r\n                                      //temporarily error message because of new audit functionality\r\n                                      NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"delete_error_audit\"));\r\n                                      return $q.reject(error);\r\n                                  });        \r\n                              };\r\n\r\n                              $scope.getEventStyle = function (ev, skipCurrentEventStyle) {\r\n\r\n                                  var style = EventUtils.getEventStatusColor(ev);\r\n                                  $scope.eventStyleLabels[ev.event] = $scope.getDescriptionTextForEventStyle(style, $scope.descriptionTypes.label, false);\r\n                                  \r\n                                  if ($scope.currentEvent && $scope.currentEvent.event === ev.event && (angular.isUndefined(skipCurrentEventStyle) || skipCurrentEventStyle === false)) {\r\n                                      style = style + '-darker' + ' ' + ' current-event';\r\n                                  }        \r\n                                  \r\n                                  return style;\r\n                              };\r\n                              \r\n                              \r\n\r\n                              $scope.getColumnWidth = function (weight) {\r\n                                  var width = weight <= 1 ? 1 : weight;\r\n                                  width = (width / $scope.totalEvents) * 100;\r\n                                  return \"width: \" + width + '%';\r\n                              };\r\n\r\n                              $scope.sortEventsByDate = function (dhis2Event) {\r\n                                  var d = dhis2Event.sortingDate;\r\n                                  return DateUtils.getDate(d);\r\n                              };\r\n                              \r\n                              var sortStageEvents = function(stage){        \r\n                                  var key = stage.id;\r\n                                  if ($scope.eventsByStage.hasOwnProperty(key)){\r\n                                      var sortedEvents = $filter('orderBy')($scope.eventsByStage[key], function (event) {\r\n                                          if(angular.isDefined(stage.displayEventsInTable) && stage.displayEventsInTable === true){\r\n                                              return DateUtils.getDate(event.eventDate);\r\n                                          }\r\n                                          else{\r\n                                              return DateUtils.getDate(event.sortingDate);\r\n                                          }                    \r\n                                      }, false);\r\n                                      $scope.eventsByStage[key] = sortedEvents;\r\n                                      $scope.eventsByStageDesc[key] = [];\r\n                                      \r\n                                      //Reverse the order of events, but keep the objects within the array.\r\n                                      //angular.copy and reverse did not work - this messed up databinding.\r\n                                      angular.forEach(sortedEvents, function(sortedEvent) {\r\n                                          $scope.eventsByStageDesc[key].splice(0,0,sortedEvent);\r\n                                      });          \r\n                                      \r\n                                      if(angular.isDefined($scope.currentStage) && $scope.currentStage !== null && $scope.currentStage.id === stage.id){\r\n                                          $scope.currentStageEvents = sortedEvents;\r\n                                      }\r\n                                      return sortedEvents;\r\n                                  }        \r\n                              };\r\n\r\n                              var sortEventsByStage = function (operation, newEvent) {\r\n\r\n                                  $scope.eventFilteringRequired = false;\r\n\r\n                                  for (var key in $scope.eventsByStage) {\r\n\r\n                                      var stage = $scope.stagesById[key];            \r\n                                      var sortedEvents = sortStageEvents(stage);           \r\n                                      if ($scope.eventsByStage.hasOwnProperty(key) && stage && $scope.selectedEnrollment && $scope.selectedEnrollment.enrollment ) {\r\n                                          \r\n                                          var periods = PeriodService.getPeriods(sortedEvents, stage, $scope.selectedEnrollment).occupiedPeriods;\r\n\r\n                                          $scope.eventPeriods[key] = periods;\r\n                                          $scope.currentPeriod[key] = periods.length > 0 ? periods[0] : null;\r\n                                          $scope.eventFilteringRequired = $scope.eventFilteringRequired ? $scope.eventFilteringRequired : periods.length > 1;\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  if (operation) {\r\n                                      if (operation === 'ADD' && newEvent && newEvent.event) {\r\n                                          var ev = EventUtils.reconstruct(newEvent, $scope.currentStage, $scope.optionSets);                \r\n                                          ev.enrollment = newEvent.enrollment;\r\n                                          ev.visited = newEvent.visited;\r\n                                          ev.orgUnitName = newEvent.orgUnitName;\r\n                                          ev.name = newEvent.name;\r\n                                          ev.sortingDate =newEvent.sortingDate;\r\n                                          \r\n                                          $scope.allEventsSorted.push(ev);\r\n                                      }\r\n                                      if (operation === 'UPDATE') {\r\n                                          var ev = EventUtils.reconstruct($scope.currentEvent, $scope.currentStage, $scope.optionSets);\r\n                                          ev.enrollment = $scope.currentEvent.enrollment;\r\n                                          ev.visited = $scope.currentEvent.visited;\r\n                                          ev.orgUnitName = $scope.currentEvent.orgUnitName;\r\n                                          ev.name = $scope.currentEvent.name;\r\n                                          ev.sortingDate = $scope.currentEvent.sortingDate;\r\n                                          var index = -1;\r\n                                          for (var i = 0; i < $scope.allEventsSorted.length && index === -1; i++) {\r\n                                              if ($scope.allEventsSorted[i].event === $scope.currentEvent.event) {\r\n                                                  index = i;\r\n                                              }\r\n                                          }\r\n                                          if (index !== -1) {\r\n                                              $scope.allEventsSorted[index] = ev;\r\n                                          }\r\n                                      }\r\n                                      if (operation === 'REMOVE') {\r\n                                          var index = -1;\r\n                                          for (var i = 0; i < $scope.allEventsSorted.length && index === -1; i++) {\r\n                                              if ($scope.allEventsSorted[i].event === $scope.currentEvent.event) {\r\n                                                  index = i;\r\n                                              }\r\n                                          }\r\n                                          if (index !== -1) {\r\n                                              $scope.allEventsSorted.splice(index, 1);\r\n                                          }\r\n                                      }\r\n\r\n                                      $timeout(function () {\r\n                                          $rootScope.$broadcast('tei-report-widget', {});\r\n                                      }, 200);\r\n                                  }        \r\n                                  $scope.allEventsSorted = orderByFilter($scope.allEventsSorted, '-sortingDate').reverse();         \r\n                              };\r\n\r\n                              $scope.showLastEventInStage = function (stageId) {\r\n                                  var ev = $scope.eventsByStage[stageId][$scope.eventsByStage[stageId].length - 1];\r\n                                  $scope.showDataEntryForEvent(ev);\r\n                              };\r\n\r\n                              $scope.showDataEntryForEvent = function (event) {\r\n\r\n                                  var period = {event: event.event, stage: event.programStage, name: event.sortingDate};\r\n                                  $scope.currentPeriod[event.programStage] = period;\r\n\r\n                                  var event = null;\r\n                                  for (var i = 0; i < $scope.eventsByStage[period.stage].length; i++) {\r\n                                      if ($scope.eventsByStage[period.stage][i].event === period.event) {\r\n                                          event = $scope.eventsByStage[period.stage][i];\r\n                                          break;\r\n                                      }\r\n                                  }\r\n\r\n                                  if (event) {\r\n                                      $scope.showDataEntry(event, false, true);\r\n                                  }\r\n                                  \r\n                              };\r\n                              \r\n                              $scope.interacted = function (field, form) {        \r\n                                  \r\n                                  var status = false;\r\n                                  if (field) {\r\n                                      if(angular.isDefined(form)){\r\n                                          status = form.$submitted || field.$dirty;\r\n                                      }\r\n                                      else {\r\n                                          status = $scope.outerDataEntryForm.$submitted || field.$dirty;\r\n                                      }            \r\n                                  }\r\n                                  return status;\r\n                              };\r\n\r\n                              $scope.getEventPage = function(direction){\r\n                                  if(direction === 'FORWARD'){\r\n                                      $scope.eventPagingStart += $scope.eventPageSize;\r\n                                      $scope.eventPagingEnd += $scope.eventPageSize;            \r\n                                  }\r\n                                  \r\n                                  if(direction === 'BACKWARD'){\r\n                                      $scope.eventPagingStart -= $scope.eventPageSize;\r\n                                      $scope.eventPagingEnd -= $scope.eventPageSize;\r\n                                  }\r\n                                  \r\n                                  $scope.showDataEntry($scope.topLineEvents[$scope.eventPagingStart], false, true);\r\n                              };   \r\n                              \r\n                              $scope.getEventPageForEvent = function(event){\r\n                                  if(angular.isDefined(event) && angular.isObject(event) && angular.isDefined($scope.topLineEvents)){\r\n                                      \r\n                                      var index = -1;\r\n                                      for(i = 0; i < $scope.topLineEvents.length; i++){\r\n                                          if(event.event === $scope.topLineEvents[i].event){\r\n                                              index = i;\r\n                                              break;\r\n                                          }\r\n                                      }\r\n\r\n                                      if(index !== -1){\r\n                                          var page = Math.floor(index / $scope.eventPageSize);\r\n                                          $scope.eventPagingStart = page * $scope.eventPageSize;\r\n                                          $scope.eventPagingEnd = $scope.eventPagingStart + $scope.eventPageSize;\r\n                                      }\r\n                                  }        \r\n                              };\r\n\r\n                              $scope.deselectCurrent = function(id){        \r\n                                  \r\n                                  if($scope.currentEvent && $scope.currentEvent.event === id){\r\n                                      $scope.currentEvent = {};            \r\n                                      sortStageEvents($scope.currentStage);\r\n                                      $scope.currentStageEvents = $scope.eventsByStage[$scope.currentStage.id];\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.abortDeselect = function(){\r\n                                  if(!$scope.currentStage.displayEventsInTable){\r\n                                      return true;\r\n                                  }\r\n                                  return false;\r\n                              };\r\n                              \r\n                              $scope.showCompleteErrorMessageInModal = function(message, fieldName, isWarning){\r\n                                  var messages = [message];\r\n                                  var headerPrefix = angular.isDefined(isWarning) && isWarning === true ? \"Warning in \" : \"Error in \";\r\n                                  \r\n                                  var dialogOptions = {\r\n                                      headerText: headerPrefix + fieldName,\r\n                                      bodyText: '',\r\n                                      bodyList: messages\r\n                                  };                \r\n                                  \r\n                                  NotificationService.showNotifcationWithOptions({}, dialogOptions);\r\n                              };\r\n                              \r\n                              //for compare-mode\r\n                              $scope.compareModeColDefs = {header: 1, otherEvent: 2, currentEvent: 3, otherEvents: 4, providedElsewhere: 5};\r\n                              $scope.getCompareModeColSize = function(colId){                \r\n                                  \r\n                                  var otherEventsCnt = $scope.otherStageEvents.length;                \r\n                                  \r\n                                  switch(colId){\r\n                                  case $scope.compareModeColDefs.header:\r\n                                      if(otherEventsCnt > 4){\r\n                                          if($scope.allowProvidedElsewhereExists[$scope.currentStage.id]){\r\n                                              return 'col-xs-1';\r\n                                          }\r\n                                          return 'col-xs-2';\r\n                                      }\r\n                                      else if(otherEventsCnt === 4){\r\n                                          if($scope.allowProvidedElsewhereExists[$scope.currentStage.id]){\r\n                                              return 'col-xs-1';\r\n                                          }\r\n                                          return 'col-xs-2';\r\n                                      }\r\n                                      else if(otherEventsCnt >= 2){\r\n                                          return 'col-xs-3';\r\n                                      }\r\n                                      else if(otherEventsCnt === 1) {\r\n                                          return 'col-xs-4';\r\n                                      }\r\n                                      else {\r\n                                          return 'col-xs-5';\r\n                                      }\r\n                                      break;\r\n                                  case $scope.compareModeColDefs.otherEvent: \r\n                                      if(otherEventsCnt > 4){\r\n                                          return '';\r\n                                      }\r\n                                      else if(otherEventsCnt === 4){\r\n                                          return 'col-xs-3';\r\n                                      }\r\n                                      else if(otherEventsCnt === 3){\r\n                                          return 'col-xs-4';\r\n                                      }\r\n                                      else if(otherEventsCnt === 2){\r\n                                          return 'col-xs-6';\r\n                                      }\r\n                                      else if(otherEventsCnt === 1){\r\n                                          return 'col-xs-12';\r\n                                      }\r\n                                      else{\r\n                                          return '';\r\n                                      }                \r\n                                      break;\r\n                                  case $scope.compareModeColDefs.currentEvent:\r\n                                      if(otherEventsCnt > 4){\r\n                                          return 'col-xs-2';\r\n                                      }\r\n                                      else if(otherEventsCnt === 4){\r\n                                          return 'col-xs-2';\r\n                                      }\r\n                                      else if(otherEventsCnt >= 2){\r\n                                          if($scope.allowProvidedElsewhereExists[$scope.currentStage.id]){\r\n                                              return 'col-xs-2';\r\n                                          }\r\n                                          return 'col-xs-3';\r\n                                      }\r\n                                      else if(otherEventsCnt === 1){\r\n                                          if($scope.allowProvidedElsewhereExists[$scope.currentStage.id]){\r\n                                              return 'col-xs-3';\r\n                                          }\r\n                                          return 'col-xs-4';\r\n                                      }\r\n                                      else{\r\n                                          if($scope.allowProvidedElsewhereExists[$scope.currentStage.id]){\r\n                                              return 'col-xs-6';\r\n                                          }\r\n                                          return 'col-xs-7';\r\n                                      }\r\n                                      break;\r\n                                  case $scope.compareModeColDefs.otherEvents:\r\n                                      if(otherEventsCnt > 4){\r\n                                          return 'col-xs-8';\r\n                                      }\r\n                                      else if(otherEventsCnt === 4){\r\n                                          return 'col-xs-8';\r\n                                      }\r\n                                      else if(otherEventsCnt >= 2){\r\n                                          return 'col-xs-6';\r\n                                      }\r\n                                      else if(otherEventsCnt === 1){\r\n                                          return 'col-xs-4';\r\n                                      }\r\n                                      else {\r\n                                          return '';\r\n                                      }\r\n                                      break;\r\n                                  case $scope.compareModeColDefs.providedElsewhere:\r\n                                      return 'col-xs-1';\r\n                                      break;\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.maxCompareItemsInCompareView = 4;\r\n                              $scope.setOtherStageEvents = function(){\r\n                                  \r\n                                  $scope.otherStageEventIndexes = [];\r\n                                  $scope.otherStageEvents = [];\r\n                                  $scope.stageEventsExcludedSkipped = [];\r\n                                  \r\n                                  if(angular.isUndefined($scope.currentStageEvents) || $scope.currentStageEvents.length <= 1){\r\n                                      return;\r\n                                  }        \r\n                                  else {            \r\n                                      \r\n                                      angular.forEach($scope.currentStageEvents, function(event){\r\n                                          if(event.status !== $scope.EVENTSTATUSSKIPPEDLABEL || event.event === $scope.currentEvent.event){\r\n                                              $scope.stageEventsExcludedSkipped.push(event);\r\n                                          }\r\n                                      });\r\n                                      \r\n                                      \r\n                                      var indexOfCurrent = -1;\r\n                                      for(i = 0; i < $scope.stageEventsExcludedSkipped.length; i++){\r\n                                          var stageEvent = $scope.stageEventsExcludedSkipped[i];\r\n                                          if(stageEvent.event === $scope.currentEvent.event){\r\n                                              indexOfCurrent = i;\r\n                                              break;\r\n                                          }                    \r\n                                      }            \r\n\r\n                                      for(j = 0; j < $scope.maxCompareItemsInCompareView; j++){\r\n                                          var position = indexOfCurrent - 1 - j;\r\n                                          if(position < 0){\r\n                                              break;\r\n                                          }\r\n                                          \r\n                                          var relative = - j - 1;\r\n                                          $scope.otherStageEventIndexes.unshift({relative: relative, position: position});\r\n                                      }\r\n\r\n                                      angular.forEach($scope.otherStageEventIndexes, function(indexContainer){\r\n                                          $scope.otherStageEvents.push($scope.stageEventsExcludedSkipped[indexContainer.position]);\r\n                                      });                        \r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.navigateOtherStageEvents = function(direction){\r\n                                  \r\n                                  angular.forEach($scope.otherStageEventIndexes, function(indexContainer){\r\n                                      var change;\r\n                                      if(direction < 0){\r\n                                          change = -1;\r\n                                          if(indexContainer.relative - 1 === 0){\r\n                                              change = -2;\r\n                                          }                \r\n                                      }\r\n                                      else{\r\n                                          change = 1;\r\n                                          if(indexContainer.relative + 1 === 0){\r\n                                              change = 2;\r\n                                          }                \r\n                                      }\r\n                                      \r\n                                      indexContainer.relative += change;\r\n                                      indexContainer.position += change;\r\n                                  });\r\n                                  \r\n                                  $scope.otherStageEvents = [];\r\n                                  angular.forEach($scope.otherStageEventIndexes, function(indexContainer){\r\n                                      $scope.otherStageEvents.push($scope.stageEventsExcludedSkipped[indexContainer.position]);\r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.readyCompareDisplayForm = function(){    \r\n                                  \r\n                                  $scope.setOtherStageEvents();\r\n\r\n                                  if($scope.displayCustomForm !== \"COMPARE\"){\r\n                                      $scope.displayCustomForm = \"COMPARE\";\r\n                                  }                 \r\n                              };\r\n                              \r\n                              $scope.$watch(\"displayCustomForm\", function(newValue, oldValue){        \r\n                                  if(newValue === \"COMPARE\"){\r\n                                      $scope.readyCompareDisplayForm();\r\n                                  }\r\n                              });\r\n                              \r\n                              $scope.buttonType = {back: 1, forward: 2};\r\n                              $scope.showOtherEventsNavigationButtonInCompareForm = function(type){        \r\n                                  if(type === $scope.buttonType.back){\r\n                                      if($scope.otherStageEventIndexes.length > 0){\r\n                                          var firstEventPosition = $scope.otherStageEventIndexes[0].position;\r\n                                          if(firstEventPosition > 0){\r\n                                              return true;\r\n                                          }\r\n                                      }\r\n                                      return false;\r\n                                  }\r\n                                  else{\r\n                                      if($scope.otherStageEventIndexes.length > 0){\r\n                                          var lastEventRelativePosition = $scope.otherStageEventIndexes[$scope.otherStageEventIndexes.length - 1].relative;\r\n                                          if(lastEventRelativePosition < -1){\r\n                                              return true;\r\n                                          }\r\n                                      }\r\n                                      return false;\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.currentStageEventNumber = function(){\r\n                                  for(i = 0; i < $scope.stageEventsExcludedSkipped.length; i++){\r\n                                      if($scope.currentEvent.event === $scope.stageEventsExcludedSkipped[i].event){\r\n                                          return i+1;\r\n                                      }\r\n                                  }\r\n                                  return;\r\n                              };\r\n                              \r\n                              $scope.getStageStyle = function(stage){\r\n                                  \r\n                                  var eventToFetch = $scope.getEventForStage(stage);\r\n                                  \r\n                                  if(eventToFetch >= 0){\r\n                                      var stageStyle = $scope.getEventStyle($scope.eventsByStage[stage.id][eventToFetch]);\r\n                                      if($scope.currentStage && $scope.currentStage.id === stage.id){\r\n                                          stageStyle += \" current-stage\";\r\n                                      }\r\n                                      return stageStyle;\r\n                                  }\r\n                                  else {\r\n                                      return '';\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.getMainMenuItemStyle = function(stage){\r\n                                  \r\n                                  if($scope.eventsLoaded){                \r\n                                      $scope.stageStyleLabels[stage.id] = \"\";\r\n                                      var stages = [stage.id];\r\n                                      \r\n                                      if(angular.isDefined($scope.headerCombineStages)){\r\n                                          for(var key in $scope.headerCombineStages){\r\n                                              if(key === stage.id){\r\n                                                  stages.push($scope.headerCombineStages[key]);\r\n                                              }\r\n                                              else if($scope.headerCombineStages[key] === stage.id){\r\n                                                  stages.push(key);\r\n                                              }\r\n                                          }\r\n                                      }\r\n\r\n                                      var event = $scope.getEventForStages(stages);\r\n\r\n                                      if(angular.isDefined(event)){\r\n                                          var style = $scope.getEventStyle(event, true);\r\n                                          $scope.stageStyleLabels[stage.id] = $scope.getDescriptionTextForEventStyle(style, $scope.descriptionTypes.label, true);\r\n                                          return style;\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  return '';                      \r\n                              };\r\n                              \r\n                              $scope.descriptionTypes = {full: 1, label: 2};\r\n                              $scope.getDescriptionTextForEventStyle = function(style, descriptionType, useInStage){\r\n                                  \r\n                                  if(angular.isDefined(style) && style !== \"\"){\r\n                                      var eventStyles = $filter('filter')($scope.eventStyles, {color: style},true);\r\n                                      if(angular.isDefined(eventStyles) && eventStyles.length === 1){            \r\n                                          return $scope.getDescriptionTextForDescription(eventStyles[0].description, descriptionType, useInStage);\r\n                                      }\r\n                                  }        \r\n                                  return \"\";\r\n                              };\r\n                              \r\n                              $scope.getDescriptionTextForDescription = function(description, descriptionType, useInStage){\r\n                                  \r\n                                  var translateText = \"\";\r\n                                  \r\n                                  if(useInStage){\r\n                                      translateText = \"stage_\";\r\n                                  }\r\n                                  translateText += description;\r\n\r\n                                  if(descriptionType === $scope.descriptionTypes.label){\r\n                                      translateText += \"_label\";                \r\n                                  }            \r\n                                  return $translate.instant(translateText);        \r\n                              };\r\n                              \r\n                              $scope.getStageStyleLabel = function(stage){\r\n                                  if($scope.stageStyleLabels[stage.id]){\r\n                                      return \"(\" + $scope.stageStyleLabels[stage.id] + \")\";\r\n                                  }\r\n                                  return \"(\" + $translate.instant(\"stage_empty_label\") + \")\";\r\n                              };\r\n                              \r\n                              $scope.getEventStyleLabel = function(event){\r\n                                  if($scope.eventStyleLabels[event.event]){\r\n                                      return \"(\" + $scope.eventStyleLabels[event.event] + \")\";\r\n                                  }\r\n                                  return '';\r\n                              };\r\n                              \r\n                              $scope.getEventForStage = function(stage){\r\n                                  //get first incomplete not skipped. If none, get latest nok skipped         \r\n                                  var lastComplete = -1;\r\n                                  var firstOpen = -1;  \r\n                                  \r\n                                  if(angular.isDefined($scope.eventsByStage[stage.id]) && $scope.eventsByStage[stage.id].length > 0){\r\n                                      var stageEvents = $scope.eventsByStage[stage.id];\r\n                                      for(i = 0; i < stageEvents.length; i++){\r\n                                          var itiratedEvent = stageEvents[i];\r\n                                          if(itiratedEvent.status !== $scope.EVENTSTATUSSKIPPEDLABEL && itiratedEvent.status !== $scope.EVENTSTATUSCOMPLETELABEL){\r\n                                              firstOpen = i;\r\n                                              break;\r\n                                          }\r\n                                          else if(itiratedEvent.status === $scope.EVENTSTATUSCOMPLETELABEL){\r\n                                              lastComplete = i;\r\n                                          }\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  var eventToFetch = -1;\r\n                                  if(firstOpen >= 0){\r\n                                      eventToFetch = firstOpen;\r\n                                  }\r\n                                  else if(lastComplete >= 0){\r\n                                      eventToFetch = lastComplete;\r\n                                  }\r\n                                  return eventToFetch;\r\n                              };\r\n                              \r\n                              $scope.getEventForStages = function(stagesInputArray){\r\n                                  var stages = [];\r\n                                  if(angular.isString(stagesInputArray[0])){\r\n                                      //getstages\r\n                                      angular.forEach(stagesInputArray, function(stageString){\r\n                                          stages.push($scope.stagesById[stageString]);\r\n                                      });\r\n                                  }\r\n                                  else{\r\n                                      stages = stagesInputArray;\r\n                                  }\r\n                                  \r\n                                  stages.sort(function(a,b){\r\n                                      return a.sortOrder - b.sortOrder;\r\n                                  });\r\n                                  \r\n                                  var eventsForStages = [];\r\n                                  angular.forEach(stages, function(stage){\r\n                                      eventsForStages = eventsForStages.concat($scope.eventsByStage[stage.id]);\r\n                                  });\r\n                                  \r\n                                  return $scope.getEventFromEventCollection(eventsForStages);\r\n                              };\r\n                              \r\n                              $scope.getEventFromEventCollection = function(eventCollection){\r\n                                  //get first incomplete not skipped. If none, get latest nok skipped         \r\n                                  var lastComplete = -1;\r\n                                  var firstOpen = -1;  \r\n                                  \r\n                                  var stageEvents = eventCollection;\r\n                                  for(i = 0; i < stageEvents.length; i++){\r\n                                      var itiratedEvent = stageEvents[i];\r\n                                      if(itiratedEvent.status !== $scope.EVENTSTATUSSKIPPEDLABEL && itiratedEvent.status !== $scope.EVENTSTATUSCOMPLETELABEL){\r\n                                          firstOpen = i;\r\n                                          break;\r\n                                      }\r\n                                      else if(itiratedEvent.status === $scope.EVENTSTATUSCOMPLETELABEL){\r\n                                          lastComplete = i;\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  \r\n                                  var eventToFetch = -1;\r\n                                  if(firstOpen >= 0){\r\n                                      eventToFetch = firstOpen;\r\n                                  }\r\n                                  else if(lastComplete >= 0){\r\n                                      eventToFetch = lastComplete;\r\n                                  }\r\n                                  \r\n                                  if(eventToFetch !== -1){\r\n                                      return stageEvents[eventToFetch];\r\n                                  }\r\n                                  return; \r\n                              };\r\n                              \r\n                              $scope.openStageFormFromEventLayout = function(stage){                \r\n                                  \r\n                                  if($scope.currentStage && $scope.currentStage.id === stage.id){\r\n                                      $scope.deSelectCurrentEvent();\r\n                                  }\r\n                                  else {\r\n                                      $scope.openStageEvent(stage, function(){\r\n                                          if($scope.stageOpenInEventLayout === stage.id){\r\n                                              $scope.stageOpenInEventLayout = \"\";\r\n                                          }\r\n                                          else {\r\n                                              $scope.stageOpenInEventLayout = stage.id;\r\n                                          }\r\n                                      });\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.openStageEventFromMenu = function(stage, timelineFilter){\r\n                                  \r\n                                  var stages = [stage.id];\r\n                                  //set timeLineFilter if present\r\n                                  if(angular.isDefined(timelineFilter)){\r\n                                      var timelineFilterArr = timelineFilter.split(\",\");\r\n                                      $scope.topLineStageFilter = {};\r\n                                      angular.forEach(timelineFilterArr, function(filter){\r\n                                          $scope.topLineStageFilter[filter] = true;\r\n                                          if(stage.id !== filter){\r\n                                              stages.push(filter);\r\n                                          }\r\n                                      });\r\n                                  }\r\n                                  \r\n                                  $scope.openStagesEvent(stages, function(){\r\n                                      $scope.openEmptyStage(stage);\r\n                                  });        \r\n                              };\r\n                              \r\n                              $scope.openStagesEvent = function(stages, noEventFoundFunc){\r\n                                  var event = $scope.getEventForStages(stages);\r\n                                  \r\n                                  if(angular.isDefined(event)){ \r\n                                      $scope.getEventFromStageSelection(event);            \r\n                                  }\r\n                                  else {\r\n                                      noEventFoundFunc();\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.openStageEvent = function(stage, noEventFoundFunc){\r\n                                  \r\n                                  var latest = $scope.getEventForStage(stage);\r\n                                  \r\n                                  if(latest >= 0){\r\n                                      $scope.getEventFromStageSelection($scope.eventsByStage[stage.id][latest]);\r\n                                  }\r\n                                  else {\r\n                                      noEventFoundFunc();\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.getEventFromStageSelection = function(event){\r\n                                  \r\n                                  $scope.showDataEntryForEvent(event);\r\n                                  \r\n                                  if(angular.isDefined($scope.currentStage) && $scope.currentStage !== null && angular.isDefined($scope.currentStage.displayEventsInTable) && $scope.currentStage.displayEventsInTable === true){\r\n                                      $scope.currentEvent = {};\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.openEmptyStage = function(stage){\r\n                                  $scope.deSelectCurrentEvent();\r\n                                  $scope.currentStage = stage;        \r\n                              };\r\n                              \r\n                              $scope.getStageEventCnt = function(stage){                \r\n                                  \r\n                                  var cnt = -1;\r\n                                  \r\n                                  if($scope.eventsLoaded){            \r\n                                      cnt = 0;\r\n                                      if(angular.isDefined($scope.eventsByStage[stage.id])){\r\n                                          cnt = $scope.eventsByStage[stage.id].length;\r\n                                      }\r\n\r\n                                      if(angular.isDefined($scope.headerCombineStages)){\r\n                                          for(var key in $scope.headerCombineStages){\r\n                                              if(stage.id === key){\r\n                                                  if(angular.isDefined($scope.eventsByStage[$scope.headerCombineStages[key]])){\r\n                                                      cnt += $scope.eventsByStage[$scope.headerCombineStages[key]].length;\r\n                                                  }\r\n                                              }\r\n                                              else if(stage.id === $scope.headerCombineStages[key]){\r\n                                                  if(angular.isDefined($scope.eventsByStage[key])){\r\n                                                      cnt += $scope.eventsByStage[key].length;\r\n                                                  }\r\n                                              }\r\n                                          }\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  return cnt > -1 ? cnt : \"\";        \r\n                              };\r\n                              \r\n                              $scope.$watch(\"currentEvent\", function(newValue, oldValue){\r\n                                  if(angular.isDefined(newValue)){\r\n                                      $scope.stageOpenInEventLayout = \"\";            \r\n                                  }\r\n                              });\r\n                              \r\n                              $scope.getValueTitleCompareForm = function(event){\r\n\t                          return event.eventDate;\r\n                              };\r\n                              \r\n                              $scope.getGestAgeForANCEventContainer = function(event){\r\n                                  return '';\r\n                              };\r\n                              \r\n                              $scope.getStageErrorMessageInEventLayout = function(stage){\r\n                                  if(angular.isDefined($scope.stageErrorInEventLayout[stage.id])){\r\n                                      switch($scope.stageErrorInEventLayout[stage.id]){\r\n                                      case $scope.eventCreationActions.add:                    \r\n                                          return $translate.instant('please_complete_all_results_before_add');\r\n                                          break;\r\n                                      case $scope.eventCreationActions.schedule:\r\n                                          return $translate.instant('please_complete_all_results_before_schedule');\r\n                                          break;\r\n                                      case $scope.eventCreationActions.referral:\r\n                                          return $translate.instant('please_complete_all_results_before_referral');\r\n                                          break;                \r\n                                      }\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.resetStageErrorInEventLayout = function(){\r\n                                  if(angular.isDefined($scope.stageErrorInEventLayout[$scope.currentEvent.programStage]) && $scope.stageErrorInEventLayout[$scope.currentEvent.programStage] !== \"\"){\r\n                                      $scope.stageErrorInEventLayout[$scope.currentEvent.programStage] = \"\";\r\n                                  }\r\n                              };\r\n\r\n                              $scope.downloadFile = function(eventUid, dataElementUid, e) {\r\n                                  eventUid = eventUid ? eventUid : $scope.currentEvent.event ? $scope.currentEvent.event : null;        \r\n                                  if( !eventUid || !dataElementUid){\r\n                                      NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"missing_file_identifier\"));\r\n                                      return;\r\n                                  }\r\n                                  \r\n                                  $window.open('../api/events/files?eventUid=' + eventUid +'&dataElementUid=' + dataElementUid, '_blank', '');\r\n                                  if(e){\r\n                                      e.stopPropagation();\r\n                                      e.preventDefault();\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.deleteFile = function(ev, dataElement){\r\n                                  \r\n                                  if( !dataElement ){\r\n                                      NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"missing_file_identifier\"));\r\n                                      return;\r\n                                  }\r\n                                  \r\n                                  var modalOptions = {\r\n                                      closeButtonText: 'cancel',\r\n                                      actionButtonText: 'remove',\r\n                                      headerText: 'remove',\r\n                                      bodyText: 'are_you_sure_to_remove'\r\n                                  };\r\n\r\n                                  ModalService.showModal({}, modalOptions).then(function(result){            \r\n                                      $scope.fileNames[$scope.currentEvent.event][dataElement] = null;\r\n                                      $scope.currentEvent[dataElement] = null;\r\n                                      ev[dataElement] = null;\r\n                                      $scope.saveDatavalue($scope.prStDes[dataElement], null);\r\n                                      //$scope.updateEventDataValue($scope.currentEvent, dataElement);\r\n                                  });\r\n                              };\r\n                              \r\n                              $scope.updateFileNames = function(){        \r\n                                  for(var dataElement in $scope.currentFileNames){\r\n                                      if($scope.currentFileNames[dataElement]){\r\n                                          if(!$scope.fileNames[$scope.currentEvent.event]){\r\n                                              $scope.fileNames[$scope.currentEvent.event] = [];\r\n                                          }                 \r\n                                          $scope.fileNames[$scope.currentEvent.event][dataElement] = $scope.currentFileNames[dataElement];\r\n                                      }\r\n                                  }\r\n                              };\r\n                              \r\n                              $scope.categoryOptionComboFilter = function(){\r\n                                  \r\n                                  var modalInstance = $modal.open({\r\n                                      templateUrl: 'components/dataentry/modal-category-option.html',\r\n                                      controller: 'EventCategoryComboController',\r\n                                      resolve: {\r\n                                          selectedProgram: function () {\r\n                                              return $scope.selectedProgram;\r\n                                          },\r\n                                          selectedCategories: function(){\r\n                                              return $scope.selectedCategories;\r\n                                          },\r\n                                          selectedTeiId: function(){\r\n                                              return $scope.selectedTei.trackedEntityInstance;\r\n                                          }\r\n                                      }\r\n                                  });\r\n\r\n                                  modalInstance.result.then(function (events) {\r\n                                      if (angular.isObject(events)) {\r\n                                          CurrentSelection.setSelectedTeiEvents( events );\r\n                                          $scope.getEvents();\r\n                                      }\r\n                                  }, function () {\r\n                                  });        \r\n                              };\r\n                              \r\n                              $scope.editAttributeCategoryOptions = function(){\r\n                                  $scope.showAttributeCategoryOptions = !$scope.showAttributeCategoryOptions;\r\n                                  \r\n                                  if( $scope.showAttributeCategoryOptions && $scope.currentEvent && $scope.currentEvent.attributeCategoryOptions ){                        \r\n                                      var selectedOptions = $scope.currentEvent.attributeCategoryOptions.split(\";\");\r\n                                      var reverse = false;\r\n                                      for (var i=0; i<$scope.selectedCategories.length; i++) {\r\n                                          for(var j=0; j<$scope.selectedCategories[i].categoryOptions.length; j++) {\r\n                                              if($scope.selectedCategories[i].categoryOptions[j].id === selectedOptions[i]){\r\n                                                  $scope.selectedCategories[i].selectedOption = $scope.selectedCategories[i].categoryOptions[j];\r\n                                                  break;\r\n                                              }\r\n                                              else{\r\n                                                  reverse = true;\r\n                                              }\r\n                                          }\r\n                                      }\r\n                                      \r\n                                      if( reverse ){\r\n                                          selectedOptions = selectedOptions.reverse();\r\n                                          $scope.currentEvent.attributeCategoryOptions = selectedOptions.join(';');\r\n                                          for (var i=0; i<$scope.selectedCategories.length; i++) {\r\n                                              for(var j=0; j<$scope.selectedCategories[i].categoryOptions.length; j++) {\r\n                                                  if($scope.selectedCategories[i].categoryOptions[j].id === selectedOptions[i]){\r\n                                                      $scope.selectedCategories[i].selectedOption = $scope.selectedCategories[i].categoryOptions[j];\r\n                                                      break;\r\n                                                  }\r\n                                              }\r\n                                          }\r\n                                      }\r\n                                  }        \r\n                              };\r\n                              \r\n                              $scope.saveAttributeCategoryOptions = function(){\r\n                                  var selectedOptions = [], optionsReady = true;\r\n                                  $scope.changedCat = {id: -1, saved: false};\r\n                                  for (var i = 0; i < $scope.selectedCategories.length; i++) {\r\n                                      \r\n                                      if( $scope.selectedCategories[i].selectedOption.id !== $scope.currentEvent.attributeCategoryOptions.split(';')[i] ){                \r\n                                          $scope.changedCat.id = $scope.selectedCategories[i].id;\r\n                                      }\r\n                                      if ($scope.selectedCategories[i].selectedOption && $scope.selectedCategories[i].selectedOption.id) {\r\n                                          selectedOptions.push($scope.selectedCategories[i].selectedOption.id);\r\n                                      }\r\n                                      else{\r\n                                          optionsReady = false;\r\n                                      }\r\n                                  }\r\n                                  \r\n                                  var acos = selectedOptions.join(';');\r\n                                  if( optionsReady && acos !== $scope.currentEvent.attributeCategoryOptions ){\r\n                                      \r\n                                      var ev = EventUtils.processEvent($scope.currentEvent, $scope.currentStage, $scope.optionSets, $scope.prStDes);\r\n                                      \r\n                                      if( ev.event && ev.enrollment && ev.trackedEntityInstance && ev.attributeCategoryOptions && ev.attributeOptionCombo){\r\n                                          var dhis2Event = {event: ev.event, orgUnit: ev.orgUnit, enrollment: ev.enrollment, program: ev.program, programStage: ev.programStage, dataValues: ev.dataValues};\r\n                                          \r\n                                          if( ev.status ){\r\n                                              dhis2Event.status = ev.status;\r\n                                          }\r\n                                          \r\n                                          if( ev.eventDate ){\r\n                                              dhis2Event.eventDate = ev.eventDate;\r\n                                          }\r\n                                          \r\n                                          if( ev.notes ){\r\n                                              dhis2Event.notes = ev.notes;\r\n                                          }\r\n                                          \r\n                                          if( ev.coordinate ){\r\n                                              dhis2Event.coordinate = ev.coordinate;\r\n                                          }\r\n                                          \r\n                                          dhis2Event.attributeCategoryOptions = acos;\r\n                                      }            \r\n                                      \r\n                                      DHIS2EventFactory.update(dhis2Event).then(function(data){            \r\n                                          $scope.currentEvent.attributeCategoryOptions = dhis2Event.attributeCategoryOptions;\r\n                                          $scope.changedCat.saved = true;\r\n                                      });\r\n                                  }\r\n                              };\r\n                              \r\n                              //$scope.getInputNotifcationClass = function(id, custom, event){\r\n                              $scope.getOptionSaveNotifcationClass = function( id ){\r\n                                  if($scope.changedCat && $scope.changedCat.id && $scope.changedCat.id === id){            \r\n                                      if($scope.changedCat.saved){\r\n                                          return 'form-control input-success';\r\n                                      }            \r\n                                      else{\r\n                                          return 'form-control input-error';\r\n                                      }            \r\n                                  }\r\n                                  return 'form-control';\r\n                              };\r\n                              \r\n                              $scope.hideEditAttributeCategoryOptions = function(){\r\n                                  $scope.showAttributeCategoryOptions = !$scope.showAttributeCategoryOptions;\r\n                              };\r\n                              \r\n                          })\r\n    .controller('EventOptionsInTableController', function($scope, $translate){\r\n        \r\n        var COMPLETE = \"Complete\";\r\n        var INCOMPLETE = \"Incomplete\";\r\n        var VALIDATE = \"Validate\";\r\n        var DELETE = \"Delete\";    \r\n        var SKIP = \"Skip\";\r\n        var UNSKIP = \"Unskip\";\r\n        var NOTE = \"Note\";\r\n        \r\n\r\n        $scope.completeIncompleteEventFromTable = function(){\r\n            \r\n            if ($scope.currentEvent.status !== 'COMPLETED'){\r\n                $scope.currentEvent.submitted = true;           \r\n                var formData = $scope.$eval('eventRowForm' + $scope.eventRow.event);                    \r\n                if(formData.$valid){\r\n                    $scope.completeIncompleteEvent(true);\r\n                }\r\n            }\r\n            else{\r\n                $scope.completeIncompleteEvent(true);\r\n            }\r\n        };\r\n        \r\n        $scope.eventTableOptions = {};    \r\n        $scope.eventTableOptions[COMPLETE] = {text: \"Complete\", tooltip: 'Complete', icon: \"<span class='glyphicon glyphicon-check'></span>\", value: COMPLETE, onClick: $scope.completeIncompleteEventFromTable, sort: 0};\r\n        $scope.eventTableOptions[INCOMPLETE] = {text: \"Reopen\", tooltip: 'Reopen', icon: \"<span class='glyphicon glyphicon-pencil'></span>\", value: INCOMPLETE, onClick: $scope.completeIncompleteEventFromTable, sort: 1};\r\n        //$scope.eventTableOptions[VALIDATE] = {text: \"Validate\", tooltip: 'Validate', icon: \"<span class='glyphicon glyphicon-cog'></span>\", value: VALIDATE, onClick: $scope.validateEvent, sort: 6};    \r\n        $scope.eventTableOptions[DELETE] = {text: \"Delete\", tooltip: 'Delete', icon: \"<span class='glyphicon glyphicon-floppy-remove'></span>\", value: DELETE, onClick: $scope.deleteEvent, sort: 2};\r\n        $scope.eventTableOptions[SKIP] = {text: \"Skip\", tooltip: 'Skip', icon: \"<span class='glyphicon glyphicon-step-forward'></span>\", value: SKIP, onClick: $scope.skipUnskipEvent, sort: 3};\r\n        $scope.eventTableOptions[UNSKIP] = {text: \"Schedule back\", tooltip: 'Schedule back', icon: \"<span class='glyphicon glyphicon-step-backward'></span>\", value: UNSKIP, onClick: $scope.skipUnskipEvent, sort: 4};\r\n        //$scope.eventTableOptions[NOTE] = {text: \"Notes\", tooltip: 'Show notes', icon: \"<span class='glyphicon glyphicon-list-alt'></span>\", value: NOTE, onClick: $scope.notesModal, sort: 5};    \r\n        \r\n        $scope.eventRow.validatedEventDate = $scope.eventRow.eventDate;\r\n        updateEventTableOptions();\r\n        \r\n        $scope.$watch(\"eventRow.status\", function(newValue, oldValue){\r\n            if(newValue !== oldValue){\r\n                updateEventTableOptions();\r\n            }    \r\n            \r\n        });\r\n        \r\n        $scope.$watch(\"validatedDateSetForEvent\", function(newValue, oldValue){                        \r\n            if(angular.isDefined(newValue)){\r\n                if(!angular.equals(newValue, {})){\r\n                    var updatedEvent = newValue.event;\r\n                    if(updatedEvent === $scope.eventRow){                    \r\n                        $scope.eventRow.validatedEventDate = newValue.date; \r\n                        updateEventTableOptions();                    \r\n                    }\r\n                }\r\n            }        \r\n            \r\n        });\r\n        \r\n        function updateEventTableOptions(){\r\n            \r\n            var eventRow = $scope.eventRow;        \r\n            \r\n            for(var key in $scope.eventTableOptions){\r\n                $scope.eventTableOptions[key].show = true;\r\n                $scope.eventTableOptions[key].disabled = false;\r\n            }\r\n            \r\n            $scope.eventTableOptions[UNSKIP].show = false;        \r\n            \r\n            switch(eventRow.status){\r\n            case $scope.EVENTSTATUSCOMPLETELABEL:\r\n                $scope.eventTableOptions[COMPLETE].show = false;\r\n                $scope.eventTableOptions[SKIP].show = false; \r\n                $scope.eventTableOptions[DELETE].show = false;\r\n                //$scope.eventTableOptions[VALIDATE].show = false;                \r\n                $scope.defaultOption = $scope.eventTableOptions[INCOMPLETE];\r\n                break;\r\n            case $scope.EVENTSTATUSSKIPPEDLABEL:\r\n                $scope.eventTableOptions[COMPLETE].show = false;\r\n                $scope.eventTableOptions[INCOMPLETE].show = false;\r\n                //$scope.eventTableOptions[VALIDATE].show = false;                \r\n                $scope.eventTableOptions[SKIP].show = false;\r\n                \r\n                $scope.eventTableOptions[UNSKIP].show = true;\r\n                $scope.defaultOption = $scope.eventTableOptions[UNSKIP];\r\n                break;            \r\n            default:                 \r\n                if(eventRow.validatedEventDate){\r\n                    $scope.eventTableOptions[INCOMPLETE].show = false;\r\n                    $scope.eventTableOptions[SKIP].show = false;\r\n                    $scope.defaultOption = $scope.eventTableOptions[COMPLETE];\r\n                }\r\n                else {\r\n                    $scope.eventTableOptions[INCOMPLETE].show = false;                    \r\n                    //$scope.eventTableOptions[VALIDATE].show = false;\r\n                    $scope.eventTableOptions[COMPLETE].disabled = true;\r\n                    $scope.defaultOption = $scope.eventTableOptions[COMPLETE];\r\n                }                          \r\n                break;\r\n            }\r\n            \r\n            createOptionsArray();\r\n        }\r\n        \r\n        function createOptionsArray(){\r\n            \r\n            $scope.eventTableOptionsArr = [];        \r\n            \r\n            for(var key in $scope.eventTableOptions){\r\n                $scope.eventTableOptionsArr[$scope.eventTableOptions[key].sort] = $scope.eventTableOptions[key];\r\n            }\r\n        }   \r\n    });\r\n\n\n\n// WEBPACK FOOTER //\n// ./components/dataentry/dataentry-controller.js","var trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('MakeReferralController', function($scope, $modalInstance, stage, OrgUnitFactory){\n    $scope.stage = stage;\n    $scope.cancel = function(){\n        $modalInstance.close();\n    };\n    \n    $scope.makeReferral = function(){\n        if(!$scope.referralDate){\n            $scope.dateError = true;\n        }else{\n            $scope.dateError = false;\n        }\n        \n        if(!$scope.selectedSearchingOrgUnit){\n            $scope.orgError = true;     \n        }else{\n            $scope.orgError = false;\n        }\n        if(!$scope.dateError && !$scope.orgError){\n            $modalInstance.close();\n        }\n    };\n    \n    $scope.setSelectedSearchingOrgUnit = function(orgUnit){\n        $scope.selectedSearchingOrgUnit = orgUnit;     \n    };\n    \n    OrgUnitFactory.getSearchTreeRoot().then(function(response) {\n        $scope.orgUnits = response.organisationUnits;\n        angular.forEach($scope.orgUnits, function(ou){\n            ou.show = true;\n            angular.forEach(ou.children, function(o){                    \n                o.hasChildren = o.children && o.children.length > 0 ? true : false;\n            });            \n        });\n    });\n    \n    $scope.expandCollapse = function(orgUnit) {\n        if( orgUnit.hasChildren ){            \n            //Get children for the selected orgUnit\n            OrgUnitFactory.get(orgUnit.id).then(function(ou) {                \n                orgUnit.show = !orgUnit.show;\n                orgUnit.hasChildren = false;\n                orgUnit.children = ou.organisationUnits[0].children;                \n                angular.forEach(orgUnit.children, function(ou){                    \n                    ou.hasChildren = ou.children && ou.children.length > 0 ? true : false;\n                });                \n            });           \n        }\n        else{\n            orgUnit.show = !orgUnit.show;   \n        }        \n    };\n})\n\n\n// WEBPACK FOOTER //\n// ./components/dataentry/referral-controller.js","var trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('ModalDefaultFormController', function($scope){\n    \n    var defaultRequestError = \"Server error. Please try again later.\";\n    \n    $scope.completeIncompleteEventModal = function(){  \n           \n        $scope.requestError = \"\";\n        if ($scope.currentEvent.status === 'COMPLETED'){\n            var dhis2Event = $scope.makeDhis2EventToUpdate();\n            dhis2Event.status = 'ACTIVE';\n        }\n        else{\n            $scope.modalForm.$setSubmitted();\n            $scope.modalForm.outerDataEntryForm.$setSubmitted();     \n            \n            if($scope.modalForm.$invalid){\n                return;\n            }     \n            \n            //check for errors!\n            if(angular.isDefined($scope.errorMessages[$scope.currentEvent.event]) && $scope.errorMessages[$scope.currentEvent.event].length > 0) {\n                //There is unresolved program rule errors - show error message.\n                return;\n            }\n            \n            var dhis2Event = $scope.makeDhis2EventToUpdate();\n            dhis2Event.status = 'COMPLETED';\n        }        \n        \n        $scope.executeCompleteIncompleteEvent(dhis2Event).then(function(){                                    \n            if(dhis2Event.status === 'COMPLETED'){\n                $scope.eventEditFormModalInstance.close();            \n            }\n        }, function(error){\n            $scope.requestError = defaultRequestError;                                   \n        });\n    };\n    \n    $scope.deleteEventModal = function(){\n        \n        $scope.executeDeleteEvent().then(function(){\n            \n            $scope.eventEditFormModalInstance.close();\n        }, function(){\n            \n            $scope.requestError = defaultRequestError; \n        });        \n    };\n    \n    $scope.skipUnskipEventModal = function(){\n                \n        var dhis2Event = $scope.makeDhis2EventToUpdate();\n        \n        if ($scope.currentEvent.status === 'SKIPPED') {//unskip event\n            dhis2Event.status = 'ACTIVE';\n        }\n        else {//skip event\n            dhis2Event.status = 'SKIPPED';\n        }\n        \n        \n        $scope.executeSkipUnskipEvent(dhis2Event).then(function(){\n            if(dhis2Event.status === 'SKIPPED'){\n                $scope.eventEditFormModalInstance.close();\n            }\n        }, function(){\n            $scope.requestError = defaultRequestError;\n        });        \n    };\n    \n    $scope.closeEventModal = function(){\n        $scope.eventEditFormModalInstance.dismiss();\n    };\n});\n\n\n// WEBPACK FOOTER //\n// ./components/dataentry/modal-default-form-controller.js","\n/* global trackerCapture, angular */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('EventCreationController',\n        function ($scope,\n                $modalInstance,\n                $timeout,\n                $translate,\n                $filter,\n                removeFuturePeriodFilter,\n                DateUtils,\n                DHIS2EventFactory,\n                OrgUnitFactory,\n                NotificationService,\n                EventCreationService,\n                eventsByStage,\n                stage,\n                stages,\n                allStages,\n                tei,\n                program,\n                orgUnit,\n                enrollment,                \n                eventCreationAction,\n                autoCreate,\n                EventUtils,\n                events,\n                suggestedStage,\n                selectedCategories,\n                PeriodService) {\n    $scope.selectedEnrollment = enrollment;                \n    $scope.stages = stages;\n    $scope.allStages = allStages;\n    $scope.events = events;\n    $scope.eventCreationAction = eventCreationAction;\n    $scope.eventCreationActions = EventCreationService.eventCreationActions;\n    $scope.isNewEvent = (eventCreationAction === $scope.eventCreationActions.add);\n    $scope.isScheduleEvent = (eventCreationAction === $scope.eventCreationActions.schedule || eventCreationAction === $scope.eventCreationActions.referral);\n    $scope.isReferralEvent = (eventCreationAction === $scope.eventCreationActions.referral);\n    $scope.model = {selectedStage: stage, dueDateInvalid: false, eventDateInvalid: false};\n    $scope.stageSpecifiedOnModalOpen = angular.isObject(stage) ? true : false;\n    $scope.suggestedStage = suggestedStage;\n    $scope.selectedProgram = program;\n    $scope.selectedCategories = selectedCategories;\n    $scope.pleaseSelectLabel = $translate.instant('please_select');\n    $scope.periodOffset = 0;\n    $scope.referenceOffset = 0;\n    $scope.periods = [];\n    $scope.hasFuturePeriod = false;\n    $scope.today = DateUtils.getToday();\n    \n    if( $scope.isScheduleEvent ){        \n        $scope.stages = $filter('filter')(stages, {hideDueDate: false});\n    }\n    \n    if( $scope.isScheduleEvent ){        \n        $scope.stages = $filter('filter')(stages, {periodType: 'undefined'});\n    }\n\n    var dummyEvent = {};\n    \n    function prepareEvent(){\n        \n        dummyEvent = EventUtils.createDummyEvent(eventsByStage[stage.id], tei, program, stage, orgUnit, $scope.selectedEnrollment);\n        \n        $scope.newEvent = {programStage: stage};\n        $scope.dhis2Event = {eventDate: $scope.isScheduleEvent ? '' : DateUtils.getToday(), dueDate: dummyEvent.dueDate, executionDateLabel : dummyEvent.executionDateLabel, name: dummyEvent.name, invalid: true};        \n\n        if ($scope.model.selectedStage.periodType) {\n            $scope.dhis2Event.eventDate = dummyEvent.dueDate;\n            $scope.dhis2Event.periodName = dummyEvent.periodName;\n            $scope.periods = dummyEvent.periods;\n            $scope.periodOffset = angular.copy( dummyEvent.periodOffset );\n            $scope.referenceOffset = angular.copy( dummyEvent.periodOffset );\n            $scope.hasFuturePeriod = angular.copy( dummyEvent.hasFuturePeriod );\n            $scope.dhis2Event.selectedPeriod = dummyEvent.periods[0];\n            $scope.periods = PeriodService.managePeriods($scope.periods, $scope.isNewEvent);\n        }\n    };\n    \n    function suggestStage(){        \n        var suggestedStage;\n        var events = $scope.events;        \n        var allStages = $scope.allStages;\n        \n        var availableStagesOrdered = $scope.stages.slice();\n        availableStagesOrdered.sort(function (a,b){\n            return a.sortOrder - b.sortOrder;\n        });\n        \n        var stagesById = [];\n        \n        if((angular.isUndefined(events) || events.length === 0) && angular.isUndefined($scope.suggestedStage)){\n            suggestedStage = availableStagesOrdered[0];\n        }\n        else{\n            angular.forEach(allStages, function(stage){\n                stagesById[stage.id] = stage;\n            });\n            \n            var lastStageForEvents;\n            \n            if(angular.isUndefined($scope.suggestedStage)){\n                for(var i = 0; i < events.length; i++){\n                    var event = events[i];\n                    var eventStage = stagesById[event.programStage];\n                        if(i > 0){\n                            if(eventStage.sortOrder > lastStageForEvents.sortOrder){\n                                lastStageForEvents = eventStage;\n                            }\n                            else if(eventStage.sortOrder === lastStageForEvents.sortOrder){\n                                if(eventStage.id !== lastStageForEvents.id){\n                                    if(eventStage.displayName.localeCompare(lastStageForEvents.displayName) > 0){\n                                        lastStageForEvents = eventStage;\n                                    }\n                                }                            \n                            }\n                        }\n                        else {\n                            lastStageForEvents = eventStage;\n                        }\n                }   \n            }\n            else {\n                lastStageForEvents = $scope.suggestedStage;\n            }\n\n            \n            for(var j = 0; j < availableStagesOrdered.length; j++){\n                var availableStage = availableStagesOrdered[j];\n                \n                if( !availableStage || !availableStage.id || lastStageForEvents || lastStageForEvents.id ){\n                    break;\n                }\n                \n                if(availableStage.id === lastStageForEvents.id){\n                    suggestedStage = availableStage;\n                    break;\n                }\n                else if(availableStage.sortOrder === lastStageForEvents.sortOrder){\n                    if(availableStage.displayName.localeCompare(lastStageForEvents.displayName) > 0){\n                        suggestedStage = availableStage;\n                        break;\n                    }\n                }\n                else if(availableStage.sortOrder > lastStageForEvents.sortOrder){\n                    suggestedStage = availableStage;\n                    break;\n                }\n            }\n            \n            if(angular.isUndefined(suggestedStage)){\n                suggestedStage = availableStagesOrdered[availableStagesOrdered.length - 1];\n            }\n        }\n        \n        $scope.model.selectedStage = suggestedStage;\n        stage = $scope.model.selectedStage;\n    };\n    \n    if(!$scope.stageSpecifiedOnModalOpen){\n        //suggest stage\n        suggestStage();        \n    }\n    \n    \n    $scope.$watch('model.selectedStage', function(){       \n        if(angular.isObject($scope.model.selectedStage)){\n            stage = $scope.model.selectedStage;            \n            prepareEvent();\n            $scope.model.selectedStage.executionDateLabel = $scope.model.selectedStage.executionDateLabel ? $scope.model.selectedStage.executionDateLabel : $translate.instant('report_date');\n            //If the caller wants to create right away, go ahead and save.\n            if (autoCreate) {\n                $scope.save();\n            };\n        }\n    });    \n\n    $scope.getCategoryOptions = function(){\n        $scope.selectedOptions = [];\n        for (var i = 0; i < $scope.selectedCategories.length; i++) {\n            if ($scope.selectedCategories[i].selectedOption && $scope.selectedCategories[i].selectedOption.id) {\n                $scope.selectedOptions.push($scope.selectedCategories[i].selectedOption.id);\n            }\n        }\n    };\n\n    $scope.save = function () {\n\n        $scope.getCategoryOptions();\n        \n        //check for form validity\n        $scope.eventCreationForm.submitted = true;        \n        if( $scope.eventCreationForm.$invalid ){\n            return false;\n        }\n        \n        if($scope.isReferralEvent && !$scope.selectedSearchingOrgUnit){\n            $scope.orgUnitError = true;\n            return false;\n        }        \n        \n        $scope.orgUnitError =  false;\n        \n        var newEvents = {events: []};\n        var newEvent = {\n            trackedEntityInstance: dummyEvent.trackedEntityInstance,\n            program: dummyEvent.program,\n            programStage: dummyEvent.programStage,\n            enrollment: dummyEvent.enrollment,\n            orgUnit: dummyEvent.orgUnit,\n            notes: [],\n            dataValues: [],\n            status: 'ACTIVE'\n        };\n        \n        if ($scope.model.selectedStage.periodType) {\n            if( $scope.isNewEvent ){\n                newEvent.eventDate = DateUtils.formatFromUserToApi( $scope.dhis2Event.selectedPeriod.endDate );\n            }\n            else{\n                newEvent.dueDate = DateUtils.formatFromUserToApi( $scope.dhis2Event.selectedPeriod.endDate );\n            }\n        }\n        else{\n            if( $scope.isNewEvent ){\n                newEvent.eventDate = DateUtils.formatFromUserToApi($scope.dhis2Event.eventDate);\n            }\n            else{\n                newEvent.eventDate = DateUtils.formatFromUserToApi($scope.dhis2Event.dueDate);\n            }\n        }\n\n        newEvent.status = newEvent.eventDate ? 'ACTIVE' : 'SCHEDULE';\n        \n        //for saving category combo\n        if ($scope.selectedProgram.categoryCombo && !$scope.selectedProgram.categoryCombo.isDefault) {\n            if ($scope.selectedOptions.length !== $scope.selectedCategories.length) {\n                NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"fill_all_category_options\"));\n                return;\n            }\n            newEvent.attributeCategoryOptions = $scope.selectedOptions.join(';');\n        }\n\n        newEvents.events.push(newEvent);\n        DHIS2EventFactory.create(newEvents).then(function (response) {\n            if (response && response.response && response.response.importSummaries[0].status === 'SUCCESS') {\n                newEvent.event = response.response.importSummaries[0].reference;\n                $modalInstance.close({dummyEvent: dummyEvent, ev: newEvent});\n            } else {\n                $scope.eventCreationForm.submitted = false;\n            }\n        });\n    };\n\n    //Start referral logic\n    $scope.setSelectedSearchingOrgUnit = function(orgUnit){\n        $scope.selectedSearchingOrgUnit = orgUnit;\n        dummyEvent.orgUnit = orgUnit.id;\n        dummyEvent.orgUnitName = orgUnit.name;\n    };\n    \n    \n    if(angular.isDefined(orgUnit) && angular.isDefined(orgUnit.id) && $scope.isReferralEvent){\n        $scope.orgUnitsLoading = true;\n        $timeout(function(){\n            OrgUnitFactory.get(orgUnit.id).then(function(data){\n                if(data && data.organisationUnits && data.organisationUnits.length >0){\n                    orgUnit = data.organisationUnits[0];\n                    var url = generateFieldsUrl();\n                    OrgUnitFactory.getOrgUnits(orgUnit.id,url).then(function(data){\n                        if(data && data.organisationUnits && data.organisationUnits.length >0){\n                            $scope.orgWithParents = data.organisationUnits[0];\n                            var org = data.organisationUnits[0];\n                            var orgUnitsById ={};\n                            orgUnitsById[org.id] = org;\n                            while(org.parent){\n                                org.parent.childrenLoaded = true;\n                                orgUnitsById[org.parent.id] = org.parent;\n                                org.parent.show = true;\n                                for(var i=0;i<org.parent.children.length;i++){\n                                    angular.forEach(org.parent.children[i].children, function(child){\n                                       if(!orgUnitsById[child.id]){\n                                            orgUnitsById[child.id] =child; \n                                       }\n                                    });\n                                    if(org.parent.children[i].id===org.id){\n                                        org.parent.children[i] = org;\n                                        i= org.parent.children.length;\n                                    }else{\n                                        orgUnitsById[org.parent.children[i].id] = org.parent.children[i];\n                                    }\n                                }\n                                org = org.parent;\n                            }\n                            $scope.orgUnits = [org];\n                        }\n                        $scope.orgUnitsLoading = false;\n                    });\n                }\n\n                \n            });\n            \n        },350);\n    }\n    \n    function generateFieldsUrl(){\n        var fieldUrl = \"fields=id,displayName,organisationUnitGroups[shortName]\";\n        var parentStartDefault = \",parent[id,displayName,children[id,displayName,organisationUnitGroups[shortName],children[id,displayName,organisationUnitGroups[shortName]]]\";\n        var parentEndDefault = \"]\";\n        if(orgUnit.level && orgUnit.level > 1){\n            var parentStart = parentStartDefault;\n            var parentEnd = parentEndDefault;\n            for(var i =0; i< orgUnit.level-2;i++){\n                parentStart+= parentStartDefault;\n                parentEnd +=parentStartDefault;\n            }\n            fieldUrl += parentStart;\n            fieldUrl += parentEnd;\n        }\n        return fieldUrl;\n    }\n    \n    $scope.expandCollapse = function(orgUnit) {\n        orgUnit.show = !orgUnit.show;\n        if(!orgUnit.childrenLoaded){\n            OrgUnitFactory.get(orgUnit.id).then(function(data){\n                orgUnit.children = data.organisationUnits[0].children;\n                orgUnit.childrenLoaded = true;\n                \n            });\n        }\n    };\n    //end referral logic\n    $scope.cancel = function () {\n        $modalInstance.close();\n    };\n    \n    $scope.interacted = function(field) {        \n        var status = false;\n        if(field){            \n            status = $scope.eventCreationForm.submitted || field.$dirty;\n        }\n        return status;        \n    };\n\n    $scope.fetchPeriod = function (period) {\n        if( !period ){\n            return;\n        }\n        \n        $scope.periodOffset = period === 'NEXT' ? $scope.periodOffset + 1 : $scope.periodOffset - 1;\n        $scope.dhis2Event.selectedPeriod = null;\n        \n        var prds = PeriodService.getPeriods(eventsByStage[stage.id], $scope.model.selectedStage, $scope.selectedEnrollment, $scope.periodOffset);\n        $scope.periods = prds && prds.availablePeriods ? prds.availablePeriods : [];\n        $scope.dhis2Event.selectedPeriod = $scope.periods[0];\n        $scope.hasFuturePeriod = prds.hasFuturePeriod;\n        \n        $scope.periods = PeriodService.managePeriods($scope.periods, $scope.isNewEvent);\n    };\n});\n\n\n\n// WEBPACK FOOTER //\n// ./components/dataentry/new-event-controller.js","/* global trackerCapture */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('EventCategoryComboController', \n        function($scope, \n                $modalInstance, \n                $translate,\n                NotificationService,\n                selectedProgram, \n                selectedCategories,\n                selectedTeiId,\n                DHIS2EventFactory){\n                    \n    $scope.selectedOptions = [];\n    $scope.selectedProgram = selectedProgram;\n    $scope.selectedCategories  = selectedCategories;\n    $scope.selectedTeiId = selectedTeiId;\n    $scope.applyOptions = function(){                    \n        var attributeCategory = {cc: $scope.selectedProgram.categoryCombo.id, default: $scope.selectedProgram.categoryCombo.isDefault, cp: \"\"};\n        if(!$scope.selectedProgram.categoryCombo.isDefault){            \n            if($scope.selectedOptions.length !== $scope.selectedCategories.length){\n                NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"fill_all_category_options\"));\n                return;\n            }            \n            attributeCategory.cp = $scope.selectedOptions.join(';');\n        }\n\n        DHIS2EventFactory.getEventsByProgram($scope.selectedTeiId, $scope.selectedProgram.id, attributeCategory).then(function(events){\n            $scope.close( events );\n        });\n    };\n\n    $scope.getCategoryOptions = function(){\n        $scope.selectedOptions = [];\n        for (var i = 0; i < $scope.selectedCategories.length; i++) {\n            if ($scope.selectedCategories[i].selectedOption && $scope.selectedCategories[i].selectedOption.id) {\n                $scope.selectedOptions.push($scope.selectedCategories[i].selectedOption.id);\n            }\n        }\n    };\n\n    $scope.close = function ( obj ) {\n        $modalInstance.close( obj );\n    };    \n});\n\n\n\n\n// WEBPACK FOOTER //\n// ./components/dataentry/event-cocbo-controller.js","/* global trackerCapture, angular */\n\n//conroller for tei report\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('TeiReportController',\n        function($scope,\n                $filter,\n                $translate,\n                $location,\n                CurrentSelection,\n                DateUtils,\n                EventUtils,\n                TEIService,\n                EnrollmentService,\n                OrgUnitFactory) {\n    $scope.showProgramReportDetailsDiv = false;\n    $scope.enrollmentsByProgram = [];\n    $scope.orgUnitLabel = $translate.instant('org_unit');\n\n    $scope.$on('dashboardWidgets', function(event, args) {\n        $scope.showProgramReportDetailsDiv = false;\n        var selections = CurrentSelection.get();\n        OrgUnitFactory.getOrgUnit(($location.search()).ou).then(function (orgUnit) {\n            $scope.selectedOrgUnit = orgUnit;\n            $scope.selectedTei = selections.tei;\n            $scope.selectedEntity = selections.te;\n            $scope.selectedProgram = selections.pr;\n            $scope.optionSets = selections.optionSets;\n            $scope.programs = selections.prs;\n            $scope.programNames = selections.prNames;\n            $scope.programStageNames = selections.prStNames;\n            \n            angular.forEach(selections.enrollments, function (en) {\n                $scope.enrollmentsByProgram[en.program] = en;\n            });\n\n            if ($scope.selectedTei) {\n                $scope.getEvents();\n            }\n        });\n    });\n    \n    $scope.$on('tei-report-widget', function(event, args) {\n        $scope.getEvents();        \n    });\n    \n    $scope.getEvents = function(){\n        \n        $scope.dataFetched = false;\n        $scope.dataExists = false;\n        \n        $scope.report = [];\n        angular.forEach($scope.programs, function(pr){\n            $scope.report[pr.id] = {};\n        });\n        \n        var eventList = angular.copy( CurrentSelection.getSelectedTeiEvents() );        \n        if($scope.selectedProgram && $scope.selectedProgram.id){\n            eventList = $filter('filter')(eventList, {program: $scope.selectedProgram.id});\n        }\n        \n        angular.forEach(eventList, function(ev){\n            if(ev.program && $scope.report[ev.program] && ev.orgUnit){       \n                ev.visited = true;\n                ev.dueDate = DateUtils.formatFromApiToUser(ev.dueDate);  \n                ev.sortingDate = ev.dueDate;\n                ev.name = $scope.programStageNames[ev.programStage].displayName;\n                ev.programName = $scope.programNames[ev.program].displayName;                    \n                if(!$scope.report[ev.program].enrollments){\n                    $scope.report[ev.program] = {enrollments: {}};\n                }\n                ev.statusColor = EventUtils.getEventStatusColor(ev); \n\n                if(ev.eventDate){\n                    ev.eventDate = DateUtils.formatFromApiToUser(ev.eventDate);\n                    ev.sortingDate = ev.eventDate;\n                }\n                else{\n                    ev.visited = false;\n                }                 \n\n                if(ev.enrollment){\n                    if($scope.report[ev.program].enrollments[ev.enrollment]){\n                        $scope.report[ev.program].enrollments[ev.enrollment].push(ev);\n                    }\n                    else{\n                        $scope.report[ev.program].enrollments[ev.enrollment]= [ev];\n                    }\n                }                    \n                if(!$scope.dataExists){\n                    $scope.dataExists = true;\n                }\n            }                \n        });\n        \n        $scope.dataFetched = true;\n        \n    };\n    \n    $scope.showProgramReportDetails = function(pr){\n        \n        var selections = CurrentSelection.get();\n        $scope.selectedTei = selections.tei;\n        \n        $scope.showProgramReportDetailsDiv = !$scope.showProgramReportDetailsDiv;\n        $scope.selectedProgram = pr;\n        $scope.selectedReport = $scope.report[pr.id];\n        \n        //today as report date\n        $scope.today = DateUtils.getToday();\n\n        //process tei attributes, this is to have consistent display so that the tei \n        //contains program attributes whether it has value or not\n        TEIService.processAttributes($scope.selectedTei, $scope.selectedProgram, $scope.enrollmentsByProgram[pr.id]).then(function(tei){\n            $scope.tei = tei;\n        });\n        \n        //get program stage for the selected program\n        //they are needed to assign data element names for event data values\n        $scope.stagesById = [];  \n        $scope.allowProvidedElsewhereExists = [];\n        $scope.prStDes = [];\n        \n        $scope.programStages = $scope.selectedProgram.programStages;\n        angular.forEach($scope.programStages, function(stage){\n            var providedElsewhereExists = false;\n            for(var i=0; i<stage.programStageDataElements.length; i++){                \n                if(stage.programStageDataElements[i].allowProvidedElsewhere && !providedElsewhereExists){\n                    providedElsewhereExists = true;\n                    $scope.allowProvidedElsewhereExists[stage.id] = true;\n                }\n\n                $scope.prStDes[stage.programStageDataElements[i].dataElement.id] = stage.programStageDataElements[i];\n            }\n\n            $scope.stagesById[stage.id] = stage;\n        });        \n\n        //program reports come grouped in enrollment, process for each enrollment\n        $scope.enrollments = [];\n        angular.forEach(Object.keys($scope.selectedReport.enrollments), function (enr) {\n            //format report data values\n            angular.forEach($scope.selectedReport.enrollments[enr], function (ev) {\n\n                angular.forEach(ev.notes, function (note) {\n                    note.storedDate = DateUtils.formatToHrsMins(note.storedDate);\n                    //get enrollment details\n                    EnrollmentService.get(enr).then(function (enrollment) {\n                        if (enrollment) {\n                            angular.forEach(enrollment.notes, function (note) {\n                                note.storedDate = DateUtils.formatToHrsMins(note.storedDate);\n                            });\n                            $scope.enrollments.push(enrollment);\n                        }\n                    });\n\n                    if (ev.dataValues) {\n                        ev = EventUtils.processEvent(ev, $scope.stagesById[ev.programStage], $scope.optionSets, $scope.prStDes);\n                    }\n                });\n\n                //get enrollment details\n                EnrollmentService.get(enr).then(function (enrollment) {\n                    angular.forEach(enrollment.notes, function (note) {\n                        note.storedDate = DateUtils.formatToHrsMins(note.storedDate);\n                    });\n                    $scope.enrollments.push(enrollment);\n                });\n            });\n        });\n    };\n    \n    $scope.close = function(){\n        $scope.showProgramReportDetailsDiv = false;\n    };\n    \n    $scope.print = function(divName){\n        $scope.showProgramReportDetailsDiv = false;\n        var printContents = document.getElementById(divName).innerHTML;\n        var popupWin = window.open('', '_blank', 'fullscreen=1');\n        popupWin.document.open();\n        popupWin.document.write('<html>\\n\\\n                                        <head>\\n\\\n                                                <link rel=\"stylesheet\" type=\"text/css\" href=\"../dhis-web-commons/bootstrap/css/bootstrap.min.css\" />\\n\\\n                                                <link rel=\"stylesheet\" type=\"text/css\" href=\"../dhis-web-commons/css/print.css\" />\\n\\\n                                                <link rel=\"stylesheet\" type=\"text/css\" href=\"styles/style.css\" />\\n\\\n                                                <link rel=\"stylesheet\" type=\"text/css\" href=\"styles/print.css\" />\\n\\\n                                        </head>\\n\\\n                                        <body onload=\"window.print()\">' + printContents + \n                                '</html>');\n        popupWin.document.close();       \n    };\n});\n\n\n// WEBPACK FOOTER //\n// ./components/report/tei-report-controller.js","/* global trackerCapture, angular */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('ProgramSummaryController',\n        function($scope,\n                DateUtils,\n                EventUtils,\n                TEIGridService,\n                AttributesFactory,\n                ProgramFactory,\n                CurrentSelection,\n                MetaDataFactory,\n                EventReportService) {    \n    $scope.today = DateUtils.getToday();\n    \n    $scope.ouModes = [{name: 'SELECTED'}, {name: 'CHILDREN'}, {name: 'DESCENDANTS'}, {name: 'ACCESSIBLE'}];         \n    $scope.selectedOuMode = $scope.ouModes[0];\n    $scope.report = {};\n    $scope.model = {};\n    \n    $scope.optionSets = CurrentSelection.getOptionSets();\n    if(!$scope.optionSets){\n        $scope.optionSets = [];\n        MetaDataFactory.getAll('optionSets').then(function(optionSets){\n            angular.forEach(optionSets, function(optionSet){  \n                $scope.optionSets[optionSet.id] = optionSet;\n            });\n            CurrentSelection.setOptionSets($scope.optionSets);\n        });\n    }\n    \n    //watch for selection of org unit from tree\n    $scope.$watch('selectedOrgUnit', function() {      \n        $scope.model.selectedProgram = null;\n        $scope.reportStarted = false;\n        $scope.dataReady = false;  \n        $scope.programStages = null;\n        $scope.stagesById = [];\n        if( angular.isObject($scope.selectedOrgUnit)){            \n            $scope.loadPrograms($scope.selectedOrgUnit);\n        }\n    });\n    \n    //load programs associated with the selected org unit.\n    $scope.loadPrograms = function(orgUnit) {        \n        $scope.selectedOrgUnit = orgUnit;        \n        if (angular.isObject($scope.selectedOrgUnit)){\n            ProgramFactory.getProgramsByOu($scope.selectedOrgUnit, $scope.model.selectedProgram).then(function(response){\n                $scope.programs = response.programs;\n                $scope.model.selectedProgram = response.selectedProgram;\n            });\n        }        \n    };\n    \n    $scope.$watch('model.selectedProgram', function() {        \n        $scope.programStages = null;\n        $scope.stagesById = [];\n        if( angular.isObject($scope.model.selectedProgram)){            \n            $scope.reportStarted = false;\n            $scope.dataReady = false;            \n            $scope.programStages = $scope.model.selectedProgram.programStages;\n            $scope.stagesById = [];\n            angular.forEach($scope.programStages, function(stage){\n                $scope.stagesById[stage.id] = stage;\n            });            \n        }\n    });\n    \n    $scope.generateReport = function(program, report, ouMode){\n        \n        $scope.model.selectedProgram = program;\n        $scope.report = report;\n        $scope.selectedOuMode = ouMode;\n        \n        //check for form validity\n        $scope.outerForm.submitted = true;        \n        if( $scope.outerForm.$invalid || !$scope.model.selectedProgram){\n            return false;\n        }\n        \n        $scope.reportStarted = true;\n        $scope.dataReady = false;\n            \n        AttributesFactory.getByProgram($scope.model.selectedProgram).then(function(atts){            \n            var grid = TEIGridService.generateGridColumns(atts, $scope.selectedOuMode.name,true);   \n            $scope.gridColumns = grid.columns;\n        });  \n        \n        EventReportService.getEventReport($scope.selectedOrgUnit.id, \n                                        $scope.selectedOuMode.name, \n                                        $scope.model.selectedProgram.id, \n                                        DateUtils.formatFromUserToApi($scope.report.startDate), \n                                        DateUtils.formatFromUserToApi($scope.report.endDate), \n                                        null,\n                                        null, \n                                        $scope.pager).then(function(data){\n            $scope.dhis2Events = [];  \n            $scope.teiList = [];\n            \n            if( data && data.eventRows ){\n                angular.forEach(data.eventRows, function(ev){\n                    if(ev.trackedEntityInstance){\n                        ev.name = $scope.stagesById[ev.programStage].displayName;\n                        ev.programName = $scope.model.selectedProgram.displayName;\n                        ev.statusColor = EventUtils.getEventStatusColor(ev); \n                        ev.eventDate = DateUtils.formatFromApiToUser(ev.eventDate);\n\n                        angular.forEach(ev.dataValues, function(dv){\n                            ev[dv.dataElement] = dv.value;\n                            $scope.stagesById[ev.programStage].hasData = true;\n                        });\n\n                        angular.forEach(ev.attributes, function(att){\n                            ev[att.attribute] = att.value;\n                        });\n\n                        if($scope.teiList.indexOf(ev.trackedEntityInstance) === -1){\n                            $scope.teiList.push( ev.trackedEntityInstance );\n                        }\n                        $scope.dhis2Events.push(ev);\n                    }\n                });\n            }\n            \n            $scope.reportStarted = false;\n            $scope.dataReady = true;            \n        });\n    };    \n});\n\n\n// WEBPACK FOOTER //\n// ./components/report/program-summary-controller.js","/* global trackerCapture, angular */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('ProgramStatisticsController',\n         function($scope,\n                DateUtils,                \n                EnrollmentService,\n                ProgramFactory,\n                DHIS2EventFactory) {\n    $scope.today = DateUtils.getToday();\n    \n    $scope.ouModes = [{name: 'SELECTED'}, {name: 'CHILDREN'}, {name: 'DESCENDANTS'}, {name: 'ACCESSIBLE'}];         \n    $scope.selectedOuMode = $scope.ouModes[0];\n    $scope.report = {};\n    $scope.maxOptionSize = 30;\n    $scope.model = {};\n    \n    $scope.displayMode = {};\n    $scope.printMode = false;\n    \n    //Paging\n    $scope.pager = {pageSize: 50, page: 1, toolBarDisplay: 5};\n    \n    function resetParams(){\n        $scope.reportStarted = false;\n        $scope.dataReady = false;\n    }\n    //watch for selection of org unit from tree\n    $scope.$watch('selectedOrgUnit', function() {      \n        resetParams();\n        $scope.model.selectedProgram = null;\n        if( angular.isObject($scope.selectedOrgUnit)){        \n            $scope.loadPrograms($scope.selectedOrgUnit);\n        }\n    });\n    \n    //load programs associated with the selected org unit.\n    $scope.loadPrograms = function(orgUnit) {        \n        $scope.selectedOrgUnit = orgUnit;        \n        if (angular.isObject($scope.selectedOrgUnit)){\n            ProgramFactory.getProgramsByOu($scope.selectedOrgUnit, $scope.model.selectedProgram).then(function(response){\n                $scope.programs = response.programs;\n                $scope.model.selectedProgram = response.selectedProgram;\n            });\n        }        \n    };    \n    \n    //watch for selection of program\n    $scope.$watch('model.selectedProgram', function() {   \n        if( angular.isObject($scope.model.selectedProgram)){            \n            resetParams();\n        }\n    });\n    \n    $scope.xFunction = function(){\n        return function(d) {\n            return d.key;\n        };\n    };\n    \n    $scope.yFunction = function(){\n        return function(d){\n            return d.y;\n        };\n    };\n\n    $scope.generateReport = function(program, report, ouMode){\n        \n        $scope.model.selectedProgram = program;\n        $scope.report = report;\n        $scope.selectedOuMode = ouMode;\n\n        //check for form validity\n        $scope.outerForm.submitted = true;        \n        if( $scope.outerForm.$invalid || !$scope.model.selectedProgram){\n            return false;\n        }\n        \n        $scope.dataReady = false;\n        $scope.reportStarted = true;        \n        \n\n        $scope.enrollments = {active: 0, completed: 0, cancelled: 0};\n        $scope.enrollmentList = [];\n        EnrollmentService.getByStartAndEndDate($scope.model.selectedProgram.id,\n                                        $scope.selectedOrgUnit.id, \n                                        $scope.selectedOuMode.name,\n                                        DateUtils.formatFromUserToApi($scope.report.startDate), \n                                        DateUtils.formatFromUserToApi($scope.report.endDate)).then(function(data){\n\n            if( data ) {\n                $scope.totalEnrollment = data.enrollments.length;                                \n                angular.forEach(data.enrollments, function(en){\n                    $scope.enrollmentList[en.enrollment] = en;\n                    if(en.status === 'ACTIVE'){\n                        $scope.enrollments.active++;\n                    }\n                    else if(en.status === 'COMPLETED'){\n                        $scope.enrollments.completed++;\n                    }\n                    else{\n                        $scope.enrollments.cancelled++;\n                    }\n                });\n\n                $scope.enrollmentStat = [{key: 'Completed', y: $scope.enrollments.completed},\n                                        {key: 'Active', y: $scope.enrollments.active},\n                                        {key: 'Cancelled', y: $scope.enrollments.cancelled}];\n\n                DHIS2EventFactory.getByOrgUnitAndProgram($scope.selectedOrgUnit.id, $scope.selectedOuMode.name, $scope.model.selectedProgram.id, null, null).then(function(data){\n                    \n                    if( data ) {\n                        $scope.dhis2Events = {completed: 0, active: 0, skipped: 0, overdue: 0, ontime: 0};\n                        $scope.totalEvents = 0;\n                        angular.forEach(data, function(ev){\n\n                            if(ev.trackedEntityInstance && $scope.enrollmentList[ev.enrollment]){                        \n\n                                $scope.totalEvents++;\n                                if(ev.status === 'COMPLETED'){\n                                    $scope.dhis2Events.completed++;\n                                }\n                                else if(ev.status === 'ACTIVE'){\n                                    $scope.dhis2Events.active++;\n                                }\n                                else if(ev.status === 'SKIPPED'){\n                                    $scope.dhis2Events.skipped++;\n                                }                        \n                                else{\n                                    if(ev.dueDate && moment($scope.today).isAfter(DateUtils.formatFromApiToUser(ev.dueDate))){\n                                        $scope.dhis2Events.overdue++;\n                                    }\n                                    else{\n                                        $scope.dhis2Events.ontime++;\n                                    }\n                                }\n                            }\n                        });\n                        $scope.eventStat = [{key: 'Completed', y: $scope.dhis2Events.completed},\n                                            {key: 'Active', y: $scope.dhis2Events.active},\n                                            {key: 'Skipped', y: $scope.dhis2Events.skipped},\n                                            {key: 'Ontime', y: $scope.dhis2Events.overdue},\n                                            {key: 'Overdue', y: $scope.dhis2Events.ontime}];         \n                    }\n                });            \n            }\n            \n            $scope.reportStarted = false;\n            $scope.dataReady = true; \n            \n        });\n    };    \n});\n\n\n// WEBPACK FOOTER //\n// ./components/report/program-statistics-controller.js","/* global angular, trackerCapture */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('OverdueEventsController',\n         function($scope,\n                $modal,\n                $location,\n                $translate,\n                DateUtils,\n                Paginator,\n                EventReportService,\n                TEIGridService,\n                AttributesFactory,\n                ProgramFactory,\n                CurrentSelection,\n                MetaDataFactory,\n                CommonUtils) {    \n    $scope.today = DateUtils.getToday();\n    \n    $scope.selectedOuMode = 'SELECTED';\n    $scope.report = {};\n    $scope.displayMode = {};\n    $scope.printMode = false;\n    $scope.model = {};\n    \n    \n    //get optionsets\n    $scope.optionSets = CurrentSelection.getOptionSets();\n    if(!$scope.optionSets){\n        $scope.optionSets = [];\n        MetaDataFactory.getAll('optionSets').then(function(optionSets){\n            angular.forEach(optionSets, function(optionSet){  \n                $scope.optionSets[optionSet.id] = optionSet;\n            });\n            CurrentSelection.setOptionSets($scope.optionSets);\n        });\n    }\n    \n    //get attributes\n    $scope.attributesById = CurrentSelection.getAttributesById();\n    if(!$scope.attributesById){\n        AttributesFactory.getAll().then(function(atts){\n            $scope.attributes = [];  \n            $scope.attributesById = [];\n            angular.forEach(atts, function(att){\n                $scope.attributesById[att.id] = att;\n            });\n            CurrentSelection.setAttributesById($scope.attributesById);\n        });\n    }    \n\n    //Paging\n    $scope.pager = {pageSize: 50, page: 1, toolBarDisplay: 5};   \n    \n    //watch for selection of org unit from tree\n    $scope.$watch('selectedOrgUnit', function() {\n        $scope.reportFinished = false;\n        $scope.reportStarted = false;        \n        if( angular.isObject($scope.selectedOrgUnit)){\n            $scope.loadPrograms();\n        }\n    });\n    \n    //load programs associated with the selected org unit.\n    $scope.loadPrograms = function() {\n        if (angular.isObject($scope.selectedOrgUnit)){\n            ProgramFactory.getAllForUser($scope.model.selectedProgram).then(function(response){\n                $scope.programs = response.programs;\n                $scope.model.selectedProgram = response.selectedProgram;\n            });\n        }\n    };\n    \n    //watch for selection of program\n    $scope.$watch('model.selectedProgram', function() {   \n        $scope.reportFinished = false;\n        $scope.reportStarted = false;        \n        if (angular.isObject($scope.model.selectedProgram)){\n            $scope.generateGridHeader();\n            $scope.generateReport();\n        }\n    });\n    \n    //watch for selection of ouMode\n    $scope.$watch('selectedOuMode', function() {   \n        $scope.reportFinished = false;\n        $scope.reportStarted = false;\n        if (angular.isObject($scope.model.selectedProgram)){\n            $scope.generateGridHeader();\n            $scope.generateReport();\n        }\n    });    \n    \n    $scope.generateReport = function(){\n        \n        if($scope.model.selectedProgram && $scope.selectedOuMode){\n            \n            $scope.reportFinished = false;\n            $scope.reportStarted = true;            \n            $scope.overdueEvents = [];\n            \n            EventReportService.getEventReport($scope.selectedOrgUnit.id, $scope.selectedOuMode, $scope.model.selectedProgram.id, null, null, 'ACTIVE','OVERDUE', $scope.pager).then(function(data){                \n                if( data ) {\n                    if( data.pager ){\n                        $scope.pager = data.pager;\n                        $scope.pager.toolBarDisplay = 5;\n\n                        Paginator.setPage($scope.pager.page);\n                        Paginator.setPageCount($scope.pager.pageCount);\n                        Paginator.setPageSize($scope.pager.pageSize);\n                        Paginator.setItemCount($scope.pager.total);                    \n                    }\n\n                    angular.forEach(data.eventRows, function(row){\n                        var overdueEvent = {};                    \n                        angular.forEach(row.attributes, function(att){\n                            if( att.attribute && $scope.attributesById[att.attribute] ){\n                                att.value = CommonUtils.formatDataValue(null, att.value, $scope.attributesById[att.attribute], $scope.optionSets, 'USER');                \n                            }\n                            overdueEvent[att.attribute] = att.value;                        \n                        });\n\n                        overdueEvent.dueDate = DateUtils.formatFromApiToUser(row.dueDate);\n                        overdueEvent.event = row.event;\n                        overdueEvent.eventName = $scope.programStages[row.programStage].displayName;\n                        overdueEvent.orgUnitName = row.orgUnitName;                    \n                        overdueEvent.followup = row.followup;\n                        overdueEvent.program = row.program;\n                        overdueEvent.programStage = row.programStage;\n                        overdueEvent.trackedEntityInstance = row.trackedEntityInstance;\n                        $scope.overdueEvents.push(overdueEvent);\n\n                    });\n\n                    //sort overdue events by their due dates - this is default\n                    if(!$scope.sortColumn.id){                                      \n                        $scope.sortGrid({id: 'dueDate', displayName: $translate.instant('due_date'), valueType: 'DATE', displayInListNoProgram: false, showFilter: false, show: true});\n                        $scope.reverse = false;\n                    }\n                }                \n                $scope.reportFinished = true;\n                $scope.reportStarted = false;                \n            });\n        }\n    };    \n    \n    $scope.generateGridHeader = function(){\n        \n        if (angular.isObject($scope.model.selectedProgram)){\n            \n            $scope.programStages = [];\n            $scope.sortColumn = {};\n            $scope.filterTypes = {};\n            $scope.filterText = {};\n            $scope.reverse = false;\n\n            angular.forEach($scope.model.selectedProgram.programStages, function(stage){\n                $scope.programStages[stage.id] = stage;\n            });\n\n            AttributesFactory.getByProgram($scope.model.selectedProgram).then(function(atts){            \n                var grid = TEIGridService.generateGridColumns(atts, $scope.selectedOuMode,true);\n                $scope.gridColumns = [];\n                $scope.gridColumns.push({displayName: $translate.instant('due_date'), id: 'dueDate', valueType: 'DATE', displayInListNoProgram: false, showFilter: false, show: true, eventCol: true});\n                $scope.gridColumns.push({displayName: $translate.instant('event_name'), id: 'eventName', valueType: 'TEXT', displayInListNoProgram: false, showFilter: false, show: true, eventCol: true});\n                $scope.gridColumns = $scope.gridColumns.concat(grid.columns);\n                \n                $scope.filterTypes['eventName'] = 'TEXT';                \n                $scope.filterTypes['dueDate'] = 'DATE';\n                $scope.filterText['dueDate']= {};\n                \n                angular.forEach($scope.gridColumns, function(col){\n                    col.eventCol = false;\n                });\n            });            \n        }      \n    };\n    \n    $scope.showHideColumns = function(){\n        \n        $scope.hiddenGridColumns = 0;\n        \n        angular.forEach($scope.gridColumns, function(gridColumn){\n            if(!gridColumn.show){\n                $scope.hiddenGridColumns++;\n            }\n        });\n        \n        var modalInstance = $modal.open({\n            templateUrl: 'views/column-modal.html',\n            controller: 'ColumnDisplayController',\n            resolve: {\n                gridColumns: function () {\n                    return $scope.gridColumns;\n                },\n                hiddenGridColumns: function(){\n                    return $scope.hiddenGridColumns;\n                }\n            }\n        });\n\n        modalInstance.result.then(function (gridColumns) {\n            $scope.gridColumns = gridColumns;\n        }, function () {\n        });\n    };\n\n    //sortGrid\n    $scope.sortGrid = function(gridHeader){\n        if ($scope.sortColumn && $scope.sortColumn.id === gridHeader.id){\n            $scope.reverse = !$scope.reverse;\n            return;\n        }        \n        $scope.sortColumn = gridHeader;\n        if($scope.sortColumn.valueType === 'DATE'){\n            $scope.reverse = true;\n        }\n        else{\n            $scope.reverse = false;    \n        }\n    };\n    \n    \n    $scope.d2Sort = function(overDueEvent){ \n        if($scope.sortColumn && $scope.sortColumn.valueType === 'DATE'){            \n            var d = overDueEvent[$scope.sortColumn.id];         \n            return DateUtils.getDate(d);\n        }\n        return overDueEvent[$scope.sortColumn.id];\n    };\n    \n    \n    $scope.searchInGrid = function(gridColumn){\n        \n        $scope.currentFilter = gridColumn;\n       \n        for(var i=0; i<$scope.gridColumns.length; i++){\n            \n            //toggle the selected grid column's filter\n            if($scope.gridColumns[i].id === gridColumn.id){\n                $scope.gridColumns[i].showFilter = !$scope.gridColumns[i].showFilter;\n            }            \n            else{\n                $scope.gridColumns[i].showFilter = false;\n            }\n        }\n    };    \n    \n    $scope.removeStartFilterText = function(gridColumnId){\n        $scope.filterText[gridColumnId].start = undefined;\n    };\n    \n    $scope.removeEndFilterText = function(gridColumnId){\n        $scope.filterText[gridColumnId].end = undefined;\n    };\n    \n    $scope.showDashboard = function(tei){\n        $location.path('/dashboard').search({tei: tei,\n            program: $scope.model.selectedProgram ? $scope.model.selectedProgram.id: null,\n            ou:$scope.selectedOrgUnit.id});\n    };\n    \n    $scope.generateReportData = function(){\n        return TEIGridService.getData($scope.overdueEvents, $scope.gridColumns);\n    };\n    \n    $scope.generateReportHeader = function(){\n        return TEIGridService.getHeader($scope.gridColumns);\n    };\n    \n    $scope.jumpToPage = function(){\n        $scope.generateReport();\n    };\n    \n    $scope.resetPageSize = function(){\n        $scope.pager.page = 1;        \n        $scope.generateReport();\n    };\n    \n    $scope.getPage = function(page){    \n        $scope.pager.page = page;\n        $scope.generateReport();\n    };\n});\n\n\n// WEBPACK FOOTER //\n// ./components/report/overdue-events-controller.js","/* global trackerCapture */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('UpcomingEventsController',\n         function($scope,\n                $modal,\n                $location,\n                $translate,\n                DateUtils,\n                Paginator,\n                EventReportService,\n                TEIGridService,\n                AttributesFactory,\n                ProgramFactory,\n                CurrentSelection,\n                MetaDataFactory,\n                CommonUtils) {\n    $scope.today = DateUtils.getToday();\n    $scope.selectedOuMode = 'SELECTED';\n    $scope.report = {};\n    $scope.displayMode = {};\n    $scope.printMode = false;\n    $scope.model = {};\n    //get optionsets\n    $scope.optionSets = CurrentSelection.getOptionSets();\n    if(!$scope.optionSets){\n        $scope.optionSets = [];\n        MetaDataFactory.getAll('optionSets').then(function(optionSets){\n            angular.forEach(optionSets, function(optionSet){  \n                $scope.optionSets[optionSet.id] = optionSet;\n            });\n            CurrentSelection.setOptionSets($scope.optionSets);\n        });\n    }\n    \n    //get attributes\n    $scope.attributesById = CurrentSelection.getAttributesById();\n    if(!$scope.attributesById){\n        AttributesFactory.getAll().then(function(atts){\n            $scope.attributes = [];  \n            $scope.attributesById = [];\n            angular.forEach(atts, function(att){\n                $scope.attributesById[att.id] = att;\n            });\n            CurrentSelection.setAttributesById($scope.attributesById);\n        });\n    }\n    \n    //Paging\n    $scope.pager = {pageSize: 50, page: 1, toolBarDisplay: 5};\n    \n    //watch for selection of org unit from tree\n    $scope.$watch('selectedOrgUnit', function() {\n        if( angular.isObject($scope.selectedOrgUnit)){            \n            $scope.loadPrograms();\n        }\n    });\n    \n    //load programs associated with the selected org unit.\n    $scope.loadPrograms = function() {\n        if (angular.isObject($scope.selectedOrgUnit)){\n            ProgramFactory.getAllForUser($scope.model.selectedProgram).then(function(response){\n                $scope.programs = response.programs;\n                $scope.model.selectedProgram = response.selectedProgram;\n            });\n        }        \n    };\n    \n    //watch for selection of program\n    $scope.$watchCollection('[model.selectedProgram, selectedOuMode]', function () {\n        $scope.reportFinished = false;\n        $scope.reportStarted = false;\n        \n        if (angular.isObject($scope.model.selectedProgram)){\n            $scope.generateGridHeader();\n        }\n    });\n    \n    $scope.generateReport = function(){\n        \n        //check for form validity\n        $scope.outerForm.submitted = true;        \n        if( $scope.outerForm.$invalid || !$scope.model.selectedProgram){\n            return false;\n        }\n        \n        $scope.reportFinished = false;\n        $scope.reportStarted = true;        \n        \n        $scope.upcomingEvents = [];\n        EventReportService.getEventReport($scope.selectedOrgUnit.id, \n                                        $scope.selectedOuMode, \n                                        $scope.model.selectedProgram.id, \n                                        DateUtils.formatFromUserToApi($scope.report.startDate), \n                                        DateUtils.formatFromUserToApi($scope.report.endDate), \n                                        'ACTIVE',\n                                        'SCHEDULE', \n                                        $scope.pager).then(function(data){            \n            if( data ) {\n                if( data.pager ){\n                    $scope.pager = data.pager;\n                    $scope.pager.toolBarDisplay = 5;\n\n                    Paginator.setPage($scope.pager.page);\n                    Paginator.setPageCount($scope.pager.pageCount);\n                    Paginator.setPageSize($scope.pager.pageSize);\n                    Paginator.setItemCount($scope.pager.total);                    \n                }\n\n                angular.forEach(data.eventRows, function(row){\n                    var upcomingEvent = {};\n                    angular.forEach(row.attributes, function(att){\n                        if( att.attribute && $scope.attributesById[att.attribute] ){\n                            att.value = CommonUtils.formatDataValue(null, att.value, $scope.attributesById[att.attribute], $scope.optionSets, 'USER');                \n                        }\n                        upcomingEvent[att.attribute] = att.value;                        \n                    });\n\n                    upcomingEvent.dueDate = DateUtils.formatFromApiToUser(row.dueDate);\n                    upcomingEvent.event = row.event;\n                    upcomingEvent.eventName = $scope.programStages[row.programStage].displayName;                    \n                    upcomingEvent.orgUnitName = row.orgUnitName; \n                    upcomingEvent.followup = row.followup;\n                    upcomingEvent.program = row.program;\n                    upcomingEvent.programStage = row.programStage;\n                    upcomingEvent.trackedEntityInstance = row.trackedEntityInstance;                \n                    upcomingEvent.created = DateUtils.formatFromApiToUser(row.registrationDate);;\n                    $scope.upcomingEvents.push(upcomingEvent);\n\n                });\n\n                //sort upcoming events by their due dates - this is default\n                if(!$scope.sortColumn.id){                                      \n                    $scope.sortGrid({id: 'dueDate', displayName: $translate.instant('due_date'), valueType: 'DATE', displayInListNoProgram: false, showFilter: false, show: true});\n                    $scope.reverse = false;\n                }\n            }\n\n            $scope.reportFinished = true;\n            $scope.reportStarted = false;\n        });\n    };\n    \n    $scope.generateGridHeader = function(){\n        \n        if (angular.isObject($scope.model.selectedProgram)){\n            \n            $scope.programStages = [];\n            $scope.sortColumn = {};\n            $scope.filterTypes = {};\n            $scope.filterText = {};\n            $scope.reverse = false;;\n\n            angular.forEach($scope.model.selectedProgram.programStages, function(stage){\n                $scope.programStages[stage.id] = stage;\n            });\n\n            \n            AttributesFactory.getByProgram($scope.model.selectedProgram).then(function(atts){            \n                var grid = TEIGridService.generateGridColumns(atts, $scope.selectedOuMode, true);\n                \n                $scope.gridColumns = [];\n                $scope.gridColumns.push({displayName: $translate.instant('due_date'), id: 'dueDate', valueType: 'DATE', displayInListNoProgram: false, showFilter: false, show: true, eventCol: true});\n                $scope.gridColumns.push({displayName: $translate.instant('event_name'), id: 'eventName', valueType: 'TEXT', displayInListNoProgram: false, showFilter: false, show: true, eventCol: true});\n                $scope.gridColumns = $scope.gridColumns.concat(grid.columns);\n                \n                $scope.filterTypes['eventName'] = 'TEXT';                \n                $scope.filterTypes['dueDate'] = 'DATE';\n                $scope.filterText['dueDate']= {};\n                \n                angular.forEach($scope.gridColumns, function(col){\n                    col.eventCol = false;\n                });                \n            });            \n        }      \n    };\n    \n    $scope.showHideColumns = function(){\n        \n        $scope.hiddenGridColumns = 0;\n        \n        angular.forEach($scope.gridColumns, function(gridColumn){\n            if(!gridColumn.show){\n                $scope.hiddenGridColumns++;\n            }\n        });\n        \n        var modalInstance = $modal.open({\n            templateUrl: 'views/column-modal.html',\n            controller: 'ColumnDisplayController',\n            resolve: {\n                gridColumns: function () {\n                    return $scope.gridColumns;\n                },\n                hiddenGridColumns: function(){\n                    return $scope.hiddenGridColumns;\n                }\n            }\n        });\n\n        modalInstance.result.then(function (gridColumns) {\n            $scope.gridColumns = gridColumns;\n        }, function () {\n        });\n    };\n    \n    $scope.sortGrid = function(gridHeader){\n        if ($scope.sortColumn && $scope.sortColumn.id === gridHeader.id){\n            $scope.reverse = !$scope.reverse;\n            return;\n        }        \n        $scope.sortColumn = gridHeader;\n        if($scope.sortColumn.valueType === 'DATE'){\n            $scope.reverse = true;\n        }\n        else{\n            $scope.reverse = false;    \n        }\n    };\n    \n    $scope.d2Sort = function(upcomingDueEvent){ \n        if($scope.sortColumn && $scope.sortColumn.valueType === 'DATE'){            \n            var d = upcomingDueEvent[$scope.sortColumn.id];         \n            return DateUtils.getDate(d);\n        }\n        return upcomingDueEvent[$scope.sortColumn.id];\n    };\n    \n    $scope.searchInGrid = function(gridColumn){\n        \n        $scope.currentFilter = gridColumn;\n       \n        for(var i=0; i<$scope.gridColumns.length; i++){\n            \n            //toggle the selected grid column's filter\n            if($scope.gridColumns[i].id === gridColumn.id){\n                $scope.gridColumns[i].showFilter = !$scope.gridColumns[i].showFilter;\n            }            \n            else{\n                $scope.gridColumns[i].showFilter = false;\n            }\n        }\n    };    \n    \n    $scope.removeStartFilterText = function(gridColumnId){\n        $scope.filterText[gridColumnId].start = undefined;\n    };\n    \n    $scope.removeEndFilterText = function(gridColumnId){\n        $scope.filterText[gridColumnId].end = undefined;\n    };\n    \n    $scope.showDashboard = function(tei){\n        $location.path('/dashboard').search({tei: tei,\n            program: $scope.model.selectedProgram ? $scope.model.selectedProgram.id: null,\n            ou:$scope.selectedOrgUnit.id});\n    };\n    \n    $scope.generateReportData = function(){\n        return TEIGridService.getData($scope.upcomingEvents, $scope.gridColumns);\n    };\n\n\n    $scope.dates=[ {\"name\":$translate.instant('events_today'), \"numOfDays\":1},\n                     {\"name\":$translate.instant('events_in_one_week'), \"numOfDays\":7},\n                     {\"name\":$translate.instant('events_in_two_weeks'), \"numOfDays\":14},\n                     {\"name\":$translate.instant('events_in_one_month'), \"numOfDays\":30},\n                     {\"name\":$translate.instant('choose_the_dates')}\n    ];\n\n    $scope.selectedDate = $scope.dates[0];\n\n    $scope.datePicker = {\"visible\":false};\n\n    $scope.$watch('selectedDate',function() {\n        var numOfDays = $scope.selectedDate.numOfDays;\n        $scope.report.startDate = $scope.today;\n        if ($scope.selectedDate) {\n            if (numOfDays) {\n                $scope.datePicker.visible = false;\n                if (numOfDays === 1) {\n                    $scope.report.endDate = $scope.today;\n                } else {\n                    $scope.report.endDate = DateUtils.getDateAfterOffsetDays(numOfDays);\n                }\n            } else {\n                $scope.datePicker.visible = true;\n            }\n        }\n    });\n\n    $scope.hideDatePicker = function(){\n        $scope.datePicker.visible = !$scope.datePicker.visible;\n        $scope.selectedDate = $scope.dates[0];\n    };\n    \n    $scope.generateReportHeader = function(){\n        return TEIGridService.getHeader($scope.gridColumns);\n    };\n    \n    $scope.jumpToPage = function(){\n        $scope.generateReport();\n    };\n    \n    $scope.resetPageSize = function(){\n        $scope.pager.page = 1;        \n        $scope.generateReport();\n    };\n    \n    $scope.getPage = function(page){    \n        $scope.pager.page = page;\n        $scope.generateReport();\n    };\n    \n    $scope.interacted = function(field) {\n        var status = false;\n        if(field){            \n            status = $scope.outerForm.submitted || field.$dirty;\n        }\n        return status;        \n    };\n});\n\n\n// WEBPACK FOOTER //\n// ./components/report/upcoming-events-controller.js","/* global trackerCapture */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('SelectedInfoController',\n        function($scope,\n                CurrentSelection,\n                OrgUnitFactory,\n                $location) {\n    //listen for the selected items\n    $scope.$on('selectedItems', function(event, args) {\n       \n        var selections = CurrentSelection.get();\n        $scope.selectedEntity = selections.tei;\n        $scope.selectedProgram = selections.pr;\n\n        OrgUnitFactory.getOrgUnit(($location.search()).ou).then(function(orgUnit) {\n            $scope.selectedOrgUnit = orgUnit;\n            $scope.selections = [];\n\n            $scope.selections.push({title: 'org_unit', value: $scope.selectedOrgUnit ? $scope.selectedOrgUnit.displayName : 'not_selected'});\n            $scope.selections.push({title: 'program', value: $scope.selectedProgram ? $scope.selectedProgram.displayName : 'not_selected'});\n        });\n    });\n});\n\n\n// WEBPACK FOOTER //\n// ./components/selected/selected-controller.js","/* global trackerCapture, angular */\r\n\r\nvar trackerCapture = angular.module('trackerCapture');\r\ntrackerCapture.controller('RelationshipController',\r\n        function($scope,\r\n                $rootScope,\r\n                $modal,                \r\n                $location,\r\n                TEIService,\r\n                AttributesFactory,\r\n                CurrentSelection,\r\n                RelationshipFactory,\r\n                OrgUnitFactory,\r\n                ModalService,\r\n                CommonUtils) {\r\n    $rootScope.showAddRelationshipDiv = false;\r\n    $scope.relatedProgramRelationship = false;\r\n    \r\n    //listen for the selected entity       \r\n    $scope.$on('dashboardWidgets', function(event, args) { \r\n        $scope.relationshipTypes = []; \r\n        $scope.relationships = [];\r\n        $scope.relatedTeis = [];\r\n        $scope.selections = CurrentSelection.get();\r\n        $scope.optionSets = $scope.selections.optionSets;\r\n        $scope.selectedTei = angular.copy($scope.selections.tei);        \r\n        $scope.attributesById = CurrentSelection.getAttributesById();\r\n        \r\n        $scope.attributes = [];\r\n        for(var key in $scope.attributesById){\r\n            if($scope.attributesById.hasOwnProperty(key)){\r\n                $scope.attributes.push($scope.attributesById[key]);\r\n            }            \r\n        }\r\n        \r\n        $scope.trackedEntity = $scope.selections.te;\r\n        $scope.selectedEnrollment = $scope.selections.selectedEnrollment;\r\n        $scope.selectedProgram = $scope.selections.pr;\r\n        $scope.programs = $scope.selections.pr;\r\n        \r\n        RelationshipFactory.getAll().then(function(rels){\r\n            $scope.relationshipTypes = rels;    \r\n            angular.forEach(rels, function(rel){\r\n                $scope.relationships[rel.id] = rel;\r\n            });\r\n            setRelationships();\r\n        });\r\n        $scope.selectedOrgUnit = $scope.selections.orgUnit;\r\n    });\r\n    \r\n    $scope.showAddRelationship = function(related) {\r\n        $scope.relatedProgramRelationship = related;\r\n        $rootScope.showAddRelationshipDiv = !$rootScope.showAddRelationshipDiv;\r\n       \r\n        if($rootScope.showAddRelationshipDiv){\r\n            var modalInstance = $modal.open({\r\n                templateUrl: 'components/teiadd/tei-add.html',\r\n                controller: 'TEIAddController',\r\n                windowClass: 'modal-full-window',\r\n                resolve: {\r\n                    relationshipTypes: function () {\r\n                        return $scope.relationshipTypes;\r\n                    },\r\n                    selectedAttribute: function(){\r\n                        return null;\r\n                    },\r\n                    existingAssociateUid: function(){\r\n                        return null;\r\n                    },\r\n                    addingRelationship: function(){\r\n                        return true;\r\n                    },\r\n                    selections: function () {\r\n                        return $scope.selections;\r\n                    },\r\n                    selectedTei: function(){\r\n                        return $scope.selectedTei;\r\n                    },\r\n                    selectedProgram: function(){\r\n                        return $scope.selectedProgram;\r\n                    },\r\n                    relatedProgramRelationship: function(){\r\n                        return $scope.relatedProgramRelationship;\r\n                    }\r\n                }\r\n            });\r\n\r\n            modalInstance.result.then(function (relationships) {\r\n                $scope.selectedTei.relationships = relationships;                \r\n                setRelationships();\r\n            });\r\n        }\r\n    };\r\n    \r\n    $scope.removeRelationship = function(rel){\r\n        \r\n        var modalOptions = {\r\n            closeButtonText: 'cancel',\r\n            actionButtonText: 'delete',\r\n            headerText: 'delete',\r\n            bodyText: 'are_you_sure_to_delete_relationship'\r\n        };\r\n\r\n        ModalService.showModal({}, modalOptions).then(function(result){\r\n            \r\n            var index = -1;\r\n            for(var i=0; i<$scope.selectedTei.relationships.length; i++){\r\n                if($scope.selectedTei.relationships[i].relationship === rel.relId){\r\n                    index = i;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if( index !== -1 ){\r\n                $scope.selectedTei.relationships.splice(index,1);\r\n                var trimmedTei = angular.copy($scope.selectedTei);\r\n                angular.forEach(trimmedTei.relationships, function(rel){\r\n                    delete rel.relative;\r\n                });\r\n                TEIService.update(trimmedTei, $scope.optionSets, $scope.attributesById).then(function(response){\r\n                    if(!response || response.response && response.response.status !== 'SUCCESS'){//update has failed\r\n                        return;\r\n                    }\r\n                    setRelationships();\r\n                });\r\n            }\r\n        });        \r\n    };\r\n    \r\n    $scope.showDashboard = function(teiId, relId){\r\n        \r\n        var dashboardProgram = null;\r\n        \r\n        if($scope.selectedProgram && $scope.selectedProgram.relationshipType){\r\n            if($scope.selectedProgram.relationshipType.id === relId && $scope.selectedProgram.relatedProgram ){\r\n                dashboardProgram = $scope.selectedProgram.relatedProgram.id;\r\n            }\r\n        }        \r\n    \r\n        $location.path('/dashboard').search({tei: teiId, program: dashboardProgram, ou: $scope.selectedOrgUnit.id}); \r\n    };\r\n    \r\n    var setRelationships = function(){\r\n        $scope.relatedTeis = [];\r\n        angular.forEach($scope.selectedTei.relationships, function(rel){\r\n            var teiId = rel.trackedEntityInstanceA;\r\n            var relName = $scope.relationships[rel.relationship].aIsToB;\r\n            if($scope.selectedTei.trackedEntityInstance === rel.trackedEntityInstanceA){\r\n                teiId = rel.trackedEntityInstanceB;\r\n                relName = $scope.relationships[rel.relationship].bIsToA;\r\n            }\r\n            var relative = {trackedEntityInstance: teiId, relName: relName, relId: rel.relationship, attributes: getRelativeAttributes(rel)};            \r\n            $scope.relatedTeis.push(relative);\r\n        });\r\n        \r\n        var selections = CurrentSelection.get();\r\n        CurrentSelection.set({tei: $scope.selectedTei, te: $scope.selectedTei.trackedEntity, prs: selections.prs, pr: $scope.selectedProgram, prNames: selections.prNames, prStNames: selections.prStNames, enrollments: selections.enrollments, selectedEnrollment: $scope.selectedEnrollment, optionSets: selections.optionSets, orgUnit:selections.orgUnit});       \r\n    };\r\n    \r\n    var getRelativeAttributes = function(tei){\r\n        \r\n        var attributes = {};\r\n        \r\n        if(tei && tei.relative && tei.relative.attributes && !tei.relative.processed){\r\n            angular.forEach(tei.relative.attributes, function(att){                \r\n                if( att.attribute && $scope.attributesById[att.attribute] ){\r\n                    att.value = CommonUtils.formatDataValue(null, att.value, $scope.attributesById[att.attribute], $scope.optionSets, 'USER');                \r\n                }                \r\n                attributes[att.attribute] = att.value;\r\n            });\r\n        }\r\n        \r\n        if(tei && tei.relative && tei.relative.processed){\r\n            attributes = tei.relative.attributes;\r\n        }\r\n        \r\n        return attributes;\r\n    };\r\n});\n\n\n// WEBPACK FOOTER //\n// ./components/relationship/relationship-controller.js","/* global trackerCapture, angular */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('TEIAddController', \n    function($scope, \n            $rootScope,\n            $translate,\n            $modalInstance, \n            $location,\n            DateUtils,\n            CurrentSelection,\n            OperatorFactory,\n            AttributesFactory,\n            EntityQueryFactory,\n            OrgUnitFactory,\n            ProgramFactory,\n            MetaDataFactory,\n            TEIService,\n            TEIGridService,\n            NotificationService,\n            Paginator,\n            relationshipTypes,\n            selectedProgram,\n            relatedProgramRelationship,\n            selections,\n            selectedAttribute,\n            existingAssociateUid,\n            addingRelationship,\n            selectedTei){\n    var selection = CurrentSelection.get();\n    $scope.attributesById = CurrentSelection.getAttributesById();\n    if(!$scope.attributesById){\n        $scope.attributesById = [];\n        AttributesFactory.getAll().then(function(atts){\n            angular.forEach(atts, function(att){\n                $scope.attributesById[att.id] = att;\n            });\n            \n            CurrentSelection.setAttributesById($scope.attributesById);\n        });\n    }    \n    \n    $scope.optionSets = CurrentSelection.getOptionSets();        \n    if(!$scope.optionSets){\n        $scope.optionSets = [];\n        MetaDataFactory.getAll('optionSets').then(function(optionSets){\n            angular.forEach(optionSets, function(optionSet){                        \n                $scope.optionSets[optionSet.id] = optionSet;\n            });\n\n            CurrentSelection.setOptionSets($scope.optionSets);\n        });\n    }\n    \n    $scope.today = DateUtils.getToday();\n    $scope.relationshipTypes = relationshipTypes;\n    $scope.addingRelationship = addingRelationship;\n    $scope.selectedAttribute = selectedAttribute;\n    $scope.selectedProgram = selectedProgram;\n    $scope.relatedProgramRelationship = relatedProgramRelationship;\n    $scope.mainTei = selectedTei;    \n    $scope.attributesById = CurrentSelection.getAttributesById();\n    $scope.addingTeiAssociate = false;\n    \n    $scope.searchOuTree = false;\n    $scope.orgUnitLabel = $translate.instant('org_unit');\n    \n    $scope.selectedRelationship = {};\n    $scope.relationship = {};\n    \n    var invalidTeis = $scope.addingRelationship ? [$scope.mainTei.trackedEntityInstance] : [];\n    if($scope.mainTei.relationships && $scope.addingRelationship){\n        angular.forEach($scope.mainTei.relationships, function(rel){\n            invalidTeis.push(rel.trackedEntityInstanceB);\n        });\n    }\n\n\n        $scope.selectedOrgUnit = selection.orgUnit;\n        $scope.selectedEnrollment = {\n            enrollmentDate: $scope.today,\n            incidentDate: $scope.today,\n            orgUnitName: $scope.selectedOrgUnit.displayName\n        };\n\n        //Selections\n        $scope.selectedTeiForDisplay = angular.copy($scope.mainTei);\n        $scope.ouModes = [{name: 'SELECTED'}, {name: 'CHILDREN'}, {name: 'DESCENDANTS'}, {name: 'ACCESSIBLE'}];\n        $scope.selectedOuMode = $scope.ouModes[0];\n\n        //Paging\n        $scope.pager = {pageSize: 50, page: 1, toolBarDisplay: 5};\n\n        //Searching\n        $scope.showAdvancedSearchDiv = false;\n        $scope.searchText = {value: null};\n        $scope.emptySearchText = false;\n        $scope.searchFilterExists = false;\n        $scope.defaultOperators = OperatorFactory.defaultOperators;\n        $scope.boolOperators = OperatorFactory.boolOperators;\n        $scope.selectedTrackedEntity = null;\n\n        $scope.trackedEntityList = null;\n        $scope.enrollment = {programStartDate: '', programEndDate: '', operator: $scope.defaultOperators[0]};\n\n        $scope.searchMode = {listAll: 'LIST_ALL', freeText: 'FREE_TEXT', attributeBased: 'ATTRIBUTE_BASED'};\n        $scope.selectedSearchMode = $scope.searchMode.listAll;\n\n        if ($scope.addingRelationship) {\n            $scope.teiAddLabel = $translate.instant('add_relationship');\n            $scope.programs = selections.prs;\n            CurrentSelection.setRelationshipOwner($scope.mainTei);\n        }\n        else {\n            $scope.teiAddLabel = $scope.selectedAttribute && $scope.selectedAttribute.displayName ? $scope.selectedAttribute.displayName : $translate.instant('tracker_associate');\n            $scope.addingTeiAssociate = true;\n            ProgramFactory.getProgramsByOu($scope.selectedOrgUnit, $scope.selectedProgram).then(function (response) {\n                $scope.programs = response.programs;\n                if ($scope.selectedAttribute && $scope.selectedAttribute.trackedEntity && $scope.selectedAttribute.trackedEntity.id) {\n                    $scope.programs = [];\n                    angular.forEach(response.programs, function (pr) {\n                        if (pr.trackedEntity && pr.trackedEntity.id === $scope.selectedAttribute.trackedEntity.id) {\n                            $scope.programs.push(pr);\n                        }\n                    });\n                }\n                $scope.selectedProgram = response.selectedProgram;\n            });\n\n            if (existingAssociateUid) {\n                TEIService.get(existingAssociateUid, $scope.optionSets, $scope.attributesById).then(function (data) {\n                    $scope.selectedTeiForDisplay = data;\n                });\n            }\n            else {\n                $scope.selectedTeiForDisplay = null;\n            }\n\n            CurrentSelection.setRelationshipOwner({});\n\n            if ($scope.selectedAttribute && $scope.selectedAttribute.trackedEntity && $scope.selectedAttribute.trackedEntity.id) {\n                $scope.selectedTrackedEntity = $scope.selectedAttribute.trackedEntity;\n            }\n        }\n\n        if (angular.isObject($scope.programs) && $scope.programs.length === 1) {\n            $scope.selectedProgramForRelative = $scope.programs[0];\n        }\n\n        if ($scope.selectedProgram) {\n            if ($scope.selectedProgram.relatedProgram && $scope.relatedProgramRelationship) {\n                angular.forEach($scope.programs, function (pr) {\n                    if (pr.id === $scope.selectedProgram.relatedProgram.id) {\n                        $scope.selectedProgramForRelative = pr;\n                    }\n                });\n            }\n\n            if ($scope.selectedProgram.relationshipType) {\n                angular.forEach($scope.relationshipTypes, function (rel) {\n                    if (rel.id === $scope.selectedProgram.relationshipType.id) {\n                        $scope.relationship.selected = rel;\n                    }\n                });\n            }\n        }\n\n        //watch for selection of relationship\n        $scope.$watch('relationship.selected', function () {\n            if (angular.isObject($scope.relationship.selected)) {\n                $scope.selectedRelationship = {\n                    aIsToB: $scope.relationship.selected.aIsToB,\n                    bIsToA: $scope.relationship.selected.bIsToA\n                };\n            }\n        });\n\n        function resetFields() {\n\n            $scope.teiForRelationship = null;\n            $scope.teiFetched = false;\n            $scope.emptySearchText = false;\n            $scope.emptySearchAttribute = false;\n            $scope.showAdvancedSearchDiv = false;\n            $scope.showRegistrationDiv = false;\n            $scope.showTrackedEntityDiv = false;\n            $scope.trackedEntityList = null;\n            $scope.teiCount = null;\n\n            $scope.queryUrl = null;\n            $scope.programUrl = null;\n            $scope.attributeUrl = {url: null, hasValue: false};\n            $scope.sortColumn = {};\n        }\n\n        //listen for selections\n        $scope.$on('relationship', function (event, args) {\n            if (args.result === 'SUCCESS') {\n                var relationshipInfo = CurrentSelection.getRelationshipInfo();\n                $scope.teiForRelationship = relationshipInfo.tei;\n                $scope.addRelationship();\n            }\n\n            if (args.result === 'CANCEL') {\n                $scope.showRegistration();\n            }\n        });\n\n        //sortGrid\n        $scope.sortGrid = function (gridHeader) {\n            if ($scope.sortColumn && $scope.sortColumn.id === gridHeader.id) {\n                $scope.reverse = !$scope.reverse;\n                return;\n            }\n            $scope.sortColumn = gridHeader;\n            if ($scope.sortColumn.valueType === 'date') {\n                $scope.reverse = true;\n            }\n            else {\n                $scope.reverse = false;\n            }\n        };\n\n        $scope.d2Sort = function (tei) {\n            if ($scope.sortColumn && $scope.sortColumn.valueType === 'date') {\n                var d = tei[$scope.sortColumn.id];\n                return DateUtils.getDate(d);\n            }\n            return tei[$scope.sortColumn.id];\n        };\n\n        $scope.search = function (mode) {\n\n            resetFields();\n\n            $scope.selectedSearchMode = mode;\n\n            if ($scope.selectedProgramForRelative) {\n                $scope.programUrl = 'program=' + $scope.selectedProgramForRelative.id;\n            }\n\n            //check search mode\n            if ($scope.selectedSearchMode === $scope.searchMode.freeText) {\n\n                if (!$scope.searchText.value) {\n                    $scope.emptySearchText = true;\n                    $scope.teiFetched = false;\n                    $scope.teiCount = null;\n                    return;\n                }\n\n                $scope.queryUrl = 'query=LIKE:' + $scope.searchText.value;\n            }\n\n            if ($scope.selectedSearchMode === $scope.searchMode.attributeBased) {\n                $scope.searchText.value = null;\n                $scope.attributeUrl = EntityQueryFactory.getAttributesQuery($scope.attributes, $scope.enrollment);\n\n                if (!$scope.attributeUrl.hasValue && !$scope.selectedProgramForRelative) {\n                    $scope.emptySearchAttribute = true;\n                    $scope.teiFetched = false;\n                    $scope.teiCount = null;\n                    return;\n                }\n            }\n\n            if ($scope.addingTeiAssociate) {\n                if (!$scope.selectedTrackedEntity || !$scope.selectedTrackedEntity.id) {\n                    NotificationService.showNotifcationDialog($translate.instant(\"searching_error\"),\n                        $translate.instant(\"no_entity_for_tracker_associate_attribute\"));\n                    $scope.teiFetched = true;\n                    return;\n                }\n\n                //$scope.programUrl = 'trackedEntity=' + $scope.selectedTrackedEntity.id;\n            }\n\n            $scope.fetchTei();\n        };\n\n        $scope.fetchTei = function () {\n\n            //get events for the specified parameters\n            TEIService.search($scope.selectedOrgUnit.id,\n                $scope.selectedOuMode.name,\n                $scope.queryUrl,\n                $scope.programUrl,\n                $scope.attributeUrl.url,\n                $scope.pager,\n                true).then(function (data) {\n                //$scope.trackedEntityList = data;\n                if (data.rows) {\n                    $scope.teiCount = data.rows.length;\n                }\n\n                if (data.metaData.pager) {\n                    $scope.pager = data.metaData.pager;\n                    $scope.pager.toolBarDisplay = 5;\n\n                    Paginator.setPage($scope.pager.page);\n                    Paginator.setPageCount($scope.pager.pageCount);\n                    Paginator.setPageSize($scope.pager.pageSize);\n                    Paginator.setItemCount($scope.pager.total);\n                }\n\n                //process tei grid\n\n                $scope.trackedEntityList = TEIGridService.format($scope.selectedOrgUnit.id, data, false, $scope.optionSets, invalidTeis);\n                $scope.showTrackedEntityDiv = true;\n                $scope.teiFetched = true;\n\n                if (!$scope.sortColumn.id) {\n                    $scope.sortGrid({\n                        id: 'created',\n                        name: $translate.instant('registration_date'),\n                        valueType: 'date',\n                        displayInListNoProgram: false,\n                        showFilter: false,\n                        show: false\n                    });\n                }\n            });\n        };\n\n        //set attributes as per selected program\n        $scope.setAttributesForSearch = function (program) {\n\n            $scope.selectedProgramForRelative = program;\n            AttributesFactory.getByProgram($scope.selectedProgramForRelative).then(function (atts) {\n                $scope.attributes = atts;\n                $scope.attributes = AttributesFactory.generateAttributeFilters(atts);\n                $scope.gridColumns = TEIGridService.generateGridColumns($scope.attributes, null, false).columns;\n            });\n\n            $scope.search($scope.selectedSearchMode);\n        };\n\n        $scope.setAttributesForSearch($scope.selectedProgramForRelative);\n\n        $scope.jumpToPage = function () {\n            if ($scope.pager && $scope.pager.page && $scope.pager.pageCount && $scope.pager.page > $scope.pager.pageCount) {\n                $scope.pager.page = $scope.pager.pageCount;\n            }\n\n            $scope.search($scope.selectedSearchMode);\n        };\n\n        $scope.resetPageSize = function () {\n            $scope.pager.page = 1;\n            $scope.search($scope.selectedSearchMode);\n        };\n\n        $scope.getPage = function (page) {\n            $scope.pager.page = page;\n            $scope.search($scope.selectedSearchMode);\n        };\n\n        //generate grid columns from teilist attributes\n        $scope.generateGridColumns = function (attributes) {\n\n            var columns = attributes ? angular.copy(attributes) : [];\n\n            //also add extra columns which are not part of attributes (orgunit for example)\n            columns.push({id: 'orgUnitName', name: 'Organisation unit', type: 'TEXT', displayInListNoProgram: false});\n            columns.push({id: 'created', name: 'Registration date', type: 'TEXT', displayInListNoProgram: false});\n\n            //generate grid column for the selected program/attributes\n            angular.forEach(columns, function (column) {\n                if (column.id === 'orgUnitName' && $scope.selectedOuMode.name !== 'SELECTED') {\n                    column.show = true;\n                }\n\n                if (column.displayInListNoProgram) {\n                    column.show = true;\n                }\n\n                if (column.type === 'date') {\n                    $scope.filterText[column.id] = {start: '', end: ''};\n                }\n            });\n            return columns;\n        };\n\n        $scope.showHideSearch = function (simpleSearch) {\n            $scope.showAdvancedSearchDiv = simpleSearch ? false : !$scope.showAdvancedSearchDiv;\n            $scope.showTrackedEntityDiv = !$scope.showAdvancedSearchDiv;\n        };\n\n        $scope.showRegistration = function () {\n            $scope.showRegistrationDiv = !$scope.showRegistrationDiv;\n            $scope.showTrackedEntityDiv = !$scope.showRegistrationDiv;\n        };\n\n        $scope.close = function () {\n            $modalInstance.close($scope.mainTei.relationships ? $scope.mainTei.relationships : []);\n            $rootScope.showAddRelationshipDiv = !$rootScope.showAddRelationshipDiv;\n        };\n\n        $scope.setRelationshipSides = function (side) {\n            if (side === 'A') {\n                $scope.selectedRelationship.bIsToA = $scope.selectedRelationship.aIsToB === $scope.relationship.selected.aIsToB ? $scope.relationship.selected.bIsToA : $scope.relationship.selected.aIsToB;\n            }\n            if (side === 'B') {\n                $scope.selectedRelationship.aIsToB = $scope.selectedRelationship.bIsToA === $scope.relationship.selected.bIsToA ? $scope.relationship.selected.aIsToB : $scope.relationship.selected.bIsToA;\n            }\n        };\n\n        $scope.assignRelationship = function (relativeTei) {\n            $scope.teiForRelationship = relativeTei;\n            $rootScope.showAddRelationshipDiv = !$rootScope.showAddRelationshipDiv;\n        };\n\n        $scope.back = function () {\n            $scope.teiForRelationship = null;\n            $rootScope.showAddRelationshipDiv = !$rootScope.showAddRelationshipDiv;\n        };\n\n        $scope.addRelationship = function () {\n            if ($scope.addingRelationship) {\n                if ($scope.mainTei && $scope.teiForRelationship && $scope.relationship.selected) {\n                    var tei = angular.copy($scope.mainTei);\n                    var relationship = {};\n                    relationship.relationship = $scope.relationship.selected.id;\n                    relationship.displayName = $scope.relationship.selected.displayName;\n                    relationship.relative = {};\n\n                    relationship.trackedEntityInstanceA = $scope.selectedRelationship.aIsToB === $scope.relationship.selected.aIsToB ? $scope.mainTei.trackedEntityInstance : $scope.teiForRelationship.id;\n                    relationship.trackedEntityInstanceB = $scope.selectedRelationship.bIsToA === $scope.relationship.selected.bIsToA ? $scope.teiForRelationship.id : $scope.mainTei.trackedEntityInstance;\n\n                    tei.relationships = [];\n                    angular.forEach($scope.mainTei.relationships, function (rel) {\n                        tei.relationships.push({\n                            relationship: rel.relationship,\n                            displayName: rel.displayName,\n                            trackedEntityInstanceA: rel.trackedEntityInstanceA,\n                            trackedEntityInstanceB: rel.trackedEntityInstanceB\n                        });\n                    });\n                    tei.relationships.push(relationship);\n\n                    TEIService.update(tei, $scope.optionSets, $scope.attributesById).then(function (response) {\n                        if (!response || response.response && response.response.status !== 'SUCCESS') {//update has failed\n                            return;\n                        }\n\n                        relationship.relative.processed = true;\n                        relationship.relative.attributes = $scope.teiForRelationship;\n\n                        if ($scope.mainTei.relationships) {\n                            $scope.mainTei.relationships.push(relationship);\n                        }\n                        else {\n                            $scope.mainTei.relationships = [relationship];\n                        }\n\n                        $modalInstance.close($scope.mainTei.relationships);\n                    });\n                }\n                else {\n                    NotificationService.showNotifcationDialog($translate.instant(\"relationship_error\"), $translate.instant(\"selected_tei_is_invalid\"));\n                    return;\n                }\n            }\n            else {\n                if ($scope.teiForRelationship && $scope.teiForRelationship.id) {\n                    $modalInstance.close($scope.teiForRelationship);\n                }\n                else {\n                    NotificationService.showNotifcationDialog($translate.instant(\"tracker_associate_error\"), $translate.instant(\"selected_tei_is_invalid\"));\n                    return;\n                }\n\n            }\n        };\n\n        //Get orgunits for the logged in user\n        OrgUnitFactory.getSearchTreeRoot().then(function (response) {\n            $scope.orgUnits = response.organisationUnits;\n            angular.forEach($scope.orgUnits, function (ou) {\n                ou.show = true;\n                angular.forEach(ou.children, function (o) {\n                    o.hasChildren = o.children && o.children.length > 0 ? true : false;\n                });\n            });\n        });\n\n        //expand/collapse of search orgunit tree\n        $scope.expandCollapse = function (orgUnit) {\n            if (orgUnit.hasChildren) {\n                //Get children for the selected orgUnit\n                OrgUnitFactory.get(orgUnit.id).then(function (ou) {\n                    orgUnit.show = !orgUnit.show;\n                    orgUnit.hasChildren = false;\n                    orgUnit.children = ou.organisationUnits[0].children;\n                    angular.forEach(orgUnit.children, function (ou) {\n                        ou.hasChildren = ou.children && ou.children.length > 0 ? true : false;\n                    });\n                });\n            }\n            else {\n                orgUnit.show = !orgUnit.show;\n            }\n        };\n\n        //load programs for the selected orgunit (from tree)\n        $scope.setSelectedSearchingOrgUnit = function (orgUnit) {\n            $scope.selectedSearchingOrgUnit = orgUnit;\n        };\n})\n\n.controller('TEIRegistrationController', \n        function($rootScope,\n                $scope,\n                $timeout,\n                $translate,\n                AttributesFactory,\n                MetaDataFactory,\n                TrackerRulesFactory,\n                CustomFormService,\n                TEService,\n                EnrollmentService,\n                NotificationService,\n                CurrentSelection,\n                DateUtils,\n                EventUtils,\n                DHIS2EventFactory,\n                RegistrationService,\n                SessionStorageService,\n                TrackerRulesExecutionService,\n                TEIGridService) {\n    $scope.selectedOrgUnit = SessionStorageService.get('SELECTED_OU');\n    $scope.enrollment = {enrollmentDate: '', incidentDate: ''};    \n    $scope.attributesById = CurrentSelection.getAttributesById();\n    $scope.today = DateUtils.getToday();\n    $scope.trackedEntityForm = null;\n    $scope.customRegistrationForm = null;\n    $scope.selectedTei = {};\n    $scope.teiOriginal = {};\n    $scope.tei = {};\n    $scope.hiddenFields = {};\n    $scope.editingDisabled = false;\n    \n    var selections = CurrentSelection.get();\n    $scope.programs = selections.prs;\n    $scope.selectedOrgUnit = selections.orgUnit;\n\n    $scope.attributesById = CurrentSelection.getAttributesById();\n    if(!$scope.attributesById){\n        $scope.attributesById = [];\n        AttributesFactory.getAll().then(function(atts){\n            angular.forEach(atts, function(att){\n                $scope.attributesById[att.id] = att;\n            });\n            \n            CurrentSelection.setAttributesById($scope.attributesById);\n        });\n    }    \n    \n    $scope.optionSets = CurrentSelection.getOptionSets();        \n    if(!$scope.optionSets){\n        $scope.optionSets = [];\n        MetaDataFactory.getAll('optionSets').then(function(optionSets){\n            angular.forEach(optionSets, function(optionSet){                        \n                $scope.optionSets[optionSet.id] = optionSet;\n            });\n\n            CurrentSelection.setOptionSets($scope.optionSets);\n        });\n    }\n    \n    var assignInheritance = function(){        \n        $scope.selectedTei = {};\n        if($scope.addingRelationship){\n            var t = angular.copy( CurrentSelection.getRelationshipOwner() );\n            angular.forEach(t.attributes, function(att){\n                t[att.attribute] = att.value;\n            });\n            \n            angular.forEach($scope.attributes, function(att){\n                if(att.inherit && t[att.id]){\n                    $scope.selectedTei[att.id] = t[att.id];\n                }\n            });\n            t = {};\n        }\n    };\n    \n    var getRules = function(){\n        $scope.allProgramRules = {constants: [], programIndicators: {}, programValidations: [], programVariables: [], programRules: []};\n        if( angular.isObject($scope.selectedProgramForRelative) && $scope.selectedProgramForRelative.id ){\n            TrackerRulesFactory.getRules($scope.selectedProgramForRelative.id).then(function(rules){                    \n                $scope.allProgramRules = rules;\n            });\n        }\n    };\n  \n    \n    if(angular.isObject($scope.programs) && $scope.programs.length === 1){\n        $scope.selectedProgramForRelative = $scope.programs[0];\n        AttributesFactory.getByProgram($scope.selectedProgramForRelative).then(function(atts){\n            $scope.attributes = TEIGridService.generateGridColumns(atts, null,false).columns;\n            assignInheritance();\n            getRules();\n        });\n    }\n    \n    //watch for selection of program\n    $scope.$watch('selectedProgramForRelative', function() {        \n        $scope.trackedEntityForm = null;\n        $scope.customRegistrationForm = null;\n        $scope.customFormExists = false;        \n        AttributesFactory.getByProgram($scope.selectedProgramForRelative).then(function(atts){\n            $scope.attributes = TEIGridService.generateGridColumns(atts, null,false).columns;                       \n            if($scope.selectedProgramForRelative && $scope.selectedProgramForRelative.id && $scope.selectedProgramForRelative.dataEntryForm && $scope.selectedProgramForRelative.dataEntryForm.htmlCode){\n                $scope.customFormExists = true;\n                $scope.trackedEntityForm = $scope.selectedProgramForRelative.dataEntryForm;  \n                $scope.trackedEntityForm.attributes = $scope.attributes;\n                $scope.trackedEntityForm.selectIncidentDatesInFuture = $scope.selectedProgramForRelative.selectIncidentDatesInFuture;\n                $scope.trackedEntityForm.selectEnrollmentDatesInFuture = $scope.selectedProgramForRelative.selectEnrollmentDatesInFuture;\n                $scope.trackedEntityForm.displayIncidentDate = $scope.selectedProgramForRelative.displayIncidentDate;\n                $scope.customRegistrationForm = CustomFormService.getForTrackedEntity($scope.trackedEntityForm, 'RELATIONSHIP');\n            }\n            assignInheritance();\n            getRules();                \n        });\n        \n    }); \n            \n    $scope.trackedEntities = {available: []};\n    TEService.getAll().then(function(entities){\n        $scope.trackedEntities.available = entities;   \n        $scope.trackedEntities.selected = $scope.trackedEntities.available[0];\n    });\n    \n    $scope.registerEntity = function(){\n        \n        //check for form validity\n        $scope.outerForm.submitted = true;\n        if( $scope.outerForm.$invalid ){\n            return false;\n        }\n        \n        //form is valid, continue the registration\n        //get selected entity\n        var selectedTrackedEntity = $scope.trackedEntities.selected.id; \n        if($scope.selectedProgramForRelative){\n            selectedTrackedEntity = $scope.selectedProgramForRelative.trackedEntity.id;\n        }\n        \n        //get tei attributes and their values\n        //but there could be a case where attributes are non-mandatory and\n        //registration form comes empty, in this case enforce at least one value\n        $scope.selectedTei.trackedEntity = $scope.tei.trackedEntity = selectedTrackedEntity; \n        $scope.selectedTei.orgUnit = $scope.tei.orgUnit = $scope.selectedOrgUnit.id;\n        $scope.selectedTei.attributes = $scope.tei.attributes = [];\n        \n        var result = RegistrationService.processForm($scope.tei, $scope.selectedTei, $scope.teiOriginal, $scope.attributesById);\n        $scope.formEmpty = result.formEmpty;\n        $scope.tei = result.tei;\n                \n        if($scope.formEmpty){//registration form is empty\n            return false;\n        }\n        \n        RegistrationService.registerOrUpdate($scope.tei, $scope.optionSets, $scope.attributesById).then(function(registrationResponse){\n            var reg = registrationResponse.response ? registrationResponse.response : {};\n            if(reg.reference && reg.status === 'SUCCESS'){                \n                $scope.tei.trackedEntityInstance = $scope.tei.id = reg.reference; \n                \n                //registration is successful and check for enrollment\n                if($scope.selectedProgramForRelative){    \n                    //enroll TEI\n                    var enrollment = {};\n                    enrollment.trackedEntityInstance = $scope.tei.trackedEntityInstance;\n                    enrollment.program = $scope.selectedProgramForRelative.id;\n                    enrollment.status = 'ACTIVE';\n                    enrollment.orgUnit = $scope.selectedOrgUnit.id;\n                    enrollment.enrollmentDate = $scope.selectedEnrollment.enrollmentDate;\n                    enrollment.incidentDate = $scope.selectedEnrollment.incidentDate === '' ? $scope.selectedEnrollment.enrollmentDate : $scope.selectedEnrollment.incidentDate;\n                    EnrollmentService.enroll(enrollment).then(function(enrollmentResponse){\n                        if(enrollmentResponse) {\n                            var en = enrollmentResponse.response && enrollmentResponse.response.importSummaries && enrollmentResponse.response.importSummaries[0] ? enrollmentResponse.response.importSummaries[0] : {};\n                            if (en.reference && en.status === 'SUCCESS') {\n                                enrollment.enrollment = en.reference;\n                                $scope.selectedEnrollment = enrollment;\n                                var dhis2Events = EventUtils.autoGenerateEvents($scope.tei.trackedEntityInstance, $scope.selectedProgramForRelative, $scope.selectedOrgUnit, enrollment, null);\n                                if (dhis2Events.events.length > 0) {\n                                    DHIS2EventFactory.create(dhis2Events);\n                                }\n                            }\n                            else {\n                                //enrollment has failed\n                                NotificationService.showNotifcationDialog($translate.instant(\"enrollment_error\"), enrollmentResponse.message);\n                                return;\n                            }\n                        }\n                    });\n                }\n            }\n            else{\n                //registration has failed\n                NotificationService.showNotifcationDialog($translate.instant(\"registration_error\"), enrollmentResponse.message);\n                return;\n            }\n            \n            $timeout(function(){\n                $scope.selectedEnrollment.enrollmentDate = '';\n                $scope.selectedEnrollment.incidentDate =  '';\n                $scope.outerForm.submitted = false; \n                $scope.broadCastSelections();                \n            }, 100);        \n            \n        });\n    };\n    \n    $scope.broadCastSelections = function(){\n        if($scope.tei){\n            angular.forEach($scope.tei.attributes, function(att){\n                $scope.tei[att.attribute] = att.value;\n            });\n\n            $scope.tei.orgUnitName = $scope.selectedOrgUnit.displayName;\n            $scope.tei.created = DateUtils.formatFromApiToUser(new Date());\n            \n            CurrentSelection.setRelationshipInfo({tei: $scope.tei});\n            \n            $timeout(function() { \n                $rootScope.$broadcast('relationship', {result: 'SUCCESS'});\n            }, 100);\n        }        \n    };\n    \n    $scope.executeRules = function () {\n        var flag = {debug: true, verbose: false};\n        \n        //repopulate attributes with updated values\n        $scope.selectedTei.attributes = [];        \n        angular.forEach($scope.attributes, function(metaAttribute){\n            var newAttributeInArray = {attribute:metaAttribute.id,\n                code:metaAttribute.code,\n                displayName:metaAttribute.displayName,\n                type:metaAttribute.valueType\n            };\n            if($scope.selectedTei[newAttributeInArray.attribute]){\n                newAttributeInArray.value = $scope.selectedTei[newAttributeInArray.attribute];\n            }\n            \n           $scope.selectedTei.attributes.push(newAttributeInArray);\n        });\n        \n        if($scope.selectedProgram && $scope.selectedProgram.id){\n            TrackerRulesExecutionService.executeRules($scope.allProgramRules, 'registration', null, null, $scope.selectedTei, $scope.selectedEnrollment, flag);\n        }        \n    };\n    \n    //check if field is hidden\n    $scope.isHidden = function (id) {\n        //In case the field contains a value, we cant hide it. \n        //If we hid a field with a value, it would falsely seem the user was aware that the value was entered in the UI.        \n        return $scope.selectedTei[id] ? false : $scope.hiddenFields[id];\n    };\n    \n    $scope.teiValueUpdated = function(tei, field){\n        $scope.executeRules();\n    };\n    \n    //listen for rule effect changes\n    $scope.$on('ruleeffectsupdated', function(){\n        $scope.warningMessages = [];\n        var effectResult = TrackerRulesExecutionService.processRuleEffectAttribute('registration', $scope.selectedTei, $scope.tei, $scope.attributesById, $scope.hiddenFields, $scope.warningMessages);\n        $scope.selectedTei = effectResult.selectedTei;\n        $scope.hiddenFields = effectResult.hiddenFields;\n        $scope.warningMessages = effectResult.warningMessages;\n    });\n    \n    $scope.interacted = function(field) {\n        var status = false;\n        if(field){            \n            status = $scope.outerForm.submitted || field.$dirty;\n        }\n        return status;        \n    };\n});\n\n\n\n// WEBPACK FOOTER //\n// ./components/teiadd/tei-add-controller.js","/* global trackerCapture, angular */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('ProfileController',\n        function($rootScope,\n                $scope,\n                $timeout,\n                CurrentSelection) {\n    $scope.editingDisabled = true;\n    $scope.enrollmentEditing = false;\n    $scope.widget = 'PROFILE';\n    \n    //listen for the selected entity\n    var selections = {};\n    $scope.$on('dashboardWidgets', function(event, args) {        \n        listenToBroadCast();\n    });\n    \n    //listen to changes in profile\n    $scope.$on('profileWidget', function(event, args){\n        listenToBroadCast();\n    });\n    \n    //listen to changes in enrollment editing\n    $scope.$on('enrollmentEditing', function(event, args){\n        $scope.enrollmentEditing = args.enrollmentEditing;\n    });\n    \n    var listenToBroadCast = function(){\n        $scope.editingDisabled = true;\n        selections = CurrentSelection.get();\n        $scope.selectedTei = angular.copy(selections.tei);\n        $scope.trackedEntity = selections.te;\n        $scope.selectedProgram = selections.pr;   \n        $scope.selectedEnrollment = selections.selectedEnrollment;\n        $scope.optionSets = selections.optionSets;\n        $scope.selectedOrgUnit = selections.orgUnit;\n        $scope.trackedEntityForm = null;\n        $scope.customForm = null;\n        $scope.attributesById = CurrentSelection.getAttributesById();\n        \n        //display only those attributes that belong to the selected program\n        //if no program, display attributesInNoProgram        \n        angular.forEach($scope.selectedTei.attributes, function(att){\n            $scope.selectedTei[att.attribute] = att.value;\n        });\n\n        $timeout(function() { \n            $rootScope.$broadcast('registrationWidget', {registrationMode: 'PROFILE', selectedTei: $scope.selectedTei, enrollment: $scope.selectedEnrollment});\n        });\n    };\n    \n    $scope.enableEdit = function(){\n        $scope.teiOriginal = angular.copy($scope.selectedTei);\n        $scope.editingDisabled = !$scope.editingDisabled; \n        $rootScope.profileWidget.expand = true;\n    };\n    \n    $scope.cancel = function(){\n        $scope.selectedTei = $scope.teiOriginal;  \n        $scope.editingDisabled = !$scope.editingDisabled;\n        $timeout(function() { \n            $rootScope.$broadcast('registrationWidget', {registrationMode: 'PROFILE', selectedTei: $scope.selectedTei, enrollment: $scope.selectedEnrollment});\n        }, 600);\n    };  \n});\n\n\n// WEBPACK FOOTER //\n// ./components/profile/profile-controller.js","/* global trackerCapture, angular */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('NotesController',\n        function($scope,\n                $translate,\n                DateUtils,\n                EnrollmentService,\n                CurrentSelection,\n                NotificationService,\n                SessionStorageService,\n                orderByFilter) {\n    var userProfile = SessionStorageService.get('USER_PROFILE');\n    var storedBy = userProfile && userProfile.username ? userProfile.username : '';\n\n    var today = DateUtils.getToday();\n    \n    $scope.note = {};\n    $scope.showNotesDiv = true;\n    \n    $scope.$on('dashboardWidgets', function() {\n        $scope.selectedEnrollment = null;\n        var selections = CurrentSelection.get();\n        $scope.selectedTei = selections.tei;\n        \n        if(selections.selectedEnrollment && selections.selectedEnrollment.enrollment){\n            EnrollmentService.get(selections.selectedEnrollment.enrollment).then(function(data){\n                if (data) {\n                    $scope.selectedEnrollment = data;\n                    if (!angular.isUndefined($scope.selectedEnrollment.notes)) {\n                        $scope.selectedEnrollment.notes = orderByFilter($scope.selectedEnrollment.notes, '-storedDate');\n                        angular.forEach($scope.selectedEnrollment.notes, function (note) {\n                            note.displayDate = DateUtils.formatFromApiToUser(note.storedDate);\n                            note.storedDate = DateUtils.formatToHrsMins(note.storedDate);\n                        });\n                    }\n                }\n            });\n        }\n    });\n       \n    $scope.addNote = function(){\n        if(!$scope.note.value){\n            NotificationService.showNotifcationDialog($translate.instant(\"error\"), $translate.instant(\"please_add_some_text\"));\n            return;\n        }\n\n        var newNote = {value: $scope.note.value};\n\n        if(angular.isUndefined( $scope.selectedEnrollment.notes) ){\n            $scope.selectedEnrollment.notes = [{value: newNote.value, storedDate: DateUtils.formatFromUserToApi(today), displayDate: today, storedBy: storedBy}];\n\n        }\n        else{\n            $scope.selectedEnrollment.notes.splice(0,0,{value: newNote.value, storedDate: DateUtils.formatFromUserToApi(today),displayDate: today, storedBy: storedBy});\n        }\n\n        var e = angular.copy($scope.selectedEnrollment);\n        e.enrollmentDate = DateUtils.formatFromUserToApi(e.enrollmentDate);\n        if(e.incidentDate){\n            e.incidentDate = DateUtils.formatFromUserToApi(e.incidentDate);\n        }\n        e.notes = [newNote];\n        EnrollmentService.updateForNote(e).then(function(){\n            $scope.clear();\n        });\n    };\n    \n    $scope.clear = function(){\n        $scope.note = {};\n    };\n    \n    $scope.showNotes = function(){\n        $scope.showNotesDiv = !$scope.showNotesDiv;\n    };\n});\n\n\n\n// WEBPACK FOOTER //\n// ./components/notes/notes-controller.js","/* global angular, trackerCapture */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('RuleBoundController',\n        function(\n                $rootScope,\n                $scope,\n                $translate,\n                $log) {\n    $scope.widget = $scope.$parent.$parent.biggerWidget ? $scope.$parent.$parent.biggerWidget\n    : $scope.$parent.$parent.smallerWidget ? $scope.$parent.$parent.smallerWidget : null;\n    $scope.widgetTitle = $scope.widget ? $scope.widget.title : null;    \n    $scope.emptyFeedbackListLabel = $translate.instant('no_feedback_exist');\n    $scope.emptyIndicatorListLabel = $translate.instant('no_indicators_exist');\n    \n    $scope.lastEventUpdated = null;\n    $scope.widgetTitleLabel = $translate.instant($scope.widgetTitle);\n    \n    $scope.displayTextEffects = {};\n    $scope.displayKeyDataEffects = {};\n\n    //listen for updated rule effects\n    $scope.$on('ruleeffectsupdated', function(event, args) {\n        var textInEffect = false;\n        var keyDataInEffect = false;\n        \n        if(args.event === 'registration') return;\n\n        //In case the \n        if($scope.lastEventUpdated !== args.event) {\n            $scope.displayTextEffects = {};\n            $scope.displayKeyDataEffects = {};\n            $scope.lastEventUpdated = args.event;\n        }\n        \n        //Bind non-bound rule effects, if any.\n        angular.forEach($rootScope.ruleeffects[args.event], function(effect) {\n            if(effect.location === $scope.widgetTitle){\n                //This effect is affecting the local widget\n                \n                //Round data to two decimals if it is a number:\n                if(dhis2.validation.isNumber(effect.data)){\n                    effect.data = Math.round(effect.data*100)/100;\n                }\n                \n                if(effect.action === \"DISPLAYTEXT\") {\n                    //this action is display text. Make sure the displaytext is\n                    //added to the local list of displayed texts\n                    if(!angular.isObject($scope.displayTextEffects[effect.id])){\n                        $scope.displayTextEffects[effect.id] = effect;\n                    }\n                    if(effect.ineffect)\n                    {\n                        textInEffect = true;\n                    }\n                }\n                else if(effect.action === \"DISPLAYKEYVALUEPAIR\") {                    \n                    //this action is display text. Make sure the displaytext is\n                    //added to the local list of displayed texts\n                    if(!angular.isObject($scope.displayTextEffects[effect.id])){\n                        $scope.displayKeyDataEffects[effect.id] = effect;\n                    }\n                    if(effect.ineffect)\n                    {\n                        keyDataInEffect = true;\n                    }\n                }\n                else if(effect.action === \"ASSIGN\") {\n                    //the dataentry control saves the variable and or dataelement\n                }\n                else {\n                    $log.warn(\"action: '\" + effect.action + \"' not supported by rulebound-controller.js\");\n                }\n            }\n        });\n        \n        $scope.showKeyDataSection = keyDataInEffect;\n        $scope.showTextSection = textInEffect;        \n    });     \n});\n\n\n\n// WEBPACK FOOTER //\n// ./components/rulebound/rulebound-controller.js","/* global trackerCapture, angular */\n\nvar trackerCapture = angular.module('trackerCapture');\ntrackerCapture.controller('MessagingController',\n        function($scope, $translate,\n                MessagingService,\n                CurrentSelection) {\n\n    //$scope.messagingForm = {};\n    $scope.note = {};\n    $scope.message = {};\n    $scope.showMessagingDiv = false;\n    $scope.showNotesDiv = true;\n    $scope.model = {messageTypes:[\"sms\",\"email\"], selectedMessageType:\"sms\", smsMessage:\"\", emailMessage:\"\"};\n    $scope.$on('dashboardWidgets', function() {\n        $scope.selectedEnrollment = null;\n        $scope.selections = CurrentSelection.get();\n        $scope.selectedTei = $scope.selections.tei;\n        $scope.selectedOrgUnit = $scope.selections.orgUnit;\n        if ($scope.selectedTei) {\n            //check if the selected TEI has any of the contact attributes\n            //that can be used for messaging\n            var foundPhoneNumber = false;\n            var foundEmailId = false;\n            for (var i = 0; i < $scope.selectedTei.attributes.length; i++) {\n                if ($scope.selectedTei.attributes[i].valueType === 'PHONE_NUMBER') {\n                    $scope.message.phoneNumber = $scope.selectedTei.attributes[i].value;\n                    foundPhoneNumber = true;\n                }\n                if ($scope.selectedTei.attributes[i].displayName === 'Email') {\n                    $scope.message.emailId = $scope.selectedTei.attributes[i].value;\n                    foundEmailId = true;\n                }\n                if (foundPhoneNumber && foundEmailId) {\n                    break;\n                }\n            }\n        }\n    });\n\n    $scope.sendMessage = function(){\n        var message;\n        //check for form validity\n        $scope.messagingForm.submitted = true;\n        if ($scope.messagingForm.$invalid) {\n            return false;\n        }\n\n        //form is valid...\n\n        if ($scope.model.selectedMessageType === \"email\") {\n            message = {\n                \"programMessages\": [{\n                    \"recipients\": {\n                        \"emailAddresses\": [$scope.message.emailId]\n                    },\n                    \"programInstance\": {\n                        \"id\": $scope.selectedProgramId\n                    },\n                    \"deliveryChannels\": [\"EMAIL\"],\n                    \"subject\": $scope.message.emailSubject,\n                    \"text\": $scope.message.emailMessage,\n                    \"storeCopy\": false\n                }]\n            };\n        } else if ($scope.model.selectedMessageType === \"sms\") {\n            message = {\n                \"programMessages\": [{\n                    \"recipients\": {\n                        \"phoneNumbers\": [$scope.message.phoneNumber]\n                    },\n                    \"programInstance\": {\n                        \"id\": $scope.selectedProgramId\n                    },\n                    \"deliveryChannels\": [\"SMS\"],\n                    \"text\": $scope.message.smsMessage,\n                    \"storeCopy\": false\n                }]\n            };\n        }\n\n        MessagingService.sendMessage(message);\n\n    };\n\n    $scope.clear = function(){\n        $scope.messagingForm.submitted = false;\n        $scope.message = {};\n    };\n    \n    $scope.showMessaging = function(){        \n        $scope.showMessagingDiv = !$scope.showMessagingDiv;\n    };\n});\n\n\n\n// WEBPACK FOOTER //\n// ./components/messaging/messaging-controller.js","/*\n Leaflet, a JavaScript library for mobile-friendly interactive maps. http://leafletjs.com\n (c) 2010-2013, Vladimir Agafonkin\n (c) 2010-2011, CloudMade\n*/\n(function (window, document, undefined) {\r\nvar oldL = window.L,\r\n    L = {};\r\n\r\nL.version = '0.7.7';\r\n\r\n// define Leaflet for Node module pattern loaders, including Browserify\r\nif (typeof module === 'object' && typeof module.exports === 'object') {\r\n\tmodule.exports = L;\r\n\r\n// define Leaflet as an AMD module\r\n} else if (typeof define === 'function' && define.amd) {\r\n\tdefine(L);\r\n}\r\n\r\n// define Leaflet as a global L variable, saving the original L to restore later if needed\r\n\r\nL.noConflict = function () {\r\n\twindow.L = oldL;\r\n\treturn this;\r\n};\r\n\r\nwindow.L = L;\r\n\n\n/*\r\n * L.Util contains various utility functions used throughout Leaflet code.\r\n */\r\n\r\nL.Util = {\r\n\textend: function (dest) { // (Object[, Object, ...]) ->\r\n\t\tvar sources = Array.prototype.slice.call(arguments, 1),\r\n\t\t    i, j, len, src;\r\n\r\n\t\tfor (j = 0, len = sources.length; j < len; j++) {\r\n\t\t\tsrc = sources[j] || {};\r\n\t\t\tfor (i in src) {\r\n\t\t\t\tif (src.hasOwnProperty(i)) {\r\n\t\t\t\t\tdest[i] = src[i];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn dest;\r\n\t},\r\n\r\n\tbind: function (fn, obj) { // (Function, Object) -> Function\r\n\t\tvar args = arguments.length > 2 ? Array.prototype.slice.call(arguments, 2) : null;\r\n\t\treturn function () {\r\n\t\t\treturn fn.apply(obj, args || arguments);\r\n\t\t};\r\n\t},\r\n\r\n\tstamp: (function () {\r\n\t\tvar lastId = 0,\r\n\t\t    key = '_leaflet_id';\r\n\t\treturn function (obj) {\r\n\t\t\tobj[key] = obj[key] || ++lastId;\r\n\t\t\treturn obj[key];\r\n\t\t};\r\n\t}()),\r\n\r\n\tinvokeEach: function (obj, method, context) {\r\n\t\tvar i, args;\r\n\r\n\t\tif (typeof obj === 'object') {\r\n\t\t\targs = Array.prototype.slice.call(arguments, 3);\r\n\r\n\t\t\tfor (i in obj) {\r\n\t\t\t\tmethod.apply(context, [i, obj[i]].concat(args));\r\n\t\t\t}\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\treturn false;\r\n\t},\r\n\r\n\tlimitExecByInterval: function (fn, time, context) {\r\n\t\tvar lock, execOnUnlock;\r\n\r\n\t\treturn function wrapperFn() {\r\n\t\t\tvar args = arguments;\r\n\r\n\t\t\tif (lock) {\r\n\t\t\t\texecOnUnlock = true;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tlock = true;\r\n\r\n\t\t\tsetTimeout(function () {\r\n\t\t\t\tlock = false;\r\n\r\n\t\t\t\tif (execOnUnlock) {\r\n\t\t\t\t\twrapperFn.apply(context, args);\r\n\t\t\t\t\texecOnUnlock = false;\r\n\t\t\t\t}\r\n\t\t\t}, time);\r\n\r\n\t\t\tfn.apply(context, args);\r\n\t\t};\r\n\t},\r\n\r\n\tfalseFn: function () {\r\n\t\treturn false;\r\n\t},\r\n\r\n\tformatNum: function (num, digits) {\r\n\t\tvar pow = Math.pow(10, digits || 5);\r\n\t\treturn Math.round(num * pow) / pow;\r\n\t},\r\n\r\n\ttrim: function (str) {\r\n\t\treturn str.trim ? str.trim() : str.replace(/^\\s+|\\s+$/g, '');\r\n\t},\r\n\r\n\tsplitWords: function (str) {\r\n\t\treturn L.Util.trim(str).split(/\\s+/);\r\n\t},\r\n\r\n\tsetOptions: function (obj, options) {\r\n\t\tobj.options = L.extend({}, obj.options, options);\r\n\t\treturn obj.options;\r\n\t},\r\n\r\n\tgetParamString: function (obj, existingUrl, uppercase) {\r\n\t\tvar params = [];\r\n\t\tfor (var i in obj) {\r\n\t\t\tparams.push(encodeURIComponent(uppercase ? i.toUpperCase() : i) + '=' + encodeURIComponent(obj[i]));\r\n\t\t}\r\n\t\treturn ((!existingUrl || existingUrl.indexOf('?') === -1) ? '?' : '&') + params.join('&');\r\n\t},\r\n\ttemplate: function (str, data) {\r\n\t\treturn str.replace(/\\{ *([\\w_]+) *\\}/g, function (str, key) {\r\n\t\t\tvar value = data[key];\r\n\t\t\tif (value === undefined) {\r\n\t\t\t\tthrow new Error('No value provided for variable ' + str);\r\n\t\t\t} else if (typeof value === 'function') {\r\n\t\t\t\tvalue = value(data);\r\n\t\t\t}\r\n\t\t\treturn value;\r\n\t\t});\r\n\t},\r\n\r\n\tisArray: Array.isArray || function (obj) {\r\n\t\treturn (Object.prototype.toString.call(obj) === '[object Array]');\r\n\t},\r\n\r\n\temptyImageUrl: 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='\r\n};\r\n\r\n(function () {\r\n\r\n\t// inspired by http://paulirish.com/2011/requestanimationframe-for-smart-animating/\r\n\r\n\tfunction getPrefixed(name) {\r\n\t\tvar i, fn,\r\n\t\t    prefixes = ['webkit', 'moz', 'o', 'ms'];\r\n\r\n\t\tfor (i = 0; i < prefixes.length && !fn; i++) {\r\n\t\t\tfn = window[prefixes[i] + name];\r\n\t\t}\r\n\r\n\t\treturn fn;\r\n\t}\r\n\r\n\tvar lastTime = 0;\r\n\r\n\tfunction timeoutDefer(fn) {\r\n\t\tvar time = +new Date(),\r\n\t\t    timeToCall = Math.max(0, 16 - (time - lastTime));\r\n\r\n\t\tlastTime = time + timeToCall;\r\n\t\treturn window.setTimeout(fn, timeToCall);\r\n\t}\r\n\r\n\tvar requestFn = window.requestAnimationFrame ||\r\n\t        getPrefixed('RequestAnimationFrame') || timeoutDefer;\r\n\r\n\tvar cancelFn = window.cancelAnimationFrame ||\r\n\t        getPrefixed('CancelAnimationFrame') ||\r\n\t        getPrefixed('CancelRequestAnimationFrame') ||\r\n\t        function (id) { window.clearTimeout(id); };\r\n\r\n\r\n\tL.Util.requestAnimFrame = function (fn, context, immediate, element) {\r\n\t\tfn = L.bind(fn, context);\r\n\r\n\t\tif (immediate && requestFn === timeoutDefer) {\r\n\t\t\tfn();\r\n\t\t} else {\r\n\t\t\treturn requestFn.call(window, fn, element);\r\n\t\t}\r\n\t};\r\n\r\n\tL.Util.cancelAnimFrame = function (id) {\r\n\t\tif (id) {\r\n\t\t\tcancelFn.call(window, id);\r\n\t\t}\r\n\t};\r\n\r\n}());\r\n\r\n// shortcuts for most used utility functions\r\nL.extend = L.Util.extend;\r\nL.bind = L.Util.bind;\r\nL.stamp = L.Util.stamp;\r\nL.setOptions = L.Util.setOptions;\r\n\n\n/*\r\n * L.Class powers the OOP facilities of the library.\r\n * Thanks to John Resig and Dean Edwards for inspiration!\r\n */\r\n\r\nL.Class = function () {};\r\n\r\nL.Class.extend = function (props) {\r\n\r\n\t// extended class with the new prototype\r\n\tvar NewClass = function () {\r\n\r\n\t\t// call the constructor\r\n\t\tif (this.initialize) {\r\n\t\t\tthis.initialize.apply(this, arguments);\r\n\t\t}\r\n\r\n\t\t// call all constructor hooks\r\n\t\tif (this._initHooks) {\r\n\t\t\tthis.callInitHooks();\r\n\t\t}\r\n\t};\r\n\r\n\t// instantiate class without calling constructor\r\n\tvar F = function () {};\r\n\tF.prototype = this.prototype;\r\n\r\n\tvar proto = new F();\r\n\tproto.constructor = NewClass;\r\n\r\n\tNewClass.prototype = proto;\r\n\r\n\t//inherit parent's statics\r\n\tfor (var i in this) {\r\n\t\tif (this.hasOwnProperty(i) && i !== 'prototype') {\r\n\t\t\tNewClass[i] = this[i];\r\n\t\t}\r\n\t}\r\n\r\n\t// mix static properties into the class\r\n\tif (props.statics) {\r\n\t\tL.extend(NewClass, props.statics);\r\n\t\tdelete props.statics;\r\n\t}\r\n\r\n\t// mix includes into the prototype\r\n\tif (props.includes) {\r\n\t\tL.Util.extend.apply(null, [proto].concat(props.includes));\r\n\t\tdelete props.includes;\r\n\t}\r\n\r\n\t// merge options\r\n\tif (props.options && proto.options) {\r\n\t\tprops.options = L.extend({}, proto.options, props.options);\r\n\t}\r\n\r\n\t// mix given properties into the prototype\r\n\tL.extend(proto, props);\r\n\r\n\tproto._initHooks = [];\r\n\r\n\tvar parent = this;\r\n\t// jshint camelcase: false\r\n\tNewClass.__super__ = parent.prototype;\r\n\r\n\t// add method for calling all hooks\r\n\tproto.callInitHooks = function () {\r\n\r\n\t\tif (this._initHooksCalled) { return; }\r\n\r\n\t\tif (parent.prototype.callInitHooks) {\r\n\t\t\tparent.prototype.callInitHooks.call(this);\r\n\t\t}\r\n\r\n\t\tthis._initHooksCalled = true;\r\n\r\n\t\tfor (var i = 0, len = proto._initHooks.length; i < len; i++) {\r\n\t\t\tproto._initHooks[i].call(this);\r\n\t\t}\r\n\t};\r\n\r\n\treturn NewClass;\r\n};\r\n\r\n\r\n// method for adding properties to prototype\r\nL.Class.include = function (props) {\r\n\tL.extend(this.prototype, props);\r\n};\r\n\r\n// merge new default options to the Class\r\nL.Class.mergeOptions = function (options) {\r\n\tL.extend(this.prototype.options, options);\r\n};\r\n\r\n// add a constructor hook\r\nL.Class.addInitHook = function (fn) { // (Function) || (String, args...)\r\n\tvar args = Array.prototype.slice.call(arguments, 1);\r\n\r\n\tvar init = typeof fn === 'function' ? fn : function () {\r\n\t\tthis[fn].apply(this, args);\r\n\t};\r\n\r\n\tthis.prototype._initHooks = this.prototype._initHooks || [];\r\n\tthis.prototype._initHooks.push(init);\r\n};\r\n\n\n/*\r\n * L.Mixin.Events is used to add custom events functionality to Leaflet classes.\r\n */\r\n\r\nvar eventsKey = '_leaflet_events';\r\n\r\nL.Mixin = {};\r\n\r\nL.Mixin.Events = {\r\n\r\n\taddEventListener: function (types, fn, context) { // (String, Function[, Object]) or (Object[, Object])\r\n\r\n\t\t// types can be a map of types/handlers\r\n\t\tif (L.Util.invokeEach(types, this.addEventListener, this, fn, context)) { return this; }\r\n\r\n\t\tvar events = this[eventsKey] = this[eventsKey] || {},\r\n\t\t    contextId = context && context !== this && L.stamp(context),\r\n\t\t    i, len, event, type, indexKey, indexLenKey, typeIndex;\r\n\r\n\t\t// types can be a string of space-separated words\r\n\t\ttypes = L.Util.splitWords(types);\r\n\r\n\t\tfor (i = 0, len = types.length; i < len; i++) {\r\n\t\t\tevent = {\r\n\t\t\t\taction: fn,\r\n\t\t\t\tcontext: context || this\r\n\t\t\t};\r\n\t\t\ttype = types[i];\r\n\r\n\t\t\tif (contextId) {\r\n\t\t\t\t// store listeners of a particular context in a separate hash (if it has an id)\r\n\t\t\t\t// gives a major performance boost when removing thousands of map layers\r\n\r\n\t\t\t\tindexKey = type + '_idx';\r\n\t\t\t\tindexLenKey = indexKey + '_len';\r\n\r\n\t\t\t\ttypeIndex = events[indexKey] = events[indexKey] || {};\r\n\r\n\t\t\t\tif (!typeIndex[contextId]) {\r\n\t\t\t\t\ttypeIndex[contextId] = [];\r\n\r\n\t\t\t\t\t// keep track of the number of keys in the index to quickly check if it's empty\r\n\t\t\t\t\tevents[indexLenKey] = (events[indexLenKey] || 0) + 1;\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttypeIndex[contextId].push(event);\r\n\r\n\r\n\t\t\t} else {\r\n\t\t\t\tevents[type] = events[type] || [];\r\n\t\t\t\tevents[type].push(event);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\thasEventListeners: function (type) { // (String) -> Boolean\r\n\t\tvar events = this[eventsKey];\r\n\t\treturn !!events && ((type in events && events[type].length > 0) ||\r\n\t\t                    (type + '_idx' in events && events[type + '_idx_len'] > 0));\r\n\t},\r\n\r\n\tremoveEventListener: function (types, fn, context) { // ([String, Function, Object]) or (Object[, Object])\r\n\r\n\t\tif (!this[eventsKey]) {\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tif (!types) {\r\n\t\t\treturn this.clearAllEventListeners();\r\n\t\t}\r\n\r\n\t\tif (L.Util.invokeEach(types, this.removeEventListener, this, fn, context)) { return this; }\r\n\r\n\t\tvar events = this[eventsKey],\r\n\t\t    contextId = context && context !== this && L.stamp(context),\r\n\t\t    i, len, type, listeners, j, indexKey, indexLenKey, typeIndex, removed;\r\n\r\n\t\ttypes = L.Util.splitWords(types);\r\n\r\n\t\tfor (i = 0, len = types.length; i < len; i++) {\r\n\t\t\ttype = types[i];\r\n\t\t\tindexKey = type + '_idx';\r\n\t\t\tindexLenKey = indexKey + '_len';\r\n\r\n\t\t\ttypeIndex = events[indexKey];\r\n\r\n\t\t\tif (!fn) {\r\n\t\t\t\t// clear all listeners for a type if function isn't specified\r\n\t\t\t\tdelete events[type];\r\n\t\t\t\tdelete events[indexKey];\r\n\t\t\t\tdelete events[indexLenKey];\r\n\r\n\t\t\t} else {\r\n\t\t\t\tlisteners = contextId && typeIndex ? typeIndex[contextId] : events[type];\r\n\r\n\t\t\t\tif (listeners) {\r\n\t\t\t\t\tfor (j = listeners.length - 1; j >= 0; j--) {\r\n\t\t\t\t\t\tif ((listeners[j].action === fn) && (!context || (listeners[j].context === context))) {\r\n\t\t\t\t\t\t\tremoved = listeners.splice(j, 1);\r\n\t\t\t\t\t\t\t// set the old action to a no-op, because it is possible\r\n\t\t\t\t\t\t\t// that the listener is being iterated over as part of a dispatch\r\n\t\t\t\t\t\t\tremoved[0].action = L.Util.falseFn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (context && typeIndex && (listeners.length === 0)) {\r\n\t\t\t\t\t\tdelete typeIndex[contextId];\r\n\t\t\t\t\t\tevents[indexLenKey]--;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tclearAllEventListeners: function () {\r\n\t\tdelete this[eventsKey];\r\n\t\treturn this;\r\n\t},\r\n\r\n\tfireEvent: function (type, data) { // (String[, Object])\r\n\t\tif (!this.hasEventListeners(type)) {\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tvar event = L.Util.extend({}, data, { type: type, target: this });\r\n\r\n\t\tvar events = this[eventsKey],\r\n\t\t    listeners, i, len, typeIndex, contextId;\r\n\r\n\t\tif (events[type]) {\r\n\t\t\t// make sure adding/removing listeners inside other listeners won't cause infinite loop\r\n\t\t\tlisteners = events[type].slice();\r\n\r\n\t\t\tfor (i = 0, len = listeners.length; i < len; i++) {\r\n\t\t\t\tlisteners[i].action.call(listeners[i].context, event);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// fire event for the context-indexed listeners as well\r\n\t\ttypeIndex = events[type + '_idx'];\r\n\r\n\t\tfor (contextId in typeIndex) {\r\n\t\t\tlisteners = typeIndex[contextId].slice();\r\n\r\n\t\t\tif (listeners) {\r\n\t\t\t\tfor (i = 0, len = listeners.length; i < len; i++) {\r\n\t\t\t\t\tlisteners[i].action.call(listeners[i].context, event);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\taddOneTimeEventListener: function (types, fn, context) {\r\n\r\n\t\tif (L.Util.invokeEach(types, this.addOneTimeEventListener, this, fn, context)) { return this; }\r\n\r\n\t\tvar handler = L.bind(function () {\r\n\t\t\tthis\r\n\t\t\t    .removeEventListener(types, fn, context)\r\n\t\t\t    .removeEventListener(types, handler, context);\r\n\t\t}, this);\r\n\r\n\t\treturn this\r\n\t\t    .addEventListener(types, fn, context)\r\n\t\t    .addEventListener(types, handler, context);\r\n\t}\r\n};\r\n\r\nL.Mixin.Events.on = L.Mixin.Events.addEventListener;\r\nL.Mixin.Events.off = L.Mixin.Events.removeEventListener;\r\nL.Mixin.Events.once = L.Mixin.Events.addOneTimeEventListener;\r\nL.Mixin.Events.fire = L.Mixin.Events.fireEvent;\r\n\n\n/*\r\n * L.Browser handles different browser and feature detections for internal Leaflet use.\r\n */\r\n\r\n(function () {\r\n\r\n\tvar ie = 'ActiveXObject' in window,\r\n\t\tielt9 = ie && !document.addEventListener,\r\n\r\n\t    // terrible browser detection to work around Safari / iOS / Android browser bugs\r\n\t    ua = navigator.userAgent.toLowerCase(),\r\n\t    webkit = ua.indexOf('webkit') !== -1,\r\n\t    chrome = ua.indexOf('chrome') !== -1,\r\n\t    phantomjs = ua.indexOf('phantom') !== -1,\r\n\t    android = ua.indexOf('android') !== -1,\r\n\t    android23 = ua.search('android [23]') !== -1,\r\n\t\tgecko = ua.indexOf('gecko') !== -1,\r\n\r\n\t    mobile = typeof orientation !== undefined + '',\r\n\t    msPointer = !window.PointerEvent && window.MSPointerEvent,\r\n\t\tpointer = (window.PointerEvent && window.navigator.pointerEnabled) ||\r\n\t\t\t\t  msPointer,\r\n\t    retina = ('devicePixelRatio' in window && window.devicePixelRatio > 1) ||\r\n\t             ('matchMedia' in window && window.matchMedia('(min-resolution:144dpi)') &&\r\n\t              window.matchMedia('(min-resolution:144dpi)').matches),\r\n\r\n\t    doc = document.documentElement,\r\n\t    ie3d = ie && ('transition' in doc.style),\r\n\t    webkit3d = ('WebKitCSSMatrix' in window) && ('m11' in new window.WebKitCSSMatrix()) && !android23,\r\n\t    gecko3d = 'MozPerspective' in doc.style,\r\n\t    opera3d = 'OTransition' in doc.style,\r\n\t    any3d = !window.L_DISABLE_3D && (ie3d || webkit3d || gecko3d || opera3d) && !phantomjs;\r\n\r\n\tvar touch = !window.L_NO_TOUCH && !phantomjs && (pointer || 'ontouchstart' in window ||\r\n\t\t(window.DocumentTouch && document instanceof window.DocumentTouch));\r\n\r\n\tL.Browser = {\r\n\t\tie: ie,\r\n\t\tielt9: ielt9,\r\n\t\twebkit: webkit,\r\n\t\tgecko: gecko && !webkit && !window.opera && !ie,\r\n\r\n\t\tandroid: android,\r\n\t\tandroid23: android23,\r\n\r\n\t\tchrome: chrome,\r\n\r\n\t\tie3d: ie3d,\r\n\t\twebkit3d: webkit3d,\r\n\t\tgecko3d: gecko3d,\r\n\t\topera3d: opera3d,\r\n\t\tany3d: any3d,\r\n\r\n\t\tmobile: mobile,\r\n\t\tmobileWebkit: mobile && webkit,\r\n\t\tmobileWebkit3d: mobile && webkit3d,\r\n\t\tmobileOpera: mobile && window.opera,\r\n\r\n\t\ttouch: touch,\r\n\t\tmsPointer: msPointer,\r\n\t\tpointer: pointer,\r\n\r\n\t\tretina: retina\r\n\t};\r\n\r\n}());\r\n\n\n/*\r\n * L.Point represents a point with x and y coordinates.\r\n */\r\n\r\nL.Point = function (/*Number*/ x, /*Number*/ y, /*Boolean*/ round) {\r\n\tthis.x = (round ? Math.round(x) : x);\r\n\tthis.y = (round ? Math.round(y) : y);\r\n};\r\n\r\nL.Point.prototype = {\r\n\r\n\tclone: function () {\r\n\t\treturn new L.Point(this.x, this.y);\r\n\t},\r\n\r\n\t// non-destructive, returns a new point\r\n\tadd: function (point) {\r\n\t\treturn this.clone()._add(L.point(point));\r\n\t},\r\n\r\n\t// destructive, used directly for performance in situations where it's safe to modify existing point\r\n\t_add: function (point) {\r\n\t\tthis.x += point.x;\r\n\t\tthis.y += point.y;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsubtract: function (point) {\r\n\t\treturn this.clone()._subtract(L.point(point));\r\n\t},\r\n\r\n\t_subtract: function (point) {\r\n\t\tthis.x -= point.x;\r\n\t\tthis.y -= point.y;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tdivideBy: function (num) {\r\n\t\treturn this.clone()._divideBy(num);\r\n\t},\r\n\r\n\t_divideBy: function (num) {\r\n\t\tthis.x /= num;\r\n\t\tthis.y /= num;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tmultiplyBy: function (num) {\r\n\t\treturn this.clone()._multiplyBy(num);\r\n\t},\r\n\r\n\t_multiplyBy: function (num) {\r\n\t\tthis.x *= num;\r\n\t\tthis.y *= num;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tround: function () {\r\n\t\treturn this.clone()._round();\r\n\t},\r\n\r\n\t_round: function () {\r\n\t\tthis.x = Math.round(this.x);\r\n\t\tthis.y = Math.round(this.y);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tfloor: function () {\r\n\t\treturn this.clone()._floor();\r\n\t},\r\n\r\n\t_floor: function () {\r\n\t\tthis.x = Math.floor(this.x);\r\n\t\tthis.y = Math.floor(this.y);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tdistanceTo: function (point) {\r\n\t\tpoint = L.point(point);\r\n\r\n\t\tvar x = point.x - this.x,\r\n\t\t    y = point.y - this.y;\r\n\r\n\t\treturn Math.sqrt(x * x + y * y);\r\n\t},\r\n\r\n\tequals: function (point) {\r\n\t\tpoint = L.point(point);\r\n\r\n\t\treturn point.x === this.x &&\r\n\t\t       point.y === this.y;\r\n\t},\r\n\r\n\tcontains: function (point) {\r\n\t\tpoint = L.point(point);\r\n\r\n\t\treturn Math.abs(point.x) <= Math.abs(this.x) &&\r\n\t\t       Math.abs(point.y) <= Math.abs(this.y);\r\n\t},\r\n\r\n\ttoString: function () {\r\n\t\treturn 'Point(' +\r\n\t\t        L.Util.formatNum(this.x) + ', ' +\r\n\t\t        L.Util.formatNum(this.y) + ')';\r\n\t}\r\n};\r\n\r\nL.point = function (x, y, round) {\r\n\tif (x instanceof L.Point) {\r\n\t\treturn x;\r\n\t}\r\n\tif (L.Util.isArray(x)) {\r\n\t\treturn new L.Point(x[0], x[1]);\r\n\t}\r\n\tif (x === undefined || x === null) {\r\n\t\treturn x;\r\n\t}\r\n\treturn new L.Point(x, y, round);\r\n};\r\n\n\n/*\r\n * L.Bounds represents a rectangular area on the screen in pixel coordinates.\r\n */\r\n\r\nL.Bounds = function (a, b) { //(Point, Point) or Point[]\r\n\tif (!a) { return; }\r\n\r\n\tvar points = b ? [a, b] : a;\r\n\r\n\tfor (var i = 0, len = points.length; i < len; i++) {\r\n\t\tthis.extend(points[i]);\r\n\t}\r\n};\r\n\r\nL.Bounds.prototype = {\r\n\t// extend the bounds to contain the given point\r\n\textend: function (point) { // (Point)\r\n\t\tpoint = L.point(point);\r\n\r\n\t\tif (!this.min && !this.max) {\r\n\t\t\tthis.min = point.clone();\r\n\t\t\tthis.max = point.clone();\r\n\t\t} else {\r\n\t\t\tthis.min.x = Math.min(point.x, this.min.x);\r\n\t\t\tthis.max.x = Math.max(point.x, this.max.x);\r\n\t\t\tthis.min.y = Math.min(point.y, this.min.y);\r\n\t\t\tthis.max.y = Math.max(point.y, this.max.y);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tgetCenter: function (round) { // (Boolean) -> Point\r\n\t\treturn new L.Point(\r\n\t\t        (this.min.x + this.max.x) / 2,\r\n\t\t        (this.min.y + this.max.y) / 2, round);\r\n\t},\r\n\r\n\tgetBottomLeft: function () { // -> Point\r\n\t\treturn new L.Point(this.min.x, this.max.y);\r\n\t},\r\n\r\n\tgetTopRight: function () { // -> Point\r\n\t\treturn new L.Point(this.max.x, this.min.y);\r\n\t},\r\n\r\n\tgetSize: function () {\r\n\t\treturn this.max.subtract(this.min);\r\n\t},\r\n\r\n\tcontains: function (obj) { // (Bounds) or (Point) -> Boolean\r\n\t\tvar min, max;\r\n\r\n\t\tif (typeof obj[0] === 'number' || obj instanceof L.Point) {\r\n\t\t\tobj = L.point(obj);\r\n\t\t} else {\r\n\t\t\tobj = L.bounds(obj);\r\n\t\t}\r\n\r\n\t\tif (obj instanceof L.Bounds) {\r\n\t\t\tmin = obj.min;\r\n\t\t\tmax = obj.max;\r\n\t\t} else {\r\n\t\t\tmin = max = obj;\r\n\t\t}\r\n\r\n\t\treturn (min.x >= this.min.x) &&\r\n\t\t       (max.x <= this.max.x) &&\r\n\t\t       (min.y >= this.min.y) &&\r\n\t\t       (max.y <= this.max.y);\r\n\t},\r\n\r\n\tintersects: function (bounds) { // (Bounds) -> Boolean\r\n\t\tbounds = L.bounds(bounds);\r\n\r\n\t\tvar min = this.min,\r\n\t\t    max = this.max,\r\n\t\t    min2 = bounds.min,\r\n\t\t    max2 = bounds.max,\r\n\t\t    xIntersects = (max2.x >= min.x) && (min2.x <= max.x),\r\n\t\t    yIntersects = (max2.y >= min.y) && (min2.y <= max.y);\r\n\r\n\t\treturn xIntersects && yIntersects;\r\n\t},\r\n\r\n\tisValid: function () {\r\n\t\treturn !!(this.min && this.max);\r\n\t}\r\n};\r\n\r\nL.bounds = function (a, b) { // (Bounds) or (Point, Point) or (Point[])\r\n\tif (!a || a instanceof L.Bounds) {\r\n\t\treturn a;\r\n\t}\r\n\treturn new L.Bounds(a, b);\r\n};\r\n\n\n/*\r\n * L.Transformation is an utility class to perform simple point transformations through a 2d-matrix.\r\n */\r\n\r\nL.Transformation = function (a, b, c, d) {\r\n\tthis._a = a;\r\n\tthis._b = b;\r\n\tthis._c = c;\r\n\tthis._d = d;\r\n};\r\n\r\nL.Transformation.prototype = {\r\n\ttransform: function (point, scale) { // (Point, Number) -> Point\r\n\t\treturn this._transform(point.clone(), scale);\r\n\t},\r\n\r\n\t// destructive transform (faster)\r\n\t_transform: function (point, scale) {\r\n\t\tscale = scale || 1;\r\n\t\tpoint.x = scale * (this._a * point.x + this._b);\r\n\t\tpoint.y = scale * (this._c * point.y + this._d);\r\n\t\treturn point;\r\n\t},\r\n\r\n\tuntransform: function (point, scale) {\r\n\t\tscale = scale || 1;\r\n\t\treturn new L.Point(\r\n\t\t        (point.x / scale - this._b) / this._a,\r\n\t\t        (point.y / scale - this._d) / this._c);\r\n\t}\r\n};\r\n\n\n/*\r\n * L.DomUtil contains various utility functions for working with DOM.\r\n */\r\n\r\nL.DomUtil = {\r\n\tget: function (id) {\r\n\t\treturn (typeof id === 'string' ? document.getElementById(id) : id);\r\n\t},\r\n\r\n\tgetStyle: function (el, style) {\r\n\r\n\t\tvar value = el.style[style];\r\n\r\n\t\tif (!value && el.currentStyle) {\r\n\t\t\tvalue = el.currentStyle[style];\r\n\t\t}\r\n\r\n\t\tif ((!value || value === 'auto') && document.defaultView) {\r\n\t\t\tvar css = document.defaultView.getComputedStyle(el, null);\r\n\t\t\tvalue = css ? css[style] : null;\r\n\t\t}\r\n\r\n\t\treturn value === 'auto' ? null : value;\r\n\t},\r\n\r\n\tgetViewportOffset: function (element) {\r\n\r\n\t\tvar top = 0,\r\n\t\t    left = 0,\r\n\t\t    el = element,\r\n\t\t    docBody = document.body,\r\n\t\t    docEl = document.documentElement,\r\n\t\t    pos;\r\n\r\n\t\tdo {\r\n\t\t\ttop  += el.offsetTop  || 0;\r\n\t\t\tleft += el.offsetLeft || 0;\r\n\r\n\t\t\t//add borders\r\n\t\t\ttop += parseInt(L.DomUtil.getStyle(el, 'borderTopWidth'), 10) || 0;\r\n\t\t\tleft += parseInt(L.DomUtil.getStyle(el, 'borderLeftWidth'), 10) || 0;\r\n\r\n\t\t\tpos = L.DomUtil.getStyle(el, 'position');\r\n\r\n\t\t\tif (el.offsetParent === docBody && pos === 'absolute') { break; }\r\n\r\n\t\t\tif (pos === 'fixed') {\r\n\t\t\t\ttop  += docBody.scrollTop  || docEl.scrollTop  || 0;\r\n\t\t\t\tleft += docBody.scrollLeft || docEl.scrollLeft || 0;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tif (pos === 'relative' && !el.offsetLeft) {\r\n\t\t\t\tvar width = L.DomUtil.getStyle(el, 'width'),\r\n\t\t\t\t    maxWidth = L.DomUtil.getStyle(el, 'max-width'),\r\n\t\t\t\t    r = el.getBoundingClientRect();\r\n\r\n\t\t\t\tif (width !== 'none' || maxWidth !== 'none') {\r\n\t\t\t\t\tleft += r.left + el.clientLeft;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//calculate full y offset since we're breaking out of the loop\r\n\t\t\t\ttop += r.top + (docBody.scrollTop  || docEl.scrollTop  || 0);\r\n\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tel = el.offsetParent;\r\n\r\n\t\t} while (el);\r\n\r\n\t\tel = element;\r\n\r\n\t\tdo {\r\n\t\t\tif (el === docBody) { break; }\r\n\r\n\t\t\ttop  -= el.scrollTop  || 0;\r\n\t\t\tleft -= el.scrollLeft || 0;\r\n\r\n\t\t\tel = el.parentNode;\r\n\t\t} while (el);\r\n\r\n\t\treturn new L.Point(left, top);\r\n\t},\r\n\r\n\tdocumentIsLtr: function () {\r\n\t\tif (!L.DomUtil._docIsLtrCached) {\r\n\t\t\tL.DomUtil._docIsLtrCached = true;\r\n\t\t\tL.DomUtil._docIsLtr = L.DomUtil.getStyle(document.body, 'direction') === 'ltr';\r\n\t\t}\r\n\t\treturn L.DomUtil._docIsLtr;\r\n\t},\r\n\r\n\tcreate: function (tagName, className, container) {\r\n\r\n\t\tvar el = document.createElement(tagName);\r\n\t\tel.className = className;\r\n\r\n\t\tif (container) {\r\n\t\t\tcontainer.appendChild(el);\r\n\t\t}\r\n\r\n\t\treturn el;\r\n\t},\r\n\r\n\thasClass: function (el, name) {\r\n\t\tif (el.classList !== undefined) {\r\n\t\t\treturn el.classList.contains(name);\r\n\t\t}\r\n\t\tvar className = L.DomUtil._getClass(el);\r\n\t\treturn className.length > 0 && new RegExp('(^|\\\\s)' + name + '(\\\\s|$)').test(className);\r\n\t},\r\n\r\n\taddClass: function (el, name) {\r\n\t\tif (el.classList !== undefined) {\r\n\t\t\tvar classes = L.Util.splitWords(name);\r\n\t\t\tfor (var i = 0, len = classes.length; i < len; i++) {\r\n\t\t\t\tel.classList.add(classes[i]);\r\n\t\t\t}\r\n\t\t} else if (!L.DomUtil.hasClass(el, name)) {\r\n\t\t\tvar className = L.DomUtil._getClass(el);\r\n\t\t\tL.DomUtil._setClass(el, (className ? className + ' ' : '') + name);\r\n\t\t}\r\n\t},\r\n\r\n\tremoveClass: function (el, name) {\r\n\t\tif (el.classList !== undefined) {\r\n\t\t\tel.classList.remove(name);\r\n\t\t} else {\r\n\t\t\tL.DomUtil._setClass(el, L.Util.trim((' ' + L.DomUtil._getClass(el) + ' ').replace(' ' + name + ' ', ' ')));\r\n\t\t}\r\n\t},\r\n\r\n\t_setClass: function (el, name) {\r\n\t\tif (el.className.baseVal === undefined) {\r\n\t\t\tel.className = name;\r\n\t\t} else {\r\n\t\t\t// in case of SVG element\r\n\t\t\tel.className.baseVal = name;\r\n\t\t}\r\n\t},\r\n\r\n\t_getClass: function (el) {\r\n\t\treturn el.className.baseVal === undefined ? el.className : el.className.baseVal;\r\n\t},\r\n\r\n\tsetOpacity: function (el, value) {\r\n\r\n\t\tif ('opacity' in el.style) {\r\n\t\t\tel.style.opacity = value;\r\n\r\n\t\t} else if ('filter' in el.style) {\r\n\r\n\t\t\tvar filter = false,\r\n\t\t\t    filterName = 'DXImageTransform.Microsoft.Alpha';\r\n\r\n\t\t\t// filters collection throws an error if we try to retrieve a filter that doesn't exist\r\n\t\t\ttry {\r\n\t\t\t\tfilter = el.filters.item(filterName);\r\n\t\t\t} catch (e) {\r\n\t\t\t\t// don't set opacity to 1 if we haven't already set an opacity,\r\n\t\t\t\t// it isn't needed and breaks transparent pngs.\r\n\t\t\t\tif (value === 1) { return; }\r\n\t\t\t}\r\n\r\n\t\t\tvalue = Math.round(value * 100);\r\n\r\n\t\t\tif (filter) {\r\n\t\t\t\tfilter.Enabled = (value !== 100);\r\n\t\t\t\tfilter.Opacity = value;\r\n\t\t\t} else {\r\n\t\t\t\tel.style.filter += ' progid:' + filterName + '(opacity=' + value + ')';\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\ttestProp: function (props) {\r\n\r\n\t\tvar style = document.documentElement.style;\r\n\r\n\t\tfor (var i = 0; i < props.length; i++) {\r\n\t\t\tif (props[i] in style) {\r\n\t\t\t\treturn props[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t},\r\n\r\n\tgetTranslateString: function (point) {\r\n\t\t// on WebKit browsers (Chrome/Safari/iOS Safari/Android) using translate3d instead of translate\r\n\t\t// makes animation smoother as it ensures HW accel is used. Firefox 13 doesn't care\r\n\t\t// (same speed either way), Opera 12 doesn't support translate3d\r\n\r\n\t\tvar is3d = L.Browser.webkit3d,\r\n\t\t    open = 'translate' + (is3d ? '3d' : '') + '(',\r\n\t\t    close = (is3d ? ',0' : '') + ')';\r\n\r\n\t\treturn open + point.x + 'px,' + point.y + 'px' + close;\r\n\t},\r\n\r\n\tgetScaleString: function (scale, origin) {\r\n\r\n\t\tvar preTranslateStr = L.DomUtil.getTranslateString(origin.add(origin.multiplyBy(-1 * scale))),\r\n\t\t    scaleStr = ' scale(' + scale + ') ';\r\n\r\n\t\treturn preTranslateStr + scaleStr;\r\n\t},\r\n\r\n\tsetPosition: function (el, point, disable3D) { // (HTMLElement, Point[, Boolean])\r\n\r\n\t\t// jshint camelcase: false\r\n\t\tel._leaflet_pos = point;\r\n\r\n\t\tif (!disable3D && L.Browser.any3d) {\r\n\t\t\tel.style[L.DomUtil.TRANSFORM] =  L.DomUtil.getTranslateString(point);\r\n\t\t} else {\r\n\t\t\tel.style.left = point.x + 'px';\r\n\t\t\tel.style.top = point.y + 'px';\r\n\t\t}\r\n\t},\r\n\r\n\tgetPosition: function (el) {\r\n\t\t// this method is only used for elements previously positioned using setPosition,\r\n\t\t// so it's safe to cache the position for performance\r\n\r\n\t\t// jshint camelcase: false\r\n\t\treturn el._leaflet_pos;\r\n\t}\r\n};\r\n\r\n\r\n// prefix style property names\r\n\r\nL.DomUtil.TRANSFORM = L.DomUtil.testProp(\r\n        ['transform', 'WebkitTransform', 'OTransform', 'MozTransform', 'msTransform']);\r\n\r\n// webkitTransition comes first because some browser versions that drop vendor prefix don't do\r\n// the same for the transitionend event, in particular the Android 4.1 stock browser\r\n\r\nL.DomUtil.TRANSITION = L.DomUtil.testProp(\r\n        ['webkitTransition', 'transition', 'OTransition', 'MozTransition', 'msTransition']);\r\n\r\nL.DomUtil.TRANSITION_END =\r\n        L.DomUtil.TRANSITION === 'webkitTransition' || L.DomUtil.TRANSITION === 'OTransition' ?\r\n        L.DomUtil.TRANSITION + 'End' : 'transitionend';\r\n\r\n(function () {\r\n    if ('onselectstart' in document) {\r\n        L.extend(L.DomUtil, {\r\n            disableTextSelection: function () {\r\n                L.DomEvent.on(window, 'selectstart', L.DomEvent.preventDefault);\r\n            },\r\n\r\n            enableTextSelection: function () {\r\n                L.DomEvent.off(window, 'selectstart', L.DomEvent.preventDefault);\r\n            }\r\n        });\r\n    } else {\r\n        var userSelectProperty = L.DomUtil.testProp(\r\n            ['userSelect', 'WebkitUserSelect', 'OUserSelect', 'MozUserSelect', 'msUserSelect']);\r\n\r\n        L.extend(L.DomUtil, {\r\n            disableTextSelection: function () {\r\n                if (userSelectProperty) {\r\n                    var style = document.documentElement.style;\r\n                    this._userSelect = style[userSelectProperty];\r\n                    style[userSelectProperty] = 'none';\r\n                }\r\n            },\r\n\r\n            enableTextSelection: function () {\r\n                if (userSelectProperty) {\r\n                    document.documentElement.style[userSelectProperty] = this._userSelect;\r\n                    delete this._userSelect;\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n\tL.extend(L.DomUtil, {\r\n\t\tdisableImageDrag: function () {\r\n\t\t\tL.DomEvent.on(window, 'dragstart', L.DomEvent.preventDefault);\r\n\t\t},\r\n\r\n\t\tenableImageDrag: function () {\r\n\t\t\tL.DomEvent.off(window, 'dragstart', L.DomEvent.preventDefault);\r\n\t\t}\r\n\t});\r\n})();\r\n\n\n/*\r\n * L.LatLng represents a geographical point with latitude and longitude coordinates.\r\n */\r\n\r\nL.LatLng = function (lat, lng, alt) { // (Number, Number, Number)\r\n\tlat = parseFloat(lat);\r\n\tlng = parseFloat(lng);\r\n\r\n\tif (isNaN(lat) || isNaN(lng)) {\r\n\t\tthrow new Error('Invalid LatLng object: (' + lat + ', ' + lng + ')');\r\n\t}\r\n\r\n\tthis.lat = lat;\r\n\tthis.lng = lng;\r\n\r\n\tif (alt !== undefined) {\r\n\t\tthis.alt = parseFloat(alt);\r\n\t}\r\n};\r\n\r\nL.extend(L.LatLng, {\r\n\tDEG_TO_RAD: Math.PI / 180,\r\n\tRAD_TO_DEG: 180 / Math.PI,\r\n\tMAX_MARGIN: 1.0E-9 // max margin of error for the \"equals\" check\r\n});\r\n\r\nL.LatLng.prototype = {\r\n\tequals: function (obj) { // (LatLng) -> Boolean\r\n\t\tif (!obj) { return false; }\r\n\r\n\t\tobj = L.latLng(obj);\r\n\r\n\t\tvar margin = Math.max(\r\n\t\t        Math.abs(this.lat - obj.lat),\r\n\t\t        Math.abs(this.lng - obj.lng));\r\n\r\n\t\treturn margin <= L.LatLng.MAX_MARGIN;\r\n\t},\r\n\r\n\ttoString: function (precision) { // (Number) -> String\r\n\t\treturn 'LatLng(' +\r\n\t\t        L.Util.formatNum(this.lat, precision) + ', ' +\r\n\t\t        L.Util.formatNum(this.lng, precision) + ')';\r\n\t},\r\n\r\n\t// Haversine distance formula, see http://en.wikipedia.org/wiki/Haversine_formula\r\n\t// TODO move to projection code, LatLng shouldn't know about Earth\r\n\tdistanceTo: function (other) { // (LatLng) -> Number\r\n\t\tother = L.latLng(other);\r\n\r\n\t\tvar R = 6378137, // earth radius in meters\r\n\t\t    d2r = L.LatLng.DEG_TO_RAD,\r\n\t\t    dLat = (other.lat - this.lat) * d2r,\r\n\t\t    dLon = (other.lng - this.lng) * d2r,\r\n\t\t    lat1 = this.lat * d2r,\r\n\t\t    lat2 = other.lat * d2r,\r\n\t\t    sin1 = Math.sin(dLat / 2),\r\n\t\t    sin2 = Math.sin(dLon / 2);\r\n\r\n\t\tvar a = sin1 * sin1 + sin2 * sin2 * Math.cos(lat1) * Math.cos(lat2);\r\n\r\n\t\treturn R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n\t},\r\n\r\n\twrap: function (a, b) { // (Number, Number) -> LatLng\r\n\t\tvar lng = this.lng;\r\n\r\n\t\ta = a || -180;\r\n\t\tb = b ||  180;\r\n\r\n\t\tlng = (lng + b) % (b - a) + (lng < a || lng === b ? b : a);\r\n\r\n\t\treturn new L.LatLng(this.lat, lng);\r\n\t}\r\n};\r\n\r\nL.latLng = function (a, b) { // (LatLng) or ([Number, Number]) or (Number, Number)\r\n\tif (a instanceof L.LatLng) {\r\n\t\treturn a;\r\n\t}\r\n\tif (L.Util.isArray(a)) {\r\n\t\tif (typeof a[0] === 'number' || typeof a[0] === 'string') {\r\n\t\t\treturn new L.LatLng(a[0], a[1], a[2]);\r\n\t\t} else {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\tif (a === undefined || a === null) {\r\n\t\treturn a;\r\n\t}\r\n\tif (typeof a === 'object' && 'lat' in a) {\r\n\t\treturn new L.LatLng(a.lat, 'lng' in a ? a.lng : a.lon);\r\n\t}\r\n\tif (b === undefined) {\r\n\t\treturn null;\r\n\t}\r\n\treturn new L.LatLng(a, b);\r\n};\r\n\r\n\n\n/*\r\n * L.LatLngBounds represents a rectangular area on the map in geographical coordinates.\r\n */\r\n\r\nL.LatLngBounds = function (southWest, northEast) { // (LatLng, LatLng) or (LatLng[])\r\n\tif (!southWest) { return; }\r\n\r\n\tvar latlngs = northEast ? [southWest, northEast] : southWest;\r\n\r\n\tfor (var i = 0, len = latlngs.length; i < len; i++) {\r\n\t\tthis.extend(latlngs[i]);\r\n\t}\r\n};\r\n\r\nL.LatLngBounds.prototype = {\r\n\t// extend the bounds to contain the given point or bounds\r\n\textend: function (obj) { // (LatLng) or (LatLngBounds)\r\n\t\tif (!obj) { return this; }\r\n\r\n\t\tvar latLng = L.latLng(obj);\r\n\t\tif (latLng !== null) {\r\n\t\t\tobj = latLng;\r\n\t\t} else {\r\n\t\t\tobj = L.latLngBounds(obj);\r\n\t\t}\r\n\r\n\t\tif (obj instanceof L.LatLng) {\r\n\t\t\tif (!this._southWest && !this._northEast) {\r\n\t\t\t\tthis._southWest = new L.LatLng(obj.lat, obj.lng);\r\n\t\t\t\tthis._northEast = new L.LatLng(obj.lat, obj.lng);\r\n\t\t\t} else {\r\n\t\t\t\tthis._southWest.lat = Math.min(obj.lat, this._southWest.lat);\r\n\t\t\t\tthis._southWest.lng = Math.min(obj.lng, this._southWest.lng);\r\n\r\n\t\t\t\tthis._northEast.lat = Math.max(obj.lat, this._northEast.lat);\r\n\t\t\t\tthis._northEast.lng = Math.max(obj.lng, this._northEast.lng);\r\n\t\t\t}\r\n\t\t} else if (obj instanceof L.LatLngBounds) {\r\n\t\t\tthis.extend(obj._southWest);\r\n\t\t\tthis.extend(obj._northEast);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\t// extend the bounds by a percentage\r\n\tpad: function (bufferRatio) { // (Number) -> LatLngBounds\r\n\t\tvar sw = this._southWest,\r\n\t\t    ne = this._northEast,\r\n\t\t    heightBuffer = Math.abs(sw.lat - ne.lat) * bufferRatio,\r\n\t\t    widthBuffer = Math.abs(sw.lng - ne.lng) * bufferRatio;\r\n\r\n\t\treturn new L.LatLngBounds(\r\n\t\t        new L.LatLng(sw.lat - heightBuffer, sw.lng - widthBuffer),\r\n\t\t        new L.LatLng(ne.lat + heightBuffer, ne.lng + widthBuffer));\r\n\t},\r\n\r\n\tgetCenter: function () { // -> LatLng\r\n\t\treturn new L.LatLng(\r\n\t\t        (this._southWest.lat + this._northEast.lat) / 2,\r\n\t\t        (this._southWest.lng + this._northEast.lng) / 2);\r\n\t},\r\n\r\n\tgetSouthWest: function () {\r\n\t\treturn this._southWest;\r\n\t},\r\n\r\n\tgetNorthEast: function () {\r\n\t\treturn this._northEast;\r\n\t},\r\n\r\n\tgetNorthWest: function () {\r\n\t\treturn new L.LatLng(this.getNorth(), this.getWest());\r\n\t},\r\n\r\n\tgetSouthEast: function () {\r\n\t\treturn new L.LatLng(this.getSouth(), this.getEast());\r\n\t},\r\n\r\n\tgetWest: function () {\r\n\t\treturn this._southWest.lng;\r\n\t},\r\n\r\n\tgetSouth: function () {\r\n\t\treturn this._southWest.lat;\r\n\t},\r\n\r\n\tgetEast: function () {\r\n\t\treturn this._northEast.lng;\r\n\t},\r\n\r\n\tgetNorth: function () {\r\n\t\treturn this._northEast.lat;\r\n\t},\r\n\r\n\tcontains: function (obj) { // (LatLngBounds) or (LatLng) -> Boolean\r\n\t\tif (typeof obj[0] === 'number' || obj instanceof L.LatLng) {\r\n\t\t\tobj = L.latLng(obj);\r\n\t\t} else {\r\n\t\t\tobj = L.latLngBounds(obj);\r\n\t\t}\r\n\r\n\t\tvar sw = this._southWest,\r\n\t\t    ne = this._northEast,\r\n\t\t    sw2, ne2;\r\n\r\n\t\tif (obj instanceof L.LatLngBounds) {\r\n\t\t\tsw2 = obj.getSouthWest();\r\n\t\t\tne2 = obj.getNorthEast();\r\n\t\t} else {\r\n\t\t\tsw2 = ne2 = obj;\r\n\t\t}\r\n\r\n\t\treturn (sw2.lat >= sw.lat) && (ne2.lat <= ne.lat) &&\r\n\t\t       (sw2.lng >= sw.lng) && (ne2.lng <= ne.lng);\r\n\t},\r\n\r\n\tintersects: function (bounds) { // (LatLngBounds)\r\n\t\tbounds = L.latLngBounds(bounds);\r\n\r\n\t\tvar sw = this._southWest,\r\n\t\t    ne = this._northEast,\r\n\t\t    sw2 = bounds.getSouthWest(),\r\n\t\t    ne2 = bounds.getNorthEast(),\r\n\r\n\t\t    latIntersects = (ne2.lat >= sw.lat) && (sw2.lat <= ne.lat),\r\n\t\t    lngIntersects = (ne2.lng >= sw.lng) && (sw2.lng <= ne.lng);\r\n\r\n\t\treturn latIntersects && lngIntersects;\r\n\t},\r\n\r\n\ttoBBoxString: function () {\r\n\t\treturn [this.getWest(), this.getSouth(), this.getEast(), this.getNorth()].join(',');\r\n\t},\r\n\r\n\tequals: function (bounds) { // (LatLngBounds)\r\n\t\tif (!bounds) { return false; }\r\n\r\n\t\tbounds = L.latLngBounds(bounds);\r\n\r\n\t\treturn this._southWest.equals(bounds.getSouthWest()) &&\r\n\t\t       this._northEast.equals(bounds.getNorthEast());\r\n\t},\r\n\r\n\tisValid: function () {\r\n\t\treturn !!(this._southWest && this._northEast);\r\n\t}\r\n};\r\n\r\n//TODO International date line?\r\n\r\nL.latLngBounds = function (a, b) { // (LatLngBounds) or (LatLng, LatLng)\r\n\tif (!a || a instanceof L.LatLngBounds) {\r\n\t\treturn a;\r\n\t}\r\n\treturn new L.LatLngBounds(a, b);\r\n};\r\n\n\n/*\r\n * L.Projection contains various geographical projections used by CRS classes.\r\n */\r\n\r\nL.Projection = {};\r\n\n\n/*\r\n * Spherical Mercator is the most popular map projection, used by EPSG:3857 CRS used by default.\r\n */\r\n\r\nL.Projection.SphericalMercator = {\r\n\tMAX_LATITUDE: 85.0511287798,\r\n\r\n\tproject: function (latlng) { // (LatLng) -> Point\r\n\t\tvar d = L.LatLng.DEG_TO_RAD,\r\n\t\t    max = this.MAX_LATITUDE,\r\n\t\t    lat = Math.max(Math.min(max, latlng.lat), -max),\r\n\t\t    x = latlng.lng * d,\r\n\t\t    y = lat * d;\r\n\r\n\t\ty = Math.log(Math.tan((Math.PI / 4) + (y / 2)));\r\n\r\n\t\treturn new L.Point(x, y);\r\n\t},\r\n\r\n\tunproject: function (point) { // (Point, Boolean) -> LatLng\r\n\t\tvar d = L.LatLng.RAD_TO_DEG,\r\n\t\t    lng = point.x * d,\r\n\t\t    lat = (2 * Math.atan(Math.exp(point.y)) - (Math.PI / 2)) * d;\r\n\r\n\t\treturn new L.LatLng(lat, lng);\r\n\t}\r\n};\r\n\n\n/*\r\n * Simple equirectangular (Plate Carree) projection, used by CRS like EPSG:4326 and Simple.\r\n */\r\n\r\nL.Projection.LonLat = {\r\n\tproject: function (latlng) {\r\n\t\treturn new L.Point(latlng.lng, latlng.lat);\r\n\t},\r\n\r\n\tunproject: function (point) {\r\n\t\treturn new L.LatLng(point.y, point.x);\r\n\t}\r\n};\r\n\n\n/*\r\n * L.CRS is a base object for all defined CRS (Coordinate Reference Systems) in Leaflet.\r\n */\r\n\r\nL.CRS = {\r\n\tlatLngToPoint: function (latlng, zoom) { // (LatLng, Number) -> Point\r\n\t\tvar projectedPoint = this.projection.project(latlng),\r\n\t\t    scale = this.scale(zoom);\r\n\r\n\t\treturn this.transformation._transform(projectedPoint, scale);\r\n\t},\r\n\r\n\tpointToLatLng: function (point, zoom) { // (Point, Number[, Boolean]) -> LatLng\r\n\t\tvar scale = this.scale(zoom),\r\n\t\t    untransformedPoint = this.transformation.untransform(point, scale);\r\n\r\n\t\treturn this.projection.unproject(untransformedPoint);\r\n\t},\r\n\r\n\tproject: function (latlng) {\r\n\t\treturn this.projection.project(latlng);\r\n\t},\r\n\r\n\tscale: function (zoom) {\r\n\t\treturn 256 * Math.pow(2, zoom);\r\n\t},\r\n\r\n\tgetSize: function (zoom) {\r\n\t\tvar s = this.scale(zoom);\r\n\t\treturn L.point(s, s);\r\n\t}\r\n};\r\n\n\n/*\n * A simple CRS that can be used for flat non-Earth maps like panoramas or game maps.\n */\n\nL.CRS.Simple = L.extend({}, L.CRS, {\n\tprojection: L.Projection.LonLat,\n\ttransformation: new L.Transformation(1, 0, -1, 0),\n\n\tscale: function (zoom) {\n\t\treturn Math.pow(2, zoom);\n\t}\n});\n\n\n/*\r\n * L.CRS.EPSG3857 (Spherical Mercator) is the most common CRS for web mapping\r\n * and is used by Leaflet by default.\r\n */\r\n\r\nL.CRS.EPSG3857 = L.extend({}, L.CRS, {\r\n\tcode: 'EPSG:3857',\r\n\r\n\tprojection: L.Projection.SphericalMercator,\r\n\ttransformation: new L.Transformation(0.5 / Math.PI, 0.5, -0.5 / Math.PI, 0.5),\r\n\r\n\tproject: function (latlng) { // (LatLng) -> Point\r\n\t\tvar projectedPoint = this.projection.project(latlng),\r\n\t\t    earthRadius = 6378137;\r\n\t\treturn projectedPoint.multiplyBy(earthRadius);\r\n\t}\r\n});\r\n\r\nL.CRS.EPSG900913 = L.extend({}, L.CRS.EPSG3857, {\r\n\tcode: 'EPSG:900913'\r\n});\r\n\n\n/*\r\n * L.CRS.EPSG4326 is a CRS popular among advanced GIS specialists.\r\n */\r\n\r\nL.CRS.EPSG4326 = L.extend({}, L.CRS, {\r\n\tcode: 'EPSG:4326',\r\n\r\n\tprojection: L.Projection.LonLat,\r\n\ttransformation: new L.Transformation(1 / 360, 0.5, -1 / 360, 0.5)\r\n});\r\n\n\n/*\r\n * L.Map is the central class of the API - it is used to create a map.\r\n */\r\n\r\nL.Map = L.Class.extend({\r\n\r\n\tincludes: L.Mixin.Events,\r\n\r\n\toptions: {\r\n\t\tcrs: L.CRS.EPSG3857,\r\n\r\n\t\t/*\r\n\t\tcenter: LatLng,\r\n\t\tzoom: Number,\r\n\t\tlayers: Array,\r\n\t\t*/\r\n\r\n\t\tfadeAnimation: L.DomUtil.TRANSITION && !L.Browser.android23,\r\n\t\ttrackResize: true,\r\n\t\tmarkerZoomAnimation: L.DomUtil.TRANSITION && L.Browser.any3d\r\n\t},\r\n\r\n\tinitialize: function (id, options) { // (HTMLElement or String, Object)\r\n\t\toptions = L.setOptions(this, options);\r\n\r\n\r\n\t\tthis._initContainer(id);\r\n\t\tthis._initLayout();\r\n\r\n\t\t// hack for https://github.com/Leaflet/Leaflet/issues/1980\r\n\t\tthis._onResize = L.bind(this._onResize, this);\r\n\r\n\t\tthis._initEvents();\r\n\r\n\t\tif (options.maxBounds) {\r\n\t\t\tthis.setMaxBounds(options.maxBounds);\r\n\t\t}\r\n\r\n\t\tif (options.center && options.zoom !== undefined) {\r\n\t\t\tthis.setView(L.latLng(options.center), options.zoom, {reset: true});\r\n\t\t}\r\n\r\n\t\tthis._handlers = [];\r\n\r\n\t\tthis._layers = {};\r\n\t\tthis._zoomBoundLayers = {};\r\n\t\tthis._tileLayersNum = 0;\r\n\r\n\t\tthis.callInitHooks();\r\n\r\n\t\tthis._addLayers(options.layers);\r\n\t},\r\n\r\n\r\n\t// public methods that modify map state\r\n\r\n\t// replaced by animation-powered implementation in Map.PanAnimation.js\r\n\tsetView: function (center, zoom) {\r\n\t\tzoom = zoom === undefined ? this.getZoom() : zoom;\r\n\t\tthis._resetView(L.latLng(center), this._limitZoom(zoom));\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetZoom: function (zoom, options) {\r\n\t\tif (!this._loaded) {\r\n\t\t\tthis._zoom = this._limitZoom(zoom);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t\treturn this.setView(this.getCenter(), zoom, {zoom: options});\r\n\t},\r\n\r\n\tzoomIn: function (delta, options) {\r\n\t\treturn this.setZoom(this._zoom + (delta || 1), options);\r\n\t},\r\n\r\n\tzoomOut: function (delta, options) {\r\n\t\treturn this.setZoom(this._zoom - (delta || 1), options);\r\n\t},\r\n\r\n\tsetZoomAround: function (latlng, zoom, options) {\r\n\t\tvar scale = this.getZoomScale(zoom),\r\n\t\t    viewHalf = this.getSize().divideBy(2),\r\n\t\t    containerPoint = latlng instanceof L.Point ? latlng : this.latLngToContainerPoint(latlng),\r\n\r\n\t\t    centerOffset = containerPoint.subtract(viewHalf).multiplyBy(1 - 1 / scale),\r\n\t\t    newCenter = this.containerPointToLatLng(viewHalf.add(centerOffset));\r\n\r\n\t\treturn this.setView(newCenter, zoom, {zoom: options});\r\n\t},\r\n\r\n\tfitBounds: function (bounds, options) {\r\n\r\n\t\toptions = options || {};\r\n\t\tbounds = bounds.getBounds ? bounds.getBounds() : L.latLngBounds(bounds);\r\n\r\n\t\tvar paddingTL = L.point(options.paddingTopLeft || options.padding || [0, 0]),\r\n\t\t    paddingBR = L.point(options.paddingBottomRight || options.padding || [0, 0]),\r\n\r\n\t\t    zoom = this.getBoundsZoom(bounds, false, paddingTL.add(paddingBR));\r\n\r\n\t\tzoom = (options.maxZoom) ? Math.min(options.maxZoom, zoom) : zoom;\r\n\r\n\t\tvar paddingOffset = paddingBR.subtract(paddingTL).divideBy(2),\r\n\r\n\t\t    swPoint = this.project(bounds.getSouthWest(), zoom),\r\n\t\t    nePoint = this.project(bounds.getNorthEast(), zoom),\r\n\t\t    center = this.unproject(swPoint.add(nePoint).divideBy(2).add(paddingOffset), zoom);\r\n\r\n\t\treturn this.setView(center, zoom, options);\r\n\t},\r\n\r\n\tfitWorld: function (options) {\r\n\t\treturn this.fitBounds([[-90, -180], [90, 180]], options);\r\n\t},\r\n\r\n\tpanTo: function (center, options) { // (LatLng)\r\n\t\treturn this.setView(center, this._zoom, {pan: options});\r\n\t},\r\n\r\n\tpanBy: function (offset) { // (Point)\r\n\t\t// replaced with animated panBy in Map.PanAnimation.js\r\n\t\tthis.fire('movestart');\r\n\r\n\t\tthis._rawPanBy(L.point(offset));\r\n\r\n\t\tthis.fire('move');\r\n\t\treturn this.fire('moveend');\r\n\t},\r\n\r\n\tsetMaxBounds: function (bounds) {\r\n\t\tbounds = L.latLngBounds(bounds);\r\n\r\n\t\tthis.options.maxBounds = bounds;\r\n\r\n\t\tif (!bounds) {\r\n\t\t\treturn this.off('moveend', this._panInsideMaxBounds, this);\r\n\t\t}\r\n\r\n\t\tif (this._loaded) {\r\n\t\t\tthis._panInsideMaxBounds();\r\n\t\t}\r\n\r\n\t\treturn this.on('moveend', this._panInsideMaxBounds, this);\r\n\t},\r\n\r\n\tpanInsideBounds: function (bounds, options) {\r\n\t\tvar center = this.getCenter(),\r\n\t\t\tnewCenter = this._limitCenter(center, this._zoom, bounds);\r\n\r\n\t\tif (center.equals(newCenter)) { return this; }\r\n\r\n\t\treturn this.panTo(newCenter, options);\r\n\t},\r\n\r\n\taddLayer: function (layer) {\r\n\t\t// TODO method is too big, refactor\r\n\r\n\t\tvar id = L.stamp(layer);\r\n\r\n\t\tif (this._layers[id]) { return this; }\r\n\r\n\t\tthis._layers[id] = layer;\r\n\r\n\t\t// TODO getMaxZoom, getMinZoom in ILayer (instead of options)\r\n\t\tif (layer.options && (!isNaN(layer.options.maxZoom) || !isNaN(layer.options.minZoom))) {\r\n\t\t\tthis._zoomBoundLayers[id] = layer;\r\n\t\t\tthis._updateZoomLevels();\r\n\t\t}\r\n\r\n\t\t// TODO looks ugly, refactor!!!\r\n\t\tif (this.options.zoomAnimation && L.TileLayer && (layer instanceof L.TileLayer)) {\r\n\t\t\tthis._tileLayersNum++;\r\n\t\t\tthis._tileLayersToLoad++;\r\n\t\t\tlayer.on('load', this._onTileLayerLoad, this);\r\n\t\t}\r\n\r\n\t\tif (this._loaded) {\r\n\t\t\tthis._layerAdd(layer);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tremoveLayer: function (layer) {\r\n\t\tvar id = L.stamp(layer);\r\n\r\n\t\tif (!this._layers[id]) { return this; }\r\n\r\n\t\tif (this._loaded) {\r\n\t\t\tlayer.onRemove(this);\r\n\t\t}\r\n\r\n\t\tdelete this._layers[id];\r\n\r\n\t\tif (this._loaded) {\r\n\t\t\tthis.fire('layerremove', {layer: layer});\r\n\t\t}\r\n\r\n\t\tif (this._zoomBoundLayers[id]) {\r\n\t\t\tdelete this._zoomBoundLayers[id];\r\n\t\t\tthis._updateZoomLevels();\r\n\t\t}\r\n\r\n\t\t// TODO looks ugly, refactor\r\n\t\tif (this.options.zoomAnimation && L.TileLayer && (layer instanceof L.TileLayer)) {\r\n\t\t\tthis._tileLayersNum--;\r\n\t\t\tthis._tileLayersToLoad--;\r\n\t\t\tlayer.off('load', this._onTileLayerLoad, this);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\thasLayer: function (layer) {\r\n\t\tif (!layer) { return false; }\r\n\r\n\t\treturn (L.stamp(layer) in this._layers);\r\n\t},\r\n\r\n\teachLayer: function (method, context) {\r\n\t\tfor (var i in this._layers) {\r\n\t\t\tmethod.call(context, this._layers[i]);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tinvalidateSize: function (options) {\r\n\t\tif (!this._loaded) { return this; }\r\n\r\n\t\toptions = L.extend({\r\n\t\t\tanimate: false,\r\n\t\t\tpan: true\r\n\t\t}, options === true ? {animate: true} : options);\r\n\r\n\t\tvar oldSize = this.getSize();\r\n\t\tthis._sizeChanged = true;\r\n\t\tthis._initialCenter = null;\r\n\r\n\t\tvar newSize = this.getSize(),\r\n\t\t    oldCenter = oldSize.divideBy(2).round(),\r\n\t\t    newCenter = newSize.divideBy(2).round(),\r\n\t\t    offset = oldCenter.subtract(newCenter);\r\n\r\n\t\tif (!offset.x && !offset.y) { return this; }\r\n\r\n\t\tif (options.animate && options.pan) {\r\n\t\t\tthis.panBy(offset);\r\n\r\n\t\t} else {\r\n\t\t\tif (options.pan) {\r\n\t\t\t\tthis._rawPanBy(offset);\r\n\t\t\t}\r\n\r\n\t\t\tthis.fire('move');\r\n\r\n\t\t\tif (options.debounceMoveend) {\r\n\t\t\t\tclearTimeout(this._sizeTimer);\r\n\t\t\t\tthis._sizeTimer = setTimeout(L.bind(this.fire, this, 'moveend'), 200);\r\n\t\t\t} else {\r\n\t\t\t\tthis.fire('moveend');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this.fire('resize', {\r\n\t\t\toldSize: oldSize,\r\n\t\t\tnewSize: newSize\r\n\t\t});\r\n\t},\r\n\r\n\t// TODO handler.addTo\r\n\taddHandler: function (name, HandlerClass) {\r\n\t\tif (!HandlerClass) { return this; }\r\n\r\n\t\tvar handler = this[name] = new HandlerClass(this);\r\n\r\n\t\tthis._handlers.push(handler);\r\n\r\n\t\tif (this.options[name]) {\r\n\t\t\thandler.enable();\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tremove: function () {\r\n\t\tif (this._loaded) {\r\n\t\t\tthis.fire('unload');\r\n\t\t}\r\n\r\n\t\tthis._initEvents('off');\r\n\r\n\t\ttry {\r\n\t\t\t// throws error in IE6-8\r\n\t\t\tdelete this._container._leaflet;\r\n\t\t} catch (e) {\r\n\t\t\tthis._container._leaflet = undefined;\r\n\t\t}\r\n\r\n\t\tthis._clearPanes();\r\n\t\tif (this._clearControlPos) {\r\n\t\t\tthis._clearControlPos();\r\n\t\t}\r\n\r\n\t\tthis._clearHandlers();\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\r\n\t// public methods for getting map state\r\n\r\n\tgetCenter: function () { // (Boolean) -> LatLng\r\n\t\tthis._checkIfLoaded();\r\n\r\n\t\tif (this._initialCenter && !this._moved()) {\r\n\t\t\treturn this._initialCenter;\r\n\t\t}\r\n\t\treturn this.layerPointToLatLng(this._getCenterLayerPoint());\r\n\t},\r\n\r\n\tgetZoom: function () {\r\n\t\treturn this._zoom;\r\n\t},\r\n\r\n\tgetBounds: function () {\r\n\t\tvar bounds = this.getPixelBounds(),\r\n\t\t    sw = this.unproject(bounds.getBottomLeft()),\r\n\t\t    ne = this.unproject(bounds.getTopRight());\r\n\r\n\t\treturn new L.LatLngBounds(sw, ne);\r\n\t},\r\n\r\n\tgetMinZoom: function () {\r\n\t\treturn this.options.minZoom === undefined ?\r\n\t\t\t(this._layersMinZoom === undefined ? 0 : this._layersMinZoom) :\r\n\t\t\tthis.options.minZoom;\r\n\t},\r\n\r\n\tgetMaxZoom: function () {\r\n\t\treturn this.options.maxZoom === undefined ?\r\n\t\t\t(this._layersMaxZoom === undefined ? Infinity : this._layersMaxZoom) :\r\n\t\t\tthis.options.maxZoom;\r\n\t},\r\n\r\n\tgetBoundsZoom: function (bounds, inside, padding) { // (LatLngBounds[, Boolean, Point]) -> Number\r\n\t\tbounds = L.latLngBounds(bounds);\r\n\r\n\t\tvar zoom = this.getMinZoom() - (inside ? 1 : 0),\r\n\t\t    maxZoom = this.getMaxZoom(),\r\n\t\t    size = this.getSize(),\r\n\r\n\t\t    nw = bounds.getNorthWest(),\r\n\t\t    se = bounds.getSouthEast(),\r\n\r\n\t\t    zoomNotFound = true,\r\n\t\t    boundsSize;\r\n\r\n\t\tpadding = L.point(padding || [0, 0]);\r\n\r\n\t\tdo {\r\n\t\t\tzoom++;\r\n\t\t\tboundsSize = this.project(se, zoom).subtract(this.project(nw, zoom)).add(padding);\r\n\t\t\tzoomNotFound = !inside ? size.contains(boundsSize) : boundsSize.x < size.x || boundsSize.y < size.y;\r\n\r\n\t\t} while (zoomNotFound && zoom <= maxZoom);\r\n\r\n\t\tif (zoomNotFound && inside) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\treturn inside ? zoom : zoom - 1;\r\n\t},\r\n\r\n\tgetSize: function () {\r\n\t\tif (!this._size || this._sizeChanged) {\r\n\t\t\tthis._size = new L.Point(\r\n\t\t\t\tthis._container.clientWidth,\r\n\t\t\t\tthis._container.clientHeight);\r\n\r\n\t\t\tthis._sizeChanged = false;\r\n\t\t}\r\n\t\treturn this._size.clone();\r\n\t},\r\n\r\n\tgetPixelBounds: function () {\r\n\t\tvar topLeftPoint = this._getTopLeftPoint();\r\n\t\treturn new L.Bounds(topLeftPoint, topLeftPoint.add(this.getSize()));\r\n\t},\r\n\r\n\tgetPixelOrigin: function () {\r\n\t\tthis._checkIfLoaded();\r\n\t\treturn this._initialTopLeftPoint;\r\n\t},\r\n\r\n\tgetPanes: function () {\r\n\t\treturn this._panes;\r\n\t},\r\n\r\n\tgetContainer: function () {\r\n\t\treturn this._container;\r\n\t},\r\n\r\n\r\n\t// TODO replace with universal implementation after refactoring projections\r\n\r\n\tgetZoomScale: function (toZoom) {\r\n\t\tvar crs = this.options.crs;\r\n\t\treturn crs.scale(toZoom) / crs.scale(this._zoom);\r\n\t},\r\n\r\n\tgetScaleZoom: function (scale) {\r\n\t\treturn this._zoom + (Math.log(scale) / Math.LN2);\r\n\t},\r\n\r\n\r\n\t// conversion methods\r\n\r\n\tproject: function (latlng, zoom) { // (LatLng[, Number]) -> Point\r\n\t\tzoom = zoom === undefined ? this._zoom : zoom;\r\n\t\treturn this.options.crs.latLngToPoint(L.latLng(latlng), zoom);\r\n\t},\r\n\r\n\tunproject: function (point, zoom) { // (Point[, Number]) -> LatLng\r\n\t\tzoom = zoom === undefined ? this._zoom : zoom;\r\n\t\treturn this.options.crs.pointToLatLng(L.point(point), zoom);\r\n\t},\r\n\r\n\tlayerPointToLatLng: function (point) { // (Point)\r\n\t\tvar projectedPoint = L.point(point).add(this.getPixelOrigin());\r\n\t\treturn this.unproject(projectedPoint);\r\n\t},\r\n\r\n\tlatLngToLayerPoint: function (latlng) { // (LatLng)\r\n\t\tvar projectedPoint = this.project(L.latLng(latlng))._round();\r\n\t\treturn projectedPoint._subtract(this.getPixelOrigin());\r\n\t},\r\n\r\n\tcontainerPointToLayerPoint: function (point) { // (Point)\r\n\t\treturn L.point(point).subtract(this._getMapPanePos());\r\n\t},\r\n\r\n\tlayerPointToContainerPoint: function (point) { // (Point)\r\n\t\treturn L.point(point).add(this._getMapPanePos());\r\n\t},\r\n\r\n\tcontainerPointToLatLng: function (point) {\r\n\t\tvar layerPoint = this.containerPointToLayerPoint(L.point(point));\r\n\t\treturn this.layerPointToLatLng(layerPoint);\r\n\t},\r\n\r\n\tlatLngToContainerPoint: function (latlng) {\r\n\t\treturn this.layerPointToContainerPoint(this.latLngToLayerPoint(L.latLng(latlng)));\r\n\t},\r\n\r\n\tmouseEventToContainerPoint: function (e) { // (MouseEvent)\r\n\t\treturn L.DomEvent.getMousePosition(e, this._container);\r\n\t},\r\n\r\n\tmouseEventToLayerPoint: function (e) { // (MouseEvent)\r\n\t\treturn this.containerPointToLayerPoint(this.mouseEventToContainerPoint(e));\r\n\t},\r\n\r\n\tmouseEventToLatLng: function (e) { // (MouseEvent)\r\n\t\treturn this.layerPointToLatLng(this.mouseEventToLayerPoint(e));\r\n\t},\r\n\r\n\r\n\t// map initialization methods\r\n\r\n\t_initContainer: function (id) {\r\n\t\tvar container = this._container = L.DomUtil.get(id);\r\n\r\n\t\tif (!container) {\r\n\t\t\tthrow new Error('Map container not found.');\r\n\t\t} else if (container._leaflet) {\r\n\t\t\tthrow new Error('Map container is already initialized.');\r\n\t\t}\r\n\r\n\t\tcontainer._leaflet = true;\r\n\t},\r\n\r\n\t_initLayout: function () {\r\n\t\tvar container = this._container;\r\n\r\n\t\tL.DomUtil.addClass(container, 'leaflet-container' +\r\n\t\t\t(L.Browser.touch ? ' leaflet-touch' : '') +\r\n\t\t\t(L.Browser.retina ? ' leaflet-retina' : '') +\r\n\t\t\t(L.Browser.ielt9 ? ' leaflet-oldie' : '') +\r\n\t\t\t(this.options.fadeAnimation ? ' leaflet-fade-anim' : ''));\r\n\r\n\t\tvar position = L.DomUtil.getStyle(container, 'position');\r\n\r\n\t\tif (position !== 'absolute' && position !== 'relative' && position !== 'fixed') {\r\n\t\t\tcontainer.style.position = 'relative';\r\n\t\t}\r\n\r\n\t\tthis._initPanes();\r\n\r\n\t\tif (this._initControlPos) {\r\n\t\t\tthis._initControlPos();\r\n\t\t}\r\n\t},\r\n\r\n\t_initPanes: function () {\r\n\t\tvar panes = this._panes = {};\r\n\r\n\t\tthis._mapPane = panes.mapPane = this._createPane('leaflet-map-pane', this._container);\r\n\r\n\t\tthis._tilePane = panes.tilePane = this._createPane('leaflet-tile-pane', this._mapPane);\r\n\t\tpanes.objectsPane = this._createPane('leaflet-objects-pane', this._mapPane);\r\n\t\tpanes.shadowPane = this._createPane('leaflet-shadow-pane');\r\n\t\tpanes.overlayPane = this._createPane('leaflet-overlay-pane');\r\n\t\tpanes.markerPane = this._createPane('leaflet-marker-pane');\r\n\t\tpanes.popupPane = this._createPane('leaflet-popup-pane');\r\n\r\n\t\tvar zoomHide = ' leaflet-zoom-hide';\r\n\r\n\t\tif (!this.options.markerZoomAnimation) {\r\n\t\t\tL.DomUtil.addClass(panes.markerPane, zoomHide);\r\n\t\t\tL.DomUtil.addClass(panes.shadowPane, zoomHide);\r\n\t\t\tL.DomUtil.addClass(panes.popupPane, zoomHide);\r\n\t\t}\r\n\t},\r\n\r\n\t_createPane: function (className, container) {\r\n\t\treturn L.DomUtil.create('div', className, container || this._panes.objectsPane);\r\n\t},\r\n\r\n\t_clearPanes: function () {\r\n\t\tthis._container.removeChild(this._mapPane);\r\n\t},\r\n\r\n\t_addLayers: function (layers) {\r\n\t\tlayers = layers ? (L.Util.isArray(layers) ? layers : [layers]) : [];\r\n\r\n\t\tfor (var i = 0, len = layers.length; i < len; i++) {\r\n\t\t\tthis.addLayer(layers[i]);\r\n\t\t}\r\n\t},\r\n\r\n\r\n\t// private methods that modify map state\r\n\r\n\t_resetView: function (center, zoom, preserveMapOffset, afterZoomAnim) {\r\n\r\n\t\tvar zoomChanged = (this._zoom !== zoom);\r\n\r\n\t\tif (!afterZoomAnim) {\r\n\t\t\tthis.fire('movestart');\r\n\r\n\t\t\tif (zoomChanged) {\r\n\t\t\t\tthis.fire('zoomstart');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis._zoom = zoom;\r\n\t\tthis._initialCenter = center;\r\n\r\n\t\tthis._initialTopLeftPoint = this._getNewTopLeftPoint(center);\r\n\r\n\t\tif (!preserveMapOffset) {\r\n\t\t\tL.DomUtil.setPosition(this._mapPane, new L.Point(0, 0));\r\n\t\t} else {\r\n\t\t\tthis._initialTopLeftPoint._add(this._getMapPanePos());\r\n\t\t}\r\n\r\n\t\tthis._tileLayersToLoad = this._tileLayersNum;\r\n\r\n\t\tvar loading = !this._loaded;\r\n\t\tthis._loaded = true;\r\n\r\n\t\tthis.fire('viewreset', {hard: !preserveMapOffset});\r\n\r\n\t\tif (loading) {\r\n\t\t\tthis.fire('load');\r\n\t\t\tthis.eachLayer(this._layerAdd, this);\r\n\t\t}\r\n\r\n\t\tthis.fire('move');\r\n\r\n\t\tif (zoomChanged || afterZoomAnim) {\r\n\t\t\tthis.fire('zoomend');\r\n\t\t}\r\n\r\n\t\tthis.fire('moveend', {hard: !preserveMapOffset});\r\n\t},\r\n\r\n\t_rawPanBy: function (offset) {\r\n\t\tL.DomUtil.setPosition(this._mapPane, this._getMapPanePos().subtract(offset));\r\n\t},\r\n\r\n\t_getZoomSpan: function () {\r\n\t\treturn this.getMaxZoom() - this.getMinZoom();\r\n\t},\r\n\r\n\t_updateZoomLevels: function () {\r\n\t\tvar i,\r\n\t\t\tminZoom = Infinity,\r\n\t\t\tmaxZoom = -Infinity,\r\n\t\t\toldZoomSpan = this._getZoomSpan();\r\n\r\n\t\tfor (i in this._zoomBoundLayers) {\r\n\t\t\tvar layer = this._zoomBoundLayers[i];\r\n\t\t\tif (!isNaN(layer.options.minZoom)) {\r\n\t\t\t\tminZoom = Math.min(minZoom, layer.options.minZoom);\r\n\t\t\t}\r\n\t\t\tif (!isNaN(layer.options.maxZoom)) {\r\n\t\t\t\tmaxZoom = Math.max(maxZoom, layer.options.maxZoom);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (i === undefined) { // we have no tilelayers\r\n\t\t\tthis._layersMaxZoom = this._layersMinZoom = undefined;\r\n\t\t} else {\r\n\t\t\tthis._layersMaxZoom = maxZoom;\r\n\t\t\tthis._layersMinZoom = minZoom;\r\n\t\t}\r\n\r\n\t\tif (oldZoomSpan !== this._getZoomSpan()) {\r\n\t\t\tthis.fire('zoomlevelschange');\r\n\t\t}\r\n\t},\r\n\r\n\t_panInsideMaxBounds: function () {\r\n\t\tthis.panInsideBounds(this.options.maxBounds);\r\n\t},\r\n\r\n\t_checkIfLoaded: function () {\r\n\t\tif (!this._loaded) {\r\n\t\t\tthrow new Error('Set map center and zoom first.');\r\n\t\t}\r\n\t},\r\n\r\n\t// map events\r\n\r\n\t_initEvents: function (onOff) {\r\n\t\tif (!L.DomEvent) { return; }\r\n\r\n\t\tonOff = onOff || 'on';\r\n\r\n\t\tL.DomEvent[onOff](this._container, 'click', this._onMouseClick, this);\r\n\r\n\t\tvar events = ['dblclick', 'mousedown', 'mouseup', 'mouseenter',\r\n\t\t              'mouseleave', 'mousemove', 'contextmenu'],\r\n\t\t    i, len;\r\n\r\n\t\tfor (i = 0, len = events.length; i < len; i++) {\r\n\t\t\tL.DomEvent[onOff](this._container, events[i], this._fireMouseEvent, this);\r\n\t\t}\r\n\r\n\t\tif (this.options.trackResize) {\r\n\t\t\tL.DomEvent[onOff](window, 'resize', this._onResize, this);\r\n\t\t}\r\n\t},\r\n\r\n\t_onResize: function () {\r\n\t\tL.Util.cancelAnimFrame(this._resizeRequest);\r\n\t\tthis._resizeRequest = L.Util.requestAnimFrame(\r\n\t\t        function () { this.invalidateSize({debounceMoveend: true}); }, this, false, this._container);\r\n\t},\r\n\r\n\t_onMouseClick: function (e) {\r\n\t\tif (!this._loaded || (!e._simulated &&\r\n\t\t        ((this.dragging && this.dragging.moved()) ||\r\n\t\t         (this.boxZoom  && this.boxZoom.moved()))) ||\r\n\t\t            L.DomEvent._skipped(e)) { return; }\r\n\r\n\t\tthis.fire('preclick');\r\n\t\tthis._fireMouseEvent(e);\r\n\t},\r\n\r\n\t_fireMouseEvent: function (e) {\r\n\t\tif (!this._loaded || L.DomEvent._skipped(e)) { return; }\r\n\r\n\t\tvar type = e.type;\r\n\r\n\t\ttype = (type === 'mouseenter' ? 'mouseover' : (type === 'mouseleave' ? 'mouseout' : type));\r\n\r\n\t\tif (!this.hasEventListeners(type)) { return; }\r\n\r\n\t\tif (type === 'contextmenu') {\r\n\t\t\tL.DomEvent.preventDefault(e);\r\n\t\t}\r\n\r\n\t\tvar containerPoint = this.mouseEventToContainerPoint(e),\r\n\t\t    layerPoint = this.containerPointToLayerPoint(containerPoint),\r\n\t\t    latlng = this.layerPointToLatLng(layerPoint);\r\n\r\n\t\tthis.fire(type, {\r\n\t\t\tlatlng: latlng,\r\n\t\t\tlayerPoint: layerPoint,\r\n\t\t\tcontainerPoint: containerPoint,\r\n\t\t\toriginalEvent: e\r\n\t\t});\r\n\t},\r\n\r\n\t_onTileLayerLoad: function () {\r\n\t\tthis._tileLayersToLoad--;\r\n\t\tif (this._tileLayersNum && !this._tileLayersToLoad) {\r\n\t\t\tthis.fire('tilelayersload');\r\n\t\t}\r\n\t},\r\n\r\n\t_clearHandlers: function () {\r\n\t\tfor (var i = 0, len = this._handlers.length; i < len; i++) {\r\n\t\t\tthis._handlers[i].disable();\r\n\t\t}\r\n\t},\r\n\r\n\twhenReady: function (callback, context) {\r\n\t\tif (this._loaded) {\r\n\t\t\tcallback.call(context || this, this);\r\n\t\t} else {\r\n\t\t\tthis.on('load', callback, context);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_layerAdd: function (layer) {\r\n\t\tlayer.onAdd(this);\r\n\t\tthis.fire('layeradd', {layer: layer});\r\n\t},\r\n\r\n\r\n\t// private methods for getting map state\r\n\r\n\t_getMapPanePos: function () {\r\n\t\treturn L.DomUtil.getPosition(this._mapPane);\r\n\t},\r\n\r\n\t_moved: function () {\r\n\t\tvar pos = this._getMapPanePos();\r\n\t\treturn pos && !pos.equals([0, 0]);\r\n\t},\r\n\r\n\t_getTopLeftPoint: function () {\r\n\t\treturn this.getPixelOrigin().subtract(this._getMapPanePos());\r\n\t},\r\n\r\n\t_getNewTopLeftPoint: function (center, zoom) {\r\n\t\tvar viewHalf = this.getSize()._divideBy(2);\r\n\t\t// TODO round on display, not calculation to increase precision?\r\n\t\treturn this.project(center, zoom)._subtract(viewHalf)._round();\r\n\t},\r\n\r\n\t_latLngToNewLayerPoint: function (latlng, newZoom, newCenter) {\r\n\t\tvar topLeft = this._getNewTopLeftPoint(newCenter, newZoom).add(this._getMapPanePos());\r\n\t\treturn this.project(latlng, newZoom)._subtract(topLeft);\r\n\t},\r\n\r\n\t// layer point of the current center\r\n\t_getCenterLayerPoint: function () {\r\n\t\treturn this.containerPointToLayerPoint(this.getSize()._divideBy(2));\r\n\t},\r\n\r\n\t// offset of the specified place to the current center in pixels\r\n\t_getCenterOffset: function (latlng) {\r\n\t\treturn this.latLngToLayerPoint(latlng).subtract(this._getCenterLayerPoint());\r\n\t},\r\n\r\n\t// adjust center for view to get inside bounds\r\n\t_limitCenter: function (center, zoom, bounds) {\r\n\r\n\t\tif (!bounds) { return center; }\r\n\r\n\t\tvar centerPoint = this.project(center, zoom),\r\n\t\t    viewHalf = this.getSize().divideBy(2),\r\n\t\t    viewBounds = new L.Bounds(centerPoint.subtract(viewHalf), centerPoint.add(viewHalf)),\r\n\t\t    offset = this._getBoundsOffset(viewBounds, bounds, zoom);\r\n\r\n\t\treturn this.unproject(centerPoint.add(offset), zoom);\r\n\t},\r\n\r\n\t// adjust offset for view to get inside bounds\r\n\t_limitOffset: function (offset, bounds) {\r\n\t\tif (!bounds) { return offset; }\r\n\r\n\t\tvar viewBounds = this.getPixelBounds(),\r\n\t\t    newBounds = new L.Bounds(viewBounds.min.add(offset), viewBounds.max.add(offset));\r\n\r\n\t\treturn offset.add(this._getBoundsOffset(newBounds, bounds));\r\n\t},\r\n\r\n\t// returns offset needed for pxBounds to get inside maxBounds at a specified zoom\r\n\t_getBoundsOffset: function (pxBounds, maxBounds, zoom) {\r\n\t\tvar nwOffset = this.project(maxBounds.getNorthWest(), zoom).subtract(pxBounds.min),\r\n\t\t    seOffset = this.project(maxBounds.getSouthEast(), zoom).subtract(pxBounds.max),\r\n\r\n\t\t    dx = this._rebound(nwOffset.x, -seOffset.x),\r\n\t\t    dy = this._rebound(nwOffset.y, -seOffset.y);\r\n\r\n\t\treturn new L.Point(dx, dy);\r\n\t},\r\n\r\n\t_rebound: function (left, right) {\r\n\t\treturn left + right > 0 ?\r\n\t\t\tMath.round(left - right) / 2 :\r\n\t\t\tMath.max(0, Math.ceil(left)) - Math.max(0, Math.floor(right));\r\n\t},\r\n\r\n\t_limitZoom: function (zoom) {\r\n\t\tvar min = this.getMinZoom(),\r\n\t\t    max = this.getMaxZoom();\r\n\r\n\t\treturn Math.max(min, Math.min(max, zoom));\r\n\t}\r\n});\r\n\r\nL.map = function (id, options) {\r\n\treturn new L.Map(id, options);\r\n};\r\n\n\n/*\r\n * Mercator projection that takes into account that the Earth is not a perfect sphere.\r\n * Less popular than spherical mercator; used by projections like EPSG:3395.\r\n */\r\n\r\nL.Projection.Mercator = {\r\n\tMAX_LATITUDE: 85.0840591556,\r\n\r\n\tR_MINOR: 6356752.314245179,\r\n\tR_MAJOR: 6378137,\r\n\r\n\tproject: function (latlng) { // (LatLng) -> Point\r\n\t\tvar d = L.LatLng.DEG_TO_RAD,\r\n\t\t    max = this.MAX_LATITUDE,\r\n\t\t    lat = Math.max(Math.min(max, latlng.lat), -max),\r\n\t\t    r = this.R_MAJOR,\r\n\t\t    r2 = this.R_MINOR,\r\n\t\t    x = latlng.lng * d * r,\r\n\t\t    y = lat * d,\r\n\t\t    tmp = r2 / r,\r\n\t\t    eccent = Math.sqrt(1.0 - tmp * tmp),\r\n\t\t    con = eccent * Math.sin(y);\r\n\r\n\t\tcon = Math.pow((1 - con) / (1 + con), eccent * 0.5);\r\n\r\n\t\tvar ts = Math.tan(0.5 * ((Math.PI * 0.5) - y)) / con;\r\n\t\ty = -r * Math.log(ts);\r\n\r\n\t\treturn new L.Point(x, y);\r\n\t},\r\n\r\n\tunproject: function (point) { // (Point, Boolean) -> LatLng\r\n\t\tvar d = L.LatLng.RAD_TO_DEG,\r\n\t\t    r = this.R_MAJOR,\r\n\t\t    r2 = this.R_MINOR,\r\n\t\t    lng = point.x * d / r,\r\n\t\t    tmp = r2 / r,\r\n\t\t    eccent = Math.sqrt(1 - (tmp * tmp)),\r\n\t\t    ts = Math.exp(- point.y / r),\r\n\t\t    phi = (Math.PI / 2) - 2 * Math.atan(ts),\r\n\t\t    numIter = 15,\r\n\t\t    tol = 1e-7,\r\n\t\t    i = numIter,\r\n\t\t    dphi = 0.1,\r\n\t\t    con;\r\n\r\n\t\twhile ((Math.abs(dphi) > tol) && (--i > 0)) {\r\n\t\t\tcon = eccent * Math.sin(phi);\r\n\t\t\tdphi = (Math.PI / 2) - 2 * Math.atan(ts *\r\n\t\t\t            Math.pow((1.0 - con) / (1.0 + con), 0.5 * eccent)) - phi;\r\n\t\t\tphi += dphi;\r\n\t\t}\r\n\r\n\t\treturn new L.LatLng(phi * d, lng);\r\n\t}\r\n};\r\n\n\n\r\nL.CRS.EPSG3395 = L.extend({}, L.CRS, {\r\n\tcode: 'EPSG:3395',\r\n\r\n\tprojection: L.Projection.Mercator,\r\n\r\n\ttransformation: (function () {\r\n\t\tvar m = L.Projection.Mercator,\r\n\t\t    r = m.R_MAJOR,\r\n\t\t    scale = 0.5 / (Math.PI * r);\r\n\r\n\t\treturn new L.Transformation(scale, 0.5, -scale, 0.5);\r\n\t}())\r\n});\r\n\n\n/*\r\n * L.TileLayer is used for standard xyz-numbered tile layers.\r\n */\r\n\r\nL.TileLayer = L.Class.extend({\r\n\tincludes: L.Mixin.Events,\r\n\r\n\toptions: {\r\n\t\tminZoom: 0,\r\n\t\tmaxZoom: 18,\r\n\t\ttileSize: 256,\r\n\t\tsubdomains: 'abc',\r\n\t\terrorTileUrl: '',\r\n\t\tattribution: '',\r\n\t\tzoomOffset: 0,\r\n\t\topacity: 1,\r\n\t\t/*\r\n\t\tmaxNativeZoom: null,\r\n\t\tzIndex: null,\r\n\t\ttms: false,\r\n\t\tcontinuousWorld: false,\r\n\t\tnoWrap: false,\r\n\t\tzoomReverse: false,\r\n\t\tdetectRetina: false,\r\n\t\treuseTiles: false,\r\n\t\tbounds: false,\r\n\t\t*/\r\n\t\tunloadInvisibleTiles: L.Browser.mobile,\r\n\t\tupdateWhenIdle: L.Browser.mobile\r\n\t},\r\n\r\n\tinitialize: function (url, options) {\r\n\t\toptions = L.setOptions(this, options);\r\n\r\n\t\t// detecting retina displays, adjusting tileSize and zoom levels\r\n\t\tif (options.detectRetina && L.Browser.retina && options.maxZoom > 0) {\r\n\r\n\t\t\toptions.tileSize = Math.floor(options.tileSize / 2);\r\n\t\t\toptions.zoomOffset++;\r\n\r\n\t\t\tif (options.minZoom > 0) {\r\n\t\t\t\toptions.minZoom--;\r\n\t\t\t}\r\n\t\t\tthis.options.maxZoom--;\r\n\t\t}\r\n\r\n\t\tif (options.bounds) {\r\n\t\t\toptions.bounds = L.latLngBounds(options.bounds);\r\n\t\t}\r\n\r\n\t\tthis._url = url;\r\n\r\n\t\tvar subdomains = this.options.subdomains;\r\n\r\n\t\tif (typeof subdomains === 'string') {\r\n\t\t\tthis.options.subdomains = subdomains.split('');\r\n\t\t}\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tthis._map = map;\r\n\t\tthis._animated = map._zoomAnimated;\r\n\r\n\t\t// create a container div for tiles\r\n\t\tthis._initContainer();\r\n\r\n\t\t// set up events\r\n\t\tmap.on({\r\n\t\t\t'viewreset': this._reset,\r\n\t\t\t'moveend': this._update\r\n\t\t}, this);\r\n\r\n\t\tif (this._animated) {\r\n\t\t\tmap.on({\r\n\t\t\t\t'zoomanim': this._animateZoom,\r\n\t\t\t\t'zoomend': this._endZoomAnim\r\n\t\t\t}, this);\r\n\t\t}\r\n\r\n\t\tif (!this.options.updateWhenIdle) {\r\n\t\t\tthis._limitedUpdate = L.Util.limitExecByInterval(this._update, 150, this);\r\n\t\t\tmap.on('move', this._limitedUpdate, this);\r\n\t\t}\r\n\r\n\t\tthis._reset();\r\n\t\tthis._update();\r\n\t},\r\n\r\n\taddTo: function (map) {\r\n\t\tmap.addLayer(this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tthis._container.parentNode.removeChild(this._container);\r\n\r\n\t\tmap.off({\r\n\t\t\t'viewreset': this._reset,\r\n\t\t\t'moveend': this._update\r\n\t\t}, this);\r\n\r\n\t\tif (this._animated) {\r\n\t\t\tmap.off({\r\n\t\t\t\t'zoomanim': this._animateZoom,\r\n\t\t\t\t'zoomend': this._endZoomAnim\r\n\t\t\t}, this);\r\n\t\t}\r\n\r\n\t\tif (!this.options.updateWhenIdle) {\r\n\t\t\tmap.off('move', this._limitedUpdate, this);\r\n\t\t}\r\n\r\n\t\tthis._container = null;\r\n\t\tthis._map = null;\r\n\t},\r\n\r\n\tbringToFront: function () {\r\n\t\tvar pane = this._map._panes.tilePane;\r\n\r\n\t\tif (this._container) {\r\n\t\t\tpane.appendChild(this._container);\r\n\t\t\tthis._setAutoZIndex(pane, Math.max);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tbringToBack: function () {\r\n\t\tvar pane = this._map._panes.tilePane;\r\n\r\n\t\tif (this._container) {\r\n\t\t\tpane.insertBefore(this._container, pane.firstChild);\r\n\t\t\tthis._setAutoZIndex(pane, Math.min);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tgetAttribution: function () {\r\n\t\treturn this.options.attribution;\r\n\t},\r\n\r\n\tgetContainer: function () {\r\n\t\treturn this._container;\r\n\t},\r\n\r\n\tsetOpacity: function (opacity) {\r\n\t\tthis.options.opacity = opacity;\r\n\r\n\t\tif (this._map) {\r\n\t\t\tthis._updateOpacity();\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetZIndex: function (zIndex) {\r\n\t\tthis.options.zIndex = zIndex;\r\n\t\tthis._updateZIndex();\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetUrl: function (url, noRedraw) {\r\n\t\tthis._url = url;\r\n\r\n\t\tif (!noRedraw) {\r\n\t\t\tthis.redraw();\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tredraw: function () {\r\n\t\tif (this._map) {\r\n\t\t\tthis._reset({hard: true});\r\n\t\t\tthis._update();\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_updateZIndex: function () {\r\n\t\tif (this._container && this.options.zIndex !== undefined) {\r\n\t\t\tthis._container.style.zIndex = this.options.zIndex;\r\n\t\t}\r\n\t},\r\n\r\n\t_setAutoZIndex: function (pane, compare) {\r\n\r\n\t\tvar layers = pane.children,\r\n\t\t    edgeZIndex = -compare(Infinity, -Infinity), // -Infinity for max, Infinity for min\r\n\t\t    zIndex, i, len;\r\n\r\n\t\tfor (i = 0, len = layers.length; i < len; i++) {\r\n\r\n\t\t\tif (layers[i] !== this._container) {\r\n\t\t\t\tzIndex = parseInt(layers[i].style.zIndex, 10);\r\n\r\n\t\t\t\tif (!isNaN(zIndex)) {\r\n\t\t\t\t\tedgeZIndex = compare(edgeZIndex, zIndex);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.options.zIndex = this._container.style.zIndex =\r\n\t\t        (isFinite(edgeZIndex) ? edgeZIndex : 0) + compare(1, -1);\r\n\t},\r\n\r\n\t_updateOpacity: function () {\r\n\t\tvar i,\r\n\t\t    tiles = this._tiles;\r\n\r\n\t\tif (L.Browser.ielt9) {\r\n\t\t\tfor (i in tiles) {\r\n\t\t\t\tL.DomUtil.setOpacity(tiles[i], this.options.opacity);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tL.DomUtil.setOpacity(this._container, this.options.opacity);\r\n\t\t}\r\n\t},\r\n\r\n\t_initContainer: function () {\r\n\t\tvar tilePane = this._map._panes.tilePane;\r\n\r\n\t\tif (!this._container) {\r\n\t\t\tthis._container = L.DomUtil.create('div', 'leaflet-layer');\r\n\r\n\t\t\tthis._updateZIndex();\r\n\r\n\t\t\tif (this._animated) {\r\n\t\t\t\tvar className = 'leaflet-tile-container';\r\n\r\n\t\t\t\tthis._bgBuffer = L.DomUtil.create('div', className, this._container);\r\n\t\t\t\tthis._tileContainer = L.DomUtil.create('div', className, this._container);\r\n\r\n\t\t\t} else {\r\n\t\t\t\tthis._tileContainer = this._container;\r\n\t\t\t}\r\n\r\n\t\t\ttilePane.appendChild(this._container);\r\n\r\n\t\t\tif (this.options.opacity < 1) {\r\n\t\t\t\tthis._updateOpacity();\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_reset: function (e) {\r\n\t\tfor (var key in this._tiles) {\r\n\t\t\tthis.fire('tileunload', {tile: this._tiles[key]});\r\n\t\t}\r\n\r\n\t\tthis._tiles = {};\r\n\t\tthis._tilesToLoad = 0;\r\n\r\n\t\tif (this.options.reuseTiles) {\r\n\t\t\tthis._unusedTiles = [];\r\n\t\t}\r\n\r\n\t\tthis._tileContainer.innerHTML = '';\r\n\r\n\t\tif (this._animated && e && e.hard) {\r\n\t\t\tthis._clearBgBuffer();\r\n\t\t}\r\n\r\n\t\tthis._initContainer();\r\n\t},\r\n\r\n\t_getTileSize: function () {\r\n\t\tvar map = this._map,\r\n\t\t    zoom = map.getZoom() + this.options.zoomOffset,\r\n\t\t    zoomN = this.options.maxNativeZoom,\r\n\t\t    tileSize = this.options.tileSize;\r\n\r\n\t\tif (zoomN && zoom > zoomN) {\r\n\t\t\ttileSize = Math.round(map.getZoomScale(zoom) / map.getZoomScale(zoomN) * tileSize);\r\n\t\t}\r\n\r\n\t\treturn tileSize;\r\n\t},\r\n\r\n\t_update: function () {\r\n\r\n\t\tif (!this._map) { return; }\r\n\r\n\t\tvar map = this._map,\r\n\t\t    bounds = map.getPixelBounds(),\r\n\t\t    zoom = map.getZoom(),\r\n\t\t    tileSize = this._getTileSize();\r\n\r\n\t\tif (zoom > this.options.maxZoom || zoom < this.options.minZoom) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar tileBounds = L.bounds(\r\n\t\t        bounds.min.divideBy(tileSize)._floor(),\r\n\t\t        bounds.max.divideBy(tileSize)._floor());\r\n\r\n\t\tthis._addTilesFromCenterOut(tileBounds);\r\n\r\n\t\tif (this.options.unloadInvisibleTiles || this.options.reuseTiles) {\r\n\t\t\tthis._removeOtherTiles(tileBounds);\r\n\t\t}\r\n\t},\r\n\r\n\t_addTilesFromCenterOut: function (bounds) {\r\n\t\tvar queue = [],\r\n\t\t    center = bounds.getCenter();\r\n\r\n\t\tvar j, i, point;\r\n\r\n\t\tfor (j = bounds.min.y; j <= bounds.max.y; j++) {\r\n\t\t\tfor (i = bounds.min.x; i <= bounds.max.x; i++) {\r\n\t\t\t\tpoint = new L.Point(i, j);\r\n\r\n\t\t\t\tif (this._tileShouldBeLoaded(point)) {\r\n\t\t\t\t\tqueue.push(point);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar tilesToLoad = queue.length;\r\n\r\n\t\tif (tilesToLoad === 0) { return; }\r\n\r\n\t\t// load tiles in order of their distance to center\r\n\t\tqueue.sort(function (a, b) {\r\n\t\t\treturn a.distanceTo(center) - b.distanceTo(center);\r\n\t\t});\r\n\r\n\t\tvar fragment = document.createDocumentFragment();\r\n\r\n\t\t// if its the first batch of tiles to load\r\n\t\tif (!this._tilesToLoad) {\r\n\t\t\tthis.fire('loading');\r\n\t\t}\r\n\r\n\t\tthis._tilesToLoad += tilesToLoad;\r\n\r\n\t\tfor (i = 0; i < tilesToLoad; i++) {\r\n\t\t\tthis._addTile(queue[i], fragment);\r\n\t\t}\r\n\r\n\t\tthis._tileContainer.appendChild(fragment);\r\n\t},\r\n\r\n\t_tileShouldBeLoaded: function (tilePoint) {\r\n\t\tif ((tilePoint.x + ':' + tilePoint.y) in this._tiles) {\r\n\t\t\treturn false; // already loaded\r\n\t\t}\r\n\r\n\t\tvar options = this.options;\r\n\r\n\t\tif (!options.continuousWorld) {\r\n\t\t\tvar limit = this._getWrapTileNum();\r\n\r\n\t\t\t// don't load if exceeds world bounds\r\n\t\t\tif ((options.noWrap && (tilePoint.x < 0 || tilePoint.x >= limit.x)) ||\r\n\t\t\t\ttilePoint.y < 0 || tilePoint.y >= limit.y) { return false; }\r\n\t\t}\r\n\r\n\t\tif (options.bounds) {\r\n\t\t\tvar tileSize = this._getTileSize(),\r\n\t\t\t    nwPoint = tilePoint.multiplyBy(tileSize),\r\n\t\t\t    sePoint = nwPoint.add([tileSize, tileSize]),\r\n\t\t\t    nw = this._map.unproject(nwPoint),\r\n\t\t\t    se = this._map.unproject(sePoint);\r\n\r\n\t\t\t// TODO temporary hack, will be removed after refactoring projections\r\n\t\t\t// https://github.com/Leaflet/Leaflet/issues/1618\r\n\t\t\tif (!options.continuousWorld && !options.noWrap) {\r\n\t\t\t\tnw = nw.wrap();\r\n\t\t\t\tse = se.wrap();\r\n\t\t\t}\r\n\r\n\t\t\tif (!options.bounds.intersects([nw, se])) { return false; }\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t},\r\n\r\n\t_removeOtherTiles: function (bounds) {\r\n\t\tvar kArr, x, y, key;\r\n\r\n\t\tfor (key in this._tiles) {\r\n\t\t\tkArr = key.split(':');\r\n\t\t\tx = parseInt(kArr[0], 10);\r\n\t\t\ty = parseInt(kArr[1], 10);\r\n\r\n\t\t\t// remove tile if it's out of bounds\r\n\t\t\tif (x < bounds.min.x || x > bounds.max.x || y < bounds.min.y || y > bounds.max.y) {\r\n\t\t\t\tthis._removeTile(key);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_removeTile: function (key) {\r\n\t\tvar tile = this._tiles[key];\r\n\r\n\t\tthis.fire('tileunload', {tile: tile, url: tile.src});\r\n\r\n\t\tif (this.options.reuseTiles) {\r\n\t\t\tL.DomUtil.removeClass(tile, 'leaflet-tile-loaded');\r\n\t\t\tthis._unusedTiles.push(tile);\r\n\r\n\t\t} else if (tile.parentNode === this._tileContainer) {\r\n\t\t\tthis._tileContainer.removeChild(tile);\r\n\t\t}\r\n\r\n\t\t// for https://github.com/CloudMade/Leaflet/issues/137\r\n\t\tif (!L.Browser.android) {\r\n\t\t\ttile.onload = null;\r\n\t\t\ttile.src = L.Util.emptyImageUrl;\r\n\t\t}\r\n\r\n\t\tdelete this._tiles[key];\r\n\t},\r\n\r\n\t_addTile: function (tilePoint, container) {\r\n\t\tvar tilePos = this._getTilePos(tilePoint);\r\n\r\n\t\t// get unused tile - or create a new tile\r\n\t\tvar tile = this._getTile();\r\n\r\n\t\t/*\r\n\t\tChrome 20 layouts much faster with top/left (verify with timeline, frames)\r\n\t\tAndroid 4 browser has display issues with top/left and requires transform instead\r\n\t\t(other browsers don't currently care) - see debug/hacks/jitter.html for an example\r\n\t\t*/\r\n\t\tL.DomUtil.setPosition(tile, tilePos, L.Browser.chrome);\r\n\r\n\t\tthis._tiles[tilePoint.x + ':' + tilePoint.y] = tile;\r\n\r\n\t\tthis._loadTile(tile, tilePoint);\r\n\r\n\t\tif (tile.parentNode !== this._tileContainer) {\r\n\t\t\tcontainer.appendChild(tile);\r\n\t\t}\r\n\t},\r\n\r\n\t_getZoomForUrl: function () {\r\n\r\n\t\tvar options = this.options,\r\n\t\t    zoom = this._map.getZoom();\r\n\r\n\t\tif (options.zoomReverse) {\r\n\t\t\tzoom = options.maxZoom - zoom;\r\n\t\t}\r\n\r\n\t\tzoom += options.zoomOffset;\r\n\r\n\t\treturn options.maxNativeZoom ? Math.min(zoom, options.maxNativeZoom) : zoom;\r\n\t},\r\n\r\n\t_getTilePos: function (tilePoint) {\r\n\t\tvar origin = this._map.getPixelOrigin(),\r\n\t\t    tileSize = this._getTileSize();\r\n\r\n\t\treturn tilePoint.multiplyBy(tileSize).subtract(origin);\r\n\t},\r\n\r\n\t// image-specific code (override to implement e.g. Canvas or SVG tile layer)\r\n\r\n\tgetTileUrl: function (tilePoint) {\r\n\t\treturn L.Util.template(this._url, L.extend({\r\n\t\t\ts: this._getSubdomain(tilePoint),\r\n\t\t\tz: tilePoint.z,\r\n\t\t\tx: tilePoint.x,\r\n\t\t\ty: tilePoint.y\r\n\t\t}, this.options));\r\n\t},\r\n\r\n\t_getWrapTileNum: function () {\r\n\t\tvar crs = this._map.options.crs,\r\n\t\t    size = crs.getSize(this._map.getZoom());\r\n\t\treturn size.divideBy(this._getTileSize())._floor();\r\n\t},\r\n\r\n\t_adjustTilePoint: function (tilePoint) {\r\n\r\n\t\tvar limit = this._getWrapTileNum();\r\n\r\n\t\t// wrap tile coordinates\r\n\t\tif (!this.options.continuousWorld && !this.options.noWrap) {\r\n\t\t\ttilePoint.x = ((tilePoint.x % limit.x) + limit.x) % limit.x;\r\n\t\t}\r\n\r\n\t\tif (this.options.tms) {\r\n\t\t\ttilePoint.y = limit.y - tilePoint.y - 1;\r\n\t\t}\r\n\r\n\t\ttilePoint.z = this._getZoomForUrl();\r\n\t},\r\n\r\n\t_getSubdomain: function (tilePoint) {\r\n\t\tvar index = Math.abs(tilePoint.x + tilePoint.y) % this.options.subdomains.length;\r\n\t\treturn this.options.subdomains[index];\r\n\t},\r\n\r\n\t_getTile: function () {\r\n\t\tif (this.options.reuseTiles && this._unusedTiles.length > 0) {\r\n\t\t\tvar tile = this._unusedTiles.pop();\r\n\t\t\tthis._resetTile(tile);\r\n\t\t\treturn tile;\r\n\t\t}\r\n\t\treturn this._createTile();\r\n\t},\r\n\r\n\t// Override if data stored on a tile needs to be cleaned up before reuse\r\n\t_resetTile: function (/*tile*/) {},\r\n\r\n\t_createTile: function () {\r\n\t\tvar tile = L.DomUtil.create('img', 'leaflet-tile');\r\n\t\ttile.style.width = tile.style.height = this._getTileSize() + 'px';\r\n\t\ttile.galleryimg = 'no';\r\n\r\n\t\ttile.onselectstart = tile.onmousemove = L.Util.falseFn;\r\n\r\n\t\tif (L.Browser.ielt9 && this.options.opacity !== undefined) {\r\n\t\t\tL.DomUtil.setOpacity(tile, this.options.opacity);\r\n\t\t}\r\n\t\t// without this hack, tiles disappear after zoom on Chrome for Android\r\n\t\t// https://github.com/Leaflet/Leaflet/issues/2078\r\n\t\tif (L.Browser.mobileWebkit3d) {\r\n\t\t\ttile.style.WebkitBackfaceVisibility = 'hidden';\r\n\t\t}\r\n\t\treturn tile;\r\n\t},\r\n\r\n\t_loadTile: function (tile, tilePoint) {\r\n\t\ttile._layer  = this;\r\n\t\ttile.onload  = this._tileOnLoad;\r\n\t\ttile.onerror = this._tileOnError;\r\n\r\n\t\tthis._adjustTilePoint(tilePoint);\r\n\t\ttile.src     = this.getTileUrl(tilePoint);\r\n\r\n\t\tthis.fire('tileloadstart', {\r\n\t\t\ttile: tile,\r\n\t\t\turl: tile.src\r\n\t\t});\r\n\t},\r\n\r\n\t_tileLoaded: function () {\r\n\t\tthis._tilesToLoad--;\r\n\r\n\t\tif (this._animated) {\r\n\t\t\tL.DomUtil.addClass(this._tileContainer, 'leaflet-zoom-animated');\r\n\t\t}\r\n\r\n\t\tif (!this._tilesToLoad) {\r\n\t\t\tthis.fire('load');\r\n\r\n\t\t\tif (this._animated) {\r\n\t\t\t\t// clear scaled tiles after all new tiles are loaded (for performance)\r\n\t\t\t\tclearTimeout(this._clearBgBufferTimer);\r\n\t\t\t\tthis._clearBgBufferTimer = setTimeout(L.bind(this._clearBgBuffer, this), 500);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_tileOnLoad: function () {\r\n\t\tvar layer = this._layer;\r\n\r\n\t\t//Only if we are loading an actual image\r\n\t\tif (this.src !== L.Util.emptyImageUrl) {\r\n\t\t\tL.DomUtil.addClass(this, 'leaflet-tile-loaded');\r\n\r\n\t\t\tlayer.fire('tileload', {\r\n\t\t\t\ttile: this,\r\n\t\t\t\turl: this.src\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tlayer._tileLoaded();\r\n\t},\r\n\r\n\t_tileOnError: function () {\r\n\t\tvar layer = this._layer;\r\n\r\n\t\tlayer.fire('tileerror', {\r\n\t\t\ttile: this,\r\n\t\t\turl: this.src\r\n\t\t});\r\n\r\n\t\tvar newUrl = layer.options.errorTileUrl;\r\n\t\tif (newUrl) {\r\n\t\t\tthis.src = newUrl;\r\n\t\t}\r\n\r\n\t\tlayer._tileLoaded();\r\n\t}\r\n});\r\n\r\nL.tileLayer = function (url, options) {\r\n\treturn new L.TileLayer(url, options);\r\n};\r\n\n\n/*\r\n * L.TileLayer.WMS is used for putting WMS tile layers on the map.\r\n */\r\n\r\nL.TileLayer.WMS = L.TileLayer.extend({\r\n\r\n\tdefaultWmsParams: {\r\n\t\tservice: 'WMS',\r\n\t\trequest: 'GetMap',\r\n\t\tversion: '1.1.1',\r\n\t\tlayers: '',\r\n\t\tstyles: '',\r\n\t\tformat: 'image/jpeg',\r\n\t\ttransparent: false\r\n\t},\r\n\r\n\tinitialize: function (url, options) { // (String, Object)\r\n\r\n\t\tthis._url = url;\r\n\r\n\t\tvar wmsParams = L.extend({}, this.defaultWmsParams),\r\n\t\t    tileSize = options.tileSize || this.options.tileSize;\r\n\r\n\t\tif (options.detectRetina && L.Browser.retina) {\r\n\t\t\twmsParams.width = wmsParams.height = tileSize * 2;\r\n\t\t} else {\r\n\t\t\twmsParams.width = wmsParams.height = tileSize;\r\n\t\t}\r\n\r\n\t\tfor (var i in options) {\r\n\t\t\t// all keys that are not TileLayer options go to WMS params\r\n\t\t\tif (!this.options.hasOwnProperty(i) && i !== 'crs') {\r\n\t\t\t\twmsParams[i] = options[i];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.wmsParams = wmsParams;\r\n\r\n\t\tL.setOptions(this, options);\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\r\n\t\tthis._crs = this.options.crs || map.options.crs;\r\n\r\n\t\tthis._wmsVersion = parseFloat(this.wmsParams.version);\r\n\r\n\t\tvar projectionKey = this._wmsVersion >= 1.3 ? 'crs' : 'srs';\r\n\t\tthis.wmsParams[projectionKey] = this._crs.code;\r\n\r\n\t\tL.TileLayer.prototype.onAdd.call(this, map);\r\n\t},\r\n\r\n\tgetTileUrl: function (tilePoint) { // (Point, Number) -> String\r\n\r\n\t\tvar map = this._map,\r\n\t\t    tileSize = this.options.tileSize,\r\n\r\n\t\t    nwPoint = tilePoint.multiplyBy(tileSize),\r\n\t\t    sePoint = nwPoint.add([tileSize, tileSize]),\r\n\r\n\t\t    nw = this._crs.project(map.unproject(nwPoint, tilePoint.z)),\r\n\t\t    se = this._crs.project(map.unproject(sePoint, tilePoint.z)),\r\n\t\t    bbox = this._wmsVersion >= 1.3 && this._crs === L.CRS.EPSG4326 ?\r\n\t\t        [se.y, nw.x, nw.y, se.x].join(',') :\r\n\t\t        [nw.x, se.y, se.x, nw.y].join(','),\r\n\r\n\t\t    url = L.Util.template(this._url, {s: this._getSubdomain(tilePoint)});\r\n\r\n\t\treturn url + L.Util.getParamString(this.wmsParams, url, true) + '&BBOX=' + bbox;\r\n\t},\r\n\r\n\tsetParams: function (params, noRedraw) {\r\n\r\n\t\tL.extend(this.wmsParams, params);\r\n\r\n\t\tif (!noRedraw) {\r\n\t\t\tthis.redraw();\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t}\r\n});\r\n\r\nL.tileLayer.wms = function (url, options) {\r\n\treturn new L.TileLayer.WMS(url, options);\r\n};\r\n\n\n/*\r\n * L.TileLayer.Canvas is a class that you can use as a base for creating\r\n * dynamically drawn Canvas-based tile layers.\r\n */\r\n\r\nL.TileLayer.Canvas = L.TileLayer.extend({\r\n\toptions: {\r\n\t\tasync: false\r\n\t},\r\n\r\n\tinitialize: function (options) {\r\n\t\tL.setOptions(this, options);\r\n\t},\r\n\r\n\tredraw: function () {\r\n\t\tif (this._map) {\r\n\t\t\tthis._reset({hard: true});\r\n\t\t\tthis._update();\r\n\t\t}\r\n\r\n\t\tfor (var i in this._tiles) {\r\n\t\t\tthis._redrawTile(this._tiles[i]);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_redrawTile: function (tile) {\r\n\t\tthis.drawTile(tile, tile._tilePoint, this._map._zoom);\r\n\t},\r\n\r\n\t_createTile: function () {\r\n\t\tvar tile = L.DomUtil.create('canvas', 'leaflet-tile');\r\n\t\ttile.width = tile.height = this.options.tileSize;\r\n\t\ttile.onselectstart = tile.onmousemove = L.Util.falseFn;\r\n\t\treturn tile;\r\n\t},\r\n\r\n\t_loadTile: function (tile, tilePoint) {\r\n\t\ttile._layer = this;\r\n\t\ttile._tilePoint = tilePoint;\r\n\r\n\t\tthis._redrawTile(tile);\r\n\r\n\t\tif (!this.options.async) {\r\n\t\t\tthis.tileDrawn(tile);\r\n\t\t}\r\n\t},\r\n\r\n\tdrawTile: function (/*tile, tilePoint*/) {\r\n\t\t// override with rendering code\r\n\t},\r\n\r\n\ttileDrawn: function (tile) {\r\n\t\tthis._tileOnLoad.call(tile);\r\n\t}\r\n});\r\n\r\n\r\nL.tileLayer.canvas = function (options) {\r\n\treturn new L.TileLayer.Canvas(options);\r\n};\r\n\n\n/*\r\n * L.ImageOverlay is used to overlay images over the map (to specific geographical bounds).\r\n */\r\n\r\nL.ImageOverlay = L.Class.extend({\r\n\tincludes: L.Mixin.Events,\r\n\r\n\toptions: {\r\n\t\topacity: 1\r\n\t},\r\n\r\n\tinitialize: function (url, bounds, options) { // (String, LatLngBounds, Object)\r\n\t\tthis._url = url;\r\n\t\tthis._bounds = L.latLngBounds(bounds);\r\n\r\n\t\tL.setOptions(this, options);\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tthis._map = map;\r\n\r\n\t\tif (!this._image) {\r\n\t\t\tthis._initImage();\r\n\t\t}\r\n\r\n\t\tmap._panes.overlayPane.appendChild(this._image);\r\n\r\n\t\tmap.on('viewreset', this._reset, this);\r\n\r\n\t\tif (map.options.zoomAnimation && L.Browser.any3d) {\r\n\t\t\tmap.on('zoomanim', this._animateZoom, this);\r\n\t\t}\r\n\r\n\t\tthis._reset();\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tmap.getPanes().overlayPane.removeChild(this._image);\r\n\r\n\t\tmap.off('viewreset', this._reset, this);\r\n\r\n\t\tif (map.options.zoomAnimation) {\r\n\t\t\tmap.off('zoomanim', this._animateZoom, this);\r\n\t\t}\r\n\t},\r\n\r\n\taddTo: function (map) {\r\n\t\tmap.addLayer(this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetOpacity: function (opacity) {\r\n\t\tthis.options.opacity = opacity;\r\n\t\tthis._updateOpacity();\r\n\t\treturn this;\r\n\t},\r\n\r\n\t// TODO remove bringToFront/bringToBack duplication from TileLayer/Path\r\n\tbringToFront: function () {\r\n\t\tif (this._image) {\r\n\t\t\tthis._map._panes.overlayPane.appendChild(this._image);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tbringToBack: function () {\r\n\t\tvar pane = this._map._panes.overlayPane;\r\n\t\tif (this._image) {\r\n\t\t\tpane.insertBefore(this._image, pane.firstChild);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetUrl: function (url) {\r\n\t\tthis._url = url;\r\n\t\tthis._image.src = this._url;\r\n\t},\r\n\r\n\tgetAttribution: function () {\r\n\t\treturn this.options.attribution;\r\n\t},\r\n\r\n\t_initImage: function () {\r\n\t\tthis._image = L.DomUtil.create('img', 'leaflet-image-layer');\r\n\r\n\t\tif (this._map.options.zoomAnimation && L.Browser.any3d) {\r\n\t\t\tL.DomUtil.addClass(this._image, 'leaflet-zoom-animated');\r\n\t\t} else {\r\n\t\t\tL.DomUtil.addClass(this._image, 'leaflet-zoom-hide');\r\n\t\t}\r\n\r\n\t\tthis._updateOpacity();\r\n\r\n\t\t//TODO createImage util method to remove duplication\r\n\t\tL.extend(this._image, {\r\n\t\t\tgalleryimg: 'no',\r\n\t\t\tonselectstart: L.Util.falseFn,\r\n\t\t\tonmousemove: L.Util.falseFn,\r\n\t\t\tonload: L.bind(this._onImageLoad, this),\r\n\t\t\tsrc: this._url\r\n\t\t});\r\n\t},\r\n\r\n\t_animateZoom: function (e) {\r\n\t\tvar map = this._map,\r\n\t\t    image = this._image,\r\n\t\t    scale = map.getZoomScale(e.zoom),\r\n\t\t    nw = this._bounds.getNorthWest(),\r\n\t\t    se = this._bounds.getSouthEast(),\r\n\r\n\t\t    topLeft = map._latLngToNewLayerPoint(nw, e.zoom, e.center),\r\n\t\t    size = map._latLngToNewLayerPoint(se, e.zoom, e.center)._subtract(topLeft),\r\n\t\t    origin = topLeft._add(size._multiplyBy((1 / 2) * (1 - 1 / scale)));\r\n\r\n\t\timage.style[L.DomUtil.TRANSFORM] =\r\n\t\t        L.DomUtil.getTranslateString(origin) + ' scale(' + scale + ') ';\r\n\t},\r\n\r\n\t_reset: function () {\r\n\t\tvar image   = this._image,\r\n\t\t    topLeft = this._map.latLngToLayerPoint(this._bounds.getNorthWest()),\r\n\t\t    size = this._map.latLngToLayerPoint(this._bounds.getSouthEast())._subtract(topLeft);\r\n\r\n\t\tL.DomUtil.setPosition(image, topLeft);\r\n\r\n\t\timage.style.width  = size.x + 'px';\r\n\t\timage.style.height = size.y + 'px';\r\n\t},\r\n\r\n\t_onImageLoad: function () {\r\n\t\tthis.fire('load');\r\n\t},\r\n\r\n\t_updateOpacity: function () {\r\n\t\tL.DomUtil.setOpacity(this._image, this.options.opacity);\r\n\t}\r\n});\r\n\r\nL.imageOverlay = function (url, bounds, options) {\r\n\treturn new L.ImageOverlay(url, bounds, options);\r\n};\r\n\n\n/*\r\n * L.Icon is an image-based icon class that you can use with L.Marker for custom markers.\r\n */\r\n\r\nL.Icon = L.Class.extend({\r\n\toptions: {\r\n\t\t/*\r\n\t\ticonUrl: (String) (required)\r\n\t\ticonRetinaUrl: (String) (optional, used for retina devices if detected)\r\n\t\ticonSize: (Point) (can be set through CSS)\r\n\t\ticonAnchor: (Point) (centered by default, can be set in CSS with negative margins)\r\n\t\tpopupAnchor: (Point) (if not specified, popup opens in the anchor point)\r\n\t\tshadowUrl: (String) (no shadow by default)\r\n\t\tshadowRetinaUrl: (String) (optional, used for retina devices if detected)\r\n\t\tshadowSize: (Point)\r\n\t\tshadowAnchor: (Point)\r\n\t\t*/\r\n\t\tclassName: ''\r\n\t},\r\n\r\n\tinitialize: function (options) {\r\n\t\tL.setOptions(this, options);\r\n\t},\r\n\r\n\tcreateIcon: function (oldIcon) {\r\n\t\treturn this._createIcon('icon', oldIcon);\r\n\t},\r\n\r\n\tcreateShadow: function (oldIcon) {\r\n\t\treturn this._createIcon('shadow', oldIcon);\r\n\t},\r\n\r\n\t_createIcon: function (name, oldIcon) {\r\n\t\tvar src = this._getIconUrl(name);\r\n\r\n\t\tif (!src) {\r\n\t\t\tif (name === 'icon') {\r\n\t\t\t\tthrow new Error('iconUrl not set in Icon options (see the docs).');\r\n\t\t\t}\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tvar img;\r\n\t\tif (!oldIcon || oldIcon.tagName !== 'IMG') {\r\n\t\t\timg = this._createImg(src);\r\n\t\t} else {\r\n\t\t\timg = this._createImg(src, oldIcon);\r\n\t\t}\r\n\t\tthis._setIconStyles(img, name);\r\n\r\n\t\treturn img;\r\n\t},\r\n\r\n\t_setIconStyles: function (img, name) {\r\n\t\tvar options = this.options,\r\n\t\t    size = L.point(options[name + 'Size']),\r\n\t\t    anchor;\r\n\r\n\t\tif (name === 'shadow') {\r\n\t\t\tanchor = L.point(options.shadowAnchor || options.iconAnchor);\r\n\t\t} else {\r\n\t\t\tanchor = L.point(options.iconAnchor);\r\n\t\t}\r\n\r\n\t\tif (!anchor && size) {\r\n\t\t\tanchor = size.divideBy(2, true);\r\n\t\t}\r\n\r\n\t\timg.className = 'leaflet-marker-' + name + ' ' + options.className;\r\n\r\n\t\tif (anchor) {\r\n\t\t\timg.style.marginLeft = (-anchor.x) + 'px';\r\n\t\t\timg.style.marginTop  = (-anchor.y) + 'px';\r\n\t\t}\r\n\r\n\t\tif (size) {\r\n\t\t\timg.style.width  = size.x + 'px';\r\n\t\t\timg.style.height = size.y + 'px';\r\n\t\t}\r\n\t},\r\n\r\n\t_createImg: function (src, el) {\r\n\t\tel = el || document.createElement('img');\r\n\t\tel.src = src;\r\n\t\treturn el;\r\n\t},\r\n\r\n\t_getIconUrl: function (name) {\r\n\t\tif (L.Browser.retina && this.options[name + 'RetinaUrl']) {\r\n\t\t\treturn this.options[name + 'RetinaUrl'];\r\n\t\t}\r\n\t\treturn this.options[name + 'Url'];\r\n\t}\r\n});\r\n\r\nL.icon = function (options) {\r\n\treturn new L.Icon(options);\r\n};\r\n\n\n/*\n * L.Icon.Default is the blue marker icon used by default in Leaflet.\n */\n\nL.Icon.Default = L.Icon.extend({\n\n\toptions: {\n\t\ticonSize: [25, 41],\n\t\ticonAnchor: [12, 41],\n\t\tpopupAnchor: [1, -34],\n\n\t\tshadowSize: [41, 41]\n\t},\n\n\t_getIconUrl: function (name) {\n\t\tvar key = name + 'Url';\n\n\t\tif (this.options[key]) {\n\t\t\treturn this.options[key];\n\t\t}\n\n\t\tif (L.Browser.retina && name === 'icon') {\n\t\t\tname += '-2x';\n\t\t}\n\n\t\tvar path = L.Icon.Default.imagePath;\n\n\t\tif (!path) {\n\t\t\tthrow new Error('Couldn\\'t autodetect L.Icon.Default.imagePath, set it manually.');\n\t\t}\n\n\t\treturn path + '/marker-' + name + '.png';\n\t}\n});\n\nL.Icon.Default.imagePath = (function () {\n\tvar scripts = document.getElementsByTagName('script'),\n\t    leafletRe = /[\\/^]leaflet[\\-\\._]?([\\w\\-\\._]*)\\.js\\??/;\n\n\tvar i, len, src, matches, path;\n\n\tfor (i = 0, len = scripts.length; i < len; i++) {\n\t\tsrc = scripts[i].src;\n\t\tmatches = src.match(leafletRe);\n\n\t\tif (matches) {\n\t\t\tpath = src.split(leafletRe)[0];\n\t\t\treturn (path ? path + '/' : '') + 'images';\n\t\t}\n\t}\n}());\n\n\n/*\r\n * L.Marker is used to display clickable/draggable icons on the map.\r\n */\r\n\r\nL.Marker = L.Class.extend({\r\n\r\n\tincludes: L.Mixin.Events,\r\n\r\n\toptions: {\r\n\t\ticon: new L.Icon.Default(),\r\n\t\ttitle: '',\r\n\t\talt: '',\r\n\t\tclickable: true,\r\n\t\tdraggable: false,\r\n\t\tkeyboard: true,\r\n\t\tzIndexOffset: 0,\r\n\t\topacity: 1,\r\n\t\triseOnHover: false,\r\n\t\triseOffset: 250\r\n\t},\r\n\r\n\tinitialize: function (latlng, options) {\r\n\t\tL.setOptions(this, options);\r\n\t\tthis._latlng = L.latLng(latlng);\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tthis._map = map;\r\n\r\n\t\tmap.on('viewreset', this.update, this);\r\n\r\n\t\tthis._initIcon();\r\n\t\tthis.update();\r\n\t\tthis.fire('add');\r\n\r\n\t\tif (map.options.zoomAnimation && map.options.markerZoomAnimation) {\r\n\t\t\tmap.on('zoomanim', this._animateZoom, this);\r\n\t\t}\r\n\t},\r\n\r\n\taddTo: function (map) {\r\n\t\tmap.addLayer(this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tif (this.dragging) {\r\n\t\t\tthis.dragging.disable();\r\n\t\t}\r\n\r\n\t\tthis._removeIcon();\r\n\t\tthis._removeShadow();\r\n\r\n\t\tthis.fire('remove');\r\n\r\n\t\tmap.off({\r\n\t\t\t'viewreset': this.update,\r\n\t\t\t'zoomanim': this._animateZoom\r\n\t\t}, this);\r\n\r\n\t\tthis._map = null;\r\n\t},\r\n\r\n\tgetLatLng: function () {\r\n\t\treturn this._latlng;\r\n\t},\r\n\r\n\tsetLatLng: function (latlng) {\r\n\t\tthis._latlng = L.latLng(latlng);\r\n\r\n\t\tthis.update();\r\n\r\n\t\treturn this.fire('move', { latlng: this._latlng });\r\n\t},\r\n\r\n\tsetZIndexOffset: function (offset) {\r\n\t\tthis.options.zIndexOffset = offset;\r\n\t\tthis.update();\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetIcon: function (icon) {\r\n\r\n\t\tthis.options.icon = icon;\r\n\r\n\t\tif (this._map) {\r\n\t\t\tthis._initIcon();\r\n\t\t\tthis.update();\r\n\t\t}\r\n\r\n\t\tif (this._popup) {\r\n\t\t\tthis.bindPopup(this._popup);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tupdate: function () {\r\n\t\tif (this._icon) {\r\n\t\t\tthis._setPos(this._map.latLngToLayerPoint(this._latlng).round());\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_initIcon: function () {\r\n\t\tvar options = this.options,\r\n\t\t    map = this._map,\r\n\t\t    animation = (map.options.zoomAnimation && map.options.markerZoomAnimation),\r\n\t\t    classToAdd = animation ? 'leaflet-zoom-animated' : 'leaflet-zoom-hide';\r\n\r\n\t\tvar icon = options.icon.createIcon(this._icon),\r\n\t\t\taddIcon = false;\r\n\r\n\t\t// if we're not reusing the icon, remove the old one and init new one\r\n\t\tif (icon !== this._icon) {\r\n\t\t\tif (this._icon) {\r\n\t\t\t\tthis._removeIcon();\r\n\t\t\t}\r\n\t\t\taddIcon = true;\r\n\r\n\t\t\tif (options.title) {\r\n\t\t\t\ticon.title = options.title;\r\n\t\t\t}\r\n\r\n\t\t\tif (options.alt) {\r\n\t\t\t\ticon.alt = options.alt;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tL.DomUtil.addClass(icon, classToAdd);\r\n\r\n\t\tif (options.keyboard) {\r\n\t\t\ticon.tabIndex = '0';\r\n\t\t}\r\n\r\n\t\tthis._icon = icon;\r\n\r\n\t\tthis._initInteraction();\r\n\r\n\t\tif (options.riseOnHover) {\r\n\t\t\tL.DomEvent\r\n\t\t\t\t.on(icon, 'mouseover', this._bringToFront, this)\r\n\t\t\t\t.on(icon, 'mouseout', this._resetZIndex, this);\r\n\t\t}\r\n\r\n\t\tvar newShadow = options.icon.createShadow(this._shadow),\r\n\t\t\taddShadow = false;\r\n\r\n\t\tif (newShadow !== this._shadow) {\r\n\t\t\tthis._removeShadow();\r\n\t\t\taddShadow = true;\r\n\t\t}\r\n\r\n\t\tif (newShadow) {\r\n\t\t\tL.DomUtil.addClass(newShadow, classToAdd);\r\n\t\t}\r\n\t\tthis._shadow = newShadow;\r\n\r\n\r\n\t\tif (options.opacity < 1) {\r\n\t\t\tthis._updateOpacity();\r\n\t\t}\r\n\r\n\r\n\t\tvar panes = this._map._panes;\r\n\r\n\t\tif (addIcon) {\r\n\t\t\tpanes.markerPane.appendChild(this._icon);\r\n\t\t}\r\n\r\n\t\tif (newShadow && addShadow) {\r\n\t\t\tpanes.shadowPane.appendChild(this._shadow);\r\n\t\t}\r\n\t},\r\n\r\n\t_removeIcon: function () {\r\n\t\tif (this.options.riseOnHover) {\r\n\t\t\tL.DomEvent\r\n\t\t\t    .off(this._icon, 'mouseover', this._bringToFront)\r\n\t\t\t    .off(this._icon, 'mouseout', this._resetZIndex);\r\n\t\t}\r\n\r\n\t\tthis._map._panes.markerPane.removeChild(this._icon);\r\n\r\n\t\tthis._icon = null;\r\n\t},\r\n\r\n\t_removeShadow: function () {\r\n\t\tif (this._shadow) {\r\n\t\t\tthis._map._panes.shadowPane.removeChild(this._shadow);\r\n\t\t}\r\n\t\tthis._shadow = null;\r\n\t},\r\n\r\n\t_setPos: function (pos) {\r\n\t\tL.DomUtil.setPosition(this._icon, pos);\r\n\r\n\t\tif (this._shadow) {\r\n\t\t\tL.DomUtil.setPosition(this._shadow, pos);\r\n\t\t}\r\n\r\n\t\tthis._zIndex = pos.y + this.options.zIndexOffset;\r\n\r\n\t\tthis._resetZIndex();\r\n\t},\r\n\r\n\t_updateZIndex: function (offset) {\r\n\t\tthis._icon.style.zIndex = this._zIndex + offset;\r\n\t},\r\n\r\n\t_animateZoom: function (opt) {\r\n\t\tvar pos = this._map._latLngToNewLayerPoint(this._latlng, opt.zoom, opt.center).round();\r\n\r\n\t\tthis._setPos(pos);\r\n\t},\r\n\r\n\t_initInteraction: function () {\r\n\r\n\t\tif (!this.options.clickable) { return; }\r\n\r\n\t\t// TODO refactor into something shared with Map/Path/etc. to DRY it up\r\n\r\n\t\tvar icon = this._icon,\r\n\t\t    events = ['dblclick', 'mousedown', 'mouseover', 'mouseout', 'contextmenu'];\r\n\r\n\t\tL.DomUtil.addClass(icon, 'leaflet-clickable');\r\n\t\tL.DomEvent.on(icon, 'click', this._onMouseClick, this);\r\n\t\tL.DomEvent.on(icon, 'keypress', this._onKeyPress, this);\r\n\r\n\t\tfor (var i = 0; i < events.length; i++) {\r\n\t\t\tL.DomEvent.on(icon, events[i], this._fireMouseEvent, this);\r\n\t\t}\r\n\r\n\t\tif (L.Handler.MarkerDrag) {\r\n\t\t\tthis.dragging = new L.Handler.MarkerDrag(this);\r\n\r\n\t\t\tif (this.options.draggable) {\r\n\t\t\t\tthis.dragging.enable();\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_onMouseClick: function (e) {\r\n\t\tvar wasDragged = this.dragging && this.dragging.moved();\r\n\r\n\t\tif (this.hasEventListeners(e.type) || wasDragged) {\r\n\t\t\tL.DomEvent.stopPropagation(e);\r\n\t\t}\r\n\r\n\t\tif (wasDragged) { return; }\r\n\r\n\t\tif ((!this.dragging || !this.dragging._enabled) && this._map.dragging && this._map.dragging.moved()) { return; }\r\n\r\n\t\tthis.fire(e.type, {\r\n\t\t\toriginalEvent: e,\r\n\t\t\tlatlng: this._latlng\r\n\t\t});\r\n\t},\r\n\r\n\t_onKeyPress: function (e) {\r\n\t\tif (e.keyCode === 13) {\r\n\t\t\tthis.fire('click', {\r\n\t\t\t\toriginalEvent: e,\r\n\t\t\t\tlatlng: this._latlng\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\r\n\t_fireMouseEvent: function (e) {\r\n\r\n\t\tthis.fire(e.type, {\r\n\t\t\toriginalEvent: e,\r\n\t\t\tlatlng: this._latlng\r\n\t\t});\r\n\r\n\t\t// TODO proper custom event propagation\r\n\t\t// this line will always be called if marker is in a FeatureGroup\r\n\t\tif (e.type === 'contextmenu' && this.hasEventListeners(e.type)) {\r\n\t\t\tL.DomEvent.preventDefault(e);\r\n\t\t}\r\n\t\tif (e.type !== 'mousedown') {\r\n\t\t\tL.DomEvent.stopPropagation(e);\r\n\t\t} else {\r\n\t\t\tL.DomEvent.preventDefault(e);\r\n\t\t}\r\n\t},\r\n\r\n\tsetOpacity: function (opacity) {\r\n\t\tthis.options.opacity = opacity;\r\n\t\tif (this._map) {\r\n\t\t\tthis._updateOpacity();\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_updateOpacity: function () {\r\n\t\tL.DomUtil.setOpacity(this._icon, this.options.opacity);\r\n\t\tif (this._shadow) {\r\n\t\t\tL.DomUtil.setOpacity(this._shadow, this.options.opacity);\r\n\t\t}\r\n\t},\r\n\r\n\t_bringToFront: function () {\r\n\t\tthis._updateZIndex(this.options.riseOffset);\r\n\t},\r\n\r\n\t_resetZIndex: function () {\r\n\t\tthis._updateZIndex(0);\r\n\t}\r\n});\r\n\r\nL.marker = function (latlng, options) {\r\n\treturn new L.Marker(latlng, options);\r\n};\r\n\n\n/*\n * L.DivIcon is a lightweight HTML-based icon class (as opposed to the image-based L.Icon)\n * to use with L.Marker.\n */\n\nL.DivIcon = L.Icon.extend({\n\toptions: {\n\t\ticonSize: [12, 12], // also can be set through CSS\n\t\t/*\n\t\ticonAnchor: (Point)\n\t\tpopupAnchor: (Point)\n\t\thtml: (String)\n\t\tbgPos: (Point)\n\t\t*/\n\t\tclassName: 'leaflet-div-icon',\n\t\thtml: false\n\t},\n\n\tcreateIcon: function (oldIcon) {\n\t\tvar div = (oldIcon && oldIcon.tagName === 'DIV') ? oldIcon : document.createElement('div'),\n\t\t    options = this.options;\n\n\t\tif (options.html !== false) {\n\t\t\tdiv.innerHTML = options.html;\n\t\t} else {\n\t\t\tdiv.innerHTML = '';\n\t\t}\n\n\t\tif (options.bgPos) {\n\t\t\tdiv.style.backgroundPosition =\n\t\t\t        (-options.bgPos.x) + 'px ' + (-options.bgPos.y) + 'px';\n\t\t}\n\n\t\tthis._setIconStyles(div, 'icon');\n\t\treturn div;\n\t},\n\n\tcreateShadow: function () {\n\t\treturn null;\n\t}\n});\n\nL.divIcon = function (options) {\n\treturn new L.DivIcon(options);\n};\n\n\n/*\r\n * L.Popup is used for displaying popups on the map.\r\n */\r\n\r\nL.Map.mergeOptions({\r\n\tclosePopupOnClick: true\r\n});\r\n\r\nL.Popup = L.Class.extend({\r\n\tincludes: L.Mixin.Events,\r\n\r\n\toptions: {\r\n\t\tminWidth: 50,\r\n\t\tmaxWidth: 300,\r\n\t\t// maxHeight: null,\r\n\t\tautoPan: true,\r\n\t\tcloseButton: true,\r\n\t\toffset: [0, 7],\r\n\t\tautoPanPadding: [5, 5],\r\n\t\t// autoPanPaddingTopLeft: null,\r\n\t\t// autoPanPaddingBottomRight: null,\r\n\t\tkeepInView: false,\r\n\t\tclassName: '',\r\n\t\tzoomAnimation: true\r\n\t},\r\n\r\n\tinitialize: function (options, source) {\r\n\t\tL.setOptions(this, options);\r\n\r\n\t\tthis._source = source;\r\n\t\tthis._animated = L.Browser.any3d && this.options.zoomAnimation;\r\n\t\tthis._isOpen = false;\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tthis._map = map;\r\n\r\n\t\tif (!this._container) {\r\n\t\t\tthis._initLayout();\r\n\t\t}\r\n\r\n\t\tvar animFade = map.options.fadeAnimation;\r\n\r\n\t\tif (animFade) {\r\n\t\t\tL.DomUtil.setOpacity(this._container, 0);\r\n\t\t}\r\n\t\tmap._panes.popupPane.appendChild(this._container);\r\n\r\n\t\tmap.on(this._getEvents(), this);\r\n\r\n\t\tthis.update();\r\n\r\n\t\tif (animFade) {\r\n\t\t\tL.DomUtil.setOpacity(this._container, 1);\r\n\t\t}\r\n\r\n\t\tthis.fire('open');\r\n\r\n\t\tmap.fire('popupopen', {popup: this});\r\n\r\n\t\tif (this._source) {\r\n\t\t\tthis._source.fire('popupopen', {popup: this});\r\n\t\t}\r\n\t},\r\n\r\n\taddTo: function (map) {\r\n\t\tmap.addLayer(this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\topenOn: function (map) {\r\n\t\tmap.openPopup(this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tmap._panes.popupPane.removeChild(this._container);\r\n\r\n\t\tL.Util.falseFn(this._container.offsetWidth); // force reflow\r\n\r\n\t\tmap.off(this._getEvents(), this);\r\n\r\n\t\tif (map.options.fadeAnimation) {\r\n\t\t\tL.DomUtil.setOpacity(this._container, 0);\r\n\t\t}\r\n\r\n\t\tthis._map = null;\r\n\r\n\t\tthis.fire('close');\r\n\r\n\t\tmap.fire('popupclose', {popup: this});\r\n\r\n\t\tif (this._source) {\r\n\t\t\tthis._source.fire('popupclose', {popup: this});\r\n\t\t}\r\n\t},\r\n\r\n\tgetLatLng: function () {\r\n\t\treturn this._latlng;\r\n\t},\r\n\r\n\tsetLatLng: function (latlng) {\r\n\t\tthis._latlng = L.latLng(latlng);\r\n\t\tif (this._map) {\r\n\t\t\tthis._updatePosition();\r\n\t\t\tthis._adjustPan();\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tgetContent: function () {\r\n\t\treturn this._content;\r\n\t},\r\n\r\n\tsetContent: function (content) {\r\n\t\tthis._content = content;\r\n\t\tthis.update();\r\n\t\treturn this;\r\n\t},\r\n\r\n\tupdate: function () {\r\n\t\tif (!this._map) { return; }\r\n\r\n\t\tthis._container.style.visibility = 'hidden';\r\n\r\n\t\tthis._updateContent();\r\n\t\tthis._updateLayout();\r\n\t\tthis._updatePosition();\r\n\r\n\t\tthis._container.style.visibility = '';\r\n\r\n\t\tthis._adjustPan();\r\n\t},\r\n\r\n\t_getEvents: function () {\r\n\t\tvar events = {\r\n\t\t\tviewreset: this._updatePosition\r\n\t\t};\r\n\r\n\t\tif (this._animated) {\r\n\t\t\tevents.zoomanim = this._zoomAnimation;\r\n\t\t}\r\n\t\tif ('closeOnClick' in this.options ? this.options.closeOnClick : this._map.options.closePopupOnClick) {\r\n\t\t\tevents.preclick = this._close;\r\n\t\t}\r\n\t\tif (this.options.keepInView) {\r\n\t\t\tevents.moveend = this._adjustPan;\r\n\t\t}\r\n\r\n\t\treturn events;\r\n\t},\r\n\r\n\t_close: function () {\r\n\t\tif (this._map) {\r\n\t\t\tthis._map.closePopup(this);\r\n\t\t}\r\n\t},\r\n\r\n\t_initLayout: function () {\r\n\t\tvar prefix = 'leaflet-popup',\r\n\t\t\tcontainerClass = prefix + ' ' + this.options.className + ' leaflet-zoom-' +\r\n\t\t\t        (this._animated ? 'animated' : 'hide'),\r\n\t\t\tcontainer = this._container = L.DomUtil.create('div', containerClass),\r\n\t\t\tcloseButton;\r\n\r\n\t\tif (this.options.closeButton) {\r\n\t\t\tcloseButton = this._closeButton =\r\n\t\t\t        L.DomUtil.create('a', prefix + '-close-button', container);\r\n\t\t\tcloseButton.href = '#close';\r\n\t\t\tcloseButton.innerHTML = '&#215;';\r\n\t\t\tL.DomEvent.disableClickPropagation(closeButton);\r\n\r\n\t\t\tL.DomEvent.on(closeButton, 'click', this._onCloseButtonClick, this);\r\n\t\t}\r\n\r\n\t\tvar wrapper = this._wrapper =\r\n\t\t        L.DomUtil.create('div', prefix + '-content-wrapper', container);\r\n\t\tL.DomEvent.disableClickPropagation(wrapper);\r\n\r\n\t\tthis._contentNode = L.DomUtil.create('div', prefix + '-content', wrapper);\r\n\r\n\t\tL.DomEvent.disableScrollPropagation(this._contentNode);\r\n\t\tL.DomEvent.on(wrapper, 'contextmenu', L.DomEvent.stopPropagation);\r\n\r\n\t\tthis._tipContainer = L.DomUtil.create('div', prefix + '-tip-container', container);\r\n\t\tthis._tip = L.DomUtil.create('div', prefix + '-tip', this._tipContainer);\r\n\t},\r\n\r\n\t_updateContent: function () {\r\n\t\tif (!this._content) { return; }\r\n\r\n\t\tif (typeof this._content === 'string') {\r\n\t\t\tthis._contentNode.innerHTML = this._content;\r\n\t\t} else {\r\n\t\t\twhile (this._contentNode.hasChildNodes()) {\r\n\t\t\t\tthis._contentNode.removeChild(this._contentNode.firstChild);\r\n\t\t\t}\r\n\t\t\tthis._contentNode.appendChild(this._content);\r\n\t\t}\r\n\t\tthis.fire('contentupdate');\r\n\t},\r\n\r\n\t_updateLayout: function () {\r\n\t\tvar container = this._contentNode,\r\n\t\t    style = container.style;\r\n\r\n\t\tstyle.width = '';\r\n\t\tstyle.whiteSpace = 'nowrap';\r\n\r\n\t\tvar width = container.offsetWidth;\r\n\t\twidth = Math.min(width, this.options.maxWidth);\r\n\t\twidth = Math.max(width, this.options.minWidth);\r\n\r\n\t\tstyle.width = (width + 1) + 'px';\r\n\t\tstyle.whiteSpace = '';\r\n\r\n\t\tstyle.height = '';\r\n\r\n\t\tvar height = container.offsetHeight,\r\n\t\t    maxHeight = this.options.maxHeight,\r\n\t\t    scrolledClass = 'leaflet-popup-scrolled';\r\n\r\n\t\tif (maxHeight && height > maxHeight) {\r\n\t\t\tstyle.height = maxHeight + 'px';\r\n\t\t\tL.DomUtil.addClass(container, scrolledClass);\r\n\t\t} else {\r\n\t\t\tL.DomUtil.removeClass(container, scrolledClass);\r\n\t\t}\r\n\r\n\t\tthis._containerWidth = this._container.offsetWidth;\r\n\t},\r\n\r\n\t_updatePosition: function () {\r\n\t\tif (!this._map) { return; }\r\n\r\n\t\tvar pos = this._map.latLngToLayerPoint(this._latlng),\r\n\t\t    animated = this._animated,\r\n\t\t    offset = L.point(this.options.offset);\r\n\r\n\t\tif (animated) {\r\n\t\t\tL.DomUtil.setPosition(this._container, pos);\r\n\t\t}\r\n\r\n\t\tthis._containerBottom = -offset.y - (animated ? 0 : pos.y);\r\n\t\tthis._containerLeft = -Math.round(this._containerWidth / 2) + offset.x + (animated ? 0 : pos.x);\r\n\r\n\t\t// bottom position the popup in case the height of the popup changes (images loading etc)\r\n\t\tthis._container.style.bottom = this._containerBottom + 'px';\r\n\t\tthis._container.style.left = this._containerLeft + 'px';\r\n\t},\r\n\r\n\t_zoomAnimation: function (opt) {\r\n\t\tvar pos = this._map._latLngToNewLayerPoint(this._latlng, opt.zoom, opt.center);\r\n\r\n\t\tL.DomUtil.setPosition(this._container, pos);\r\n\t},\r\n\r\n\t_adjustPan: function () {\r\n\t\tif (!this.options.autoPan) { return; }\r\n\r\n\t\tvar map = this._map,\r\n\t\t    containerHeight = this._container.offsetHeight,\r\n\t\t    containerWidth = this._containerWidth,\r\n\r\n\t\t    layerPos = new L.Point(this._containerLeft, -containerHeight - this._containerBottom);\r\n\r\n\t\tif (this._animated) {\r\n\t\t\tlayerPos._add(L.DomUtil.getPosition(this._container));\r\n\t\t}\r\n\r\n\t\tvar containerPos = map.layerPointToContainerPoint(layerPos),\r\n\t\t    padding = L.point(this.options.autoPanPadding),\r\n\t\t    paddingTL = L.point(this.options.autoPanPaddingTopLeft || padding),\r\n\t\t    paddingBR = L.point(this.options.autoPanPaddingBottomRight || padding),\r\n\t\t    size = map.getSize(),\r\n\t\t    dx = 0,\r\n\t\t    dy = 0;\r\n\r\n\t\tif (containerPos.x + containerWidth + paddingBR.x > size.x) { // right\r\n\t\t\tdx = containerPos.x + containerWidth - size.x + paddingBR.x;\r\n\t\t}\r\n\t\tif (containerPos.x - dx - paddingTL.x < 0) { // left\r\n\t\t\tdx = containerPos.x - paddingTL.x;\r\n\t\t}\r\n\t\tif (containerPos.y + containerHeight + paddingBR.y > size.y) { // bottom\r\n\t\t\tdy = containerPos.y + containerHeight - size.y + paddingBR.y;\r\n\t\t}\r\n\t\tif (containerPos.y - dy - paddingTL.y < 0) { // top\r\n\t\t\tdy = containerPos.y - paddingTL.y;\r\n\t\t}\r\n\r\n\t\tif (dx || dy) {\r\n\t\t\tmap\r\n\t\t\t    .fire('autopanstart')\r\n\t\t\t    .panBy([dx, dy]);\r\n\t\t}\r\n\t},\r\n\r\n\t_onCloseButtonClick: function (e) {\r\n\t\tthis._close();\r\n\t\tL.DomEvent.stop(e);\r\n\t}\r\n});\r\n\r\nL.popup = function (options, source) {\r\n\treturn new L.Popup(options, source);\r\n};\r\n\r\n\r\nL.Map.include({\r\n\topenPopup: function (popup, latlng, options) { // (Popup) or (String || HTMLElement, LatLng[, Object])\r\n\t\tthis.closePopup();\r\n\r\n\t\tif (!(popup instanceof L.Popup)) {\r\n\t\t\tvar content = popup;\r\n\r\n\t\t\tpopup = new L.Popup(options)\r\n\t\t\t    .setLatLng(latlng)\r\n\t\t\t    .setContent(content);\r\n\t\t}\r\n\t\tpopup._isOpen = true;\r\n\r\n\t\tthis._popup = popup;\r\n\t\treturn this.addLayer(popup);\r\n\t},\r\n\r\n\tclosePopup: function (popup) {\r\n\t\tif (!popup || popup === this._popup) {\r\n\t\t\tpopup = this._popup;\r\n\t\t\tthis._popup = null;\r\n\t\t}\r\n\t\tif (popup) {\r\n\t\t\tthis.removeLayer(popup);\r\n\t\t\tpopup._isOpen = false;\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n});\r\n\n\n/*\r\n * Popup extension to L.Marker, adding popup-related methods.\r\n */\r\n\r\nL.Marker.include({\r\n\topenPopup: function () {\r\n\t\tif (this._popup && this._map && !this._map.hasLayer(this._popup)) {\r\n\t\t\tthis._popup.setLatLng(this._latlng);\r\n\t\t\tthis._map.openPopup(this._popup);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tclosePopup: function () {\r\n\t\tif (this._popup) {\r\n\t\t\tthis._popup._close();\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\ttogglePopup: function () {\r\n\t\tif (this._popup) {\r\n\t\t\tif (this._popup._isOpen) {\r\n\t\t\t\tthis.closePopup();\r\n\t\t\t} else {\r\n\t\t\t\tthis.openPopup();\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tbindPopup: function (content, options) {\r\n\t\tvar anchor = L.point(this.options.icon.options.popupAnchor || [0, 0]);\r\n\r\n\t\tanchor = anchor.add(L.Popup.prototype.options.offset);\r\n\r\n\t\tif (options && options.offset) {\r\n\t\t\tanchor = anchor.add(options.offset);\r\n\t\t}\r\n\r\n\t\toptions = L.extend({offset: anchor}, options);\r\n\r\n\t\tif (!this._popupHandlersAdded) {\r\n\t\t\tthis\r\n\t\t\t    .on('click', this.togglePopup, this)\r\n\t\t\t    .on('remove', this.closePopup, this)\r\n\t\t\t    .on('move', this._movePopup, this);\r\n\t\t\tthis._popupHandlersAdded = true;\r\n\t\t}\r\n\r\n\t\tif (content instanceof L.Popup) {\r\n\t\t\tL.setOptions(content, options);\r\n\t\t\tthis._popup = content;\r\n\t\t\tcontent._source = this;\r\n\t\t} else {\r\n\t\t\tthis._popup = new L.Popup(options, this)\r\n\t\t\t\t.setContent(content);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetPopupContent: function (content) {\r\n\t\tif (this._popup) {\r\n\t\t\tthis._popup.setContent(content);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tunbindPopup: function () {\r\n\t\tif (this._popup) {\r\n\t\t\tthis._popup = null;\r\n\t\t\tthis\r\n\t\t\t    .off('click', this.togglePopup, this)\r\n\t\t\t    .off('remove', this.closePopup, this)\r\n\t\t\t    .off('move', this._movePopup, this);\r\n\t\t\tthis._popupHandlersAdded = false;\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tgetPopup: function () {\r\n\t\treturn this._popup;\r\n\t},\r\n\r\n\t_movePopup: function (e) {\r\n\t\tthis._popup.setLatLng(e.latlng);\r\n\t}\r\n});\r\n\n\n/*\r\n * L.LayerGroup is a class to combine several layers into one so that\r\n * you can manipulate the group (e.g. add/remove it) as one layer.\r\n */\r\n\r\nL.LayerGroup = L.Class.extend({\r\n\tinitialize: function (layers) {\r\n\t\tthis._layers = {};\r\n\r\n\t\tvar i, len;\r\n\r\n\t\tif (layers) {\r\n\t\t\tfor (i = 0, len = layers.length; i < len; i++) {\r\n\t\t\t\tthis.addLayer(layers[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\taddLayer: function (layer) {\r\n\t\tvar id = this.getLayerId(layer);\r\n\r\n\t\tthis._layers[id] = layer;\r\n\r\n\t\tif (this._map) {\r\n\t\t\tthis._map.addLayer(layer);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tremoveLayer: function (layer) {\r\n\t\tvar id = layer in this._layers ? layer : this.getLayerId(layer);\r\n\r\n\t\tif (this._map && this._layers[id]) {\r\n\t\t\tthis._map.removeLayer(this._layers[id]);\r\n\t\t}\r\n\r\n\t\tdelete this._layers[id];\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\thasLayer: function (layer) {\r\n\t\tif (!layer) { return false; }\r\n\r\n\t\treturn (layer in this._layers || this.getLayerId(layer) in this._layers);\r\n\t},\r\n\r\n\tclearLayers: function () {\r\n\t\tthis.eachLayer(this.removeLayer, this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tinvoke: function (methodName) {\r\n\t\tvar args = Array.prototype.slice.call(arguments, 1),\r\n\t\t    i, layer;\r\n\r\n\t\tfor (i in this._layers) {\r\n\t\t\tlayer = this._layers[i];\r\n\r\n\t\t\tif (layer[methodName]) {\r\n\t\t\t\tlayer[methodName].apply(layer, args);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tthis._map = map;\r\n\t\tthis.eachLayer(map.addLayer, map);\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tthis.eachLayer(map.removeLayer, map);\r\n\t\tthis._map = null;\r\n\t},\r\n\r\n\taddTo: function (map) {\r\n\t\tmap.addLayer(this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\teachLayer: function (method, context) {\r\n\t\tfor (var i in this._layers) {\r\n\t\t\tmethod.call(context, this._layers[i]);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tgetLayer: function (id) {\r\n\t\treturn this._layers[id];\r\n\t},\r\n\r\n\tgetLayers: function () {\r\n\t\tvar layers = [];\r\n\r\n\t\tfor (var i in this._layers) {\r\n\t\t\tlayers.push(this._layers[i]);\r\n\t\t}\r\n\t\treturn layers;\r\n\t},\r\n\r\n\tsetZIndex: function (zIndex) {\r\n\t\treturn this.invoke('setZIndex', zIndex);\r\n\t},\r\n\r\n\tgetLayerId: function (layer) {\r\n\t\treturn L.stamp(layer);\r\n\t}\r\n});\r\n\r\nL.layerGroup = function (layers) {\r\n\treturn new L.LayerGroup(layers);\r\n};\r\n\n\n/*\r\n * L.FeatureGroup extends L.LayerGroup by introducing mouse events and additional methods\r\n * shared between a group of interactive layers (like vectors or markers).\r\n */\r\n\r\nL.FeatureGroup = L.LayerGroup.extend({\r\n\tincludes: L.Mixin.Events,\r\n\r\n\tstatics: {\r\n\t\tEVENTS: 'click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose'\r\n\t},\r\n\r\n\taddLayer: function (layer) {\r\n\t\tif (this.hasLayer(layer)) {\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tif ('on' in layer) {\r\n\t\t\tlayer.on(L.FeatureGroup.EVENTS, this._propagateEvent, this);\r\n\t\t}\r\n\r\n\t\tL.LayerGroup.prototype.addLayer.call(this, layer);\r\n\r\n\t\tif (this._popupContent && layer.bindPopup) {\r\n\t\t\tlayer.bindPopup(this._popupContent, this._popupOptions);\r\n\t\t}\r\n\r\n\t\treturn this.fire('layeradd', {layer: layer});\r\n\t},\r\n\r\n\tremoveLayer: function (layer) {\r\n\t\tif (!this.hasLayer(layer)) {\r\n\t\t\treturn this;\r\n\t\t}\r\n\t\tif (layer in this._layers) {\r\n\t\t\tlayer = this._layers[layer];\r\n\t\t}\r\n\r\n\t\tif ('off' in layer) {\r\n\t\t\tlayer.off(L.FeatureGroup.EVENTS, this._propagateEvent, this);\r\n\t\t}\r\n\r\n\t\tL.LayerGroup.prototype.removeLayer.call(this, layer);\r\n\r\n\t\tif (this._popupContent) {\r\n\t\t\tthis.invoke('unbindPopup');\r\n\t\t}\r\n\r\n\t\treturn this.fire('layerremove', {layer: layer});\r\n\t},\r\n\r\n\tbindPopup: function (content, options) {\r\n\t\tthis._popupContent = content;\r\n\t\tthis._popupOptions = options;\r\n\t\treturn this.invoke('bindPopup', content, options);\r\n\t},\r\n\r\n\topenPopup: function (latlng) {\r\n\t\t// open popup on the first layer\r\n\t\tfor (var id in this._layers) {\r\n\t\t\tthis._layers[id].openPopup(latlng);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetStyle: function (style) {\r\n\t\treturn this.invoke('setStyle', style);\r\n\t},\r\n\r\n\tbringToFront: function () {\r\n\t\treturn this.invoke('bringToFront');\r\n\t},\r\n\r\n\tbringToBack: function () {\r\n\t\treturn this.invoke('bringToBack');\r\n\t},\r\n\r\n\tgetBounds: function () {\r\n\t\tvar bounds = new L.LatLngBounds();\r\n\r\n\t\tthis.eachLayer(function (layer) {\r\n\t\t\tbounds.extend(layer instanceof L.Marker ? layer.getLatLng() : layer.getBounds());\r\n\t\t});\r\n\r\n\t\treturn bounds;\r\n\t},\r\n\r\n\t_propagateEvent: function (e) {\r\n\t\te = L.extend({\r\n\t\t\tlayer: e.target,\r\n\t\t\ttarget: this\r\n\t\t}, e);\r\n\t\tthis.fire(e.type, e);\r\n\t}\r\n});\r\n\r\nL.featureGroup = function (layers) {\r\n\treturn new L.FeatureGroup(layers);\r\n};\r\n\n\n/*\r\n * L.Path is a base class for rendering vector paths on a map. Inherited by Polyline, Circle, etc.\r\n */\r\n\r\nL.Path = L.Class.extend({\r\n\tincludes: [L.Mixin.Events],\r\n\r\n\tstatics: {\r\n\t\t// how much to extend the clip area around the map view\r\n\t\t// (relative to its size, e.g. 0.5 is half the screen in each direction)\r\n\t\t// set it so that SVG element doesn't exceed 1280px (vectors flicker on dragend if it is)\r\n\t\tCLIP_PADDING: (function () {\r\n\t\t\tvar max = L.Browser.mobile ? 1280 : 2000,\r\n\t\t\t    target = (max / Math.max(window.outerWidth, window.outerHeight) - 1) / 2;\r\n\t\t\treturn Math.max(0, Math.min(0.5, target));\r\n\t\t})()\r\n\t},\r\n\r\n\toptions: {\r\n\t\tstroke: true,\r\n\t\tcolor: '#0033ff',\r\n\t\tdashArray: null,\r\n\t\tlineCap: null,\r\n\t\tlineJoin: null,\r\n\t\tweight: 5,\r\n\t\topacity: 0.5,\r\n\r\n\t\tfill: false,\r\n\t\tfillColor: null, //same as color by default\r\n\t\tfillOpacity: 0.2,\r\n\r\n\t\tclickable: true\r\n\t},\r\n\r\n\tinitialize: function (options) {\r\n\t\tL.setOptions(this, options);\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tthis._map = map;\r\n\r\n\t\tif (!this._container) {\r\n\t\t\tthis._initElements();\r\n\t\t\tthis._initEvents();\r\n\t\t}\r\n\r\n\t\tthis.projectLatlngs();\r\n\t\tthis._updatePath();\r\n\r\n\t\tif (this._container) {\r\n\t\t\tthis._map._pathRoot.appendChild(this._container);\r\n\t\t}\r\n\r\n\t\tthis.fire('add');\r\n\r\n\t\tmap.on({\r\n\t\t\t'viewreset': this.projectLatlngs,\r\n\t\t\t'moveend': this._updatePath\r\n\t\t}, this);\r\n\t},\r\n\r\n\taddTo: function (map) {\r\n\t\tmap.addLayer(this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tmap._pathRoot.removeChild(this._container);\r\n\r\n\t\t// Need to fire remove event before we set _map to null as the event hooks might need the object\r\n\t\tthis.fire('remove');\r\n\t\tthis._map = null;\r\n\r\n\t\tif (L.Browser.vml) {\r\n\t\t\tthis._container = null;\r\n\t\t\tthis._stroke = null;\r\n\t\t\tthis._fill = null;\r\n\t\t}\r\n\r\n\t\tmap.off({\r\n\t\t\t'viewreset': this.projectLatlngs,\r\n\t\t\t'moveend': this._updatePath\r\n\t\t}, this);\r\n\t},\r\n\r\n\tprojectLatlngs: function () {\r\n\t\t// do all projection stuff here\r\n\t},\r\n\r\n\tsetStyle: function (style) {\r\n\t\tL.setOptions(this, style);\r\n\r\n\t\tif (this._container) {\r\n\t\t\tthis._updateStyle();\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tredraw: function () {\r\n\t\tif (this._map) {\r\n\t\t\tthis.projectLatlngs();\r\n\t\t\tthis._updatePath();\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n});\r\n\r\nL.Map.include({\r\n\t_updatePathViewport: function () {\r\n\t\tvar p = L.Path.CLIP_PADDING,\r\n\t\t    size = this.getSize(),\r\n\t\t    panePos = L.DomUtil.getPosition(this._mapPane),\r\n\t\t    min = panePos.multiplyBy(-1)._subtract(size.multiplyBy(p)._round()),\r\n\t\t    max = min.add(size.multiplyBy(1 + p * 2)._round());\r\n\r\n\t\tthis._pathViewport = new L.Bounds(min, max);\r\n\t}\r\n});\r\n\n\n/*\r\n * Extends L.Path with SVG-specific rendering code.\r\n */\r\n\r\nL.Path.SVG_NS = 'http://www.w3.org/2000/svg';\r\n\r\nL.Browser.svg = !!(document.createElementNS && document.createElementNS(L.Path.SVG_NS, 'svg').createSVGRect);\r\n\r\nL.Path = L.Path.extend({\r\n\tstatics: {\r\n\t\tSVG: L.Browser.svg\r\n\t},\r\n\r\n\tbringToFront: function () {\r\n\t\tvar root = this._map._pathRoot,\r\n\t\t    path = this._container;\r\n\r\n\t\tif (path && root.lastChild !== path) {\r\n\t\t\troot.appendChild(path);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tbringToBack: function () {\r\n\t\tvar root = this._map._pathRoot,\r\n\t\t    path = this._container,\r\n\t\t    first = root.firstChild;\r\n\r\n\t\tif (path && first !== path) {\r\n\t\t\troot.insertBefore(path, first);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tgetPathString: function () {\r\n\t\t// form path string here\r\n\t},\r\n\r\n\t_createElement: function (name) {\r\n\t\treturn document.createElementNS(L.Path.SVG_NS, name);\r\n\t},\r\n\r\n\t_initElements: function () {\r\n\t\tthis._map._initPathRoot();\r\n\t\tthis._initPath();\r\n\t\tthis._initStyle();\r\n\t},\r\n\r\n\t_initPath: function () {\r\n\t\tthis._container = this._createElement('g');\r\n\r\n\t\tthis._path = this._createElement('path');\r\n\r\n\t\tif (this.options.className) {\r\n\t\t\tL.DomUtil.addClass(this._path, this.options.className);\r\n\t\t}\r\n\r\n\t\tthis._container.appendChild(this._path);\r\n\t},\r\n\r\n\t_initStyle: function () {\r\n\t\tif (this.options.stroke) {\r\n\t\t\tthis._path.setAttribute('stroke-linejoin', 'round');\r\n\t\t\tthis._path.setAttribute('stroke-linecap', 'round');\r\n\t\t}\r\n\t\tif (this.options.fill) {\r\n\t\t\tthis._path.setAttribute('fill-rule', 'evenodd');\r\n\t\t}\r\n\t\tif (this.options.pointerEvents) {\r\n\t\t\tthis._path.setAttribute('pointer-events', this.options.pointerEvents);\r\n\t\t}\r\n\t\tif (!this.options.clickable && !this.options.pointerEvents) {\r\n\t\t\tthis._path.setAttribute('pointer-events', 'none');\r\n\t\t}\r\n\t\tthis._updateStyle();\r\n\t},\r\n\r\n\t_updateStyle: function () {\r\n\t\tif (this.options.stroke) {\r\n\t\t\tthis._path.setAttribute('stroke', this.options.color);\r\n\t\t\tthis._path.setAttribute('stroke-opacity', this.options.opacity);\r\n\t\t\tthis._path.setAttribute('stroke-width', this.options.weight);\r\n\t\t\tif (this.options.dashArray) {\r\n\t\t\t\tthis._path.setAttribute('stroke-dasharray', this.options.dashArray);\r\n\t\t\t} else {\r\n\t\t\t\tthis._path.removeAttribute('stroke-dasharray');\r\n\t\t\t}\r\n\t\t\tif (this.options.lineCap) {\r\n\t\t\t\tthis._path.setAttribute('stroke-linecap', this.options.lineCap);\r\n\t\t\t}\r\n\t\t\tif (this.options.lineJoin) {\r\n\t\t\t\tthis._path.setAttribute('stroke-linejoin', this.options.lineJoin);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis._path.setAttribute('stroke', 'none');\r\n\t\t}\r\n\t\tif (this.options.fill) {\r\n\t\t\tthis._path.setAttribute('fill', this.options.fillColor || this.options.color);\r\n\t\t\tthis._path.setAttribute('fill-opacity', this.options.fillOpacity);\r\n\t\t} else {\r\n\t\t\tthis._path.setAttribute('fill', 'none');\r\n\t\t}\r\n\t},\r\n\r\n\t_updatePath: function () {\r\n\t\tvar str = this.getPathString();\r\n\t\tif (!str) {\r\n\t\t\t// fix webkit empty string parsing bug\r\n\t\t\tstr = 'M0 0';\r\n\t\t}\r\n\t\tthis._path.setAttribute('d', str);\r\n\t},\r\n\r\n\t// TODO remove duplication with L.Map\r\n\t_initEvents: function () {\r\n\t\tif (this.options.clickable) {\r\n\t\t\tif (L.Browser.svg || !L.Browser.vml) {\r\n\t\t\t\tL.DomUtil.addClass(this._path, 'leaflet-clickable');\r\n\t\t\t}\r\n\r\n\t\t\tL.DomEvent.on(this._container, 'click', this._onMouseClick, this);\r\n\r\n\t\t\tvar events = ['dblclick', 'mousedown', 'mouseover',\r\n\t\t\t              'mouseout', 'mousemove', 'contextmenu'];\r\n\t\t\tfor (var i = 0; i < events.length; i++) {\r\n\t\t\t\tL.DomEvent.on(this._container, events[i], this._fireMouseEvent, this);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_onMouseClick: function (e) {\r\n\t\tif (this._map.dragging && this._map.dragging.moved()) { return; }\r\n\r\n\t\tthis._fireMouseEvent(e);\r\n\t},\r\n\r\n\t_fireMouseEvent: function (e) {\r\n\t\tif (!this._map || !this.hasEventListeners(e.type)) { return; }\r\n\r\n\t\tvar map = this._map,\r\n\t\t    containerPoint = map.mouseEventToContainerPoint(e),\r\n\t\t    layerPoint = map.containerPointToLayerPoint(containerPoint),\r\n\t\t    latlng = map.layerPointToLatLng(layerPoint);\r\n\r\n\t\tthis.fire(e.type, {\r\n\t\t\tlatlng: latlng,\r\n\t\t\tlayerPoint: layerPoint,\r\n\t\t\tcontainerPoint: containerPoint,\r\n\t\t\toriginalEvent: e\r\n\t\t});\r\n\r\n\t\tif (e.type === 'contextmenu') {\r\n\t\t\tL.DomEvent.preventDefault(e);\r\n\t\t}\r\n\t\tif (e.type !== 'mousemove') {\r\n\t\t\tL.DomEvent.stopPropagation(e);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nL.Map.include({\r\n\t_initPathRoot: function () {\r\n\t\tif (!this._pathRoot) {\r\n\t\t\tthis._pathRoot = L.Path.prototype._createElement('svg');\r\n\t\t\tthis._panes.overlayPane.appendChild(this._pathRoot);\r\n\r\n\t\t\tif (this.options.zoomAnimation && L.Browser.any3d) {\r\n\t\t\t\tL.DomUtil.addClass(this._pathRoot, 'leaflet-zoom-animated');\r\n\r\n\t\t\t\tthis.on({\r\n\t\t\t\t\t'zoomanim': this._animatePathZoom,\r\n\t\t\t\t\t'zoomend': this._endPathZoom\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tL.DomUtil.addClass(this._pathRoot, 'leaflet-zoom-hide');\r\n\t\t\t}\r\n\r\n\t\t\tthis.on('moveend', this._updateSvgViewport);\r\n\t\t\tthis._updateSvgViewport();\r\n\t\t}\r\n\t},\r\n\r\n\t_animatePathZoom: function (e) {\r\n\t\tvar scale = this.getZoomScale(e.zoom),\r\n\t\t    offset = this._getCenterOffset(e.center)._multiplyBy(-scale)._add(this._pathViewport.min);\r\n\r\n\t\tthis._pathRoot.style[L.DomUtil.TRANSFORM] =\r\n\t\t        L.DomUtil.getTranslateString(offset) + ' scale(' + scale + ') ';\r\n\r\n\t\tthis._pathZooming = true;\r\n\t},\r\n\r\n\t_endPathZoom: function () {\r\n\t\tthis._pathZooming = false;\r\n\t},\r\n\r\n\t_updateSvgViewport: function () {\r\n\r\n\t\tif (this._pathZooming) {\r\n\t\t\t// Do not update SVGs while a zoom animation is going on otherwise the animation will break.\r\n\t\t\t// When the zoom animation ends we will be updated again anyway\r\n\t\t\t// This fixes the case where you do a momentum move and zoom while the move is still ongoing.\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis._updatePathViewport();\r\n\r\n\t\tvar vp = this._pathViewport,\r\n\t\t    min = vp.min,\r\n\t\t    max = vp.max,\r\n\t\t    width = max.x - min.x,\r\n\t\t    height = max.y - min.y,\r\n\t\t    root = this._pathRoot,\r\n\t\t    pane = this._panes.overlayPane;\r\n\r\n\t\t// Hack to make flicker on drag end on mobile webkit less irritating\r\n\t\tif (L.Browser.mobileWebkit) {\r\n\t\t\tpane.removeChild(root);\r\n\t\t}\r\n\r\n\t\tL.DomUtil.setPosition(root, min);\r\n\t\troot.setAttribute('width', width);\r\n\t\troot.setAttribute('height', height);\r\n\t\troot.setAttribute('viewBox', [min.x, min.y, width, height].join(' '));\r\n\r\n\t\tif (L.Browser.mobileWebkit) {\r\n\t\t\tpane.appendChild(root);\r\n\t\t}\r\n\t}\r\n});\r\n\n\n/*\r\n * Popup extension to L.Path (polylines, polygons, circles), adding popup-related methods.\r\n */\r\n\r\nL.Path.include({\r\n\r\n\tbindPopup: function (content, options) {\r\n\r\n\t\tif (content instanceof L.Popup) {\r\n\t\t\tthis._popup = content;\r\n\t\t} else {\r\n\t\t\tif (!this._popup || options) {\r\n\t\t\t\tthis._popup = new L.Popup(options, this);\r\n\t\t\t}\r\n\t\t\tthis._popup.setContent(content);\r\n\t\t}\r\n\r\n\t\tif (!this._popupHandlersAdded) {\r\n\t\t\tthis\r\n\t\t\t    .on('click', this._openPopup, this)\r\n\t\t\t    .on('remove', this.closePopup, this);\r\n\r\n\t\t\tthis._popupHandlersAdded = true;\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tunbindPopup: function () {\r\n\t\tif (this._popup) {\r\n\t\t\tthis._popup = null;\r\n\t\t\tthis\r\n\t\t\t    .off('click', this._openPopup)\r\n\t\t\t    .off('remove', this.closePopup);\r\n\r\n\t\t\tthis._popupHandlersAdded = false;\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\topenPopup: function (latlng) {\r\n\r\n\t\tif (this._popup) {\r\n\t\t\t// open the popup from one of the path's points if not specified\r\n\t\t\tlatlng = latlng || this._latlng ||\r\n\t\t\t         this._latlngs[Math.floor(this._latlngs.length / 2)];\r\n\r\n\t\t\tthis._openPopup({latlng: latlng});\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tclosePopup: function () {\r\n\t\tif (this._popup) {\r\n\t\t\tthis._popup._close();\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_openPopup: function (e) {\r\n\t\tthis._popup.setLatLng(e.latlng);\r\n\t\tthis._map.openPopup(this._popup);\r\n\t}\r\n});\r\n\n\n/*\r\n * Vector rendering for IE6-8 through VML.\r\n * Thanks to Dmitry Baranovsky and his Raphael library for inspiration!\r\n */\r\n\r\nL.Browser.vml = !L.Browser.svg && (function () {\r\n\ttry {\r\n\t\tvar div = document.createElement('div');\r\n\t\tdiv.innerHTML = '<v:shape adj=\"1\"/>';\r\n\r\n\t\tvar shape = div.firstChild;\r\n\t\tshape.style.behavior = 'url(#default#VML)';\r\n\r\n\t\treturn shape && (typeof shape.adj === 'object');\r\n\r\n\t} catch (e) {\r\n\t\treturn false;\r\n\t}\r\n}());\r\n\r\nL.Path = L.Browser.svg || !L.Browser.vml ? L.Path : L.Path.extend({\r\n\tstatics: {\r\n\t\tVML: true,\r\n\t\tCLIP_PADDING: 0.02\r\n\t},\r\n\r\n\t_createElement: (function () {\r\n\t\ttry {\r\n\t\t\tdocument.namespaces.add('lvml', 'urn:schemas-microsoft-com:vml');\r\n\t\t\treturn function (name) {\r\n\t\t\t\treturn document.createElement('<lvml:' + name + ' class=\"lvml\">');\r\n\t\t\t};\r\n\t\t} catch (e) {\r\n\t\t\treturn function (name) {\r\n\t\t\t\treturn document.createElement(\r\n\t\t\t\t        '<' + name + ' xmlns=\"urn:schemas-microsoft.com:vml\" class=\"lvml\">');\r\n\t\t\t};\r\n\t\t}\r\n\t}()),\r\n\r\n\t_initPath: function () {\r\n\t\tvar container = this._container = this._createElement('shape');\r\n\r\n\t\tL.DomUtil.addClass(container, 'leaflet-vml-shape' +\r\n\t\t\t(this.options.className ? ' ' + this.options.className : ''));\r\n\r\n\t\tif (this.options.clickable) {\r\n\t\t\tL.DomUtil.addClass(container, 'leaflet-clickable');\r\n\t\t}\r\n\r\n\t\tcontainer.coordsize = '1 1';\r\n\r\n\t\tthis._path = this._createElement('path');\r\n\t\tcontainer.appendChild(this._path);\r\n\r\n\t\tthis._map._pathRoot.appendChild(container);\r\n\t},\r\n\r\n\t_initStyle: function () {\r\n\t\tthis._updateStyle();\r\n\t},\r\n\r\n\t_updateStyle: function () {\r\n\t\tvar stroke = this._stroke,\r\n\t\t    fill = this._fill,\r\n\t\t    options = this.options,\r\n\t\t    container = this._container;\r\n\r\n\t\tcontainer.stroked = options.stroke;\r\n\t\tcontainer.filled = options.fill;\r\n\r\n\t\tif (options.stroke) {\r\n\t\t\tif (!stroke) {\r\n\t\t\t\tstroke = this._stroke = this._createElement('stroke');\r\n\t\t\t\tstroke.endcap = 'round';\r\n\t\t\t\tcontainer.appendChild(stroke);\r\n\t\t\t}\r\n\t\t\tstroke.weight = options.weight + 'px';\r\n\t\t\tstroke.color = options.color;\r\n\t\t\tstroke.opacity = options.opacity;\r\n\r\n\t\t\tif (options.dashArray) {\r\n\t\t\t\tstroke.dashStyle = L.Util.isArray(options.dashArray) ?\r\n\t\t\t\t    options.dashArray.join(' ') :\r\n\t\t\t\t    options.dashArray.replace(/( *, *)/g, ' ');\r\n\t\t\t} else {\r\n\t\t\t\tstroke.dashStyle = '';\r\n\t\t\t}\r\n\t\t\tif (options.lineCap) {\r\n\t\t\t\tstroke.endcap = options.lineCap.replace('butt', 'flat');\r\n\t\t\t}\r\n\t\t\tif (options.lineJoin) {\r\n\t\t\t\tstroke.joinstyle = options.lineJoin;\r\n\t\t\t}\r\n\r\n\t\t} else if (stroke) {\r\n\t\t\tcontainer.removeChild(stroke);\r\n\t\t\tthis._stroke = null;\r\n\t\t}\r\n\r\n\t\tif (options.fill) {\r\n\t\t\tif (!fill) {\r\n\t\t\t\tfill = this._fill = this._createElement('fill');\r\n\t\t\t\tcontainer.appendChild(fill);\r\n\t\t\t}\r\n\t\t\tfill.color = options.fillColor || options.color;\r\n\t\t\tfill.opacity = options.fillOpacity;\r\n\r\n\t\t} else if (fill) {\r\n\t\t\tcontainer.removeChild(fill);\r\n\t\t\tthis._fill = null;\r\n\t\t}\r\n\t},\r\n\r\n\t_updatePath: function () {\r\n\t\tvar style = this._container.style;\r\n\r\n\t\tstyle.display = 'none';\r\n\t\tthis._path.v = this.getPathString() + ' '; // the space fixes IE empty path string bug\r\n\t\tstyle.display = '';\r\n\t}\r\n});\r\n\r\nL.Map.include(L.Browser.svg || !L.Browser.vml ? {} : {\r\n\t_initPathRoot: function () {\r\n\t\tif (this._pathRoot) { return; }\r\n\r\n\t\tvar root = this._pathRoot = document.createElement('div');\r\n\t\troot.className = 'leaflet-vml-container';\r\n\t\tthis._panes.overlayPane.appendChild(root);\r\n\r\n\t\tthis.on('moveend', this._updatePathViewport);\r\n\t\tthis._updatePathViewport();\r\n\t}\r\n});\r\n\n\n/*\r\n * Vector rendering for all browsers that support canvas.\r\n */\r\n\r\nL.Browser.canvas = (function () {\r\n\treturn !!document.createElement('canvas').getContext;\r\n}());\r\n\r\nL.Path = (L.Path.SVG && !window.L_PREFER_CANVAS) || !L.Browser.canvas ? L.Path : L.Path.extend({\r\n\tstatics: {\r\n\t\t//CLIP_PADDING: 0.02, // not sure if there's a need to set it to a small value\r\n\t\tCANVAS: true,\r\n\t\tSVG: false\r\n\t},\r\n\r\n\tredraw: function () {\r\n\t\tif (this._map) {\r\n\t\t\tthis.projectLatlngs();\r\n\t\t\tthis._requestUpdate();\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetStyle: function (style) {\r\n\t\tL.setOptions(this, style);\r\n\r\n\t\tif (this._map) {\r\n\t\t\tthis._updateStyle();\r\n\t\t\tthis._requestUpdate();\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tmap\r\n\t\t    .off('viewreset', this.projectLatlngs, this)\r\n\t\t    .off('moveend', this._updatePath, this);\r\n\r\n\t\tif (this.options.clickable) {\r\n\t\t\tthis._map.off('click', this._onClick, this);\r\n\t\t\tthis._map.off('mousemove', this._onMouseMove, this);\r\n\t\t}\r\n\r\n\t\tthis._requestUpdate();\r\n\t\t\r\n\t\tthis.fire('remove');\r\n\t\tthis._map = null;\r\n\t},\r\n\r\n\t_requestUpdate: function () {\r\n\t\tif (this._map && !L.Path._updateRequest) {\r\n\t\t\tL.Path._updateRequest = L.Util.requestAnimFrame(this._fireMapMoveEnd, this._map);\r\n\t\t}\r\n\t},\r\n\r\n\t_fireMapMoveEnd: function () {\r\n\t\tL.Path._updateRequest = null;\r\n\t\tthis.fire('moveend');\r\n\t},\r\n\r\n\t_initElements: function () {\r\n\t\tthis._map._initPathRoot();\r\n\t\tthis._ctx = this._map._canvasCtx;\r\n\t},\r\n\r\n\t_updateStyle: function () {\r\n\t\tvar options = this.options;\r\n\r\n\t\tif (options.stroke) {\r\n\t\t\tthis._ctx.lineWidth = options.weight;\r\n\t\t\tthis._ctx.strokeStyle = options.color;\r\n\t\t}\r\n\t\tif (options.fill) {\r\n\t\t\tthis._ctx.fillStyle = options.fillColor || options.color;\r\n\t\t}\r\n\r\n\t\tif (options.lineCap) {\r\n\t\t\tthis._ctx.lineCap = options.lineCap;\r\n\t\t}\r\n\t\tif (options.lineJoin) {\r\n\t\t\tthis._ctx.lineJoin = options.lineJoin;\r\n\t\t}\r\n\t},\r\n\r\n\t_drawPath: function () {\r\n\t\tvar i, j, len, len2, point, drawMethod;\r\n\r\n\t\tthis._ctx.beginPath();\r\n\r\n\t\tfor (i = 0, len = this._parts.length; i < len; i++) {\r\n\t\t\tfor (j = 0, len2 = this._parts[i].length; j < len2; j++) {\r\n\t\t\t\tpoint = this._parts[i][j];\r\n\t\t\t\tdrawMethod = (j === 0 ? 'move' : 'line') + 'To';\r\n\r\n\t\t\t\tthis._ctx[drawMethod](point.x, point.y);\r\n\t\t\t}\r\n\t\t\t// TODO refactor ugly hack\r\n\t\t\tif (this instanceof L.Polygon) {\r\n\t\t\t\tthis._ctx.closePath();\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_checkIfEmpty: function () {\r\n\t\treturn !this._parts.length;\r\n\t},\r\n\r\n\t_updatePath: function () {\r\n\t\tif (this._checkIfEmpty()) { return; }\r\n\r\n\t\tvar ctx = this._ctx,\r\n\t\t    options = this.options;\r\n\r\n\t\tthis._drawPath();\r\n\t\tctx.save();\r\n\t\tthis._updateStyle();\r\n\r\n\t\tif (options.fill) {\r\n\t\t\tctx.globalAlpha = options.fillOpacity;\r\n\t\t\tctx.fill(options.fillRule || 'evenodd');\r\n\t\t}\r\n\r\n\t\tif (options.stroke) {\r\n\t\t\tctx.globalAlpha = options.opacity;\r\n\t\t\tctx.stroke();\r\n\t\t}\r\n\r\n\t\tctx.restore();\r\n\r\n\t\t// TODO optimization: 1 fill/stroke for all features with equal style instead of 1 for each feature\r\n\t},\r\n\r\n\t_initEvents: function () {\r\n\t\tif (this.options.clickable) {\r\n\t\t\tthis._map.on('mousemove', this._onMouseMove, this);\r\n\t\t\tthis._map.on('click dblclick contextmenu', this._fireMouseEvent, this);\r\n\t\t}\r\n\t},\r\n\r\n\t_fireMouseEvent: function (e) {\r\n\t\tif (this._containsPoint(e.layerPoint)) {\r\n\t\t\tthis.fire(e.type, e);\r\n\t\t}\r\n\t},\r\n\r\n\t_onMouseMove: function (e) {\r\n\t\tif (!this._map || this._map._animatingZoom) { return; }\r\n\r\n\t\t// TODO don't do on each move\r\n\t\tif (this._containsPoint(e.layerPoint)) {\r\n\t\t\tthis._ctx.canvas.style.cursor = 'pointer';\r\n\t\t\tthis._mouseInside = true;\r\n\t\t\tthis.fire('mouseover', e);\r\n\r\n\t\t} else if (this._mouseInside) {\r\n\t\t\tthis._ctx.canvas.style.cursor = '';\r\n\t\t\tthis._mouseInside = false;\r\n\t\t\tthis.fire('mouseout', e);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nL.Map.include((L.Path.SVG && !window.L_PREFER_CANVAS) || !L.Browser.canvas ? {} : {\r\n\t_initPathRoot: function () {\r\n\t\tvar root = this._pathRoot,\r\n\t\t    ctx;\r\n\r\n\t\tif (!root) {\r\n\t\t\troot = this._pathRoot = document.createElement('canvas');\r\n\t\t\troot.style.position = 'absolute';\r\n\t\t\tctx = this._canvasCtx = root.getContext('2d');\r\n\r\n\t\t\tctx.lineCap = 'round';\r\n\t\t\tctx.lineJoin = 'round';\r\n\r\n\t\t\tthis._panes.overlayPane.appendChild(root);\r\n\r\n\t\t\tif (this.options.zoomAnimation) {\r\n\t\t\t\tthis._pathRoot.className = 'leaflet-zoom-animated';\r\n\t\t\t\tthis.on('zoomanim', this._animatePathZoom);\r\n\t\t\t\tthis.on('zoomend', this._endPathZoom);\r\n\t\t\t}\r\n\t\t\tthis.on('moveend', this._updateCanvasViewport);\r\n\t\t\tthis._updateCanvasViewport();\r\n\t\t}\r\n\t},\r\n\r\n\t_updateCanvasViewport: function () {\r\n\t\t// don't redraw while zooming. See _updateSvgViewport for more details\r\n\t\tif (this._pathZooming) { return; }\r\n\t\tthis._updatePathViewport();\r\n\r\n\t\tvar vp = this._pathViewport,\r\n\t\t    min = vp.min,\r\n\t\t    size = vp.max.subtract(min),\r\n\t\t    root = this._pathRoot;\r\n\r\n\t\t//TODO check if this works properly on mobile webkit\r\n\t\tL.DomUtil.setPosition(root, min);\r\n\t\troot.width = size.x;\r\n\t\troot.height = size.y;\r\n\t\troot.getContext('2d').translate(-min.x, -min.y);\r\n\t}\r\n});\r\n\n\n/*\r\n * L.LineUtil contains different utility functions for line segments\r\n * and polylines (clipping, simplification, distances, etc.)\r\n */\r\n\r\n/*jshint bitwise:false */ // allow bitwise operations for this file\r\n\r\nL.LineUtil = {\r\n\r\n\t// Simplify polyline with vertex reduction and Douglas-Peucker simplification.\r\n\t// Improves rendering performance dramatically by lessening the number of points to draw.\r\n\r\n\tsimplify: function (/*Point[]*/ points, /*Number*/ tolerance) {\r\n\t\tif (!tolerance || !points.length) {\r\n\t\t\treturn points.slice();\r\n\t\t}\r\n\r\n\t\tvar sqTolerance = tolerance * tolerance;\r\n\r\n\t\t// stage 1: vertex reduction\r\n\t\tpoints = this._reducePoints(points, sqTolerance);\r\n\r\n\t\t// stage 2: Douglas-Peucker simplification\r\n\t\tpoints = this._simplifyDP(points, sqTolerance);\r\n\r\n\t\treturn points;\r\n\t},\r\n\r\n\t// distance from a point to a segment between two points\r\n\tpointToSegmentDistance:  function (/*Point*/ p, /*Point*/ p1, /*Point*/ p2) {\r\n\t\treturn Math.sqrt(this._sqClosestPointOnSegment(p, p1, p2, true));\r\n\t},\r\n\r\n\tclosestPointOnSegment: function (/*Point*/ p, /*Point*/ p1, /*Point*/ p2) {\r\n\t\treturn this._sqClosestPointOnSegment(p, p1, p2);\r\n\t},\r\n\r\n\t// Douglas-Peucker simplification, see http://en.wikipedia.org/wiki/Douglas-Peucker_algorithm\r\n\t_simplifyDP: function (points, sqTolerance) {\r\n\r\n\t\tvar len = points.length,\r\n\t\t    ArrayConstructor = typeof Uint8Array !== undefined + '' ? Uint8Array : Array,\r\n\t\t    markers = new ArrayConstructor(len);\r\n\r\n\t\tmarkers[0] = markers[len - 1] = 1;\r\n\r\n\t\tthis._simplifyDPStep(points, markers, sqTolerance, 0, len - 1);\r\n\r\n\t\tvar i,\r\n\t\t    newPoints = [];\r\n\r\n\t\tfor (i = 0; i < len; i++) {\r\n\t\t\tif (markers[i]) {\r\n\t\t\t\tnewPoints.push(points[i]);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn newPoints;\r\n\t},\r\n\r\n\t_simplifyDPStep: function (points, markers, sqTolerance, first, last) {\r\n\r\n\t\tvar maxSqDist = 0,\r\n\t\t    index, i, sqDist;\r\n\r\n\t\tfor (i = first + 1; i <= last - 1; i++) {\r\n\t\t\tsqDist = this._sqClosestPointOnSegment(points[i], points[first], points[last], true);\r\n\r\n\t\t\tif (sqDist > maxSqDist) {\r\n\t\t\t\tindex = i;\r\n\t\t\t\tmaxSqDist = sqDist;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (maxSqDist > sqTolerance) {\r\n\t\t\tmarkers[index] = 1;\r\n\r\n\t\t\tthis._simplifyDPStep(points, markers, sqTolerance, first, index);\r\n\t\t\tthis._simplifyDPStep(points, markers, sqTolerance, index, last);\r\n\t\t}\r\n\t},\r\n\r\n\t// reduce points that are too close to each other to a single point\r\n\t_reducePoints: function (points, sqTolerance) {\r\n\t\tvar reducedPoints = [points[0]];\r\n\r\n\t\tfor (var i = 1, prev = 0, len = points.length; i < len; i++) {\r\n\t\t\tif (this._sqDist(points[i], points[prev]) > sqTolerance) {\r\n\t\t\t\treducedPoints.push(points[i]);\r\n\t\t\t\tprev = i;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (prev < len - 1) {\r\n\t\t\treducedPoints.push(points[len - 1]);\r\n\t\t}\r\n\t\treturn reducedPoints;\r\n\t},\r\n\r\n\t// Cohen-Sutherland line clipping algorithm.\r\n\t// Used to avoid rendering parts of a polyline that are not currently visible.\r\n\r\n\tclipSegment: function (a, b, bounds, useLastCode) {\r\n\t\tvar codeA = useLastCode ? this._lastCode : this._getBitCode(a, bounds),\r\n\t\t    codeB = this._getBitCode(b, bounds),\r\n\r\n\t\t    codeOut, p, newCode;\r\n\r\n\t\t// save 2nd code to avoid calculating it on the next segment\r\n\t\tthis._lastCode = codeB;\r\n\r\n\t\twhile (true) {\r\n\t\t\t// if a,b is inside the clip window (trivial accept)\r\n\t\t\tif (!(codeA | codeB)) {\r\n\t\t\t\treturn [a, b];\r\n\t\t\t// if a,b is outside the clip window (trivial reject)\r\n\t\t\t} else if (codeA & codeB) {\r\n\t\t\t\treturn false;\r\n\t\t\t// other cases\r\n\t\t\t} else {\r\n\t\t\t\tcodeOut = codeA || codeB;\r\n\t\t\t\tp = this._getEdgeIntersection(a, b, codeOut, bounds);\r\n\t\t\t\tnewCode = this._getBitCode(p, bounds);\r\n\r\n\t\t\t\tif (codeOut === codeA) {\r\n\t\t\t\t\ta = p;\r\n\t\t\t\t\tcodeA = newCode;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tb = p;\r\n\t\t\t\t\tcodeB = newCode;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_getEdgeIntersection: function (a, b, code, bounds) {\r\n\t\tvar dx = b.x - a.x,\r\n\t\t    dy = b.y - a.y,\r\n\t\t    min = bounds.min,\r\n\t\t    max = bounds.max;\r\n\r\n\t\tif (code & 8) { // top\r\n\t\t\treturn new L.Point(a.x + dx * (max.y - a.y) / dy, max.y);\r\n\t\t} else if (code & 4) { // bottom\r\n\t\t\treturn new L.Point(a.x + dx * (min.y - a.y) / dy, min.y);\r\n\t\t} else if (code & 2) { // right\r\n\t\t\treturn new L.Point(max.x, a.y + dy * (max.x - a.x) / dx);\r\n\t\t} else if (code & 1) { // left\r\n\t\t\treturn new L.Point(min.x, a.y + dy * (min.x - a.x) / dx);\r\n\t\t}\r\n\t},\r\n\r\n\t_getBitCode: function (/*Point*/ p, bounds) {\r\n\t\tvar code = 0;\r\n\r\n\t\tif (p.x < bounds.min.x) { // left\r\n\t\t\tcode |= 1;\r\n\t\t} else if (p.x > bounds.max.x) { // right\r\n\t\t\tcode |= 2;\r\n\t\t}\r\n\t\tif (p.y < bounds.min.y) { // bottom\r\n\t\t\tcode |= 4;\r\n\t\t} else if (p.y > bounds.max.y) { // top\r\n\t\t\tcode |= 8;\r\n\t\t}\r\n\r\n\t\treturn code;\r\n\t},\r\n\r\n\t// square distance (to avoid unnecessary Math.sqrt calls)\r\n\t_sqDist: function (p1, p2) {\r\n\t\tvar dx = p2.x - p1.x,\r\n\t\t    dy = p2.y - p1.y;\r\n\t\treturn dx * dx + dy * dy;\r\n\t},\r\n\r\n\t// return closest point on segment or distance to that point\r\n\t_sqClosestPointOnSegment: function (p, p1, p2, sqDist) {\r\n\t\tvar x = p1.x,\r\n\t\t    y = p1.y,\r\n\t\t    dx = p2.x - x,\r\n\t\t    dy = p2.y - y,\r\n\t\t    dot = dx * dx + dy * dy,\r\n\t\t    t;\r\n\r\n\t\tif (dot > 0) {\r\n\t\t\tt = ((p.x - x) * dx + (p.y - y) * dy) / dot;\r\n\r\n\t\t\tif (t > 1) {\r\n\t\t\t\tx = p2.x;\r\n\t\t\t\ty = p2.y;\r\n\t\t\t} else if (t > 0) {\r\n\t\t\t\tx += dx * t;\r\n\t\t\t\ty += dy * t;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tdx = p.x - x;\r\n\t\tdy = p.y - y;\r\n\r\n\t\treturn sqDist ? dx * dx + dy * dy : new L.Point(x, y);\r\n\t}\r\n};\r\n\n\n/*\r\n * L.Polyline is used to display polylines on a map.\r\n */\r\n\r\nL.Polyline = L.Path.extend({\r\n\tinitialize: function (latlngs, options) {\r\n\t\tL.Path.prototype.initialize.call(this, options);\r\n\r\n\t\tthis._latlngs = this._convertLatLngs(latlngs);\r\n\t},\r\n\r\n\toptions: {\r\n\t\t// how much to simplify the polyline on each zoom level\r\n\t\t// more = better performance and smoother look, less = more accurate\r\n\t\tsmoothFactor: 1.0,\r\n\t\tnoClip: false\r\n\t},\r\n\r\n\tprojectLatlngs: function () {\r\n\t\tthis._originalPoints = [];\r\n\r\n\t\tfor (var i = 0, len = this._latlngs.length; i < len; i++) {\r\n\t\t\tthis._originalPoints[i] = this._map.latLngToLayerPoint(this._latlngs[i]);\r\n\t\t}\r\n\t},\r\n\r\n\tgetPathString: function () {\r\n\t\tfor (var i = 0, len = this._parts.length, str = ''; i < len; i++) {\r\n\t\t\tstr += this._getPathPartStr(this._parts[i]);\r\n\t\t}\r\n\t\treturn str;\r\n\t},\r\n\r\n\tgetLatLngs: function () {\r\n\t\treturn this._latlngs;\r\n\t},\r\n\r\n\tsetLatLngs: function (latlngs) {\r\n\t\tthis._latlngs = this._convertLatLngs(latlngs);\r\n\t\treturn this.redraw();\r\n\t},\r\n\r\n\taddLatLng: function (latlng) {\r\n\t\tthis._latlngs.push(L.latLng(latlng));\r\n\t\treturn this.redraw();\r\n\t},\r\n\r\n\tspliceLatLngs: function () { // (Number index, Number howMany)\r\n\t\tvar removed = [].splice.apply(this._latlngs, arguments);\r\n\t\tthis._convertLatLngs(this._latlngs, true);\r\n\t\tthis.redraw();\r\n\t\treturn removed;\r\n\t},\r\n\r\n\tclosestLayerPoint: function (p) {\r\n\t\tvar minDistance = Infinity, parts = this._parts, p1, p2, minPoint = null;\r\n\r\n\t\tfor (var j = 0, jLen = parts.length; j < jLen; j++) {\r\n\t\t\tvar points = parts[j];\r\n\t\t\tfor (var i = 1, len = points.length; i < len; i++) {\r\n\t\t\t\tp1 = points[i - 1];\r\n\t\t\t\tp2 = points[i];\r\n\t\t\t\tvar sqDist = L.LineUtil._sqClosestPointOnSegment(p, p1, p2, true);\r\n\t\t\t\tif (sqDist < minDistance) {\r\n\t\t\t\t\tminDistance = sqDist;\r\n\t\t\t\t\tminPoint = L.LineUtil._sqClosestPointOnSegment(p, p1, p2);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (minPoint) {\r\n\t\t\tminPoint.distance = Math.sqrt(minDistance);\r\n\t\t}\r\n\t\treturn minPoint;\r\n\t},\r\n\r\n\tgetBounds: function () {\r\n\t\treturn new L.LatLngBounds(this.getLatLngs());\r\n\t},\r\n\r\n\t_convertLatLngs: function (latlngs, overwrite) {\r\n\t\tvar i, len, target = overwrite ? latlngs : [];\r\n\r\n\t\tfor (i = 0, len = latlngs.length; i < len; i++) {\r\n\t\t\tif (L.Util.isArray(latlngs[i]) && typeof latlngs[i][0] !== 'number') {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\ttarget[i] = L.latLng(latlngs[i]);\r\n\t\t}\r\n\t\treturn target;\r\n\t},\r\n\r\n\t_initEvents: function () {\r\n\t\tL.Path.prototype._initEvents.call(this);\r\n\t},\r\n\r\n\t_getPathPartStr: function (points) {\r\n\t\tvar round = L.Path.VML;\r\n\r\n\t\tfor (var j = 0, len2 = points.length, str = '', p; j < len2; j++) {\r\n\t\t\tp = points[j];\r\n\t\t\tif (round) {\r\n\t\t\t\tp._round();\r\n\t\t\t}\r\n\t\t\tstr += (j ? 'L' : 'M') + p.x + ' ' + p.y;\r\n\t\t}\r\n\t\treturn str;\r\n\t},\r\n\r\n\t_clipPoints: function () {\r\n\t\tvar points = this._originalPoints,\r\n\t\t    len = points.length,\r\n\t\t    i, k, segment;\r\n\r\n\t\tif (this.options.noClip) {\r\n\t\t\tthis._parts = [points];\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis._parts = [];\r\n\r\n\t\tvar parts = this._parts,\r\n\t\t    vp = this._map._pathViewport,\r\n\t\t    lu = L.LineUtil;\r\n\r\n\t\tfor (i = 0, k = 0; i < len - 1; i++) {\r\n\t\t\tsegment = lu.clipSegment(points[i], points[i + 1], vp, i);\r\n\t\t\tif (!segment) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tparts[k] = parts[k] || [];\r\n\t\t\tparts[k].push(segment[0]);\r\n\r\n\t\t\t// if segment goes out of screen, or it's the last one, it's the end of the line part\r\n\t\t\tif ((segment[1] !== points[i + 1]) || (i === len - 2)) {\r\n\t\t\t\tparts[k].push(segment[1]);\r\n\t\t\t\tk++;\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t// simplify each clipped part of the polyline\r\n\t_simplifyPoints: function () {\r\n\t\tvar parts = this._parts,\r\n\t\t    lu = L.LineUtil;\r\n\r\n\t\tfor (var i = 0, len = parts.length; i < len; i++) {\r\n\t\t\tparts[i] = lu.simplify(parts[i], this.options.smoothFactor);\r\n\t\t}\r\n\t},\r\n\r\n\t_updatePath: function () {\r\n\t\tif (!this._map) { return; }\r\n\r\n\t\tthis._clipPoints();\r\n\t\tthis._simplifyPoints();\r\n\r\n\t\tL.Path.prototype._updatePath.call(this);\r\n\t}\r\n});\r\n\r\nL.polyline = function (latlngs, options) {\r\n\treturn new L.Polyline(latlngs, options);\r\n};\r\n\n\n/*\r\n * L.PolyUtil contains utility functions for polygons (clipping, etc.).\r\n */\r\n\r\n/*jshint bitwise:false */ // allow bitwise operations here\r\n\r\nL.PolyUtil = {};\r\n\r\n/*\r\n * Sutherland-Hodgeman polygon clipping algorithm.\r\n * Used to avoid rendering parts of a polygon that are not currently visible.\r\n */\r\nL.PolyUtil.clipPolygon = function (points, bounds) {\r\n\tvar clippedPoints,\r\n\t    edges = [1, 4, 2, 8],\r\n\t    i, j, k,\r\n\t    a, b,\r\n\t    len, edge, p,\r\n\t    lu = L.LineUtil;\r\n\r\n\tfor (i = 0, len = points.length; i < len; i++) {\r\n\t\tpoints[i]._code = lu._getBitCode(points[i], bounds);\r\n\t}\r\n\r\n\t// for each edge (left, bottom, right, top)\r\n\tfor (k = 0; k < 4; k++) {\r\n\t\tedge = edges[k];\r\n\t\tclippedPoints = [];\r\n\r\n\t\tfor (i = 0, len = points.length, j = len - 1; i < len; j = i++) {\r\n\t\t\ta = points[i];\r\n\t\t\tb = points[j];\r\n\r\n\t\t\t// if a is inside the clip window\r\n\t\t\tif (!(a._code & edge)) {\r\n\t\t\t\t// if b is outside the clip window (a->b goes out of screen)\r\n\t\t\t\tif (b._code & edge) {\r\n\t\t\t\t\tp = lu._getEdgeIntersection(b, a, edge, bounds);\r\n\t\t\t\t\tp._code = lu._getBitCode(p, bounds);\r\n\t\t\t\t\tclippedPoints.push(p);\r\n\t\t\t\t}\r\n\t\t\t\tclippedPoints.push(a);\r\n\r\n\t\t\t// else if b is inside the clip window (a->b enters the screen)\r\n\t\t\t} else if (!(b._code & edge)) {\r\n\t\t\t\tp = lu._getEdgeIntersection(b, a, edge, bounds);\r\n\t\t\t\tp._code = lu._getBitCode(p, bounds);\r\n\t\t\t\tclippedPoints.push(p);\r\n\t\t\t}\r\n\t\t}\r\n\t\tpoints = clippedPoints;\r\n\t}\r\n\r\n\treturn points;\r\n};\r\n\n\n/*\r\n * L.Polygon is used to display polygons on a map.\r\n */\r\n\r\nL.Polygon = L.Polyline.extend({\r\n\toptions: {\r\n\t\tfill: true\r\n\t},\r\n\r\n\tinitialize: function (latlngs, options) {\r\n\t\tL.Polyline.prototype.initialize.call(this, latlngs, options);\r\n\t\tthis._initWithHoles(latlngs);\r\n\t},\r\n\r\n\t_initWithHoles: function (latlngs) {\r\n\t\tvar i, len, hole;\r\n\t\tif (latlngs && L.Util.isArray(latlngs[0]) && (typeof latlngs[0][0] !== 'number')) {\r\n\t\t\tthis._latlngs = this._convertLatLngs(latlngs[0]);\r\n\t\t\tthis._holes = latlngs.slice(1);\r\n\r\n\t\t\tfor (i = 0, len = this._holes.length; i < len; i++) {\r\n\t\t\t\thole = this._holes[i] = this._convertLatLngs(this._holes[i]);\r\n\t\t\t\tif (hole[0].equals(hole[hole.length - 1])) {\r\n\t\t\t\t\thole.pop();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// filter out last point if its equal to the first one\r\n\t\tlatlngs = this._latlngs;\r\n\r\n\t\tif (latlngs.length >= 2 && latlngs[0].equals(latlngs[latlngs.length - 1])) {\r\n\t\t\tlatlngs.pop();\r\n\t\t}\r\n\t},\r\n\r\n\tprojectLatlngs: function () {\r\n\t\tL.Polyline.prototype.projectLatlngs.call(this);\r\n\r\n\t\t// project polygon holes points\r\n\t\t// TODO move this logic to Polyline to get rid of duplication\r\n\t\tthis._holePoints = [];\r\n\r\n\t\tif (!this._holes) { return; }\r\n\r\n\t\tvar i, j, len, len2;\r\n\r\n\t\tfor (i = 0, len = this._holes.length; i < len; i++) {\r\n\t\t\tthis._holePoints[i] = [];\r\n\r\n\t\t\tfor (j = 0, len2 = this._holes[i].length; j < len2; j++) {\r\n\t\t\t\tthis._holePoints[i][j] = this._map.latLngToLayerPoint(this._holes[i][j]);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\tsetLatLngs: function (latlngs) {\r\n\t\tif (latlngs && L.Util.isArray(latlngs[0]) && (typeof latlngs[0][0] !== 'number')) {\r\n\t\t\tthis._initWithHoles(latlngs);\r\n\t\t\treturn this.redraw();\r\n\t\t} else {\r\n\t\t\treturn L.Polyline.prototype.setLatLngs.call(this, latlngs);\r\n\t\t}\r\n\t},\r\n\r\n\t_clipPoints: function () {\r\n\t\tvar points = this._originalPoints,\r\n\t\t    newParts = [];\r\n\r\n\t\tthis._parts = [points].concat(this._holePoints);\r\n\r\n\t\tif (this.options.noClip) { return; }\r\n\r\n\t\tfor (var i = 0, len = this._parts.length; i < len; i++) {\r\n\t\t\tvar clipped = L.PolyUtil.clipPolygon(this._parts[i], this._map._pathViewport);\r\n\t\t\tif (clipped.length) {\r\n\t\t\t\tnewParts.push(clipped);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis._parts = newParts;\r\n\t},\r\n\r\n\t_getPathPartStr: function (points) {\r\n\t\tvar str = L.Polyline.prototype._getPathPartStr.call(this, points);\r\n\t\treturn str + (L.Browser.svg ? 'z' : 'x');\r\n\t}\r\n});\r\n\r\nL.polygon = function (latlngs, options) {\r\n\treturn new L.Polygon(latlngs, options);\r\n};\r\n\n\n/*\r\n * Contains L.MultiPolyline and L.MultiPolygon layers.\r\n */\r\n\r\n(function () {\r\n\tfunction createMulti(Klass) {\r\n\r\n\t\treturn L.FeatureGroup.extend({\r\n\r\n\t\t\tinitialize: function (latlngs, options) {\r\n\t\t\t\tthis._layers = {};\r\n\t\t\t\tthis._options = options;\r\n\t\t\t\tthis.setLatLngs(latlngs);\r\n\t\t\t},\r\n\r\n\t\t\tsetLatLngs: function (latlngs) {\r\n\t\t\t\tvar i = 0,\r\n\t\t\t\t    len = latlngs.length;\r\n\r\n\t\t\t\tthis.eachLayer(function (layer) {\r\n\t\t\t\t\tif (i < len) {\r\n\t\t\t\t\t\tlayer.setLatLngs(latlngs[i++]);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.removeLayer(layer);\r\n\t\t\t\t\t}\r\n\t\t\t\t}, this);\r\n\r\n\t\t\t\twhile (i < len) {\r\n\t\t\t\t\tthis.addLayer(new Klass(latlngs[i++], this._options));\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn this;\r\n\t\t\t},\r\n\r\n\t\t\tgetLatLngs: function () {\r\n\t\t\t\tvar latlngs = [];\r\n\r\n\t\t\t\tthis.eachLayer(function (layer) {\r\n\t\t\t\t\tlatlngs.push(layer.getLatLngs());\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn latlngs;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tL.MultiPolyline = createMulti(L.Polyline);\r\n\tL.MultiPolygon = createMulti(L.Polygon);\r\n\r\n\tL.multiPolyline = function (latlngs, options) {\r\n\t\treturn new L.MultiPolyline(latlngs, options);\r\n\t};\r\n\r\n\tL.multiPolygon = function (latlngs, options) {\r\n\t\treturn new L.MultiPolygon(latlngs, options);\r\n\t};\r\n}());\r\n\n\n/*\r\n * L.Rectangle extends Polygon and creates a rectangle when passed a LatLngBounds object.\r\n */\r\n\r\nL.Rectangle = L.Polygon.extend({\r\n\tinitialize: function (latLngBounds, options) {\r\n\t\tL.Polygon.prototype.initialize.call(this, this._boundsToLatLngs(latLngBounds), options);\r\n\t},\r\n\r\n\tsetBounds: function (latLngBounds) {\r\n\t\tthis.setLatLngs(this._boundsToLatLngs(latLngBounds));\r\n\t},\r\n\r\n\t_boundsToLatLngs: function (latLngBounds) {\r\n\t\tlatLngBounds = L.latLngBounds(latLngBounds);\r\n\t\treturn [\r\n\t\t\tlatLngBounds.getSouthWest(),\r\n\t\t\tlatLngBounds.getNorthWest(),\r\n\t\t\tlatLngBounds.getNorthEast(),\r\n\t\t\tlatLngBounds.getSouthEast()\r\n\t\t];\r\n\t}\r\n});\r\n\r\nL.rectangle = function (latLngBounds, options) {\r\n\treturn new L.Rectangle(latLngBounds, options);\r\n};\r\n\n\n/*\r\n * L.Circle is a circle overlay (with a certain radius in meters).\r\n */\r\n\r\nL.Circle = L.Path.extend({\r\n\tinitialize: function (latlng, radius, options) {\r\n\t\tL.Path.prototype.initialize.call(this, options);\r\n\r\n\t\tthis._latlng = L.latLng(latlng);\r\n\t\tthis._mRadius = radius;\r\n\t},\r\n\r\n\toptions: {\r\n\t\tfill: true\r\n\t},\r\n\r\n\tsetLatLng: function (latlng) {\r\n\t\tthis._latlng = L.latLng(latlng);\r\n\t\treturn this.redraw();\r\n\t},\r\n\r\n\tsetRadius: function (radius) {\r\n\t\tthis._mRadius = radius;\r\n\t\treturn this.redraw();\r\n\t},\r\n\r\n\tprojectLatlngs: function () {\r\n\t\tvar lngRadius = this._getLngRadius(),\r\n\t\t    latlng = this._latlng,\r\n\t\t    pointLeft = this._map.latLngToLayerPoint([latlng.lat, latlng.lng - lngRadius]);\r\n\r\n\t\tthis._point = this._map.latLngToLayerPoint(latlng);\r\n\t\tthis._radius = Math.max(this._point.x - pointLeft.x, 1);\r\n\t},\r\n\r\n\tgetBounds: function () {\r\n\t\tvar lngRadius = this._getLngRadius(),\r\n\t\t    latRadius = (this._mRadius / 40075017) * 360,\r\n\t\t    latlng = this._latlng;\r\n\r\n\t\treturn new L.LatLngBounds(\r\n\t\t        [latlng.lat - latRadius, latlng.lng - lngRadius],\r\n\t\t        [latlng.lat + latRadius, latlng.lng + lngRadius]);\r\n\t},\r\n\r\n\tgetLatLng: function () {\r\n\t\treturn this._latlng;\r\n\t},\r\n\r\n\tgetPathString: function () {\r\n\t\tvar p = this._point,\r\n\t\t    r = this._radius;\r\n\r\n\t\tif (this._checkIfEmpty()) {\r\n\t\t\treturn '';\r\n\t\t}\r\n\r\n\t\tif (L.Browser.svg) {\r\n\t\t\treturn 'M' + p.x + ',' + (p.y - r) +\r\n\t\t\t       'A' + r + ',' + r + ',0,1,1,' +\r\n\t\t\t       (p.x - 0.1) + ',' + (p.y - r) + ' z';\r\n\t\t} else {\r\n\t\t\tp._round();\r\n\t\t\tr = Math.round(r);\r\n\t\t\treturn 'AL ' + p.x + ',' + p.y + ' ' + r + ',' + r + ' 0,' + (65535 * 360);\r\n\t\t}\r\n\t},\r\n\r\n\tgetRadius: function () {\r\n\t\treturn this._mRadius;\r\n\t},\r\n\r\n\t// TODO Earth hardcoded, move into projection code!\r\n\r\n\t_getLatRadius: function () {\r\n\t\treturn (this._mRadius / 40075017) * 360;\r\n\t},\r\n\r\n\t_getLngRadius: function () {\r\n\t\treturn this._getLatRadius() / Math.cos(L.LatLng.DEG_TO_RAD * this._latlng.lat);\r\n\t},\r\n\r\n\t_checkIfEmpty: function () {\r\n\t\tif (!this._map) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tvar vp = this._map._pathViewport,\r\n\t\t    r = this._radius,\r\n\t\t    p = this._point;\r\n\r\n\t\treturn p.x - r > vp.max.x || p.y - r > vp.max.y ||\r\n\t\t       p.x + r < vp.min.x || p.y + r < vp.min.y;\r\n\t}\r\n});\r\n\r\nL.circle = function (latlng, radius, options) {\r\n\treturn new L.Circle(latlng, radius, options);\r\n};\r\n\n\n/*\r\n * L.CircleMarker is a circle overlay with a permanent pixel radius.\r\n */\r\n\r\nL.CircleMarker = L.Circle.extend({\r\n\toptions: {\r\n\t\tradius: 10,\r\n\t\tweight: 2\r\n\t},\r\n\r\n\tinitialize: function (latlng, options) {\r\n\t\tL.Circle.prototype.initialize.call(this, latlng, null, options);\r\n\t\tthis._radius = this.options.radius;\r\n\t},\r\n\r\n\tprojectLatlngs: function () {\r\n\t\tthis._point = this._map.latLngToLayerPoint(this._latlng);\r\n\t},\r\n\r\n\t_updateStyle : function () {\r\n\t\tL.Circle.prototype._updateStyle.call(this);\r\n\t\tthis.setRadius(this.options.radius);\r\n\t},\r\n\r\n\tsetLatLng: function (latlng) {\r\n\t\tL.Circle.prototype.setLatLng.call(this, latlng);\r\n\t\tif (this._popup && this._popup._isOpen) {\r\n\t\t\tthis._popup.setLatLng(latlng);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetRadius: function (radius) {\r\n\t\tthis.options.radius = this._radius = radius;\r\n\t\treturn this.redraw();\r\n\t},\r\n\r\n\tgetRadius: function () {\r\n\t\treturn this._radius;\r\n\t}\r\n});\r\n\r\nL.circleMarker = function (latlng, options) {\r\n\treturn new L.CircleMarker(latlng, options);\r\n};\r\n\n\n/*\r\n * Extends L.Polyline to be able to manually detect clicks on Canvas-rendered polylines.\r\n */\r\n\r\nL.Polyline.include(!L.Path.CANVAS ? {} : {\r\n\t_containsPoint: function (p, closed) {\r\n\t\tvar i, j, k, len, len2, dist, part,\r\n\t\t    w = this.options.weight / 2;\r\n\r\n\t\tif (L.Browser.touch) {\r\n\t\t\tw += 10; // polyline click tolerance on touch devices\r\n\t\t}\r\n\r\n\t\tfor (i = 0, len = this._parts.length; i < len; i++) {\r\n\t\t\tpart = this._parts[i];\r\n\t\t\tfor (j = 0, len2 = part.length, k = len2 - 1; j < len2; k = j++) {\r\n\t\t\t\tif (!closed && (j === 0)) {\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdist = L.LineUtil.pointToSegmentDistance(p, part[k], part[j]);\r\n\r\n\t\t\t\tif (dist <= w) {\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n});\r\n\n\n/*\r\n * Extends L.Polygon to be able to manually detect clicks on Canvas-rendered polygons.\r\n */\r\n\r\nL.Polygon.include(!L.Path.CANVAS ? {} : {\r\n\t_containsPoint: function (p) {\r\n\t\tvar inside = false,\r\n\t\t    part, p1, p2,\r\n\t\t    i, j, k,\r\n\t\t    len, len2;\r\n\r\n\t\t// TODO optimization: check if within bounds first\r\n\r\n\t\tif (L.Polyline.prototype._containsPoint.call(this, p, true)) {\r\n\t\t\t// click on polygon border\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// ray casting algorithm for detecting if point is in polygon\r\n\r\n\t\tfor (i = 0, len = this._parts.length; i < len; i++) {\r\n\t\t\tpart = this._parts[i];\r\n\r\n\t\t\tfor (j = 0, len2 = part.length, k = len2 - 1; j < len2; k = j++) {\r\n\t\t\t\tp1 = part[j];\r\n\t\t\t\tp2 = part[k];\r\n\r\n\t\t\t\tif (((p1.y > p.y) !== (p2.y > p.y)) &&\r\n\t\t\t\t\t\t(p.x < (p2.x - p1.x) * (p.y - p1.y) / (p2.y - p1.y) + p1.x)) {\r\n\t\t\t\t\tinside = !inside;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn inside;\r\n\t}\r\n});\r\n\n\n/*\r\n * Extends L.Circle with Canvas-specific code.\r\n */\r\n\r\nL.Circle.include(!L.Path.CANVAS ? {} : {\r\n\t_drawPath: function () {\r\n\t\tvar p = this._point;\r\n\t\tthis._ctx.beginPath();\r\n\t\tthis._ctx.arc(p.x, p.y, this._radius, 0, Math.PI * 2, false);\r\n\t},\r\n\r\n\t_containsPoint: function (p) {\r\n\t\tvar center = this._point,\r\n\t\t    w2 = this.options.stroke ? this.options.weight / 2 : 0;\r\n\r\n\t\treturn (p.distanceTo(center) <= this._radius + w2);\r\n\t}\r\n});\r\n\n\n/*\n * CircleMarker canvas specific drawing parts.\n */\n\nL.CircleMarker.include(!L.Path.CANVAS ? {} : {\n\t_updateStyle: function () {\n\t\tL.Path.prototype._updateStyle.call(this);\n\t}\n});\n\n\n/*\r\n * L.GeoJSON turns any GeoJSON data into a Leaflet layer.\r\n */\r\n\r\nL.GeoJSON = L.FeatureGroup.extend({\r\n\r\n\tinitialize: function (geojson, options) {\r\n\t\tL.setOptions(this, options);\r\n\r\n\t\tthis._layers = {};\r\n\r\n\t\tif (geojson) {\r\n\t\t\tthis.addData(geojson);\r\n\t\t}\r\n\t},\r\n\r\n\taddData: function (geojson) {\r\n\t\tvar features = L.Util.isArray(geojson) ? geojson : geojson.features,\r\n\t\t    i, len, feature;\r\n\r\n\t\tif (features) {\r\n\t\t\tfor (i = 0, len = features.length; i < len; i++) {\r\n\t\t\t\t// Only add this if geometry or geometries are set and not null\r\n\t\t\t\tfeature = features[i];\r\n\t\t\t\tif (feature.geometries || feature.geometry || feature.features || feature.coordinates) {\r\n\t\t\t\t\tthis.addData(features[i]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tvar options = this.options;\r\n\r\n\t\tif (options.filter && !options.filter(geojson)) { return; }\r\n\r\n\t\tvar layer = L.GeoJSON.geometryToLayer(geojson, options.pointToLayer, options.coordsToLatLng, options);\r\n\t\tlayer.feature = L.GeoJSON.asFeature(geojson);\r\n\r\n\t\tlayer.defaultOptions = layer.options;\r\n\t\tthis.resetStyle(layer);\r\n\r\n\t\tif (options.onEachFeature) {\r\n\t\t\toptions.onEachFeature(geojson, layer);\r\n\t\t}\r\n\r\n\t\treturn this.addLayer(layer);\r\n\t},\r\n\r\n\tresetStyle: function (layer) {\r\n\t\tvar style = this.options.style;\r\n\t\tif (style) {\r\n\t\t\t// reset any custom styles\r\n\t\t\tL.Util.extend(layer.options, layer.defaultOptions);\r\n\r\n\t\t\tthis._setLayerStyle(layer, style);\r\n\t\t}\r\n\t},\r\n\r\n\tsetStyle: function (style) {\r\n\t\tthis.eachLayer(function (layer) {\r\n\t\t\tthis._setLayerStyle(layer, style);\r\n\t\t}, this);\r\n\t},\r\n\r\n\t_setLayerStyle: function (layer, style) {\r\n\t\tif (typeof style === 'function') {\r\n\t\t\tstyle = style(layer.feature);\r\n\t\t}\r\n\t\tif (layer.setStyle) {\r\n\t\t\tlayer.setStyle(style);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nL.extend(L.GeoJSON, {\r\n\tgeometryToLayer: function (geojson, pointToLayer, coordsToLatLng, vectorOptions) {\r\n\t\tvar geometry = geojson.type === 'Feature' ? geojson.geometry : geojson,\r\n\t\t    coords = geometry.coordinates,\r\n\t\t    layers = [],\r\n\t\t    latlng, latlngs, i, len;\r\n\r\n\t\tcoordsToLatLng = coordsToLatLng || this.coordsToLatLng;\r\n\r\n\t\tswitch (geometry.type) {\r\n\t\tcase 'Point':\r\n\t\t\tlatlng = coordsToLatLng(coords);\r\n\t\t\treturn pointToLayer ? pointToLayer(geojson, latlng) : new L.Marker(latlng);\r\n\r\n\t\tcase 'MultiPoint':\r\n\t\t\tfor (i = 0, len = coords.length; i < len; i++) {\r\n\t\t\t\tlatlng = coordsToLatLng(coords[i]);\r\n\t\t\t\tlayers.push(pointToLayer ? pointToLayer(geojson, latlng) : new L.Marker(latlng));\r\n\t\t\t}\r\n\t\t\treturn new L.FeatureGroup(layers);\r\n\r\n\t\tcase 'LineString':\r\n\t\t\tlatlngs = this.coordsToLatLngs(coords, 0, coordsToLatLng);\r\n\t\t\treturn new L.Polyline(latlngs, vectorOptions);\r\n\r\n\t\tcase 'Polygon':\r\n\t\t\tif (coords.length === 2 && !coords[1].length) {\r\n\t\t\t\tthrow new Error('Invalid GeoJSON object.');\r\n\t\t\t}\r\n\t\t\tlatlngs = this.coordsToLatLngs(coords, 1, coordsToLatLng);\r\n\t\t\treturn new L.Polygon(latlngs, vectorOptions);\r\n\r\n\t\tcase 'MultiLineString':\r\n\t\t\tlatlngs = this.coordsToLatLngs(coords, 1, coordsToLatLng);\r\n\t\t\treturn new L.MultiPolyline(latlngs, vectorOptions);\r\n\r\n\t\tcase 'MultiPolygon':\r\n\t\t\tlatlngs = this.coordsToLatLngs(coords, 2, coordsToLatLng);\r\n\t\t\treturn new L.MultiPolygon(latlngs, vectorOptions);\r\n\r\n\t\tcase 'GeometryCollection':\r\n\t\t\tfor (i = 0, len = geometry.geometries.length; i < len; i++) {\r\n\r\n\t\t\t\tlayers.push(this.geometryToLayer({\r\n\t\t\t\t\tgeometry: geometry.geometries[i],\r\n\t\t\t\t\ttype: 'Feature',\r\n\t\t\t\t\tproperties: geojson.properties\r\n\t\t\t\t}, pointToLayer, coordsToLatLng, vectorOptions));\r\n\t\t\t}\r\n\t\t\treturn new L.FeatureGroup(layers);\r\n\r\n\t\tdefault:\r\n\t\t\tthrow new Error('Invalid GeoJSON object.');\r\n\t\t}\r\n\t},\r\n\r\n\tcoordsToLatLng: function (coords) { // (Array[, Boolean]) -> LatLng\r\n\t\treturn new L.LatLng(coords[1], coords[0], coords[2]);\r\n\t},\r\n\r\n\tcoordsToLatLngs: function (coords, levelsDeep, coordsToLatLng) { // (Array[, Number, Function]) -> Array\r\n\t\tvar latlng, i, len,\r\n\t\t    latlngs = [];\r\n\r\n\t\tfor (i = 0, len = coords.length; i < len; i++) {\r\n\t\t\tlatlng = levelsDeep ?\r\n\t\t\t        this.coordsToLatLngs(coords[i], levelsDeep - 1, coordsToLatLng) :\r\n\t\t\t        (coordsToLatLng || this.coordsToLatLng)(coords[i]);\r\n\r\n\t\t\tlatlngs.push(latlng);\r\n\t\t}\r\n\r\n\t\treturn latlngs;\r\n\t},\r\n\r\n\tlatLngToCoords: function (latlng) {\r\n\t\tvar coords = [latlng.lng, latlng.lat];\r\n\r\n\t\tif (latlng.alt !== undefined) {\r\n\t\t\tcoords.push(latlng.alt);\r\n\t\t}\r\n\t\treturn coords;\r\n\t},\r\n\r\n\tlatLngsToCoords: function (latLngs) {\r\n\t\tvar coords = [];\r\n\r\n\t\tfor (var i = 0, len = latLngs.length; i < len; i++) {\r\n\t\t\tcoords.push(L.GeoJSON.latLngToCoords(latLngs[i]));\r\n\t\t}\r\n\r\n\t\treturn coords;\r\n\t},\r\n\r\n\tgetFeature: function (layer, newGeometry) {\r\n\t\treturn layer.feature ? L.extend({}, layer.feature, {geometry: newGeometry}) : L.GeoJSON.asFeature(newGeometry);\r\n\t},\r\n\r\n\tasFeature: function (geoJSON) {\r\n\t\tif (geoJSON.type === 'Feature') {\r\n\t\t\treturn geoJSON;\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\ttype: 'Feature',\r\n\t\t\tproperties: {},\r\n\t\t\tgeometry: geoJSON\r\n\t\t};\r\n\t}\r\n});\r\n\r\nvar PointToGeoJSON = {\r\n\ttoGeoJSON: function () {\r\n\t\treturn L.GeoJSON.getFeature(this, {\r\n\t\t\ttype: 'Point',\r\n\t\t\tcoordinates: L.GeoJSON.latLngToCoords(this.getLatLng())\r\n\t\t});\r\n\t}\r\n};\r\n\r\nL.Marker.include(PointToGeoJSON);\r\nL.Circle.include(PointToGeoJSON);\r\nL.CircleMarker.include(PointToGeoJSON);\r\n\r\nL.Polyline.include({\r\n\ttoGeoJSON: function () {\r\n\t\treturn L.GeoJSON.getFeature(this, {\r\n\t\t\ttype: 'LineString',\r\n\t\t\tcoordinates: L.GeoJSON.latLngsToCoords(this.getLatLngs())\r\n\t\t});\r\n\t}\r\n});\r\n\r\nL.Polygon.include({\r\n\ttoGeoJSON: function () {\r\n\t\tvar coords = [L.GeoJSON.latLngsToCoords(this.getLatLngs())],\r\n\t\t    i, len, hole;\r\n\r\n\t\tcoords[0].push(coords[0][0]);\r\n\r\n\t\tif (this._holes) {\r\n\t\t\tfor (i = 0, len = this._holes.length; i < len; i++) {\r\n\t\t\t\thole = L.GeoJSON.latLngsToCoords(this._holes[i]);\r\n\t\t\t\thole.push(hole[0]);\r\n\t\t\t\tcoords.push(hole);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn L.GeoJSON.getFeature(this, {\r\n\t\t\ttype: 'Polygon',\r\n\t\t\tcoordinates: coords\r\n\t\t});\r\n\t}\r\n});\r\n\r\n(function () {\r\n\tfunction multiToGeoJSON(type) {\r\n\t\treturn function () {\r\n\t\t\tvar coords = [];\r\n\r\n\t\t\tthis.eachLayer(function (layer) {\r\n\t\t\t\tcoords.push(layer.toGeoJSON().geometry.coordinates);\r\n\t\t\t});\r\n\r\n\t\t\treturn L.GeoJSON.getFeature(this, {\r\n\t\t\t\ttype: type,\r\n\t\t\t\tcoordinates: coords\r\n\t\t\t});\r\n\t\t};\r\n\t}\r\n\r\n\tL.MultiPolyline.include({toGeoJSON: multiToGeoJSON('MultiLineString')});\r\n\tL.MultiPolygon.include({toGeoJSON: multiToGeoJSON('MultiPolygon')});\r\n\r\n\tL.LayerGroup.include({\r\n\t\ttoGeoJSON: function () {\r\n\r\n\t\t\tvar geometry = this.feature && this.feature.geometry,\r\n\t\t\t\tjsons = [],\r\n\t\t\t\tjson;\r\n\r\n\t\t\tif (geometry && geometry.type === 'MultiPoint') {\r\n\t\t\t\treturn multiToGeoJSON('MultiPoint').call(this);\r\n\t\t\t}\r\n\r\n\t\t\tvar isGeometryCollection = geometry && geometry.type === 'GeometryCollection';\r\n\r\n\t\t\tthis.eachLayer(function (layer) {\r\n\t\t\t\tif (layer.toGeoJSON) {\r\n\t\t\t\t\tjson = layer.toGeoJSON();\r\n\t\t\t\t\tjsons.push(isGeometryCollection ? json.geometry : L.GeoJSON.asFeature(json));\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tif (isGeometryCollection) {\r\n\t\t\t\treturn L.GeoJSON.getFeature(this, {\r\n\t\t\t\t\tgeometries: jsons,\r\n\t\t\t\t\ttype: 'GeometryCollection'\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\treturn {\r\n\t\t\t\ttype: 'FeatureCollection',\r\n\t\t\t\tfeatures: jsons\r\n\t\t\t};\r\n\t\t}\r\n\t});\r\n}());\r\n\r\nL.geoJson = function (geojson, options) {\r\n\treturn new L.GeoJSON(geojson, options);\r\n};\r\n\n\n/*\r\n * L.DomEvent contains functions for working with DOM events.\r\n */\r\n\r\nL.DomEvent = {\r\n\t/* inspired by John Resig, Dean Edwards and YUI addEvent implementations */\r\n\taddListener: function (obj, type, fn, context) { // (HTMLElement, String, Function[, Object])\r\n\r\n\t\tvar id = L.stamp(fn),\r\n\t\t    key = '_leaflet_' + type + id,\r\n\t\t    handler, originalHandler, newType;\r\n\r\n\t\tif (obj[key]) { return this; }\r\n\r\n\t\thandler = function (e) {\r\n\t\t\treturn fn.call(context || obj, e || L.DomEvent._getEvent());\r\n\t\t};\r\n\r\n\t\tif (L.Browser.pointer && type.indexOf('touch') === 0) {\r\n\t\t\treturn this.addPointerListener(obj, type, handler, id);\r\n\t\t}\r\n\t\tif (L.Browser.touch && (type === 'dblclick') && this.addDoubleTapListener) {\r\n\t\t\tthis.addDoubleTapListener(obj, handler, id);\r\n\t\t}\r\n\r\n\t\tif ('addEventListener' in obj) {\r\n\r\n\t\t\tif (type === 'mousewheel') {\r\n\t\t\t\tobj.addEventListener('DOMMouseScroll', handler, false);\r\n\t\t\t\tobj.addEventListener(type, handler, false);\r\n\r\n\t\t\t} else if ((type === 'mouseenter') || (type === 'mouseleave')) {\r\n\r\n\t\t\t\toriginalHandler = handler;\r\n\t\t\t\tnewType = (type === 'mouseenter' ? 'mouseover' : 'mouseout');\r\n\r\n\t\t\t\thandler = function (e) {\r\n\t\t\t\t\tif (!L.DomEvent._checkMouse(obj, e)) { return; }\r\n\t\t\t\t\treturn originalHandler(e);\r\n\t\t\t\t};\r\n\r\n\t\t\t\tobj.addEventListener(newType, handler, false);\r\n\r\n\t\t\t} else if (type === 'click' && L.Browser.android) {\r\n\t\t\t\toriginalHandler = handler;\r\n\t\t\t\thandler = function (e) {\r\n\t\t\t\t\treturn L.DomEvent._filterClick(e, originalHandler);\r\n\t\t\t\t};\r\n\r\n\t\t\t\tobj.addEventListener(type, handler, false);\r\n\t\t\t} else {\r\n\t\t\t\tobj.addEventListener(type, handler, false);\r\n\t\t\t}\r\n\r\n\t\t} else if ('attachEvent' in obj) {\r\n\t\t\tobj.attachEvent('on' + type, handler);\r\n\t\t}\r\n\r\n\t\tobj[key] = handler;\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tremoveListener: function (obj, type, fn) {  // (HTMLElement, String, Function)\r\n\r\n\t\tvar id = L.stamp(fn),\r\n\t\t    key = '_leaflet_' + type + id,\r\n\t\t    handler = obj[key];\r\n\r\n\t\tif (!handler) { return this; }\r\n\r\n\t\tif (L.Browser.pointer && type.indexOf('touch') === 0) {\r\n\t\t\tthis.removePointerListener(obj, type, id);\r\n\t\t} else if (L.Browser.touch && (type === 'dblclick') && this.removeDoubleTapListener) {\r\n\t\t\tthis.removeDoubleTapListener(obj, id);\r\n\r\n\t\t} else if ('removeEventListener' in obj) {\r\n\r\n\t\t\tif (type === 'mousewheel') {\r\n\t\t\t\tobj.removeEventListener('DOMMouseScroll', handler, false);\r\n\t\t\t\tobj.removeEventListener(type, handler, false);\r\n\r\n\t\t\t} else if ((type === 'mouseenter') || (type === 'mouseleave')) {\r\n\t\t\t\tobj.removeEventListener((type === 'mouseenter' ? 'mouseover' : 'mouseout'), handler, false);\r\n\t\t\t} else {\r\n\t\t\t\tobj.removeEventListener(type, handler, false);\r\n\t\t\t}\r\n\t\t} else if ('detachEvent' in obj) {\r\n\t\t\tobj.detachEvent('on' + type, handler);\r\n\t\t}\r\n\r\n\t\tobj[key] = null;\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tstopPropagation: function (e) {\r\n\r\n\t\tif (e.stopPropagation) {\r\n\t\t\te.stopPropagation();\r\n\t\t} else {\r\n\t\t\te.cancelBubble = true;\r\n\t\t}\r\n\t\tL.DomEvent._skipped(e);\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tdisableScrollPropagation: function (el) {\r\n\t\tvar stop = L.DomEvent.stopPropagation;\r\n\r\n\t\treturn L.DomEvent\r\n\t\t\t.on(el, 'mousewheel', stop)\r\n\t\t\t.on(el, 'MozMousePixelScroll', stop);\r\n\t},\r\n\r\n\tdisableClickPropagation: function (el) {\r\n\t\tvar stop = L.DomEvent.stopPropagation;\r\n\r\n\t\tfor (var i = L.Draggable.START.length - 1; i >= 0; i--) {\r\n\t\t\tL.DomEvent.on(el, L.Draggable.START[i], stop);\r\n\t\t}\r\n\r\n\t\treturn L.DomEvent\r\n\t\t\t.on(el, 'click', L.DomEvent._fakeStop)\r\n\t\t\t.on(el, 'dblclick', stop);\r\n\t},\r\n\r\n\tpreventDefault: function (e) {\r\n\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t} else {\r\n\t\t\te.returnValue = false;\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tstop: function (e) {\r\n\t\treturn L.DomEvent\r\n\t\t\t.preventDefault(e)\r\n\t\t\t.stopPropagation(e);\r\n\t},\r\n\r\n\tgetMousePosition: function (e, container) {\r\n\t\tif (!container) {\r\n\t\t\treturn new L.Point(e.clientX, e.clientY);\r\n\t\t}\r\n\r\n\t\tvar rect = container.getBoundingClientRect();\r\n\r\n\t\treturn new L.Point(\r\n\t\t\te.clientX - rect.left - container.clientLeft,\r\n\t\t\te.clientY - rect.top - container.clientTop);\r\n\t},\r\n\r\n\tgetWheelDelta: function (e) {\r\n\r\n\t\tvar delta = 0;\r\n\r\n\t\tif (e.wheelDelta) {\r\n\t\t\tdelta = e.wheelDelta / 120;\r\n\t\t}\r\n\t\tif (e.detail) {\r\n\t\t\tdelta = -e.detail / 3;\r\n\t\t}\r\n\t\treturn delta;\r\n\t},\r\n\r\n\t_skipEvents: {},\r\n\r\n\t_fakeStop: function (e) {\r\n\t\t// fakes stopPropagation by setting a special event flag, checked/reset with L.DomEvent._skipped(e)\r\n\t\tL.DomEvent._skipEvents[e.type] = true;\r\n\t},\r\n\r\n\t_skipped: function (e) {\r\n\t\tvar skipped = this._skipEvents[e.type];\r\n\t\t// reset when checking, as it's only used in map container and propagates outside of the map\r\n\t\tthis._skipEvents[e.type] = false;\r\n\t\treturn skipped;\r\n\t},\r\n\r\n\t// check if element really left/entered the event target (for mouseenter/mouseleave)\r\n\t_checkMouse: function (el, e) {\r\n\r\n\t\tvar related = e.relatedTarget;\r\n\r\n\t\tif (!related) { return true; }\r\n\r\n\t\ttry {\r\n\t\t\twhile (related && (related !== el)) {\r\n\t\t\t\trelated = related.parentNode;\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\treturn (related !== el);\r\n\t},\r\n\r\n\t_getEvent: function () { // evil magic for IE\r\n\t\t/*jshint noarg:false */\r\n\t\tvar e = window.event;\r\n\t\tif (!e) {\r\n\t\t\tvar caller = arguments.callee.caller;\r\n\t\t\twhile (caller) {\r\n\t\t\t\te = caller['arguments'][0];\r\n\t\t\t\tif (e && window.Event === e.constructor) {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcaller = caller.caller;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn e;\r\n\t},\r\n\r\n\t// this is a horrible workaround for a bug in Android where a single touch triggers two click events\r\n\t_filterClick: function (e, handler) {\r\n\t\tvar timeStamp = (e.timeStamp || e.originalEvent.timeStamp),\r\n\t\t\telapsed = L.DomEvent._lastClick && (timeStamp - L.DomEvent._lastClick);\r\n\r\n\t\t// are they closer together than 500ms yet more than 100ms?\r\n\t\t// Android typically triggers them ~300ms apart while multiple listeners\r\n\t\t// on the same event should be triggered far faster;\r\n\t\t// or check if click is simulated on the element, and if it is, reject any non-simulated events\r\n\r\n\t\tif ((elapsed && elapsed > 100 && elapsed < 500) || (e.target._simulatedClick && !e._simulated)) {\r\n\t\t\tL.DomEvent.stop(e);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tL.DomEvent._lastClick = timeStamp;\r\n\r\n\t\treturn handler(e);\r\n\t}\r\n};\r\n\r\nL.DomEvent.on = L.DomEvent.addListener;\r\nL.DomEvent.off = L.DomEvent.removeListener;\r\n\n\n/*\r\n * L.Draggable allows you to add dragging capabilities to any element. Supports mobile devices too.\r\n */\r\n\r\nL.Draggable = L.Class.extend({\r\n\tincludes: L.Mixin.Events,\r\n\r\n\tstatics: {\r\n\t\tSTART: L.Browser.touch ? ['touchstart', 'mousedown'] : ['mousedown'],\r\n\t\tEND: {\r\n\t\t\tmousedown: 'mouseup',\r\n\t\t\ttouchstart: 'touchend',\r\n\t\t\tpointerdown: 'touchend',\r\n\t\t\tMSPointerDown: 'touchend'\r\n\t\t},\r\n\t\tMOVE: {\r\n\t\t\tmousedown: 'mousemove',\r\n\t\t\ttouchstart: 'touchmove',\r\n\t\t\tpointerdown: 'touchmove',\r\n\t\t\tMSPointerDown: 'touchmove'\r\n\t\t}\r\n\t},\r\n\r\n\tinitialize: function (element, dragStartTarget) {\r\n\t\tthis._element = element;\r\n\t\tthis._dragStartTarget = dragStartTarget || element;\r\n\t},\r\n\r\n\tenable: function () {\r\n\t\tif (this._enabled) { return; }\r\n\r\n\t\tfor (var i = L.Draggable.START.length - 1; i >= 0; i--) {\r\n\t\t\tL.DomEvent.on(this._dragStartTarget, L.Draggable.START[i], this._onDown, this);\r\n\t\t}\r\n\r\n\t\tthis._enabled = true;\r\n\t},\r\n\r\n\tdisable: function () {\r\n\t\tif (!this._enabled) { return; }\r\n\r\n\t\tfor (var i = L.Draggable.START.length - 1; i >= 0; i--) {\r\n\t\t\tL.DomEvent.off(this._dragStartTarget, L.Draggable.START[i], this._onDown, this);\r\n\t\t}\r\n\r\n\t\tthis._enabled = false;\r\n\t\tthis._moved = false;\r\n\t},\r\n\r\n\t_onDown: function (e) {\r\n\t\tthis._moved = false;\r\n\r\n\t\tif (e.shiftKey || ((e.which !== 1) && (e.button !== 1) && !e.touches)) { return; }\r\n\r\n\t\tL.DomEvent.stopPropagation(e);\r\n\r\n\t\tif (L.Draggable._disabled) { return; }\r\n\r\n\t\tL.DomUtil.disableImageDrag();\r\n\t\tL.DomUtil.disableTextSelection();\r\n\r\n\t\tif (this._moving) { return; }\r\n\r\n\t\tvar first = e.touches ? e.touches[0] : e;\r\n\r\n\t\tthis._startPoint = new L.Point(first.clientX, first.clientY);\r\n\t\tthis._startPos = this._newPos = L.DomUtil.getPosition(this._element);\r\n\r\n\t\tL.DomEvent\r\n\t\t    .on(document, L.Draggable.MOVE[e.type], this._onMove, this)\r\n\t\t    .on(document, L.Draggable.END[e.type], this._onUp, this);\r\n\t},\r\n\r\n\t_onMove: function (e) {\r\n\t\tif (e.touches && e.touches.length > 1) {\r\n\t\t\tthis._moved = true;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar first = (e.touches && e.touches.length === 1 ? e.touches[0] : e),\r\n\t\t    newPoint = new L.Point(first.clientX, first.clientY),\r\n\t\t    offset = newPoint.subtract(this._startPoint);\r\n\r\n\t\tif (!offset.x && !offset.y) { return; }\r\n\t\tif (L.Browser.touch && Math.abs(offset.x) + Math.abs(offset.y) < 3) { return; }\r\n\r\n\t\tL.DomEvent.preventDefault(e);\r\n\r\n\t\tif (!this._moved) {\r\n\t\t\tthis.fire('dragstart');\r\n\r\n\t\t\tthis._moved = true;\r\n\t\t\tthis._startPos = L.DomUtil.getPosition(this._element).subtract(offset);\r\n\r\n\t\t\tL.DomUtil.addClass(document.body, 'leaflet-dragging');\r\n\t\t\tthis._lastTarget = e.target || e.srcElement;\r\n\t\t\tL.DomUtil.addClass(this._lastTarget, 'leaflet-drag-target');\r\n\t\t}\r\n\r\n\t\tthis._newPos = this._startPos.add(offset);\r\n\t\tthis._moving = true;\r\n\r\n\t\tL.Util.cancelAnimFrame(this._animRequest);\r\n\t\tthis._animRequest = L.Util.requestAnimFrame(this._updatePosition, this, true, this._dragStartTarget);\r\n\t},\r\n\r\n\t_updatePosition: function () {\r\n\t\tthis.fire('predrag');\r\n\t\tL.DomUtil.setPosition(this._element, this._newPos);\r\n\t\tthis.fire('drag');\r\n\t},\r\n\r\n\t_onUp: function () {\r\n\t\tL.DomUtil.removeClass(document.body, 'leaflet-dragging');\r\n\r\n\t\tif (this._lastTarget) {\r\n\t\t\tL.DomUtil.removeClass(this._lastTarget, 'leaflet-drag-target');\r\n\t\t\tthis._lastTarget = null;\r\n\t\t}\r\n\r\n\t\tfor (var i in L.Draggable.MOVE) {\r\n\t\t\tL.DomEvent\r\n\t\t\t    .off(document, L.Draggable.MOVE[i], this._onMove)\r\n\t\t\t    .off(document, L.Draggable.END[i], this._onUp);\r\n\t\t}\r\n\r\n\t\tL.DomUtil.enableImageDrag();\r\n\t\tL.DomUtil.enableTextSelection();\r\n\r\n\t\tif (this._moved && this._moving) {\r\n\t\t\t// ensure drag is not fired after dragend\r\n\t\t\tL.Util.cancelAnimFrame(this._animRequest);\r\n\r\n\t\t\tthis.fire('dragend', {\r\n\t\t\t\tdistance: this._newPos.distanceTo(this._startPos)\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tthis._moving = false;\r\n\t}\r\n});\r\n\n\n/*\n\tL.Handler is a base class for handler classes that are used internally to inject\n\tinteraction features like dragging to classes like Map and Marker.\n*/\n\nL.Handler = L.Class.extend({\n\tinitialize: function (map) {\n\t\tthis._map = map;\n\t},\n\n\tenable: function () {\n\t\tif (this._enabled) { return; }\n\n\t\tthis._enabled = true;\n\t\tthis.addHooks();\n\t},\n\n\tdisable: function () {\n\t\tif (!this._enabled) { return; }\n\n\t\tthis._enabled = false;\n\t\tthis.removeHooks();\n\t},\n\n\tenabled: function () {\n\t\treturn !!this._enabled;\n\t}\n});\n\n\n/*\n * L.Handler.MapDrag is used to make the map draggable (with panning inertia), enabled by default.\n */\n\nL.Map.mergeOptions({\n\tdragging: true,\n\n\tinertia: !L.Browser.android23,\n\tinertiaDeceleration: 3400, // px/s^2\n\tinertiaMaxSpeed: Infinity, // px/s\n\tinertiaThreshold: L.Browser.touch ? 32 : 18, // ms\n\teaseLinearity: 0.25,\n\n\t// TODO refactor, move to CRS\n\tworldCopyJump: false\n});\n\nL.Map.Drag = L.Handler.extend({\n\taddHooks: function () {\n\t\tif (!this._draggable) {\n\t\t\tvar map = this._map;\n\n\t\t\tthis._draggable = new L.Draggable(map._mapPane, map._container);\n\n\t\t\tthis._draggable.on({\n\t\t\t\t'dragstart': this._onDragStart,\n\t\t\t\t'drag': this._onDrag,\n\t\t\t\t'dragend': this._onDragEnd\n\t\t\t}, this);\n\n\t\t\tif (map.options.worldCopyJump) {\n\t\t\t\tthis._draggable.on('predrag', this._onPreDrag, this);\n\t\t\t\tmap.on('viewreset', this._onViewReset, this);\n\n\t\t\t\tmap.whenReady(this._onViewReset, this);\n\t\t\t}\n\t\t}\n\t\tthis._draggable.enable();\n\t},\n\n\tremoveHooks: function () {\n\t\tthis._draggable.disable();\n\t},\n\n\tmoved: function () {\n\t\treturn this._draggable && this._draggable._moved;\n\t},\n\n\t_onDragStart: function () {\n\t\tvar map = this._map;\n\n\t\tif (map._panAnim) {\n\t\t\tmap._panAnim.stop();\n\t\t}\n\n\t\tmap\n\t\t    .fire('movestart')\n\t\t    .fire('dragstart');\n\n\t\tif (map.options.inertia) {\n\t\t\tthis._positions = [];\n\t\t\tthis._times = [];\n\t\t}\n\t},\n\n\t_onDrag: function () {\n\t\tif (this._map.options.inertia) {\n\t\t\tvar time = this._lastTime = +new Date(),\n\t\t\t    pos = this._lastPos = this._draggable._newPos;\n\n\t\t\tthis._positions.push(pos);\n\t\t\tthis._times.push(time);\n\n\t\t\tif (time - this._times[0] > 200) {\n\t\t\t\tthis._positions.shift();\n\t\t\t\tthis._times.shift();\n\t\t\t}\n\t\t}\n\n\t\tthis._map\n\t\t    .fire('move')\n\t\t    .fire('drag');\n\t},\n\n\t_onViewReset: function () {\n\t\t// TODO fix hardcoded Earth values\n\t\tvar pxCenter = this._map.getSize()._divideBy(2),\n\t\t    pxWorldCenter = this._map.latLngToLayerPoint([0, 0]);\n\n\t\tthis._initialWorldOffset = pxWorldCenter.subtract(pxCenter).x;\n\t\tthis._worldWidth = this._map.project([0, 180]).x;\n\t},\n\n\t_onPreDrag: function () {\n\t\t// TODO refactor to be able to adjust map pane position after zoom\n\t\tvar worldWidth = this._worldWidth,\n\t\t    halfWidth = Math.round(worldWidth / 2),\n\t\t    dx = this._initialWorldOffset,\n\t\t    x = this._draggable._newPos.x,\n\t\t    newX1 = (x - halfWidth + dx) % worldWidth + halfWidth - dx,\n\t\t    newX2 = (x + halfWidth + dx) % worldWidth - halfWidth - dx,\n\t\t    newX = Math.abs(newX1 + dx) < Math.abs(newX2 + dx) ? newX1 : newX2;\n\n\t\tthis._draggable._newPos.x = newX;\n\t},\n\n\t_onDragEnd: function (e) {\n\t\tvar map = this._map,\n\t\t    options = map.options,\n\t\t    delay = +new Date() - this._lastTime,\n\n\t\t    noInertia = !options.inertia || delay > options.inertiaThreshold || !this._positions[0];\n\n\t\tmap.fire('dragend', e);\n\n\t\tif (noInertia) {\n\t\t\tmap.fire('moveend');\n\n\t\t} else {\n\n\t\t\tvar direction = this._lastPos.subtract(this._positions[0]),\n\t\t\t    duration = (this._lastTime + delay - this._times[0]) / 1000,\n\t\t\t    ease = options.easeLinearity,\n\n\t\t\t    speedVector = direction.multiplyBy(ease / duration),\n\t\t\t    speed = speedVector.distanceTo([0, 0]),\n\n\t\t\t    limitedSpeed = Math.min(options.inertiaMaxSpeed, speed),\n\t\t\t    limitedSpeedVector = speedVector.multiplyBy(limitedSpeed / speed),\n\n\t\t\t    decelerationDuration = limitedSpeed / (options.inertiaDeceleration * ease),\n\t\t\t    offset = limitedSpeedVector.multiplyBy(-decelerationDuration / 2).round();\n\n\t\t\tif (!offset.x || !offset.y) {\n\t\t\t\tmap.fire('moveend');\n\n\t\t\t} else {\n\t\t\t\toffset = map._limitOffset(offset, map.options.maxBounds);\n\n\t\t\t\tL.Util.requestAnimFrame(function () {\n\t\t\t\t\tmap.panBy(offset, {\n\t\t\t\t\t\tduration: decelerationDuration,\n\t\t\t\t\t\teaseLinearity: ease,\n\t\t\t\t\t\tnoMoveStart: true\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n});\n\nL.Map.addInitHook('addHandler', 'dragging', L.Map.Drag);\n\n\n/*\n * L.Handler.DoubleClickZoom is used to handle double-click zoom on the map, enabled by default.\n */\n\nL.Map.mergeOptions({\n\tdoubleClickZoom: true\n});\n\nL.Map.DoubleClickZoom = L.Handler.extend({\n\taddHooks: function () {\n\t\tthis._map.on('dblclick', this._onDoubleClick, this);\n\t},\n\n\tremoveHooks: function () {\n\t\tthis._map.off('dblclick', this._onDoubleClick, this);\n\t},\n\n\t_onDoubleClick: function (e) {\n\t\tvar map = this._map,\n\t\t    zoom = map.getZoom() + (e.originalEvent.shiftKey ? -1 : 1);\n\n\t\tif (map.options.doubleClickZoom === 'center') {\n\t\t\tmap.setZoom(zoom);\n\t\t} else {\n\t\t\tmap.setZoomAround(e.containerPoint, zoom);\n\t\t}\n\t}\n});\n\nL.Map.addInitHook('addHandler', 'doubleClickZoom', L.Map.DoubleClickZoom);\n\n\n/*\n * L.Handler.ScrollWheelZoom is used by L.Map to enable mouse scroll wheel zoom on the map.\n */\n\nL.Map.mergeOptions({\n\tscrollWheelZoom: true\n});\n\nL.Map.ScrollWheelZoom = L.Handler.extend({\n\taddHooks: function () {\n\t\tL.DomEvent.on(this._map._container, 'mousewheel', this._onWheelScroll, this);\n\t\tL.DomEvent.on(this._map._container, 'MozMousePixelScroll', L.DomEvent.preventDefault);\n\t\tthis._delta = 0;\n\t},\n\n\tremoveHooks: function () {\n\t\tL.DomEvent.off(this._map._container, 'mousewheel', this._onWheelScroll);\n\t\tL.DomEvent.off(this._map._container, 'MozMousePixelScroll', L.DomEvent.preventDefault);\n\t},\n\n\t_onWheelScroll: function (e) {\n\t\tvar delta = L.DomEvent.getWheelDelta(e);\n\n\t\tthis._delta += delta;\n\t\tthis._lastMousePos = this._map.mouseEventToContainerPoint(e);\n\n\t\tif (!this._startTime) {\n\t\t\tthis._startTime = +new Date();\n\t\t}\n\n\t\tvar left = Math.max(40 - (+new Date() - this._startTime), 0);\n\n\t\tclearTimeout(this._timer);\n\t\tthis._timer = setTimeout(L.bind(this._performZoom, this), left);\n\n\t\tL.DomEvent.preventDefault(e);\n\t\tL.DomEvent.stopPropagation(e);\n\t},\n\n\t_performZoom: function () {\n\t\tvar map = this._map,\n\t\t    delta = this._delta,\n\t\t    zoom = map.getZoom();\n\n\t\tdelta = delta > 0 ? Math.ceil(delta) : Math.floor(delta);\n\t\tdelta = Math.max(Math.min(delta, 4), -4);\n\t\tdelta = map._limitZoom(zoom + delta) - zoom;\n\n\t\tthis._delta = 0;\n\t\tthis._startTime = null;\n\n\t\tif (!delta) { return; }\n\n\t\tif (map.options.scrollWheelZoom === 'center') {\n\t\t\tmap.setZoom(zoom + delta);\n\t\t} else {\n\t\t\tmap.setZoomAround(this._lastMousePos, zoom + delta);\n\t\t}\n\t}\n});\n\nL.Map.addInitHook('addHandler', 'scrollWheelZoom', L.Map.ScrollWheelZoom);\n\n\n/*\r\n * Extends the event handling code with double tap support for mobile browsers.\r\n */\r\n\r\nL.extend(L.DomEvent, {\r\n\r\n\t_touchstart: L.Browser.msPointer ? 'MSPointerDown' : L.Browser.pointer ? 'pointerdown' : 'touchstart',\r\n\t_touchend: L.Browser.msPointer ? 'MSPointerUp' : L.Browser.pointer ? 'pointerup' : 'touchend',\r\n\r\n\t// inspired by Zepto touch code by Thomas Fuchs\r\n\taddDoubleTapListener: function (obj, handler, id) {\r\n\t\tvar last,\r\n\t\t    doubleTap = false,\r\n\t\t    delay = 250,\r\n\t\t    touch,\r\n\t\t    pre = '_leaflet_',\r\n\t\t    touchstart = this._touchstart,\r\n\t\t    touchend = this._touchend,\r\n\t\t    trackedTouches = [];\r\n\r\n\t\tfunction onTouchStart(e) {\r\n\t\t\tvar count;\r\n\r\n\t\t\tif (L.Browser.pointer) {\r\n\t\t\t\ttrackedTouches.push(e.pointerId);\r\n\t\t\t\tcount = trackedTouches.length;\r\n\t\t\t} else {\r\n\t\t\t\tcount = e.touches.length;\r\n\t\t\t}\r\n\t\t\tif (count > 1) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tvar now = Date.now(),\r\n\t\t\t\tdelta = now - (last || now);\r\n\r\n\t\t\ttouch = e.touches ? e.touches[0] : e;\r\n\t\t\tdoubleTap = (delta > 0 && delta <= delay);\r\n\t\t\tlast = now;\r\n\t\t}\r\n\r\n\t\tfunction onTouchEnd(e) {\r\n\t\t\tif (L.Browser.pointer) {\r\n\t\t\t\tvar idx = trackedTouches.indexOf(e.pointerId);\r\n\t\t\t\tif (idx === -1) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\ttrackedTouches.splice(idx, 1);\r\n\t\t\t}\r\n\r\n\t\t\tif (doubleTap) {\r\n\t\t\t\tif (L.Browser.pointer) {\r\n\t\t\t\t\t// work around .type being readonly with MSPointer* events\r\n\t\t\t\t\tvar newTouch = { },\r\n\t\t\t\t\t\tprop;\r\n\r\n\t\t\t\t\t// jshint forin:false\r\n\t\t\t\t\tfor (var i in touch) {\r\n\t\t\t\t\t\tprop = touch[i];\r\n\t\t\t\t\t\tif (typeof prop === 'function') {\r\n\t\t\t\t\t\t\tnewTouch[i] = prop.bind(touch);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tnewTouch[i] = prop;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttouch = newTouch;\r\n\t\t\t\t}\r\n\t\t\t\ttouch.type = 'dblclick';\r\n\t\t\t\thandler(touch);\r\n\t\t\t\tlast = null;\r\n\t\t\t}\r\n\t\t}\r\n\t\tobj[pre + touchstart + id] = onTouchStart;\r\n\t\tobj[pre + touchend + id] = onTouchEnd;\r\n\r\n\t\t// on pointer we need to listen on the document, otherwise a drag starting on the map and moving off screen\r\n\t\t// will not come through to us, so we will lose track of how many touches are ongoing\r\n\t\tvar endElement = L.Browser.pointer ? document.documentElement : obj;\r\n\r\n\t\tobj.addEventListener(touchstart, onTouchStart, false);\r\n\t\tendElement.addEventListener(touchend, onTouchEnd, false);\r\n\r\n\t\tif (L.Browser.pointer) {\r\n\t\t\tendElement.addEventListener(L.DomEvent.POINTER_CANCEL, onTouchEnd, false);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tremoveDoubleTapListener: function (obj, id) {\r\n\t\tvar pre = '_leaflet_';\r\n\r\n\t\tobj.removeEventListener(this._touchstart, obj[pre + this._touchstart + id], false);\r\n\t\t(L.Browser.pointer ? document.documentElement : obj).removeEventListener(\r\n\t\t        this._touchend, obj[pre + this._touchend + id], false);\r\n\r\n\t\tif (L.Browser.pointer) {\r\n\t\t\tdocument.documentElement.removeEventListener(L.DomEvent.POINTER_CANCEL, obj[pre + this._touchend + id],\r\n\t\t\t\tfalse);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t}\r\n});\r\n\n\n/*\n * Extends L.DomEvent to provide touch support for Internet Explorer and Windows-based devices.\n */\n\nL.extend(L.DomEvent, {\n\n\t//static\n\tPOINTER_DOWN: L.Browser.msPointer ? 'MSPointerDown' : 'pointerdown',\n\tPOINTER_MOVE: L.Browser.msPointer ? 'MSPointerMove' : 'pointermove',\n\tPOINTER_UP: L.Browser.msPointer ? 'MSPointerUp' : 'pointerup',\n\tPOINTER_CANCEL: L.Browser.msPointer ? 'MSPointerCancel' : 'pointercancel',\n\n\t_pointers: [],\n\t_pointerDocumentListener: false,\n\n\t// Provides a touch events wrapper for (ms)pointer events.\n\t// Based on changes by veproza https://github.com/CloudMade/Leaflet/pull/1019\n\t//ref http://www.w3.org/TR/pointerevents/ https://www.w3.org/Bugs/Public/show_bug.cgi?id=22890\n\n\taddPointerListener: function (obj, type, handler, id) {\n\n\t\tswitch (type) {\n\t\tcase 'touchstart':\n\t\t\treturn this.addPointerListenerStart(obj, type, handler, id);\n\t\tcase 'touchend':\n\t\t\treturn this.addPointerListenerEnd(obj, type, handler, id);\n\t\tcase 'touchmove':\n\t\t\treturn this.addPointerListenerMove(obj, type, handler, id);\n\t\tdefault:\n\t\t\tthrow 'Unknown touch event type';\n\t\t}\n\t},\n\n\taddPointerListenerStart: function (obj, type, handler, id) {\n\t\tvar pre = '_leaflet_',\n\t\t    pointers = this._pointers;\n\n\t\tvar cb = function (e) {\n\t\t\tif (e.pointerType !== 'mouse' && e.pointerType !== e.MSPOINTER_TYPE_MOUSE) {\n\t\t\t\tL.DomEvent.preventDefault(e);\n\t\t\t}\n\n\t\t\tvar alreadyInArray = false;\n\t\t\tfor (var i = 0; i < pointers.length; i++) {\n\t\t\t\tif (pointers[i].pointerId === e.pointerId) {\n\t\t\t\t\talreadyInArray = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!alreadyInArray) {\n\t\t\t\tpointers.push(e);\n\t\t\t}\n\n\t\t\te.touches = pointers.slice();\n\t\t\te.changedTouches = [e];\n\n\t\t\thandler(e);\n\t\t};\n\n\t\tobj[pre + 'touchstart' + id] = cb;\n\t\tobj.addEventListener(this.POINTER_DOWN, cb, false);\n\n\t\t// need to also listen for end events to keep the _pointers list accurate\n\t\t// this needs to be on the body and never go away\n\t\tif (!this._pointerDocumentListener) {\n\t\t\tvar internalCb = function (e) {\n\t\t\t\tfor (var i = 0; i < pointers.length; i++) {\n\t\t\t\t\tif (pointers[i].pointerId === e.pointerId) {\n\t\t\t\t\t\tpointers.splice(i, 1);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\t//We listen on the documentElement as any drags that end by moving the touch off the screen get fired there\n\t\t\tdocument.documentElement.addEventListener(this.POINTER_UP, internalCb, false);\n\t\t\tdocument.documentElement.addEventListener(this.POINTER_CANCEL, internalCb, false);\n\n\t\t\tthis._pointerDocumentListener = true;\n\t\t}\n\n\t\treturn this;\n\t},\n\n\taddPointerListenerMove: function (obj, type, handler, id) {\n\t\tvar pre = '_leaflet_',\n\t\t    touches = this._pointers;\n\n\t\tfunction cb(e) {\n\n\t\t\t// don't fire touch moves when mouse isn't down\n\t\t\tif ((e.pointerType === e.MSPOINTER_TYPE_MOUSE || e.pointerType === 'mouse') && e.buttons === 0) { return; }\n\n\t\t\tfor (var i = 0; i < touches.length; i++) {\n\t\t\t\tif (touches[i].pointerId === e.pointerId) {\n\t\t\t\t\ttouches[i] = e;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\te.touches = touches.slice();\n\t\t\te.changedTouches = [e];\n\n\t\t\thandler(e);\n\t\t}\n\n\t\tobj[pre + 'touchmove' + id] = cb;\n\t\tobj.addEventListener(this.POINTER_MOVE, cb, false);\n\n\t\treturn this;\n\t},\n\n\taddPointerListenerEnd: function (obj, type, handler, id) {\n\t\tvar pre = '_leaflet_',\n\t\t    touches = this._pointers;\n\n\t\tvar cb = function (e) {\n\t\t\tfor (var i = 0; i < touches.length; i++) {\n\t\t\t\tif (touches[i].pointerId === e.pointerId) {\n\t\t\t\t\ttouches.splice(i, 1);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\te.touches = touches.slice();\n\t\t\te.changedTouches = [e];\n\n\t\t\thandler(e);\n\t\t};\n\n\t\tobj[pre + 'touchend' + id] = cb;\n\t\tobj.addEventListener(this.POINTER_UP, cb, false);\n\t\tobj.addEventListener(this.POINTER_CANCEL, cb, false);\n\n\t\treturn this;\n\t},\n\n\tremovePointerListener: function (obj, type, id) {\n\t\tvar pre = '_leaflet_',\n\t\t    cb = obj[pre + type + id];\n\n\t\tswitch (type) {\n\t\tcase 'touchstart':\n\t\t\tobj.removeEventListener(this.POINTER_DOWN, cb, false);\n\t\t\tbreak;\n\t\tcase 'touchmove':\n\t\t\tobj.removeEventListener(this.POINTER_MOVE, cb, false);\n\t\t\tbreak;\n\t\tcase 'touchend':\n\t\t\tobj.removeEventListener(this.POINTER_UP, cb, false);\n\t\t\tobj.removeEventListener(this.POINTER_CANCEL, cb, false);\n\t\t\tbreak;\n\t\t}\n\n\t\treturn this;\n\t}\n});\n\n\n/*\n * L.Handler.TouchZoom is used by L.Map to add pinch zoom on supported mobile browsers.\n */\n\nL.Map.mergeOptions({\n\ttouchZoom: L.Browser.touch && !L.Browser.android23,\n\tbounceAtZoomLimits: true\n});\n\nL.Map.TouchZoom = L.Handler.extend({\n\taddHooks: function () {\n\t\tL.DomEvent.on(this._map._container, 'touchstart', this._onTouchStart, this);\n\t},\n\n\tremoveHooks: function () {\n\t\tL.DomEvent.off(this._map._container, 'touchstart', this._onTouchStart, this);\n\t},\n\n\t_onTouchStart: function (e) {\n\t\tvar map = this._map;\n\n\t\tif (!e.touches || e.touches.length !== 2 || map._animatingZoom || this._zooming) { return; }\n\n\t\tvar p1 = map.mouseEventToLayerPoint(e.touches[0]),\n\t\t    p2 = map.mouseEventToLayerPoint(e.touches[1]),\n\t\t    viewCenter = map._getCenterLayerPoint();\n\n\t\tthis._startCenter = p1.add(p2)._divideBy(2);\n\t\tthis._startDist = p1.distanceTo(p2);\n\n\t\tthis._moved = false;\n\t\tthis._zooming = true;\n\n\t\tthis._centerOffset = viewCenter.subtract(this._startCenter);\n\n\t\tif (map._panAnim) {\n\t\t\tmap._panAnim.stop();\n\t\t}\n\n\t\tL.DomEvent\n\t\t    .on(document, 'touchmove', this._onTouchMove, this)\n\t\t    .on(document, 'touchend', this._onTouchEnd, this);\n\n\t\tL.DomEvent.preventDefault(e);\n\t},\n\n\t_onTouchMove: function (e) {\n\t\tvar map = this._map;\n\n\t\tif (!e.touches || e.touches.length !== 2 || !this._zooming) { return; }\n\n\t\tvar p1 = map.mouseEventToLayerPoint(e.touches[0]),\n\t\t    p2 = map.mouseEventToLayerPoint(e.touches[1]);\n\n\t\tthis._scale = p1.distanceTo(p2) / this._startDist;\n\t\tthis._delta = p1._add(p2)._divideBy(2)._subtract(this._startCenter);\n\n\t\tif (this._scale === 1) { return; }\n\n\t\tif (!map.options.bounceAtZoomLimits) {\n\t\t\tif ((map.getZoom() === map.getMinZoom() && this._scale < 1) ||\n\t\t\t    (map.getZoom() === map.getMaxZoom() && this._scale > 1)) { return; }\n\t\t}\n\n\t\tif (!this._moved) {\n\t\t\tL.DomUtil.addClass(map._mapPane, 'leaflet-touching');\n\n\t\t\tmap\n\t\t\t    .fire('movestart')\n\t\t\t    .fire('zoomstart');\n\n\t\t\tthis._moved = true;\n\t\t}\n\n\t\tL.Util.cancelAnimFrame(this._animRequest);\n\t\tthis._animRequest = L.Util.requestAnimFrame(\n\t\t        this._updateOnMove, this, true, this._map._container);\n\n\t\tL.DomEvent.preventDefault(e);\n\t},\n\n\t_updateOnMove: function () {\n\t\tvar map = this._map,\n\t\t    origin = this._getScaleOrigin(),\n\t\t    center = map.layerPointToLatLng(origin),\n\t\t    zoom = map.getScaleZoom(this._scale);\n\n\t\tmap._animateZoom(center, zoom, this._startCenter, this._scale, this._delta, false, true);\n\t},\n\n\t_onTouchEnd: function () {\n\t\tif (!this._moved || !this._zooming) {\n\t\t\tthis._zooming = false;\n\t\t\treturn;\n\t\t}\n\n\t\tvar map = this._map;\n\n\t\tthis._zooming = false;\n\t\tL.DomUtil.removeClass(map._mapPane, 'leaflet-touching');\n\t\tL.Util.cancelAnimFrame(this._animRequest);\n\n\t\tL.DomEvent\n\t\t    .off(document, 'touchmove', this._onTouchMove)\n\t\t    .off(document, 'touchend', this._onTouchEnd);\n\n\t\tvar origin = this._getScaleOrigin(),\n\t\t    center = map.layerPointToLatLng(origin),\n\n\t\t    oldZoom = map.getZoom(),\n\t\t    floatZoomDelta = map.getScaleZoom(this._scale) - oldZoom,\n\t\t    roundZoomDelta = (floatZoomDelta > 0 ?\n\t\t            Math.ceil(floatZoomDelta) : Math.floor(floatZoomDelta)),\n\n\t\t    zoom = map._limitZoom(oldZoom + roundZoomDelta),\n\t\t    scale = map.getZoomScale(zoom) / this._scale;\n\n\t\tmap._animateZoom(center, zoom, origin, scale);\n\t},\n\n\t_getScaleOrigin: function () {\n\t\tvar centerOffset = this._centerOffset.subtract(this._delta).divideBy(this._scale);\n\t\treturn this._startCenter.add(centerOffset);\n\t}\n});\n\nL.Map.addInitHook('addHandler', 'touchZoom', L.Map.TouchZoom);\n\n\n/*\n * L.Map.Tap is used to enable mobile hacks like quick taps and long hold.\n */\n\nL.Map.mergeOptions({\n\ttap: true,\n\ttapTolerance: 15\n});\n\nL.Map.Tap = L.Handler.extend({\n\taddHooks: function () {\n\t\tL.DomEvent.on(this._map._container, 'touchstart', this._onDown, this);\n\t},\n\n\tremoveHooks: function () {\n\t\tL.DomEvent.off(this._map._container, 'touchstart', this._onDown, this);\n\t},\n\n\t_onDown: function (e) {\n\t\tif (!e.touches) { return; }\n\n\t\tL.DomEvent.preventDefault(e);\n\n\t\tthis._fireClick = true;\n\n\t\t// don't simulate click or track longpress if more than 1 touch\n\t\tif (e.touches.length > 1) {\n\t\t\tthis._fireClick = false;\n\t\t\tclearTimeout(this._holdTimeout);\n\t\t\treturn;\n\t\t}\n\n\t\tvar first = e.touches[0],\n\t\t    el = first.target;\n\n\t\tthis._startPos = this._newPos = new L.Point(first.clientX, first.clientY);\n\n\t\t// if touching a link, highlight it\n\t\tif (el.tagName && el.tagName.toLowerCase() === 'a') {\n\t\t\tL.DomUtil.addClass(el, 'leaflet-active');\n\t\t}\n\n\t\t// simulate long hold but setting a timeout\n\t\tthis._holdTimeout = setTimeout(L.bind(function () {\n\t\t\tif (this._isTapValid()) {\n\t\t\t\tthis._fireClick = false;\n\t\t\t\tthis._onUp();\n\t\t\t\tthis._simulateEvent('contextmenu', first);\n\t\t\t}\n\t\t}, this), 1000);\n\n\t\tL.DomEvent\n\t\t\t.on(document, 'touchmove', this._onMove, this)\n\t\t\t.on(document, 'touchend', this._onUp, this);\n\t},\n\n\t_onUp: function (e) {\n\t\tclearTimeout(this._holdTimeout);\n\n\t\tL.DomEvent\n\t\t\t.off(document, 'touchmove', this._onMove, this)\n\t\t\t.off(document, 'touchend', this._onUp, this);\n\n\t\tif (this._fireClick && e && e.changedTouches) {\n\n\t\t\tvar first = e.changedTouches[0],\n\t\t\t    el = first.target;\n\n\t\t\tif (el && el.tagName && el.tagName.toLowerCase() === 'a') {\n\t\t\t\tL.DomUtil.removeClass(el, 'leaflet-active');\n\t\t\t}\n\n\t\t\t// simulate click if the touch didn't move too much\n\t\t\tif (this._isTapValid()) {\n\t\t\t\tthis._simulateEvent('click', first);\n\t\t\t}\n\t\t}\n\t},\n\n\t_isTapValid: function () {\n\t\treturn this._newPos.distanceTo(this._startPos) <= this._map.options.tapTolerance;\n\t},\n\n\t_onMove: function (e) {\n\t\tvar first = e.touches[0];\n\t\tthis._newPos = new L.Point(first.clientX, first.clientY);\n\t},\n\n\t_simulateEvent: function (type, e) {\n\t\tvar simulatedEvent = document.createEvent('MouseEvents');\n\n\t\tsimulatedEvent._simulated = true;\n\t\te.target._simulatedClick = true;\n\n\t\tsimulatedEvent.initMouseEvent(\n\t\t        type, true, true, window, 1,\n\t\t        e.screenX, e.screenY,\n\t\t        e.clientX, e.clientY,\n\t\t        false, false, false, false, 0, null);\n\n\t\te.target.dispatchEvent(simulatedEvent);\n\t}\n});\n\nif (L.Browser.touch && !L.Browser.pointer) {\n\tL.Map.addInitHook('addHandler', 'tap', L.Map.Tap);\n}\n\n\n/*\n * L.Handler.ShiftDragZoom is used to add shift-drag zoom interaction to the map\n  * (zoom to a selected bounding box), enabled by default.\n */\n\nL.Map.mergeOptions({\n\tboxZoom: true\n});\n\nL.Map.BoxZoom = L.Handler.extend({\n\tinitialize: function (map) {\n\t\tthis._map = map;\n\t\tthis._container = map._container;\n\t\tthis._pane = map._panes.overlayPane;\n\t\tthis._moved = false;\n\t},\n\n\taddHooks: function () {\n\t\tL.DomEvent.on(this._container, 'mousedown', this._onMouseDown, this);\n\t},\n\n\tremoveHooks: function () {\n\t\tL.DomEvent.off(this._container, 'mousedown', this._onMouseDown);\n\t\tthis._moved = false;\n\t},\n\n\tmoved: function () {\n\t\treturn this._moved;\n\t},\n\n\t_onMouseDown: function (e) {\n\t\tthis._moved = false;\n\n\t\tif (!e.shiftKey || ((e.which !== 1) && (e.button !== 1))) { return false; }\n\n\t\tL.DomUtil.disableTextSelection();\n\t\tL.DomUtil.disableImageDrag();\n\n\t\tthis._startLayerPoint = this._map.mouseEventToLayerPoint(e);\n\n\t\tL.DomEvent\n\t\t    .on(document, 'mousemove', this._onMouseMove, this)\n\t\t    .on(document, 'mouseup', this._onMouseUp, this)\n\t\t    .on(document, 'keydown', this._onKeyDown, this);\n\t},\n\n\t_onMouseMove: function (e) {\n\t\tif (!this._moved) {\n\t\t\tthis._box = L.DomUtil.create('div', 'leaflet-zoom-box', this._pane);\n\t\t\tL.DomUtil.setPosition(this._box, this._startLayerPoint);\n\n\t\t\t//TODO refactor: move cursor to styles\n\t\t\tthis._container.style.cursor = 'crosshair';\n\t\t\tthis._map.fire('boxzoomstart');\n\t\t}\n\n\t\tvar startPoint = this._startLayerPoint,\n\t\t    box = this._box,\n\n\t\t    layerPoint = this._map.mouseEventToLayerPoint(e),\n\t\t    offset = layerPoint.subtract(startPoint),\n\n\t\t    newPos = new L.Point(\n\t\t        Math.min(layerPoint.x, startPoint.x),\n\t\t        Math.min(layerPoint.y, startPoint.y));\n\n\t\tL.DomUtil.setPosition(box, newPos);\n\n\t\tthis._moved = true;\n\n\t\t// TODO refactor: remove hardcoded 4 pixels\n\t\tbox.style.width  = (Math.max(0, Math.abs(offset.x) - 4)) + 'px';\n\t\tbox.style.height = (Math.max(0, Math.abs(offset.y) - 4)) + 'px';\n\t},\n\n\t_finish: function () {\n\t\tif (this._moved) {\n\t\t\tthis._pane.removeChild(this._box);\n\t\t\tthis._container.style.cursor = '';\n\t\t}\n\n\t\tL.DomUtil.enableTextSelection();\n\t\tL.DomUtil.enableImageDrag();\n\n\t\tL.DomEvent\n\t\t    .off(document, 'mousemove', this._onMouseMove)\n\t\t    .off(document, 'mouseup', this._onMouseUp)\n\t\t    .off(document, 'keydown', this._onKeyDown);\n\t},\n\n\t_onMouseUp: function (e) {\n\n\t\tthis._finish();\n\n\t\tvar map = this._map,\n\t\t    layerPoint = map.mouseEventToLayerPoint(e);\n\n\t\tif (this._startLayerPoint.equals(layerPoint)) { return; }\n\n\t\tvar bounds = new L.LatLngBounds(\n\t\t        map.layerPointToLatLng(this._startLayerPoint),\n\t\t        map.layerPointToLatLng(layerPoint));\n\n\t\tmap.fitBounds(bounds);\n\n\t\tmap.fire('boxzoomend', {\n\t\t\tboxZoomBounds: bounds\n\t\t});\n\t},\n\n\t_onKeyDown: function (e) {\n\t\tif (e.keyCode === 27) {\n\t\t\tthis._finish();\n\t\t}\n\t}\n});\n\nL.Map.addInitHook('addHandler', 'boxZoom', L.Map.BoxZoom);\n\n\n/*\n * L.Map.Keyboard is handling keyboard interaction with the map, enabled by default.\n */\n\nL.Map.mergeOptions({\n\tkeyboard: true,\n\tkeyboardPanOffset: 80,\n\tkeyboardZoomOffset: 1\n});\n\nL.Map.Keyboard = L.Handler.extend({\n\n\tkeyCodes: {\n\t\tleft:    [37],\n\t\tright:   [39],\n\t\tdown:    [40],\n\t\tup:      [38],\n\t\tzoomIn:  [187, 107, 61, 171],\n\t\tzoomOut: [189, 109, 173]\n\t},\n\n\tinitialize: function (map) {\n\t\tthis._map = map;\n\n\t\tthis._setPanOffset(map.options.keyboardPanOffset);\n\t\tthis._setZoomOffset(map.options.keyboardZoomOffset);\n\t},\n\n\taddHooks: function () {\n\t\tvar container = this._map._container;\n\n\t\t// make the container focusable by tabbing\n\t\tif (container.tabIndex === -1) {\n\t\t\tcontainer.tabIndex = '0';\n\t\t}\n\n\t\tL.DomEvent\n\t\t    .on(container, 'focus', this._onFocus, this)\n\t\t    .on(container, 'blur', this._onBlur, this)\n\t\t    .on(container, 'mousedown', this._onMouseDown, this);\n\n\t\tthis._map\n\t\t    .on('focus', this._addHooks, this)\n\t\t    .on('blur', this._removeHooks, this);\n\t},\n\n\tremoveHooks: function () {\n\t\tthis._removeHooks();\n\n\t\tvar container = this._map._container;\n\n\t\tL.DomEvent\n\t\t    .off(container, 'focus', this._onFocus, this)\n\t\t    .off(container, 'blur', this._onBlur, this)\n\t\t    .off(container, 'mousedown', this._onMouseDown, this);\n\n\t\tthis._map\n\t\t    .off('focus', this._addHooks, this)\n\t\t    .off('blur', this._removeHooks, this);\n\t},\n\n\t_onMouseDown: function () {\n\t\tif (this._focused) { return; }\n\n\t\tvar body = document.body,\n\t\t    docEl = document.documentElement,\n\t\t    top = body.scrollTop || docEl.scrollTop,\n\t\t    left = body.scrollLeft || docEl.scrollLeft;\n\n\t\tthis._map._container.focus();\n\n\t\twindow.scrollTo(left, top);\n\t},\n\n\t_onFocus: function () {\n\t\tthis._focused = true;\n\t\tthis._map.fire('focus');\n\t},\n\n\t_onBlur: function () {\n\t\tthis._focused = false;\n\t\tthis._map.fire('blur');\n\t},\n\n\t_setPanOffset: function (pan) {\n\t\tvar keys = this._panKeys = {},\n\t\t    codes = this.keyCodes,\n\t\t    i, len;\n\n\t\tfor (i = 0, len = codes.left.length; i < len; i++) {\n\t\t\tkeys[codes.left[i]] = [-1 * pan, 0];\n\t\t}\n\t\tfor (i = 0, len = codes.right.length; i < len; i++) {\n\t\t\tkeys[codes.right[i]] = [pan, 0];\n\t\t}\n\t\tfor (i = 0, len = codes.down.length; i < len; i++) {\n\t\t\tkeys[codes.down[i]] = [0, pan];\n\t\t}\n\t\tfor (i = 0, len = codes.up.length; i < len; i++) {\n\t\t\tkeys[codes.up[i]] = [0, -1 * pan];\n\t\t}\n\t},\n\n\t_setZoomOffset: function (zoom) {\n\t\tvar keys = this._zoomKeys = {},\n\t\t    codes = this.keyCodes,\n\t\t    i, len;\n\n\t\tfor (i = 0, len = codes.zoomIn.length; i < len; i++) {\n\t\t\tkeys[codes.zoomIn[i]] = zoom;\n\t\t}\n\t\tfor (i = 0, len = codes.zoomOut.length; i < len; i++) {\n\t\t\tkeys[codes.zoomOut[i]] = -zoom;\n\t\t}\n\t},\n\n\t_addHooks: function () {\n\t\tL.DomEvent.on(document, 'keydown', this._onKeyDown, this);\n\t},\n\n\t_removeHooks: function () {\n\t\tL.DomEvent.off(document, 'keydown', this._onKeyDown, this);\n\t},\n\n\t_onKeyDown: function (e) {\n\t\tvar key = e.keyCode,\n\t\t    map = this._map;\n\n\t\tif (key in this._panKeys) {\n\n\t\t\tif (map._panAnim && map._panAnim._inProgress) { return; }\n\n\t\t\tmap.panBy(this._panKeys[key]);\n\n\t\t\tif (map.options.maxBounds) {\n\t\t\t\tmap.panInsideBounds(map.options.maxBounds);\n\t\t\t}\n\n\t\t} else if (key in this._zoomKeys) {\n\t\t\tmap.setZoom(map.getZoom() + this._zoomKeys[key]);\n\n\t\t} else {\n\t\t\treturn;\n\t\t}\n\n\t\tL.DomEvent.stop(e);\n\t}\n});\n\nL.Map.addInitHook('addHandler', 'keyboard', L.Map.Keyboard);\n\n\n/*\n * L.Handler.MarkerDrag is used internally by L.Marker to make the markers draggable.\n */\n\nL.Handler.MarkerDrag = L.Handler.extend({\n\tinitialize: function (marker) {\n\t\tthis._marker = marker;\n\t},\n\n\taddHooks: function () {\n\t\tvar icon = this._marker._icon;\n\t\tif (!this._draggable) {\n\t\t\tthis._draggable = new L.Draggable(icon, icon);\n\t\t}\n\n\t\tthis._draggable\n\t\t\t.on('dragstart', this._onDragStart, this)\n\t\t\t.on('drag', this._onDrag, this)\n\t\t\t.on('dragend', this._onDragEnd, this);\n\t\tthis._draggable.enable();\n\t\tL.DomUtil.addClass(this._marker._icon, 'leaflet-marker-draggable');\n\t},\n\n\tremoveHooks: function () {\n\t\tthis._draggable\n\t\t\t.off('dragstart', this._onDragStart, this)\n\t\t\t.off('drag', this._onDrag, this)\n\t\t\t.off('dragend', this._onDragEnd, this);\n\n\t\tthis._draggable.disable();\n\t\tL.DomUtil.removeClass(this._marker._icon, 'leaflet-marker-draggable');\n\t},\n\n\tmoved: function () {\n\t\treturn this._draggable && this._draggable._moved;\n\t},\n\n\t_onDragStart: function () {\n\t\tthis._marker\n\t\t    .closePopup()\n\t\t    .fire('movestart')\n\t\t    .fire('dragstart');\n\t},\n\n\t_onDrag: function () {\n\t\tvar marker = this._marker,\n\t\t    shadow = marker._shadow,\n\t\t    iconPos = L.DomUtil.getPosition(marker._icon),\n\t\t    latlng = marker._map.layerPointToLatLng(iconPos);\n\n\t\t// update shadow position\n\t\tif (shadow) {\n\t\t\tL.DomUtil.setPosition(shadow, iconPos);\n\t\t}\n\n\t\tmarker._latlng = latlng;\n\n\t\tmarker\n\t\t    .fire('move', {latlng: latlng})\n\t\t    .fire('drag');\n\t},\n\n\t_onDragEnd: function (e) {\n\t\tthis._marker\n\t\t    .fire('moveend')\n\t\t    .fire('dragend', e);\n\t}\n});\n\n\n/*\r\n * L.Control is a base class for implementing map controls. Handles positioning.\r\n * All other controls extend from this class.\r\n */\r\n\r\nL.Control = L.Class.extend({\r\n\toptions: {\r\n\t\tposition: 'topright'\r\n\t},\r\n\r\n\tinitialize: function (options) {\r\n\t\tL.setOptions(this, options);\r\n\t},\r\n\r\n\tgetPosition: function () {\r\n\t\treturn this.options.position;\r\n\t},\r\n\r\n\tsetPosition: function (position) {\r\n\t\tvar map = this._map;\r\n\r\n\t\tif (map) {\r\n\t\t\tmap.removeControl(this);\r\n\t\t}\r\n\r\n\t\tthis.options.position = position;\r\n\r\n\t\tif (map) {\r\n\t\t\tmap.addControl(this);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tgetContainer: function () {\r\n\t\treturn this._container;\r\n\t},\r\n\r\n\taddTo: function (map) {\r\n\t\tthis._map = map;\r\n\r\n\t\tvar container = this._container = this.onAdd(map),\r\n\t\t    pos = this.getPosition(),\r\n\t\t    corner = map._controlCorners[pos];\r\n\r\n\t\tL.DomUtil.addClass(container, 'leaflet-control');\r\n\r\n\t\tif (pos.indexOf('bottom') !== -1) {\r\n\t\t\tcorner.insertBefore(container, corner.firstChild);\r\n\t\t} else {\r\n\t\t\tcorner.appendChild(container);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tremoveFrom: function (map) {\r\n\t\tvar pos = this.getPosition(),\r\n\t\t    corner = map._controlCorners[pos];\r\n\r\n\t\tcorner.removeChild(this._container);\r\n\t\tthis._map = null;\r\n\r\n\t\tif (this.onRemove) {\r\n\t\t\tthis.onRemove(map);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_refocusOnMap: function () {\r\n\t\tif (this._map) {\r\n\t\t\tthis._map.getContainer().focus();\r\n\t\t}\r\n\t}\r\n});\r\n\r\nL.control = function (options) {\r\n\treturn new L.Control(options);\r\n};\r\n\r\n\r\n// adds control-related methods to L.Map\r\n\r\nL.Map.include({\r\n\taddControl: function (control) {\r\n\t\tcontrol.addTo(this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tremoveControl: function (control) {\r\n\t\tcontrol.removeFrom(this);\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_initControlPos: function () {\r\n\t\tvar corners = this._controlCorners = {},\r\n\t\t    l = 'leaflet-',\r\n\t\t    container = this._controlContainer =\r\n\t\t            L.DomUtil.create('div', l + 'control-container', this._container);\r\n\r\n\t\tfunction createCorner(vSide, hSide) {\r\n\t\t\tvar className = l + vSide + ' ' + l + hSide;\r\n\r\n\t\t\tcorners[vSide + hSide] = L.DomUtil.create('div', className, container);\r\n\t\t}\r\n\r\n\t\tcreateCorner('top', 'left');\r\n\t\tcreateCorner('top', 'right');\r\n\t\tcreateCorner('bottom', 'left');\r\n\t\tcreateCorner('bottom', 'right');\r\n\t},\r\n\r\n\t_clearControlPos: function () {\r\n\t\tthis._container.removeChild(this._controlContainer);\r\n\t}\r\n});\r\n\n\n/*\r\n * L.Control.Zoom is used for the default zoom buttons on the map.\r\n */\r\n\r\nL.Control.Zoom = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'topleft',\r\n\t\tzoomInText: '+',\r\n\t\tzoomInTitle: 'Zoom in',\r\n\t\tzoomOutText: '-',\r\n\t\tzoomOutTitle: 'Zoom out'\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tvar zoomName = 'leaflet-control-zoom',\r\n\t\t    container = L.DomUtil.create('div', zoomName + ' leaflet-bar');\r\n\r\n\t\tthis._map = map;\r\n\r\n\t\tthis._zoomInButton  = this._createButton(\r\n\t\t        this.options.zoomInText, this.options.zoomInTitle,\r\n\t\t        zoomName + '-in',  container, this._zoomIn,  this);\r\n\t\tthis._zoomOutButton = this._createButton(\r\n\t\t        this.options.zoomOutText, this.options.zoomOutTitle,\r\n\t\t        zoomName + '-out', container, this._zoomOut, this);\r\n\r\n\t\tthis._updateDisabled();\r\n\t\tmap.on('zoomend zoomlevelschange', this._updateDisabled, this);\r\n\r\n\t\treturn container;\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tmap.off('zoomend zoomlevelschange', this._updateDisabled, this);\r\n\t},\r\n\r\n\t_zoomIn: function (e) {\r\n\t\tthis._map.zoomIn(e.shiftKey ? 3 : 1);\r\n\t},\r\n\r\n\t_zoomOut: function (e) {\r\n\t\tthis._map.zoomOut(e.shiftKey ? 3 : 1);\r\n\t},\r\n\r\n\t_createButton: function (html, title, className, container, fn, context) {\r\n\t\tvar link = L.DomUtil.create('a', className, container);\r\n\t\tlink.innerHTML = html;\r\n\t\tlink.href = '#';\r\n\t\tlink.title = title;\r\n\r\n\t\tvar stop = L.DomEvent.stopPropagation;\r\n\r\n\t\tL.DomEvent\r\n\t\t    .on(link, 'click', stop)\r\n\t\t    .on(link, 'mousedown', stop)\r\n\t\t    .on(link, 'dblclick', stop)\r\n\t\t    .on(link, 'click', L.DomEvent.preventDefault)\r\n\t\t    .on(link, 'click', fn, context)\r\n\t\t    .on(link, 'click', this._refocusOnMap, context);\r\n\r\n\t\treturn link;\r\n\t},\r\n\r\n\t_updateDisabled: function () {\r\n\t\tvar map = this._map,\r\n\t\t\tclassName = 'leaflet-disabled';\r\n\r\n\t\tL.DomUtil.removeClass(this._zoomInButton, className);\r\n\t\tL.DomUtil.removeClass(this._zoomOutButton, className);\r\n\r\n\t\tif (map._zoom === map.getMinZoom()) {\r\n\t\t\tL.DomUtil.addClass(this._zoomOutButton, className);\r\n\t\t}\r\n\t\tif (map._zoom === map.getMaxZoom()) {\r\n\t\t\tL.DomUtil.addClass(this._zoomInButton, className);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nL.Map.mergeOptions({\r\n\tzoomControl: true\r\n});\r\n\r\nL.Map.addInitHook(function () {\r\n\tif (this.options.zoomControl) {\r\n\t\tthis.zoomControl = new L.Control.Zoom();\r\n\t\tthis.addControl(this.zoomControl);\r\n\t}\r\n});\r\n\r\nL.control.zoom = function (options) {\r\n\treturn new L.Control.Zoom(options);\r\n};\r\n\r\n\n\n/*\r\n * L.Control.Attribution is used for displaying attribution on the map (added by default).\r\n */\r\n\r\nL.Control.Attribution = L.Control.extend({\r\n\toptions: {\r\n\t\tposition: 'bottomright',\r\n\t\tprefix: '<a href=\"http://leafletjs.com\" title=\"A JS library for interactive maps\">Leaflet</a>'\r\n\t},\r\n\r\n\tinitialize: function (options) {\r\n\t\tL.setOptions(this, options);\r\n\r\n\t\tthis._attributions = {};\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tthis._container = L.DomUtil.create('div', 'leaflet-control-attribution');\r\n\t\tL.DomEvent.disableClickPropagation(this._container);\r\n\r\n\t\tfor (var i in map._layers) {\r\n\t\t\tif (map._layers[i].getAttribution) {\r\n\t\t\t\tthis.addAttribution(map._layers[i].getAttribution());\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tmap\r\n\t\t    .on('layeradd', this._onLayerAdd, this)\r\n\t\t    .on('layerremove', this._onLayerRemove, this);\r\n\r\n\t\tthis._update();\r\n\r\n\t\treturn this._container;\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tmap\r\n\t\t    .off('layeradd', this._onLayerAdd)\r\n\t\t    .off('layerremove', this._onLayerRemove);\r\n\r\n\t},\r\n\r\n\tsetPrefix: function (prefix) {\r\n\t\tthis.options.prefix = prefix;\r\n\t\tthis._update();\r\n\t\treturn this;\r\n\t},\r\n\r\n\taddAttribution: function (text) {\r\n\t\tif (!text) { return; }\r\n\r\n\t\tif (!this._attributions[text]) {\r\n\t\t\tthis._attributions[text] = 0;\r\n\t\t}\r\n\t\tthis._attributions[text]++;\r\n\r\n\t\tthis._update();\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\tremoveAttribution: function (text) {\r\n\t\tif (!text) { return; }\r\n\r\n\t\tif (this._attributions[text]) {\r\n\t\t\tthis._attributions[text]--;\r\n\t\t\tthis._update();\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_update: function () {\r\n\t\tif (!this._map) { return; }\r\n\r\n\t\tvar attribs = [];\r\n\r\n\t\tfor (var i in this._attributions) {\r\n\t\t\tif (this._attributions[i]) {\r\n\t\t\t\tattribs.push(i);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar prefixAndAttribs = [];\r\n\r\n\t\tif (this.options.prefix) {\r\n\t\t\tprefixAndAttribs.push(this.options.prefix);\r\n\t\t}\r\n\t\tif (attribs.length) {\r\n\t\t\tprefixAndAttribs.push(attribs.join(', '));\r\n\t\t}\r\n\r\n\t\tthis._container.innerHTML = prefixAndAttribs.join(' | ');\r\n\t},\r\n\r\n\t_onLayerAdd: function (e) {\r\n\t\tif (e.layer.getAttribution) {\r\n\t\t\tthis.addAttribution(e.layer.getAttribution());\r\n\t\t}\r\n\t},\r\n\r\n\t_onLayerRemove: function (e) {\r\n\t\tif (e.layer.getAttribution) {\r\n\t\t\tthis.removeAttribution(e.layer.getAttribution());\r\n\t\t}\r\n\t}\r\n});\r\n\r\nL.Map.mergeOptions({\r\n\tattributionControl: true\r\n});\r\n\r\nL.Map.addInitHook(function () {\r\n\tif (this.options.attributionControl) {\r\n\t\tthis.attributionControl = (new L.Control.Attribution()).addTo(this);\r\n\t}\r\n});\r\n\r\nL.control.attribution = function (options) {\r\n\treturn new L.Control.Attribution(options);\r\n};\r\n\n\n/*\n * L.Control.Scale is used for displaying metric/imperial scale on the map.\n */\n\nL.Control.Scale = L.Control.extend({\n\toptions: {\n\t\tposition: 'bottomleft',\n\t\tmaxWidth: 100,\n\t\tmetric: true,\n\t\timperial: true,\n\t\tupdateWhenIdle: false\n\t},\n\n\tonAdd: function (map) {\n\t\tthis._map = map;\n\n\t\tvar className = 'leaflet-control-scale',\n\t\t    container = L.DomUtil.create('div', className),\n\t\t    options = this.options;\n\n\t\tthis._addScales(options, className, container);\n\n\t\tmap.on(options.updateWhenIdle ? 'moveend' : 'move', this._update, this);\n\t\tmap.whenReady(this._update, this);\n\n\t\treturn container;\n\t},\n\n\tonRemove: function (map) {\n\t\tmap.off(this.options.updateWhenIdle ? 'moveend' : 'move', this._update, this);\n\t},\n\n\t_addScales: function (options, className, container) {\n\t\tif (options.metric) {\n\t\t\tthis._mScale = L.DomUtil.create('div', className + '-line', container);\n\t\t}\n\t\tif (options.imperial) {\n\t\t\tthis._iScale = L.DomUtil.create('div', className + '-line', container);\n\t\t}\n\t},\n\n\t_update: function () {\n\t\tvar bounds = this._map.getBounds(),\n\t\t    centerLat = bounds.getCenter().lat,\n\t\t    halfWorldMeters = 6378137 * Math.PI * Math.cos(centerLat * Math.PI / 180),\n\t\t    dist = halfWorldMeters * (bounds.getNorthEast().lng - bounds.getSouthWest().lng) / 180,\n\n\t\t    size = this._map.getSize(),\n\t\t    options = this.options,\n\t\t    maxMeters = 0;\n\n\t\tif (size.x > 0) {\n\t\t\tmaxMeters = dist * (options.maxWidth / size.x);\n\t\t}\n\n\t\tthis._updateScales(options, maxMeters);\n\t},\n\n\t_updateScales: function (options, maxMeters) {\n\t\tif (options.metric && maxMeters) {\n\t\t\tthis._updateMetric(maxMeters);\n\t\t}\n\n\t\tif (options.imperial && maxMeters) {\n\t\t\tthis._updateImperial(maxMeters);\n\t\t}\n\t},\n\n\t_updateMetric: function (maxMeters) {\n\t\tvar meters = this._getRoundNum(maxMeters);\n\n\t\tthis._mScale.style.width = this._getScaleWidth(meters / maxMeters) + 'px';\n\t\tthis._mScale.innerHTML = meters < 1000 ? meters + ' m' : (meters / 1000) + ' km';\n\t},\n\n\t_updateImperial: function (maxMeters) {\n\t\tvar maxFeet = maxMeters * 3.2808399,\n\t\t    scale = this._iScale,\n\t\t    maxMiles, miles, feet;\n\n\t\tif (maxFeet > 5280) {\n\t\t\tmaxMiles = maxFeet / 5280;\n\t\t\tmiles = this._getRoundNum(maxMiles);\n\n\t\t\tscale.style.width = this._getScaleWidth(miles / maxMiles) + 'px';\n\t\t\tscale.innerHTML = miles + ' mi';\n\n\t\t} else {\n\t\t\tfeet = this._getRoundNum(maxFeet);\n\n\t\t\tscale.style.width = this._getScaleWidth(feet / maxFeet) + 'px';\n\t\t\tscale.innerHTML = feet + ' ft';\n\t\t}\n\t},\n\n\t_getScaleWidth: function (ratio) {\n\t\treturn Math.round(this.options.maxWidth * ratio) - 10;\n\t},\n\n\t_getRoundNum: function (num) {\n\t\tvar pow10 = Math.pow(10, (Math.floor(num) + '').length - 1),\n\t\t    d = num / pow10;\n\n\t\td = d >= 10 ? 10 : d >= 5 ? 5 : d >= 3 ? 3 : d >= 2 ? 2 : 1;\n\n\t\treturn pow10 * d;\n\t}\n});\n\nL.control.scale = function (options) {\n\treturn new L.Control.Scale(options);\n};\n\n\n/*\r\n * L.Control.Layers is a control to allow users to switch between different layers on the map.\r\n */\r\n\r\nL.Control.Layers = L.Control.extend({\r\n\toptions: {\r\n\t\tcollapsed: true,\r\n\t\tposition: 'topright',\r\n\t\tautoZIndex: true\r\n\t},\r\n\r\n\tinitialize: function (baseLayers, overlays, options) {\r\n\t\tL.setOptions(this, options);\r\n\r\n\t\tthis._layers = {};\r\n\t\tthis._lastZIndex = 0;\r\n\t\tthis._handlingClick = false;\r\n\r\n\t\tfor (var i in baseLayers) {\r\n\t\t\tthis._addLayer(baseLayers[i], i);\r\n\t\t}\r\n\r\n\t\tfor (i in overlays) {\r\n\t\t\tthis._addLayer(overlays[i], i, true);\r\n\t\t}\r\n\t},\r\n\r\n\tonAdd: function (map) {\r\n\t\tthis._initLayout();\r\n\t\tthis._update();\r\n\r\n\t\tmap\r\n\t\t    .on('layeradd', this._onLayerChange, this)\r\n\t\t    .on('layerremove', this._onLayerChange, this);\r\n\r\n\t\treturn this._container;\r\n\t},\r\n\r\n\tonRemove: function (map) {\r\n\t\tmap\r\n\t\t    .off('layeradd', this._onLayerChange, this)\r\n\t\t    .off('layerremove', this._onLayerChange, this);\r\n\t},\r\n\r\n\taddBaseLayer: function (layer, name) {\r\n\t\tthis._addLayer(layer, name);\r\n\t\tthis._update();\r\n\t\treturn this;\r\n\t},\r\n\r\n\taddOverlay: function (layer, name) {\r\n\t\tthis._addLayer(layer, name, true);\r\n\t\tthis._update();\r\n\t\treturn this;\r\n\t},\r\n\r\n\tremoveLayer: function (layer) {\r\n\t\tvar id = L.stamp(layer);\r\n\t\tdelete this._layers[id];\r\n\t\tthis._update();\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_initLayout: function () {\r\n\t\tvar className = 'leaflet-control-layers',\r\n\t\t    container = this._container = L.DomUtil.create('div', className);\r\n\r\n\t\t//Makes this work on IE10 Touch devices by stopping it from firing a mouseout event when the touch is released\r\n\t\tcontainer.setAttribute('aria-haspopup', true);\r\n\r\n\t\tif (!L.Browser.touch) {\r\n\t\t\tL.DomEvent\r\n\t\t\t\t.disableClickPropagation(container)\r\n\t\t\t\t.disableScrollPropagation(container);\r\n\t\t} else {\r\n\t\t\tL.DomEvent.on(container, 'click', L.DomEvent.stopPropagation);\r\n\t\t}\r\n\r\n\t\tvar form = this._form = L.DomUtil.create('form', className + '-list');\r\n\r\n\t\tif (this.options.collapsed) {\r\n\t\t\tif (!L.Browser.android) {\r\n\t\t\t\tL.DomEvent\r\n\t\t\t\t    .on(container, 'mouseover', this._expand, this)\r\n\t\t\t\t    .on(container, 'mouseout', this._collapse, this);\r\n\t\t\t}\r\n\t\t\tvar link = this._layersLink = L.DomUtil.create('a', className + '-toggle', container);\r\n\t\t\tlink.href = '#';\r\n\t\t\tlink.title = 'Layers';\r\n\r\n\t\t\tif (L.Browser.touch) {\r\n\t\t\t\tL.DomEvent\r\n\t\t\t\t    .on(link, 'click', L.DomEvent.stop)\r\n\t\t\t\t    .on(link, 'click', this._expand, this);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tL.DomEvent.on(link, 'focus', this._expand, this);\r\n\t\t\t}\r\n\t\t\t//Work around for Firefox android issue https://github.com/Leaflet/Leaflet/issues/2033\r\n\t\t\tL.DomEvent.on(form, 'click', function () {\r\n\t\t\t\tsetTimeout(L.bind(this._onInputClick, this), 0);\r\n\t\t\t}, this);\r\n\r\n\t\t\tthis._map.on('click', this._collapse, this);\r\n\t\t\t// TODO keyboard accessibility\r\n\t\t} else {\r\n\t\t\tthis._expand();\r\n\t\t}\r\n\r\n\t\tthis._baseLayersList = L.DomUtil.create('div', className + '-base', form);\r\n\t\tthis._separator = L.DomUtil.create('div', className + '-separator', form);\r\n\t\tthis._overlaysList = L.DomUtil.create('div', className + '-overlays', form);\r\n\r\n\t\tcontainer.appendChild(form);\r\n\t},\r\n\r\n\t_addLayer: function (layer, name, overlay) {\r\n\t\tvar id = L.stamp(layer);\r\n\r\n\t\tthis._layers[id] = {\r\n\t\t\tlayer: layer,\r\n\t\t\tname: name,\r\n\t\t\toverlay: overlay\r\n\t\t};\r\n\r\n\t\tif (this.options.autoZIndex && layer.setZIndex) {\r\n\t\t\tthis._lastZIndex++;\r\n\t\t\tlayer.setZIndex(this._lastZIndex);\r\n\t\t}\r\n\t},\r\n\r\n\t_update: function () {\r\n\t\tif (!this._container) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis._baseLayersList.innerHTML = '';\r\n\t\tthis._overlaysList.innerHTML = '';\r\n\r\n\t\tvar baseLayersPresent = false,\r\n\t\t    overlaysPresent = false,\r\n\t\t    i, obj;\r\n\r\n\t\tfor (i in this._layers) {\r\n\t\t\tobj = this._layers[i];\r\n\t\t\tthis._addItem(obj);\r\n\t\t\toverlaysPresent = overlaysPresent || obj.overlay;\r\n\t\t\tbaseLayersPresent = baseLayersPresent || !obj.overlay;\r\n\t\t}\r\n\r\n\t\tthis._separator.style.display = overlaysPresent && baseLayersPresent ? '' : 'none';\r\n\t},\r\n\r\n\t_onLayerChange: function (e) {\r\n\t\tvar obj = this._layers[L.stamp(e.layer)];\r\n\r\n\t\tif (!obj) { return; }\r\n\r\n\t\tif (!this._handlingClick) {\r\n\t\t\tthis._update();\r\n\t\t}\r\n\r\n\t\tvar type = obj.overlay ?\r\n\t\t\t(e.type === 'layeradd' ? 'overlayadd' : 'overlayremove') :\r\n\t\t\t(e.type === 'layeradd' ? 'baselayerchange' : null);\r\n\r\n\t\tif (type) {\r\n\t\t\tthis._map.fire(type, obj);\r\n\t\t}\r\n\t},\r\n\r\n\t// IE7 bugs out if you create a radio dynamically, so you have to do it this hacky way (see http://bit.ly/PqYLBe)\r\n\t_createRadioElement: function (name, checked) {\r\n\r\n\t\tvar radioHtml = '<input type=\"radio\" class=\"leaflet-control-layers-selector\" name=\"' + name + '\"';\r\n\t\tif (checked) {\r\n\t\t\tradioHtml += ' checked=\"checked\"';\r\n\t\t}\r\n\t\tradioHtml += '/>';\r\n\r\n\t\tvar radioFragment = document.createElement('div');\r\n\t\tradioFragment.innerHTML = radioHtml;\r\n\r\n\t\treturn radioFragment.firstChild;\r\n\t},\r\n\r\n\t_addItem: function (obj) {\r\n\t\tvar label = document.createElement('label'),\r\n\t\t    input,\r\n\t\t    checked = this._map.hasLayer(obj.layer);\r\n\r\n\t\tif (obj.overlay) {\r\n\t\t\tinput = document.createElement('input');\r\n\t\t\tinput.type = 'checkbox';\r\n\t\t\tinput.className = 'leaflet-control-layers-selector';\r\n\t\t\tinput.defaultChecked = checked;\r\n\t\t} else {\r\n\t\t\tinput = this._createRadioElement('leaflet-base-layers', checked);\r\n\t\t}\r\n\r\n\t\tinput.layerId = L.stamp(obj.layer);\r\n\r\n\t\tL.DomEvent.on(input, 'click', this._onInputClick, this);\r\n\r\n\t\tvar name = document.createElement('span');\r\n\t\tname.innerHTML = ' ' + obj.name;\r\n\r\n\t\tlabel.appendChild(input);\r\n\t\tlabel.appendChild(name);\r\n\r\n\t\tvar container = obj.overlay ? this._overlaysList : this._baseLayersList;\r\n\t\tcontainer.appendChild(label);\r\n\r\n\t\treturn label;\r\n\t},\r\n\r\n\t_onInputClick: function () {\r\n\t\tvar i, input, obj,\r\n\t\t    inputs = this._form.getElementsByTagName('input'),\r\n\t\t    inputsLen = inputs.length;\r\n\r\n\t\tthis._handlingClick = true;\r\n\r\n\t\tfor (i = 0; i < inputsLen; i++) {\r\n\t\t\tinput = inputs[i];\r\n\t\t\tobj = this._layers[input.layerId];\r\n\r\n\t\t\tif (input.checked && !this._map.hasLayer(obj.layer)) {\r\n\t\t\t\tthis._map.addLayer(obj.layer);\r\n\r\n\t\t\t} else if (!input.checked && this._map.hasLayer(obj.layer)) {\r\n\t\t\t\tthis._map.removeLayer(obj.layer);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis._handlingClick = false;\r\n\r\n\t\tthis._refocusOnMap();\r\n\t},\r\n\r\n\t_expand: function () {\r\n\t\tL.DomUtil.addClass(this._container, 'leaflet-control-layers-expanded');\r\n\t},\r\n\r\n\t_collapse: function () {\r\n\t\tthis._container.className = this._container.className.replace(' leaflet-control-layers-expanded', '');\r\n\t}\r\n});\r\n\r\nL.control.layers = function (baseLayers, overlays, options) {\r\n\treturn new L.Control.Layers(baseLayers, overlays, options);\r\n};\r\n\n\n/*\n * L.PosAnimation is used by Leaflet internally for pan animations.\n */\n\nL.PosAnimation = L.Class.extend({\n\tincludes: L.Mixin.Events,\n\n\trun: function (el, newPos, duration, easeLinearity) { // (HTMLElement, Point[, Number, Number])\n\t\tthis.stop();\n\n\t\tthis._el = el;\n\t\tthis._inProgress = true;\n\t\tthis._newPos = newPos;\n\n\t\tthis.fire('start');\n\n\t\tel.style[L.DomUtil.TRANSITION] = 'all ' + (duration || 0.25) +\n\t\t        's cubic-bezier(0,0,' + (easeLinearity || 0.5) + ',1)';\n\n\t\tL.DomEvent.on(el, L.DomUtil.TRANSITION_END, this._onTransitionEnd, this);\n\t\tL.DomUtil.setPosition(el, newPos);\n\n\t\t// toggle reflow, Chrome flickers for some reason if you don't do this\n\t\tL.Util.falseFn(el.offsetWidth);\n\n\t\t// there's no native way to track value updates of transitioned properties, so we imitate this\n\t\tthis._stepTimer = setInterval(L.bind(this._onStep, this), 50);\n\t},\n\n\tstop: function () {\n\t\tif (!this._inProgress) { return; }\n\n\t\t// if we just removed the transition property, the element would jump to its final position,\n\t\t// so we need to make it stay at the current position\n\n\t\tL.DomUtil.setPosition(this._el, this._getPos());\n\t\tthis._onTransitionEnd();\n\t\tL.Util.falseFn(this._el.offsetWidth); // force reflow in case we are about to start a new animation\n\t},\n\n\t_onStep: function () {\n\t\tvar stepPos = this._getPos();\n\t\tif (!stepPos) {\n\t\t\tthis._onTransitionEnd();\n\t\t\treturn;\n\t\t}\n\t\t// jshint camelcase: false\n\t\t// make L.DomUtil.getPosition return intermediate position value during animation\n\t\tthis._el._leaflet_pos = stepPos;\n\n\t\tthis.fire('step');\n\t},\n\n\t// you can't easily get intermediate values of properties animated with CSS3 Transitions,\n\t// we need to parse computed style (in case of transform it returns matrix string)\n\n\t_transformRe: /([-+]?(?:\\d*\\.)?\\d+)\\D*, ([-+]?(?:\\d*\\.)?\\d+)\\D*\\)/,\n\n\t_getPos: function () {\n\t\tvar left, top, matches,\n\t\t    el = this._el,\n\t\t    style = window.getComputedStyle(el);\n\n\t\tif (L.Browser.any3d) {\n\t\t\tmatches = style[L.DomUtil.TRANSFORM].match(this._transformRe);\n\t\t\tif (!matches) { return; }\n\t\t\tleft = parseFloat(matches[1]);\n\t\t\ttop  = parseFloat(matches[2]);\n\t\t} else {\n\t\t\tleft = parseFloat(style.left);\n\t\t\ttop  = parseFloat(style.top);\n\t\t}\n\n\t\treturn new L.Point(left, top, true);\n\t},\n\n\t_onTransitionEnd: function () {\n\t\tL.DomEvent.off(this._el, L.DomUtil.TRANSITION_END, this._onTransitionEnd, this);\n\n\t\tif (!this._inProgress) { return; }\n\t\tthis._inProgress = false;\n\n\t\tthis._el.style[L.DomUtil.TRANSITION] = '';\n\n\t\t// jshint camelcase: false\n\t\t// make sure L.DomUtil.getPosition returns the final position value after animation\n\t\tthis._el._leaflet_pos = this._newPos;\n\n\t\tclearInterval(this._stepTimer);\n\n\t\tthis.fire('step').fire('end');\n\t}\n\n});\n\n\n/*\n * Extends L.Map to handle panning animations.\n */\n\nL.Map.include({\n\n\tsetView: function (center, zoom, options) {\n\n\t\tzoom = zoom === undefined ? this._zoom : this._limitZoom(zoom);\n\t\tcenter = this._limitCenter(L.latLng(center), zoom, this.options.maxBounds);\n\t\toptions = options || {};\n\n\t\tif (this._panAnim) {\n\t\t\tthis._panAnim.stop();\n\t\t}\n\n\t\tif (this._loaded && !options.reset && options !== true) {\n\n\t\t\tif (options.animate !== undefined) {\n\t\t\t\toptions.zoom = L.extend({animate: options.animate}, options.zoom);\n\t\t\t\toptions.pan = L.extend({animate: options.animate}, options.pan);\n\t\t\t}\n\n\t\t\t// try animating pan or zoom\n\t\t\tvar animated = (this._zoom !== zoom) ?\n\t\t\t\tthis._tryAnimatedZoom && this._tryAnimatedZoom(center, zoom, options.zoom) :\n\t\t\t\tthis._tryAnimatedPan(center, options.pan);\n\n\t\t\tif (animated) {\n\t\t\t\t// prevent resize handler call, the view will refresh after animation anyway\n\t\t\t\tclearTimeout(this._sizeTimer);\n\t\t\t\treturn this;\n\t\t\t}\n\t\t}\n\n\t\t// animation didn't start, just reset the map view\n\t\tthis._resetView(center, zoom);\n\n\t\treturn this;\n\t},\n\n\tpanBy: function (offset, options) {\n\t\toffset = L.point(offset).round();\n\t\toptions = options || {};\n\n\t\tif (!offset.x && !offset.y) {\n\t\t\treturn this;\n\t\t}\n\n\t\tif (!this._panAnim) {\n\t\t\tthis._panAnim = new L.PosAnimation();\n\n\t\t\tthis._panAnim.on({\n\t\t\t\t'step': this._onPanTransitionStep,\n\t\t\t\t'end': this._onPanTransitionEnd\n\t\t\t}, this);\n\t\t}\n\n\t\t// don't fire movestart if animating inertia\n\t\tif (!options.noMoveStart) {\n\t\t\tthis.fire('movestart');\n\t\t}\n\n\t\t// animate pan unless animate: false specified\n\t\tif (options.animate !== false) {\n\t\t\tL.DomUtil.addClass(this._mapPane, 'leaflet-pan-anim');\n\n\t\t\tvar newPos = this._getMapPanePos().subtract(offset);\n\t\t\tthis._panAnim.run(this._mapPane, newPos, options.duration || 0.25, options.easeLinearity);\n\t\t} else {\n\t\t\tthis._rawPanBy(offset);\n\t\t\tthis.fire('move').fire('moveend');\n\t\t}\n\n\t\treturn this;\n\t},\n\n\t_onPanTransitionStep: function () {\n\t\tthis.fire('move');\n\t},\n\n\t_onPanTransitionEnd: function () {\n\t\tL.DomUtil.removeClass(this._mapPane, 'leaflet-pan-anim');\n\t\tthis.fire('moveend');\n\t},\n\n\t_tryAnimatedPan: function (center, options) {\n\t\t// difference between the new and current centers in pixels\n\t\tvar offset = this._getCenterOffset(center)._floor();\n\n\t\t// don't animate too far unless animate: true specified in options\n\t\tif ((options && options.animate) !== true && !this.getSize().contains(offset)) { return false; }\n\n\t\tthis.panBy(offset, options);\n\n\t\treturn true;\n\t}\n});\n\n\n/*\n * L.PosAnimation fallback implementation that powers Leaflet pan animations\n * in browsers that don't support CSS3 Transitions.\n */\n\nL.PosAnimation = L.DomUtil.TRANSITION ? L.PosAnimation : L.PosAnimation.extend({\n\n\trun: function (el, newPos, duration, easeLinearity) { // (HTMLElement, Point[, Number, Number])\n\t\tthis.stop();\n\n\t\tthis._el = el;\n\t\tthis._inProgress = true;\n\t\tthis._duration = duration || 0.25;\n\t\tthis._easeOutPower = 1 / Math.max(easeLinearity || 0.5, 0.2);\n\n\t\tthis._startPos = L.DomUtil.getPosition(el);\n\t\tthis._offset = newPos.subtract(this._startPos);\n\t\tthis._startTime = +new Date();\n\n\t\tthis.fire('start');\n\n\t\tthis._animate();\n\t},\n\n\tstop: function () {\n\t\tif (!this._inProgress) { return; }\n\n\t\tthis._step();\n\t\tthis._complete();\n\t},\n\n\t_animate: function () {\n\t\t// animation loop\n\t\tthis._animId = L.Util.requestAnimFrame(this._animate, this);\n\t\tthis._step();\n\t},\n\n\t_step: function () {\n\t\tvar elapsed = (+new Date()) - this._startTime,\n\t\t    duration = this._duration * 1000;\n\n\t\tif (elapsed < duration) {\n\t\t\tthis._runFrame(this._easeOut(elapsed / duration));\n\t\t} else {\n\t\t\tthis._runFrame(1);\n\t\t\tthis._complete();\n\t\t}\n\t},\n\n\t_runFrame: function (progress) {\n\t\tvar pos = this._startPos.add(this._offset.multiplyBy(progress));\n\t\tL.DomUtil.setPosition(this._el, pos);\n\n\t\tthis.fire('step');\n\t},\n\n\t_complete: function () {\n\t\tL.Util.cancelAnimFrame(this._animId);\n\n\t\tthis._inProgress = false;\n\t\tthis.fire('end');\n\t},\n\n\t_easeOut: function (t) {\n\t\treturn 1 - Math.pow(1 - t, this._easeOutPower);\n\t}\n});\n\n\n/*\n * Extends L.Map to handle zoom animations.\n */\n\nL.Map.mergeOptions({\n\tzoomAnimation: true,\n\tzoomAnimationThreshold: 4\n});\n\nif (L.DomUtil.TRANSITION) {\n\n\tL.Map.addInitHook(function () {\n\t\t// don't animate on browsers without hardware-accelerated transitions or old Android/Opera\n\t\tthis._zoomAnimated = this.options.zoomAnimation && L.DomUtil.TRANSITION &&\n\t\t\t\tL.Browser.any3d && !L.Browser.android23 && !L.Browser.mobileOpera;\n\n\t\t// zoom transitions run with the same duration for all layers, so if one of transitionend events\n\t\t// happens after starting zoom animation (propagating to the map pane), we know that it ended globally\n\t\tif (this._zoomAnimated) {\n\t\t\tL.DomEvent.on(this._mapPane, L.DomUtil.TRANSITION_END, this._catchTransitionEnd, this);\n\t\t}\n\t});\n}\n\nL.Map.include(!L.DomUtil.TRANSITION ? {} : {\n\n\t_catchTransitionEnd: function (e) {\n\t\tif (this._animatingZoom && e.propertyName.indexOf('transform') >= 0) {\n\t\t\tthis._onZoomTransitionEnd();\n\t\t}\n\t},\n\n\t_nothingToAnimate: function () {\n\t\treturn !this._container.getElementsByClassName('leaflet-zoom-animated').length;\n\t},\n\n\t_tryAnimatedZoom: function (center, zoom, options) {\n\n\t\tif (this._animatingZoom) { return true; }\n\n\t\toptions = options || {};\n\n\t\t// don't animate if disabled, not supported or zoom difference is too large\n\t\tif (!this._zoomAnimated || options.animate === false || this._nothingToAnimate() ||\n\t\t        Math.abs(zoom - this._zoom) > this.options.zoomAnimationThreshold) { return false; }\n\n\t\t// offset is the pixel coords of the zoom origin relative to the current center\n\t\tvar scale = this.getZoomScale(zoom),\n\t\t    offset = this._getCenterOffset(center)._divideBy(1 - 1 / scale),\n\t\t\torigin = this._getCenterLayerPoint()._add(offset);\n\n\t\t// don't animate if the zoom origin isn't within one screen from the current center, unless forced\n\t\tif (options.animate !== true && !this.getSize().contains(offset)) { return false; }\n\n\t\tthis\n\t\t    .fire('movestart')\n\t\t    .fire('zoomstart');\n\n\t\tthis._animateZoom(center, zoom, origin, scale, null, true);\n\n\t\treturn true;\n\t},\n\n\t_animateZoom: function (center, zoom, origin, scale, delta, backwards, forTouchZoom) {\n\n\t\tif (!forTouchZoom) {\n\t\t\tthis._animatingZoom = true;\n\t\t}\n\n\t\t// put transform transition on all layers with leaflet-zoom-animated class\n\t\tL.DomUtil.addClass(this._mapPane, 'leaflet-zoom-anim');\n\n\t\t// remember what center/zoom to set after animation\n\t\tthis._animateToCenter = center;\n\t\tthis._animateToZoom = zoom;\n\n\t\t// disable any dragging during animation\n\t\tif (L.Draggable) {\n\t\t\tL.Draggable._disabled = true;\n\t\t}\n\n\t\tL.Util.requestAnimFrame(function () {\n\t\t\tthis.fire('zoomanim', {\n\t\t\t\tcenter: center,\n\t\t\t\tzoom: zoom,\n\t\t\t\torigin: origin,\n\t\t\t\tscale: scale,\n\t\t\t\tdelta: delta,\n\t\t\t\tbackwards: backwards\n\t\t\t});\n\t\t\t// horrible hack to work around a Chrome bug https://github.com/Leaflet/Leaflet/issues/3689\n\t\t\tsetTimeout(L.bind(this._onZoomTransitionEnd, this), 250);\n\t\t}, this);\n\t},\n\n\t_onZoomTransitionEnd: function () {\n\t\tif (!this._animatingZoom) { return; }\n\n\t\tthis._animatingZoom = false;\n\n\t\tL.DomUtil.removeClass(this._mapPane, 'leaflet-zoom-anim');\n\n\t\tL.Util.requestAnimFrame(function () {\n\t\t\tthis._resetView(this._animateToCenter, this._animateToZoom, true, true);\n\n\t\t\tif (L.Draggable) {\n\t\t\t\tL.Draggable._disabled = false;\n\t\t\t}\n\t\t}, this);\n\t}\n});\n\n\n/*\n\tZoom animation logic for L.TileLayer.\n*/\n\nL.TileLayer.include({\n\t_animateZoom: function (e) {\n\t\tif (!this._animating) {\n\t\t\tthis._animating = true;\n\t\t\tthis._prepareBgBuffer();\n\t\t}\n\n\t\tvar bg = this._bgBuffer,\n\t\t    transform = L.DomUtil.TRANSFORM,\n\t\t    initialTransform = e.delta ? L.DomUtil.getTranslateString(e.delta) : bg.style[transform],\n\t\t    scaleStr = L.DomUtil.getScaleString(e.scale, e.origin);\n\n\t\tbg.style[transform] = e.backwards ?\n\t\t\t\tscaleStr + ' ' + initialTransform :\n\t\t\t\tinitialTransform + ' ' + scaleStr;\n\t},\n\n\t_endZoomAnim: function () {\n\t\tvar front = this._tileContainer,\n\t\t    bg = this._bgBuffer;\n\n\t\tfront.style.visibility = '';\n\t\tfront.parentNode.appendChild(front); // Bring to fore\n\n\t\t// force reflow\n\t\tL.Util.falseFn(bg.offsetWidth);\n\n\t\tvar zoom = this._map.getZoom();\n\t\tif (zoom > this.options.maxZoom || zoom < this.options.minZoom) {\n\t\t\tthis._clearBgBuffer();\n\t\t}\n\n\t\tthis._animating = false;\n\t},\n\n\t_clearBgBuffer: function () {\n\t\tvar map = this._map;\n\n\t\tif (map && !map._animatingZoom && !map.touchZoom._zooming) {\n\t\t\tthis._bgBuffer.innerHTML = '';\n\t\t\tthis._bgBuffer.style[L.DomUtil.TRANSFORM] = '';\n\t\t}\n\t},\n\n\t_prepareBgBuffer: function () {\n\n\t\tvar front = this._tileContainer,\n\t\t    bg = this._bgBuffer;\n\n\t\t// if foreground layer doesn't have many tiles but bg layer does,\n\t\t// keep the existing bg layer and just zoom it some more\n\n\t\tvar bgLoaded = this._getLoadedTilesPercentage(bg),\n\t\t    frontLoaded = this._getLoadedTilesPercentage(front);\n\n\t\tif (bg && bgLoaded > 0.5 && frontLoaded < 0.5) {\n\n\t\t\tfront.style.visibility = 'hidden';\n\t\t\tthis._stopLoadingImages(front);\n\t\t\treturn;\n\t\t}\n\n\t\t// prepare the buffer to become the front tile pane\n\t\tbg.style.visibility = 'hidden';\n\t\tbg.style[L.DomUtil.TRANSFORM] = '';\n\n\t\t// switch out the current layer to be the new bg layer (and vice-versa)\n\t\tthis._tileContainer = bg;\n\t\tbg = this._bgBuffer = front;\n\n\t\tthis._stopLoadingImages(bg);\n\n\t\t//prevent bg buffer from clearing right after zoom\n\t\tclearTimeout(this._clearBgBufferTimer);\n\t},\n\n\t_getLoadedTilesPercentage: function (container) {\n\t\tvar tiles = container.getElementsByTagName('img'),\n\t\t    i, len, count = 0;\n\n\t\tfor (i = 0, len = tiles.length; i < len; i++) {\n\t\t\tif (tiles[i].complete) {\n\t\t\t\tcount++;\n\t\t\t}\n\t\t}\n\t\treturn count / len;\n\t},\n\n\t// stops loading all tiles in the background layer\n\t_stopLoadingImages: function (container) {\n\t\tvar tiles = Array.prototype.slice.call(container.getElementsByTagName('img')),\n\t\t    i, len, tile;\n\n\t\tfor (i = 0, len = tiles.length; i < len; i++) {\n\t\t\ttile = tiles[i];\n\n\t\t\tif (!tile.complete) {\n\t\t\t\ttile.onload = L.Util.falseFn;\n\t\t\t\ttile.onerror = L.Util.falseFn;\n\t\t\t\ttile.src = L.Util.emptyImageUrl;\n\n\t\t\t\ttile.parentNode.removeChild(tile);\n\t\t\t}\n\t\t}\n\t}\n});\n\n\n/*\r\n * Provides L.Map with convenient shortcuts for using browser geolocation features.\r\n */\r\n\r\nL.Map.include({\r\n\t_defaultLocateOptions: {\r\n\t\twatch: false,\r\n\t\tsetView: false,\r\n\t\tmaxZoom: Infinity,\r\n\t\ttimeout: 10000,\r\n\t\tmaximumAge: 0,\r\n\t\tenableHighAccuracy: false\r\n\t},\r\n\r\n\tlocate: function (/*Object*/ options) {\r\n\r\n\t\toptions = this._locateOptions = L.extend(this._defaultLocateOptions, options);\r\n\r\n\t\tif (!navigator.geolocation) {\r\n\t\t\tthis._handleGeolocationError({\r\n\t\t\t\tcode: 0,\r\n\t\t\t\tmessage: 'Geolocation not supported.'\r\n\t\t\t});\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tvar onResponse = L.bind(this._handleGeolocationResponse, this),\r\n\t\t\tonError = L.bind(this._handleGeolocationError, this);\r\n\r\n\t\tif (options.watch) {\r\n\t\t\tthis._locationWatchId =\r\n\t\t\t        navigator.geolocation.watchPosition(onResponse, onError, options);\r\n\t\t} else {\r\n\t\t\tnavigator.geolocation.getCurrentPosition(onResponse, onError, options);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tstopLocate: function () {\r\n\t\tif (navigator.geolocation) {\r\n\t\t\tnavigator.geolocation.clearWatch(this._locationWatchId);\r\n\t\t}\r\n\t\tif (this._locateOptions) {\r\n\t\t\tthis._locateOptions.setView = false;\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\t_handleGeolocationError: function (error) {\r\n\t\tvar c = error.code,\r\n\t\t    message = error.message ||\r\n\t\t            (c === 1 ? 'permission denied' :\r\n\t\t            (c === 2 ? 'position unavailable' : 'timeout'));\r\n\r\n\t\tif (this._locateOptions.setView && !this._loaded) {\r\n\t\t\tthis.fitWorld();\r\n\t\t}\r\n\r\n\t\tthis.fire('locationerror', {\r\n\t\t\tcode: c,\r\n\t\t\tmessage: 'Geolocation error: ' + message + '.'\r\n\t\t});\r\n\t},\r\n\r\n\t_handleGeolocationResponse: function (pos) {\r\n\t\tvar lat = pos.coords.latitude,\r\n\t\t    lng = pos.coords.longitude,\r\n\t\t    latlng = new L.LatLng(lat, lng),\r\n\r\n\t\t    latAccuracy = 180 * pos.coords.accuracy / 40075017,\r\n\t\t    lngAccuracy = latAccuracy / Math.cos(L.LatLng.DEG_TO_RAD * lat),\r\n\r\n\t\t    bounds = L.latLngBounds(\r\n\t\t            [lat - latAccuracy, lng - lngAccuracy],\r\n\t\t            [lat + latAccuracy, lng + lngAccuracy]),\r\n\r\n\t\t    options = this._locateOptions;\r\n\r\n\t\tif (options.setView) {\r\n\t\t\tvar zoom = Math.min(this.getBoundsZoom(bounds), options.maxZoom);\r\n\t\t\tthis.setView(latlng, zoom);\r\n\t\t}\r\n\r\n\t\tvar data = {\r\n\t\t\tlatlng: latlng,\r\n\t\t\tbounds: bounds,\r\n\t\t\ttimestamp: pos.timestamp\r\n\t\t};\r\n\r\n\t\tfor (var i in pos.coords) {\r\n\t\t\tif (typeof pos.coords[i] === 'number') {\r\n\t\t\t\tdata[i] = pos.coords[i];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.fire('locationfound', data);\r\n\t}\r\n});\r\n\n\n}(window, document));\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/leaflet/dist/leaflet-src.js\n// module id = 40\n// module chunks = 0","/*\n * leaflet-geocoder-mapzen\n * Leaflet plugin to search (geocode) using Mapzen Search or your\n * own hosted version of the Pelias Geocoder API.\n *\n * License: MIT\n * (c) Mapzen\n */\n;(function (factory) { // eslint-disable-line no-extra-semi\n  var L;\n  if (typeof define === 'function' && define.amd) {\n    // AMD\n    define(['leaflet'], factory);\n  } else if (typeof module !== 'undefined') {\n    // Node/CommonJS\n    L = require('leaflet');\n    module.exports = factory(L);\n  } else {\n    // Browser globals\n    if (typeof window.L === 'undefined') {\n      throw new Error('Leaflet must be loaded first');\n    }\n    factory(window.L);\n  }\n}(function (L) {\n  'use strict';\n\n  var MINIMUM_INPUT_LENGTH_FOR_AUTOCOMPLETE = 1;\n  var FULL_WIDTH_MARGIN = 20; // in pixels\n  var FULL_WIDTH_TOUCH_ADJUSTED_MARGIN = 4; // in pixels\n  var RESULTS_HEIGHT_MARGIN = 20; // in pixels\n  var API_RATE_LIMIT = 250; // in ms, throttled time between subsequent requests to API\n\n  L.Control.Geocoder = L.Control.extend({\n\n    includes: L.Mixin.Events,\n\n    options: {\n      position: 'topleft',\n      attribution: 'Geocoding by <a href=\"https://mapzen.com/projects/search/\">Mapzen</a>',\n      url: 'https://search.mapzen.com/v1',\n      placeholder: 'Search',\n      title: 'Search',\n      bounds: false,\n      latlng: null,\n      layers: null,\n      panToPoint: true,\n      pointIcon: true, // 'images/point_icon.png',\n      polygonIcon: true, // 'images/polygon_icon.png',\n      fullWidth: 650,\n      markers: true,\n      expanded: false,\n      autocomplete: true\n    },\n\n    initialize: function (apiKey, options) {\n      // For IE8 compatibility (if XDomainRequest is present),\n      // we set the default value of options.url to the protocol-relative\n      // version, because XDomainRequest does not allow http-to-https requests\n      // This is set first so it can always be overridden by the user\n      if (window.XDomainRequest) {\n        this.options.url = '//search.mapzen.com/v1';\n      }\n\n      // If the apiKey is omitted entirely and the\n      // first parameter is actually the options\n      if (typeof apiKey === 'object' && !!apiKey) {\n        options = apiKey;\n      } else {\n        this.apiKey = apiKey;\n      }\n\n      // Now merge user-specified options\n      L.Util.setOptions(this, options);\n      this.marker;\n      this.markers = [];\n    },\n\n    getLayers: function (params) {\n      var layers = this.options.layers;\n\n      if (!layers) {\n        return params;\n      }\n\n      params.layers = layers;\n      return params;\n    },\n\n    getBoundingBoxParam: function (params) {\n      /*\n       * this.options.bounds can be one of the following\n       * true //Boolean - take the map bounds\n       * false //Boolean - no bounds\n       * L.latLngBounds(...) //Object\n       * [[10, 10], [40, 60]] //Array\n      */\n      var bounds = this.options.bounds;\n\n      // If falsy, bail\n      if (!bounds) {\n        return params;\n      }\n\n      // If set to true, use map bounds\n      // If it is a valid L.LatLngBounds object, get its values\n      // If it is an array, try running it through L.LatLngBounds\n      if (bounds === true) {\n        bounds = this._map.getBounds();\n        params = makeParamsFromLeaflet(params, bounds);\n      } else if (typeof bounds === 'object' && bounds.isValid && bounds.isValid()) {\n        params = makeParamsFromLeaflet(params, bounds);\n      } else if (L.Util.isArray(bounds)) {\n        var latLngBounds = L.latLngBounds(bounds);\n        if (latLngBounds.isValid && latLngBounds.isValid()) {\n          params = makeParamsFromLeaflet(params, latLngBounds);\n        }\n      }\n\n      function makeParamsFromLeaflet (params, latLngBounds) {\n        params['boundary.rect.min_lon'] = latLngBounds.getWest();\n        params['boundary.rect.min_lat'] = latLngBounds.getSouth();\n        params['boundary.rect.max_lon'] = latLngBounds.getEast();\n        params['boundary.rect.max_lat'] = latLngBounds.getNorth();\n        return params;\n      }\n\n      return params;\n    },\n\n    getLatlngParam: function (params) {\n      /*\n       * this.options.latlng can be one of the following\n       * [50, 30] //Array\n       * {lon: 30, lat: 50} //Object\n       * {lat: 50, lng: 30} //Object\n       * L.latLng(50, 30) //Object\n       * true //Boolean - take the map center\n       * false //Boolean - No latlng to be considered\n      */\n      var latlng = this.options.latlng;\n\n      if (!latlng) {\n        return params;\n      }\n\n      if (latlng.constructor === Array) {\n        // TODO Check for array size, throw errors if invalid lat/lon\n        params['focus.point.lat'] = latlng[0];\n        params['focus.point.lon'] = latlng[1];\n      } else if (typeof latlng !== 'object') {\n        // fallback to the map's center L.latLng()\n        latlng = this._map.getCenter();\n        params['focus.point.lat'] = latlng.lat;\n        params['focus.point.lon'] = latlng.lng;\n      } else {\n        // TODO Check for valid L.LatLng Object or Object thats in the form of {lat:..,lon:..}\n        // TODO Check for valid lat/lon values, Error handling\n        params['focus.point.lat'] = latlng.lat;\n        params['focus.point.lon'] = latlng.lng ? latlng.lng : latlng.lon;\n      }\n\n      return params;\n    },\n\n    search: function (input) {\n      // Prevent lack of input from sending a malformed query to Pelias\n      if (!input) return;\n\n      var url = this.options.url + '/search';\n      var params = {\n        text: input\n      };\n\n      this.callPelias(url, params, 'search');\n    },\n\n    autocomplete: throttle(function (input) {\n      // Prevent lack of input from sending a malformed query to Pelias\n      if (!input) return;\n\n      var url = this.options.url + '/autocomplete';\n      var params = {\n        text: input\n      };\n\n      this.callPelias(url, params, 'autocomplete');\n    }, API_RATE_LIMIT),\n\n    // Timestamp of the last response which was successfully rendered to the UI.\n    // The time represents when the request was *sent*, not when it was recieved.\n    maxReqTimestampRendered: new Date().getTime(),\n\n    callPelias: function (endpoint, params, type) {\n      params = this.getBoundingBoxParam(params);\n      params = this.getLatlngParam(params);\n      params = this.getLayers(params);\n\n      // Search API key\n      if (this.apiKey) {\n        params.api_key = this.apiKey;\n      }\n\n      L.DomUtil.addClass(this._search, 'leaflet-pelias-loading');\n\n      // Track when the request began\n      var reqStartedAt = new Date().getTime();\n\n      AJAX.request(endpoint, params, function (err, results) {\n        L.DomUtil.removeClass(this._search, 'leaflet-pelias-loading');\n\n        if (err) {\n          var errorMessage;\n          switch (err.code) {\n            // Error codes.\n            // https://mapzen.com/documentation/search/http-status-codes/\n            case 403:\n              errorMessage = 'A valid API key is needed for this search feature.';\n              break;\n            case 404:\n              errorMessage = 'The search service cannot be found. :-(';\n              break;\n            case 408:\n              errorMessage = 'The search service took too long to respond. Try again in a second.';\n              break;\n            case 429:\n              errorMessage = 'There were too many requests. Try again in a second.';\n              break;\n            case 500:\n              errorMessage = 'The search service is not working right now. Please try again later.';\n              break;\n            case 502:\n              errorMessage = 'Connection lost. Please try again later.';\n              break;\n            // Note the status code is 0 if CORS is not enabled on the error response\n            default:\n              errorMessage = 'The search service is having problems :-(';\n              break;\n          }\n          this.showMessage(errorMessage);\n          this.fire('error', {\n            results: results,\n            endpoint: endpoint,\n            requestType: type,\n            params: params,\n            errorCode: err.code,\n            errorMessage: errorMessage\n          });\n        }\n\n        if (results && results.features) {\n          // Ignore requests that started before a request which has already\n          // been successfully rendered on to the UI.\n          if (this.maxReqTimestampRendered < reqStartedAt) {\n            this.maxReqTimestampRendered = reqStartedAt;\n            this.showResults(results.features);\n            this.fire('results', {\n              results: results,\n              endpoint: endpoint,\n              requestType: type,\n              params: params\n            });\n          }\n          // Else ignore the request, it is stale.\n        }\n      }, this);\n    },\n\n    highlight: function (text, focus) {\n      var r = RegExp('(' + escapeRegExp(focus) + ')', 'gi');\n      return text.replace(r, '<strong>$1</strong>');\n    },\n\n    getIconType: function (layer) {\n      var pointIcon = this.options.pointIcon;\n      var polygonIcon = this.options.polygonIcon;\n      var classPrefix = 'leaflet-pelias-layer-icon-';\n\n      if (layer.match('venue') || layer.match('address')) {\n        if (pointIcon === true) {\n          return {\n            type: 'class',\n            value: classPrefix + 'point'\n          };\n        } else if (pointIcon === false) {\n          return false;\n        } else {\n          return {\n            type: 'image',\n            value: pointIcon\n          };\n        }\n      } else {\n        if (polygonIcon === true) {\n          return {\n            type: 'class',\n            value: classPrefix + 'polygon'\n          };\n        } else if (polygonIcon === false) {\n          return false;\n        } else {\n          return {\n            type: 'image',\n            value: polygonIcon\n          };\n        }\n      }\n    },\n\n    showResults: function (features) {\n      // Exit function if there are no features\n      if (features.length === 0) {\n        this.showMessage('No results were found.');\n        return;\n      }\n\n      var resultsContainer = this._results;\n\n      // Reset and display results container\n      resultsContainer.innerHTML = '';\n      resultsContainer.style.display = 'block';\n      // manage result box height\n      resultsContainer.style.maxHeight = (this._map.getSize().y - resultsContainer.offsetTop - this._container.offsetTop - RESULTS_HEIGHT_MARGIN) + 'px';\n\n      var list = L.DomUtil.create('ul', 'leaflet-pelias-list', resultsContainer);\n\n      for (var i = 0, j = features.length; i < j; i++) {\n        var feature = features[i];\n        var resultItem = L.DomUtil.create('li', 'leaflet-pelias-result', list);\n\n        resultItem.feature = feature;\n        resultItem.layer = feature.properties.layer;\n\n        // Deprecated\n        // Use L.GeoJSON.coordsToLatLng(resultItem.feature.geometry.coordinates) instead\n        // This returns a L.LatLng object that can be used throughout Leaflet\n        resultItem.coords = feature.geometry.coordinates;\n\n        var icon = this.getIconType(feature.properties.layer);\n        if (icon) {\n          // Point or polygon icon\n          // May be a class or an image path\n          var layerIconContainer = L.DomUtil.create('span', 'leaflet-pelias-layer-icon-container', resultItem);\n          var layerIcon;\n\n          if (icon.type === 'class') {\n            layerIcon = L.DomUtil.create('div', 'leaflet-pelias-layer-icon ' + icon.value, layerIconContainer);\n          } else {\n            layerIcon = L.DomUtil.create('img', 'leaflet-pelias-layer-icon', layerIconContainer);\n            layerIcon.src = icon.value;\n          }\n\n          layerIcon.title = 'layer: ' + feature.properties.layer;\n        }\n\n        if (this._input.value.length > 0) {\n          resultItem.innerHTML += this.highlight(feature.properties.label, this._input.value);\n        }\n      }\n    },\n\n    showMessage: function (text) {\n      var resultsContainer = this._results;\n\n      // Reset and display results container\n      resultsContainer.innerHTML = '';\n      resultsContainer.style.display = 'block';\n\n      var messageEl = L.DomUtil.create('div', 'leaflet-pelias-message', resultsContainer);\n      messageEl.textContent = text;\n    },\n\n    removeMarkers: function () {\n      if (this.options.markers) {\n        for (var i = 0; i < this.markers.length; i++) {\n          this._map.removeLayer(this.markers[i]);\n        }\n        this.markers = [];\n      }\n    },\n\n    showMarker: function (text, latlng) {\n      this.removeMarkers();\n      this._map.setView(latlng, this._map.getZoom() || 8);\n\n      var markerOptions = (typeof this.options.markers === 'object') ? this.options.markers : {};\n\n      if (this.options.markers) {\n        this.marker = new L.marker(latlng, markerOptions).bindPopup(text); // eslint-disable-line new-cap\n        this._map.addLayer(this.marker);\n        this.markers.push(this.marker);\n        this.marker.openPopup();\n      }\n    },\n\n    setSelectedResult: function (selected, originalEvent) {\n      var latlng = L.GeoJSON.coordsToLatLng(selected.feature.geometry.coordinates);\n      this._input.value = selected.innerText || selected.textContent;\n      this.showMarker(selected.innerHTML, latlng);\n      this.fire('select', {\n        originalEvent: originalEvent,\n        latlng: latlng,\n        feature: selected.feature\n      });\n      this.blur();\n    },\n\n    resetInput: function () {\n      this._input.value = '';\n      L.DomUtil.addClass(this._close, 'leaflet-pelias-hidden');\n      this.removeMarkers();\n      this._input.focus();\n      this.fire('reset');\n    },\n\n    // Removes focus from geocoder control\n    blur: function () {\n      this.clearResults();\n      if (this._input.value === '' && this._results.style.display !== 'none') {\n        L.DomUtil.addClass(this._close, 'leaflet-pelias-hidden');\n        if (!this.options.expanded) {\n          this.collapse();\n        }\n      }\n    },\n\n    clearResults: function () {\n      // Hide results from view\n      this._results.style.display = 'none';\n\n      // Destroy contents if input has also cleared\n      if (this._input.value === '') {\n        this._results.innerHTML = '';\n      }\n    },\n\n    expand: function () {\n      L.DomUtil.addClass(this._container, 'leaflet-pelias-expanded');\n      this.setFullWidth();\n      this.fire('expand');\n    },\n\n    collapse: function () {\n      // 'expanded' options check happens outside of this function now\n      // So it's now possible for a script to force-collapse a geocoder\n      // that otherwise defaults to the always-expanded state\n      L.DomUtil.removeClass(this._container, 'leaflet-pelias-expanded');\n      this._input.blur();\n      this.clearFullWidth();\n      this.clearResults();\n      this.fire('collapse');\n    },\n\n    // Set full width of expanded input, if enabled\n    setFullWidth: function () {\n      if (this.options.fullWidth) {\n        // If fullWidth setting is a number, only expand if map container\n        // is smaller than that breakpoint. Otherwise, clear width\n        // Always ask map to invalidate and recalculate size first\n        this._map.invalidateSize();\n        var mapWidth = this._map.getSize().x;\n        var touchAdjustment = L.Browser.touch ? FULL_WIDTH_TOUCH_ADJUSTED_MARGIN : 0;\n        var width = mapWidth - FULL_WIDTH_MARGIN - touchAdjustment;\n        if (typeof this.options.fullWidth === 'number' && mapWidth >= window.parseInt(this.options.fullWidth, 10)) {\n          this.clearFullWidth();\n          return;\n        }\n        this._container.style.width = width.toString() + 'px';\n      }\n    },\n\n    clearFullWidth: function () {\n      // Clear set width, if any\n      if (this.options.fullWidth) {\n        this._container.style.width = '';\n      }\n    },\n\n    onAdd: function (map) {\n      var container = L.DomUtil.create('div',\n          'leaflet-pelias-control leaflet-bar leaflet-control');\n\n      this._body = document.body || document.getElementsByTagName('body')[0];\n      this._container = container;\n      this._input = L.DomUtil.create('input', 'leaflet-pelias-input', this._container);\n      this._input.spellcheck = false;\n\n      // Only set if title option is not null or falsy\n      if (this.options.title) {\n        this._input.title = this.options.title;\n      }\n\n      // Only set if placeholder option is not null or falsy\n      if (this.options.placeholder) {\n        this._input.placeholder = this.options.placeholder;\n      }\n\n      this._search = L.DomUtil.create('a', 'leaflet-pelias-search-icon', this._container);\n      this._close = L.DomUtil.create('div', 'leaflet-pelias-close leaflet-pelias-hidden', this._container);\n      this._close.innerHTML = '×';\n      this._close.title = 'Close';\n\n      this._results = L.DomUtil.create('div', 'leaflet-pelias-results leaflet-bar', this._container);\n\n      if (this.options.expanded) {\n        this.expand();\n      }\n\n      L.DomEvent\n        .on(this._container, 'click', function (e) {\n          // Other listeners should call stopProgation() to\n          // prevent this from firing too greedily\n          this._input.focus();\n        }, this)\n        .on(this._input, 'focus', function (e) {\n          if (this._input.value) {\n            this._results.style.display = 'block';\n          }\n        }, this)\n        .on(this._map, 'click', function (e) {\n          // Does what you might expect a _input.blur() listener might do,\n          // but since that would fire for any reason (e.g. clicking a result)\n          // what you really want is to blur from the control by listening to clicks on the map\n          this.blur();\n        }, this)\n        .on(this._search, 'click', function (e) {\n          L.DomEvent.stopPropagation(e);\n\n          // Toggles expanded state of container on click of search icon\n          if (L.DomUtil.hasClass(this._container, 'leaflet-pelias-expanded')) {\n            // If expanded option is true, just focus the input\n            if (this.options.expanded === true) {\n              this._input.focus();\n              return;\n            } else {\n              // Otherwise, toggle to hidden state\n              L.DomUtil.addClass(this._close, 'leaflet-pelias-hidden');\n              this.collapse();\n            }\n          } else {\n            // If not currently expanded, clicking here always expands it\n            if (this._input.value.length > 0) {\n              L.DomUtil.removeClass(this._close, 'leaflet-pelias-hidden');\n            }\n            this.expand();\n            this._input.focus();\n          }\n        }, this)\n        .on(this._close, 'click', function (e) {\n          this.resetInput();\n          this.clearResults();\n          L.DomEvent.stopPropagation(e);\n        }, this)\n        .on(this._input, 'keydown', function (e) {\n          var list = this._results.querySelectorAll('.leaflet-pelias-result');\n          var selected = this._results.querySelectorAll('.leaflet-pelias-selected')[0];\n          var selectedPosition;\n          var self = this;\n          var panToPoint = function (shouldPan) {\n            var _selected = self._results.querySelectorAll('.leaflet-pelias-selected')[0];\n            if (_selected && shouldPan) {\n              self.showMarker(_selected.innerHTML, L.GeoJSON.coordsToLatLng(_selected.feature.geometry.coordinates));\n            }\n          };\n\n          var scrollSelectedResultIntoView = function () {\n            var _selected = self._results.querySelectorAll('.leaflet-pelias-selected')[0];\n            var _selectedRect = _selected.getBoundingClientRect();\n            var _resultsRect = self._results.getBoundingClientRect();\n            // Is the selected element not visible?\n            if (_selectedRect.bottom > _resultsRect.bottom) {\n              self._results.scrollTop = _selected.offsetTop + _selected.offsetHeight - self._results.offsetHeight;\n            } else if (_selectedRect.top < _resultsRect.top) {\n              self._results.scrollTop = _selected.offsetTop;\n            }\n          };\n\n          for (var i = 0; i < list.length; i++) {\n            if (list[i] === selected) {\n              selectedPosition = i;\n              break;\n            }\n          }\n\n          // TODO cleanup\n          switch (e.keyCode) {\n            // 13 = enter\n            case 13:\n              if (selected) {\n                this.setSelectedResult(selected, e);\n              } else {\n                // perform a full text search on enter\n                var text = (e.target || e.srcElement).value;\n                this.search(text);\n              }\n              L.DomEvent.preventDefault(e);\n              break;\n            // 38 = up arrow\n            case 38:\n              // Ignore key if there are no results or if list is not visible\n              if (list.length === 0 || this._results.style.display === 'none') {\n                return;\n              }\n\n              if (selected) {\n                L.DomUtil.removeClass(selected, 'leaflet-pelias-selected');\n              }\n\n              var previousItem = list[selectedPosition - 1];\n              var highlighted = (selected && previousItem) ? previousItem : list[list.length - 1]; // eslint-disable-line no-redeclare\n\n              L.DomUtil.addClass(highlighted, 'leaflet-pelias-selected');\n              scrollSelectedResultIntoView();\n              panToPoint(this.options.panToPoint);\n              this.fire('highlight', {\n                originalEvent: e,\n                latlng: L.GeoJSON.coordsToLatLng(highlighted.feature.geometry.coordinates),\n                feature: highlighted.feature\n              });\n\n              L.DomEvent.preventDefault(e);\n              break;\n            // 40 = down arrow\n            case 40:\n              // Ignore key if there are no results or if list is not visible\n              if (list.length === 0 || this._results.style.display === 'none') {\n                return;\n              }\n\n              if (selected) {\n                L.DomUtil.removeClass(selected, 'leaflet-pelias-selected');\n              }\n\n              var nextItem = list[selectedPosition + 1];\n              var highlighted = (selected && nextItem) ? nextItem : list[0]; // eslint-disable-line no-redeclare\n\n              L.DomUtil.addClass(highlighted, 'leaflet-pelias-selected');\n              scrollSelectedResultIntoView();\n              panToPoint(this.options.panToPoint);\n              this.fire('highlight', {\n                originalEvent: e,\n                latlng: L.GeoJSON.coordsToLatLng(highlighted.feature.geometry.coordinates),\n                feature: highlighted.feature\n              });\n\n              L.DomEvent.preventDefault(e);\n              break;\n            // all other keys\n            default:\n              break;\n          }\n        }, this)\n        .on(this._input, 'keyup', function (e) {\n          var key = e.which || e.keyCode;\n          var text = (e.target || e.srcElement).value;\n\n          if (this._input.value.length > 0) {\n            L.DomUtil.removeClass(this._close, 'leaflet-pelias-hidden');\n          } else {\n            L.DomUtil.addClass(this._close, 'leaflet-pelias-hidden');\n          }\n\n          // Ignore all further action if the keycode matches an arrow\n          // key (handled via keydown event)\n          if (key === 13 || key === 38 || key === 40) {\n            return;\n          }\n\n          // keyCode 27 = esc key (esc should clear results)\n          if (key === 27) {\n            // If input is blank or results have already been cleared\n            // (perhaps due to a previous 'esc') then pressing esc at\n            // this point will blur from input as well.\n            if (text.length === 0 || this._results.style.display === 'none') {\n              this._input.blur();\n\n              if (L.DomUtil.hasClass(this._container, 'leaflet-pelias-expanded')) {\n                if (!this.options.expanded) {\n                  this.collapse();\n                }\n                this.clearResults();\n              }\n            }\n            // Clears results\n            this._results.innerHTML = '';\n            this._results.style.display = 'none';\n            L.DomUtil.removeClass(this._search, 'leaflet-pelias-loading');\n            return;\n          }\n\n          if (this._input.value !== this._lastValue) {\n            this._lastValue = this._input.value;\n\n            if (text.length >= MINIMUM_INPUT_LENGTH_FOR_AUTOCOMPLETE && this.options.autocomplete === true) {\n              this.autocomplete(text);\n            } else {\n              this.clearResults();\n            }\n          }\n        }, this)\n        .on(this._results, 'click', function (e) {\n          L.DomEvent.preventDefault(e);\n          L.DomEvent.stopPropagation(e);\n\n          var _selected = this._results.querySelectorAll('.leaflet-pelias-selected')[0];\n          if (_selected) {\n            L.DomUtil.removeClass(_selected, 'leaflet-pelias-selected');\n          }\n\n          var selected = e.target || e.srcElement; /* IE8 */\n          var findParent = function () {\n            if (!L.DomUtil.hasClass(selected, 'leaflet-pelias-result')) {\n              selected = selected.parentElement;\n              if (selected) {\n                findParent();\n              }\n            }\n            return selected;\n          };\n\n          // click event can be registered on the child nodes\n          // that does not have the required coords prop\n          // so its important to find the parent.\n          findParent();\n\n          // If nothing is selected, (e.g. it's a message, not a result),\n          // do nothing.\n          if (selected) {\n            L.DomUtil.addClass(selected, 'leaflet-pelias-selected');\n            this.setSelectedResult(selected, e);\n          }\n        }, this)\n        .on(this._results, 'mouseover', function (e) {\n          // Prevent scrolling over results list from zooming the map, if enabled\n          this._scrollWheelZoomEnabled = map.scrollWheelZoom.enabled();\n          if (this._scrollWheelZoomEnabled) {\n            map.scrollWheelZoom.disable();\n          }\n        }, this)\n        .on(this._results, 'mouseout', function (e) {\n          // Re-enable scroll wheel zoom (if previously enabled) after\n          // leaving the results box\n          if (this._scrollWheelZoomEnabled) {\n            map.scrollWheelZoom.enable();\n          }\n        }, this);\n\n      // Recalculate width of the input bar when window resizes\n      if (this.options.fullWidth) {\n        L.DomEvent.on(window, 'resize', function (e) {\n          if (L.DomUtil.hasClass(this._container, 'leaflet-pelias-expanded')) {\n            this.setFullWidth();\n          }\n        }, this);\n      }\n\n      // Collapse an empty input bar when user interacts with the map\n      // Disabled if expanded is set to true\n      if (!this.options.expanded) {\n        L.DomEvent.on(this._map, 'mousedown', this._onMapInteraction, this);\n        L.DomEvent.on(this._map, 'touchstart', this._onMapInteraction, this);\n      }\n\n      L.DomEvent.disableClickPropagation(this._container);\n      if (map.attributionControl) {\n        map.attributionControl.addAttribution(this.options.attribution);\n      }\n      return container;\n    },\n\n    _onMapInteraction: function (event) {\n      // Only collapse if the input is clear, and is currently expanded.\n      if (!this._input.value && L.DomUtil.hasClass(this._container, 'leaflet-pelias-expanded')) {\n        this.collapse();\n      }\n    },\n\n    onRemove: function (map) {\n      map.attributionControl.removeAttribution(this.options.attribution);\n    }\n  });\n\n  L.control.geocoder = function (apiKey, options) {\n    return new L.Control.Geocoder(apiKey, options);\n  };\n\n  /*\n   * AJAX Utility function (implements basic HTTP get)\n   */\n  var AJAX = {\n    serialize: function (params) {\n      var data = '';\n\n      for (var key in params) {\n        if (params.hasOwnProperty(key)) {\n          var param = params[key];\n          var type = param.toString();\n          var value;\n\n          if (data.length) {\n            data += '&';\n          }\n\n          switch (type) {\n            case '[object Array]':\n              value = (param[0].toString() === '[object Object]') ? JSON.stringify(param) : param.join(',');\n              break;\n            case '[object Object]':\n              value = JSON.stringify(param);\n              break;\n            case '[object Date]':\n              value = param.valueOf();\n              break;\n            default:\n              value = param;\n              break;\n          }\n\n          data += encodeURIComponent(key) + '=' + encodeURIComponent(value);\n        }\n      }\n\n      return data;\n    },\n    http_request: function (callback, context) {\n      if (window.XDomainRequest) {\n        return this.xdr(callback, context);\n      } else {\n        return this.xhr(callback, context);\n      }\n    },\n    xhr: function (callback, context) {\n      var xhr = new XMLHttpRequest();\n\n      xhr.onerror = function (e) {\n        xhr.onreadystatechange = L.Util.falseFn;\n        var error = {\n          code: xhr.status,\n          message: xhr.statusText\n        };\n\n        callback.call(context, error, null);\n      };\n\n      xhr.onreadystatechange = function () {\n        var response;\n        var error;\n\n        if (xhr.readyState === 4) {\n          // Handle all non-200 responses first\n          if (xhr.status !== 200) {\n            error = {\n              code: xhr.status,\n              message: xhr.statusText\n            };\n            callback.call(context, error, null);\n          } else {\n            try {\n              response = JSON.parse(xhr.responseText);\n            } catch (e) {\n              response = null;\n              error = {\n                code: 500,\n                message: 'Parse Error'\n              };\n            }\n\n            if (!error && response.error) {\n              error = response.error;\n              response = null;\n            }\n\n            xhr.onerror = L.Util.falseFn;\n\n            callback.call(context, error, response);\n          }\n        }\n      };\n\n      return xhr;\n    },\n    xdr: function (callback, context) {\n      var xdr = new window.XDomainRequest();\n\n      xdr.onerror = function (e) {\n        xdr.onload = L.Util.falseFn;\n\n        // XDRs have no access to actual status codes\n        var error = {\n          code: 500,\n          message: 'XMLHttpRequest Error'\n        };\n        callback.call(context, error, null);\n      };\n\n      // XDRs have .onload instead of .onreadystatechange\n      xdr.onload = function () {\n        var response;\n        var error;\n\n        try {\n          response = JSON.parse(xdr.responseText);\n        } catch (e) {\n          response = null;\n          error = {\n            code: 500,\n            message: 'Parse Error'\n          };\n        }\n\n        if (!error && response.error) {\n          error = response.error;\n          response = null;\n        }\n\n        xdr.onerror = L.Util.falseFn;\n        callback.call(context, error, response);\n      };\n\n      return xdr;\n    },\n    request: function (url, params, callback, context) {\n      var paramString = this.serialize(params);\n      var httpRequest = this.http_request(callback, context);\n\n      httpRequest.open('GET', url + '?' + paramString);\n      if (httpRequest.constructor.name === 'XMLHttpRequest') {\n        httpRequest.setRequestHeader('Accept', 'application/json');\n      }\n\n      setTimeout(function () {\n        httpRequest.send(null);\n      }, 0);\n    }\n  };\n\n  /*\n   * throttle Utility function (borrowed from underscore)\n   */\n  function throttle (func, wait, options) {\n    var context, args, result;\n    var timeout = null;\n    var previous = 0;\n    if (!options) options = {};\n    var later = function () {\n      previous = options.leading === false ? 0 : new Date().getTime();\n      timeout = null;\n      result = func.apply(context, args);\n      if (!timeout) context = args = null;\n    };\n    return function () {\n      var now = new Date().getTime();\n      if (!previous && options.leading === false) previous = now;\n      var remaining = wait - (now - previous);\n      context = this;\n      args = arguments;\n      if (remaining <= 0 || remaining > wait) {\n        if (timeout) {\n          clearTimeout(timeout);\n          timeout = null;\n        }\n        previous = now;\n        result = func.apply(context, args);\n        if (!timeout) context = args = null;\n      } else if (!timeout && options.trailing !== false) {\n        timeout = setTimeout(later, remaining);\n      }\n      return result;\n    };\n  }\n\n  /*\n   * escaping a string for regex Utility function\n   * from https://stackoverflow.com/questions/3446170/escape-string-for-use-in-javascript-regex\n   */\n  function escapeRegExp (str) {\n    return str.replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, '\\\\$&');\n  }\n}));\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/leaflet-geocoder-mapzen/dist/leaflet-geocoder-mapzen.js\n// module id = 41\n// module chunks = 0","/*\n\tLeaflet.contextmenu, a context menu for Leaflet.\n\t(c) 2015, Adam Ratcliffe, GeoSmart Maps Limited\n\n\t@preserve\n*/\n\n(function(factory) {\n\t// Packaging/modules magic dance\n\tvar L;\n\tif (typeof define === 'function' && define.amd) {\n\t\t// AMD\n\t\tdefine(['leaflet'], factory);\n\t} else if (typeof module === 'object' && typeof module.exports === 'object') {\n\t\t// Node/CommonJS\n\t\tL = require('leaflet');\n\t\tmodule.exports = factory(L);\n\t} else {\n\t\t// Browser globals\n\t\tif (typeof window.L === 'undefined') {\n\t\t\tthrow new Error('Leaflet must be loaded first');\n\t\t}\n\t\tfactory(window.L);\n\t}\n})(function(L) {\nL.Map.mergeOptions({\n    contextmenuItems: []\n});\n\nL.Map.ContextMenu = L.Handler.extend({\n    _touchstart: L.Browser.msPointer ? 'MSPointerDown' : L.Browser.pointer ? 'pointerdown' : 'touchstart',\n    \n    statics: {\n        BASE_CLS: 'leaflet-contextmenu'\n    },\n    \n    initialize: function (map) {\n        L.Handler.prototype.initialize.call(this, map);\n        \n        this._items = [];\n        this._visible = false;\n\n        var container = this._container = L.DomUtil.create('div', L.Map.ContextMenu.BASE_CLS, map._container);\n        container.style.zIndex = 10000;\n        container.style.position = 'absolute';\n\n        if (map.options.contextmenuWidth) {\n            container.style.width = map.options.contextmenuWidth + 'px';\n        }\n\n        this._createItems();\n\n        L.DomEvent\n            .on(container, 'click', L.DomEvent.stop)\n            .on(container, 'mousedown', L.DomEvent.stop)\n            .on(container, 'dblclick', L.DomEvent.stop)\n            .on(container, 'contextmenu', L.DomEvent.stop);\n    },\n\n    addHooks: function () {\n        var container = this._map.getContainer();\n\n        L.DomEvent\n            .on(container, 'mouseleave', this._hide, this)\n            .on(document, 'keydown', this._onKeyDown, this);\n\n        if (L.Browser.touch) {\n            L.DomEvent.on(document, this._touchstart, this._hide, this);\n        }\n\n        this._map.on({\n            contextmenu: this._show,\n            mousedown: this._hide,\n            movestart: this._hide,\n            zoomstart: this._hide\n        }, this);\n    },\n\n    removeHooks: function () {\n        var container = this._map.getContainer();\n\n        L.DomEvent\n            .off(container, 'mouseleave', this._hide, this)\n            .off(document, 'keydown', this._onKeyDown, this);\n\n        if (L.Browser.touch) {\n            L.DomEvent.off(document, this._touchstart, this._hide, this);\n        }\n\n        this._map.off({\n            contextmenu: this._show,\n            mousedown: this._hide,\n            movestart: this._hide,\n            zoomstart: this._hide\n        }, this);\n    },\n\n    showAt: function (point, data) {\n        if (point instanceof L.LatLng) {\n            point = this._map.latLngToContainerPoint(point);\n        }\n        this._showAtPoint(point, data);\n    },\n\n    hide: function () {\n        this._hide();\n    },\n\n    addItem: function (options) {\n        return this.insertItem(options);\n    },\n\n    insertItem: function (options, index) {\n        index = index !== undefined ? index: this._items.length;\n\n        var item = this._createItem(this._container, options, index);\n\n        this._items.push(item);\n\n        this._sizeChanged = true;\n\n        this._map.fire('contextmenu.additem', {\n            contextmenu: this,\n            el: item.el,\n            index: index\n        });\n\n        return item.el;\n    },\n\n    removeItem: function (item) {\n        var container = this._container;\n\n        if (!isNaN(item)) {\n            item = container.children[item];\n        }\n\n        if (item) {\n            this._removeItem(L.Util.stamp(item));\n\n            this._sizeChanged = true;\n\n            this._map.fire('contextmenu.removeitem', {\n                contextmenu: this,\n                el: item\n            });\n\n            return item;\n        }\n\n        return null;\n    },\n\n    removeAllItems: function () {\n        var items = this._container.children,\n            item;\n\n        while (items.length) {\n            item = items[0];\n            this._removeItem(L.Util.stamp(item));\n        }\n        return items;\n    },\n\n    hideAllItems: function () {\n        var item, i, l;\n\n        for (i = 0, l = this._items.length; i < l; i++) {\n            item = this._items[i];\n            item.el.style.display = 'none';\n        }\n    },\n\n    showAllItems: function () {\n        var item, i, l;\n\n        for (i = 0, l = this._items.length; i < l; i++) {\n            item = this._items[i];\n            item.el.style.display = '';\n        }\n    },\n\n    setDisabled: function (item, disabled) {\n        var container = this._container,\n        itemCls = L.Map.ContextMenu.BASE_CLS + '-item';\n\n        if (!isNaN(item)) {\n            item = container.children[item];\n        }\n\n        if (item && L.DomUtil.hasClass(item, itemCls)) {\n            if (disabled) {\n                L.DomUtil.addClass(item, itemCls + '-disabled');\n                this._map.fire('contextmenu.disableitem', {\n                    contextmenu: this,\n                    el: item\n                });\n            } else {\n                L.DomUtil.removeClass(item, itemCls + '-disabled');\n                this._map.fire('contextmenu.enableitem', {\n                    contextmenu: this,\n                    el: item\n                });\n            }\n        }\n    },\n\n    isVisible: function () {\n        return this._visible;\n    },\n\n    _createItems: function () {\n        var itemOptions = this._map.options.contextmenuItems,\n            item,\n            i, l;\n\n        for (i = 0, l = itemOptions.length; i < l; i++) {\n            this._items.push(this._createItem(this._container, itemOptions[i]));\n        }\n    },\n\n    _createItem: function (container, options, index) {\n        if (options.separator || options === '-') {\n            return this._createSeparator(container, index);\n        }\n\n        var itemCls = L.Map.ContextMenu.BASE_CLS + '-item',\n            cls = options.disabled ? (itemCls + ' ' + itemCls + '-disabled') : itemCls,\n            el = this._insertElementAt('a', cls, container, index),\n            callback = this._createEventHandler(el, options.callback, options.context, options.hideOnSelect),\n            icon = this._getIcon(options),\n            iconCls = this._getIconCls(options),\n            html = '';\n\n        if (icon) {\n            html = '<img class=\"' + L.Map.ContextMenu.BASE_CLS + '-icon\" src=\"' + icon + '\"/>';\n        } else if (iconCls) {\n            html = '<span class=\"' + L.Map.ContextMenu.BASE_CLS + '-icon ' + iconCls + '\"></span>';\n        }\n\n        el.innerHTML = html + options.text;\n        el.href = '#';\n\n        L.DomEvent\n            .on(el, 'mouseover', this._onItemMouseOver, this)\n            .on(el, 'mouseout', this._onItemMouseOut, this)\n            .on(el, 'mousedown', L.DomEvent.stopPropagation)\n            .on(el, 'click', callback);\n\n        if (L.Browser.touch) {\n            L.DomEvent.on(el, this._touchstart, L.DomEvent.stopPropagation);\n        }\n\n        // Devices without a mouse fire \"mouseover\" on tap, but never “mouseout\"\n        if (!L.Browser.pointer) {\n            L.DomEvent.on(el, 'click', this._onItemMouseOut, this);\n        }\n\n        return {\n            id: L.Util.stamp(el),\n            el: el,\n            callback: callback\n        };\n    },\n\n    _removeItem: function (id) {\n        var item,\n            el,\n            i, l, callback;\n\n        for (i = 0, l = this._items.length; i < l; i++) {\n            item = this._items[i];\n\n            if (item.id === id) {\n                el = item.el;\n                callback = item.callback;\n\n                if (callback) {\n                    L.DomEvent\n                        .off(el, 'mouseover', this._onItemMouseOver, this)\n                        .off(el, 'mouseover', this._onItemMouseOut, this)\n                        .off(el, 'mousedown', L.DomEvent.stopPropagation)\n                        .off(el, 'click', callback);\n\n                    if (L.Browser.touch) {\n                        L.DomEvent.off(el, this._touchstart, L.DomEvent.stopPropagation);\n                    }\n\n                    if (!L.Browser.pointer) {\n                        L.DomEvent.on(el, 'click', this._onItemMouseOut, this);\n                    }\n                }\n\n                this._container.removeChild(el);\n                this._items.splice(i, 1);\n\n                return item;\n            }\n        }\n        return null;\n    },\n\n    _createSeparator: function (container, index) {\n        var el = this._insertElementAt('div', L.Map.ContextMenu.BASE_CLS + '-separator', container, index);\n\n        return {\n            id: L.Util.stamp(el),\n            el: el\n        };\n    },\n\n    _createEventHandler: function (el, func, context, hideOnSelect) {\n        var me = this,\n            map = this._map,\n            disabledCls = L.Map.ContextMenu.BASE_CLS + '-item-disabled',\n            hideOnSelect = (hideOnSelect !== undefined) ? hideOnSelect : true;\n\n        return function (e) {\n            if (L.DomUtil.hasClass(el, disabledCls)) {\n                return;\n            }\n\n            if (hideOnSelect) {\n                me._hide();\n            }\n\n            if (func) {\n                func.call(context || map, me._showLocation);\n            }\n\n            me._map.fire('contextmenu.select', {\n                contextmenu: me,\n                el: el\n            });\n        };\n    },\n\n    _insertElementAt: function (tagName, className, container, index) {\n        var refEl,\n            el = document.createElement(tagName);\n\n        el.className = className;\n\n        if (index !== undefined) {\n            refEl = container.children[index];\n        }\n\n        if (refEl) {\n            container.insertBefore(el, refEl);\n        } else {\n            container.appendChild(el);\n        }\n\n        return el;\n    },\n\n    _show: function (e) {\n        this._showAtPoint(e.containerPoint, e);\n    },\n\n    _showAtPoint: function (pt, data) {\n        if (this._items.length) {\n            var map = this._map,\n            layerPoint = map.containerPointToLayerPoint(pt),\n            latlng = map.layerPointToLatLng(layerPoint),\n            event = L.extend(data || {}, {contextmenu: this});\n\n            this._showLocation = {\n                latlng: latlng,\n                layerPoint: layerPoint,\n                containerPoint: pt\n            };\n\n            if (data && data.relatedTarget){\n                this._showLocation.relatedTarget = data.relatedTarget;\n            }\n\n            this._setPosition(pt);\n\n            if (!this._visible) {\n                this._container.style.display = 'block';\n                this._visible = true;\n            }\n\n            this._map.fire('contextmenu.show', event);\n        }\n    },\n\n    _hide: function () {\n        if (this._visible) {\n            this._visible = false;\n            this._container.style.display = 'none';\n            this._map.fire('contextmenu.hide', {contextmenu: this});\n        }\n    },\n\n    _getIcon: function (options) {\n        return L.Browser.retina && options.retinaIcon || options.icon;\n    },\n\n    _getIconCls: function (options) {\n        return L.Browser.retina && options.retinaIconCls || options.iconCls;\n    },\n\n    _setPosition: function (pt) {\n        var mapSize = this._map.getSize(),\n            container = this._container,\n            containerSize = this._getElementSize(container),\n            anchor;\n\n        if (this._map.options.contextmenuAnchor) {\n            anchor = L.point(this._map.options.contextmenuAnchor);\n            pt = pt.add(anchor);\n        }\n\n        container._leaflet_pos = pt;\n\n        if (pt.x + containerSize.x > mapSize.x) {\n            container.style.left = 'auto';\n            container.style.right = Math.min(Math.max(mapSize.x - pt.x, 0), mapSize.x - containerSize.x - 1) + 'px';\n        } else {\n            container.style.left = Math.max(pt.x, 0) + 'px';\n            container.style.right = 'auto';\n        }\n\n        if (pt.y + containerSize.y > mapSize.y) {\n            container.style.top = 'auto';\n            container.style.bottom = Math.min(Math.max(mapSize.y - pt.y, 0), mapSize.y - containerSize.y - 1) + 'px';\n        } else {\n            container.style.top = Math.max(pt.y, 0) + 'px';\n            container.style.bottom = 'auto';\n        }\n    },\n\n    _getElementSize: function (el) {\n        var size = this._size,\n            initialDisplay = el.style.display;\n\n        if (!size || this._sizeChanged) {\n            size = {};\n\n            el.style.left = '-999999px';\n            el.style.right = 'auto';\n            el.style.display = 'block';\n\n            size.x = el.offsetWidth;\n            size.y = el.offsetHeight;\n\n            el.style.left = 'auto';\n            el.style.display = initialDisplay;\n\n            this._sizeChanged = false;\n        }\n\n        return size;\n    },\n\n    _onKeyDown: function (e) {\n        var key = e.keyCode;\n\n        // If ESC pressed and context menu is visible hide it\n        if (key === 27) {\n            this._hide();\n        }\n    },\n\n    _onItemMouseOver: function (e) {\n        L.DomUtil.addClass(e.target || e.srcElement, 'over');\n    },\n\n    _onItemMouseOut: function (e) {\n        L.DomUtil.removeClass(e.target || e.srcElement, 'over');\n    }\n});\n\nL.Map.addInitHook('addHandler', 'contextmenu', L.Map.ContextMenu);\nL.Mixin.ContextMenu = {\n    bindContextMenu: function (options) {\n        L.setOptions(this, options);\n        this._initContextMenu();\n\n        return this;\n    },\n\n    unbindContextMenu: function (){\n        this.off('contextmenu', this._showContextMenu, this);\n\n        return this;\n    },\n\n    addContextMenuItem: function (item) {\n            this.options.contextmenuItems.push(item);\n    },\n\n    removeContextMenuItemWithIndex: function (index) {\n        var items = [];\n        for (var i = 0; i < this.options.contextmenuItems.length; i++) {\n            if (this.options.contextmenuItems[i].index == index){\n                items.push(i);\n            }\n        }\n        var elem = items.pop();\n        while (elem !== undefined) {\n            this.options.contextmenuItems.splice(elem,1);\n            elem = items.pop();\n        }\n    },\n\n    replaceContextMenuItem: function (item) {\n        this.removeContextMenuItemWithIndex(item.index);\n        this.addContextMenuItem(item);\n    },\n\n    _initContextMenu: function () {\n        this._items = [];\n\n        this.on('contextmenu', this._showContextMenu, this);\n    },\n\n    _showContextMenu: function (e) {\n        var itemOptions,\n            data, pt, i, l;\n\n        if (this._map.contextmenu) {\n            data = L.extend({relatedTarget: this}, e);\n\n            pt = this._map.mouseEventToContainerPoint(e.originalEvent);\n\n            if (!this.options.contextmenuInheritItems) {\n                this._map.contextmenu.hideAllItems();\n            }\n\n            for (i = 0, l = this.options.contextmenuItems.length; i < l; i++) {\n                itemOptions = this.options.contextmenuItems[i];\n                this._items.push(this._map.contextmenu.insertItem(itemOptions, itemOptions.index));\n            }\n\n            this._map.once('contextmenu.hide', this._hideContextMenu, this);\n\n            this._map.contextmenu.showAt(pt, data);\n        }\n    },\n\n    _hideContextMenu: function () {\n        var i, l;\n\n        for (i = 0, l = this._items.length; i < l; i++) {\n            this._map.contextmenu.removeItem(this._items[i]);\n        }\n        this._items.length = 0;\n\n        if (!this.options.contextmenuInheritItems) {\n            this._map.contextmenu.showAllItems();\n        }\n    }\n};\n\nvar classes = [L.Marker, L.Path],\n    defaultOptions = {\n        contextmenu: false,\n        contextmenuItems: [],\n        contextmenuInheritItems: true\n    },\n    cls, i, l;\n\nfor (i = 0, l = classes.length; i < l; i++) {\n    cls = classes[i];\n\n    // L.Class should probably provide an empty options hash, as it does not test\n    // for it here and add if needed\n    if (!cls.prototype.options) {\n        cls.prototype.options = defaultOptions;\n    } else {\n        cls.mergeOptions(defaultOptions);\n    }\n\n    cls.addInitHook(function () {\n        if (this.options.contextmenu) {\n            this._initContextMenu();\n        }\n    });\n\n    cls.include(L.Mixin.ContextMenu);\n}\nreturn L.Map.ContextMenu;\n});\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/leaflet-contextmenu/dist/leaflet.contextmenu.js\n// module id = 42\n// module chunks = 0","/*\n * Google layer using Google Maps API\n */\n\n/* global google: true */\n\nL.Google = L.Class.extend({\n\tincludes: L.Mixin.Events,\n\n\toptions: {\n\t\tminZoom: 0,\n\t\tmaxZoom: 18,\n\t\ttileSize: 256,\n\t\tsubdomains: 'abc',\n\t\terrorTileUrl: '',\n\t\tattribution: '',\n\t\topacity: 1,\n\t\tcontinuousWorld: false,\n\t\tnoWrap: false,\n\t\tmapOptions: {\n\t\t\tbackgroundColor: '#dddddd'\n\t\t}\n\t},\n\n\t// Possible types: SATELLITE, ROADMAP, HYBRID, TERRAIN\n\tinitialize: function(type, options) {\n\t\tL.Util.setOptions(this, options);\n\n\t\tthis._ready = google.maps.Map !== undefined;\n\t\tif (!this._ready) L.Google.asyncWait.push(this);\n\n\t\tthis._type = type || 'SATELLITE';\n\t},\n\n\tonAdd: function(map, insertAtTheBottom) {\n\t\tthis._map = map;\n\t\tthis._insertAtTheBottom = insertAtTheBottom;\n\n\t\t// create a container div for tiles\n\t\tthis._initContainer();\n\t\tthis._initMapObject();\n\n\t\t// set up events\n\t\tmap.on('viewreset', this._resetCallback, this);\n\n\t\tthis._limitedUpdate = L.Util.limitExecByInterval(this._update, 150, this);\n\t\tmap.on('move', this._update, this);\n\n\t\tmap.on('zoomanim', this._handleZoomAnim, this);\n\n\t\t//20px instead of 1em to avoid a slight overlap with google's attribution\n\t\tmap._controlCorners.bottomright.style.marginBottom = '20px';\n\n\t\tthis._reset();\n\t\tthis._update();\n\t},\n\n\tonRemove: function(map) {\n\t\tmap._container.removeChild(this._container);\n\n\t\tmap.off('viewreset', this._resetCallback, this);\n\n\t\tmap.off('move', this._update, this);\n\n\t\tmap.off('zoomanim', this._handleZoomAnim, this);\n\n\t\tmap._controlCorners.bottomright.style.marginBottom = '0em';\n\t},\n\n\tgetAttribution: function() {\n\t\treturn this.options.attribution;\n\t},\n\n\tsetOpacity: function(opacity) {\n\t\tthis.options.opacity = opacity;\n\t\tif (opacity < 1) {\n\t\t\tL.DomUtil.setOpacity(this._container, opacity);\n\t\t}\n\t},\n\n\tsetElementSize: function(e, size) {\n\t\te.style.width = size.x + 'px';\n\t\te.style.height = size.y + 'px';\n\t},\n\n\t_initContainer: function() {\n\t\tvar tilePane = this._map._container,\n\t\t\tfirst = tilePane.firstChild;\n\n\t\tif (!this._container) {\n\t\t\tthis._container = L.DomUtil.create('div', 'leaflet-google-layer leaflet-top leaflet-left');\n\t\t\tthis._container.id = '_GMapContainer_' + L.Util.stamp(this);\n\t\t\tthis._container.style.zIndex = 'auto';\n\t\t}\n\n\t\ttilePane.insertBefore(this._container, first);\n\n\t\tthis.setOpacity(this.options.opacity);\n\t\tthis.setElementSize(this._container, this._map.getSize());\n\t},\n\n\t_initMapObject: function() {\n\t\tif (!this._ready) return;\n\t\tthis._google_center = new google.maps.LatLng(0, 0);\n\t\tvar map = new google.maps.Map(this._container, {\n\t\t\tcenter: this._google_center,\n\t\t\tzoom: 0,\n\t\t\ttilt: 0,\n\t\t\tmapTypeId: google.maps.MapTypeId[this._type],\n\t\t\tdisableDefaultUI: true,\n\t\t\tkeyboardShortcuts: false,\n\t\t\tdraggable: false,\n\t\t\tdisableDoubleClickZoom: true,\n\t\t\tscrollwheel: false,\n\t\t\tstreetViewControl: false,\n\t\t\tstyles: this.options.mapOptions.styles,\n\t\t\tbackgroundColor: this.options.mapOptions.backgroundColor\n\t\t});\n\n\t\tvar _this = this;\n\t\tthis._reposition = google.maps.event.addListenerOnce(map, 'center_changed',\n\t\t\tfunction() { _this.onReposition(); });\n\t\tthis._google = map;\n\n\t\tgoogle.maps.event.addListenerOnce(map, 'idle',\n\t\t\tfunction() { _this._checkZoomLevels(); });\n\t\tgoogle.maps.event.addListenerOnce(map, 'tilesloaded',\n\t\t\tfunction() { _this.fire('load'); });\n\t\t//Reporting that map-object was initialized.\n\t\tthis.fire('MapObjectInitialized', { mapObject: map });\n\t},\n\n\t_checkZoomLevels: function() {\n\t\t//setting the zoom level on the Google map may result in a different zoom level than the one requested\n\t\t//(it won't go beyond the level for which they have data).\n\t\t// verify and make sure the zoom levels on both Leaflet and Google maps are consistent\n\t\tif (this._google.getZoom() !== this._map.getZoom()) {\n\t\t\t//zoom levels are out of sync. Set the leaflet zoom level to match the google one\n\t\t\tthis._map.setZoom( this._google.getZoom() );\n\t\t}\n\t},\n\n\t_resetCallback: function(e) {\n\t\tthis._reset(e.hard);\n\t},\n\n\t_reset: function(clearOldContainer) {\n\t\tthis._initContainer();\n\t},\n\n\t_update: function(e) {\n\t\tif (!this._google) return;\n\t\tthis._resize();\n\n\t\tvar center = this._map.getCenter();\n\t\tvar _center = new google.maps.LatLng(center.lat, center.lng);\n\n\t\tthis._google.setCenter(_center);\n\t\tthis._google.setZoom(Math.round(this._map.getZoom()));\n\n\t\tthis._checkZoomLevels();\n\t},\n\n\t_resize: function() {\n\t\tvar size = this._map.getSize();\n\t\tif (this._container.style.width === size.x &&\n\t\t\t\tthis._container.style.height === size.y)\n\t\t\treturn;\n\t\tthis.setElementSize(this._container, size);\n\t\tthis.onReposition();\n\t},\n\n\n\t_handleZoomAnim: function (e) {\n\t\tvar center = e.center;\n\t\tvar _center = new google.maps.LatLng(center.lat, center.lng);\n\n\t\tthis._google.setCenter(_center);\n\t\tthis._google.setZoom(Math.round(e.zoom));\n\t},\n\n\n\tonReposition: function() {\n\t\tif (!this._google) return;\n\t\tgoogle.maps.event.trigger(this._google, 'resize');\n\t}\n});\n\nL.Google.asyncWait = [];\nL.Google.asyncInitialize = function() {\n\tvar i;\n\tfor (i = 0; i < L.Google.asyncWait.length; i++) {\n\t\tvar o = L.Google.asyncWait[i];\n\t\to._ready = true;\n\t\tif (o._container) {\n\t\t\to._initMapObject();\n\t\t\to._update();\n\t\t}\n\t}\n\tL.Google.asyncWait = [];\n};\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/d2-tracker/lib/Google.js\n// module id = 43\n// module chunks = 0"],"sourceRoot":""}